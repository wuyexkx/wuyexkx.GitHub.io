<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>WDS1期第10课 内核 3 内核之Makefile</title>
      <link href="2021/05/14/wds1-qi-di-10-ke-nei-he-3-nei-he-zhi-makefile-local/"/>
      <url>2021/05/14/wds1-qi-di-10-ke-nei-he-3-nei-he-zhi-makefile-local/</url>
      
        <content type="html"><![CDATA[<p><strong>整个内核Makefile的分析过程与uboot的Makefile分析类似，最终都是找到链接文件lds和第一个文件.s是哪个，.S中可以看到内核的启动流程。</strong></p><p>选择子目录下的Makefile，drivers/char/Makefile，-y表示被编译进内核，-m表示编译成模块</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">obj<span class="token operator">-</span>y <span class="token operator">+=</span> mem<span class="token punctuation">.</span>o random<span class="token punctuation">.</span>o tty_io<span class="token punctuation">.</span>o n_tty<span class="token punctuation">.</span>o tty_ioctl<span class="token punctuation">.</span>o<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>组合成模块：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">obj<span class="token operator">-</span>m   <span class="token operator">+=</span> ab<span class="token punctuation">.</span>oab<span class="token operator">-</span>objs <span class="token operator">:</span><span class="token operator">=</span> a<span class="token punctuation">.</span>o  b<span class="token punctuation">.</span>o<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>a.c b.c生成a.0 b.o，最终ab.ko</p><h3 id="顶层Makefile"><a href="#顶层Makefile" class="headerlink" title="顶层Makefile"></a>顶层Makefile</h3><p>根据命令和顶层Makefile顺藤摸瓜，编译内核时，<code>make或make uImage</code>命令，在顶层Makefile中没有uImage，uImage在arch/arm/Makefile中，所以子目录下的M会被包含到顶层的M，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">根目录下：ARCH<span class="token operator">?</span><span class="token operator">=</span> armCROSS_COMPILE<span class="token operator">?</span><span class="token operator">=</span> arm<span class="token operator">-</span>linux<span class="token operator">-</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>include $<span class="token punctuation">(</span>srctree<span class="token punctuation">)</span><span class="token operator">/</span>arch<span class="token operator">/</span>$<span class="token punctuation">(</span>ARCH<span class="token punctuation">)</span><span class="token operator">/</span>Makefile子目录下：zImage Image xipImage bootpImage uImage<span class="token operator">:</span> vmlinux<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>由上可知，ARCH也在顶层M目录下，<code>include $(srctree)/arch/$(ARCH)/Makefile</code> –&gt; <code>include $(srctree)/arch/arm/Makefile</code>，也就是顶层M下包含了子层那个M，所以可以找到uImage。<br>&#8195; 之前由.config生成的auto.conf是Makefile的参数来源之一，所以它也被包含在顶层M中，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">-</span>include include<span class="token operator">/</span>config<span class="token operator">/</span><span class="token keyword">auto</span><span class="token punctuation">.</span>conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>回到上上面，uImage依赖vmlinux(真内核)，第一个目标是生成vmlinux。它依赖一堆东西，链接文件/初始化/主要文件等</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">all<span class="token operator">:</span> vmlinux<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">vmlinux</span> <span class="token expression">image <span class="token operator">-</span> including updated kernel symbols</span></span>vmlinux<span class="token operator">:</span> $<span class="token punctuation">(</span>vmlinux<span class="token operator">-</span>lds<span class="token punctuation">)</span> $<span class="token punctuation">(</span>vmlinux<span class="token operator">-</span>init<span class="token punctuation">)</span> $<span class="token punctuation">(</span>vmlinux<span class="token operator">-</span>main<span class="token punctuation">)</span> $<span class="token punctuation">(</span>kallsyms<span class="token punctuation">.</span>o<span class="token punctuation">)</span> FORCE<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>vmlinux<span class="token operator">-</span>init <span class="token operator">:</span><span class="token operator">=</span> $<span class="token punctuation">(</span>head<span class="token operator">-</span>y<span class="token punctuation">)</span> $<span class="token punctuation">(</span>init<span class="token operator">-</span>y<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token macro property"><span class="token directive-hash">#</span> <span class="token expression">Objects we will link into vmlinux <span class="token operator">/</span> subdirs we need to visit</span></span>init<span class="token operator">-</span>y<span class="token operator">:</span><span class="token operator">=</span> init<span class="token operator">/</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>init<span class="token operator">-</span>y<span class="token operator">:</span><span class="token operator">=</span> $<span class="token punctuation">(</span>patsubst <span class="token operator">%</span><span class="token operator">/</span><span class="token punctuation">,</span> <span class="token operator">%</span><span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o<span class="token punctuation">,</span> $<span class="token punctuation">(</span>init<span class="token operator">-</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>vmlinux<span class="token operator">-</span>main <span class="token operator">:</span><span class="token operator">=</span> $<span class="token punctuation">(</span>core<span class="token operator">-</span>y<span class="token punctuation">)</span> $<span class="token punctuation">(</span>libs<span class="token operator">-</span>y<span class="token punctuation">)</span> $<span class="token punctuation">(</span>drivers<span class="token operator">-</span>y<span class="token punctuation">)</span> $<span class="token punctuation">(</span>net<span class="token operator">-</span>y<span class="token punctuation">)</span>core<span class="token operator">-</span>y<span class="token operator">:</span><span class="token operator">=</span> usr<span class="token operator">/</span>core<span class="token operator">-</span>y<span class="token operator">+=</span> kernel<span class="token operator">/</span> mm<span class="token operator">/</span> fs<span class="token operator">/</span> ipc<span class="token operator">/</span> security<span class="token operator">/</span> crypto<span class="token operator">/</span> block<span class="token operator">/</span>core<span class="token operator">-</span>y<span class="token operator">:</span><span class="token operator">=</span> $<span class="token punctuation">(</span>patsubst <span class="token operator">%</span><span class="token operator">/</span><span class="token punctuation">,</span> <span class="token operator">%</span><span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o<span class="token punctuation">,</span> $<span class="token punctuation">(</span>core<span class="token operator">-</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>libs<span class="token operator">-</span>y<span class="token operator">:</span><span class="token operator">=</span> lib<span class="token operator">/</span>libs<span class="token operator">-</span>y1<span class="token operator">:</span><span class="token operator">=</span> $<span class="token punctuation">(</span>patsubst <span class="token operator">%</span><span class="token operator">/</span><span class="token punctuation">,</span> <span class="token operator">%</span><span class="token operator">/</span>lib<span class="token punctuation">.</span>a<span class="token punctuation">,</span> $<span class="token punctuation">(</span>libs<span class="token operator">-</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>libs<span class="token operator">-</span>y2<span class="token operator">:</span><span class="token operator">=</span> $<span class="token punctuation">(</span>patsubst <span class="token operator">%</span><span class="token operator">/</span><span class="token punctuation">,</span> <span class="token operator">%</span><span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o<span class="token punctuation">,</span> $<span class="token punctuation">(</span>libs<span class="token operator">-</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>libs<span class="token operator">-</span>y<span class="token operator">:</span><span class="token operator">=</span> $<span class="token punctuation">(</span>libs<span class="token operator">-</span>y1<span class="token punctuation">)</span> $<span class="token punctuation">(</span>libs<span class="token operator">-</span>y2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>drivers<span class="token operator">-</span>y<span class="token operator">:</span><span class="token operator">=</span> drivers<span class="token operator">/</span> sound<span class="token operator">/</span>drivers<span class="token operator">-</span>y<span class="token operator">:</span><span class="token operator">=</span> $<span class="token punctuation">(</span>patsubst <span class="token operator">%</span><span class="token operator">/</span><span class="token punctuation">,</span> <span class="token operator">%</span><span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o<span class="token punctuation">,</span> $<span class="token punctuation">(</span>drivers<span class="token operator">-</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>net<span class="token operator">-</span>y<span class="token operator">:</span><span class="token operator">=</span> net<span class="token operator">/</span>net<span class="token operator">-</span>y<span class="token operator">:</span><span class="token operator">=</span> $<span class="token punctuation">(</span>patsubst <span class="token operator">%</span><span class="token operator">/</span><span class="token punctuation">,</span> <span class="token operator">%</span><span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o<span class="token punctuation">,</span> $<span class="token punctuation">(</span>net<span class="token operator">-</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>&#8195; init-y那两句是将所有init/目录下的文件编成init/built-in.o文件。<br>&#8195; 在顶层找不到head-y，所以在arch/arm/Makefile中，可见head-y由两个文件组成，MMUEXT没有定义，就是head.o 和 init_task.o组成，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token expression">Default value</span></span>head<span class="token operator">-</span>y<span class="token operator">:</span><span class="token operator">=</span> arch<span class="token operator">/</span>arm<span class="token operator">/</span>kernel<span class="token operator">/</span>head$<span class="token punctuation">(</span>MMUEXT<span class="token punctuation">)</span><span class="token punctuation">.</span>o arch<span class="token operator">/</span>arm<span class="token operator">/</span>kernel<span class="token operator">/</span>init_task<span class="token punctuation">.</span>o<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>vmlinux-main依赖核心/驱动/网络，<code>vmlinux-main := $(core-y) $(libs-y) $(drivers-y) $(net-y)</code>，<br>core-y最终是 usr/built-in.o kernel/built-in.o mm/built-in.o fs/built-in.o ipc/built-in.o security/built-in.o crypto/built-in.o block/built-in.o<br>libs-y最终是 lib/lib.a lib/built-in.o<br>drivers-y最终是 drivers/built-in.o sound/built-in.o<br>net-y最终是 net/built-in.o</p><p>以上大堆垃圾怎么组合编译生成vmlinux的，还需看<code>vmlinux: $(vmlinux-lds) $(vmlinux-init) $(vmlinux-main) $(kallsyms.o) FORCE</code>其他，但是很庞大，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">vmlinux</span> <span class="token expression">image <span class="token operator">-</span> including updated kernel symbols</span></span>vmlinux<span class="token operator">:</span> $<span class="token punctuation">(</span>vmlinux<span class="token operator">-</span>lds<span class="token punctuation">)</span> $<span class="token punctuation">(</span>vmlinux<span class="token operator">-</span>init<span class="token punctuation">)</span> $<span class="token punctuation">(</span>vmlinux<span class="token operator">-</span>main<span class="token punctuation">)</span> $<span class="token punctuation">(</span>kallsyms<span class="token punctuation">.</span>o<span class="token punctuation">)</span> FORCEifdef CONFIG_HEADERS_CHECK$<span class="token punctuation">(</span>Q<span class="token punctuation">)</span>$<span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> <span class="token operator">-</span>f $<span class="token punctuation">(</span>srctree<span class="token punctuation">)</span><span class="token operator">/</span>Makefile headers_checkendif$<span class="token punctuation">(</span>call if_changed_rule<span class="token punctuation">,</span>vmlinux__<span class="token punctuation">)</span>$<span class="token punctuation">(</span>Q<span class="token punctuation">)</span>$<span class="token punctuation">(</span>MAKE<span class="token punctuation">)</span> <span class="token operator">-</span>f $<span class="token punctuation">(</span>srctree<span class="token punctuation">)</span><span class="token operator">/</span>scripts<span class="token operator">/</span>Makefile<span class="token punctuation">.</span>modpost $@$<span class="token punctuation">(</span>Q<span class="token punctuation">)</span>rm <span class="token operator">-</span>f <span class="token punctuation">.</span>old_version<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看编译内核最后的一些提示信息来反向分析，先删除rm vmlinux，再make uImage V=1，V=1表示详细列出信息，最终输出vmlinux，与<br><code>vmlinux: $(vmlinux-lds) $(vmlinux-init) $(vmlinux-main) $(kallsyms.o) FORCE</code>对应，<br>所以链接文件<code>arch/arm/kernel/vmlinux.lds</code> ，和第一个文件<code>arch/arm/kernel/head.o</code>很重要，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">arm<span class="token operator">-</span>linux<span class="token operator">-</span>ld <span class="token operator">-</span>EL  <span class="token operator">-</span>p <span class="token operator">--</span>no<span class="token operator">-</span>undefined <span class="token operator">-</span>X <span class="token operator">-</span>o vmlinux <span class="token operator">-</span>T arch<span class="token operator">/</span>arm<span class="token operator">/</span>kernel<span class="token operator">/</span>vmlinux<span class="token punctuation">.</span>lds arch<span class="token operator">/</span>arm<span class="token operator">/</span>kernel<span class="token operator">/</span>head<span class="token punctuation">.</span>o arch<span class="token operator">/</span>arm<span class="token operator">/</span>kernel<span class="token operator">/</span>init_task<span class="token punctuation">.</span>o  init<span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o <span class="token operator">--</span>start<span class="token operator">-</span>group  usr<span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o arch<span class="token operator">/</span>arm<span class="token operator">/</span>kernel<span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o  arch<span class="token operator">/</span>arm<span class="token operator">/</span>mm<span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o  arch<span class="token operator">/</span>arm<span class="token operator">/</span>common<span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o arch<span class="token operator">/</span>arm<span class="token operator">/</span>mach<span class="token operator">-</span>s3c2410<span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o  arch<span class="token operator">/</span>arm<span class="token operator">/</span>mach<span class="token operator">-</span>s3c2400<span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o  arch<span class="token operator">/</span>arm<span class="token operator">/</span>mach<span class="token operator">-</span>s3c2412<span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o  arch<span class="token operator">/</span>arm<span class="token operator">/</span>mach<span class="token operator">-</span>s3c2440<span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o  arch<span class="token operator">/</span>arm<span class="token operator">/</span>mach<span class="token operator">-</span>s3c2442<span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o  arch<span class="token operator">/</span>arm<span class="token operator">/</span>mach<span class="token operator">-</span>s3c2443<span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o  arch<span class="token operator">/</span>arm<span class="token operator">/</span>nwfpe<span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o  arch<span class="token operator">/</span>arm<span class="token operator">/</span>plat<span class="token operator">-</span>s3c24xx<span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o  kernel<span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o  mm<span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o  fs<span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o  ipc<span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o  security<span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o  crypto<span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o  block<span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o  arch<span class="token operator">/</span>arm<span class="token operator">/</span>lib<span class="token operator">/</span>lib<span class="token punctuation">.</span>a  lib<span class="token operator">/</span>lib<span class="token punctuation">.</span>a  arch<span class="token operator">/</span>arm<span class="token operator">/</span>lib<span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o  lib<span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o  drivers<span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o  sound<span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o  net<span class="token operator">/</span>built<span class="token operator">-</span>in<span class="token punctuation">.</span>o <span class="token operator">--</span>end<span class="token operator">-</span>group <span class="token punctuation">.</span>tmp_kallsyms2<span class="token punctuation">.</span>o<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>uImage依赖vmlinux，vmlinux依赖<code>$(vmlinux-lds) $(vmlinux-init) $(vmlinux-main) $(kallsyms.o)</code>，其中vmlinux-main由<code>$(core-y) $(libs-y) $(drivers-y) $(net-y)</code>生成。</p><p>所以链接文件<code>arch/arm/kernel/vmlinux.lds</code> ，和第一个文件<code>arch/arm/kernel/head.o</code>很重要，<br>arch/arm/kernel/vmlinux.lds内容如下，首先给出内核应该存放的位置，但这里是虚拟地址。下面接着放所有文件的(.text.head)段，然后所有文件的(.init.text)段。<strong>文件的顺序由.o的出现的顺序决定，.o内部的各个段存放的顺序由lds链接脚本决定，</strong></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">SECTIONS<span class="token punctuation">&#123;</span> <span class="token punctuation">.</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0xc0000000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x00008000</span><span class="token punctuation">;</span> <span class="token punctuation">.</span>text<span class="token punctuation">.</span>head <span class="token operator">:</span> <span class="token punctuation">&#123;</span>  _stext <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">;</span>  _sinittext <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">;</span>  <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span>head<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">.</span>init <span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* Init code and data*/</span>   <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">.</span>init<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS1期第2课 裸机1 - 程序启动流程</title>
      <link href="2021/05/14/wds1-qi-di-2-ke-luo-ji-1-cheng-xu-qi-dong-liu-cheng-local/"/>
      <url>2021/05/14/wds1-qi-di-2-ke-luo-ji-1-cheng-xu-qi-dong-liu-cheng-local/</url>
      
        <content type="html"><![CDATA[<h3 id="启动方式有两种"><a href="#启动方式有两种" class="headerlink" title="启动方式有两种"></a>启动方式有两种</h3><h4 id="1-从nand启动"><a href="#1-从nand启动" class="headerlink" title="1 从nand启动"></a>1 从nand启动</h4><p>2440内部有4K的SRAM，通常2440裸机程序由外部Nand启动，nand的前4K会被强制复制到内部4K的SRAM中，起始地址都是0。<strong>nand的地址是串行总线的方法（不是由cpu统一编址），不能像读RAM一样读取。</strong></p><ol><li>nand前4K会被自动拷贝到SRAM中，起始地址为0</li><li>CPU从SRAM的0地址取指执行(代码段地址从0开始的原因)</li></ol><p>如该程序很大，先拷贝nand的前4字节到SRAM，执行，在SRAM中设置将nand后面的程序拷贝到SDRAM中，然后再从SDRAM中取指执行。</p><h4 id="2-从nor启动"><a href="#2-从nor启动" class="headerlink" title="2 从nor启动"></a>2 从nor启动</h4><p>如果从Nor启动，CPU从nor的0地址取指启动。<strong>nor能像读RAM一样读取，但不能像内存一样写东西，要先擦除</strong>。</p><ol><li>cpu的0地址是指向nor的，不是内部的SRAM</li><li>从nor的0地址取指执行<h3 id="main"><a href="#main" class="headerlink" title="main"></a>main</h3>main也是函数，也会被调用，也会返回。<br>在启动文件中包含 <strong>软件初始化</strong> 和 <strong>硬件初始化</strong>。<br>软件初始化：</li><li>设置main的栈<br>将栈指针sp指向某块内存（SRAM[不需初始化]、SDRAM[需要初始化]）</li><li>设置main的返回地址</li><li>调用main</li><li>main返回后的清理工作</li></ol><p>硬件初始化：</p><ol><li>关看门狗（定时器），2440默认三秒重启系统</li><li>初始化时钟（上电只有12M，需要初始化更快的时钟）</li><li>初始化SDRAM</li></ol><h4 id="crt0-s"><a href="#crt0-s" class="headerlink" title="crt0.s"></a>crt0.s</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">@<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>@ File：crt0<span class="token punctuation">.</span>S@ 功能：通过它转入C程序@<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>       <span class="token punctuation">.</span>text<span class="token punctuation">.</span>global _start_start<span class="token operator">:</span>            ldr     r0<span class="token punctuation">,</span> <span class="token operator">=</span><span class="token number">0x53000000</span>     @ WATCHDOG寄存器地址                                 <span class="token number">1.</span>关看门狗            mov     r1<span class="token punctuation">,</span> #<span class="token number">0x0</span>                                 str     r1<span class="token punctuation">,</span> <span class="token punctuation">[</span>r0<span class="token punctuation">]</span>            @ 写入<span class="token number">0</span>，禁止WATCHDOG，否则CPU会不断重启                        ldr     sp<span class="token punctuation">,</span> <span class="token operator">=</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">4</span>         @ 设置堆栈，注意：不能大于<span class="token number">4</span>k<span class="token punctuation">,</span> 因为现在可用的内存只有<span class="token number">4</span>K     <span class="token number">0.</span>设置sp栈空间大小                                        @ nand flash中的代码在复位后会移到内部ram中，此ram只有<span class="token number">4</span>K            bl      main                @ 调用C程序中的main函数                               跳转到main函数，并且返回地址保存在lr里边halt_loop<span class="token operator">:</span>                              @                                                  main返回后清理，死循环            b       halt_loop<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="main-c"><a href="#main-c" class="headerlink" title="main.c"></a>main.c</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPFCON</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x56000050</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPFDAT</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x56000054</span><span class="token punctuation">)</span></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    GPFCON <span class="token operator">=</span> <span class="token number">0x00000100</span><span class="token punctuation">;</span>    <span class="token comment">// 设置GPF4为输出口, 位[9:8]=0b01</span>    GPFDAT <span class="token operator">=</span> <span class="token number">0x00000000</span><span class="token punctuation">;</span>    <span class="token comment">// GPF4输出0，LED1点亮</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">led_on_c<span class="token punctuation">.</span>bin <span class="token operator">:</span> crt0<span class="token punctuation">.</span>S  led_on_c<span class="token punctuation">.</span>carm<span class="token operator">-</span>linux<span class="token operator">-</span>gcc <span class="token operator">-</span>g <span class="token operator">-</span>c <span class="token operator">-</span>o crt0<span class="token punctuation">.</span>o crt0<span class="token punctuation">.</span>S  # <span class="token operator">-</span>g加入调试信息 <span class="token operator">-</span>c汇编成<span class="token punctuation">.</span>oarm<span class="token operator">-</span>linux<span class="token operator">-</span>gcc <span class="token operator">-</span>g <span class="token operator">-</span>c <span class="token operator">-</span>o led_on_c<span class="token punctuation">.</span>o led_on_c<span class="token punctuation">.</span>c#  arm<span class="token operator">-</span>linux<span class="token operator">-</span>ld <span class="token operator">-</span>Ttext <span class="token number">0x0000000</span> <span class="token operator">-</span>g  crt0<span class="token punctuation">.</span>o led_on_c<span class="token punctuation">.</span>o <span class="token operator">-</span>o led_on_c_elf # 链接前面两个<span class="token punctuation">.</span>o文件 成 led_on_c_elf     # <span class="token operator">-</span>Ttext <span class="token number">0x0000000</span> 表示代码段的地址为<span class="token number">0</span>arm<span class="token operator">-</span>linux<span class="token operator">-</span>objcopy <span class="token operator">-</span>O binary <span class="token operator">-</span>S led_on_c_elf led_on_c<span class="token punctuation">.</span>bin # 转换可执行文件为二进制文件，要烧进flasharm<span class="token operator">-</span>linux<span class="token operator">-</span>objdump <span class="token operator">-</span>D <span class="token operator">-</span>m arm  led_on_c_elf <span class="token operator">></span> led_on_c<span class="token punctuation">.</span>disclean<span class="token operator">:</span>rm <span class="token operator">-</span>f led_on_c<span class="token punctuation">.</span>dis led_on_c<span class="token punctuation">.</span>bin led_on_c_elf <span class="token operator">*</span><span class="token punctuation">.</span>o<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其中的链接地址就是从nand拷贝到SRAM的0x0000000地址。</p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS1期第3课 裸机2 - 存储管理器</title>
      <link href="2021/05/14/wds1-qi-di-3-ke-luo-ji-2-cun-chu-guan-li-qi-local/"/>
      <url>2021/05/14/wds1-qi-di-3-ke-luo-ji-2-cun-chu-guan-li-qi-local/</url>
      
        <content type="html"><![CDATA[<p>CPU是通过存储管理单元访问到外部存储器的，存储器一般包括以下几个部分：<br>地址线 数据线 （数据宽度），时钟频率，寻址相关跟芯片有关，如SDRAM bank-行地址-列地址<br>以SDRAM为例，32位，16位，8位的内存接线方法不一样，如32位内存，是以4个字节为单位访问地址空间的，地址位0/1/2/3读回的数据是一样的，所以地址线的低三位A0A1A2不用接。</p><p>一般操作为：配置存储单元管理器，写寄存器（如总线宽度，时钟等等）。</p><p>内存一般分为SRAM(给出地址直接访问) SDRM(bank 行 列 需要刷新) DDR</p><p>RAM-like：网卡 nor SRAM</p><p>2440 共8个Bank，每个Bank可以寻址128M。Bank0-5可以接RAM-like，0地址就是指Bank0，叫做steppingstone，Bank6/7接SDRAM（可以组合，128+128，32+32等等）</p><p>2440内部有4K的SRAM，通常2440裸机程序由外部Nand启动，nand的前4K会被强制复制到内部4K的SRAM中，起始地址都是0。<strong>and的地址是串行总线的方法，不能像读RAM一样读取。</strong></p><ol><li>nand前4K会被自动拷贝到SRAM中，起始地址为0</li><li>CPU从SRAM的0地址取指执行(代码段地址从0开始的原因)</li></ol><p><strong>如该程序很大，先拷贝nand的前4字节到SRAM，执行，在SRAM中设置将nand后面的程序拷贝到SDRAM中，然后再从SDRAM中取指执行。</strong></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS1期第4课 裸机3 - MMU</title>
      <link href="2021/05/14/wds1-qi-di-4-ke-luo-ji-3-mmu-local/"/>
      <url>2021/05/14/wds1-qi-di-4-ke-luo-ji-3-mmu-local/</url>
      
        <content type="html"><![CDATA[<p>通常CPU不是和内存直接打交道，CPU执行程序时要存放A变量到内存的某个地址，由MMU做地址转换，然后交给存储管理器去存放。<br>CPU —–(虚拟地址)—– MMU —–(物理地址)—— 存储管理器</p><p>但是在裸机程序中，CPU也可以绕过MMU(不开启MMU)直接给存储管理器发地址而不转换地址。<br>CPU —–(物理地址)—— 存储管理器</p><p>在CPU的眼里，没有虚拟地址和物理地址这个概念，比如Makefile中的链接地址也没有虚拟和物理地址之分。都只是负责按取指的内容执行指令。</p><h3 id="虚拟转物理地址"><a href="#虚拟转物理地址" class="headerlink" title="虚拟转物理地址"></a>虚拟转物理地址</h3><ol><li>对于linux架构，PA = 0xxxxx + VA</li><li>对于arm架构，表格，映射方式有 段/大页/小页/极小页<br>表格的每一项对应一段，如一段表示1M，4G内存放到表格的每一项，每一项表示0～1M的空间</li></ol>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS1期第5课 裸机4 - nand</title>
      <link href="2021/05/14/wds1-qi-di-5-ke-luo-ji-4-nand-local/"/>
      <url>2021/05/14/wds1-qi-di-5-ke-luo-ji-4-nand-local/</url>
      
        <content type="html"><![CDATA[<p>CPU统一编址</p><ol><li>片内内存SRAM （0地址）</li><li>SDRAM</li><li>网卡</li><li>CPU寄存器</li></ol><p>Nand<br>Nand由很多块组成，块由很多页组成。大页2Kbyte，小页512Byte。每页由2KByte存储数据的单元和64Byte的ooB组成，64页组成一块，一页包含2048+64Byte的内容。<br>OOB：对于Nand Flash，每一个页，对应一个空闲区域(OOB)，这个区域是基于Nand Flash的硬件特性，数据在读写的时候容易出错，为了保证数据的正确性，就产生了这样一个检测和纠错的区域，用来放置数据的校验值。OOB的读写操作，一般都是随着页的操作一起完成，也就是在读写页的时候，对应的OOB就产生了。<a href="https://www.cnblogs.com/ken-song2016/p/5598473.html">https://www.cnblogs.com/ken-song2016/p/5598473.html</a></p><p>数据/命令/地址 都是通过8根数据总线传输的。</p><ol><li>NFCMD</li><li>NFADRR</li><li>NFDAT</li><li>NFSTAT</li></ol>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第30课 3 自制工具 驱动代码操作寄存器编辑读写 用户代码调用接口读写寄存器</title>
      <link href="2021/05/14/wds2-qi-di-30-ke-3-zi-zhi-gong-ju-qu-dong-dai-ma-cao-zuo-ji-cun-qi-bian-ji-du-xie-yong-hu-dai-ma-diao-yong-jie-kou-du-xie-ji-cun-qi-local/"/>
      <url>2021/05/14/wds2-qi-di-30-ke-3-zi-zhi-gong-ju-qu-dong-dai-ma-cao-zuo-ji-cun-qi-bian-ji-du-xie-yong-hu-dai-ma-diao-yong-jie-kou-du-xie-ji-cun-qi-local/</url>
      
        <content type="html"><![CDATA[<p>相当于 再写一个驱动程序 提供ioctl函数，在函数里对cpu寄存器直接操作，读或者写，<br>再写一个用户程序，调用ioctl函数简单操作寄存器。</p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第30课2.2没什么东西</title>
      <link href="2021/05/14/wds2-qi-di-30-ke-2.2-mei-shi-me-dong-xi-local/"/>
      <url>2021/05/14/wds2-qi-di-30-ke-2.2-mei-shi-me-dong-xi-local/</url>
      
        <content type="html"><![CDATA[<ol start="3"><li>根据栈信息分析函数调用过程<h1 id="firstdrvtest-on"><a href="#firstdrvtest-on" class="headerlink" title="./firstdrvtest on"></a>./firstdrvtest on</h1>Unable to handle kernel paging request at virtual address 56000050<br>pgd = c3e78000<br>[56000050] *pgd=00000000<br>Internal error: Oops: 5 [#1]<br>Modules linked in: first_drv<br>CPU: 0    Not tainted  (2.6.22.6 #48)<br>PC is at first_drv_open+0x18/0x3c [first_drv]<br>LR is at chrdev_open+0x14c/0x164<br>pc : [<bf000018>]    lr : [<c008c888>]    psr: a0000013</li><li>1 根据PC确定出错位置<br>bf000018 属于 insmod的模块<br>bf000000 t first_drv_open       [first_drv]</li></ol><p>3.2 确定它属于哪个函数<br>反汇编first_drv.ko</p><p>sp : c3e69e88  ip : c3e69e98  fp : c3e69e94<br>r10: 00000000  r9 : c3e68000  r8 : c0490620<br>r7 : 00000000  r6 : 00000000  r5 : c3e320a0  r4 : c06a8300<br>r3 : bf000000  r2 : 56000050  r1 : bf000964  r0 : 00000000<br>Flags: NzCv  IRQs on  FIQs on  Mode SVC_32  Segment user<br>Control: c000717f  Table: 33e78000  DAC: 00000015<br>Process firstdrvtest (pid: 752, stack limit = 0xc3e68258)<br>Stack: (0xc3e69e88 to 0xc3e6a000)<br>9e80:                   c3e69ebc c3e69e98 c008c888 bf000010 00000000 c0490620<br>                        first_drv_open’sp    lr             chrdev_open’sp</p><p>9ea0: c3e320a0 c008c73c c0465e20 c3e36cb4 c3e69ee4 c3e69ec0 c0088e48 c008c74c<br>                                                            lr    </p><p>9ec0: c0490620 c3e69f04 00000003 ffffff9c c002b044 c06e0000 c3e69efc c3e69ee8<br>      __dentry_open’sp</p><p>9ee0: c0088f64 c0088d58 00000000 00000002 c3e69f68 c3e69f00 c0088fb8 c0088f40<br>      lr                nameidata_to_filp’sp                lr</p><p>9f00: c3e69f04 c3e36cb4 c0465e20 00000000 00000000 c3e79000 00000101 00000001<br>      do_filp_open’sp</p><p>9f20: 00000000 c3e68000 c04c1468 c04c1460 ffffffe8 c06e0000 c3e69f68 c3e69f48<br>9f40: c008916c c009ec70 00000003 00000000 c0490620 00000002 be94eee0 c3e69f94<br>9f60: c3e69f6c c00892f4 c0088f88 00008520 be94eed4 0000860c 00008670 00000005<br>               lr                do_sys_open’sp</p><p>9f80: c002b044 4013365c c3e69fa4 c3e69f98 c00893a8 c00892b0 00000000 c3e69fa8<br>                                          lr                sys_open’sp</p><p>9fa0: c002aea0 c0089394 be94eed4 0000860c 00008720 00000002 be94eee0 00000001<br>      lr                ret_fast_syscall’sp</p><p>9fc0: be94eed4 0000860c 00008670 00000002 00008520 00000000 4013365c be94eea8<br>9fe0: 00000000 be94ee84 0000266c 400c98e0 60000010 00008720 00000000 00000000 </p><p>三. 自制工具<br>寄存器编辑器</p><p>四. 修改内核来定位系统僵死问题<br>./firstdrvtest on<br>asm_do_IRQ =&gt; s3c2410_timer_interrupt : pid = 752, task name = firstdrvtest<br>pc = bf000084<br>asm_do_IRQ =&gt; s3c2410_timer_interrupt : pid = 752, task name = firstdrvtest<br>pc = bf000084   // 对于中断, pc-4才是发生中断瞬间的地址</p><p>看/proc/kallsyms<br>first_drv.dis<br>00000000 <first_drv_open>:                     bf000000 t first_drv_open    [first_drv]<br>0000003c <first_drv_write>:<br>  3c:    e1a0c00d     mov    ip, sp<br>  40:    e92dd800     stmdb    sp!, {fp, ip, lr, pc}<br>  44:    e24cb004     sub    fp, ip, #4    ; 0x4<br>  48:    e24dd004     sub    sp, sp, #4    ; 0x4<br>  4c:    e3cd3d7f     bic    r3, sp, #8128    ; 0x1fc0<br>  50:    e3c3303f     bic    r3, r3, #63    ; 0x3f<br>  54:    e5933008     ldr    r3, [r3, #8]<br>  58:    e0910002     adds    r0, r1, r2<br>  5c:    30d00003     sbcccs    r0, r0, r3<br>  60:    33a03000     movcc    r3, #0    ; 0x0<br>  64:    e3530000     cmp    r3, #0    ; 0x0<br>  68:    e24b0010     sub    r0, fp, #16    ; 0x10<br>  6c:    1a00001c     bne    e4 &lt;init_module+0x5c&gt;<br>  70:    ebfffffe     bl    70 &lt;first_drv_write+0x34&gt;<br>  74:    ea00001f     b    f8 &lt;init_module+0x70&gt;<br>  78:    e3520000     cmp    r2, #0    ; 0x0<br>  7c:    11a01002     movne    r1, r2<br>  80:    1bfffffe     blne    80 &lt;first_drv_write+0x44&gt;       // 卡死的地方<br>  84:    ea00001f     b    108 &lt;init_module+0x80&gt;</p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第31课 1 应用程序调试之使用strace strace -o log.txt rmmod app trace父进程创建app子进程记录日志</title>
      <link href="2021/05/14/wds2-qi-di-31-ke-1-ying-yong-cheng-xu-diao-shi-zhi-shi-yong-strace-strace-o-log.txt-rmmod-app-trace-fu-jin-cheng-chuang-jian-app-zi-jin-cheng-ji-lu-ri-zhi-local/"/>
      <url>2021/05/14/wds2-qi-di-31-ke-1-ying-yong-cheng-xu-diao-shi-zhi-shi-yong-strace-strace-o-log.txt-rmmod-app-trace-fu-jin-cheng-chuang-jian-app-zi-jin-cheng-ji-lu-ri-zhi-local/</url>
      
        <content type="html"><![CDATA[<p> strace是一种调试工具，需要自己下载 打补丁 编译然后生成可执行文件。用可执行文件跟踪app输出到日志。</p><h1 id="strace-原理"><a href="#strace-原理" class="headerlink" title="strace 原理"></a>strace 原理</h1><p>在使用时是这样： <code>strace -o log.txt rmmod app</code>，跟踪某个app<br>strace本身是父进程，通过上面会创建app子进程，app在进行系统调用时，read write open时会发生swi异常（软中断异常），在异常处理函数中判断是否被跟踪，若被跟踪则休眠等待父进程处理结束再往下执行。（通常父进程记录子进程调用的系统函数等等）</p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux ubuntu的一些命令 linux目录的意义 版本号-主版本-稳定or开发-修订次数</title>
      <link href="2021/05/14/linux-ubuntu-de-yi-xie-ming-ling-linux-mu-lu-de-yi-yi-ban-ben-hao-zhu-ban-ben-wen-ding-or-kai-fa-xiu-ding-ci-shu-local/"/>
      <url>2021/05/14/linux-ubuntu-de-yi-xie-ming-ling-linux-mu-lu-de-yi-yi-ban-ben-hao-zhu-ban-ben-wen-ding-or-kai-fa-xiu-ding-ci-shu-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]</p><h3 id="开发板相关"><a href="#开发板相关" class="headerlink" title="开发板相关"></a>开发板相关</h3><h4 id="uboot"><a href="#uboot" class="headerlink" title="uboot"></a>uboot</h4><p>设置bootargs： <code>set bootargs noinitrd root=/dev/mtdblock3 rootfstype=yaffs2 init=/linuxrc console=ttySAC0</code><br>设置bootcmd：  <code>set bootcmd nand read.jffs2 0x30007fc0 kernel;bootm 0x30007fc0</code><br> <code>set bootcmd nand read.jffs2 0x30007FC0 0X00060000 0X00200000</code></p><p><code>ping 192.168.0.120</code><br>从uboot进入菜单选项： <code>menu</code><br>查看nand分区别名：  <code>mtd</code><br>打印内存的内容： <code>md.w o</code></p><h4 id="重新编译uboot"><a href="#重新编译uboot" class="headerlink" title="重新编译uboot"></a>重新编译uboot</h4><ol><li><code>tar xjf u-boot-1.1.6.tar.bz2</code> 解压</li><li><code>cd u-boot-1.1.6/ </code>               到目录下</li><li><code>patch -p1 &lt; ../u-boot-1.1.6_jz2440.patch</code>  打补丁 </li><li><code>make 100ask24x0_config</code>                    配置make</li><li><code>make</code>                                      make<h4 id="重新烧写uboot"><a href="#重新烧写uboot" class="headerlink" title="重新烧写uboot"></a>重新烧写uboot</h4><code>sudo ./oflash u-boot.bin</code><h4 id="串口打印小工具"><a href="#串口打印小工具" class="headerlink" title="串口打印小工具"></a>串口打印小工具</h4><code>minicom： sudo minicom</code></li></ol><h4 id="tftp下载"><a href="#tftp下载" class="headerlink" title="tftp下载"></a>tftp下载</h4><p><strong>前提是开发板能ping同服务器，服务器的目录下有需要下载的文件。</strong><br>需要服务器支持tftp：<br>首先要安装tftp服务端：<code>sudo apt-get install tftpd-hpa</code>        //tftpd-hpa是服务器端<br>安装好后配置服务器的设置：<code>sudo gedit /etc/default/tftpd-hpa</code>，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"># <span class="token operator">/</span>etc<span class="token operator">/</span><span class="token keyword">default</span><span class="token operator">/</span>tftpd<span class="token operator">-</span>hpaTFTP_USERNAME<span class="token operator">=</span><span class="token string">"tftp"</span>TFTP_DIRECTORY<span class="token operator">=</span><span class="token string">"/media/D/tftp"</span>TFTP_ADDRESS<span class="token operator">=</span><span class="token string">":69"</span>TFTP_OPTIONS<span class="token operator">=</span><span class="token string">"--secure"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>新建目录给权限：<br><code>chmod 777 ./tftp</code><br>重新启动tftp服务：<code>sudo service tftpd-hpa restart</code></p><ol><li><strong>开发板uboot下：</strong><br><code>tftp 30007FC0 uImage</code><br><code>nand erase kernel</code><br><code>nand write 30007FC0 kernel</code></li><li><strong>开发板下载sysfile：</strong><br>tftp 30000000 <h3 id="linux系统"><a href="#linux系统" class="headerlink" title="linux系统"></a>linux系统</h3><h4 id="设置网络ip：-ifconfig-eth0-192-168-0-232"><a href="#设置网络ip：-ifconfig-eth0-192-168-0-232" class="headerlink" title="设置网络ip： ifconfig eth0 192.168.0.232"></a>设置网络ip： <code>ifconfig eth0 192.168.0.232</code></h4><h4 id="创建软链接"><a href="#创建软链接" class="headerlink" title="创建软链接"></a>创建软链接</h4><code>sudo ln -s /media/wuyexkx/000451040000EB1D/Users/wuyexkx/Desktop /home/wuyexkx/Desktop</code><br><code>sudo ln -s /media/wuyexkx/DA18EBFA09C1B27D/韦东山 /home/wuyexkx/Desktop</code><br><code>sudo ln -s /media/wuyexkx/DA18EBFA09C1B27D/tftp /home/wuyexkx/Desktop</code><h4 id="后台运行程序-脚本"><a href="#后台运行程序-脚本" class="headerlink" title="后台运行程序/脚本"></a>后台运行程序/脚本</h4><code>xxx &amp;</code><h4 id="查看资源占用情况"><a href="#查看资源占用情况" class="headerlink" title="查看资源占用情况"></a>查看资源占用情况</h4><code>top</code><h3 id="配置SSH远程"><a href="#配置SSH远程" class="headerlink" title="配置SSH远程"></a>配置SSH远程</h3><h4 id="Ubuntu默认没有安装SSH-Server，使用以下命令安装："><a href="#Ubuntu默认没有安装SSH-Server，使用以下命令安装：" class="headerlink" title="Ubuntu默认没有安装SSH Server，使用以下命令安装："></a>Ubuntu默认没有安装SSH Server，使用以下命令安装：</h4><code>sudo apt-get install openssh-server</code><br>然后确认sshserver是否启动了<br><code>ps -e|grep ssh</code>  或用<code>netstat -tlp</code>命令<br>如果只有ssh-agent那ssh-server还没有启动，<br>需要<code>/etc/init.d/ssh start</code>，如果看到sshd那说明ssh-server已经启动了。<br>如果没有则可以这样启动：<br><code>sudo/etc/init.d/ssh start</code><h4 id="重启服务"><a href="#重启服务" class="headerlink" title="重启服务"></a>重启服务</h4><code>sudo service ssh restart</code><h4 id="创建快捷方式"><a href="#创建快捷方式" class="headerlink" title="创建快捷方式"></a>创建快捷方式</h4>假设要在 /A下创建 /B/C 的快捷方式：<code>ln -s /B/C /A</code><h4 id="查找"><a href="#查找" class="headerlink" title="查找"></a>查找</h4><code> find -name &quot;*defconfig*&quot;</code><h4 id="磁盘变只读修改"><a href="#磁盘变只读修改" class="headerlink" title="磁盘变只读修改"></a>磁盘变只读修改</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">方法<span class="token number">1</span>：df <span class="token operator">-</span>h <span class="token comment">// 查看是哪个盘</span>sudo mount <span class="token operator">-</span>o remount<span class="token punctuation">,</span>rw <span class="token operator">/</span>dev<span class="token operator">/</span>xxx  <span class="token comment">// 重新挂在，改变权限</span>方法<span class="token number">2</span>：卸载U盘： umount <span class="token operator">/</span>media<span class="token operator">/</span>pcname<span class="token operator">/</span>sdb1检查修复：dosfsck <span class="token operator">-</span>a <span class="token operator">/</span>dev<span class="token operator">/</span>sdb1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="自动挂载外盘"><a href="#自动挂载外盘" class="headerlink" title="自动挂载外盘"></a>自动挂载外盘</h3>linux开机默认只挂在系统盘，其他盘需要手动挂在。</li><li>获取分区类型 <code>sudo blkid  </code></li><li>编辑/etc/fstab文件<code>sudo gedit /etc/fstab </code></li><li>在配置文件末行添加在末行加上<br><code>/dev/sda1 /media/C ntfs defaults 0 0</code><br><code>/dev/sda1 /media/D ntfs defaults 0 0</code><br>有两项需要自己修改，sda1为挂在的哪个分区，ntfs该分区的格式。<h3 id="ubuntu卡死，解决办法"><a href="#ubuntu卡死，解决办法" class="headerlink" title="ubuntu卡死，解决办法"></a>ubuntu卡死，解决办法</h3>如果还可以进终端，<code>sudo pkill Xorg</code>，然后重新登录一下。<br>如果不能进终端了，<code>ctrl + alt + f1</code>，然后输入<code>sudo lightdm restart</code>注销<h3 id="文件夹权限"><a href="#文件夹权限" class="headerlink" title="文件夹权限"></a>文件夹权限</h3><code>sudo chmod -R 777 xxx</code><h3 id="linux目录下的文件意义"><a href="#linux目录下的文件意义" class="headerlink" title="linux目录下的文件意义"></a>linux目录下的文件意义</h3>/proc 是虚拟文件系统，存放进程相关的状态信息，用户与内核通信的纽带之一。<br>/sys 虚拟文件系统，包含所有系统硬件的层级视图，把设备和总线组成分级文件，就是展示设备驱动模型各组件的关系。<pre class="line-numbers language-c" data-language="c"><code class="language-c">dev<span class="token operator">/</span>xxx <span class="token comment">// 设备节点，xxx为设备节点名称</span>proc<span class="token operator">/</span>devices<span class="token comment">// 主设备号和对应名称保存的文件 1 mem</span>proc<span class="token operator">/</span>PID<span class="token operator">/</span>maps<span class="token comment">// 一个进程的所有vma在虚拟地址空间的分布情况,每个segment用一个vm_area_struct（以vma）结构体表示</span>proc<span class="token operator">/</span>iomem<span class="token comment">// 查看kernel的text data bss内存分布，是物理地址</span>proc<span class="token operator">/</span>zoneinfo<span class="token comment">// 包含由内存frame页框组成的zone内存域组成的node的信息</span>proc<span class="token operator">/</span>interupts<span class="token comment">// 包含中断信息，控制器名称 中断名称等等</span><span class="token operator">/</span>mnt<span class="token comment">// 挂在的文件系统</span><span class="token operator">/</span>sys<span class="token operator">/</span>class<span class="token operator">/</span><span class="token comment">// mdev自动创建设备节点的根据 是 这个内核信息 /sys/class/class_name/dev_node_name/dev</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h1 id="linux版本号"><a href="#linux版本号" class="headerlink" title="linux版本号"></a>linux版本号</h1><p>Linux内核版本有两种：稳定版和开发版<br>Linux内核版本号由3组数字组成：第一个组数字.第二组数字.第三组数字</p><p>第一个组数字：目前发布的内核主版本。<br>第二个组数字：偶数表示稳定版本；奇数表示开发中版本。<br>第三个组数字：错误修补的次数。</p><p>例： 2.6.18-128.ELsmp ,</p><p> 第一个组数字: 2 , 主版本号<br> 第二个组数字: 6 , 次版本号，表示稳定版本(因为有偶数)<br> 第三个组数字 18 , 修订版本号 ， 表示修改的次数，头两个数字合在一齐可以描述内核系列。如稳定版的2.6.0，它是2.6版内核系列。128: 表示这个当前版本的第5次微调patch ， 而ELsmp指出了当前内核是为ELsmp特别调校的 EL : Enterprise Linux ； smp : 表示支持多处理器 ， 表示该内核版本支持多处理器</p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>16位cpu接8位ram 汉字字库存储检索 时间变化显示 模拟MessageBox函数 局部变量和形参才能是寄存器变量 取余位移操作</title>
      <link href="2021/05/14/16-wei-cpu-jie-8-wei-ram-han-zi-zi-ku-cun-chu-jian-suo-shi-jian-bian-hua-xian-shi-mo-ni-messagebox-han-shu-ju-bu-bian-liang-he-xing-can-cai-neng-shi-ji-cun-qi-bian-liang-qu-yu-wei-yi-cao-zuo-local/"/>
      <url>2021/05/14/16-wei-cpu-jie-8-wei-ram-han-zi-zi-ku-cun-chu-jian-suo-shi-jian-bian-hua-xian-shi-mo-ni-messagebox-han-shu-ju-bu-bian-liang-he-xing-can-cai-neng-shi-ji-cun-qi-bian-liang-qu-yu-wei-yi-cao-zuo-local/</url>
      
        <content type="html"><![CDATA[<p><a href="https://mp.weixin.qq.com/s/w3-3nyYk0qQ9lk05asFz9w">https://mp.weixin.qq.com/s/w3-3nyYk0qQ9lk05asFz9w</a></p><p>经典：C语言在嵌入式系统编程时的注意事项<br>嵌入式ARM 昨天</p><p>C语言是一门通用计算机编程语言，应用广泛。C语言的设计目标是提供一种能以简易的方式编译、处理低级存储器、产生少量的机器码以及不需要任何运行环境支持便能运行的编程语言。<br>尽管C语言提供了许多低级处理的功能，但仍然保持着良好跨平台的特性，以一个标准规格写出的C语言程序可在许多电脑平台上进行编译，甚至包含一些嵌入式处理器（单片机或称MCU）以及超级电脑等作业平台。<br>20世纪80年代，为了避免各开发厂商用的C语言语法产生差异，由美国国家标准局为C语言订定了一套完整的国际标准语法，称为ANSI C，作为C语言最初的标准。　　</p><p>C语言嵌入式系统编程注意事项<br>不同于一般形式的软件编程，嵌入式系统编程建立在特定的硬件平台上，势必要求其编程语言具备较强的硬件直接操作能力。无疑，汇编语言具备这样的特质。但是，归因于汇编语言开发过程的复杂性，它并不是嵌入式系统开发的一般选择。而与之相比，C语言–一种“高级的低级”语言，则成为嵌入式系统开发的最佳选择。笔者在嵌入式系统项目的开发过程中，一次又一次感受到C语言的精妙，沉醉于C语言给嵌入式开发带来的便利。<br>大多数嵌入式系统的硬件平台。它包括两部分：<br>（1） 以通用处理器为中心的协议处理模块，用于网络控制协议的处理；<br>（2） 以数字信号处理器（DSP）为中心的信号处理模块，用于调制、解调和数/模信号转换。<br>本文的讨论主要围绕以通用处理器为中心的协议处理模块进行，因为它更多地牵涉到具体的C语言编程技巧。而DSP编程则重点关注具体的数字信号处理算法，主要涉及通信领域的知识，不是本文的讨论重点。<br>着眼于讨论普遍的嵌入式系统C编程技巧，系统的协议处理模块没有选择特别的CPU，而是选择了众所周知的CPU芯片–80186，每一位学习过《微机原理》的读者都应该对此芯片有一个基本的认识，且对其指令集比较熟悉。80186的字长是16位，可以寻址到的内存空间为1MB，只有实地址模式。C语言编译生成的指针为32位（双字），高16位为段地址，低16位为段内编译，一段最多64KB。<br>协议处理模块中的FLASH和RAM几乎是每个嵌入式系统的必备设备，前者用于存储程序，后者则是程序运行时指令及数据的存放位置。系统所选择的FLASH和RAM的位宽都为16位，与CPU一致。<br>实时钟芯片可以为系统定时，给出当前的年、月、日及具体时间（小时、分、秒及毫秒），可以设定其经过一段时间即向CPU提出中断或设定报警时间到来时向CPU提出中断（类似闹钟功能）。<br>NVRAM（非易失去性RAM）具有掉电不丢失数据的特性，可以用于保存系统的设置信息，譬如网络协议参数等。在系统掉电或重新启动后，仍然可以读取先前的设置信息。其位宽为8位，比CPU字长小。文章特意选择一个与CPU字长不一致的存储芯片，为后文中一节的讨论创造条件。<br>UART则完成CPU并行数据传输与RS-232串行数据传输的转换，它可以在接收到［1~MAX_BUFFER］字节后向CPU提出中断，MAX_BUFFER为UART芯片存储接收到字节的最大缓冲区。<br>键盘控制器和显示控制器则完成系统人机界面的控制。<br>以上提供的是一个较完备的嵌入式系统硬件架构，实际的系统可能包含更少的外设。之所以选择一个完备的系统，是为了后文更全面的讨论嵌入式系统C语言编程技巧的方方面面，所有设备都会成为后文的分析目标。<br>嵌入式系统需要良好的软件开发环境的支持，由于嵌入式系统的目标机资源受限，不可能在其上建立庞大、复杂的开发环境，因而其开发环境和目标运行环境相互分离。因此，嵌入式应用软件的开发方式一般是，在宿主机（Host）上建立开发环境，进行应用程序编码和交叉编译，然后宿主机同目标机（Target）建立连接，将应用程序下载到目标机上进行交叉调试，经过调试和优化，最后将应用程序固化到目标机中实际运行。<br>CAD-UL是适用于x86处理器的嵌入式应用软件开发环境，它运行在Windows操作系统之上，可生成x86处理器的目标代码并通过PC机的COM口（RS-232串口）或以太网口下载到目标机上运行。其驻留于目标机FLASH存储器中的monitor程序可以监控宿主机Windows调试平台上的用户调试指令，获取CPU寄存器的值及目标机存储空间、I/O空间的内容。<br>后续章节将从软件架构、内存操作、屏幕操作、键盘操作、性能优化等多方面阐述C语言嵌入式系统的编程技巧。软件架构是一个宏观概念，与具体硬件的联系不大；内存操作主要涉及系统中的FLASH、RAM和NVRAM芯片；屏幕操作则涉及显示控制器和实时钟；键盘操作主要涉及键盘控制器；性能优化则给出一些具体的减小程序时间、空间消耗的技巧。<br>在我们的修炼旅途中将经过25个关口，这些关口主分为两类，一类是技巧型，有很强的适用性；一类则是常识型，在理论上有些意义。<br>So， let’s go.<br>C语言嵌入式系统编程注意事项之软件架构篇<br>模块划分的“划”是规划的意思，意指怎样合理的将一个很大的软件划分为一系列功能独立的部分合作完成系统的需求。<br>模块划分<br>模块划分的“划”是规划的意思，意指怎样合理的将一个很大的软件划分为一系列功能独立的部分合作完成系统的需求。C语言作为一种结构化的程序设计语言，在模块的划分上主要依据功能（依功能进行划分在面向对象设计中成为一个错误，牛顿定律遇到了相对论），C语言模块化程序设计需理解如下概念：<br>（1） 模块即是一个.c文件和一个.h文件的结合，头文件（.h）中是对于该模块接口的声明；<br>（2） 某模块提供给其它模块调用的外部函数及数据需在.h中文件中冠以extern关键字声明；<br>（3） 模块内的函数和全局变量需在.c文件开头冠以staTIc关键字声明；<br>（4） 永远不要在.h文件中定义变量！定义变量和声明变量的区别在于定义会产生内存分配的操作，是汇编阶段的概念；而声明则只是告诉包含该声明的模块在连接阶段从其它模块寻找外部函数和变量。如：</p><p>　　/<em>module1.h</em>/<br>　　int a = 5; /* 在模块1的.h文件中定义int a <em>/<br>　　/<em>module1 .c</em>/<br>　　#include “module1.h” /</em> 在模块1中包含模块1的.h文件 <em>/<br>　　/<em>module2 .c</em>/<br>　　＃include “module1.h” /</em> 在模块2中包含模块1的.h文件 <em>/<br>　　/<em>module3 .c</em>/<br>　　＃include “module1.h” /</em> 在模块3中包含模块1的.h文件 */</p><p>以上程序的结果是在模块1、2、3中都定义了整型变量a，a在不同的模块中对应不同的地址单元，这个世界上从来不需要这样的程序。正确的做法是：</p><p>　　/<em>module1.h</em>/<br>　　extern int a; /* 在模块1的.h文件中声明int a <em>/<br>　　/<em>module1 .c</em>/<br>　　＃include “module1.h” /</em> 在模块1中包含模块1的.h文件 <em>/<br>　　int a = 5; /</em> 在模块1的.c文件中定义int a <em>/<br>　　/<em>module2 .c</em>/<br>　　＃include “module1.h” /</em> 在模块2中包含模块1的.h文件 <em>/<br>　　/<em>module3 .c</em>/<br>　　＃include “module1.h” /</em> 在模块3中包含模块1的.h文件 */</p><p>这样如果模块1、2、3操作a的话，对应的是同一片内存单元。<br>一个嵌入式系统通常包括两类模块：<br>（1）硬件驱动模块，一种特定硬件对应一个模块；<br>（2）软件功能模块，其模块的划分应满足低偶合、高内聚的要求。<br>多任务还是单任务<br>所谓“单任务系统”是指该系统不能支持多任务并发操作，宏观串行地执行一个任务。而多任务系统则可以宏观并行（微观上可能串行）地“同时”执行多个任务。<br>多任务的并发执行通常依赖于一个多任务操作系统（OS），多任务OS的核心是系统调度器，它使用任务控制块（TCB）来管理任务调度功能。TCB包括任务的当前状态、优先级、要等待的事件或资源、任务程序码的起始地址、初始堆栈指针等信息。调度器在任务被激活时，要用到这些信息。此外，TCB还被用来存放任务的“上下文”（context）。任务的上下文就是当一个执行中的任务被停止时，所要保存的所有信息。通常，上下文就是计算机当前的状态，也即各个寄存器的内容。当发生任务切换时，当前运行的任务的上下文被存入TCB，并将要被执行的任务的上下文从它的TCB中取出，放入各个寄存器中。<br>嵌入式多任务OS的典型例子有Vxworks、ucLinux等。嵌入式OS并非遥不可及的神坛之物，我们可以用不到1000行代码实现一个针对80186处理器的功能最简单的OS内核，作者正准备进行此项工作，希望能将心得贡献给大家。<br>究竟选择多任务还是单任务方式，依赖于软件的体系是否庞大。例如，绝大多数手机程序都是多任务的，但也有一些小灵通的协议栈是单任务的，没有操作系统，它们的主程序轮流调用各个软件模块的处理程序，模拟多任务环境。<br>单任务程序典型架构<br>（1）从CPU复位时的指定地址开始执行；<br>（2）跳转至汇编代码startup处执行；<br>（3）跳转至用户主程序main执行，在main中完成：<br>       a.初试化各硬件设备；<br>　　b.初始化各软件模块；<br>　　c.进入死循环（无限循环），调用各模块的处理函数<br>用户主程序和各模块的处理函数都以C语言完成。用户主程序最后都进入了一个死循环，其首选方案是：</p><p>　　while（1）<br>　　{<br>　　}</p><p>有的程序员这样写：</p><p>　　for（;;）<br>　　{<br>　　}</p><p>这个语法没有确切表达代码的含义，我们从for（;;）看不出什么，只有弄明白for（;;）在C语言中意味着无条件循环才明白其意。<br>下面是几个“著名”的死循环：<br>（1）操作系统是死循环；<br>（2）WIN32程序是死循环；<br>（3）嵌入式系统软件是死循环；<br>（4）多线程程序的线程处理函数是死循环。<br>你可能会辩驳，大声说：“凡事都不是绝对的，2、3、4都可以不是死循环”。Yes，you are right，但是你得不到鲜花和掌声。实际上，这是一个没有太大意义的牛角尖，因为这个世界从来不需要一个处理完几个消息就喊着要OS杀死它的WIN32程序，不需要一个刚开始RUN就自行了断的嵌入式系统，不需要莫名其妙启动一个做一点事就干掉自己的线程。有时候，过于严谨制造的不是便利而是麻烦。君不见，五层的TCP/IP协议栈超越严谨的ISO/OSI七层协议栈大行其道成为事实上的标准？<br>经常有网友讨论：</p><p>　　printf（“%d，%d”，++i，i++）; /* 输出是什么？*/<br>　　c = a+++b; /* c=？ */</p><p>等类似问题。面对这些问题，我们只能发出由衷的感慨：世界上还有很多有意义的事情等着我们去消化摄入的食物。<br>实际上，嵌入式系统要运行到世界末日。<br>中断服务程序<br>中断是嵌入式系统中重要的组成部分，但是在标准C中不包含中断。许多编译开发商在标准C上增加了对中断的支持，提供新的关键字用于标示中断服务程序（ISR），类似于__interrupt、#program interrupt等。当一个函数被定义为ISR的时候，编译器会自动为该函数增加中断服务程序所需要的中断现场入栈和出栈代码。<br>中断服务程序需要满足如下要求：<br>（1）不能返回值；<br>（2）不能向ISR传递参数；<br>（3） ISR应该尽可能的短小精悍；<br>（4） printf（char * lpFormatString，…）函数会带来重入和性能问题，不能在ISR中采用。<br>在某项目的开发中，我们设计了一个队列，在中断服务程序中，只是将中断类型添加入该队列中，在主程序的死循环中不断扫描中断队列是否有中断，有则取出队列中的第一个中断类型，进行相应处理。</p><p>　　/* 存放中断的队列 <em>/<br>　　typedef struct tagIntQueue<br>　　{<br>　　int intType; /</em> 中断类型 */<br>　　struct tagIntQueue <em>next;<br>　　}IntQueue;<br>　　IntQueue lpIntQueueHead;<br>　　__interrupt ISRexample （）<br>　　{<br>　　int intType;<br>　　intType = GetSystemType（）;<br>　　QueueAddTail（lpIntQueueHead， intType）；/</em> 在队列尾加入新的中断 */<br>　　}</p><p>在主程序循环中判断是否有中断：</p><p>　　While（1）<br>　　{<br>　　If（ ！IsIntQueueEmpty（） ）<br>　　{<br>　　intType = GetFirsTInt（）;<br>　　switch（intType） /* 是不是很象WIN32程序的消息解析函数？ <em>/<br>　　{<br>　　/</em> 对，我们的中断类型解析很类似于消息驱动 <em>/<br>　　case xxx： /</em> 我们称其为“中断驱动”吧？ */<br>　　…<br>　　break;<br>　　case xxx：<br>　　…<br>　　break;<br>　　…<br>　　}<br>　　}<br>　　}</p><p>按上述方法设计的中断服务程序很小，实际的工作都交由主程序执行了。<br>模块划分的“划”是规划的意思，意指怎样合理的将一个很大的软件划分为一系列功能独立的部分合作完成系统的需求<br>硬件驱动模块<br>一个硬件驱动模块通常应包括如下函数：<br>（1）中断服务程序ISR<br>（2）硬件初始化<br>　　a.修改寄存器，设置硬件参数（如UART应设置其波特率，AD/DA设备应设置其采样速率等）；<br>　　b.将中断服务程序入口地址写入中断向量表：<br>　　/* 设置中断向量表 <em>/<br>　　m_myPtr = make_far_pointer（0l）; /</em> 返回void far型指针void far * <em>/<br>　　m_myPtr += ITYPE_UART; /</em> ITYPE_UART： uart中断服务程序 <em>/<br>　　/</em> 相对于中断向量表首地址的偏移 */<br>　　<em>m_myPtr = &amp;UART _Isr; /</em> UART _Isr：UART的中断服务程序 */</p><p>（3）设置CPU针对该硬件的控制线<br>　　a.如果控制线可作PIO（可编程I/O）和控制信号用，则设置CPU内部对应寄存器使其作为控制信号；<br>　　b.设置CPU内部的针对该设备的中断屏蔽位，设置中断方式（电平触发还是边缘触发）。<br>（4）提供一系列针对该设备的操作接口函数。例如，对于LCD，其驱动模块应提供绘制像素、画线、绘制矩阵、显示字符点阵等函数；而对于实时钟，其驱动模块则需提供获取时间、设置时间等函数。<br>C的面向对象化<br>在面向对象的语言里面，出现了类的概念。类是对特定数据的特定操作的集合体。类包含了两个范畴：数据和操作。而C语言中的struct仅仅是数据的集合，我们可以利用函数指针将struct模拟为一个包含数据和操作的“类”。下面的C程序模拟了一个最简单的“类”：<br>　　#ifndef C_Class<br>　　#define C_Class struct<br>　　#endif<br>　　C_Class A<br>　　{<br>　　C_Class A <em>A_this; /</em> this指针 <em>/<br>　　void （</em>Foo）（C_Class A <em>A_this）; /</em> 行为：函数指针 <em>/<br>　　int a; /</em> 数据 */<br>　　int b;<br>　　};</p><p>我们可以利用C语言模拟出面向对象的三个特性：封装、继承和多态，但是更多的时候，我们只是需要将数据与行为封装以解决软件结构混乱的问题。C模拟面向对象思想的目的不在于模拟行为本身，而在于解决某些情况下使用C语言编程时程序整体框架结构分散、数据和函数脱节的问题。我们在后续章节会看到这样的例子。<br>总结<br>本篇介绍了嵌入式系统编程软件架构方面的知识，主要包括模块划分、多任务还是单任务选取、单任务程序典型架构、中断服务程序、硬件驱动模块设计等，从宏观上给出了一个嵌入式系统软件所包含的主要元素。<br>请记住：软件结构是软件的灵魂！结构混乱的程序面目可憎，调试、测试、维护、升级都极度困难。<br>C语言嵌入式系统编程注意事项之内存操作<br>在嵌入式系统的编程中，常常要求在特定的内存单元读写内容，汇编有对应的MOV指令，而除C/C++以外的其它编程语言基本没有直接访问绝对地址的能力<br>数据指针<br>在嵌入式系统的编程中，常常要求在特定的内存单元读写内容，汇编有对应的MOV指令，而除C/C++以外的其它编程语言基本没有直接访问绝对地址的能力。在嵌入式系统的实际调试中，多借助C语言指针所具有的对绝对地址单元内容的读写能力。以指针直接操作内存多发生在如下几种情况：<br>（1） 某I/O芯片被定位在CPU的存储空间而非I/O空间，而且寄存器对应于某特定地址；<br>（2） 两个CPU之间以双端口RAM通信，CPU需要在双端口RAM的特定单元（称为mail box）书写内容以在对方CPU产生中断；<br>（3） 读取在ROM或FLASH的特定单元所烧录的汉字和英文字模。<br>譬如：<br>　　unsigned char *p = （unsigned char *）0xF000FF00;<br>　　*p=11;</p><p>以上程序的意义为在绝对地址0xF0000+0xFF00（80186使用16位段地址和16位偏移地址）写入11。<br>在使用绝对地址指针时，要注意指针自增自减操作的结果取决于指针指向的数据类别。上例中p++后的结果是p= 0xF000FF01，若p指向int，即：<br>　　int *p = （int *）0xF000FF00;</p><p>　　p++（或++p）的结果等同于：p = p+sizeof（int），而p-（或-p）的结果是p = p-sizeof（int）。<br>同理，若执行：</p><p>　　long int *p = （long int *）0xF000FF00;</p><p>则p++（或++p）的结果等同于：p = p+sizeof（long int） ，而p-（或-p）的结果是p = p-sizeof（long int）。<br>记住：CPU以字节为单位编址，而C语言指针以指向的数据类型长度作自增和自减。理解这一点对于以指针直接操作内存是相当重要的。<br>函数指针<br>首先要理解以下三个问题：<br>（1）C语言中函数名直接对应于函数生成的指令代码在内存中的地址，因此函数名可以直接赋给指向函数的指针；<br>（2）调用函数实际上等同于“调转指令＋参数传递处理＋回归位置入栈”，本质上最核心的操作是将函数生成的目标代码的首地址赋给CPU的PC寄存器；<br>（3）因为函数调用的本质是跳转到某一个地址单元的code去执行，所以可以“调用”一个根本就不存在的函数实体，晕？请往下看：<br>请拿出你可以获得的任何一本大学《微型计算机原理》教材，书中讲到，186 CPU启动后跳转至绝对地址0xFFFF0（对应C语言指针是0xF000FFF0，0xF000为段地址，0xFFF0为段内偏移）执行，请看下面的代码：<br>　　typedef void （<em>lp） （ ）; /</em> 定义一个无参数、无返回类型的 <em>/<br>　　/</em> 函数指针类型 <em>/<br>　　lp lpReset = （lp）0xF000FFF0; /</em> 定义一个函数指针，指向*/<br>　　/* CPU启动后所执行第一条指令的位置 <em>/<br>　　lpReset（）; /</em> 调用函数 */</p><p>在以上的程序中，我们根本没有看到任何一个函数实体，但是我们却执行了这样的函数调用：lpReset（），它实际上起到了“软重启”的作用，跳转到CPU启动后第一条要执行的指令的位置。<br>记住：函数无它，唯指令集合耳；你可以调用一个没有函数体的函数，本质上只是换一个地址开始执行指令！<br>数组vs动态申请<br>在嵌入式系统中动态内存申请存在比一般系统编程时更严格的要求，这是因为嵌入式系统的内存空间往往是十分有限的，不经意的内存泄露会很快导致系统的崩溃。<br>所以一定要保证你的malloc和free成对出现，如果你写出这样的一段程序：</p><p>　　char * （void）<br>　　{<br>　　char *p;<br>　　p = （char <em>）malloc（…）;<br>　　if（p==NULL）<br>　　…;<br>　　… /</em> 一系列针对p的操作 */<br>　　return p;<br>　　}</p><p>在某处调用（），用完中动态申请的内存后将其free，如下：</p><p>　　char *q = （）;<br>　　…<br>　　free（q）;</p><p>上述代码明显是不合理的，因为违反了malloc和free成对出现的原则，即“谁申请，就由谁释放”原则。不满足这个原则，会导致代码的耦合度增大，因为用户在调用函数时需要知道其内部细节！<br>正确的做法是在调用处申请内存，并传入函数，如下：</p><p>　　char *p=malloc（…）;<br>　　if（p==NULL）<br>　　…;<br>　　（p）;<br>　　…<br>　　free（p）;<br>　　p=NULL;</p><p>而函数则接收参数p，如下：</p><p>　　void （char <em>p）<br>　　{<br>　　… /</em> 一系列针对p的操作 */<br>　　}</p><p>基本上，动态申请内存方式可以用较大的数组替换。对于编程新手，笔者推荐你尽量采用数组！嵌入式系统可以以博大的胸襟接收瑕疵，而无法“海纳”错误。毕竟，以最笨的方式苦练神功的郭靖胜过机智聪明却范政治错误走反革命道路的杨康。<br>给出原则：<br>（1）尽可能的选用数组，数组不能越界访问（真理越过一步就是谬误，数组越过界限就光荣地成全了一个混乱的嵌入式系统）；<br>（2）如果使用动态申请，则申请后一定要判断是否申请成功了，并且malloc和free应成对出现！<br>在嵌入式系统的编程中，常常要求在特定的内存单元读写内容，汇编有对应的MOV指令，而除C/C++以外的其它编程语言基本没有直接访问绝对地址的能力<br>关键字const<br>const意味着“只读”。区别如下代码的功能非常重要，也是老生长叹，如果你还不知道它们的区别，而且已经在程序界摸爬滚打多年，那只能说这是一个悲哀：</p><p>　　const int a;<br>　　int const a;<br>　　const int *a;<br>　　int * const a;<br>　　int const * a const;</p><p>（1） 关键字const的作用是为给读你代码的人传达非常有用的信息。例如，在函数的形参前添加const关键字意味着这个参数在函数体内不会被修改，属于“输入参数”。在有多个形参的时候，函数的调用者可以凭借参数前是否有const关键字，清晰的辨别哪些是输入参数，哪些是可能的输出参数。<br>（2）合理地使用关键字const可以使编译器很自然地保护那些不希望被改变的参数，防止其被无意的代码修改，这样可以减少bug的出现。<br>const在C++语言中则包含了更丰富的含义，而在C语言中仅意味着：“只能读的普通变量”，可以称其为“不能改变的变量”（这个说法似乎很拗口，但却最准确的表达了C语言中const的本质），在编译阶段需要的常数仍然只能以#define宏定义！故在C语言中如下程序是非法的：</p><p>　　const int SIZE = 10;<br>　　char a［SIZE］; /* 非法：编译阶段不能用到变量 */<br>　　关键字volaTIle<br>　　C语言编译器会对用户书写的代码进行优化，譬如如下代码：<br>　　int a，b，c;<br>　　a = inWord（0x100）; /<em>读取I/O空间0x100端口的内容存入a变量</em>/<br>　　b = a;<br>　　a = inWord （0x100）; /<em>再次读取I/O空间0x100端口的内容存入a变量</em>/<br>　　c = a;</p><p>　　很可能被编译器优化为：</p><p>　　int a，b，c;<br>　　a = inWord（0x100）; /<em>读取I/O空间0x100端口的内容存入a变量</em>/<br>　　b = a;<br>　　c = a;</p><p>但是这样的优化结果可能导致错误，如果I/O空间0x100端口的内容在执行第一次读操作后被其它程序写入新值，则其实第2次读操作读出的内容与第一次不同，b和c的值应该不同。在变量a的定义前加上volaTIle关键字可以防止编译器的类似优化，正确的做法是：</p><p>　　volatile int a；</p><p>volatile变量可能用于如下几种情况：<br>（1） 并行设备的硬件寄存器（如：状态寄存器，例中的代码属于此类）；<br>（2） 一个中断服务子程序中会访问到的非自动变量（也就是全局变量）；<br>（3） 多线程应用中被几个任务共享的变量。<br>CPU字长与存储器位宽不一致处理<br>在背景篇中提到，本文特意选择了一个与CPU字长不一致的存储芯片，就是为了进行本节的讨论，解决CPU字长与存储器位宽不一致的情况。80186的字长为16，而NVRAM的位宽为8，在这种情况下，我们需要为NVRAM提供读写字节、字的接口，如下：</p><p>　　typedef unsigned char BYTE;<br>　　typedef unsigned int WORD;<br>　　/* 函数功能：读NVRAM中字节<br>　　* 参数：wOffset，读取位置相对NVRAM基地址的偏移<br>　　* 返回：读取到的字节值<br>　　<em>/<br>　　extern BYTE ReadByteNVRAM（WORD wOffset）<br>　　{<br>　　LPBYTE lpAddr = （BYTE</em>）（NVRAM + wOffset * 2）; /* 为什么偏移要×2？ <em>/<br>　　return <em>lpAddr;<br>　　}<br>　　/</em> 函数功能：读NVRAM中字<br>　　* 参数：wOffset，读取位置相对NVRAM基地址的偏移<br>　　* 返回：读取到的字<br>　　<em>/<br>　　extern WORD ReadWordNVRAM（WORD wOffset）<br>　　{<br>　　WORD wTmp = 0;<br>　　LPBYTE lpAddr;<br>　　/</em> 读取高位字节 <em>/<br>　　lpAddr = （BYTE</em>）（NVRAM + wOffset * 2）; /</em> 为什么偏移要×2？ <em>/<br>　　wTmp += （</em>lpAddr）<em>256;<br>　　/</em> 读取低位字节 <em>/<br>　　lpAddr = （BYTE</em>）（NVRAM + （wOffset +1） * 2）; /* 为什么偏移要×2？ */<br>　　wTmp += <em>lpAddr;<br>　　return wTmp;<br>　　}<br>　　/</em> 函数功能：向NVRAM中写一个字节<br>　　*参数：wOffset，写入位置相对NVRAM基地址的偏移<br>　　* byData，欲写入的字节<br>　　<em>/<br>　　extern void WriteByteNVRAM（WORD wOffset， BYTE byData）<br>　　{<br>　　…<br>　　}<br>　　/</em> 函数功能：向NVRAM中写一个字 */<br>　　*参数：wOffset，写入位置相对NVRAM基地址的偏移<br>　　* wData，欲写入的字<br>　　*/<br>　　extern void WriteWordNVRAM（WORD wOffset， WORD wData）<br>　　{<br>　　…<br>　　}</p><p>子贡问曰：Why偏移要乘以2？<br>子曰：16位80186与8位NVRAM之间互连只能以地址线A1对其A0，CPU本身的A0与NVRAM不连接。因此，NVRAM的地址只能是偶数地址，故每次以0x10为单位前进！<br>子贡再问：So why 80186的地址线A0不与NVRAM的A0连接？<br>子曰：请看《IT论语》之《微机原理篇》，那里面讲述了关于计算机组成的圣人之道。<br>总结<br>本篇主要讲述了嵌入式系统C编程中内存操作的相关技巧。掌握并深入理解关于数据指针、函数指针、动态申请内存、const及volatile关键字等的相关知识，是一个优秀的C语言程序设计师的基本要求。当我们已经牢固掌握了上述技巧后，我们就已经学会了C语言的99%，因为C语言最精华的内涵皆在内存操作中体现。<br>我们之所以在嵌入式系统中使用C语言进行程序设计，99%是因为其强大的内存操作能力！<br>如果你爱编程，请你爱C语言；<br>如果你爱C语言，请你爱指针；<br>如果你爱指针，请你爱指针的指针！<br>C语言嵌入式系统编程注意事项之屏幕操作<br>现在要解决的问题是，嵌入式系统中经常要使用的并非是完整的汉字库，往往只是需要提供数量有限的汉字供必要的显示功能<br>汉字处理<br>现在要解决的问题是，嵌入式系统中经常要使用的并非是完整的汉字库，往往只是需要提供数量有限的汉字供必要的显示功能。例如，一个微波炉的LCD上没有必要提供显示“电子邮件”的功能；一个提供汉字显示功能的空调的LCD上不需要显示一条“短消息”，诸如此类。但是一部手机、小灵通则通常需要包括较完整的汉字库。<br>如果包括的汉字库较完整，那么，由内码计算出汉字字模在库中的偏移是十分简单的：汉字库是按照区位的顺序排列的，前一个字节为该汉字的区号，后一个字节为该字的位号。每一个区记录94个汉字，位号则为该字在该区中的位置。因此，汉字在汉字库中的具体位置计算公式为：94<em>（区号-1）+位号-1。减1是因为数组是以0为开始而区号位号是以1为开始的。只需乘上一个汉字字模占用的字节数即可，即：（94</em>（区号-1）+位号-1）<em>一个汉字字模占用字节数，以16</em>16点阵字库为例，计算公式则为：（94<em>（区号-1）+（位号-1））</em>32。汉字库中从该位置起的32字节信息记录了该字的字模信息。<br>对于包含较完整汉字库的系统而言，我们可以以上述规则计算字模的位置。但是如果仅仅是提供少量汉字呢？譬如几十至几百个？最好的做法是：<br>定义宏：<br>　　# define EX_FONT_CHAR（）<br>　　# define EX_FONT_UNICODE_VAL（） （），<br>　　# define EX_FONT_ANSI_VAL（） （），</p><p>定义结构体：</p><p>　　typedef struct _wide_unicode_font16x16<br>　　{<br>　　WORD ; /* 内码 <em>/<br>　　BYTE data［32］; /</em> 字模点阵 <em>/<br>　　}Unicode;<br>　　#define CHINESE_CHAR_NUM … /</em> 汉字数量 */</p><p>字模的存储用数组：</p><p>　　Unicode chinese［CHINESE_CHAR_NUM］ =<br>　　{<br>　　{<br>　　EX_FONT_CHAR（“业”）<br>　　EX_FONT_UNICODE_VAL（0x4e1a）<br>　　{0x04， 0x40， 0x04， 0x40， 0x04， 0x40， 0x04， 0x44， 0x44， 0x46， 0x24， 0x4c， 0x24， 0x48， 0x14， 0x50， 0x1c， 0x50， 0x14， 0x60， 0x04， 0x40， 0x04， 0x40， 0x04， 0x44， 0xff， 0xfe， 0x00， 0x00， 0x00， 0x00}<br>　　}，<br>　　{<br>　　EX_FONT_CHAR（“中”）<br>　　EX_FONT_UNICODE_VAL（0x4e2d）<br>　　{0x01， 0x00， 0x01， 0x00， 0x21， 0x08， 0x3f， 0xfc， 0x21， 0x08， 0x21， 0x08， 0x21， 0x08， 0x21， 0x08， 0x21， 0x08，<br>　　0x3f， 0xf8， 0x21， 0x08， 0x01， 0x00， 0x01， 0x00， 0x01， 0x00， 0x01， 0x00， 0x01， 0x00}<br>　　}，<br>　　{<br>　　EX_FONT_CHAR（“云”）<br>　　EX_FONT_UNICODE_VAL（0x4e91）<br>　　{0x00， 0x00， 0x00， 0x30， 0x3f， 0xf8， 0x00， 0x00， 0x00， 0x00， 0x00， 0x0c， 0xff， 0xfe， 0x03， 0x00， 0x07， 0x00，<br>　　0x06， 0x40， 0x0c， 0x20， 0x18， 0x10， 0x31， 0xf8， 0x7f， 0x0c， 0x20， 0x08， 0x00， 0x00}<br>　　}，<br>　　{<br>　　EX_FONT_CHAR（“件”）<br>　　EX_FONT_UNICODE_VAL（0x4ef6）<br>　　{0x10， 0x40， 0x1a， 0x40， 0x13， 0x40， 0x32， 0x40， 0x23， 0xfc， 0x64， 0x40， 0xa4， 0x40， 0x28， 0x40， 0x2f， 0xfe，<br>　　0x20， 0x40， 0x20， 0x40， 0x20， 0x40， 0x20， 0x40， 0x20， 0x40， 0x20， 0x40， 0x20， 0x40}<br>　　}<br>　　}</p><p>要显示特定汉字的时候，只需要从数组中查找内码与要求汉字内码相同的即可获得字模。如果前面的汉字在数组中以内码大小顺序排列，那么可以以二分查找法更高效的查找到汉字的字模。<br>这是一种很有效的组织小汉字库的方法，它可以保证程序有很好的结构。<br>系统时间显示<br>从NVRAM中可以读取系统的时间，系统一般借助NVRAM产生的秒中断每秒读取一次当前时间并在LCD上显示。关于时间的显示，有一个效率问题。因为时间有其特殊性，那就是60秒才有一次分钟的变化，60分钟才有一次小时变化，如果我们每次都将读取的时间在屏幕上完全重新刷新一次，则浪费了大量的系统时间。<br>一个较好的办法是我们在时间显示函数中以静态变量分别存储小时、分钟、秒，只有在其内容发生变化的时候才更新其显示。</p><p>　　extern void DisplayTime（…）<br>　　{<br>　　static BYTE byHour，byMinute，bySecond;<br>　　BYTE byNewHour， byNewMinute， byNewSecond;<br>　　byNewHour = GetSysHour（）;<br>　　byNewMinute = GetSysMinute（）;<br>　　byNewSecond = GetSysSecond（）;<br>　　if（byNewHour！= byHour）<br>　　{<br>　　… /* 显示小时 <em>/<br>　　byHour = byNewHour;<br>　　}<br>　　if（byNewMinute！= byMinute）<br>　　{<br>　　… /</em> 显示分钟 <em>/<br>　　byMinute = byNewMinute;<br>　　}<br>　　if（byNewSecond！= bySecond）<br>　　{<br>　　… /</em> 显示秒钟 */<br>　　bySecond = byNewSecond;<br>　　}<br>　　}</p><p>这个例子也可以顺便作为C语言中static关键字强大威力的证明。当然，在C++语言里，static具有了更加强大的威力，它使得某些数据和函数脱离“对象”而成为“类”的一部分，正是它的这一特点，成就了软件的无数优秀设计。<br>动画显示<br>动画是无所谓有，无所谓无的，静止的画面走的路多了，也就成了动画。随着时间的变更，在屏幕上显示不同的静止画面，即是动画之本质。所以，在一个嵌入式系统的LCD上欲显示动画，必须借助定时器。没有硬件或软件定时器的世界是无法想像的：<br>（1） 没有定时器，一个操作系统将无法进行时间片的轮转，于是无法进行多任务的调度，于是便不再成其为一个多任务操作系统；<br>（2） 没有定时器，一个多媒体播放软件将无法运作，因为它不知道何时应该切换到下一帧画面；<br>（3） 没有定时器，一个网络协议将无法运转，因为其无法获知何时包传输超时并重传之，无法在特定的时间完成特定的任务。<br>因此，没有定时器将意味着没有操作系统、没有网络、没有多媒体，这将是怎样的黑暗？所以，合理并灵活地使用各种定时器，是对一个软件人的最基本需求！<br>在80186为主芯片的嵌入式系统中，我们需要借助硬件定时器的中断来作为软件定时器，在中断发生后变更画面的显示内容。在时间显示“xx:xx”中让冒号交替有无，每次秒中断发生后，需调用ShowDot：</p><p>　　void ShowDot（）<br>　　{<br>　　static BOOL bShowDot = TRUE; /* 再一次领略static关键字的威力 */<br>　　if（bShowDot）<br>　　{<br>　　showChar（’：’，xPos，yPos）;<br>　　}<br>　　else<br>　　{<br>　　showChar（’ ’，xPos，yPos）;<br>　　}<br>　　bShowDot = ！ bShowDot;<br>　　}</p><p>菜单操作<br>无数人为之绞尽脑汁的问题终于出现了，在这一节里，我们将看到，在C语言中哪怕用到一丁点的面向对象思想，软件结构将会有何等的改观！<br>要求以键盘上的“← →”键切换菜单焦点，当用户在焦点处于某菜单时，若敲击键盘上的OK、CANCEL键则调用该焦点菜单对应之处理函数。我曾经傻傻地这样做着：</p><p>　　/* 按下OK键 <em>/<br>　　void onOkKey（）<br>　　{<br>　　/</em> 判断在什么焦点菜单上按下Ok键，调用相应处理函数 <em>/<br>　　Switch（currentFocus）<br>　　{<br>　　case MENU1：<br>　　menu1OnOk（）;<br>　　break;<br>　　case MENU2：<br>　　menu2OnOk（）;<br>　　break;<br>　　…<br>　　}<br>　　}<br>　　/</em> 按下Cancel键 <em>/<br>　　void onCancelKey（）<br>　　{<br>　　/</em> 判断在什么焦点菜单上按下Cancel键，调用相应处理函数 <em>/<br>　　Switch（currentFocus）<br>　　{<br>　　case MENU1：<br>　　menu1OnCancel（）;<br>　　break;<br>　　case MENU2：<br>　　menu2OnCancel（）;<br>　　break;<br>　　…<br>　　}<br>　　}<br>　　终于有一天，我这样做了：<br>　　/</em> 将菜单的属性和操作“封装”在一起 <em>/<br>　　typedef struct tagSysMenu<br>　　{<br>　　char <em>text; /</em> 菜单的文本 <em>/<br>　　BYTE xPos; /</em> 菜单在LCD上的x坐标 <em>/<br>　　BYTE yPos; /</em> 菜单在LCD上的y坐标 <em>/<br>　　void （</em>onOkFun）（）; /</em> 在该菜单上按下ok键的处理函数指针 <em>/<br>　　void （</em>onCancelFun）（）; /* 在该菜单上按下cancel键的处理函数指针 */<br>　　}SysMenu， <em>LPSysMenu;<br>当我定义菜单时，只需要这样：<br>　　static SysMenu menu［MENU_NUM］ =<br>　　{<br>　　{<br>　　“menu1”， 0， 48， menu1OnOk， menu1OnCancel<br>　　}<br>　　，<br>　　{<br>　　“ menu2”， 7， 48， menu2OnOk， menu2OnCancel<br>　　}<br>　　，<br>　　{<br>　　“ menu3”， 7， 48， menu3OnOk， menu3OnCancel<br>　　}<br>　　，<br>　　{<br>　　“ menu4”， 7， 48， menu4OnOk， menu4OnCancel<br>　　}<br>　　…<br>　　};<br>OK键和CANCEL键的处理变成：<br>　　/</em> 按下OK键 <em>/<br>　　void onOkKey（）<br>　　{<br>　　menu［currentFocusMenu］.onOkFun（）;<br>　　}<br>　　/</em> 按下Cancel键 */<br>　　void onCancelKey（）<br>　　{<br>　　menu［currentFocusMenu］.onCancelFun（）;<br>　　}</p><p>程序被大大简化了，也开始具有很好的可扩展性！我们仅仅利用了面向对象中的封装思想，就让程序结构清晰，其结果是几乎可以在无需修改程序的情况下在系统中添加更多的菜单，而系统的按键处理函数保持不变。<br>面向对象，真神了！<br>模拟MessageBox函数<br>MessageBox函数，这个Windows编程中的超级猛料，不知道是多少入门者第一次用到的函数。还记得我们第一次在Windows中利用MessageBox输出 “Hello，World！”对话框时新奇的感觉吗？无法统计，这个世界上究竟有多少程序员学习Windows编程是从MessageBox（“Hello，World！”，…）开始的。在我本科的学校，广泛流传着一个词汇，叫做“’Hello，World’级程序员”，意指入门级程序员，但似乎“’Hello，World’级”这个说法更搞笑而形象。<br>嵌入式系统中没有给我们提供MessageBox，但是鉴于其功能强大，我们需要模拟之，一个模拟的MessageBox函数为：</p><p>　　/******************************************<br>　　/* 函数名称： MessageBox<br>　　/* 功能说明： 弹出式对话框，显示提醒用户的信息<br>　　/* 参数说明： lpStr — 提醒用户的字符串输出信息<br>　　/* TYPE — 输出格式（ID_OK = 0， ID_OKCANCEL = 1）<br>　　/* 返回值： 返回对话框接收的键值，只有两种 KEY_OK， KEY_CANCEL<br>　　/******************************************<br>　　typedef enum TYPE { ID_OK，ID_OKCANCEL }MSG_TYPE;<br>　　extern BYTE MessageBox（LPBYTE lpStr， BYTE TYPE）<br>　　{<br>　　BYTE key = -1;<br>　　ClearScreen（）; /* 清除屏幕 <em>/<br>　　DisplayString（xPos，yPos，lpStr，TRUE）; /</em> 显示字符串 <em>/<br>　　/</em> 根据对话框类型决定是否显示确定、取消 <em>/<br>　　switch （TYPE）<br>　　{<br>　　case ID_OK：<br>　　DisplayString（13，yPos+High+1， “ 确定 ”， 0）;<br>　　break;<br>　　case ID_OKCANCEL：<br>　　DisplayString（8， yPos+High+1， “ 确定 ”， 0）;<br>　　DisplayString（17，yPos+High+1， “ 取消 ”， 0）;<br>　　break;<br>　　default：<br>　　break;<br>　　}<br>　　DrawRect（0， 0， 239， yPos+High+16+4）; /</em> 绘制外框 <em>/<br>　　/</em> MessageBox是模式对话框，阻塞运行，等待按键 <em>/<br>　　while（ （key ！= KEY_OK） || （key ！= KEY_CANCEL） ）<br>　　{<br>　　key = getSysKey（）;<br>　　}<br>　　/</em> 返回按键类型 */<br>　　if（key== KEY_OK）<br>　　{<br>　　return ID_OK;<br>　　}<br>　　else<br>　　{<br>　　return ID_CANCEL;<br>　　}<br>　　}</p><p>上述函数与我们平素在VC++等中使用的MessageBox是何等的神似啊？实现这个函数，你会看到它在嵌入式系统中的妙用是无穷的。<br>总结<br>本篇是本系列文章中技巧性最深的一篇，它提供了嵌入式系统屏幕显示方面一些很巧妙的处理方法，灵活使用它们，我们将不再被LCD上凌乱不堪的显示内容所困扰。<br>屏幕乃嵌入式系统生存之重要辅助，面目可憎之显示将另用户逃之夭夭。屏幕编程若处理不好，将是软件中最不系统、最混乱的部分，笔者曾深受其害。<br>C语言嵌入式系统编程注意事项之键盘操作<br>处理功能键<br>让我们来看看WIN32编程中用到的“窗口”概念，当消息（message）被发送给不同窗口的时候，该窗口的消息处理函数（是一个callback函数）最终被调用，而在该窗口的消息处理函数中，又根据消息的类型调用了该窗口中的对应处理函数。通过这种方式，WIN32有效的组织了不同的窗口，并处理不同窗口情况下的消息。<br>我们从中学习到的就是：<br>（1）将不同的画面类比为WIN32中不同的窗口，将窗口中的各种元素（菜单、按钮等）包含在窗口之中；<br>（2）给各个画面提供一个功能键“消息”处理函数，该函数接收按键信息为参数；<br>（3）在各画面的功能键“消息”处理函数中，判断按键类型和当前焦点元素，并调用对应元素的按键处理函数。</p><p>　　/* 将窗口元素、消息处理函数封装在窗口中 <em>/<br>　　struct windows<br>　　{<br>　　BYTE currentFocus;<br>　　ELEMENT element［ELEMENT_NUM］;<br>　　void （</em>messageFun） （BYTE key）;<br>　　…<br>　　};<br>　　/* 消息处理函数 <em>/<br>　　void message（BYTE key）<br>　　{<br>　　BYTE i = 0;<br>　　/</em> 获得焦点元素 <em>/<br>　　while （ （element .ID！= currentFocus）&amp;&amp; （i 《 ELEMENT_NUM） ）<br>　　{<br>　　i++;<br>　　}<br>　　/</em> “消息映射” */<br>　　if（i 《 ELEMENT_NUM）<br>　　{<br>　　switch（key）<br>　　{<br>　　case OK：<br>　　element.OnOk（）;<br>　　break;<br>　　…<br>　　}<br>　　}<br>　　}</p><p>在窗口的消息处理函数中调用相应元素按键函数的过程类似于“消息映射”，这是我们从WIN32编程中学习到的。编程到了一个境界，很多东西都是相通的了。其它地方的思想可以拿过来为我所用，是为编程中的“拿来主义”。<br>在这个例子中，如果我们还想玩得更大一点，我们可以借鉴MFC中处理MESSAGE_MAP的方法，我们也可以学习MFC定义几个精妙的宏来实现“消息映射”。<br>处理数字键<br>用户输入数字时是一位一位输入的，每一位的输入都对应着屏幕上的一个显示位置（x坐标，y坐标）。此外，程序还需要记录该位置输入的值，所以有效组织用户数字输入的最佳方式是定义一个结构体，将坐标和数值捆绑在一起：</p><p>　　/* 用户数字输入结构体 <em>/<br>　　typedef struct tagInputNum<br>　　{<br>　　BYTE byNum; /</em> 接收用户输入赋值 <em>/<br>　　BYTE xPos; /</em> 数字输入在屏幕上的显示位置x坐标 <em>/<br>　　BYTE yPos; /</em> 数字输入在屏幕上的显示位置y坐标 */<br>　　}InputNum， *LPInputNum;</p><p>那么接收用户输入就可以定义一个结构体数组，用数组中的各位组成一个完整的数字：</p><p>　　InputNum inputElement［NUM_LENGTH］; /* 接收用户数字输入的数组 <em>/<br>　　/</em> 数字按键处理函数 <em>/<br>　　extern void onNumKey（BYTE num）<br>　　{<br>　　if（num==0|| num==1） /</em> 只接收二进制输入 <em>/<br>　　{<br>　　/</em> 在屏幕上显示用户输入 <em>/<br>　　DrawText（inputElement［currentElementInputPlace］.xPos， inputElement［currentElementInputPlace］.yPos， “%1d”， num）;<br>　　/</em> 将输入赋值给数组元素 <em>/<br>　　inputElement［currentElementInputPlace］.byNum = num;<br>　　/</em> 焦点及光标右移 */<br>　　moveToRight（）;<br>　　}<br>　　}</p><p>将数字每一位输入的坐标和输入值捆绑后，在数字键处理函数中就可以较有结构的组织程序，使程序显得很紧凑。<br>整理用户输入<br>继续第2节的例子，在第2节的onNumKey函数中，只是获取了数字的每一位，因而我们需要将其转化为有效数据，譬如要转化为有效的XXX数据，其方法是：</p><p>　　/* 从2进制数据位转化为有效数据：XXX <em>/<br>　　void convertToXXX（）<br>　　{<br>　　BYTE i;<br>　　XXX = 0;<br>　　for （i = 0; i 《 NUM_LENGTH; i++）<br>　　{<br>　　XXX += inputElement.byNum</em>power（2， NUM_LENGTH - i - 1）;<br>　　}<br>　　}</p><p>反之，我们也可能需要在屏幕上显示那些有效的数据位，因为我们也需要能够反向转化：</p><p>　　/* 从有效数据转化为2进制数据位：XXX */<br>　　void convertFromXXX（）<br>　　{<br>　　BYTE i;<br>　　XXX = 0;<br>　　for （i = 0; i 《 NUM_LENGTH; i++）<br>　　{<br>　　inputElement.byNum = XXX / power（2， NUM_LENGTH - i - 1） % 2;<br>　　}<br>　　}</p><p>当然在上面的例子中，因为数据是2进制的，用power函数不是很好的选择，直接用“《《 》》”移位操作效率更高，我们仅是为了说明问题的方便。试想，如果用户输入是十进制的，power函数或许是唯一的选择了。<br>总结<br>本篇给出了键盘操作所涉及的各个方面：功能键处理、数字键处理及用户输入整理，基本上提供了一个全套的按键处理方案。对于功能键处理方法，将LCD屏幕与Windows窗口进行类比，提出了较新颖地解决屏幕、键盘繁杂交互问题的方案。<br>计算机学的许多知识都具有相通性，因而，不断追赶时髦技术而忽略基本功的做法是徒劳无意的。我们最多需要“精通”三种语言（精通，一个在如今的求职简历里泛滥成灾的词语），最佳拍档是汇编、C、C++（或JAVA），很显然，如果你“精通”了这三种语言，其它语言你应该是可以很快“熟悉”的，否则你就没有“精通”它们。<br>C语言嵌入式系统编程注意事项之性能优化<br>在C语言中，宏是产生内嵌代码的唯一方法。对于嵌入式系统而言，为了能达到性能要求，宏是一种很好的代替函数的方法<br>使用宏定义<br>在C语言中，宏是产生内嵌代码的唯一方法。对于嵌入式系统而言，为了能达到性能要求，宏是一种很好的代替函数的方法。<br>写一个“标准”宏MIN ，这个宏输入两个参数并返回较小的一个：<br>错误做法：<br>　　#define MIN（A，B） 　（ A 《= B ？ A ： B ）<br>正确做法：<br>　　#define MIN（A，B） （（A）《= （B） ？ （A） ： （B） ）<br>对于宏，我们需要知道三点：<br>（1）宏定义“像”函数；<br>（2）宏定义不是函数，因而需要括上所有“参数”；<br>（3）宏定义可能产生副作用。<br>下面的代码：<br>　　least = MIN（<em>p++， b）;<br>将被替换为：<br>　　（ （</em>p++） 《= （b） ？（*p++）：（b） ）<br>发生的事情无法预料。<br>因而不要给宏定义传入有副作用的“参数”。<br>使用寄存器变量<br>当对一个变量频繁被读写时，需要反复访问内存，从而花费大量的存取时间。为此，C语言提供了一种变量，即寄存器变量。这种变量存放在CPU的寄存器中，使用时，不需要访问内存，而直接从寄存器中读写，从而提高效率。寄存器变量的说明符是register。对于循环次数较多的循环控制变量及循环体内反复使用的变量均可定义为寄存器变量，而循环计数是应用寄存器变量的最好候选者。<br>（1） 只有局部自动变量和形参才可以定义为寄存器变量。因为寄存器变量属于动态存储方式，凡需要采用静态存储方式的量都不能定义为寄存器变量，包括：模块间全局变量、模块内全局变量、局部static变量；<br>（2） register是一个“建议”型关键字，意指程序建议该变量放在寄存器中，但最终该变量可能因为条件不满足并未成为寄存器变量，而是被放在了存储器中，但编译器中并不报错（在C++语言中有另一个“建议”型关键字：inline）。<br>下面是一个采用寄存器变量的例子：</p><p>　　/* 求1+2+3+….+n的值 */<br>　　WORD Addition（BYTE n）<br>　　{<br>　　register i，s=0;<br>　　for（i=1;i《=n;i++）<br>　　{<br>　　s=s+i;<br>　　}<br>　　return s;<br>　　}</p><p>本程序循环n次，i和s都被频繁使用，因此可定义为寄存器变量。<br>内嵌汇编<br>程序中对时间要求苛刻的部分可以用内嵌汇编来重写，以带来速度上的显著提高。但是，开发和测试汇编代码是一件辛苦的工作，它将花费更长的时间，因而要慎重选择要用汇编的部分。<br>在程序中，存在一个80-20原则，即20%的程序消耗了80%的运行时间，因而我们要改进效率，最主要是考虑改进那20%的代码。<br>嵌入式C程序中主要使用在线汇编，即在C程序中直接插入_asm{ }内嵌汇编语句：</p><p>　　/* 把两个输入参数的值相加，结果存放到另外一个全局变量中 */<br>　　int result;<br>　　void Add（long a， long *b）<br>　　{<br>　　_asm<br>　　{<br>　　MOV AX， a<br>　　MOV BX， b<br>　　ADD AX， ［BX］<br>　　MOV result， AX<br>　　}<br>　　}</p><p>利用硬件特性<br>首先要明白CPU对各种存储器的访问速度，基本上是：<br>CPU内部RAM》外部同步RAM》外部异步RAM》FLASH/ROM<br>对于程序代码，已经被烧录在FLASH或ROM中，我们可以让CPU直接从其中读取代码执行，但通常这不是一个好办法，我们最好在系统启动后将FLASH或ROM中的目标代码拷贝入RAM中后再执行以提高取指令速度；<br>对于UART等设备，其内部有一定容量的接收BUFFER，我们应尽量在BUFFER被占满后再向CPU提出中断。例如计算机终端在向目标机通过RS-232传递数据时，不宜设置UART只接收到一个BYTE就向CPU提中断，从而无谓浪费中断处理时间；<br>如果对某设备能采取DMA方式读取，就采用DMA读取，DMA读取方式在读取目标中包含的存储信息较大时效率较高，其数据传输的基本单位是块，而所传输的数据是从设备直接送入内存的（或者相反）。DMA方式较之中断驱动方式，减少了CPU 对外设的干预，进一步提高了CPU与外设的并行操作程度。<br>活用位操作<br>使用C语言的位操作可以减少除法和取模的运算。在计算机程序中数据的位是可以操作的最小数据单位，理论上可以用“位运算”来完成所有的运算和操作，因而，灵活的位操作可以有效地提高程序运行的效率。举例如下：</p><p>　　/* 方法1 <em>/<br>　　int i，j;<br>　　i = 879 / 16;<br>　　j = 562 % 32;<br>　　/</em> 方法2 */<br>　　int i，j;<br>　　i = 879 》》 4;<br>　　j = 562 - （562 》》 5 《《 5）;</p><p>对于以2的指数次方为“*”、“/”或“%”因子的数学运算，转化为移位运算“《《 》》”通常可以提高算法效率。因为乘除运算指令周期通常比移位运算大。<br>C语言位运算除了可以提高运算效率外，在嵌入式系统的编程中，它的另一个最典型的应用，而且十分广泛地正在被使用着的是位间的与（&amp;）、或（|）、非（~）操作，这跟嵌入式系统的编程特点有很大关系。我们通常要对硬件寄存器进行位设置，譬如，我们通过将AM186ER型80186处理器的中断屏蔽控制寄存器的第低6位设置为0（开中断2），最通用的做法是：</p><p>　　#define INT_I2_MASK 0x0040<br>　　wTemp = inword（INT_MASK）;<br>　　outword（INT_MASK， wTemp &amp;~INT_I2_MASK）;<br>　　而将该位设置为1的做法是：<br>　　#define INT_I2_MASK 0x0040<br>　　wTemp = inword（INT_MASK）;<br>　　outword（INT_MASK， wTemp | INT_I2_MASK）;</p><p>判断该位是否为1的做法是：</p><p>　　#define INT_I2_MASK 0x0040<br>　　wTemp = inword（INT_MASK）;<br>　　if（wTemp &amp; INT_I2_MASK）<br>　　{<br>　　… /* 该位为1 */<br>　　}</p><p>上述方法在嵌入式系统的编程中是非常常见的，我们需要牢固掌握。<br>总结<br>在性能优化方面永远注意80-20准备，不要优化程序中开销不大的那80%，这是劳而无功的。<br>宏定义是C语言中实现类似函数功能而又不具函数调用和返回开销的较好方法，但宏在本质上不是函数，因而要防止宏展开后出现不可预料的结果，对宏的定义和使用要慎而处之。很遗憾，标准C至今没有包括C++中inline函数的功能，inline函数兼具无调用开销和安全的优点。<br>使用寄存器变量、内嵌汇编和活用位操作也是提高程序效率的有效方法。<br>除了编程上的技巧外，为提高系统的运行效率，我们通常也需要最大可能地利用各种硬件设备自身的特点来减小其运转开销，例如减小中断次数、利用DMA传输方式等。</p><p>免责声明：整理文章为传播相关技术，版权归原作者所有，如有侵权，请联系删除</p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>视频学 uboot简单使用，移植时需要</title>
      <link href="2021/05/14/shi-pin-xue-uboot-jian-dan-shi-yong-yi-zhi-shi-xu-yao-local/"/>
      <url>2021/05/14/shi-pin-xue-uboot-jian-dan-shi-yong-yi-zhi-shi-xu-yao-local/</url>
      
        <content type="html"><![CDATA[<h2 id="Uboot常用命令"><a href="#Uboot常用命令" class="headerlink" title="Uboot常用命令 "></a>Uboot常用命令 <img src="/images/20191117223001691.png"></h2><p>Uboot是一款软件，是bootloader的一个子系统</p><h3 id="print-打印出uboot的环境变量"><a href="#print-打印出uboot的环境变量" class="headerlink" title="print 打印出uboot的环境变量"></a>print 打印出uboot的环境变量</h3><p>变量名=变量值</p><h3 id="setenv-saveenv-设置环境变量"><a href="#setenv-saveenv-设置环境变量" class="headerlink" title="setenv saveenv 设置环境变量"></a>setenv saveenv 设置环境变量</h3><p>set只保存在RAM中，saveenv才保存到flash/Nor/Nand<br><img src="https://img-blog.csdnimg.cn/20191117223403556.png"><img src="/images/20191118094352827.png"></p><h3 id="显示DRAM中的内容"><a href="#显示DRAM中的内容" class="headerlink" title="显示DRAM中的内容"></a>显示DRAM中的内容</h3><p><code>md  20008000</code>（memory display）</p><h3 id="网络层ip配置"><a href="#网络层ip配置" class="headerlink" title="网络层ip配置"></a>网络层ip配置</h3><p><code>setenv  ipaddr xxx.xxx.xxx.xxx</code>  （要保存）</p><h3 id="传输层（tftp传输文件到开发板）"><a href="#传输层（tftp传输文件到开发板）" class="headerlink" title="传输层（tftp传输文件到开发板）"></a>传输层（tftp传输文件到开发板）</h3><p>FTP底层是TCP协议，TFTP底层是UDP协议（简单）<br>uboot没有tcp协议，只有udp协议。使用的是基于udp的文件传输协议<code>tftp</code><br>服务机和客服机模式S/C</p><ol><li>windows服务端<br>直接使用软件tftpd，设置服务端ip和共享文件夹</li><li>开发板客户端<br>需要知道服务端地址、端口、任务<br>服务端地址：通过环境变量取得 <code>setenv serverip xxx</code><br>端口：tftp端口固定为69</li></ol><p><strong>使用</strong> <code>tftp 20008000  a.txt</code> （20008000十六进制的DRAM地址一般200xxx-300xxx）将文件a.txt的内容写到内存中<br>3. linux服务端<br>32位比较简单，64位默认使用ipv6，端口号也变了，需要设置<br>32位直接装 <code>sudo apt-get install tftpd-hpa</code><br>64位，<code>sudo apt-get install tftpd openbsc-xinetd</code><br><strong>查看linux服务端是否运行了tftp</strong>：<code>netstat -ua</code> (查看udp相关服务)<br><strong>修改服务端某个网卡的ip</strong>：<code>ifconfig eth1 xxx.xxx.xxx.xxx</code></p><h3 id="nand"><a href="#nand" class="headerlink" title="nand"></a>nand</h3><p>nand分块然后分页，先擦后写。<br><img src="/images/20191118103924824.png"><br><code>nand [动词] [内存地址] [nandflash内部地址] [搬移大小]</code>  默认16进制<br><strong>将nand flash中的第5M地址块读1k到ram的21000000中。</strong><br>2^10=1K<br>2^20=1M —&gt; 2进制 1000…000(20个0) —&gt;16进制 0x100000<br>5M=5x1M=5x(0x100000) = 0x500000<br><code>nand read 21000000 500000 1024</code>将nand flash中的第5M地址块读1k到ram的21000000中<br><code>nand erase 500000 1024</code> 擦除第5M块的。。。1024会被检测到第几块第几页<br><code>nand write 21000000 500000 1024</code>将ram中的起始21000000地址的1k写到nand flash中的第5M地址块（注意先擦后写）<br><img src="/images/20191118110607134.png"></p><h3 id="加载内核（uboot最重要的作用）"><a href="#加载内核（uboot最重要的作用）" class="headerlink" title="加载内核（uboot最重要的作用）"></a>加载内核（uboot最重要的作用）</h3><p>通过uboot启动内核<br><code>bootm</code> 启动内核，用于启动uImage，常用<br><code>go</code> 程序pc指针，将uboot主动权交给内核，启动其他格式文件<br>内核可执行文件的名字 <code>uImage(包含内核和uboot关联的数据) zImage Image bzImag</code>e，头格式不一致<br><img src="/images/20191118120925545.png"><br><strong>内核启动条件</strong><br>内核启动条件需要 启动参数 和 文件系统<br>uboot去启动内核，需要借助环境变量<code>bootargs</code>，以什么样的方式启动，输出控制台是什么。<br><img src="/images/20191118133024345.png"></p><ol><li>启动参数<br><code>setenv bootargs root=/dev/mtdblock2 init=/linuxrc console=ttySAC0,115200</code><br><code>root=</code> 启动的根文件系统在哪个设备中<br>&nbsp; &nbsp; 设备信息RAM NFS flash<br><code>init=</code> 内核启动后，第一个可执行init进程从哪里来<br><code>console=</code> 内核启动时使用什么设备作为控制台（串口最直接）</li><li>文件系统<br>文件系统可以看作一个执行程序、模块。是内核和用户交互的中介。<br>文件系统和内核需要介质连接，可以是nand接口、flash数据总线接口、ram总线接口、网络接口。保证内核和文件系统能够相互找得到。<h3 id="文件系统的烧写"><a href="#文件系统的烧写" class="headerlink" title="文件系统的烧写"></a>文件系统的烧写</h3>文件系统的部署方法有很多。<br><img src="/images/20191118144747970.png"></li><li>   Ramdisk，借助内存，内核指向那里即可<br><code>root=/dev/ram</code> # ram<br><code>initrd=0x21000000,8M</code> # ram初始地址，和文件系统需要的大小（内存基地址0x2000 0000，20008000放内核）<br><code>init=/linuxrc</code> # linux第一个进程<br><code>console=ttySAC0</code><br>总的需要的步骤：</li><li>1 <code>tftp 20008000 uImage</code> # 下载uImage到内存地址</li><li>2 <code>tftp 21000000  initrd.img.gz</code> # 下载文件系统到内存地址</li><li>3 <code>setenv bootargs root=/dev/ram initrd=0x21000000,8M init=/linuxrc console=ttySAC0,115200</code>  # 设置启动参数</li><li>4 <code>bootm 20008000</code> # 启动内核，内核根据前面的参数加载文件系统<br>通过以上步骤就可以在开发板上运行linux系统了。</li><li>   NFS，借助网络，与服务器连接（调试用）<br>实际开发中也许flash驱动还没有完成，这时可以把网络文件系统当作root，通过网线把根文件系统挂在到内核。<br>使用TCP/IP协议，还是C/S架构</li><li>1 服务端<br>ubuntu默认不装NFS服务</li><li>1.1 安装nfs服务<br><code>sudo apt-cache search nfs-</code> # 搜索需要安装的服务，大致结果<br><code>sudo apt install nfs-kernel-server</code> # 安装nfs服务</li><li>1.2 配置脚本<br>在目录/etc/exports下，==<strong>一般配置文件都在/etc下</strong>==<br>设置共享路径     哪些主机可以访问（和文件权限）<br><img src="/images/20191118201025260.png"></li><li>1.3 重启服务<br><code>sudo /etc/init.d/nfs-kernel-server restart</code> 重启服务。<br>设置好共享文件夹之后还需要把根文件系统initrd.img.gz放进去：<br>&emsp;(1)首先解压<code>gunzip initrd.img.gz</code>得到镜像文件initrd.img,<br>&emsp;(2)然后将镜像文件挂在到swap交换区路径下，<code>sudo mount -t ext2 initrd.img ./swap/</code> 好像只是为了得到镜像文件的内容<br>&emsp;(3)再把文件夹全部复制到共享路径下，注意复制时的命令参数 <code>sudo cp -a /home/...../swap/* xxx</code> 将swap文件的所有内容复制到xxx共享路径下。<br>到此服务端的文件系统准备完成，包括数据都准备好了。</li><li>2 客户端<br>让内核找到服务端的具体目录的数据：==<strong>一般设备文件都在/dev下</strong>==<br>所以要设置bootargs，<code>root=/dev/nfs  nfsroot=192..168.10.110:/home/xxx</code>(ip:共享目录)<br>但是内核启动起来之后uboot就丧失主动权了，这样内核就处于无ip状态，所以还需要设置一个ip，<code>ip=192.168.10.112</code><br>完整设置<code>setenv bootargs root=/dev/nfs nfsroot=192.168.10.110:/home/xxx ip=192.168.10.112 init=/linuxrc console=ttySAC0,115200</code> # 设置环境变量<br><code>saveenv</code> # 保存设置的环境变量<br><code>tftp 20008000 uImage</code> # 下载uImage到内存<br><code>bootm 20008000</code> # 启动内核，根据环境变量找文件系统等等</li></ol><p>让系统启动后自动运行程序需要删除以下两个环境变量：<br>&emsp;bootdelay倒计时<br>&emsp;bootcmd倒计时后运行什么<br>系统移植的基本步骤：<br>uboot设置环境变量，uboot跟内核有数据交互，内核和文件系统有数据交互。<br><img src="/images/20191118213115221.png"></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>嵌入式问题 伪指令 PC=crt+8 内存字节序</title>
      <link href="2021/05/14/qian-ru-shi-wen-ti-wei-zhi-ling-pc-crt-8-nei-cun-zi-jie-xu-local/"/>
      <url>2021/05/14/qian-ru-shi-wen-ti-wei-zhi-ling-pc-crt-8-nei-cun-zi-jie-xu-local/</url>
      
        <content type="html"><![CDATA[<p>2440是一个SOC，它里面的CPU有R1、R2、R3……等寄存器；<br>它里面的GPIO控制器也有很多寄存器，如 GPFCON、GPFDAT。<br>这两个寄存器是有差异的，在写代码的时候，CPU里面的寄存器可以直接访问，其它的寄存器要以地址进行访问。</p><h1 id="伪指令"><a href="#伪指令" class="headerlink" title="伪指令"></a>伪指令</h1><p>LDR R0,=0x12345678 这是一条伪指令，即实际中并不存在这个指令，他会被拆分成几个真正的ARM指令，实现一样的效果。 最后结果是R0 = 0x12345678。</p><p>为什么会引入伪指令？ 在ARM的32位指令中，有些字节表示指令，有些字节表示数据，因此表示数据的没有32位，不能表示一个32位的任意值，只能表示一个较小的简单值，这个简单值称为立即数。引入伪指令后，利用LDR可以为R0赋任意大小值，编译器会自动拆分成真正的的指令，实现目的。</p><h1 id="PC-当前指令-8"><a href="#PC-当前指令-8" class="headerlink" title="PC=当前指令+8"></a>PC=当前指令+8</h1><p>在2440这个SOC里面，R0-R15都在CPU里面，其中：</p><ol><li>R13 别名：sp （Stack Pointer）栈指针</li><li>R14 别名：lr （Link Register）返回地址</li><li>R15 别名：pc （program Counter）程序计数器=当前指令+8</li></ol><p>为什么 PC=当前指令+8？<br>ARM指令采用<strong>流水线机制</strong>，当前执行地址A的指令，已经在对地址A+4的指令进行译码，已经在读取地址A+8的指令，其中A+8就是PC的值。</p><h1 id="内存字节序"><a href="#内存字节序" class="headerlink" title="内存字节序"></a>内存字节序</h1><p>一般的arm芯片都是小字节序，对于2440可以设置某个寄存器，让整个系统使用大字节序或小字节序，它默认使用小字节序。</p><p><strong>0x12345678的低位（0x78）存在低地址，即方式1，叫做小字节序(Little endian)；</strong><br>0x12345678的高位（0x12）存在低地址，即方式2，叫做大字节序(Big endian)；<br><img src="/images/20200522173926675.png"></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>编译地址 和 运行地址 位置无关码（PIC position independent code）链接地址(预估的) 运行地址(真实的)</title>
      <link href="2021/05/14/bian-yi-di-zhi-he-yun-xing-di-zhi-wei-zhi-wu-guan-ma-pic-position-independent-code-lian-jie-di-zhi-yu-gu-de-yun-xing-di-zhi-zhen-shi-de-local/"/>
      <url>2021/05/14/bian-yi-di-zhi-he-yun-xing-di-zhi-wei-zhi-wu-guan-ma-pic-position-independent-code-lian-jie-di-zhi-yu-gu-de-yun-xing-di-zhi-zhen-shi-de-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]</p><h1 id="什么是《编译地址》？什么是《运行地址》？"><a href="#什么是《编译地址》？什么是《运行地址》？" class="headerlink" title="什么是《编译地址》？什么是《运行地址》？"></a>什么是《编译地址》？什么是《运行地址》？</h1><p><img src="/images/20200518131920239.png"></p><h2 id="编译地址"><a href="#编译地址" class="headerlink" title="编译地址"></a>编译地址</h2><p> 32位的处理器，它的每一条指令是4个字节，以4个字节存储顺序，进行顺序执行，CPU是顺序执行的，只要没发生什么跳转，它会顺序进行执行行， 编译器会对每一条指令分配一个编译地址，这是编译器分配的，在编译过程中分配的地址，我们称之为编译地址。</p><h2 id="运行地址"><a href="#运行地址" class="headerlink" title="运行地址"></a>运行地址</h2><p>是指程序指令真正运行的地址，是由用户指定的，用户将运行地址烧录到哪里，哪里就是运行的地址。<br>      比如有一个指令的编译地址是0x5，实际运行的地址是0x200，如果用户将指令烧到0x200上，那么这条指令的运行地址就是0x200。</p><h2 id="当编译地址和运行地址不同的时候会出现什么结果？"><a href="#当编译地址和运行地址不同的时候会出现什么结果？" class="headerlink" title="当编译地址和运行地址不同的时候会出现什么结果？"></a>当编译地址和运行地址不同的时候会出现什么结果？</h2><p>结果是不能跳转，编译后会产生跳转地址，如果实际地址和编译后产生的地址不相等，那么就不能跳转。<br>     C语言编译地址：都希望把编译地址和实际运行地址放在一起的，但是汇编代码因为不需要做C语言到汇编的转换，可以认为的去写地址，所以直接写的就是他的运行地址这就是为什么任何bootloader刚开始会有一段汇编代码，因为起始代码编译地址和实际地址不相等，这段代码和汇编无关，跳转用的运行地址。                                                   </p><h2 id="编译地址和运行地址如何来算呢？"><a href="#编译地址和运行地址如何来算呢？" class="headerlink" title="编译地址和运行地址如何来算呢？"></a>编译地址和运行地址如何来算呢？</h2><ol><li>假如有两个编译地址a=0x10，b=0x7，b的运行地址是0x300，那么a的运行地址就是b的运行地址加上两者编译地址的差值，a-b=0x10-0x7=0x3，<br> a的运行地址就是0x300+0x3=0x303。    2.   假设uboot上两条指令的编译地址为a=0x33000007和b=0x33000001，这两条指令都落在bank6上，现在要计算出他们对应的运行地址，要找出运行地址的始地址，这个是由用户烧录进去的，假设运行地址的首地址是0x0，则a的运行地址为0x7，b为0x1，就是这样算出来的。<h2 id="为什么要分配编译地址？这样做有什么好处，有什么作用？"><a href="#为什么要分配编译地址？这样做有什么好处，有什么作用？" class="headerlink" title="为什么要分配编译地址？这样做有什么好处，有什么作用？"></a>为什么要分配编译地址？这样做有什么好处，有什么作用？</h2>比如在函数a中定义了函数b，当执行到函数b时要进行指令跳转，要跳转到b函数所对应的起始地址上去，编译时，编译器给每条指令都分配了编译地址，如果编译器已经给分配了地址就可以直接进行跳转，查找b函数跳转指令所对应的表，进行直接跳转，因为有个编译地址和指令对应的一个表，如果没有分配，编译器就查找不到这个跳转地址，要进行计算，非常麻烦。<h1 id="什么是《相对地址》？"><a href="#什么是《相对地址》？" class="headerlink" title="什么是《相对地址》？"></a>什么是《相对地址》？</h1>以NOR Flash为例，NOR Falsh是映射到bank0上面，SDRAM是映射到bank6上面，uboot和内核最终是在SDRAM上面运行，最开始我们是从Nor Flash的零地址开始往后烧录，uboot中至少有一段代码编译地址和运行地址是不一样的，编译uboot或内核时，都会将编译地址放入到SDRAM中，他们最终都会在SDRAM中执行，刚开始uboot在Nor Flash中运行，运行地址是一个低端地址，是bank0中的一个地址，但编译地址是bank6中的地址，这样就会导致绝对跳转指令执行的失败，所以就引出了相对地址的概念。</li></ol><p>那么什么是相对地址呢？<br>     至少在bank0中uboot这段代码要知道不能用b+编译地址这样的方法去跳转指令，因为这段代码的编译地址和运行地址不一样，那如何去做呢？<br>    要去计算这个指令运行的真实地址，计算出来后再做跳转，应该是b+运行地址，不能出现b+编译地址，而是b+运行地址，而运行地址是算出来的。</p><p>   _TEXT_BASE:<br>  .word TEXT_BASE //0x33F80000,在board/config.mk中<br>这段话表示，用户告诉编译器编译地址的起始地址</p><h1 id="位置无关码"><a href="#位置无关码" class="headerlink" title="位置无关码"></a>位置无关码</h1><p>位置无关可执行文件PIE包括<code>位置无关代码PIC</code>和<code>位置无关数据PID</code>两部分。</p><p>通常情况下，将bootloader程序下载到ROM的0x0地址进行启动（比如固化到NorFlash中）。<br>然而在很多的设计中，比如将bootloader固化在NAND中，<br>在系统复位后S3C2440A中NAND控制器自动读取NAND中存储的前4K的代码到s3c2440a中称之为<code>steppingstone</code>的RAM中，<code>steppingstone</code>中的代码进行一些非核心的硬件初始化，再将NAND中剩下的bootloader代码拷贝到RAM中运行。<br>一般境况下两者的地址并不相同，程序在SDRAM中的地址重定位过程必须由程序员来完成。这样就有了位置无关代码的概念，指代码不在连接时指定的运行地址空间，也可以执行，它一段加载到任意地址空间都能执行的特殊代码。这样<strong>在<code>steppingstone</code>设计的代码要用位置无关设计</strong>。 </p><p><strong>一旦使用了全局变量,就不能作为位置无关码的一部分了。<br>比如bootloader启动的第一阶段, copy2ram的前面部分.必须是位置无关码</strong></p><p>汇编文件生成可执行文件时 编码方式与位置（内存地址）无关。<br>链接脚本<code>.lds</code>指示<code>.o</code>应该被分成<strong>哪些段</strong>，这些段最终存<strong>放在哪个位置</strong>。</p><p><font color=red> <strong><code>bl/b</code>调用的c语言函数里面也不要使用全局变量, 因为c里面的全局变量的地址是根据链接地址生成的。</strong> </font> </p><h2 id="运行地址-一般与链接地址相等-真实的"><a href="#运行地址-一般与链接地址相等-真实的" class="headerlink" title="运行地址(一般与链接地址相等) 真实的"></a>运行地址(一般与链接地址相等) 真实的</h2><p>运行地址由运行时决定的地址，实际运行地址无法绝对确定。<br>如把代码烧写到其他区域，看你怎么运行。</p><h2 id="链接地址-一般与运行地址相等-预估的"><a href="#链接地址-一般与运行地址相等-预估的" class="headerlink" title="链接地址(一般与运行地址相等) 预估的"></a>链接地址(一般与运行地址相等) 预估的</h2><p>在链接过程中指定，通过<code>Makefile</code>的<code>-Ttext xxx</code>或者链接脚本<code>.lds</code>中指定。<br>程序员认为程序应该在链接地址运行，程序员事先应该知道程序的执行要求，有期望的执行地址，作为链接地址。</p><p>为什么应用程序没有要求程序员指定链接地址？<br>应用程序运行在操作系统上，因为linux的应用程序独享4G虚拟地址空间，每个进程代码的默认连链接地址是0。</p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>千峰视频 内核模块编写流程module_init，module_exit，MODULE_LICENSE 最简单的内核模块编写</title>
      <link href="2021/05/14/qian-feng-shi-pin-nei-he-mo-kuai-bian-xie-liu-cheng-module-init-module-exit-module-license-zui-jian-dan-de-nei-he-mo-kuai-bian-xie-local/"/>
      <url>2021/05/14/qian-feng-shi-pin-nei-he-mo-kuai-bian-xie-liu-cheng-module-init-module-exit-module-license-zui-jian-dan-de-nei-he-mo-kuai-bian-xie-local/</url>
      
        <content type="html"><![CDATA[<p>doc@[toc]</p><h2 id="模块编写的流程，先在pc上测试"><a href="#模块编写的流程，先在pc上测试" class="headerlink" title="模块编写的流程，先在pc上测试"></a>模块编写的流程，先在pc上测试</h2><p>pc也是linux内核。<br>内核提供的三个宏，module_init，module_exit，MODULE_LICENSE<br>前俩在<code>include/linux/init.h</code>中定义，MODULE_LICENSE在<code>include/linux/module.h</code>中定义，<br><img src="/images/20191215213412718.png"><br>入口出口和GPL协议说明都是宏函数。</p><h3 id="0-入出口函数，GPL声明"><a href="#0-入出口函数，GPL声明" class="headerlink" title="0. 入出口函数，GPL声明"></a>0. 入出口函数，GPL声明</h3><p>在内核源码中找到一个入出口函数，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">omap2_mbox_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">platform_driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>omap2_mbox_driver<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">omap2_mbox_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">platform_driver_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>omap2_mbox_driver<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>omap2_mbox_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>omap2_mbox_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>大致结构如下：<br>__init将函数统一放在__init段，入口函数参数为void，返回值为int，用__init修改函数属性，<br>__exit将函数统一放在__exit段，出口函数参数为void，返回值为void，用__exit修改函数属性，<br>将入出口函数指针传入</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">xxx_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">platform_driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>omap2_mbox_driver<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">xxx_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">platform_driver_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>omap2_mbox_driver<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>xxx_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>xxx_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="1-编写内核模块"><a href="#1-编写内核模块" class="headerlink" title="1. 编写内核模块"></a>1. 编写内核模块</h3><p><strong>至少包含那三个宏函数。</strong><br>查看当前ubuntu系统的linux内核版本号，<code>name -r</code><br>ubuntu的linux内核在<code>/lib/modules/5.0.0-37-generic/build</code>，init.h在<code>/lib/modules/5.0.0-37-generic/build/include/linux</code>下。<br>编写内核模块，就打印个信息：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token keyword">int</span> __init <span class="token function">module_demo_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"-----%s-----%s-----%d"</span><span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> __exit <span class="token function">module_demo_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"-----%s-----%s-----%d"</span><span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>module_demo_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>module_demo_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-编译内核模块"><a href="#2-编译内核模块" class="headerlink" title="2. 编译内核模块"></a>2. 编译内核模块</h3><ol><li>静态编译<br>编译到uImage中</li><li>动态编译<br>编译生成动态模块.ko</li></ol><p>外部编译内核模块时，在Documentation/kbuild/modules.txt中有说明，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">make <span class="token operator">-</span>C <span class="token operator">&lt;</span>path<span class="token operator">-</span>to<span class="token operator">-</span>kernel<span class="token operator">></span> M<span class="token operator">=</span>`pwd` # <span class="token operator">-</span>C到指定路径下执行Makefile，内核源码路径，M表示外部模块所处路径，编译目标<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>make <span class="token operator">-</span>C <span class="token operator">/</span>lib<span class="token operator">/</span>modules<span class="token operator">/</span>`uname <span class="token operator">-</span>r`<span class="token operator">/</span>build M<span class="token operator">=</span>`pwd`<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>Makefile内容如下：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">KERNDIR <span class="token operator">:</span><span class="token operator">=</span> <span class="token operator">/</span>lib<span class="token operator">/</span>modules<span class="token operator">/</span><span class="token number">5.0</span><span class="token number">.0</span><span class="token operator">-</span><span class="token number">37</span><span class="token operator">-</span>generic<span class="token operator">/</span>build<span class="token operator">/</span> # 系统内核的路径PWD <span class="token operator">:</span><span class="token operator">=</span> $<span class="token punctuation">(</span>shell pwd<span class="token punctuation">)</span># 执行pwd命令并把结果赋给PWDobj<span class="token operator">-</span>m <span class="token operator">:</span><span class="token operator">=</span> module_demo<span class="token punctuation">.</span>o  # <span class="token punctuation">.</span>ko的生成依赖于<span class="token punctuation">.</span>o，<span class="token punctuation">.</span>o默认依赖<span class="token punctuation">.</span>call<span class="token operator">:</span>make <span class="token operator">-</span>C $<span class="token punctuation">(</span>KERNDIR<span class="token punctuation">)</span> M<span class="token operator">=</span>$<span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> modules # modules为编译目标clean<span class="token operator">:</span>nake <span class="token operator">-</span>C $<span class="token punctuation">(</span>KERNDIR<span class="token punctuation">)</span> M<span class="token operator">=</span>$<span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> clean<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>make</code>后在内核模块路径（当前路径下）生成<code>module_demo.ko</code>文件，这个文件由pc对应的编译器编译生成，所以可以插入到pc内核中运行。</p><h3 id="3-使用内核模块"><a href="#3-使用内核模块" class="headerlink" title="3. 使用内核模块"></a>3. 使用内核模块</h3><p>将内核模块加入到内核中，与内核形成整体，然后运行。<br>也可以从内核模块中卸载内核 内核模块。</p><h4 id="3-1-内核模块信息"><a href="#3-1-内核模块信息" class="headerlink" title="3.1 内核模块信息"></a>3.1 内核模块信息</h4><p>查看内核模块信息：<code>modinfo</code>，&#8195;如<code>modinfo module_demo.ko</code>，<br><img src="/images/20191216145305869.png"><br>当然还可以包含作者，模块描述等信息，需要添加其他宏函数，在include/linux/module.h中定义，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">MODULE_LICENSE</span><span class="token expression"><span class="token punctuation">(</span>_license<span class="token punctuation">)</span> <span class="token function">MODULE_INFO</span><span class="token punctuation">(</span>license<span class="token punctuation">,</span> _license<span class="token punctuation">)</span></span></span><span class="token comment">/* Author, ideally of form NAME[, NAME]*[ and NAME] */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">MODULE_AUTHOR</span><span class="token expression"><span class="token punctuation">(</span>_author<span class="token punctuation">)</span> <span class="token function">MODULE_INFO</span><span class="token punctuation">(</span>author<span class="token punctuation">,</span> _author<span class="token punctuation">)</span></span></span>  <span class="token comment">/* What your module does. */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">MODULE_DESCRIPTION</span><span class="token expression"><span class="token punctuation">(</span>_description<span class="token punctuation">)</span> <span class="token function">MODULE_INFO</span><span class="token punctuation">(</span>description<span class="token punctuation">,</span> _description<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="3-2-查看当前系统插入的动态内核模块"><a href="#3-2-查看当前系统插入的动态内核模块" class="headerlink" title="3.2 查看当前系统插入的动态内核模块"></a>3.2 查看当前系统插入的动态内核模块</h4><p><code>lsmod</code><br><img src="/images/20191216145952374.png"></p><h4 id="3-3-插入内核模块"><a href="#3-3-插入内核模块" class="headerlink" title="3.3 插入内核模块"></a>3.3 插入内核模块</h4><p>需要管理员权限<br><code>insmod module_demo.ko</code> # 加载函数会被调用</p><h4 id="3-4-查看内核日志信息"><a href="#3-4-查看内核日志信息" class="headerlink" title="3.4 查看内核日志信息"></a>3.4 查看内核日志信息</h4><p><code>dmesg</code><br>可以先删除之前的内核日志<code>sudo dmesg -c</code></p><h4 id="3-5-卸载内核模块"><a href="#3-5-卸载内核模块" class="headerlink" title="3.5 卸载内核模块"></a>3.5 卸载内核模块</h4><p><code>sudo rmmod module_demo</code> # 卸载函数会被调用<br>最终可以看到写的module_demo.ko内核模块在pc内核中运行的结果，<br><img src="/images/20191216150826878.png"><strong>内核模块 加载的时候 执行加载函数，只执行一次，<br>内核模块 卸载的时候 执行卸载函数，只执行一次。</strong></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>千峰视频  操作系统的5大功能 设备控制、进程管理、内存管理、文件系统、网络 用户空间--内核空间--硬件</title>
      <link href="2021/05/14/qian-feng-shi-pin-cao-zuo-xi-tong-de-5-da-gong-neng-she-bei-kong-zhi-jin-cheng-guan-li-nei-cun-guan-li-wen-jian-xi-tong-wang-luo-yong-hu-kong-jian-nei-he-kong-jian-ying-jian-local/"/>
      <url>2021/05/14/qian-feng-shi-pin-cao-zuo-xi-tong-de-5-da-gong-neng-she-bei-kong-zhi-jin-cheng-guan-li-nei-cun-guan-li-wen-jian-xi-tong-wang-luo-yong-hu-kong-jian-nei-he-kong-jian-ying-jian-local/</url>
      
        <content type="html"><![CDATA[<p><img src="/images/20191215213023142.png"><br>操作系统的5大功能：</p><ol><li>设备控制</li><li>进程管理</li><li>内存管理</li><li>文件系统</li><li>网络<br><img src="/images/20191215212222274.png"><br>open write函数是在C库里的函数，属于应用层程序，（User space），<br>在这类函数中，肯定包含<code>swi</code>指令去触发某个异常val进入内核空间（Kernel space），<br>在内核空间的异常处理函数中会根据val这个异常值去调用sys_open，sys_write，<br>这些函数根据打开的不同文件，文件的属性(磁盘，LED等)去找到底层的不同驱动程序，驱动程序也是属于内核的部分。<br><img src="/images/20191214213724975.png"></li></ol><p><strong>通过 <code>C库 到 底层驱动程序</code> 这个对应关系 在 ==驱动程序框架== 中体现。</strong></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>windows ubuntu VMware board 嵌入式开发板与pc的网络连接方法</title>
      <link href="2021/05/14/windows-ubuntu-vmware-board-qian-ru-shi-kai-fa-ban-yu-pc-de-wang-luo-lian-jie-fang-fa-local/"/>
      <url>2021/05/14/windows-ubuntu-vmware-board-qian-ru-shi-kai-fa-ban-yu-pc-de-wang-luo-lian-jie-fang-fa-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]</p><h1 id="1-单系统-开发板-最方便的连接方法"><a href="#1-单系统-开发板-最方便的连接方法" class="headerlink" title="1. 单系统+开发板 最方便的连接方法"></a>1. 单系统+开发板 最方便的连接方法</h1><p>使用路由器<br>单系统windows或ubuntu直接连接路由器（有线无线皆可），开发板有线直接连接路由器，只要保证系统和开发板处于同一网段就可以连通。</p><h1 id="2-windows-VMware-开发板"><a href="#2-windows-VMware-开发板" class="headerlink" title="2. windows+VMware 开发板"></a>2. windows+VMware 开发板</h1><p>这种情况是无法从路由器引线连接到开发板，但要保证PC有两个网卡且至少有一个有线网卡（有线网卡和开发板连接）。</p><ol><li>虚拟机不能上网 连接开发板<br>在虚拟机ubuntu系统中一个网卡桥接到PC有线网卡，设置桥接的那张卡和板子在同一网段</li><li><strong>虚拟机可以上网 并 连接开发板</strong><br>在虚拟机中开两张卡，一张NAT，一张桥接到PC有线网卡。</li></ol><p><strong>注意：</strong><br><font size=4 color=#73D>虚拟机的NAT卡网段 和 PC另一张不连开发板的卡 网段要设置不一样。<br>虚拟机用于桥接的卡必须和开发板一个网段，并且与NAT卡、PC上网卡的网段都不同。<br>如：<br><strong>PC上网的网段</strong>：192.168.0.x<br><strong>虚拟机NAT网段</strong>：192.168.2.x<br>虚拟机NAT网卡 （在虚拟机上设）和 PC的VMwareVirtualEthernetAdapterforVMnet8（在PC上设）的IP同网段不同IP。<br><strong>虚拟机桥接有线网卡和板子网段</strong>：192.168.1.x<br>开发板（在板子上设）和虚拟机用于桥接的有线网卡（在虚拟机上设）设置为同网段不同IP。<br></font></p><h2 id="2-1-设置虚拟机中的网卡"><a href="#2-1-设置虚拟机中的网卡" class="headerlink" title="2.1 设置虚拟机中的网卡"></a>2.1 设置虚拟机中的网卡</h2><p><img src="/images/20191126153029201.png"></p><h3 id="2-1-1-虚拟机中NAT卡设置"><a href="#2-1-1-虚拟机中NAT卡设置" class="headerlink" title="2.1.1 虚拟机中NAT卡设置"></a>2.1.1 虚拟机中NAT卡设置</h3><p><img src="/images/20191126152505763.png"></p><h3 id="2-1-2-虚拟机网关设置"><a href="#2-1-2-虚拟机网关设置" class="headerlink" title="2.1.2 虚拟机网关设置"></a>2.1.2 虚拟机网关设置</h3><p>虚拟机NAT网关和PC上用于虚拟机上网的虚拟网卡的网关要一致。网关自动.2<br><img src="/images/2019112615404713.png"><br><img src="/images/20191126154806745.png"></p><h3 id="2-1-3-虚拟机中桥接卡设置"><a href="#2-1-3-虚拟机中桥接卡设置" class="headerlink" title="2.1.3 虚拟机中桥接卡设置"></a>2.1.3 虚拟机中桥接卡设置</h3><p><img src="/images/20191126153216897.png"><br>三种模式：<br>仅主机模式：是虚拟机和主机形成局域网，所以可以在主机使用ssh连接虚拟机，但是虚拟机不能上外网。<br>NAT模式：虚拟机可以上外网，但是主机默认不能ssh连接虚拟机，虚拟机ip不会变。<br>桥接模式：虚拟机可以上外网，但是主机默认不能ssh连接虚拟机，虚拟机ip会变化。<br>没有一种方式可以默认又能上外网，又能ssh的。</p><h3 id="远程访问另一台电脑的虚拟机"><a href="#远程访问另一台电脑的虚拟机" class="headerlink" title="远程访问另一台电脑的虚拟机"></a>远程访问另一台电脑的虚拟机</h3><p>主要步骤是在虚拟机配置NAT时添加 端口转发，意思是 其他电脑可以通过 这台电脑的IP和端口 访问这台电脑的虚拟机。<br><img src="/images/20191126192044822.png"><br><a href="https://blog.csdn.net/jiuduan2009/article/details/51737004">https://blog.csdn.net/jiuduan2009/article/details/51737004</a></p><h1 id="NFS挂在到板子"><a href="#NFS挂在到板子" class="headerlink" title="NFS挂在到板子"></a>NFS挂在到板子</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ifconfig</span> eth0 <span class="token number">192.168</span>.1.100<span class="token builtin class-name">echo</span> <span class="token function">ifconfig</span> eth0 <span class="token number">192.168</span>.1.100<span class="token function">mount</span> -t nfs -o tcp,nolock <span class="token number">192.168</span>.1.103:/nfs/fs_root /mnt<span class="token builtin class-name">echo</span> <span class="token function">mount</span> -t nfs -o tcp,nolock <span class="token number">192.168</span>.1.103:/nfs/fs_root /mnt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>交叉编译工具集的一些小工具</title>
      <link href="2021/05/14/jiao-cha-bian-yi-gong-ju-ji-de-yi-xie-xiao-gong-ju-local/"/>
      <url>2021/05/14/jiao-cha-bian-yi-gong-ju-ji-de-yi-xie-xiao-gong-ju-local/</url>
      
        <content type="html"><![CDATA[<p><strong>交叉编译工具集的一些小工具</strong><br><img src="/images/20191117205938916.png"></p><h3 id="1-elf操作系统之上的可执行文件包含头信息，可以-windows下是PE-readelf"><a href="#1-elf操作系统之上的可执行文件包含头信息，可以-windows下是PE-readelf" class="headerlink" title="1. elf操作系统之上的可执行文件包含头信息，可以,windows下是PE  readelf"></a>1. elf操作系统之上的可执行文件包含头信息，可以,windows下是PE  readelf</h3><p>读取可执行文件支持的平台等信息<br><code>readelf -h xxx</code></p><pre class="line-numbers language-none"><code class="language-none">aaa@aaa:~&#x2F;Desktop$ readelf -h mainELF Header:  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00   Class:                             ELF64  Data:                              2&#39;s complement, little endian  Version:                           1 (current)  OS&#x2F;ABI:                            UNIX - System V  ABI Version:                       0  Type:                              DYN (Shared object file)  Machine:                           Advanced Micro Devices X86-64  Version:                           0x1  Entry point address:               0x530  Start of program headers:          64 (bytes into file)  Start of section headers:          6440 (bytes into file)  Flags:                             0x0  Size of this header:               64 (bytes)  Size of program headers:           56 (bytes)  Number of program headers:         9  Size of section headers:           64 (bytes)  Number of section headers:         29  Section header string table index: 28<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-可执行文件包含数据大小size"><a href="#2-可执行文件包含数据大小size" class="headerlink" title="2. 可执行文件包含数据大小size"></a>2. 可执行文件包含数据大小size</h3><p><code>size xxx</code></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">aaa@aaa<span class="token operator">-</span>v<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>Desktop$ size main   text   data    bss    dec    hexfilename   <span class="token number">1517</span>    <span class="token number">600</span>      <span class="token number">8</span>   <span class="token number">2125</span>    <span class="token number">84</span>dmain<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="3-符号列表nm-查看全局标签"><a href="#3-符号列表nm-查看全局标签" class="headerlink" title="3. 符号列表nm 查看全局标签"></a>3. 符号列表nm 查看全局标签</h3><p>T 全局函数标签，代码段<br>t static修饰的函数区<br>D 全局变量区<br>d static修饰的变量区</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">aaa@aaa<span class="token operator">-</span>v<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>Desktop$ nm main<span class="token number">0000000000201010</span> B __bss_start<span class="token number">0000000000201010</span> b completed<span class="token punctuation">.</span><span class="token number">7697</span>                 w __cxa_finalize@@GLIBC_2<span class="token punctuation">.</span><span class="token number">2.5</span><span class="token number">0000000000201000</span> D __data_start<span class="token number">0000000000201000</span> W data_start<span class="token number">0000000000000560</span> t deregister_tm_clones<span class="token number">00000000000005f</span><span class="token number">0</span> t __do_global_dtors_aux<span class="token number">0000000000200</span>dc0 t __do_global_dtors_aux_fini_array_entry<span class="token number">0000000000201008</span> D __dso_handle<span class="token number">0000000000200</span>dc8 d _DYNAMIC<span class="token number">0000000000201010</span> D _edata<span class="token number">0000000000201018</span> B _end<span class="token number">00000000000006</span>d4 T _fini<span class="token number">0000000000000630</span> t frame_dummy<span class="token number">0000000000200</span>db8 t __frame_dummy_init_array_entry<span class="token number">0000000000000834</span> r __FRAME_END__<span class="token number">0000000000200f</span>b8 d _GLOBAL_OFFSET_TABLE_                 w __gmon_start__<span class="token number">00000000000006f</span><span class="token number">4</span> r __GNU_EH_FRAME_HDR<span class="token number">00000000000004e8</span> T _init<span class="token number">0000000000200</span>dc0 t __init_array_end<span class="token number">0000000000200</span>db8 t __init_array_start<span class="token number">00000000000006e0</span> R _IO_stdin_used                 w _ITM_deregisterTMCloneTable                 w _ITM_registerTMCloneTable<span class="token number">00000000000006</span>d0 T __libc_csu_fini<span class="token number">0000000000000660</span> T __libc_csu_init                 U __libc_start_main@@GLIBC_2<span class="token punctuation">.</span><span class="token number">2.5</span><span class="token number">000000000000063</span>a T main                 U puts@@GLIBC_2<span class="token punctuation">.</span><span class="token number">2.5</span><span class="token number">00000000000005</span>a0 t register_tm_clones<span class="token number">0000000000000530</span> T _start<span class="token number">0000000000201010</span> D __TMC_END__<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-strip-去除可执行文件中的符号表"><a href="#4-strip-去除可执行文件中的符号表" class="headerlink" title="4. strip 去除可执行文件中的符号表"></a>4. strip 去除可执行文件中的符号表</h3><p><code>file xxx</code> 查看是否去除符号表</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">aaa@aaa<span class="token operator">-</span>v<span class="token operator">:</span><span class="token operator">~</span><span class="token operator">/</span>Desktop$ file mainmain<span class="token operator">:</span> ELF <span class="token number">64</span><span class="token operator">-</span>bit LSB shared object<span class="token punctuation">,</span> x86<span class="token operator">-</span><span class="token number">64</span><span class="token punctuation">,</span> version <span class="token number">1</span> <span class="token punctuation">(</span>SYSV<span class="token punctuation">)</span><span class="token punctuation">,</span> dynamically linked<span class="token punctuation">,</span> interpreter <span class="token operator">/</span>lib64<span class="token operator">/</span>l<span class="token punctuation">,</span> <span class="token keyword">for</span> GNU<span class="token operator">/</span>Linux <span class="token number">3.2</span><span class="token number">.0</span><span class="token punctuation">,</span> BuildID<span class="token punctuation">[</span>sha1<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">53f</span>b9bc8b9b27b6dc018f8afaf611a8d482da38d<span class="token punctuation">,</span> not stripped<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>strip xxx</code> 去除可执行文件的符号表，size变小，用于发布</p><h3 id="5-strings-查看程序中存在字符串"><a href="#5-strings-查看程序中存在字符串" class="headerlink" title="5. strings 查看程序中存在字符串"></a>5. strings 查看程序中存在字符串</h3><h3 id="6-objcopy-按格式拷贝出代码段数据段（裸机开发时用"><a href="#6-objcopy-按格式拷贝出代码段数据段（裸机开发时用" class="headerlink" title="6. objcopy 按格式拷贝出代码段数据段（裸机开发时用"></a>6. objcopy 按格式拷贝出代码段数据段（裸机开发时用</h3><h3 id="7-objdump-反汇编（调试bootloader时常用）"><a href="#7-objdump-反汇编（调试bootloader时常用）" class="headerlink" title="7. objdump 反汇编（调试bootloader时常用）"></a>7. objdump 反汇编（调试bootloader时常用）</h3><p><code>objdump -d(-D) xxx</code> 将可执行文件转换成汇编代码</p><h3 id="安装交叉编译工具"><a href="#安装交叉编译工具" class="headerlink" title="安装交叉编译工具"></a>安装交叉编译工具</h3><ol><li>解压：<code>sudo tar jxvf xxx/arm-linux-gcc-4.3.2.tar.bz2</code></li><li>添加环境变量：<code>sudo gedit ~/.bashrc</code> <pre class="line-numbers language-c" data-language="c"><code class="language-c">export PATH<span class="token operator">=</span>$PATH<span class="token operator">:</span><span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>arm<span class="token operator">/</span>gcc<span class="token operator">-</span><span class="token number">3.4</span><span class="token number">.5</span><span class="token operator">-</span>glibc<span class="token operator">-</span><span class="token number">2.3</span><span class="token number">.6</span><span class="token operator">/</span>binexport LD_LIBRARY_PATH<span class="token operator">=</span>$LD_LIBRARY_PATH<span class="token operator">:</span><span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>arm<span class="token operator">/</span>gcc<span class="token operator">-</span><span class="token number">3.4</span><span class="token number">.5</span><span class="token operator">-</span>glibc<span class="token operator">-</span><span class="token number">2.3</span><span class="token number">.6</span><span class="token operator">/</span>lib<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><code>source ~/.bashrc</code></li></ol><p>若出现错误：arm-linux-gcc: No such file or directory参考：<br><a href="https://blog.csdn.net/zhengzg_6/article/details/54950707">https://blog.csdn.net/zhengzg_6/article/details/54950707</a><br>这种情况是因为你的操作系统是Ubuntu 64位的，而交叉编译工具链都是32位执行程序。要成功运行这些交叉编译工具链，需要与这些工具链相关的32位库。安装命令如下：<br><code>sudo apt-get install libc6:i386 libstdc++6:i386 libncurses5:i386 zlib1g:i386</code><br>如果不行再执行下边这个：<br><code>sudo apt-get install ia32-libs </code><br><code>sudo apt-get install lib32z1 lib32ncurses5 lib32bz2-1.0</code></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第32课 1 3.4.2内核下的I2C驱动之框架</title>
      <link href="2021/05/14/wds2-qi-di-32-ke-1-3.4.2-nei-he-xia-de-i2c-qu-dong-zhi-kuang-jia-local/"/>
      <url>2021/05/14/wds2-qi-di-32-ke-1-3.4.2-nei-he-xia-de-i2c-qu-dong-zhi-kuang-jia-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]</p><h1 id="时序，"><a href="#时序，" class="headerlink" title="时序，"></a>时序，</h1><p><img src="/images/20200607155228650.png"></p><h1 id="读写流程，"><a href="#读写流程，" class="headerlink" title="读写流程，"></a>读写流程，</h1><p><img src="/images/20200607155032821.png"><br><img src="/images/20200607155133968.png"></p><h1 id="总线设备驱动模型，虚拟的"><a href="#总线设备驱动模型，虚拟的" class="headerlink" title="总线设备驱动模型，虚拟的"></a>总线设备驱动模型，虚拟的</h1><p><img src="/images/20200607161555157.png"></p><h1 id="IIC驱动框架-分三层-设备驱动-总线驱动（核心层-适配器）"><a href="#IIC驱动框架-分三层-设备驱动-总线驱动（核心层-适配器）" class="headerlink" title="IIC驱动框架 分三层 设备驱动 总线驱动（核心层 适配器）"></a>IIC驱动框架 分三层 设备驱动 总线驱动（核心层 适配器）</h1><p><img src="/images/20200607161145636.png" alt=" "></p><h1 id="IIC-总线设备驱动"><a href="#IIC-总线设备驱动" class="headerlink" title="IIC 总线设备驱动"></a>IIC 总线设备驱动</h1><ol><li>左边注册一个设备，i2c_client</li><li>右边注册一个驱动，i2c_driver</li><li>比较名字id，相同则probe，在probe函数里为所欲为<br><img src="/images/20200607162420998.png"></li></ol>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第31课 2 应用调试gdb，另外的-安装某些库提示未定义找不到时处理 -I没有去编译库里找 根据结果修改头文件</title>
      <link href="2021/05/14/wds2-qi-di-31-ke-2-app-diao-shi-gdb-ling-wai-de-an-zhuang-mou-ku-ti-shi-wei-ding-yi-zhao-bu-dao-shi-chu-li-i-mei-qu-bian-yi-ku-zhao-gen-ju-jie-guo-xiu-gai-tou-wen-jian-local/"/>
      <url>2021/05/14/wds2-qi-di-31-ke-2-app-diao-shi-gdb-ling-wai-de-an-zhuang-mou-ku-ti-shi-wei-ding-yi-zhao-bu-dao-shi-chu-li-i-mei-qu-bian-yi-ku-zhao-gen-ju-jie-guo-xiu-gai-tou-wen-jian-local/</url>
      
        <content type="html"><![CDATA[<p>gdb在pc运行，<br>gdb-server在ARM 板子上运行，gdb-server是arm app的父进程。</p><ol><li><p>设置 host target</p></li><li><p>编译gdb</p></li><li><p>安装 到 tmp<br>默认安装到pc机，可以改变安装目录，查看<code>vi Makefile</code>，修改默认安装目录的前缀，<code>prefix</code><br><img src="/images/2020060715060983.png"></p></li><li><p>编译gdb-server，进入server目录，<br>头文件在 <code>-I</code>选项里找，还会在编译工具的库里找，如果提示在<code>-I</code>中找不到，查看系统变量编译工具库在哪里<code>echo $PATH</code>,然后进入编译工具所在的库，查找找不到的东西<code>grep ”XXX“ * -nR</code>，根据结果修改头文件就ok了。</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第30课2.1 符号表 驱动调试之段错误分析 结合内核打印信息PC值  确定地址范围是属于内核还是加载模块的空间System.map  查看内核或模块反汇编文件</title>
      <link href="2021/05/14/wds2-qi-di-30-ke-2.1-fu-hao-biao-qu-dong-diao-shi-zhi-duan-cuo-wu-fen-xi-jie-he-nei-he-da-yin-xin-xi-pc-zhi-que-ding-di-zhi-fan-wei-shi-shu-yu-nei-he-huan-shi-jia-zai-mo-kuai-de-kong-jian-system.map-cha-kan-nei-he-huo-mo-kuai-fan-hui-bian-wen-jian-local/"/>
      <url>2021/05/14/wds2-qi-di-30-ke-2.1-fu-hao-biao-qu-dong-diao-shi-zhi-duan-cuo-wu-fen-xi-jie-he-nei-he-da-yin-xin-xi-pc-zhi-que-ding-di-zhi-fan-wei-shi-shu-yu-nei-he-huan-shi-jia-zai-mo-kuai-de-kong-jian-system.map-cha-kan-nei-he-huo-mo-kuai-fan-hui-bian-wen-jian-local/</url>
      
        <content type="html"><![CDATA[<p>大致流程如下：</p><ol><li>结合内核打印信息PC值 ，</li><li>确定地址范围是属于内核还是加载模块的空间， <code>vi System.map</code>(内核源代码根目录下)确定内核的函数的地址范围；  把内核所有函数名及对应地址保存到文件<code>cat /proc/kallsyms &gt; 111.txt</code></li></ol><p><font color=red> <strong>System.map文件是编译内核时生成的，它记录了内核中的符号列表，以及符号在内存中的虚拟地址。<br>/proc/kallsyms文件是在内核启动后生成的，位于文件系统的/proc目录下，前提是内核必须打开CONFIG_KALLSYMS编译选项。它和System.map的区别是它同时包含了内核模块的符号列表。</strong></font><br><img src="https://img-blog.csdnimg.cn/20200606205612906.png"><img src="/images/20200606205624614.png"></p><ol start="4"><li>查看内核或模块反汇编文件</li></ol><p><strong>需要详细栈回溯信息(栈里面函数的调用关系) 必须 在编译内核时 打开CONFIG_FRAME_POINTER</strong><br><img src="/images/20200606202326404.png"></p><h1 id="WDS笔记"><a href="#WDS笔记" class="headerlink" title="WDS笔记"></a>WDS笔记</h1><p>二. 根据内核打印的段错误信息分析<br>a. 作为模块：</p><ol><li>根据pc值确定该指令属于内核还是外加的模块<br>pc=0xbf000018 它属于什么的地址？是内核还是通过insmod加载的驱动程序？<br>先判断是否属于内核的地址: 看System.map确定内核的函数的地址范围:c0004000~c03265a4</li></ol><p>如果不属于System.map里的范围，则它属于insmod加载的驱动程序</p><ol start="2"><li><p>假设它是加载的驱动程序引入的错误，怎么确定是哪一个驱动程序？<br>先看看加载的驱动程序的函数的地址范围<br>cat /proc/kallsyms  (内核函数、加载的函数的地址)<br>从这些信息里找到一个相近的地址, 这个地址&lt;=0xbf000018<br>比如找到了：<br>bf000000 t first_drv_open    [first_drv]</p></li><li><p>找到了first_drv.ko<br>在PC上反汇编它: arm-linux-objdump -D first_drv.ko &gt; frist_drv.dis<br>在dis文件里找到first_drv_open</p><p> first_drv.dis文件里              insmod后<br>00000000 <first_drv_open>:       bf000000 t first_drv_open    [first_drv]<br>00000018                         pc = bf000018</p></li></ol><p>./firstdrvtest on<br>Unable to handle kernel paging request at virtual address 56000050<br>内核使用56000050来访问时发生了错误</p><p>pgd = c3eb0000<br>[56000050] *pgd=00000000<br>Internal error: Oops: 5 [#1]<br>Modules linked in: first_drv<br>CPU: 0    Not tainted  (2.6.22.6 #1)<br>PC is at first_drv_open+0x18(该指令的偏移)/0x3c(该函数的总大小) [first_drv]<br>PC就是发生错误的指令的地址<br>大多时候，PC值只会给出一个地址，不到指示说是在哪个函数里</p><p>LR is at chrdev_open+0x14c/0x164<br>LR寄存器的值</p><p>pc = 0xbf000018</p><p>pc : [<bf000018>]    lr : [<c008d888>]    psr: a0000013<br>sp : c3c7be88  ip : c3c7be98  fp : c3c7be94<br>r10: 00000000  r9 : c3c7a000  r8 : c049abc0<br>r7 : 00000000  r6 : 00000000  r5 : c3e740c0  r4 : c06d41e0<br>r3 : bf000000  r2 : 56000050  r1 : bf000964  r0 : 00000000<br>执行这条导致错误的指令时各个寄存器的值</p><p>Flags: NzCv  IRQs on  FIQs on  Mode SVC_32  Segment user<br>Control: c000717f  Table: 33eb0000  DAC: 00000015<br>Process firstdrvtest (pid: 777, stack limit = 0xc3c7a258)<br>发生错误时当前进程的名称是firstdrvtest</p><p>栈<br>Stack: (0xc3c7be88 to 0xc3c7c000)<br>be80:                   c3c7bebc c3c7be98 c008d888 bf000010 00000000 c049abc0<br>bea0: c3e740c0 c008d73c c0474e20 c3e766a8 c3c7bee4 c3c7bec0 c0089e48 c008d74c<br>bec0: c049abc0 c3c7bf04 00000003 ffffff9c c002c044 c3d10000 c3c7befc c3c7bee8<br>bee0: c0089f64 c0089d58 00000000 00000002 c3c7bf68 c3c7bf00 c0089fb8 c0089f40<br>bf00: c3c7bf04 c3e766a8 c0474e20 00000000 00000000 c3eb1000 00000101 00000001<br>bf20: 00000000 c3c7a000 c04a7468 c04a7460 ffffffe8 c3d10000 c3c7bf68 c3c7bf48<br>bf40: c008a16c c009fc70 00000003 00000000 c049abc0 00000002 bec1fee0 c3c7bf94<br>bf60: c3c7bf6c c008a2f4 c0089f88 00008520 bec1fed4 0000860c 00008670 00000005<br>bf80: c002c044 4013365c c3c7bfa4 c3c7bf98 c008a3a8 c008a2b0 00000000 c3c7bfa8<br>bfa0: c002bea0 c008a394 bec1fed4 0000860c 00008720 00000002 bec1fee0 00000001<br>bfc0: bec1fed4 0000860c 00008670 00000002 00008520 00000000 4013365c bec1fea8<br>bfe0: 00000000 bec1fe84 0000266c 400c98e0 60000010 00008720 00000000 00000000 </p><p>Backtrace: (回溯)<br>[<bf000000>] (first_drv_open+0x0/0x3c [first_drv]) from [<c008d888>] (chrdev_open+0x14c/0x164)<br>[<c008d73c>] (chrdev_open+0x0/0x164) from [<c0089e48>] (__dentry_open+0x100/0x1e8)<br> r8:c3e766a8 r7:c0474e20 r6:c008d73c r5:c3e740c0 r4:c049abc0<br>[<c0089d48>] (__dentry_open+0x0/0x1e8) from [<c0089f64>] (nameidata_to_filp+0x34/0x48)<br>[<c0089f30>] (nameidata_to_filp+0x0/0x48) from [<c0089fb8>] (do_filp_open+0x40/0x48)<br> r4:00000002<br>[<c0089f78>] (do_filp_open+0x0/0x48) from [<c008a2f4>] (do_sys_open+0x54/0xe4)<br> r5:bec1fee0 r4:00000002<br>[<c008a2a0>] (do_sys_open+0x0/0xe4) from [<c008a3a8>] (sys_open+0x24/0x28)<br>[<c008a384>] (sys_open+0x0/0x28) from [<c002bea0>] (ret_fast_syscall+0x0/0x2c)<br>Code: e24cb004 e59f1024 e3a00000 e5912000 (e5923000)<br>Segmentation fault</p><h1 id=""><a href="#" class="headerlink" title=""></a></h1><p>b. 编入内核<br>Modules linked in:<br>CPU: 0    Not tainted  (2.6.22.6 #2)<br>PC is at first_drv_open+0x18/0x3c<br>LR is at chrdev_open+0x14c/0x164<br>pc : [<c014e6c0>]    lr : [<c008638c>]    psr: a0000013<br>sp : c3a03e88  ip : c3a03e98  fp : c3a03e94<br>r10: 00000000  r9 : c3a02000  r8 : c03f3c60<br>r7 : 00000000  r6 : 00000000  r5 : c38a0c50  r4 : c3c1e780<br>r3 : c014e6a8  r2 : 56000050  r1 : c031a47c  r0 : 00000000<br>Flags: NzCv  IRQs on  FIQs on  Mode SVC_32  Segment user<br>Control: c000717f  Table: 339f0000  DAC: 00000015<br>Process firstdrvtest (pid: 750, stack limit = 0xc3a02258)</p><ol><li><p>根据pc值确定该指令属于内核还是外加的模块<br>pc=c014e6c0 属于内核(看System.map)</p></li><li><p>反汇编内核: arm-linux-objdump -D vmlinux &gt; vmlinux.dis<br>在dis文件里搜c014e6c0<br>c014e6a8 <first_drv_open>:<br>c014e6a8:       e1a0c00d        mov     ip, sp<br>c014e6ac:       e92dd800        stmdb   sp!, {fp, ip, lr, pc}<br>c014e6b0:       e24cb004        sub     fp, ip, #4      ; 0x4<br>c014e6b4:       e59f1024        ldr     r1, [pc, #36]   ; c014e6e0 &lt;.text+0x1276e0&gt;<br>c014e6b8:       e3a00000        mov     r0, #0  ; 0x0<br>c014e6bc:       e5912000        ldr     r2, [r1]<br>c014e6c0:       e5923000        ldr     r3, [r2] // 在此出错 r2=56000050</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第30课 4 内核僵死 无法输入也没反应 当内核卡死时利用内核心脏时钟中断检查连续10s内都是同一个pid则就是这个进程出问题，pt_regs结构体保存了R寄存器的值，打印PC后回到前面分析</title>
      <link href="2021/05/14/wds2-qi-di-30-ke-4-nei-he-jiang-si-wu-fa-shu-ru-ye-mei-fan-ying-dang-nei-he-qia-si-shi-li-yong-nei-he-xin-zang-shi-zhong-zhong-duan-jian-cha-lian-xu-10s-nei-du-shi-tong-yi-ge-pid-ze-jiu-shi-zhe-ge-jin-cheng-chu-wen-ti-pt-regs-jie-gou-ti-bao-cun-liao-r-ji-cun-qi-de-zhi-da-yin-pc-hou-hui-dao-qian-mian-fen-xi-local/"/>
      <url>2021/05/14/wds2-qi-di-30-ke-4-nei-he-jiang-si-wu-fa-shu-ru-ye-mei-fan-ying-dang-nei-he-qia-si-shi-li-yong-nei-he-xin-zang-shi-zhong-zhong-duan-jian-cha-lian-xu-10s-nei-du-shi-tong-yi-ge-pid-ze-jiu-shi-zhe-ge-jin-cheng-chu-wen-ti-pt-regs-jie-gou-ti-bao-cun-liao-r-ji-cun-qi-de-zhi-da-yin-pc-hou-hui-dao-qian-mian-fen-xi-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]<br>在内核时钟中断中加入打印pid和进程名信息。<br>当内核卡死时，利用内核心脏<strong>时钟中断处理函数检查连续10s内都是同一个pid</strong>则就是这个进程出问题。</p><p>查看内核中断，30号中断是时钟中断，查找<code>Timer Tick</code>，<br><img src="/images/20200607113903199.png"><br>在这里，<br><img src="/images/20200607114129568.png"><br>中断处理函数，<br><img src="/images/20200607114207960.png"></p><h1 id="在时钟中断中打印pid信息的代码"><a href="#在时钟中断中打印pid信息的代码" class="headerlink" title="在时钟中断中打印pid信息的代码"></a>在时钟中断中打印pid信息的代码</h1><p><img src="/images/20200607114944370.png"><br>在这里卡死，打印出信息，<br><img src="/images/20200607115118730.png"></p><h1 id="asm-do-IRQ中打印寄存器R值的代码-struct-pt-regs中"><a href="#asm-do-IRQ中打印寄存器R值的代码-struct-pt-regs中" class="headerlink" title="asm_do_IRQ中打印寄存器R值的代码 struct pt_regs中"></a>asm_do_IRQ中打印寄存器R值的代码 struct pt_regs中</h1><p>R15 保存pc的值，<br><img src="/images/202006071155285.png">在asm_do_IRQ中的代码，类似时钟中断，<br><img src="/images/20200607120314805.png"></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第30课 1.3 create_proc_entry printk输出到自己的log文件模仿 _proc_kmsg myprintk 读睡眠写后唤醒 EXPORT_SYMBOL</title>
      <link href="2021/05/14/wds2-qi-di-30-ke-1.3-create-proc-entry-printk-shu-chu-dao-zi-ji-de-log-wen-jian-mo-fang-proc-kmsg-myprintk-du-shui-mian-xie-hou-huan-xing-export-symbol-local/"/>
      <url>2021/05/14/wds2-qi-di-30-ke-1.3-create-proc-entry-printk-shu-chu-dao-zi-ji-de-log-wen-jian-mo-fang-proc-kmsg-myprintk-du-shui-mian-xie-hou-huan-xing-export-symbol-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]</p><h1 id="让printk的输出到自己的log文件-proc-my-msg"><a href="#让printk的输出到自己的log文件-proc-my-msg" class="headerlink" title="让printk的输出到自己的log文件 /proc/my_msg"></a>让printk的输出到自己的log文件 /proc/my_msg</h1><p>在用户的命令行中 执行 <code>cat /proc/kmsg</code>时候，进入内核态，<br>内核找到对应的fops调用read，在read中copy_to_user<br>对proc的操作函数在fs/proc中,参考fs/proc/proc_misc.c， </p><h2 id="程序1-能在-proc-xx打开文件-框架"><a href="#程序1-能在-proc-xx打开文件-框架" class="headerlink" title="程序1 能在/proc/xx打开文件 框架"></a>程序1 能在/proc/xx打开文件 框架</h2><h3 id="源代码1"><a href="#源代码1" class="headerlink" title="源代码1"></a>源代码1</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/proc_fs.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span>   <span class="token comment">// MODULE_LICENSE</span></span><span class="token keyword">static</span> <span class="token keyword">struct</span>  <span class="token operator">*</span>my_entry<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">mymsg_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>ppos<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"mymsg_read is called.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> proc_mymsg_operations <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>read<span class="token operator">=</span> mymsg_read<span class="token punctuation">,</span><span class="token comment">// .poll= kmsg_poll,</span><span class="token comment">// .open= kmsg_open,</span><span class="token comment">// .release= kmsg_release,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">proc_msg_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    my_entry <span class="token operator">=</span> <span class="token function">create_proc_entry</span><span class="token punctuation">(</span><span class="token string">"mymsg"</span><span class="token punctuation">,</span> S_IRUSR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>proc_root<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>my_entry<span class="token punctuation">)</span>        my_entry<span class="token operator">-></span>proc_fops <span class="token operator">=</span> <span class="token operator">&amp;</span>proc_mymsg_operations<span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">proc_msg_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">remove_proc_entry</span><span class="token punctuation">(</span><span class="token string">"mymsg"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>proc_root<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>proc_msg_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>proc_msg_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="实验1"><a href="#实验1" class="headerlink" title="实验1"></a>实验1</h3><p><img src="/images/20200601212846999.png"><br>简单的写了read函数，<br><img src="/images/20200601213502980.png"></p><h2 id="程序2-利用vsnprintf写自己的printk-并导出到内核空间EXPORT-SYMBOL"><a href="#程序2-利用vsnprintf写自己的printk-并导出到内核空间EXPORT-SYMBOL" class="headerlink" title="程序2  利用vsnprintf写自己的printk 并导出到内核空间EXPORT_SYMBOL"></a>程序2  利用vsnprintf写自己的printk 并导出到内核空间EXPORT_SYMBOL</h2><p>用vsnprintf把myprintk的参数复制到临时缓存区tmp_buf，再把tmp_buf写入到ring_bug，<br>然后读取ring_bug到用户空间。<br>参考<code>fs/proc/kmsg.c</code>的kmsg_read, 阻塞读取数据时等到被唤醒，由执行put的地方唤醒，</p><h3 id="源代码2"><a href="#源代码2" class="headerlink" title="源代码2"></a>源代码2</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/irq.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/regs-gpio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/hardware.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/proc_fs.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span>   <span class="token comment">// MODULE_LICENSE</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/uaccess.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/delay.h></span></span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">proc_dir_entry</span> <span class="token operator">*</span>my_entry<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">char</span> tmp_buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">/* 定义一个等待队列button_waitq，这个等待队列实际上是由中断驱动的，    当中断发生时，会令挂接到这个等待队列的休眠进程唤醒 */</span><span class="token keyword">static</span> <span class="token function">DECLARE_WAIT_QUEUE_HEAD</span><span class="token punctuation">(</span>log_waitq<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// -------------------------------------环形缓存区----------------------------------------------</span><span class="token comment">// 环形缓冲区 log_buf</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUF_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DATA_TYPE</span> <span class="token expression"><span class="token keyword">char</span></span></span><span class="token comment">/* 环形顺序缓存区@BUF_SIZE    需要自定义两个宏 缓存区大小@DATA_TYPE   存储数据的类型@.head = 0,@.tail = 0,@.size = 0,@.capacity = BUF_SIZE   */</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">ring_buf</span> ring_buf<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">ring_buf</span><span class="token punctuation">&#123;</span>    DATA_TYPE buf<span class="token punctuation">[</span>BUF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> head<span class="token punctuation">;</span>    <span class="token keyword">int</span> tail<span class="token punctuation">;</span>    <span class="token keyword">int</span> size<span class="token punctuation">;</span>    <span class="token keyword">int</span> capacity<span class="token punctuation">;</span>    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>isempty<span class="token punctuation">)</span><span class="token punctuation">(</span>ring_buf<span class="token operator">*</span> rb<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>put<span class="token punctuation">)</span><span class="token punctuation">(</span>ring_buf<span class="token operator">*</span> rb<span class="token punctuation">,</span> DATA_TYPE c<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>gets<span class="token punctuation">)</span><span class="token punctuation">(</span>ring_buf<span class="token operator">*</span> rb<span class="token punctuation">,</span> DATA_TYPE<span class="token operator">*</span> dst<span class="token punctuation">,</span>  <span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">/* 往环形缓存区存入数据@ring_buf* rb 需要处理的环形缓存区 通常为THIS@DATA_TYPE c  需要存入的数据    */</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ring_buf_put</span><span class="token punctuation">(</span>ring_buf<span class="token operator">*</span> rb<span class="token punctuation">,</span> DATA_TYPE c<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    rb<span class="token operator">-></span>tail <span class="token operator">=</span> <span class="token punctuation">(</span>rb<span class="token operator">-></span>tail <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> rb<span class="token operator">-></span>capacity<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>rb<span class="token operator">-></span>head <span class="token operator">==</span> rb<span class="token operator">-></span>tail<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 满了就覆盖</span>        rb<span class="token operator">-></span>head <span class="token operator">=</span> <span class="token punctuation">(</span>rb<span class="token operator">-></span>head <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> rb<span class="token operator">-></span>capacity<span class="token punctuation">;</span>        rb<span class="token operator">-></span>size <span class="token operator">=</span> rb<span class="token operator">-></span>capacity<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span> rb<span class="token operator">-></span>size<span class="token operator">++</span><span class="token punctuation">;</span>                   rb<span class="token operator">-></span>buf<span class="token punctuation">[</span>rb<span class="token operator">-></span>tail<span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/* 检查环形缓存区是否为空@ring_buf* rb 需要处理的环形缓存区 通常为THIS    */</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ring_buf_isempty</span><span class="token punctuation">(</span>ring_buf<span class="token operator">*</span> rb<span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token keyword">return</span> rb<span class="token operator">-></span>head <span class="token operator">==</span> rb<span class="token operator">-></span>tail<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token comment">/* 从环形缓存区中获取数据@ring_buf* rb   需要处理的环形缓存区 通常为THIS @DATA_TYPE* dst 存入目标@int len        获取的数据的个数    return: 成功复制到dst的数据个数 */</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ring_buf_gets</span><span class="token punctuation">(</span>ring_buf<span class="token operator">*</span> rb<span class="token punctuation">,</span> DATA_TYPE<span class="token operator">*</span> dst<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 实际能复制的长度</span>    <span class="token keyword">int</span> cp_len <span class="token operator">=</span> len <span class="token operator">></span> rb<span class="token operator">-></span>size <span class="token operator">?</span> rb<span class="token operator">-></span>size <span class="token operator">:</span> len<span class="token punctuation">;</span>        <span class="token comment">// 缓存区为空</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>rb<span class="token operator">-></span><span class="token function">isempty</span><span class="token punctuation">(</span>rb<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">// 将数据复制到dst，检查是否wrap</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>rb<span class="token operator">-></span>tail <span class="token operator">></span> rb<span class="token operator">-></span>head<span class="token punctuation">)</span>        <span class="token comment">// not wrap</span>        <span class="token function">memcpy</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> rb<span class="token operator">-></span>buf <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> cp_len <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>DATA_TYPE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                          <span class="token comment">// wrap</span>        <span class="token keyword">int</span> len_back<span class="token punctuation">;</span>              <span class="token comment">// 后部分的长度</span>        len_back <span class="token operator">=</span> rb<span class="token operator">-></span>capacity <span class="token operator">-</span> rb<span class="token operator">-></span>head<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>cp_len <span class="token operator">&lt;=</span> len_back<span class="token punctuation">)</span>     <span class="token comment">// 需要的数据长度 &lt;= 后半部的长度 直接复制需要的长度即可</span>            <span class="token function">memcpy</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> rb<span class="token operator">-></span>buf <span class="token operator">+</span> rb<span class="token operator">-></span>head<span class="token punctuation">,</span> cp_len <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>DATA_TYPE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                      <span class="token comment">// 需要的数据长度 > 后半部的长度 分两部分复制</span>            <span class="token function">memcpy</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> rb<span class="token operator">-></span>buf <span class="token operator">+</span> rb<span class="token operator">-></span>head<span class="token punctuation">,</span> len_back <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>DATA_TYPE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// 后半部</span>            <span class="token function">memcpy</span><span class="token punctuation">(</span>dst <span class="token operator">+</span> len_back<span class="token punctuation">,</span> rb<span class="token operator">-></span>buf<span class="token punctuation">,</span> <span class="token punctuation">(</span>cp_len <span class="token operator">-</span> len_back<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>DATA_TYPE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 前半部</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> cp_len<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 定义并初始化一个缓存区</span><span class="token keyword">static</span> ring_buf log_buf <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span>head <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token punctuation">.</span>tail <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token punctuation">.</span>capacity <span class="token operator">=</span> BUF_SIZE<span class="token punctuation">,</span>    <span class="token punctuation">.</span>isempty <span class="token operator">=</span> ring_buf_isempty<span class="token punctuation">,</span>    <span class="token punctuation">.</span>put <span class="token operator">=</span> ring_buf_put<span class="token punctuation">,</span>    <span class="token punctuation">.</span>gets <span class="token operator">=</span> ring_buf_gets<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// -------------------------------------------------------------------------------------------</span><span class="token comment">// 巧妙用vsnprintf将日志写到临时缓存区</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">myprintk</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    va_list args<span class="token punctuation">;</span> <span class="token comment">// typedef char *va_list;</span>    <span class="token keyword">int</span> len<span class="token punctuation">,</span> i<span class="token punctuation">;</span>    <span class="token function">va_start</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> fmt<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// ? 拆解可变参数？</span>    len <span class="token operator">=</span> <span class="token function">vsnprintf</span><span class="token punctuation">(</span>tmp_buf<span class="token punctuation">,</span> INT_MAX<span class="token punctuation">,</span> fmt<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">va_end</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 将临时缓存区数据放入环形缓存区中</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>         log_buf<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log_buf<span class="token punctuation">,</span> tmp_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 当缓存区有数据后，唤醒等待log_waitq的进程</span>    <span class="token function">wake_up_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log_waitq<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> len<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 参考fs/proc/kmsg.c的kmsg_read,</span><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">mymsg_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buff<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>ppos<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> read_flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> err<span class="token punctuation">,</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> cp_len<span class="token punctuation">;</span>    <span class="token comment">// 非阻塞方式打开 并且 buf为空 返回错误咯</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>file<span class="token operator">-></span>f_flags <span class="token operator">&amp;</span> O_NONBLOCK<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> log_buf<span class="token punctuation">.</span><span class="token function">isempty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log_buf<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token operator">-</span>EAGAIN<span class="token punctuation">;</span>    <span class="token comment">// 阻塞方式打开文件时 休眠直到buf不为空</span>    <span class="token comment">// 休眠时放入队列log_wait，唤醒时在队列里找，在写数据后唤醒</span>    err <span class="token operator">=</span> <span class="token function">wait_event_interruptible</span><span class="token punctuation">(</span>log_waitq<span class="token punctuation">,</span> <span class="token operator">!</span>log_buf<span class="token punctuation">.</span><span class="token function">isempty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 被唤醒之后做点事，copy_to_user</span>    <span class="token comment">// 方法一 类似视频==================================================</span>    <span class="token comment">// cp_len = log_buf.gets(&amp;log_buf, tmp_buf, count);   // 先从log_buf中取出到tmp_buf</span>    <span class="token comment">// while (!err &amp;&amp; i &lt; cp_len) &#123;                       // 然后搬运到用户buff</span>    <span class="token comment">//     err = __put_user(tmp_buf[i], buff);</span>    <span class="token comment">//     buff++;</span>    <span class="token comment">//     i++;</span>    <span class="token comment">// &#125;</span>    <span class="token comment">// // 没有出错返回i，出错返回错误值</span>    <span class="token comment">// if (!err)  </span>    <span class="token comment">//     err = i;</span>    <span class="token comment">// // cat /proc/mymsg 时打印不停 因为返回永远是有长度的</span>    <span class="token comment">// //  临时解决 flag 0 1</span>    <span class="token comment">// read_flag = read_flag == 1 ? 0 : 1; // 改变值</span>    <span class="token comment">// if (read_flag == 0) return 0;       // 首次读取返回读取长度</span>    <span class="token comment">// return err;  </span>    <span class="token comment">// 方法二 不用copy_to_user直接memcpy ================================</span>    <span class="token comment">// cat /proc/mymsg 时打印不停 因为返回永远是有长度的</span>    <span class="token comment">//  临时解决 flag 0 1</span>    read_flag <span class="token operator">=</span> read_flag <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 改变值</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>read_flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>       <span class="token comment">// 首次读取返回读取长度</span>    <span class="token keyword">return</span> log_buf<span class="token punctuation">.</span><span class="token function">gets</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>log_buf<span class="token punctuation">,</span> buff<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> proc_mymsg_operations <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>read<span class="token operator">=</span> mymsg_read<span class="token punctuation">,</span><span class="token comment">// .poll= kmsg_poll,</span><span class="token comment">// .open= kmsg_open,</span><span class="token comment">// .release= kmsg_release,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">proc_msg_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    my_entry <span class="token operator">=</span> <span class="token function">create_proc_entry</span><span class="token punctuation">(</span><span class="token string">"mymsg"</span><span class="token punctuation">,</span> S_IRUSR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>proc_root<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>my_entry<span class="token punctuation">)</span>        my_entry<span class="token operator">-></span>proc_fops <span class="token operator">=</span> <span class="token operator">&amp;</span>proc_mymsg_operations<span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">proc_msg_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">remove_proc_entry</span><span class="token punctuation">(</span><span class="token string">"mymsg"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>proc_root<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>proc_msg_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>proc_msg_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">EXPORT_SYMBOL</span><span class="token punctuation">(</span>myprintk<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 导出</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// EXPORT_SYMBOL是Linux内核中一个常见的工具，</span><span class="token comment">// 其作用是讲一个”Symbol”（函数或者变量）导出到内核空间，使得内核的所有代码都可以使用。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="实验2"><a href="#实验2" class="headerlink" title="实验2"></a>实验2</h3><p>可以在自定义的文件中看到myprintk输出的内容。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 编译复制清空</span><span class="token function">rm</span> /nfs/fs_root/tzb/* ./*.ko ./*.o ./led_user -r<span class="token function">make</span> <span class="token operator">&amp;&amp;</span> arm-linux-gcc -o led_user led_user.c<span class="token function">cp</span> ./*.ko ./led_user /nfs/fs_root/tzb/<span class="token comment"># 加载模块 测试用户</span>rmmod led_myprintkrmmod proc_msginsmod proc_msg.koinsmod led_myprintk.ko./led_user led0 on./led_user led0 off<span class="token function">cat</span> /proc/mymsg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/images/20200605204946229.png"></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第30课 1.1 1.2 驱动调试之printk的使用</title>
      <link href="2021/05/14/wds2-qi-di-30-ke-1.1-1.2-qu-dong-diao-shi-zhi-printk-de-shi-yong-define-dbg-printk-printk-xiu-gai-log-level-diao-zheng-da-yin-ji-bie-local/"/>
      <url>2021/05/14/wds2-qi-di-30-ke-1.1-1.2-qu-dong-diao-shi-zhi-printk-de-shi-yong-define-dbg-printk-printk-xiu-gai-log-level-diao-zheng-da-yin-ji-bie-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]<br>内核调试方法有几种</p><h1 id="printk"><a href="#printk" class="headerlink" title="printk()"></a>printk()</h1><p>printk的数据实际存放在数组log_buf，也在console打印。</p><p><code>dmesg</code>命令可以看到log_buf数组的打印数据，从这个文件<code>/proc/kmsg</code>里读取，<br><code>/etc/fstab</code>文件系统表<br><code>/proc/mount</code>查看挂载情况<br><img src="/images/20200601175428263.png"></p><h2 id="打印原理"><a href="#打印原理" class="headerlink" title="打印原理"></a>打印原理</h2><p>内核会根据命令行参数（uboot传入）console=ttySAC0，内核用printk()打印，所以最终会调用到硬件的write函数，<br>关于console由add_preferred_console存放在console_cmdline里面的，<br>内核调用register_console获取console_cmdline的项，<br>kernel/printk.c，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token number">1.</span> uboot传入的使用console参数，保存在console_cmdline<span class="token function">__setup</span><span class="token punctuation">(</span><span class="token string">"console="</span><span class="token punctuation">,</span> console_setup<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 宏函数生成结构体，内核中有很多这些结构体来处理参数，当内核处理参数时。</span><span class="token function">console_setup</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">)</span><span class="token function">add_preferred_console</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token comment">// 根据参数记录这个控制台的名词</span>console_cmdline<span class="token punctuation">[</span>MAX_CMDLINECONSOLES<span class="token punctuation">]</span> <span class="token comment">// 数组存放控制台名称 </span><span class="token number">2.</span> 硬件驱动中 内核调用register_console选择console_cmdline数组的内容console<span class="token function">register_console</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s3c24xx_serial_console<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// drivers/serial/s3c2410.c</span>s3c24xx_serial_console    <span class="token comment">// 在同文件下定义如下，包含了name和write</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">console</span> s3c24xx_serial_console <span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">.</span>name<span class="token operator">=</span> S3C24XX_SERIAL_NAME<span class="token punctuation">,</span> <span class="token comment">// #define S3C24XX_SERIAL_NAME"ttySAC"</span><span class="token punctuation">.</span>device<span class="token operator">=</span> uart_console_device<span class="token punctuation">,</span><span class="token punctuation">.</span>flags<span class="token operator">=</span> CON_PRINTBUFFER<span class="token punctuation">,</span><span class="token punctuation">.</span>index<span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">.</span>write<span class="token operator">=</span> s3c24xx_serial_console_write<span class="token punctuation">,</span><span class="token punctuation">.</span>setup<span class="token operator">=</span> s3c24xx_serial_console_setup<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token number">3.</span> printk 最终调用到uboot传入参数对应硬件的writeasmlinkage <span class="token keyword">int</span> <span class="token function">printk</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>r <span class="token operator">=</span> <span class="token function">vprintk</span><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* Emit the output into the temporary buffer */</span> 先把输出信息放入临时缓存区printed_len <span class="token operator">=</span> <span class="token function">vscnprintf</span><span class="token punctuation">(</span>printk_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>printk_buf<span class="token punctuation">)</span><span class="token punctuation">,</span> fmt<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>Copy the output into log_buf<span class="token punctuation">.</span> <span class="token comment">/* 写入log_buf 这些打印信息在内核的字符数组里面（dmesg就是打印数组）*/</span> <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"&lt;3>hello"</span><span class="token punctuation">)</span> <span class="token comment">// 打印级别，默认级别是&lt;4></span><span class="token function">release_console_sem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">call_console_drivers</span><span class="token punctuation">(</span>_con_start<span class="token punctuation">,</span> _log_end<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 从log_buf获取数据 算出 打印级别 </span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>msg_log_level <span class="token operator">&lt;</span> console_loglevel <span class="token comment">// 打印级别可以修改</span><span class="token function">_call_console_drivers</span><span class="token punctuation">(</span>start_print<span class="token punctuation">,</span> cur_index<span class="token punctuation">,</span> msg_level<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">__call_console_drivers</span><span class="token punctuation">(</span>start <span class="token operator">&amp;</span> LOG_BUF_MASK<span class="token punctuation">,</span> log_buf_len<span class="token punctuation">)</span><span class="token punctuation">;</span>console<span class="token operator">-></span><span class="token function">write</span><span class="token punctuation">(</span>con<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token function">LOG_BUF</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">,</span> end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="printk调试方法"><a href="#printk调试方法" class="headerlink" title="printk调试方法"></a>printk调试方法</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DBG_PRINTK</span><span class="token expression">printk</span><span class="token comment">// 需要打印的时候 </span></span><span class="token comment">// #define DBG_PRINTK(x...)  // 不需要打印时， 空的宏 ...表示参数可变</span><span class="token function">DBG_PRINTK</span><span class="token punctuation">(</span><span class="token string">"%s %s %s"</span><span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> __FUNCTION__<span class="token punctuation">,</span> <span class="token constant">__LINE__</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">DBG_PRINTK</span><span class="token punctuation">(</span><span class="token string">"%s %s %s"</span><span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> __FUNCTION__<span class="token punctuation">,</span> <span class="token constant">__LINE__</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="系统启动后，修改打印级别的阈值"><a href="#系统启动后，修改打印级别的阈值" class="headerlink" title="系统启动后，修改打印级别的阈值"></a>系统启动后，修改打印级别的阈值</h3><p>查看<code>cat /proc/sys/kernel/printk</code>，<br>修改 <code>echo &quot;8 4 1 7&quot; &gt; /proc/sys/kernel/printk</code><br><img src="/images/20200601163531441.png"></p><h3 id="代码里边修改打印级别"><a href="#代码里边修改打印级别" class="headerlink" title="代码里边修改打印级别"></a>代码里边修改打印级别</h3><h4 id="直接改成0，所有的都不打印-kernel-printk-c的msg-log-level-lt-console-loglevel-–-gt-msg-log-level-lt-0"><a href="#直接改成0，所有的都不打印-kernel-printk-c的msg-log-level-lt-console-loglevel-–-gt-msg-log-level-lt-0" class="headerlink" title="直接改成0，所有的都不打印, kernel/printk.c的msg_log_level &lt; console_loglevel –&gt; msg_log_level &lt; 0"></a>直接改成0，所有的都不打印, kernel/printk.c的msg_log_level &lt; console_loglevel –&gt; msg_log_level &lt; 0</h4><h4 id="uboot参数传递-添加设置-set-bootargs-loglevel-0-或者-set-edbug-会打印所有信息"><a href="#uboot参数传递-添加设置-set-bootargs-loglevel-0-或者-set-edbug-会打印所有信息" class="headerlink" title="uboot参数传递 添加设置 set bootargs loglevel=0 或者 set edbug 会打印所有信息"></a>uboot参数传递 添加设置 set bootargs loglevel=0 或者 set edbug 会打印所有信息</h4><h1 id="WDS笔记"><a href="#WDS笔记" class="headerlink" title="WDS笔记"></a>WDS笔记</h1><p>驱动程序的调试<br>一. 打印: prink, 自制proc文件<br>UBOOT传入console=ttySAC0 console=tty1</p><ol><li><p>内核处理UBOOT传入的参数<br>console_setup<br> add_preferred_console // 我想用名为”ttySAC0”的控制台，先记录下来</p></li><li><p>硬件驱动的入口函数里:<br> drivers/serial/s3c2410.c</p><pre><code> register_console(&amp;s3c24xx_serial_console);        </code></pre></li><li><p>printk</p><pre><code> vprintk     /* Emit the output into the temporary buffer */     // 先把输出信息放入临时BUFFER     vscnprintf          // Copy the output into log_buf.     // 把临时BUFFER里的数据稍作处理，再写入log_buf     // 比如printk(&quot;abc&quot;)会得到&quot;&lt;4&gt;abc&quot;, 再写入log_buf     // 可以用dmesg命令把log_buf里的数据打印出来重现内核的输出信息               // 调用硬件的write函数输出     release_console_sem();         call_console_drivers(_con_start, _log_end);             // 从log_buf得到数据，算出打印级别             _call_console_drivers(start_print, cur_index, msg_level);                             // 如果可以级别够格打印                 if ((msg_log_level &lt; console_loglevel                     __call_console_drivers                         con-&gt;write(con, &amp;LOG_BUF(start), end - start);</code></pre></li></ol>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第29课 1 2 3 裸板调试方法 点灯 串口 JTAG 重定位前的代码不能用源码级别的调试只能用汇编级别的调试，逐条指令调试。</title>
      <link href="2021/05/14/wds2-qi-di-29-ke-1-2-3-luo-ban-diao-shi-fang-fa-dian-deng-chuan-kou-jtag-chong-ding-wei-qian-de-dai-ma-bu-neng-yong-yuan-ma-ji-bie-de-diao-shi-zhi-neng-yong-hui-bian-ji-bie-de-diao-shi-zhu-tiao-zhi-ling-diao-shi-local/"/>
      <url>2021/05/14/wds2-qi-di-29-ke-1-2-3-luo-ban-diao-shi-fang-fa-dian-deng-chuan-kou-jtag-chong-ding-wei-qian-de-dai-ma-bu-neng-yong-yuan-ma-ji-bie-de-diao-shi-zhi-neng-yong-hui-bian-ji-bie-de-diao-shi-zhu-tiao-zhi-ling-diao-shi-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]</p><h1 id="裸板调试方-需要结合汇编源码"><a href="#裸板调试方-需要结合汇编源码" class="headerlink" title="裸板调试方 需要结合汇编源码"></a>裸板调试方 需要结合汇编源码</h1><h2 id="点灯"><a href="#点灯" class="headerlink" title="点灯"></a>点灯</h2><h2 id="串口打印"><a href="#串口打印" class="headerlink" title="串口打印"></a>串口打印</h2><h2 id="JTAG"><a href="#JTAG" class="headerlink" title="JTAG"></a>JTAG</h2><p>JTAG(Joint Test Action Group，联合测试工作组)，主要用于芯片内部测试。<br>标准的JTAG接口是4线：TMS、TCK、TDI、TDO，分别为模式选择、时钟、数据输入和数据输出线。</p><p>JTAG位于CPU内部，当cpu与外设的地址信号，数据信号都要经过JTAG。<br>电脑上的应用程序有 keil、ADS、openOCD<br>JTAG调试器有Jlink、openJTAG、并口wigger。</p><p>可以控制cpu，<br>如，当地址信号 == xxx 时，让cpu停止工作，读寄存器，重新运行 ，，，硬件断点（ARM9只有两个比较器）<br>如，当数据信号 == xxx时，  让cpu停止工作，读寄存器，重新运行，，，软件断点</p><h3 id="cpu从0地址执行，想让运行在某地址时停止"><a href="#cpu从0地址执行，想让运行在某地址时停止" class="headerlink" title="cpu从0地址执行，想让运行在某地址时停止"></a>cpu从0地址执行，想让运行在某地址时停止</h3><h4 id="1-设置硬件断点"><a href="#1-设置硬件断点" class="headerlink" title="1. 设置硬件断点"></a>1. 设置硬件断点</h4><p>设置JTAG的比较器，让ADDR == xxx，当cpu发出xxx地址时停止。</p><h4 id="2-设置软件断点"><a href="#2-设置软件断点" class="headerlink" title="2.设置软件断点"></a>2.设置软件断点</h4><p>设置JTAG的比较器 DATA == B 并且修改xxx地址的内存的值为B，当CPU读入的值 == B时 停止。重新运行时回复xxx地址的原来值。</p><p>用硬件断点只能打两个断点，可调nor上的程序。<br>软件断点可以是无数个，前提是各个xxx地址可写，因此无法调试NOR 和 rom等无法像内存一样写的存储器上的程序。</p><h3 id="汇编级别-用openJTAG调试-逐条指令调试"><a href="#汇编级别-用openJTAG调试-逐条指令调试" class="headerlink" title="汇编级别 用openJTAG调试  逐条指令调试"></a>汇编级别 用openJTAG调试  逐条指令调试</h3><p>装好驱动，打开telnet功能，点击telnet，<br><img src="/images/20200527120658967.png"><br>结合汇编代码，难度大，要求高，</p><ol><li>先停止cpu <code>halt</code></li><li>再加载bin到内部ram的0地址 <code>load_image nand.bin 0</code></li><li><code>poll</code> 查看当前pc值 cpu执行的到哪里的</li><li><code>step 0</code> 使cpu从0地址开始执行一步 pc置0</li><li><code>step</code>  运行一条指令</li><li><code>resume 0</code>从头开始运行</li><li><code>reg</code> 查看寄存器值</li><li> <code>mdw 0x53000000</code>  读取某个地址的值</li><li><code>mww 0x30000000 0x12344567</code> 将值写入地址<br><img src="/images/20200527154653658.png"><h3 id="源码级别-用openJTAG调试"><a href="#源码级别-用openJTAG调试" class="headerlink" title="源码级别 用openJTAG调试"></a>源码级别 用openJTAG调试</h3>==重定位之前的代码不能用源码级别的调试，只能用汇编级别的调试，逐条指令调试。==<br>有工具 arm-linux-gdb，win下arm-elf-gdb，但都是用的命令行，这些工具依赖<br>有eclipse软件，图形界面，但是也是依赖arm-elf-gdb，所以需要先<a href="https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm/downloads">安装gcc-arm-none-eabi-xxxx-major-win32.exe</a>。<h4 id="源码级别调试，有前提"><a href="#源码级别调试，有前提" class="headerlink" title="源码级别调试，有前提"></a>源码级别调试，有前提</h4></li><li>源码已经重定位好，处于对应的连接地址。在源文件某处A设置断点，底层的情况，JTAG会根据断点A所在内存地址的位置去修改内存（软断点）。<ul><li>若程序链接地址是SDRAM，用openocd初始化SDRAM</li><li>用openocd下载代码到SDRAM</li></ul></li><li>链接脚本lds对代码的分段必须是固定形式，.text .data(.rodata .data) .bss</li><li>被调试的程序为elf格式，里有“调试信息” 编译时加-g<h5 id="命令行源码级别调试"><a href="#命令行源码级别调试" class="headerlink" title="命令行源码级别调试"></a>命令行源码级别调试</h5></li></ol><ul><li>先用openocd初始化内存，借助init.bin，（<code>halt---load_image init/init.bin</code>）</li><li>再用gnu-gcc-arm工具连接openocd，(<code>arm-xxx nand_elf---target remote 127.0.0.1:3333</code>)</li><li>再下载elf文件，(<code>load</code>  )</li><li>执行一条指令<code>si</code></li><li>设置断点 <code>break main.c:21</code> 文件的21行</li><li>继续运行到断点处，<code>c</code>  （continue）</li><li>列出当前处源代码，<code>l</code> (list)<br><img src="/images/20200528095608305.png"><br><img src="/images/20200528100649746.png"><h5 id="eclipse-GUI源码级别调试"><a href="#eclipse-GUI源码级别调试" class="headerlink" title="eclipse GUI源码级别调试"></a>eclipse GUI源码级别调试</h5>也必须先设置内存，初始化内存。。。。<br>新建新工程<br>虫子 调试配置<br>新建调试文件，选择文件<br>commands窗口填写：<br>&emsp;<code>target remote 127.0.0.1:3333</code><br>&emsp;<code>load</code><br>&emsp;<code>break _start</code><br>&emsp;<code>c</code></li></ul>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第27课 1 2 3  DMA 数据搬运工作 源 目的 长度 搬运完成产生DMA中断</title>
      <link href="2021/05/14/wds2-qi-di-27-ke-1-2-3-dma-shu-ju-ban-yun-gong-zuo-yuan-mu-de-chang-du-ban-yun-wan-cheng-chan-sheng-dma-zhong-duan-local/"/>
      <url>2021/05/14/wds2-qi-di-27-ke-1-2-3-dma-shu-ju-ban-yun-gong-zuo-yuan-mu-de-chang-du-ban-yun-wan-cheng-chan-sheng-dma-zhong-duan-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]<br>DMA(Direct Memory Access，直接存储器访问)<br>cpu命令DMA控制器，搬运工作由DMA控制器完成。<br>地址设置，拷贝完地址自增、自减、不动。<br>手动启动和外部启动。<br>如mic采集到数据存入自己的i2s中buff，满了之后产生DMA请求，DMA根据源地址 目的地址 长度 拷贝数据，考完之后产生中断。</p><p>支持4种搬运：</p><ol><li>src dst都在bus上，从内存的一个地方搬运到内存的另一个地方</li><li>src dst一个在外设一个在bus</li><li>src dst一个在外设一个在bus</li><li>src dst都在外设<br><img src="/images/20200526110947507.png"><h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><h2 id="驱动"><a href="#驱动" class="headerlink" title="驱动"></a>驱动</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span>     <span class="token comment">// module_init module_exit</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span>   <span class="token comment">// MODULE_LICENSE</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span>       <span class="token comment">// file_operations</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h></span>     <span class="token comment">// cdev</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h></span>   <span class="token comment">// class_device</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/uaccess.h></span>    <span class="token comment">// copy_from_user copy_to_user</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h></span>         <span class="token comment">// ioremap  iounmap</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/irq.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/delay.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/regs-gpio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/hardware.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/poll.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/dma-mapping.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/interrupt.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MEM_CPY_NO_DMA</span>  <span class="token expression"><span class="token number">0</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MEM_CPY_DMA</span>     <span class="token expression"><span class="token number">1</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUF_SIZE</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token number">512</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span> </span><span class="token comment">// 512KByte</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DMA_BASE_ADDR0</span>  <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x4B000000</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DMA_BASE_ADDR1</span>  <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x4B000040</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DMA_BASE_ADDR2</span>  <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x4B000080</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DMA_BASE_ADDR3</span>  <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x4B0000C0</span><span class="token punctuation">)</span></span></span><span class="token keyword">static</span> <span class="token keyword">char</span><span class="token operator">*</span> src<span class="token punctuation">;</span><span class="token keyword">static</span> u32 src_phys<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">char</span><span class="token operator">*</span> dst<span class="token punctuation">;</span><span class="token keyword">static</span> u32 dst_phys<span class="token punctuation">;</span><span class="token comment">// 1 确定主设备号</span><span class="token keyword">static</span> <span class="token keyword">int</span> major<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">class</span><span class="token operator">*</span> cls<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dma_regs</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> disrc<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> disrcc<span class="token punctuation">;</span>     <span class="token keyword">unsigned</span> <span class="token keyword">long</span> didst<span class="token punctuation">;</span>     <span class="token keyword">unsigned</span> <span class="token keyword">long</span> didstc<span class="token punctuation">;</span>     <span class="token keyword">unsigned</span> <span class="token keyword">long</span> dcon<span class="token punctuation">;</span>     <span class="token keyword">unsigned</span> <span class="token keyword">long</span> dstat<span class="token punctuation">;</span>     <span class="token keyword">unsigned</span> <span class="token keyword">long</span> dcsrc<span class="token punctuation">;</span>     <span class="token keyword">unsigned</span> <span class="token keyword">long</span> dcdst<span class="token punctuation">;</span>     <span class="token keyword">unsigned</span> <span class="token keyword">long</span> dmasktrig<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">struct</span> <span class="token class-name">dma_regs</span> <span class="token operator">*</span>dmaregs<span class="token punctuation">;</span><span class="token comment">// 定义休眠等待才队列</span><span class="token keyword">static</span> <span class="token function">DECLARE_WAIT_QUEUE_HEAD</span><span class="token punctuation">(</span>dma_waitq<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 标志，在中断中置1， 在ioctl中清0</span><span class="token keyword">static</span> <span class="token keyword">int</span> ev_dma <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">s3c_dma_ioctl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 2 构造file_operations </span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> dma_fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>    <span class="token punctuation">.</span>ioctl <span class="token operator">=</span> s3c_dma_ioctl<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">s3c_dma_ioctl</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> i<span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> <span class="token number">0xAA</span><span class="token punctuation">,</span> BUF_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> <span class="token number">0x55</span><span class="token punctuation">,</span> BUF_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">case</span> MEM_CPY_NO_DMA<span class="token operator">:</span>        <span class="token punctuation">&#123;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>BUF_SIZE<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>                dst<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> src<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">memcmp</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> src<span class="token punctuation">,</span> BUF_SIZE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">// 比较以下数据是否都相等</span>                <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"MEM_CPY_NO_DMA ok.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">else</span>                <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"MEM_CPY_NO_DMA error.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">case</span> MEM_CPY_DMA<span class="token operator">:</span>        <span class="token punctuation">&#123;</span>            ev_dma <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            dmaregs<span class="token operator">-></span>disrc  <span class="token operator">=</span> src_phys<span class="token punctuation">;</span>                 <span class="token comment">// 源物理地址</span>            dmaregs<span class="token operator">-></span>disrcc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// 源位于AHB总线，源地址递增</span>            dmaregs<span class="token operator">-></span>didst  <span class="token operator">=</span> dst_phys<span class="token punctuation">;</span>                 <span class="token comment">// 目的物理地址</span>            dmaregs<span class="token operator">-></span>didstc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 目的位于AHB总线，目的地址递增</span>            dmaregs<span class="token operator">-></span>dcon   <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">29</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">28</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">27</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">23</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>BUF_SIZE<span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 使能中断，单个传输，软件触发</span>            <span class="token comment">// 启动DMA</span>            dmaregs<span class="token operator">-></span>dmasktrig <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 休眠，传输完成后在irq函数里被唤醒，如果ev_dma为0则休眠</span>            <span class="token function">wait_event_interruptible</span><span class="token punctuation">(</span>dma_waitq<span class="token punctuation">,</span> ev_dma<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">memcmp</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> src<span class="token punctuation">,</span> BUF_SIZE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 比较以下数据是否都相等</span>                <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"MEM_CPY_DMA ok.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">else</span>                <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"MEM_CPY_DMA error.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token class-name">irqreturn_t</span> <span class="token function">dma_irq</span><span class="token punctuation">(</span><span class="token keyword">int</span> irq<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>devid<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 唤醒</span>    ev_dma <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token function">wake_up_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dma_waitq<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> IRQ_HANDLED<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">s3c_dma_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 注册中断，DMA传输完成产生中断</span>    <span class="token comment">//  0～2已经被使用了，用3</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">request_irq</span><span class="token punctuation">(</span>IRQ_DMA3<span class="token punctuation">,</span> dma_irq<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"s3c_dma"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"can't request_irq for DMA3.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 申请较大连续空间，不能用kmalloc和vmalloc</span>    src <span class="token operator">=</span> <span class="token function">dma_alloc_writecombine</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> BUF_SIZE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>src_phys<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> src<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"can't alloc src buffer for 'src'.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    dst <span class="token operator">=</span> <span class="token function">dma_alloc_writecombine</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> BUF_SIZE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dst_phys<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> dst<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">dma_free_writecombine</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> BUF_SIZE<span class="token punctuation">,</span> src<span class="token punctuation">,</span> src_phys<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"can't alloc src buffer for 'dst'.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>      major <span class="token operator">=</span> <span class="token function">register_chrdev</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"s3c_dma"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>dma_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>    cls <span class="token operator">=</span> <span class="token function">class_create</span><span class="token punctuation">(</span>THIS_MODULE<span class="token punctuation">,</span> <span class="token string">"s3c_dma"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">class_device_create</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"s3c_dma"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    dmaregs <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>DMA_BASE_ADDR3<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dma_regs</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">s3c_dma_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">iounmap</span><span class="token punctuation">(</span>dmaregs<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">class_device_destroy</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">class_destroy</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">unregister_chrdev</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> <span class="token string">"s3c_dma"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">dma_free_writecombine</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> BUF_SIZE<span class="token punctuation">,</span> src<span class="token punctuation">,</span> src_phys<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">dma_free_writecombine</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> BUF_SIZE<span class="token punctuation">,</span> dst<span class="token punctuation">,</span> dst_phys<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free_irq</span><span class="token punctuation">(</span>IRQ_DMA3<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>s3c_dma_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>s3c_dma_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="用户"><a href="#用户" class="headerlink" title="用户"></a>用户</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MEM_CPY_NO_DMA</span>  <span class="token expression"><span class="token number">0</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MEM_CPY_DMA</span>     <span class="token expression"><span class="token number">1</span></span></span><span class="token keyword">void</span> <span class="token function">print_usage</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Usage:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s &lt;nodma | dma>\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span><span class="token number">2</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">print_usage</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>            <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/s3c_dma"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"can't open /dev/s3c_dma.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"nodma"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> MEM_CPY_DMA<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"dma"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> MEM_CPY_NO_DMA<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span>     <span class="token punctuation">&#123;</span>        <span class="token function">print_usage</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1>可以看到dma中断，<br>使用dma拷贝数据，执行用户程序时还可以执行系统命令如ls，<br>而不使用dma时，数据宝贝占用了cpu，很难执行ls命令。<br><img src="/images/20200526142654185.png"><br><img src="/images/20200526143041134.png"></li></ol>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第24课 2 IIC Linux下驱动程序 i2c_driver结构体里有attach_adapter  用i2c总线驱动程序的i2c_transfer函数收发数据</title>
      <link href="2021/05/14/wds2-qi-di-24-ke-2-iic-linux-xia-qu-dong-cheng-xu-i2c-driver-jie-gou-ti-li-you-attach-adapter-yong-i2c-zong-xian-qu-dong-cheng-xu-de-i2c-transfer-han-shu-shou-fa-shu-ju-local/"/>
      <url>2021/05/14/wds2-qi-di-24-ke-2-iic-linux-xia-qu-dong-cheng-xu-i2c-driver-jie-gou-ti-li-you-attach-adapter-yong-i2c-zong-xian-qu-dong-cheng-xu-de-i2c-transfer-han-shu-shou-fa-shu-ju-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]<br>参考<code>drivers\i2c\busses\i2c-s3c2410.c</code>，<br><code>drivers\i2c\chips\eeprom.c</code>，<br><code>drivers\i2c\chips\ds1374.c</code>。</p><p>如何写i2c设备驱动程序</p><ol><li>分配一个i2c_driver结构体</li><li>设置<br> <code>attach_adapter</code> 直接调用i2c_probe(adap, 设备地址，发现这个设备后要调用的函数)；<br> <code>detach_client</code> 卸载这个驱动后，如果之前发能够支持的设备，则调用它来清理；</li><li>注册 <code>i2c_add_driver</code></li></ol><p><img src="/images/20200523185421610.png"></p><h1 id="程序1-检测设备-调用那个function"><a href="#程序1-检测设备-调用那个function" class="headerlink" title="程序1 检测设备 调用那个function"></a>程序1 检测设备 调用那个function</h1><h2 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/jiffies.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/i2c.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mutex.h></span></span><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> ignore<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> I2C_CLIENT_END <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> normal_addr<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">0x50</span><span class="token punctuation">,</span> I2C_CLIENT_END <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 地址只包含前7位 0x50，设备地址1010 0000</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">i2c_client_address_data</span> addr_data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span>normal_i2c <span class="token operator">=</span> normal_addr<span class="token punctuation">,</span> <span class="token comment">// 要发出S信号和设备地址并得到ACK才能确定设备存在 才会function</span>    <span class="token punctuation">.</span>probe      <span class="token operator">=</span> ignore<span class="token punctuation">,</span>    <span class="token punctuation">.</span>ignore     <span class="token operator">=</span> ignore<span class="token punctuation">,</span>    <span class="token comment">// .forces // 强制认为这个设备存在</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 那个function</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">at24cxx_detect</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_adapter</span> <span class="token operator">*</span>adapter<span class="token punctuation">,</span> <span class="token keyword">int</span> address<span class="token punctuation">,</span> <span class="token keyword">int</span> kind<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"at24cxx_detect\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">at24cxx_attach</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_adapter</span> <span class="token operator">*</span>adapter<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">i2c_probe</span><span class="token punctuation">(</span>adapter<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr_data<span class="token punctuation">,</span> at24cxx_detect<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">at24cxx_detach</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_client</span> <span class="token operator">*</span>client<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"at24cxx_detach\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">i2c_driver</span> at24cxx_driver <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>name<span class="token operator">=</span> <span class="token string">"at24cxx"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">.</span>attach_adapter <span class="token operator">=</span> at24cxx_attach<span class="token punctuation">,</span><span class="token punctuation">.</span>detach_client  <span class="token operator">=</span> at24cxx_detach<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">at24xxx_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 1. 分配一个i2c_driver结构体，这里直接前面定义这个结构体</span>    <span class="token function">i2c_add_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>at24cxx_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 设置</span>    <span class="token comment">// attach_adapter直接调用i2c_probe(adap, 设备地址，发现这个设备后要调用的函数)；</span>    <span class="token comment">// detach_client卸载这个驱动后，如果之前发能够支持的设备，则调用它来清理；</span>    <span class="token comment">// 3.注册 i2c_add_driver  </span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">at24xxx_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">i2c_del_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>at24cxx_driver<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>at24xxx_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>at24xxx_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="实验1-插入模块查看能否检查设备"><a href="#实验1-插入模块查看能否检查设备" class="headerlink" title="实验1 插入模块查看能否检查设备"></a>实验1 插入模块查看能否检查设备</h2><p><img src="/images/20200523153040189.png"></p><h1 id="程序2-force强制执行function-不发出地址不接收ACK"><a href="#程序2-force强制执行function-不发出地址不接收ACK" class="headerlink" title="程序2 force强制执行function 不发出地址不接收ACK"></a>程序2 force强制执行function 不发出地址不接收ACK</h1><p>一般不用，强制认为该设备存在，调用function</p><h2 id="代码2"><a href="#代码2" class="headerlink" title="代码2"></a>代码2</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/jiffies.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/i2c.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mutex.h></span></span><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> ignore<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> I2C_CLIENT_END <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// static unsigned short normal_addr[] = &#123; 0x50, I2C_CLIENT_END &#125;; // 地址只包含前7位 0x50，设备地址1010 0000</span><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> force_addr<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> ANY_I2C_BUS<span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> I2C_CLIENT_END <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 板子上i2c设备不是这个地址</span><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token operator">*</span> forces<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> force_addr<span class="token punctuation">,</span> <span class="token constant">NULL</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">i2c_client_address_data</span> addr_data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span>normal_i2c <span class="token operator">=</span> ignore<span class="token punctuation">,</span> <span class="token comment">// 一般要发出S信号和设备地址并得到ACK才能确定设备存在 才会function，这里设备不存在也会强制执行function</span>    <span class="token punctuation">.</span>probe      <span class="token operator">=</span> ignore<span class="token punctuation">,</span>    <span class="token punctuation">.</span>ignore     <span class="token operator">=</span> ignore<span class="token punctuation">,</span>    <span class="token punctuation">.</span>forces     <span class="token operator">=</span> forces<span class="token punctuation">,</span> <span class="token comment">// 强制认为这个设备存在 当前不能用但是以后会用到 还是希望调用那个function</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 那个function</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">at24cxx_detect</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_adapter</span> <span class="token operator">*</span>adapter<span class="token punctuation">,</span> <span class="token keyword">int</span> address<span class="token punctuation">,</span> <span class="token keyword">int</span> kind<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"at24cxx_detect\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">at24cxx_attach</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_adapter</span> <span class="token operator">*</span>adapter<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">i2c_probe</span><span class="token punctuation">(</span>adapter<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr_data<span class="token punctuation">,</span> at24cxx_detect<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">at24cxx_detach</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_client</span> <span class="token operator">*</span>client<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"at24cxx_detach\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">i2c_driver</span> at24cxx_driver <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>name<span class="token operator">=</span> <span class="token string">"at24cxx"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">.</span>attach_adapter <span class="token operator">=</span> at24cxx_attach<span class="token punctuation">,</span><span class="token punctuation">.</span>detach_client  <span class="token operator">=</span> at24cxx_detach<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">at24xxx_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 1. 分配一个i2c_driver结构体，这里直接前面定义这个结构体</span>    <span class="token function">i2c_add_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>at24cxx_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 设置</span>    <span class="token comment">// attach_adapter直接调用i2c_probe(adap, 设备地址，发现这个设备后要调用的函数)；</span>    <span class="token comment">// detach_client卸载这个驱动后，如果之前发能够支持的设备，则调用它来清理；</span>    <span class="token comment">// 3.注册 i2c_add_driver  </span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">at24xxx_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">i2c_del_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>at24cxx_driver<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>at24xxx_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>at24xxx_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="测试2"><a href="#测试2" class="headerlink" title="测试2"></a>测试2</h2><p><img src="/images/20200523164359248.png"></p><h1 id="程序3-rmmod卸载的时候调用detach-client"><a href="#程序3-rmmod卸载的时候调用detach-client" class="headerlink" title="程序3 rmmod卸载的时候调用detach_client"></a>程序3 rmmod卸载的时候调用detach_client</h1><h2 id="代码3"><a href="#代码3" class="headerlink" title="代码3"></a>代码3</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/jiffies.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/i2c.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mutex.h></span></span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">i2c_driver</span> at24cxx_driver<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> ignore<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> I2C_CLIENT_END <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> normal_addr<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">0x50</span><span class="token punctuation">,</span> I2C_CLIENT_END <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 地址只包含前7位 0x50，设备地址1010 0000</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">i2c_client_address_data</span> addr_data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span>normal_i2c <span class="token operator">=</span> normal_addr<span class="token punctuation">,</span> <span class="token comment">// 要发出S信号和设备地址并得到ACK才能确定设备存在 </span>    <span class="token punctuation">.</span>probe      <span class="token operator">=</span> ignore<span class="token punctuation">,</span>    <span class="token punctuation">.</span>ignore     <span class="token operator">=</span> ignore<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 那个function</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">at24cxx_detect</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_adapter</span> <span class="token operator">*</span>adapter<span class="token punctuation">,</span> <span class="token keyword">int</span> address<span class="token punctuation">,</span> <span class="token keyword">int</span> kind<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">i2c_client</span> <span class="token operator">*</span>client<span class="token punctuation">;</span>    <span class="token comment">// 构造i2c_client adapter指向左边，driver指向右边，地址就是发现的那个设备地址</span>    <span class="token comment">//  收发数据就可以用i2c_client完成</span>client <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_client</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>    client<span class="token operator">-></span>addr    <span class="token operator">=</span> address<span class="token punctuation">;</span>client<span class="token operator">-></span>adapter <span class="token operator">=</span> adapter<span class="token punctuation">;</span>client<span class="token operator">-></span>driver  <span class="token operator">=</span> <span class="token operator">&amp;</span>at24cxx_driver<span class="token punctuation">;</span>    <span class="token function">strlcpy</span><span class="token punctuation">(</span>client<span class="token operator">-></span>name<span class="token punctuation">,</span> <span class="token string">"at24cxx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">i2c_attach_client</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"at24cxx_detect\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">at24cxx_attach</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_adapter</span> <span class="token operator">*</span>adapter<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">i2c_probe</span><span class="token punctuation">(</span>adapter<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr_data<span class="token punctuation">,</span> at24cxx_detect<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">at24cxx_detach</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_client</span> <span class="token operator">*</span>client<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"at24cxx_detach\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">i2c_detach_client</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 对应i2c_attach_client</span>    <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token function">i2c_get_clientdata</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">i2c_driver</span> at24cxx_driver <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>name<span class="token operator">=</span> <span class="token string">"at24cxx"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">.</span>attach_adapter <span class="token operator">=</span> at24cxx_attach<span class="token punctuation">,</span><span class="token punctuation">.</span>detach_client  <span class="token operator">=</span> at24cxx_detach<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">at24xxx_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 1. 分配一个i2c_driver结构体，这里直接前面定义这个结构体</span>    <span class="token function">i2c_add_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>at24cxx_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 设置</span>    <span class="token comment">// attach_adapter直接调用i2c_probe(adap, 设备地址，发现这个设备后要调用的函数)；</span>    <span class="token comment">// detach_client卸载这个驱动后，如果之前发能够支持的设备，则调用它来清理；</span>    <span class="token comment">// 3.注册 i2c_add_driver  </span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">at24xxx_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">i2c_del_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>at24cxx_driver<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>at24xxx_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>at24xxx_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="测试3"><a href="#测试3" class="headerlink" title="测试3"></a>测试3</h2><p><img src="/images/20200523172642955.png"></p><h1 id="程序4-在function里加入字符设备"><a href="#程序4-在function里加入字符设备" class="headerlink" title="程序4 在function里加入字符设备"></a>程序4 在function里加入字符设备</h1><p>既然在function可以为所欲为，那就搞个字符设备，只是看下能否打开字符设备和I2C， read和write没写</p><h2 id="代码4"><a href="#代码4" class="headerlink" title="代码4"></a>代码4</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/jiffies.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/i2c.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mutex.h></span></span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">i2c_driver</span> at24cxx_driver<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> ignore<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> I2C_CLIENT_END <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> normal_addr<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">0x50</span><span class="token punctuation">,</span> I2C_CLIENT_END <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 地址只包含前7位 0x50，设备地址1010 0000</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">i2c_client_address_data</span> addr_data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span>normal_i2c <span class="token operator">=</span> normal_addr<span class="token punctuation">,</span> <span class="token comment">// 要发出S信号和设备地址并得到ACK才能确定设备存在 </span>    <span class="token punctuation">.</span>probe      <span class="token operator">=</span> ignore<span class="token punctuation">,</span>    <span class="token punctuation">.</span>ignore     <span class="token operator">=</span> ignore<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 那个function</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">at24cxx_detect</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_adapter</span> <span class="token operator">*</span>adapter<span class="token punctuation">,</span> <span class="token keyword">int</span> address<span class="token punctuation">,</span> <span class="token keyword">int</span> kind<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">i2c_client</span> <span class="token operator">*</span>client<span class="token punctuation">;</span>    <span class="token comment">// 构造i2c_client adapter指向左边，driver指向右边，地址就是发现的那个设备地址</span>    <span class="token comment">//  收发数据就可以用i2c_client完成</span>client <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_client</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>    client<span class="token operator">-></span>addr    <span class="token operator">=</span> address<span class="token punctuation">;</span>client<span class="token operator">-></span>adapter <span class="token operator">=</span> adapter<span class="token punctuation">;</span>client<span class="token operator">-></span>driver  <span class="token operator">=</span> <span class="token operator">&amp;</span>at24cxx_driver<span class="token punctuation">;</span>    <span class="token function">strlcpy</span><span class="token punctuation">(</span>client<span class="token operator">-></span>name<span class="token punctuation">,</span> <span class="token string">"at24cxx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">i2c_attach_client</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"at24cxx_detect\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">at24cxx_attach</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_adapter</span> <span class="token operator">*</span>adapter<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">i2c_probe</span><span class="token punctuation">(</span>adapter<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr_data<span class="token punctuation">,</span> at24cxx_detect<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">at24cxx_detach</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_client</span> <span class="token operator">*</span>client<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"at24cxx_detach\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">i2c_detach_client</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 对应i2c_attach_client</span>    <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token function">i2c_get_clientdata</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">i2c_driver</span> at24cxx_driver <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>name<span class="token operator">=</span> <span class="token string">"at24cxx"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">.</span>attach_adapter <span class="token operator">=</span> at24cxx_attach<span class="token punctuation">,</span><span class="token punctuation">.</span>detach_client  <span class="token operator">=</span> at24cxx_detach<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">at24xxx_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 1. 分配一个i2c_driver结构体，这里直接前面定义这个结构体</span>    <span class="token function">i2c_add_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>at24cxx_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 设置</span>    <span class="token comment">// attach_adapter直接调用i2c_probe(adap, 设备地址，发现这个设备后要调用的函数)；</span>    <span class="token comment">// detach_client卸载这个驱动后，如果之前发能够支持的设备，则调用它来清理；</span>    <span class="token comment">// 3.注册 i2c_add_driver  </span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">at24xxx_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">i2c_del_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>at24cxx_driver<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>at24xxx_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>at24xxx_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="实验4"><a href="#实验4" class="headerlink" title="实验4"></a>实验4</h2><p><img src="/images/20200523172937996.png"></p><h1 id="程序5-user用字符设备完成对I2C设备的读写字节"><a href="#程序5-user用字符设备完成对I2C设备的读写字节" class="headerlink" title="程序5 user用字符设备完成对I2C设备的读写字节"></a>程序5 user用字符设备完成对I2C设备的读写字节</h1><p>既然在function可以为所欲为，那就搞个字符设备，</p><h2 id="代码5-驱动代码"><a href="#代码5-驱动代码" class="headerlink" title="代码5 驱动代码"></a>代码5 驱动代码</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/jiffies.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/i2c.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mutex.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/uaccess.h></span></span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">i2c_driver</span> at24cxx_driver<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">i2c_client</span> <span class="token operator">*</span>at24cxx_client<span class="token punctuation">;</span><span class="token comment">// 字符设备那一套</span><span class="token keyword">static</span> <span class="token keyword">int</span> major<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> at24cxx_fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>    <span class="token punctuation">.</span>read <span class="token operator">=</span> at24cxx_read<span class="token punctuation">,</span>    <span class="token punctuation">.</span>write <span class="token operator">=</span> at24cxx_write<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">class</span><span class="token operator">*</span> cls<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">at24cxx_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buff<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>offset<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 先写地址，再读数据</span>    <span class="token keyword">struct</span> <span class="token class-name">i2c_msg</span> msg<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> address<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> data<span class="token punctuation">;</span>    <span class="token comment">// buf[0] address</span>    <span class="token comment">// buf[1] data</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span>         <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>        <span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> buff<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 数据传输三要素</span>    <span class="token comment">// 读at24cxx时，先读的地址发出</span>    msg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>addr     <span class="token operator">=</span> at24cxx_client<span class="token operator">-></span>addr<span class="token punctuation">;</span> <span class="token comment">// 目的 </span>    msg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>buf      <span class="token operator">=</span> <span class="token operator">&amp;</span>address<span class="token punctuation">;</span>             <span class="token comment">// 源</span>    msg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>len      <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                    <span class="token comment">// 地址=1 Byte</span>    msg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>flags    <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                    <span class="token comment">// 写</span>    <span class="token comment">// 然后启动读操作</span>    msg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>addr     <span class="token operator">=</span> at24cxx_client<span class="token operator">-></span>addr<span class="token punctuation">;</span> <span class="token comment">// 源 </span>    msg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>buf      <span class="token operator">=</span> <span class="token operator">&amp;</span>data<span class="token punctuation">;</span>                <span class="token comment">// 目的</span>    msg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>len      <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                    <span class="token comment">// 数据=1 Byte</span>    msg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>flags    <span class="token operator">=</span> I2C_M_RD<span class="token punctuation">;</span>             <span class="token comment">// 读</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">i2c_transfer</span><span class="token punctuation">(</span>at24cxx_client<span class="token operator">-></span>adapter<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 成功</span>        <span class="token function">copy_to_user</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 表示读到1 Byte</span>    <span class="token keyword">else</span>        <span class="token keyword">return</span> <span class="token operator">-</span>EIO<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">at24cxx_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buff<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>offset<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">i2c_msg</span> msg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> val<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">// buf[0] address</span>    <span class="token comment">// buf[1] data</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span>         <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>        <span class="token function">copy_from_user</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> buff<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 传输</span>    <span class="token comment">// 数据传输三要素</span>    msg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>addr     <span class="token operator">=</span> at24cxx_client<span class="token operator">-></span>addr<span class="token punctuation">;</span> <span class="token comment">// 目的 </span>    msg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>buf      <span class="token operator">=</span> val<span class="token punctuation">;</span>                  <span class="token comment">// 源</span>    msg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>len      <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                    <span class="token comment">// 地址+数据=2 Byte</span>    msg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>flags    <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                    <span class="token comment">// 写</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">i2c_transfer</span><span class="token punctuation">(</span>at24cxx_client<span class="token operator">-></span>adapter<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 成功</span>        <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 表示写入了2 Byte</span>    <span class="token keyword">else</span>        <span class="token keyword">return</span> <span class="token operator">-</span>EIO<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> ignore<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> I2C_CLIENT_END <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> normal_addr<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">0x50</span><span class="token punctuation">,</span> I2C_CLIENT_END <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 地址只包含前7位 0x50，设备地址1010 0000</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">i2c_client_address_data</span> addr_data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span>normal_i2c <span class="token operator">=</span> normal_addr<span class="token punctuation">,</span> <span class="token comment">// 要发出S信号和设备地址并得到ACK才能确定设备存在 </span>    <span class="token punctuation">.</span>probe      <span class="token operator">=</span> ignore<span class="token punctuation">,</span>    <span class="token punctuation">.</span>ignore     <span class="token operator">=</span> ignore<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 那个function</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">at24cxx_detect</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_adapter</span> <span class="token operator">*</span>adapter<span class="token punctuation">,</span> <span class="token keyword">int</span> address<span class="token punctuation">,</span> <span class="token keyword">int</span> kind<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 构造i2c_client adapter指向左边，driver指向右边，地址就是发现的那个设备地址</span>    <span class="token comment">//  收发数据就可以用i2c_client完成</span>at24cxx_client <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_client</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>    at24cxx_client<span class="token operator">-></span>addr    <span class="token operator">=</span> address<span class="token punctuation">;</span>at24cxx_client<span class="token operator">-></span>adapter <span class="token operator">=</span> adapter<span class="token punctuation">;</span>at24cxx_client<span class="token operator">-></span>driver  <span class="token operator">=</span> <span class="token operator">&amp;</span>at24cxx_driver<span class="token punctuation">;</span>    <span class="token function">strlcpy</span><span class="token punctuation">(</span>at24cxx_client<span class="token operator">-></span>name<span class="token punctuation">,</span> <span class="token string">"at24cxx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">i2c_attach_client</span><span class="token punctuation">(</span>at24cxx_client<span class="token punctuation">)</span><span class="token punctuation">;</span>    major <span class="token operator">=</span> <span class="token function">register_chrdev</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"at24cxx"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>at24cxx_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>    cls <span class="token operator">=</span> <span class="token function">class_creat</span><span class="token punctuation">(</span>THIS_MODULE<span class="token punctuation">,</span> <span class="token string">"at24cxx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">class_device_create</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"at24cxx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// /dev/at24cxx</span>        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"at24cxx_detect\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">at24cxx_attach</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_adapter</span> <span class="token operator">*</span>adapter<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">i2c_probe</span><span class="token punctuation">(</span>adapter<span class="token punctuation">,</span> <span class="token operator">&amp;</span>addr_data<span class="token punctuation">,</span> at24cxx_detect<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">at24cxx_detach</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_client</span> <span class="token operator">*</span>client<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"at24cxx_detach\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">class_device_destroy</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">class_destory</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">unregister_chrdev</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> <span class="token string">"at24cxx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">i2c_detach_client</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">kfree</span><span class="token punctuation">(</span><span class="token function">i2c_get_clientdata</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">i2c_driver</span> at24cxx_driver <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>name<span class="token operator">=</span> <span class="token string">"at24cxx"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">.</span>attach_adapter <span class="token operator">=</span> at24cxx_attach<span class="token punctuation">,</span><span class="token punctuation">.</span>detach_client  <span class="token operator">=</span> at24cxx_detach<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">at24xxx_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 1. 分配一个i2c_driver结构体，这里直接前面定义这个结构体</span>    <span class="token function">i2c_add_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>at24cxx_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 设置</span>    <span class="token comment">// attach_adapter直接调用i2c_probe(adap, 设备地址，发现这个设备后要调用的函数)；</span>    <span class="token comment">// detach_client卸载这个驱动后，如果之前发能够支持的设备，则调用它来清理；</span>    <span class="token comment">// 3.注册 i2c_add_driver  </span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">at24xxx_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">i2c_del_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>at24cxx_driver<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>at24xxx_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>at24xxx_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="代码5-user代码"><a href="#代码5-user代码" class="headerlink" title="代码5 user代码"></a>代码5 user代码</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/stat.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;fcntl.h></span> </span><span class="token comment">// i2c_test r addr</span><span class="token comment">// i2c_test w addr val</span><span class="token keyword">void</span> <span class="token function">print_usage</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>file<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s r addr\n"</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s w addr val\n"</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">print_usage</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/at24cxx"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"can't open /dev/at24cxx\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> buff<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">// 读写操作</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        buff<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">strtoul</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 把字符转化成数字</span>        <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buff<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"read data: %c, %d, 0x%2x\n"</span><span class="token punctuation">,</span> buff<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buff<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> buff<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        buff<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">strtoul</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        buff<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">strtoul</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buff<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token function">print_usage</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="实验5"><a href="#实验5" class="headerlink" title="实验5"></a>实验5</h2><p>user用字符设备完成对I2C设备的读写字节，用户代码打开字符设备，<br><img src="/images/20200523183259524.png"></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第24课 1 IIC 驱动框架 adapter和drv 最终drv的attach_adapter的i2c_probe中adapter.master_xfer确定设备然后function</title>
      <link href="2021/05/14/wds2-qi-di-24-ke-1-iic-qu-dong-kuang-jia-adapter-he-drv-zui-zhong-drv-de-attach-adapter-de-i2c-probe-zhong-adapter.master-xfer-que-ding-she-bei-ran-hou-function-local/"/>
      <url>2021/05/14/wds2-qi-di-24-ke-1-iic-qu-dong-kuang-jia-adapter-he-drv-zui-zhong-drv-de-attach-adapter-de-i2c-probe-zhong-adapter.master-xfer-que-ding-she-bei-ran-hou-function-local/</url>
      
        <content type="html"><![CDATA[<pre class="line-numbers language-c" data-language="c"><code class="language-c">APP： open read write<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>drv_open drv_read drv_writeIIC设备驱动，知道数据含义 drivers\i2c\chip<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>I2C总线驱动程序： <span class="token number">1</span>识别 <span class="token number">2</span>提供读写函数，知道怎么收发数据 drivers\i2c\busses（一般芯片厂家提供）<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>I2C硬件：AT24C02 AT24C08    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>参考<code>drivers\i2c\busses\i2c-s3c2410.c</code></p><p>注册i2c driver的时候，<br>会把drv放入右边链表，<br>然后在左边链表取出每个adapter，调用drv的<code>.attach_adapter</code>(里边直接调用i2c_probe)，<br>在<code>i2c_probe(adapter, &amp;addr_data, function)</code>[适配器 设备地址 函数]中，用adapter的函数<code>.master_xfer</code>发信号确定是否有该设备，<br>若有函数该设备则调用function，在function里为所欲为。</p><p>注册adapter的时候，<br>把adapter放入左边链表，<br>然后从右边链表取出每个drv调用它的<code>.attach_adapter</code>(里边直接调用i2c_probe)，<br>。。。跟上面一样了。</p><p>最终无论先注册adapter还是drv，都会两两调用对应的drv里的<code>.attach_adapter</code>函数，在<code>.attach_adapter</code>函数里调用<code>i2c_probe</code>函数传入adapter然后调用发送函数<code>.master_xfer</code>确定该设备是否存在，存在则调用function为所欲为。<br><img src="/images/20200522215152370.png"><br><img src="/images/2020052221511270.png"></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第23课 2 IIC 裸板程序</title>
      <link href="2021/05/14/wds2-qi-di-23-ke-2-iic-luo-ban-cheng-xu-local/"/>
      <url>2021/05/14/wds2-qi-di-23-ke-2-iic-luo-ban-cheng-xu-local/</url>
      
        <content type="html"><![CDATA[<p>程序假设从nand启动，<br>上电时nand前4k被自动复制到片内4K内存SRAM，从0地址开始执行，前4k中的copy2ram前面的代码必须是位置无关码，后面的按照程序员指定的连接地址执行。</p><h1 id="head-S"><a href="#head-S" class="headerlink" title="head.S"></a>head.S</h1><pre class="line-numbers language-c" data-language="c"><code class="language-c">@<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>@ File<span class="token operator">:</span> head<span class="token punctuation">.</span>S@ 功能<span class="token operator">:</span> 设置SDRAM，将程序复制到SDRAM，然后跳到SDRAM继续执行@<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>          @ <span class="token punctuation">.</span>text 部分是处理器开始执行代码的地方<span class="token punctuation">,</span>指定了后续编译出来的内容放在代码段【可执行】<span class="token punctuation">,</span>是arm<span class="token operator">-</span>gcc编译器的关键词。@ <span class="token punctuation">.</span>global关键字用来让一个符号对链接器可见，可以供其他链接对象模块使用<span class="token punctuation">;</span>告诉编译器后续跟的是一个全局可见的名字【可能是变量，也可以是函数名】@ linux寻找这个 _start 标签作为程序的默认进入点。<span class="token punctuation">.</span><span class="token keyword">extern</span>     main<span class="token punctuation">.</span>text <span class="token punctuation">.</span>global _start _start<span class="token operator">:</span>@<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>       @ 中断向量，本程序中，除Reset和HandleIRQ外，其它异常都没有使用@<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>           b   Reset@ <span class="token number">0x04</span><span class="token operator">:</span> 未定义指令中止模式的向量地址HandleUndef<span class="token operator">:</span>    b   HandleUndef  @ <span class="token number">0x08</span><span class="token operator">:</span> 管理模式的向量地址，通过SWI指令进入此模式HandleSWI<span class="token operator">:</span>    b   HandleSWI@ <span class="token number">0x0c</span><span class="token operator">:</span> 指令预取终止导致的异常的向量地址HandlePrefetchAbort<span class="token operator">:</span>    b   HandlePrefetchAbort@ <span class="token number">0x10</span><span class="token operator">:</span> 数据访问终止导致的异常的向量地址HandleDataAbort<span class="token operator">:</span>    b   HandleDataAbort@ <span class="token number">0x14</span><span class="token operator">:</span> 保留HandleNotUsed<span class="token operator">:</span>    b   HandleNotUsed@ <span class="token number">0x18</span><span class="token operator">:</span> 中断模式的向量地址    b   HandleIRQ@ <span class="token number">0x1c</span><span class="token operator">:</span> 快中断模式的向量地址HandleFIQ<span class="token operator">:</span>    b   HandleFIQReset<span class="token operator">:</span>                      ldr sp<span class="token punctuation">,</span> <span class="token operator">=</span><span class="token number">4096</span>           @ 设置栈指针，以下都是C函数，调用前需要设好栈  设置栈地址在<span class="token number">4</span>k RAM的最高处，sp<span class="token operator">=</span><span class="token number">4096</span><span class="token punctuation">;</span>    bl  disable_watch_dog   @ 关闭WATCHDOG，否则CPU会不断重启    bl  clock_init          @ 设置MPLL，改变FCLK、HCLK、PCLK    bl  memsetup            @ 设置存储控制器以使用SDRAM    bl  nand_init           @ 初始化NAND Flash    @ 传递参数：通过寄存器r0<span class="token operator">~</span>r3来向子函数传递参数，当参数个数多于<span class="token number">4</span>个时，使用栈来传递参数。 @           当子函数运行时，根据自身参数个数自动从R0<span class="token operator">~</span>R3或者栈中读取参数。 @ 返回值：子函数通过R0寄存器将返回值传递给父函数。存入R0，父函数读取R0获得返回值。                             @ 复制代码到SDRAM中    ldr r0<span class="token punctuation">,</span> <span class="token operator">=</span><span class="token number">0x30000000</span>     @ <span class="token number">1.</span> 目标地址 <span class="token operator">=</span> <span class="token number">0x30000000</span>，这是SDRAM的起始地址     mov r1<span class="token punctuation">,</span> #<span class="token number">0</span>              @ <span class="token number">2.</span> 源地址   <span class="token operator">=</span> <span class="token number">0</span>，从nand的<span class="token number">0</span>地址开始拷贝    ldr r2<span class="token punctuation">,</span> <span class="token operator">=</span>__bss_start    sub r2<span class="token punctuation">,</span> r2<span class="token punctuation">,</span> r0          @ <span class="token number">3.</span> 复制长度 r2 <span class="token operator">=</span> r2 <span class="token operator">-</span> <span class="token function">r0</span>  <span class="token punctuation">(</span>__bss_start <span class="token operator">-</span> <span class="token number">0x30000000</span><span class="token punctuation">)</span>     bl  CopyCode2SDRAM      @ 调用C函数CopyCode2SDRAM   copy2ram前面的代码必须是位置无关码        bl  clean_bss           @ 清除bss段，未初始化或初值为<span class="token number">0</span>的全局<span class="token operator">/</span>静态变量保存在bss段    msr cpsr_c<span class="token punctuation">,</span> #<span class="token number">0xd2</span>       @ 进入中断模式    ldr sp<span class="token punctuation">,</span> <span class="token operator">=</span><span class="token number">0x31000000</span>     @ 设置中断模式栈指针    msr cpsr_c<span class="token punctuation">,</span> #<span class="token number">0xdf</span>       @ 进入系统模式    ldr sp<span class="token punctuation">,</span> <span class="token operator">=</span><span class="token number">0x34000000</span>     @ 设置系统模式栈指针，    ldr lr<span class="token punctuation">,</span> <span class="token operator">=</span>ret_initirq    @ 设置返回地址        ldr pc<span class="token punctuation">,</span> <span class="token operator">=</span>init_irq       @ 调用中断初始化函数ret_initirq<span class="token operator">:</span>    msr cpsr_c<span class="token punctuation">,</span> #<span class="token number">0x5f</span>       @ 设置I<span class="token operator">-</span>bit<span class="token operator">=</span><span class="token number">0</span>，开IRQ中断    ldr lr<span class="token punctuation">,</span> <span class="token operator">=</span>halt_loop      @ 设置返回地址    ldr pc<span class="token punctuation">,</span> <span class="token operator">=</span>main           @ 调用main函数halt_loop<span class="token operator">:</span>    b   halt_loopHandleIRQ<span class="token operator">:</span>    sub lr<span class="token punctuation">,</span> lr<span class="token punctuation">,</span> #<span class="token number">4</span>                  @ 计算返回地址    stmdb   sp<span class="token operator">!</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span> r0<span class="token operator">-</span>r12<span class="token punctuation">,</span>lr <span class="token punctuation">&#125;</span>   @ 保存使用到的寄存器                                    @ 注意，此时的sp是中断模式的sp                                    @ 初始值是上面设置的<span class="token number">4096</span>        ldr lr<span class="token punctuation">,</span> <span class="token operator">=</span>int_return             @ 设置调用IRQ_Handle函数后的返回地址      ldr pc<span class="token punctuation">,</span> <span class="token operator">=</span>IRQ_Handle             @ 调用中断分发函数，在interrupt<span class="token punctuation">.</span>c中int_return<span class="token operator">:</span>    ldmia   sp<span class="token operator">!</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span> r0<span class="token operator">-</span>r12<span class="token punctuation">,</span>pc <span class="token punctuation">&#125;</span><span class="token operator">^</span>  @ 中断返回<span class="token punctuation">,</span> <span class="token operator">^</span>表示将spsr的值复制到cpsr<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="i2c-lds"><a href="#i2c-lds" class="headerlink" title="i2c.lds"></a>i2c.lds</h1><p>分为一个段。<br>所有可执行文件的代码段都放在.text，head init nand按序存放，<br>所有只读数据段，<br>所有数据段，<br>bss</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">SECTIONS <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span> <span class="token operator">=</span> <span class="token number">0x30000000</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span>text <span class="token operator">:</span> <span class="token punctuation">&#123;</span> head<span class="token punctuation">.</span><span class="token function">o</span><span class="token punctuation">(</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>              init<span class="token punctuation">.</span><span class="token function">o</span><span class="token punctuation">(</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>              nand<span class="token punctuation">.</span><span class="token function">o</span><span class="token punctuation">(</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>              <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>             <span class="token punctuation">&#125;</span>    <span class="token punctuation">.</span>rodata <span class="token function">ALIGN</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">.</span>rodata<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>     <span class="token punctuation">.</span>data   <span class="token function">ALIGN</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>    __bss_start <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">;</span>     <span class="token punctuation">.</span>bss <span class="token function">ALIGN</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>  <span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">.</span>bss<span class="token punctuation">)</span>  <span class="token operator">*</span><span class="token punctuation">(</span>COMMON<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>    __bss_end <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>片内内存的0地址开始执行，<br>但是链接地址是0x30000000，链接地址和程序当前所在的位置，必须是位置无关码写代码（不能有全局变量等。</p><p>反汇编查看从copy2rm那部分代码，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">                        @ 复制代码到SDRAM中ldr r0<span class="token punctuation">,</span> <span class="token operator">=</span><span class="token number">0x30000000</span>     @ <span class="token number">1.</span> 目标地址 <span class="token operator">=</span> <span class="token number">0x30000000</span>，这是SDRAM的起始地址mov r1<span class="token punctuation">,</span> #<span class="token number">0</span>              @ <span class="token number">2.</span> 源地址   <span class="token operator">=</span> <span class="token number">0</span>ldr r2<span class="token punctuation">,</span> <span class="token operator">=</span>__bss_startsub r2<span class="token punctuation">,</span> r2<span class="token punctuation">,</span> r0          @ <span class="token number">3.</span> 复制长度bl  CopyCode2SDRAM      @ 调用C函数CopyCode2SDRAM<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这行代码的地址是3000003c，因此当前pc=0x3000003c+0x8=0x30000044，<br>0x30000044+68=0x30000088，<br>在0x30000088处取值为0x30002af8，0x2af8=11000，二进制文件大小就是11000，这么多。<br><img src="/images/20200522181420756.png"></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第23课 1 IIC(Inter-Integrated Circuit) 简单介绍 起始停止ACK</title>
      <link href="2021/05/14/wds2-qi-di-23-ke-1-iic-inter-integrated-circuit-jian-dan-jie-shao-qi-shi-ting-zhi-ack-local/"/>
      <url>2021/05/14/wds2-qi-di-23-ke-1-iic-inter-integrated-circuit-jian-dan-jie-shao-qi-shi-ting-zhi-ack-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]</p><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://www.cnblogs.com/alantu2018/p/8994719.html">参考 面试总结，Linux中IIC驱动框架等</a></p><p><a href="https://blog.csdn.net/weixin_42229404/article/details/81514457">参考 程序代码，传输流程理解</a></p><h1 id="IIC-即Inter-Integrated-Circuit-集成电路总线）"><a href="#IIC-即Inter-Integrated-Circuit-集成电路总线）" class="headerlink" title="IIC 即Inter-Integrated Circuit(集成电路总线）"></a><code>IIC</code> 即<strong>Inter-Integrated Circuit</strong>(集成电路总线）</h1><ul><li><code>I2C</code>总线是<strong>PHLIPS</strong>公司推出的一种串行总线。</li><li><code>I2C</code>总线只有两根双向信号线。一根是 **<code>数据线SDA</code>**，另一根是 **<code>时钟线SCL</code>**。</li><li><strong>起始信号</strong>  SCL为高时，SDA由高变低；<strong>终止信号</strong>  SCL为高时，SDA由低变高；</li><li> SCL必须由主机发送</li><li>I2C总线进行数据传送时，SCL为高电平期间，SDA上的数据必须保持稳定，只有在SCL上的信号为低电平期间，SDA上的高电平或低电平状态才允许变化。</li><li>每传送一个字节数据后，都要有一个应答信号以确定数据传送是否被对方收到。应答信号由接受设备产生，在SCL为高电平期间，接受设备将SDA拉低为低电平，表示数据传输正确，产生应答（ACK）</li><li>首字节是 <strong>“片选信号”</strong>，即7位从机地址加1位方向(读写)控制。<br>其中高四位为器件类型识别符，接着三位为片选，最后一位为读写位。7位寻址地址减去1个<strong>广播地址0x00</strong>不用，所以有2<sup>7</sup>=128 - 1 = 127，所以理论上可以挂127个从器件。</li></ul><h1 id="6个通信信号"><a href="#6个通信信号" class="headerlink" title="6个通信信号"></a>6个通信信号</h1><p>平时没有使用的时候，SCL SDA都是高。</p><ol><li>起始信号  SCL为高时，SDA由高变低；</li><li>终止信号  SCL为高时，SDA由低变高；<br><img src="/images/20200516202423144.png"></li><li>写数据，首字节最后1bit为0</li><li>读数据，首字节最后1bit为1</li><li>应答信号 bit9</li><li>非应答信号</li></ol><h1 id="器件地址"><a href="#器件地址" class="headerlink" title="器件地址"></a>器件地址</h1><p>首字节是 <strong>“片选信号”</strong>，即7位从机地址加1位方向(读写)控制。<br>高四位为器件类型识别符，接着三位为片选，最后一位为读写位。7位寻址地址减去1个<strong>广播地址0x00</strong>不用，所以有2<sup>7</sup>=128 - 1 = 127，所以理论上可以挂127个从器件。<br><img src="/images/20200516210102716.png"></p><h1 id="寻址过程"><a href="#寻址过程" class="headerlink" title="寻址过程"></a>寻址过程</h1><ol><li>主机起始信号（START）</li><li>主机发出首字节数据 后 释放SDA </li><li>对应地址的从机 驱动SDA为0（ACK）<h1 id="写数据"><a href="#写数据" class="headerlink" title="写数据"></a>写数据</h1>主机发出1Byte数据 释放 SDA<br>从机驱动SDA为0应答<h1 id="读数据"><a href="#读数据" class="headerlink" title="读数据"></a>读数据</h1>从机发出1Byte数据 释放 SDA<br>主机驱动SDA为0应答</li></ol><h1 id="8bit数据传输完-ACK不一定有"><a href="#8bit数据传输完-ACK不一定有" class="headerlink" title="8bit数据传输完 ACK不一定有"></a>8bit数据传输完 ACK不一定有</h1><p>以下3种情况下 数据传输完 没有ACK：</p><ol><li>无那个从机 或者 此从机正忙，第9个SCL时SDA不会被从机拉低，无ACK</li><li>从机无法接收更多的数据时，不会ACK</li><li>主机在接收到最后一个字节后，不会ACK，主机直接发出P信号</li></ol><p><img src="/images/20200516212835618.png"></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第22课 1 2 3 网卡DM9000C移植 配置基地址、中断、引脚时序时间(默认的可用，更快要调自己设置)    内存控制器 位宽与读取数据字节长度</title>
      <link href="2021/05/14/wds2-qi-di-22-ke-1-2-3-wang-qia-dm9000c-yi-zhi-pei-zhi-ji-di-zhi-zhong-duan-yin-jiao-shi-xu-shi-jian-mo-ren-de-ke-yong-geng-kuai-yao-diao-zi-ji-she-zhi-nei-cun-kong-zhi-qi-wei-kuan-yu-du-qu-shu-ju-zi-jie-chang-du-local/"/>
      <url>2021/05/14/wds2-qi-di-22-ke-1-2-3-wang-qia-dm9000c-yi-zhi-pei-zhi-ji-di-zhi-zhong-duan-yin-jiao-shi-xu-shi-jian-mo-ren-de-ke-yong-geng-kuai-yao-diao-zi-ji-she-zhi-nei-cun-kong-zhi-qi-wei-kuan-yu-du-qu-shu-ju-zi-jie-chang-du-local/</url>
      
        <content type="html"><![CDATA[<h1 id="网卡驱动移植-配置基地址、中断、引脚时序时间-默认的可用，更快要调自己设置"><a href="#网卡驱动移植-配置基地址、中断、引脚时序时间-默认的可用，更快要调自己设置" class="headerlink" title="网卡驱动移植 配置基地址、中断、引脚时序时间(默认的可用，更快要调自己设置)"></a>网卡驱动移植 配置基地址、中断、引脚时序时间(默认的可用，更快要调自己设置)</h1><p>内核自带的DM9000C网卡驱动不能用，移植DM900C芯片厂家提供的驱动程序。</p><p>网卡与内存接口一样，修改 基地址 和 中断引脚。</p><p>引脚设置，中断设置需要的头文件：<br><img src="/images/2020051616020626.png"><br>DM9000C的索引寄存器(cmd引脚为0)，数据寄存器(cmd引脚为1)在这里被用到，需要io映射，<br><img src="/images/20200516160359355.png"><br>调试出现的，这行删除，<br><img src="/images/20200516160430848.png"><br>设置中断触发类型，IRQF_TRIGGER_RISING<br><img src="/images/20200516160507660.png"><br>需要编译成模块，需要入口出口函数init exit：<br><img src="/images/20200516160608147.png"><br>设置中断引脚，为提高网卡io传输速率，应该结合CPU和DM900C的数据手册，把CPU的<strong>内存控制器</strong>相关引脚的电平维持时间 设置成 DM9000c最低要求，需要结合时序图配寄存器：<br><img src="/images/20200516162129110.png"><br><img src="/images/2020051616082289.png"><br><img src="/images/2020051616085615.png"></p><h1 id="内存控制器-位宽与读取数据字节长度"><a href="#内存控制器-位宽与读取数据字节长度" class="headerlink" title="内存控制器 位宽与读取数据字节长度"></a>内存控制器 位宽与读取数据字节长度</h1><p>CPU的内存控制器可以接SDRAM、NOR_Flash、网卡。<br><img src="/images/20200516164046100.png"></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">ldrR0<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">;</span>从<span class="token number">0</span>地址加载<span class="token number">4</span>个字节，<span class="token number">0</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> 四个地址的数据都被读取到R0ldbR0<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">;</span>从<span class="token number">0</span>地址加载<span class="token number">1</span>个字节MOVR1<span class="token punctuation">,</span>#<span class="token number">0</span><span class="token punctuation">;</span>给R1赋值<span class="token number">0</span>ldrR0<span class="token punctuation">,</span><span class="token punctuation">[</span>R1<span class="token punctuation">]</span><span class="token punctuation">;</span>从R1所指地址读取<span class="token number">4</span>字节数据到R0为什么外接nor时cpu需要设置位宽，（nor的位宽可选由硬件引脚设置了）ldrR0<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>一、假设CPU用ldr需要获取<span class="token number">4</span>Byte数据，cpu的内存控制器外接的是<span class="token number">16</span>bit的nor flash，内存控制器要发起两次传输指令才能读取<span class="token number">4</span>字节数据，<span class="token number">1.</span> 发出<span class="token number">0</span>地址，读取<span class="token number">2</span>Byte。nor收到地址为<span class="token number">0</span>，cpu A0不接 A1接nor A0<span class="token number">2.</span> 发出<span class="token number">2</span>地址，读取<span class="token number">2</span>Byte。nor收到地址为<span class="token number">1</span>，cpu A0不接 A1接nor A0<span class="token number">3.</span> 把<span class="token number">1.2</span><span class="token punctuation">.</span>的<span class="token number">4</span>Byte数据返回给CPUldbR0<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>二、假设CPU用ldb需要获取<span class="token number">1</span>Byte数据，cpu的内存控制器外接的是<span class="token number">16</span>bit的nor flash，内存控制器要发起<span class="token number">1</span>次传输指令就能读取<span class="token number">2</span>字节数据，<span class="token number">1.</span> 发出<span class="token number">3</span>地址，读取<span class="token number">2</span>Byte。nor收到地址为<span class="token number">1</span>，cpu A0不接 A1接nor A0<span class="token number">2.</span> 内存取出高字节返回cpu<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第21课 1 2 网卡驱动框架 模拟虚拟网卡接收sk_buff上报  一般网卡厂家都会给驱动程序，修改即可</title>
      <link href="2021/05/14/wds2-qi-di-21-ke-1-2-wang-qia-qu-dong-kuang-jia-mo-ni-xu-ni-wang-qia-jie-shou-sk-buff-shang-bao-yi-ban-wang-qia-han-jia-du-hui-gei-qu-dong-cheng-xu-xiu-gai-ji-ke-local/"/>
      <url>2021/05/14/wds2-qi-di-21-ke-1-2-wang-qia-qu-dong-kuang-jia-mo-ni-xu-ni-wang-qia-jie-shou-sk-buff-shang-bao-yi-ban-wang-qia-han-jia-du-hui-gei-qu-dong-cheng-xu-xiu-gai-ji-ke-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]</p><h1 id="比较字符设备-和-块设备"><a href="#比较字符设备-和-块设备" class="headerlink" title="比较字符设备 和 块设备"></a>比较字符设备 和 块设备</h1><p>比较字符设备和块设备，字符设备。<br>字符设备，首先在user中先open一个 /dev/xxx，<br>块设备，首先挂接一个盘 mount /dev/xxx。</p><ol><li>主设备号</li><li>fops</li><li>register</li><li>入口出口<br><img src="/images/20200513080339582.png"></li></ol><p>块设备，对普通文件的读写，通过文件系统最终转换成对扇区的读写，</p><ol><li>分配 gendisk<br>alloc_disk</li><li>设置，<br> queue = blk_init_queue 里面有处理队列函数<br> 其他属性：比如主设备号、容量</li><li>注册<br> add_disk</li></ol><h1 id="网卡驱动"><a href="#网卡驱动" class="headerlink" title="网卡驱动"></a>网卡驱动</h1><h2 id="网卡驱动框架"><a href="#网卡驱动框架" class="headerlink" title="网卡驱动框架"></a>网卡驱动框架</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c">app<span class="token operator">:</span> socket<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>网络协议层<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>hard_start_xmit<span class="token operator">|</span>    <span class="token operator">^</span>v sk_buff  <span class="token operator">|</span>  netif_rx<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>硬件相关的驱动程序 （要提供hard_start_xmit供上层发数据调用，接收到数据用netif_rx上报）<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>硬件<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>讲道理应该工作在数据链路层和物理层。</strong><br><img src="/images/20200513180203364.png"><br>网卡驱动程序，是OSI参考模型的硬件层，只需要完成收发功能就ok，<code>sk_buff</code>连接上下层数据传输。<br><strong>上层把数据给<code>sk_buff</code>然后调用<code>hard_start_xmit</code>传输数据，<br>硬件把收到的数据放到<code>sk_buff</code>调用提供给上层。</strong></p><p>字符设备，首先在user中先open一个 /dev/xxx，<br>块设备，    首先挂接一个盘 mount /dev/xxx，<br>网卡设备，socket编程，不需要打开什么设备。</p><h2 id="网卡设备驱动编程步骤："><a href="#网卡设备驱动编程步骤：" class="headerlink" title="网卡设备驱动编程步骤："></a>网卡设备驱动编程步骤：</h2><p>参考<code>drivers\net\cs89x0.c</code>，struct net_device * __init cs89x0_probe(int unit)。</p><ol><li>分配 <code>net_device</code></li><li> 设置<br>a.提供发包函数 <code>hard_start_xmit</code> —<code>// struct sk_buff *skb, struct net_device *dev</code><br>b.提供收包功能（中断处理函数中用<code>netif_rx</code>上报数据） <code>netif_rx</code>  —<code>// struct sk_buff* skb</code></li></ol><p><strong>上层把数据给<code>sk_buff</code>然后调用<code>hard_start_xmit</code>传输数据，<br>硬件把收到的数据放到<code>sk_buff</code>调用提供给上层。</strong><br>3.  注册 <code>register_netdev</code></p><ol start="4"><li>硬件相关</li></ol><h2 id="程序一-虚拟网卡-注册设备-没做其他"><a href="#程序一-虚拟网卡-注册设备-没做其他" class="headerlink" title="程序一 虚拟网卡 注册设备 没做其他"></a>程序一 虚拟网卡 注册设备 没做其他</h2><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p>虚拟网卡 只是注册了设备 没做其他。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/errno.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/netdevice.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/etherdevice.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/interrupt.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/ioport.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/in.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/skbuff.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/spinlock.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/bitops.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/delay.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/system.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/irq.h></span></span><span class="token comment">// 参考 drivers\net\cs89x0.c</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">net_device</span><span class="token operator">*</span> vnet_dev<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">virt_net_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 1.分配net_device</span>    <span class="token comment">//  私有数据设置为0 </span>    vnet_dev <span class="token operator">=</span> <span class="token function">alloc_netdev</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"vnet%d"</span><span class="token punctuation">,</span> ether_setup<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 2.设置</span>    <span class="token comment">// 3.注册</span>    <span class="token function">register_netdev</span><span class="token punctuation">(</span>vnet_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">virt_net_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">unregister_netdev</span><span class="token punctuation">(</span>vnet_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free_netdev</span><span class="token punctuation">(</span>vnet_dev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>virt_net_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>virt_net_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>插入模块，<br>查看网卡，<br>设置vnet0，<br>查看网卡，多了一张虚拟网卡，<br>ping虚拟网卡，ping通，因为ping自己不会涉及硬件，<br>ping其他ip死机，没有提供函数<br><img src="/images/20200513112944385.png"><br><img src="/images/20200513113330249.png"></p><h2 id="程序二-在发送函数中加入计数和统计信息"><a href="#程序二-在发送函数中加入计数和统计信息" class="headerlink" title="程序二 在发送函数中加入计数和统计信息"></a>程序二 在发送函数中加入计数和统计信息</h2><p>计数发送的次数，更新统计信息struct net_device中stats，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">include\linux\netdevice<span class="token punctuation">.</span>h<span class="token keyword">struct</span> <span class="token class-name">net_device</span><span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">net_device_stats</span>stats<span class="token punctuation">;</span>include\linux\netdevice<span class="token punctuation">.</span>h<span class="token keyword">struct</span> <span class="token class-name">net_device_stats</span><span class="token punctuation">&#123;</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span>rx_packets<span class="token punctuation">;</span><span class="token comment">/* total packets received*/</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span>tx_packets<span class="token punctuation">;</span><span class="token comment">/* total packets transmitted*/</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span>rx_bytes<span class="token punctuation">;</span><span class="token comment">/* total bytes received */</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span>tx_bytes<span class="token punctuation">;</span><span class="token comment">/* total bytes transmitted*/</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span>rx_errors<span class="token punctuation">;</span><span class="token comment">/* bad packets received*/</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span>tx_errors<span class="token punctuation">;</span><span class="token comment">/* packet transmit problems*/</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span>rx_dropped<span class="token punctuation">;</span><span class="token comment">/* no space in linux buffers*/</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span>tx_dropped<span class="token punctuation">;</span><span class="token comment">/* no space available in linux*/</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span>multicast<span class="token punctuation">;</span><span class="token comment">/* multicast packets received*/</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span>collisions<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/errno.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/netdevice.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/etherdevice.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/interrupt.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/ioport.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/in.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/skbuff.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/spinlock.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/bitops.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/delay.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/system.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/irq.h></span></span><span class="token comment">// 参考 drivers\net\cs89x0.c</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">net_device</span><span class="token operator">*</span> vnet_dev<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">virtnet_sendpacket</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"virtnet_sendpacket cnt = %d\n"</span><span class="token punctuation">,</span> <span class="token operator">++</span>cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 对于真实的网卡，应该把skb数据通过硬件发送出去</span>    <span class="token comment">// 更新统计信息</span>    vnet_dev<span class="token operator">-></span>stats<span class="token punctuation">.</span>tx_packets<span class="token operator">++</span><span class="token punctuation">;</span>    vnet_dev<span class="token operator">-></span>stats<span class="token punctuation">.</span>tx_bytes <span class="token operator">+=</span> skb<span class="token operator">-></span>len<span class="token punctuation">;</span>    <span class="token comment">// 设置MAC地址</span>    vnet_dev<span class="token operator">-></span>dev_addr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x08</span><span class="token punctuation">;</span>    vnet_dev<span class="token operator">-></span>dev_addr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x89</span><span class="token punctuation">;</span>    vnet_dev<span class="token operator">-></span>dev_addr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x89</span><span class="token punctuation">;</span>    vnet_dev<span class="token operator">-></span>dev_addr<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x89</span><span class="token punctuation">;</span>    vnet_dev<span class="token operator">-></span>dev_addr<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x89</span><span class="token punctuation">;</span>    vnet_dev<span class="token operator">-></span>dev_addr<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x11</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">virt_net_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 1.分配net_device</span>    <span class="token comment">//  私有数据设置为0 </span>    vnet_dev <span class="token operator">=</span> <span class="token function">alloc_netdev</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"vnet%d"</span><span class="token punctuation">,</span> ether_setup<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2.设置</span>    vnet_dev<span class="token operator">-></span>hard_start_xmit <span class="token operator">=</span> virtnet_sendpacket<span class="token punctuation">;</span>    <span class="token comment">// 3.注册</span>    <span class="token function">register_netdev</span><span class="token punctuation">(</span>vnet_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">virt_net_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">unregister_netdev</span><span class="token punctuation">(</span>vnet_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free_netdev</span><span class="token punctuation">(</span>vnet_dev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>virt_net_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>virt_net_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="小实验-打印-ping其他查看统计"><a href="#小实验-打印-ping其他查看统计" class="headerlink" title="小实验 打印  ping其他查看统计"></a>小实验 打印  ping其他查看统计</h3><p><img src="/images/20200513172908404.png"><br>更改MAC，ping其他<br><img src="/images/20200513174748499.png"></p><h2 id="程序三-模拟收到数据帧-这样ping其他ip也能成功"><a href="#程序三-模拟收到数据帧-这样ping其他ip也能成功" class="headerlink" title="程序三 模拟收到数据帧 这样ping其他ip也能成功"></a>程序三 模拟收到数据帧 这样ping其他ip也能成功</h2><h3 id="源代码-复杂的模拟接收没什么用"><a href="#源代码-复杂的模拟接收没什么用" class="headerlink" title="源代码 复杂的模拟接收没什么用"></a>源代码 复杂的模拟接收没什么用</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/errno.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/netdevice.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/ip.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/etherdevice.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/interrupt.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/ioport.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/in.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/skbuff.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/spinlock.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/bitops.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/delay.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/system.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/irq.h></span></span><span class="token comment">// 参考 drivers\net\cs89x0.c</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">net_device</span><span class="token operator">*</span> vnet_dev<span class="token punctuation">;</span><span class="token comment">// 仿真假装接收到 数据帧上报 数据链路层加上 MAC和帧校验序列(FCS frame check sequence)</span><span class="token comment">//  没什么用，只是讲解 接收sk_buff上报</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">emulator_rx_packet</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">net_device</span><span class="token operator">*</span> dev<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">// 参考LDDR3 很复杂 视频也没有自己写，一般用不到，主要是讲解怎么处理skb数据帧</span><span class="token comment">//  修改 源MAC ip目的MAC ip  type等</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>type<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">iphdr</span> <span class="token operator">*</span>ih<span class="token punctuation">;</span>    __be32 <span class="token operator">*</span>saddr<span class="token punctuation">,</span> <span class="token operator">*</span>daddr<span class="token punctuation">,</span> tmp<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> tmp_dev_addr<span class="token punctuation">[</span>ETH_ALEN<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">ethhdr</span> <span class="token operator">*</span>ethhdr<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>rx_skb<span class="token punctuation">;</span>    <span class="token comment">// 从硬件读出/保存数据</span>    <span class="token comment">//  对换源、目的的MAC</span>    ethhdr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ethhdr</span><span class="token operator">*</span><span class="token punctuation">)</span>skb<span class="token operator">-></span>data<span class="token punctuation">;</span>    <span class="token function">memcpy</span><span class="token punctuation">(</span>tmp_dev_addr<span class="token punctuation">,</span> ethhdr<span class="token operator">-></span>h_dest<span class="token punctuation">,</span> ETH_ALEN<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memcpy</span><span class="token punctuation">(</span>ethhdr<span class="token operator">-></span>h_dest<span class="token punctuation">,</span> ethhdr<span class="token operator">-></span>h_source<span class="token punctuation">,</span> ETH_ALEN<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memcpy</span><span class="token punctuation">(</span>ethhdr<span class="token operator">-></span>h_source<span class="token punctuation">,</span> tmp_dev_addr<span class="token punctuation">,</span> ETH_ALEN<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//  对换源、目的的ip</span>    ih <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">iphdr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>skb<span class="token operator">-></span>data <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ethhdr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    saddr <span class="token operator">=</span> <span class="token operator">&amp;</span>ih<span class="token operator">-></span>saddr<span class="token punctuation">;</span>    daddr <span class="token operator">=</span> <span class="token operator">&amp;</span>ih<span class="token operator">-></span>daddr<span class="token punctuation">;</span>    tmp <span class="token operator">=</span> <span class="token operator">*</span>saddr<span class="token punctuation">;</span>    <span class="token operator">*</span>saddr <span class="token operator">=</span> <span class="token operator">*</span>daddr<span class="token punctuation">;</span>    <span class="token operator">*</span>daddr <span class="token operator">=</span> tmp<span class="token punctuation">;</span>    type <span class="token operator">=</span> skb<span class="token operator">-></span>data <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ethhdr</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">iphdr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">*</span>type <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 修改类型，原来0x8表示ping，0表示replay</span>    ih<span class="token operator">-></span>check <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    ih<span class="token operator">-></span>check <span class="token operator">=</span> <span class="token function">ip_fast_csum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>ih<span class="token punctuation">,</span> ih<span class="token operator">-></span>ihl<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 构造一个sk_buff</span>    rx_skb <span class="token operator">=</span> <span class="token function">dev_alloc_skb</span><span class="token punctuation">(</span>skb<span class="token operator">-></span>len <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">skb_reserve</span><span class="token punctuation">(</span>rx_skb<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token function">skb_put</span><span class="token punctuation">(</span>rx_skb<span class="token punctuation">,</span> skb<span class="token operator">-></span>len<span class="token punctuation">)</span><span class="token punctuation">,</span> skb<span class="token operator">-></span>data<span class="token punctuation">,</span> skb<span class="token operator">-></span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>    rx_skb<span class="token operator">-></span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>    rx_skb<span class="token operator">-></span>protocol <span class="token operator">=</span> <span class="token function">eth_type_trans</span><span class="token punctuation">(</span>rx_skb<span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    rx_skb<span class="token operator">-></span>ip_summed <span class="token operator">=</span> CHECKSUM_UNNECESSARY<span class="token punctuation">;</span>    dev<span class="token operator">-></span>stats<span class="token punctuation">.</span>rx_packets<span class="token operator">++</span><span class="token punctuation">;</span>    dev<span class="token operator">-></span>stats<span class="token punctuation">.</span>rx_bytes <span class="token operator">+=</span> skb<span class="token operator">-></span>len<span class="token punctuation">;</span>       <span class="token comment">// 提交sk_buff</span>    <span class="token function">netif_rx</span><span class="token punctuation">(</span>rx_skb<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">virtnet_sendpacket</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"virtnet_sendpacket cnt = %d\n"</span><span class="token punctuation">,</span> <span class="token operator">++</span>cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 对于真实的网卡，应该把skb数据通过网卡发送出去</span>    <span class="token comment">//  数据写入发送完成后会产生中断再唤醒该队列</span>    <span class="token function">netif_stop_queue</span><span class="token punctuation">(</span>vnet_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 停止该网卡队列</span>    <span class="token comment">// 。。。。                   // 把skb的数据写入网卡</span>    <span class="token comment">//  自己构造sk_buff，假装接收到数据帧，然后上报</span>    <span class="token function">emulator_rx_packet</span><span class="token punctuation">(</span>skb<span class="token punctuation">,</span> vnet_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token function">dev_free_skb</span><span class="token punctuation">(</span>skb<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// 释放skb</span>    <span class="token function">netif_wake_queue</span><span class="token punctuation">(</span>vnet_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 数据全部发送完成后会唤醒网卡队列（应该在中断函数中完成）</span>    <span class="token comment">// 更新统计信息</span>    vnet_dev<span class="token operator">-></span>stats<span class="token punctuation">.</span>tx_packets<span class="token operator">++</span><span class="token punctuation">;</span>    vnet_dev<span class="token operator">-></span>stats<span class="token punctuation">.</span>tx_bytes <span class="token operator">+=</span> skb<span class="token operator">-></span>len<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">virt_net_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 1.分配net_device</span>    <span class="token comment">//  私有数据设置为0 </span>    vnet_dev <span class="token operator">=</span> <span class="token function">alloc_netdev</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"vnet%d"</span><span class="token punctuation">,</span> ether_setup<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2.设置</span>    vnet_dev<span class="token operator">-></span>hard_start_xmit <span class="token operator">=</span> virtnet_sendpacket<span class="token punctuation">;</span>    <span class="token comment">//  ping通还需要设置两项</span>    vnet_dev<span class="token operator">-></span>flags     <span class="token operator">|=</span> IFF_NOARP<span class="token punctuation">;</span>    vnet_dev<span class="token operator">-></span>features  <span class="token operator">|=</span> NETIF_F_NO_CSUM<span class="token punctuation">;</span>     <span class="token comment">//  设置MAC</span>    vnet_dev<span class="token operator">-></span>dev_addr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x08</span><span class="token punctuation">;</span>    vnet_dev<span class="token operator">-></span>dev_addr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x89</span><span class="token punctuation">;</span>    vnet_dev<span class="token operator">-></span>dev_addr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x89</span><span class="token punctuation">;</span>    vnet_dev<span class="token operator">-></span>dev_addr<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x89</span><span class="token punctuation">;</span>    vnet_dev<span class="token operator">-></span>dev_addr<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x89</span><span class="token punctuation">;</span>    vnet_dev<span class="token operator">-></span>dev_addr<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x11</span><span class="token punctuation">;</span>         <span class="token comment">// 3.注册</span>    <span class="token function">register_netdev</span><span class="token punctuation">(</span>vnet_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">virt_net_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">unregister_netdev</span><span class="token punctuation">(</span>vnet_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free_netdev</span><span class="token punctuation">(</span>vnet_dev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>virt_net_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>virt_net_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="简单实验"><a href="#简单实验" class="headerlink" title="简单实验"></a>简单实验</h3><p>能ping通，统计有计数<br><img src="/images/20200513182609661.png"><br>一般网卡厂家都会给驱动程序，修改即可。</p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第20课 3 nor驱动程序 只需硬件相关操作</title>
      <link href="2021/05/14/wds2-qi-di-20-ke-3-nor-qu-dong-cheng-xu-zhi-xu-ying-jian-xiang-guan-cao-zuo-local/"/>
      <url>2021/05/14/wds2-qi-di-20-ke-3-nor-qu-dong-cheng-xu-zhi-xu-ying-jian-xiang-guan-cao-zuo-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]<br>参考<code>drivers\mtd\maps\physmap.c</code>。<br><img src="/images/20200512181739783.png"><br>最后分析出我们配置硬件相关需要做：</p><ol><li>分配map_info结构体</li><li>设置 物理基地址(phys)、大小(size)、位宽(bankwidth) 虚拟基地址(virt)。<br> 内核看到的不同开发板最小的差别就是这些了</li><li>使用 调用nor flash的协议层函数来识别</li><li>添加分区，不是必须。add_mtd_partitions<h1 id="第一个程序-简单框架-内核识别nor"><a href="#第一个程序-简单框架-内核识别nor" class="headerlink" title="第一个程序 简单框架 内核识别nor"></a>第一个程序 简单框架 内核识别nor</h1><h2 id="第一个程序代码"><a href="#第一个程序代码" class="headerlink" title="第一个程序代码"></a>第一个程序代码</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mtd/mtd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mtd/map.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mtd/partitions.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mtd/physmap.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h></span></span><span class="token comment">// 参考drivers\mtd\maps\physmap.c。</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">map_info</span> <span class="token operator">*</span>normap_info<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>normtd_info<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">s3c_nor_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 1.分配map_info结构体</span>    normap_info <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">map_info</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2.设置 物理基地址(phys)、大小(size)、位宽(bankwidth) 虚拟基地址(virt)</span>    <span class="token comment">//  内核看到的不同开发板最小的差别就是这些了</span>normap_info<span class="token operator">-></span>name <span class="token operator">=</span> <span class="token string">"s3c_nor"</span><span class="token punctuation">;</span>normap_info<span class="token operator">-></span>phys <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>          <span class="token comment">// nor启动时 物理地址为0</span>normap_info<span class="token operator">-></span>size <span class="token operator">=</span> <span class="token number">0x1000000</span><span class="token punctuation">;</span>  <span class="token comment">// 16M 一定>=nor的实际大小</span>normap_info<span class="token operator">-></span>bankwidth <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>     <span class="token comment">// 2*Byte=16bit</span>normap_info<span class="token operator">-></span>virt <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>normap_info<span class="token operator">-></span>phys<span class="token punctuation">,</span> normap_info<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">simple_map_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>normap_info<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 简单初始化</span>    <span class="token comment">// 3.使用 调用nor flash的协议层函数来识别</span>normtd_info <span class="token operator">=</span> <span class="token function">do_map_probe</span><span class="token punctuation">(</span><span class="token string">"cfi_probe"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>normap_info<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>normap_info<span class="token punctuation">)</span>    <span class="token comment">// 这里只尝试两种模式cfi和jedec</span>        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"use cfi_probe.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"use jedec_probe.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    normtd_info <span class="token operator">=</span> <span class="token function">do_map_probe</span><span class="token punctuation">(</span><span class="token string">"jedec_probe"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>normap_info<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>normap_info<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 不是这两种模式</span>        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"mode cfi_probe or jedec_probe failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">iounmap</span><span class="token punctuation">(</span>normap_info<span class="token operator">-></span>virt<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">kfree</span><span class="token punctuation">(</span>normap_info<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span>EIO<span class="token punctuation">;</span>    <span class="token comment">// I/O error</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 4.添加分区，不是必须。add_mtd_partitions</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">s3c_nor_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">iounmap</span><span class="token punctuation">(</span>normap_info<span class="token operator">-></span>virt<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">kfree</span><span class="token punctuation">(</span>normap_info<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>s3c_nor_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>s3c_nor_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="简单测试第一个程序，插入能否识别nor"><a href="#简单测试第一个程序，插入能否识别nor" class="headerlink" title="简单测试第一个程序，插入能否识别nor"></a>简单测试第一个程序，插入能否识别nor</h2>在测试nor时先卸载，出现警告<code>physmap-flash.0 does not have a release() function</code>，在platform_device平台设备中需要提供release()函数，内核中自带nor没有，<pre class="line-numbers language-c" data-language="c"><code class="language-c">`drivers\mtd\maps\physmap<span class="token punctuation">.</span>c`<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">platform_device</span> physmap_flash <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>name<span class="token operator">=</span> <span class="token string">"physmap-flash"</span><span class="token punctuation">,</span><span class="token punctuation">.</span>id<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dev<span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>platform_data<span class="token operator">=</span> <span class="token operator">&amp;</span>physmap_flash_data<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">.</span>num_resources<span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">.</span>resource<span class="token operator">=</span> <span class="token operator">&amp;</span>physmap_flash_resource<span class="token punctuation">,</span><span class="token comment">// 无release()函数</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><img src="/images/20200512200742112.png"><br><img src="/images/20200512201343815.png"><h1 id="第二个程序-添加了分区add-mtd-partitions"><a href="#第二个程序-添加了分区add-mtd-partitions" class="headerlink" title="第二个程序 添加了分区add_mtd_partitions"></a>第二个程序 添加了分区add_mtd_partitions</h1><h2 id="第二个程序代码"><a href="#第二个程序代码" class="headerlink" title="第二个程序代码"></a>第二个程序代码</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mtd/mtd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mtd/map.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mtd/partitions.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mtd/physmap.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h></span></span><span class="token comment">// 参考drivers\mtd\maps\physmap.c。</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">map_info</span> <span class="token operator">*</span>normap_info<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>normtd_info<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">mtd_partition</span> nor_part<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 用于nor分区的数组</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">.</span>name   <span class="token operator">=</span> <span class="token string">"bootloader_nor"</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span>size   <span class="token operator">=</span> <span class="token number">0x00040000</span><span class="token punctuation">,</span><span class="token punctuation">.</span>offset<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">.</span>name   <span class="token operator">=</span> <span class="token string">"root_nor"</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span>offset <span class="token operator">=</span> MTDPART_OFS_APPEND<span class="token punctuation">,</span>        <span class="token punctuation">.</span>size   <span class="token operator">=</span> MTDPART_SIZ_FULL<span class="token punctuation">,</span> <span class="token comment">// 剩下的所有都是该分区</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">s3c_nor_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 1.分配map_info结构体</span>    normap_info <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">map_info</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2.设置 物理基地址(phys)、大小(size)、位宽(bankwidth) 虚拟基地址(virt)</span>    <span class="token comment">//  内核看到的不同开发板最小的差别就是这些了</span>normap_info<span class="token operator">-></span>name <span class="token operator">=</span> <span class="token string">"s3c_nor"</span><span class="token punctuation">;</span>normap_info<span class="token operator">-></span>phys <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>          <span class="token comment">// nor启动时 物理地址为0</span>normap_info<span class="token operator">-></span>size <span class="token operator">=</span> <span class="token number">0x1000000</span><span class="token punctuation">;</span>  <span class="token comment">// 16M 一定>=nor的实际大小</span>normap_info<span class="token operator">-></span>bankwidth <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>     <span class="token comment">// 2*Byte=16bit</span>normap_info<span class="token operator">-></span>virt <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>normap_info<span class="token operator">-></span>phys<span class="token punctuation">,</span> normap_info<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">simple_map_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>normap_info<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 简单初始化</span>    <span class="token comment">// 3.使用 调用nor flash的协议层函数来识别</span>normtd_info <span class="token operator">=</span> <span class="token function">do_map_probe</span><span class="token punctuation">(</span><span class="token string">"cfi_probe"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>normap_info<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>normap_info<span class="token punctuation">)</span>    <span class="token comment">// 这里只尝试两种模式cfi和jedec</span>        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"use cfi_probe.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"use jedec_probe.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    normtd_info <span class="token operator">=</span> <span class="token function">do_map_probe</span><span class="token punctuation">(</span><span class="token string">"jedec_probe"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>normap_info<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>normap_info<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 不是这两种模式</span>        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"mode cfi_probe or jedec_probe failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">iounmap</span><span class="token punctuation">(</span>normap_info<span class="token operator">-></span>virt<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">kfree</span><span class="token punctuation">(</span>normap_info<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span>EIO<span class="token punctuation">;</span>    <span class="token comment">// I/O error</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 4.添加分区，不是必须。add_mtd_partitions</span>    <span class="token function">add_mtd_partitions</span><span class="token punctuation">(</span>normtd_info<span class="token punctuation">,</span> nor_part<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">s3c_nor_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">del_mtd_partitions</span><span class="token punctuation">(</span>normtd_info<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">iounmap</span><span class="token punctuation">(</span>normap_info<span class="token operator">-></span>virt<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">kfree</span><span class="token punctuation">(</span>normap_info<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>s3c_nor_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>s3c_nor_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="测试第二个程序-格式化-往nor分区写文件"><a href="#测试第二个程序-格式化-往nor分区写文件" class="headerlink" title="测试第二个程序 格式化 往nor分区写文件"></a>测试第二个程序 格式化 往nor分区写文件</h2></li><li>编译 拷贝.ko</li><li><code>ls /dev/mtd*</code></li><li><code>insmod .ko</code></li><li><code>ls /dev/mtd*</code><br><img src="/images/20200512213935739.png"></li><li>格式化 <code>flash eraseall -j /dev/mtd1</code><br>一般 nand用<code>yaffs</code>格式，nor用<code>jffs2</code>格式。</li><li>挂接 <code>mount -t jffs2 /dev/mtdblock1 /mnt</code><br>可以写入一个文件测试以下，重启看还在不在。<br><img src="/images/20200512214655138.png"><h1 id="用内存模拟MTD-flash-只是介绍无实验"><a href="#用内存模拟MTD-flash-只是介绍无实验" class="headerlink" title="用内存模拟MTD flash 只是介绍无实验"></a>用内存模拟MTD flash 只是介绍无实验</h1>对于MTD，内核不关心是nand或者nor，只需要提供<code>mtd_info</code>结构体就ok。<br>flash协议层知道发什么，硬件相关知道怎么发。</li></ol><p>参考<code>drivers\mtd\devices\mtdram.c</code>，直接设置<code>mtd_info</code>结构体并告知就行：<br>分配<code>mtd_info</code>结构体，<br>分配一块内存，<br>设置<code>mtd_info</code>结构体，提供rease write read，是内存所以直接<code>memset</code> <code>memcpy</code>，<br>add_mtd_device。</p><h1 id="解析内核识别nor的过程"><a href="#解析内核识别nor的过程" class="headerlink" title="解析内核识别nor的过程"></a>解析内核识别nor的过程</h1><h2 id="cfi模式"><a href="#cfi模式" class="headerlink" title="cfi模式"></a>cfi模式</h2><p><img src="/images/20200512224329831.png"></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">从do_map_probe函数分析，normtd_info <span class="token operator">=</span> <span class="token function">do_map_probe</span><span class="token punctuation">(</span><span class="token string">"cfi_probe"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>normap_info<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span><span class="token function">do_map_probe</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">map_info</span> <span class="token operator">*</span>map<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">mtd_chip_driver</span> <span class="token operator">*</span>drv<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>ret<span class="token punctuation">;</span><span class="token comment">// ------------------------------------------------------------</span>drv <span class="token operator">=</span> <span class="token function">get_mtd_chip_driver</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">list_for_each</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> <span class="token operator">&amp;</span>chip_drvs_list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// chip_drvs_list链表由register_mtd_chip_driver</span>this <span class="token operator">=</span> <span class="token function">list_entry</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token operator">*</span>this<span class="token punctuation">)</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// drivers\mtd\chips\chipreg.c</span>ret <span class="token operator">=</span> drv<span class="token operator">-></span><span class="token function">probe</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 最会用cfi_probe</span><span class="token function">cfi_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">map_info</span> <span class="token operator">*</span>map<span class="token punctuation">)</span><span class="token function">mtd_do_chip_probe</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cfi_chip_probe<span class="token punctuation">)</span><span class="token punctuation">;</span>cfi <span class="token operator">=</span> <span class="token function">genprobe_ident_chips</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> cp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">genprobe_new_chip</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> cp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cfi<span class="token punctuation">)</span> <span class="token comment">// drivers\mtd\chips\gen_probe.c</span>cp<span class="token operator">-></span><span class="token function">probe_chip</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> cfi<span class="token punctuation">)</span> <span class="token comment">// cfi_chip_probe</span>cfi_chip_probe  <span class="token comment">// drivers\mtd\chips\cfi_probe.c</span><span class="token comment">// 进入cfi模式</span><span class="token function">cfi_send_gen_cmd</span><span class="token punctuation">(</span><span class="token number">0x98</span><span class="token punctuation">,</span> <span class="token number">0x55</span><span class="token punctuation">,</span> base<span class="token punctuation">,</span> map<span class="token punctuation">,</span> cfi<span class="token punctuation">,</span> cfi<span class="token operator">-></span>device_type<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 看能否读出QRY</span><span class="token function">qry_present</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span>base<span class="token punctuation">,</span>cfi<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面设计到的函数，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">drivers\mtd\chips\cfi_probe<span class="token punctuation">.</span>c<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">cfi_probe_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">register_mtd_chip_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cfi_chipdrv<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">cfi_probe_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">unregister_mtd_chip_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cfi_chipdrv<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>drivers\mtd\chips\cfi_probe<span class="token punctuation">.</span>c<span class="token function">xip_disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> \<span class="token function">cfi_send_gen_cmd</span><span class="token punctuation">(</span><span class="token number">0xF0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> base<span class="token punctuation">,</span> map<span class="token punctuation">,</span> cfi<span class="token punctuation">,</span> cfi<span class="token operator">-></span>device_type<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> \<span class="token function">cfi_send_gen_cmd</span><span class="token punctuation">(</span><span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> base<span class="token punctuation">,</span> map<span class="token punctuation">,</span> cfi<span class="token punctuation">,</span> cfi<span class="token operator">-></span>device_type<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> \<span class="token function">cfi_send_gen_cmd</span><span class="token punctuation">(</span><span class="token number">0x98</span><span class="token punctuation">,</span> <span class="token number">0x55</span><span class="token punctuation">,</span> base<span class="token punctuation">,</span> map<span class="token punctuation">,</span> cfi<span class="token punctuation">,</span> cfi<span class="token operator">-></span>device_type<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> \drivers\mtd\chips\cfi_probe<span class="token punctuation">.</span>c<span class="token keyword">static</span> <span class="token keyword">int</span> __xipram <span class="token function">qry_present</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">map_info</span> <span class="token operator">*</span>map<span class="token punctuation">,</span> __u32 base<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">cfi_private</span> <span class="token operator">*</span>cfi<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">int</span> osf <span class="token operator">=</span> cfi<span class="token operator">-></span>interleave <span class="token operator">*</span> cfi<span class="token operator">-></span>device_type<span class="token punctuation">;</span><span class="token comment">// scale factor</span>map_word val<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>map_word qry<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>qry<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cfi_build_cmd</span><span class="token punctuation">(</span><span class="token string">'Q'</span><span class="token punctuation">,</span> map<span class="token punctuation">,</span> cfi<span class="token punctuation">)</span><span class="token punctuation">;</span>qry<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cfi_build_cmd</span><span class="token punctuation">(</span><span class="token string">'R'</span><span class="token punctuation">,</span> map<span class="token punctuation">,</span> cfi<span class="token punctuation">)</span><span class="token punctuation">;</span>qry<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cfi_build_cmd</span><span class="token punctuation">(</span><span class="token string">'Y'</span><span class="token punctuation">,</span> map<span class="token punctuation">,</span> cfi<span class="token punctuation">)</span><span class="token punctuation">;</span>val<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">map_read</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> base <span class="token operator">+</span> osf<span class="token operator">*</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>val<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">map_read</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> base <span class="token operator">+</span> osf<span class="token operator">*</span><span class="token number">0x11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>val<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">map_read</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> base <span class="token operator">+</span> osf<span class="token operator">*</span><span class="token number">0x12</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">map_word_equal</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> qry<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">map_word_equal</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> qry<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">map_word_equal</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> qry<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// "QRY" found</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="jedec模式"><a href="#jedec模式" class="headerlink" title="jedec模式"></a>jedec模式</h2><p><img src="/images/20200512224220576.png"></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第20课 2 NOR FLASH 驱动框架 差异最小-基地址和位宽</title>
      <link href="2021/05/14/wds2-qi-di-20-ke-2-nor-flash-qu-dong-kuang-jia-chai-yi-zui-xiao-ji-di-zhi-he-wei-kuan-local/"/>
      <url>2021/05/14/wds2-qi-di-20-ke-2-nor-flash-qu-dong-kuang-jia-chai-yi-zui-xiao-ji-di-zhi-he-wei-kuan-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]</p><h1 id="nor-flash驱动框架-分析"><a href="#nor-flash驱动框架-分析" class="headerlink" title="nor flash驱动框架 分析"></a>nor flash驱动框架 分析</h1><p><img src="/images/20200512181109768.png"><br>右下角放大<br><img src="/images/20200512181653411.png"><br>协议层已经做好，需要配置的是硬件相关的设置，基地址和位宽。</p><p>字符设备就找字符设备驱动程序，<br>普通文件就找文件系统 找到块设备驱动，文件系统把对文件的读写转换成对块设备的读写。RAMblock，硬盘，MTD（nand（jedec cfi） nor）。</p><p>nor 和 nand 的差异最小到基地址和位宽，所以可以通过配置使得通用，在<code>drivers\mtd\maps\physmap.c</code>中，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">入口函数 注册平台驱动 平台设备 设置了<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">physmap_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>err <span class="token operator">=</span> <span class="token function">platform_driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>physmap_flash_driver<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">platform_device_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>physmap_flash<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>平台设备中有resource，<span class="token punctuation">.</span>resource<span class="token operator">=</span> <span class="token operator">&amp;</span>physmap_flash_resource<span class="token punctuation">,</span>resource包括了，<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">resource</span> physmap_flash_resource <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>start<span class="token operator">=</span> CONFIG_MTD_PHYSMAP_START<span class="token punctuation">,</span> <span class="token comment">// 起始地址  长度 </span><span class="token punctuation">.</span>end<span class="token operator">=</span> CONFIG_MTD_PHYSMAP_START <span class="token operator">+</span> CONFIG_MTD_PHYSMAP_LEN <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">.</span>flags<span class="token operator">=</span> IORESOURCE_MEM<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>设置位宽<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">physmap_flash_data</span> physmap_flash_data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>width<span class="token operator">=</span> CONFIG_MTD_PHYSMAP_BANKWIDTH<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>平台设备驱动  platform_driver_register 找probe  physmap_flash_probe<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">physmap_flash_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>info<span class="token operator">-></span>map<span class="token punctuation">.</span>name <span class="token operator">=</span> dev<span class="token operator">-></span>dev<span class="token punctuation">.</span>bus_id<span class="token punctuation">;</span> <span class="token comment">// 设置map_info结构体</span>info<span class="token operator">-></span>map<span class="token punctuation">.</span>phys <span class="token operator">=</span> dev<span class="token operator">-></span>resource<span class="token operator">-></span>start<span class="token punctuation">;</span><span class="token comment">// 物理地址 起始地址 长度</span>info<span class="token operator">-></span>map<span class="token punctuation">.</span>size <span class="token operator">=</span> dev<span class="token operator">-></span>resource<span class="token operator">-></span>end <span class="token operator">-</span> dev<span class="token operator">-></span>resource<span class="token operator">-></span>start <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>info<span class="token operator">-></span>map<span class="token punctuation">.</span>bankwidth <span class="token operator">=</span> physmap_data<span class="token operator">-></span>width<span class="token punctuation">;</span> <span class="token comment">// 位宽</span>info<span class="token operator">-></span>map<span class="token punctuation">.</span>set_vpp <span class="token operator">=</span> physmap_data<span class="token operator">-></span>set_vpp<span class="token punctuation">;</span>info<span class="token operator">-></span>map<span class="token punctuation">.</span>virt <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>info<span class="token operator">-></span>map<span class="token punctuation">.</span>phys<span class="token punctuation">,</span> info<span class="token operator">-></span>map<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 物理地址映射</span><span class="token comment">// 由MTD的协议层提供</span>info<span class="token operator">-></span>mtd <span class="token operator">=</span> <span class="token function">do_map_probe</span><span class="token punctuation">(</span><span class="token operator">*</span>probe_type<span class="token punctuation">,</span> <span class="token operator">&amp;</span>info<span class="token operator">-></span>map<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回mtd_info结构体</span><span class="token function">add_mtd_partitions</span><span class="token punctuation">(</span>info<span class="token operator">-></span>mtd<span class="token punctuation">,</span> physmap_data<span class="token operator">-></span>parts<span class="token punctuation">,</span> <span class="token comment">// 添加分区</span>physmap_data<span class="token operator">-></span>nr_parts<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 参数一 name 根据nor的规范才能获取nor的属性 大小等</span><span class="token comment">// static const char *rom_probe_types[] = &#123; "cfi_probe", "jedec_probe", "map_rom", NULL &#125;;</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span><span class="token function">do_map_probe</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">map_info</span> <span class="token operator">*</span>map<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后分析出我们配置硬件相关需要做：</p><ol><li>分配map_info结构体</li><li>设置 物理基地址(phys)、大小(size)、位宽(bankwidth) 虚拟基地址(virt)等。<br> 内核看到的不同开发板最小的差别就是这些了</li><li>使用 调用nor flash的协议层函数来识别</li><li>添加分区，不是必须。add_mtd_partitions<h1 id="配置内核支持nor-flash"><a href="#配置内核支持nor-flash" class="headerlink" title="配置内核支持nor flash"></a>配置内核支持nor flash</h1>内核已经做好，自己配置内核生成.ko模块测试就行，</li><li><code>make menuconfig</code><br>物理起始地址改为0，<br>长度16M 0x1000000，长度需要大于nor的真实长度，因为需要ioremap，<br>位宽 2字节</li><li><code>make modules</code>生成了模块<br>拷贝过去，<br><img src="/images/20200512180419143.png"></li><li>启动开发板，插入模块 <code>insmod physmap.ko</code><br>这里没有分区，整个nor就是一个分区，大小2M，擦除大小64k<br><img src="/images/20200512180846717.png"></li></ol>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第20课 1 NOR FLASH原理及硬件操作 nand nor比较 uboot测试norflash 读和内存一样 写需要进入program模式</title>
      <link href="2021/05/14/wds2-qi-di-20-ke-1-nor-flash-yuan-li-ji-ying-jian-cao-zuo-nand-nor-bi-jiao-uboot-ce-shi-norflash-du-he-nei-cun-yi-yang-xie-xu-yao-jin-ru-program-mo-shi-local/"/>
      <url>2021/05/14/wds2-qi-di-20-ke-1-nor-flash-yuan-li-ji-ying-jian-cao-zuo-nand-nor-bi-jiao-uboot-ce-shi-norflash-du-he-nei-cun-yi-yang-xie-xu-yao-jin-ru-program-mo-shi-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]</p><h1 id="NAND-和-NOR对比"><a href="#NAND-和-NOR对比" class="headerlink" title="NAND 和 NOR对比"></a>NAND 和 NOR对比</h1><table><thead><tr><th></th><th>NOR</th><th>NAND</th></tr></thead><tbody><tr><td>接口</td><td>RAM-Like，引脚多</td><td>引脚少，复用</td></tr><tr><td>容量</td><td>小 1M 2M…</td><td>大 512M 8G…</td></tr><tr><td>读</td><td>简单</td><td>复杂</td></tr><tr><td>写</td><td>发出特定命令，慢</td><td>发出特定命令，快</td></tr><tr><td>价格</td><td>高</td><td>低</td></tr><tr><td>XIP（execute in place）在存储芯片上直接运行</td><td>支持</td><td>不支持</td></tr><tr><td>优缺点比较</td><td>无位反转，无坏块（存储关键信息bootloader）</td><td>位反转，坏块（视频音频等）</td></tr></tbody></table><p>有地址线数据线，片选，可以像内存一样读，不能像内存一样写所以数据不易被破坏。而nand flash数据线传输cmd、data、addr。<br><img src="/images/20200512090916228.png"><br>开发板设置nand启动，nor启动。<br>从nand启动，那么cpu的0地址对应片内的4K sram，而nor不可见。<br>从nor启动，那么0地址就是nor。<br><img src="/images/20200512095151666.png"></p><h1 id="uboot测试nor-flash"><a href="#uboot测试nor-flash" class="headerlink" title="uboot测试nor flash"></a>uboot测试nor flash</h1><p>使用openJTAG烧写uboot到nor flash，从nor启动开发板，</p><h2 id="1-读数据"><a href="#1-读数据" class="headerlink" title="1. 读数据"></a>1. 读数据</h2><p>md.b 0<br><img src="/images/20200512111127138.png"></p><h2 id="2-读ID"><a href="#2-读ID" class="headerlink" title="2. 读ID"></a>2. 读ID</h2><p><img src="/images/20200512114523606.png"><br><strong>NOR手册上:</strong><br>在地址555H写AH<br>在地址2AAH写55H<br>在地址555H写90H （前两步解锁，这一步发命令）<br>读0地址得到厂家ID:C2H<br>读1地址得到设备ID:22DAH或225BH<br>退出读D状态:给任意地址写F0H<br><strong>UBOOT怎么操作：</strong></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">2440</span>的A1接到NOR的A0,所以2440发出<span class="token punctuation">(</span>555h<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span>,NMORオ能收到555h这个地址。<span class="token punctuation">(</span>CPU总认为一个地址对应一个Byte，而16位宽的nor一个地址对应两个Byte，所以CPU A0不接<span class="token punctuation">)</span>往地址AAAH写AAHmw.w aaa aa往地址554写55Hmw.w <span class="token number">554</span> <span class="token number">55</span>往地址AAAH写90Hmw.w aaa <span class="token number">90</span>读0地址得到厂家ID:C2Hmd.w <span class="token number">0</span> <span class="token number">1</span>读2地址得到设备ID:22DAH或225BHmd.w <span class="token number">2</span> <span class="token number">1</span>退出读ID状态:mw.w <span class="token number">0</span> f0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/images/20200512114032991.png"><br>nor数据手册MX29LV160DBTI，往任意地址写F0复位；可以配置位宽，word（16）或者byte（8）。<br><img src="/images/20200512122454367.png"></p><h2 id="3-CFI接口（commom-flash-interface）读取nor的信息电压容量时间参数"><a href="#3-CFI接口（commom-flash-interface）读取nor的信息电压容量时间参数" class="headerlink" title="3. CFI接口（commom flash interface）读取nor的信息电压容量时间参数"></a>3. CFI接口（commom flash interface）读取nor的信息电压容量时间参数</h2><p>通用的norflash接口，CFI。<br><img src="/images/20200512122921720.png"><br><img src="/images/20200512123106889.png"></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">2440</span>的A1接到NOR的A0,所以2440发出<span class="token punctuation">(</span>555h<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span>,NMORオ能收到555h这个地址。进入CFエ模式往AH写入98Hmw.w aa <span class="token number">98</span>读数据读20H得到0051md.w <span class="token number">20</span> <span class="token number">1</span>读22H得到0052md.w <span class="token number">22</span> <span class="token number">1</span>读24H得到0059md.w <span class="token number">24</span> <span class="token number">1</span>退出CFI模式mw.w <span class="token number">0</span> f0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/images/20200512124604745.png"></p><h2 id="4-写数据"><a href="#4-写数据" class="headerlink" title="4. 写数据"></a>4. 写数据</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">这样直接写不对，，，需要先进入program模式，md.w <span class="token number">100000</span> <span class="token number">1</span>读1M地址的数据，因为uboot在1M以内mw.w <span class="token number">100000</span> <span class="token number">1234</span>往1M地址写入，（nor不能直接写，写入不了）md.w <span class="token number">100000</span> <span class="token number">1</span>没有变化，不能像内存一样写入<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/images/20200512131539806.png"><br>根据数据手册，如何进program模式，<br><img src="/images/20200512131043318.png"></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">NOR手册:往地址555H写AAH往地址2AAH写55H往地址555H写AOH往地址PA写PD2440的A1接到MOR的A0,所以2440发出<span class="token punctuation">(</span>555h<span class="token operator">&lt;</span><span class="token number">1</span><span class="token punctuation">)</span>,MoR才能收到555h这个地址.UBOOT怎么操作：往地址AAAH写AAHmw.w aaa aa往地址554H写55Hmw.w <span class="token number">554</span><span class="token number">55</span>往地址AAAH写AOHmw.w aaa a0往地址0x100000写1234hmw.w <span class="token number">100000</span> <span class="token number">1234</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/images/20200512131632625.png"></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第19课 3 NAND驱动程序编写 cpu与nand的引脚电平时序对应，add_mtd_partitions，nfs启动-加载nand驱动-格式化nand-挂接</title>
      <link href="2021/05/14/wds2-qi-di-19-ke-3-nand-qu-dong-cheng-xu-bian-xie-cpu-yu-nand-de-yin-jiao-dian-ping-shi-xu-dui-ying-add-mtd-partitions-nfs-qi-dong-jia-zai-nand-qu-dong-ge-shi-hua-nand-gua-jie-local/"/>
      <url>2021/05/14/wds2-qi-di-19-ke-3-nand-qu-dong-cheng-xu-bian-xie-cpu-yu-nand-de-yin-jiao-dian-ping-shi-xu-dui-ying-add-mtd-partitions-nfs-qi-dong-jia-zai-nand-qu-dong-ge-shi-hua-nand-gua-jie-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]<br>参考：<br><code>drivers\mtd\nand\s3c2410.c</code><br><code>drivers\mtd\nand\at91_nand.c</code></p><h1 id="设置电平维持时间的寄存器，需要将cpu和nand对应看"><a href="#设置电平维持时间的寄存器，需要将cpu和nand对应看" class="headerlink" title="设置电平维持时间的寄存器，需要将cpu和nand对应看"></a>设置电平维持时间的寄存器，需要将cpu和nand对应看</h1><p>2440手册 ，P225，<br><img src="/images/20200428171852526.png"><br>2440手册nand P217，<br><img src="/images/20200428172136403.png"><br>NAND的手册K9F2G08U0C(NAND FLASH).pdf上 P19<br><img src="/images/202004281816496.png"><br>NAND的手册K9F2G08U0C(NAND FLASH).pdf上， P12，<br><img src="/images/20200428181706232.png"><br><img src="/images/20200428211842945.png"></p><h1 id="代码2-代码1是need-sth这里没有"><a href="#代码2-代码1是need-sth这里没有" class="headerlink" title="代码2 代码1是need_sth这里没有"></a>代码2 代码1是need_sth这里没有</h1><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/ioport.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/delay.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/err.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/clk.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mtd/mtd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mtd/nand.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mtd/nand_ecc.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mtd/partitions.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/regs-nand.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/nand.h></span></span><span class="token keyword">struct</span> <span class="token class-name">s3c2440_nand_regs</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfconf  <span class="token punctuation">;</span> <span class="token comment">// 0x4E000000</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfcont  <span class="token punctuation">;</span> <span class="token comment">// 0x4E000004</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfcmd   <span class="token punctuation">;</span> <span class="token comment">// 0x4E000008</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfaddr  <span class="token punctuation">;</span> <span class="token comment">// 0x4E00000C</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfdata  <span class="token punctuation">;</span> <span class="token comment">// 0x4E000010</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfmecc0 <span class="token punctuation">;</span> <span class="token comment">// 0x4E000014</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfmecc1 <span class="token punctuation">;</span> <span class="token comment">// 0x4E000018</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfsecc  <span class="token punctuation">;</span> <span class="token comment">// 0x4E00001C</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfstat  <span class="token punctuation">;</span> <span class="token comment">// 0x4E000020</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfestat0<span class="token punctuation">;</span> <span class="token comment">// 0x4E000024</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfestat1<span class="token punctuation">;</span> <span class="token comment">// 0x4E000028</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfmecc0 <span class="token punctuation">;</span> <span class="token comment">// 0x4E00002C</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfmecc1 <span class="token punctuation">;</span> <span class="token comment">// 0x4E000030</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfsecc  <span class="token punctuation">;</span> <span class="token comment">// 0x4E000034</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfsblk  <span class="token punctuation">;</span> <span class="token comment">// 0x4E000038</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfeblk  <span class="token punctuation">;</span> <span class="token comment">// 0x4E00003C</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">struct</span> <span class="token class-name">s3c2440_nand_regs</span> <span class="token operator">*</span>s3c_nand_regs<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">nand_chip</span> <span class="token operator">*</span>s3c_nand<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>s3c_mtd<span class="token punctuation">;</span><span class="token comment">// nand片选</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">s3c2440_select_chip</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd<span class="token punctuation">,</span> <span class="token keyword">int</span> chipnr<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 片选</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>chipnr <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         <span class="token comment">// 取消选中芯片 NFCONT[1] 为1</span>        s3c_nand_regs<span class="token operator">-></span>nfcont <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>         <span class="token comment">// 选中芯片 NFCONT[1] 为0</span>        s3c_nand_regs<span class="token operator">-></span>nfcont <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// 发命令或者地址</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">s3c2440_cmd_ctrl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd<span class="token punctuation">,</span> <span class="token keyword">int</span> dat<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> ctrl<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctrl <span class="token operator">&amp;</span> NAND_CLE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 发命令</span>        <span class="token comment">// NFCMMD = dat</span>        s3c_nand_regs<span class="token operator">-></span>nfcmd  <span class="token operator">=</span> dat<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>               <span class="token comment">// 发地址</span>        <span class="token comment">// NFADDR = dat</span>        s3c_nand_regs<span class="token operator">-></span>nfcmd  <span class="token operator">=</span> dat<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// 判断状态</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">s3c2440_dev_ready</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 返回NFSTAT的bit0</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>s3c_nand_regs<span class="token operator">-></span>nfstat <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">s3c_nand_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">clk</span> <span class="token operator">*</span>nand_clk<span class="token punctuation">;</span>    <span class="token comment">// 1.分配一个nand_chip结构体</span>s3c_nand <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">nand_chip</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3.硬件相关操作 nand寄存器地址映射</span>    s3c_nand_regs <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span><span class="token number">0x4E000000</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">s3c2440_nand_regs</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 2.设置nand_chip, nand_chip是给nand_scan函数用，</span>        <span class="token comment">// 可以先看nand_scan怎么用nand_chip的，再去设置</span>        <span class="token comment">// nand_chip应该提供 选中、发命令、地址、数据，读数据、判断状态 功能</span>    s3c_nand<span class="token operator">-></span>select_chip <span class="token operator">=</span> s3c2440_select_chip<span class="token punctuation">;</span><span class="token comment">// 默认的选择函数不能用需要自己写</span>    s3c_nand<span class="token operator">-></span>cmdfunc   <span class="token operator">=</span> s3c2440_cmd_ctrl<span class="token punctuation">;</span>     <span class="token comment">// 默认的会调用nand_chip->cmdfunc，这里也需要构造</span>    s3c_nand<span class="token operator">-></span>IO_ADDR_R <span class="token operator">=</span> s3c_nand_regs<span class="token operator">-></span>nfdata<span class="token punctuation">;</span><span class="token comment">// 读取数据 NFDATA的虚拟地址 </span>    s3c_nand<span class="token operator">-></span>IO_ADDR_W <span class="token operator">=</span> s3c_nand_regs<span class="token operator">-></span>nfdata<span class="token punctuation">;</span><span class="token comment">// 写入数据</span>    s3c_nand<span class="token operator">-></span>dev_ready <span class="token operator">=</span> s3c2440_dev_ready<span class="token punctuation">;</span>    <span class="token comment">// 判断状态</span>    <span class="token comment">// 3.硬件相关操作 电平维持时间</span>        <span class="token comment">// 使能nand控制器的时钟，后面才能读写寄存器</span>nand_clk <span class="token operator">=</span> <span class="token function">clk_get</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"nand"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">clk_enable</span><span class="token punctuation">(</span>nand_clk<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// CLKCON的bit4</span>        <span class="token comment">// HCLK=100MHz, 10ns</span>        <span class="token comment">// TACLS: 发出CLE/ALE之后隔多久发出nWE信号，</span>        <span class="token comment">//  从nand手册计算得知CLE/ALE与nWE可以同时，所以TACLS=0</span>        <span class="token comment">// TWRPH0: nWE的脉冲宽度，HCLK x ( TWRPH0 + 1 )</span>        <span class="token comment">//  从nand手册知>=12ns,所以TWRPH0=1</span>        <span class="token comment">// TWRPH1: nWE变为高电平后CLE/ALE才能变为低电平，</span>        <span class="token comment">//  从nand手册知>=5ns，所以TWRPH1>=0</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TACLS</span>   <span class="token expression"><span class="token number">0</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TWRPH0</span>  <span class="token expression"><span class="token number">1</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TWRPH1</span>  <span class="token expression"><span class="token number">0</span></span></span>    s3c_nand_regs<span class="token operator">-></span>nfconf <span class="token operator">=</span> <span class="token punctuation">(</span>TACLS<span class="token operator">&lt;&lt;</span><span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>TWRPH0<span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>TWRPH1<span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// NFCONF 取消片选，使能nand控制器 </span>        <span class="token comment">//  bit1为1 取消片选</span>        <span class="token comment">//  bit0为1 使能nand控制器</span>    s3c_nand_regs<span class="token operator">-></span>nfcont <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4.使用 nand_scan，nand_scan识别nand，构造mtd_info（包含读写擦除等方法）</span>    s3c_mtd <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>    s3c_mtd<span class="token operator">-></span>priv   <span class="token operator">=</span> s3c_nand<span class="token punctuation">;</span> <span class="token comment">// mtd与nand_chip联系</span>    s3c_mtd<span class="token operator">-></span>owner  <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>     <span class="token function">nand_scan</span><span class="token punctuation">(</span>s3c_mtd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1个芯片</span>    <span class="token comment">// 5.add_mtd_partitions</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">s3c_nand_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">kfree</span><span class="token punctuation">(</span>s3c_mtd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">iounmap</span><span class="token punctuation">(</span>s3c_nand_regs<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">kfree</span><span class="token punctuation">(</span>s3c_nand<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>s3c_nand_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>s3c_nand_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="实验2-nand识别-没有add-mtd-partitions函数"><a href="#实验2-nand识别-没有add-mtd-partitions函数" class="headerlink" title="实验2 nand识别 没有add_mtd_partitions函数"></a>实验2 nand识别 没有add_mtd_partitions函数</h1><p><img src="/images/20200428203800118.png"><br>有个NAND_ECC_NONE警告。因为没有使用ECC校验。</p><h2 id="nand位反转-解决办法ECC码"><a href="#nand位反转-解决办法ECC码" class="headerlink" title="nand位反转 解决办法ECC码"></a>nand位反转 解决办法ECC码</h2><p><img src="/images/20200428215149812.png"></p><p>nand每页（2K）之外还有不参与编址的OOB区（64字节，out of bank），<br>在读每页数据时可能某位发生反转，需要用ECC校验。ECC不仅可以<strong>知道是否数据有误</strong>还能<strong>计算出具体的bit反转</strong>。</p><h3 id="解决反转"><a href="#解决反转" class="headerlink" title="解决反转"></a>解决反转</h3><p>在写入时：</p><ol><li>按page写入</li><li>生成ECC码</li><li>保存ECC码到OOB区</li></ol><p>在读出数据时：</p><ol><li>按page读取</li><li>读取OOB的ECC</li><li>计算page的ECC码</li><li>比较两个ECC</li><li>校验</li></ol><p>解决位反转有硬件和软件的方法，这里用软件的方法，在程序2上添加一行代码行，<code>s3c_nand-&gt;ecc.mode  = NAND_ECC_SOFT;</code></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">s3c_nand<span class="token operator">-></span>select_chip <span class="token operator">=</span> s3c2440_select_chip<span class="token punctuation">;</span><span class="token comment">// 默认的选择函数不能用需要自己写</span>s3c_nand<span class="token operator">-></span>cmdfunc   <span class="token operator">=</span> s3c2440_cmd_ctrl<span class="token punctuation">;</span>     <span class="token comment">// 默认的会调用nand_chip->cmdfunc，这里也需要构造</span>s3c_nand<span class="token operator">-></span>IO_ADDR_R <span class="token operator">=</span> s3c_nand_regs<span class="token operator">-></span>nfdata<span class="token punctuation">;</span><span class="token comment">// 读取数据 NFDATA的虚拟地址 </span>s3c_nand<span class="token operator">-></span>IO_ADDR_W <span class="token operator">=</span> s3c_nand_regs<span class="token operator">-></span>nfdata<span class="token punctuation">;</span><span class="token comment">// 写入数据</span>s3c_nand<span class="token operator">-></span>dev_ready <span class="token operator">=</span> s3c2440_dev_ready<span class="token punctuation">;</span>    <span class="token comment">// 判断状态</span>s3c_nand<span class="token operator">-></span>ecc<span class="token punctuation">.</span>mode  <span class="token operator">=</span> NAND_ECC_SOFT<span class="token punctuation">;</span>        <span class="token comment">// 软件的方法ECC校验 // 添加这一行就行</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>重新装载警告消失，<br><img src="/images/20200428215038812.png"></p><h1 id="代码3-完善add-mtd-partitions函数"><a href="#代码3-完善add-mtd-partitions函数" class="headerlink" title="代码3 完善add_mtd_partitions函数"></a>代码3 完善add_mtd_partitions函数</h1><p><img src="/images/20200429142256309.png"></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">arch\arm\plat<span class="token operator">-</span>s3c24xx\common<span class="token operator">-</span>smdk<span class="token punctuation">.</span>c分区名称操作<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">mtd_partition</span> smdk_default_nand_part<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">.</span>name   <span class="token operator">=</span> <span class="token string">"bootloader"</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span>size   <span class="token operator">=</span> <span class="token number">0x00040000</span><span class="token punctuation">,</span><span class="token punctuation">.</span>offset<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">.</span>name   <span class="token operator">=</span> <span class="token string">"params"</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span>offset <span class="token operator">=</span> MTDPART_OFS_APPEND<span class="token punctuation">,</span>        <span class="token punctuation">.</span>size   <span class="token operator">=</span> <span class="token number">0x00020000</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">.</span>name   <span class="token operator">=</span> <span class="token string">"kernel"</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span>offset <span class="token operator">=</span> MTDPART_OFS_APPEND<span class="token punctuation">,</span>        <span class="token punctuation">.</span>size   <span class="token operator">=</span> <span class="token number">0x00200000</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">.</span>name   <span class="token operator">=</span> <span class="token string">"root"</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span>offset <span class="token operator">=</span> MTDPART_OFS_APPEND<span class="token punctuation">,</span>        <span class="token punctuation">.</span>size   <span class="token operator">=</span> MTDPART_SIZ_FULL<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>代码3，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/ioport.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/delay.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/err.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/clk.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mtd/mtd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mtd/nand.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mtd/nand_ecc.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mtd/partitions.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/regs-nand.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/nand.h></span></span><span class="token keyword">struct</span> <span class="token class-name">s3c2440_nand_regs</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfconf  <span class="token punctuation">;</span> <span class="token comment">// 0x4E000000</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfcont  <span class="token punctuation">;</span> <span class="token comment">// 0x4E000004</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfcmd   <span class="token punctuation">;</span> <span class="token comment">// 0x4E000008</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfaddr  <span class="token punctuation">;</span> <span class="token comment">// 0x4E00000C</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfdata  <span class="token punctuation">;</span> <span class="token comment">// 0x4E000010</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfmecc0 <span class="token punctuation">;</span> <span class="token comment">// 0x4E000014</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfmecc1 <span class="token punctuation">;</span> <span class="token comment">// 0x4E000018</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfsecc  <span class="token punctuation">;</span> <span class="token comment">// 0x4E00001C</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfstat  <span class="token punctuation">;</span> <span class="token comment">// 0x4E000020</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfestat0<span class="token punctuation">;</span> <span class="token comment">// 0x4E000024</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfestat1<span class="token punctuation">;</span> <span class="token comment">// 0x4E000028</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfmecc0 <span class="token punctuation">;</span> <span class="token comment">// 0x4E00002C</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfmecc1 <span class="token punctuation">;</span> <span class="token comment">// 0x4E000030</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfsecc  <span class="token punctuation">;</span> <span class="token comment">// 0x4E000034</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfsblk  <span class="token punctuation">;</span> <span class="token comment">// 0x4E000038</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfeblk  <span class="token punctuation">;</span> <span class="token comment">// 0x4E00003C</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">struct</span> <span class="token class-name">s3c2440_nand_regs</span> <span class="token operator">*</span>s3c_nand_regs<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">nand_chip</span> <span class="token operator">*</span>s3c_nand<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>s3c_mtd<span class="token punctuation">;</span> <span class="token comment">// mtd_info包含了nand的通用读取写入的方法</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">mtd_partition</span> s3c_nand_part<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 用于nand分区的数组</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">.</span>name   <span class="token operator">=</span> <span class="token string">"bootloader"</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span>size   <span class="token operator">=</span> <span class="token number">0x00040000</span><span class="token punctuation">,</span><span class="token punctuation">.</span>offset<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">.</span>name   <span class="token operator">=</span> <span class="token string">"params"</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span>offset <span class="token operator">=</span> MTDPART_OFS_APPEND<span class="token punctuation">,</span> <span class="token comment">// 紧跟上面的分区</span>        <span class="token punctuation">.</span>size   <span class="token operator">=</span> <span class="token number">0x00020000</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">.</span>name   <span class="token operator">=</span> <span class="token string">"kernel"</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span>offset <span class="token operator">=</span> MTDPART_OFS_APPEND<span class="token punctuation">,</span>        <span class="token punctuation">.</span>size   <span class="token operator">=</span> <span class="token number">0x00200000</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">.</span>name   <span class="token operator">=</span> <span class="token string">"root"</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span>offset <span class="token operator">=</span> MTDPART_OFS_APPEND<span class="token punctuation">,</span>        <span class="token punctuation">.</span>size   <span class="token operator">=</span> MTDPART_SIZ_FULL<span class="token punctuation">,</span> <span class="token comment">// 剩下的所有都是该分区</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// nand片选</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">s3c2440_select_chip</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd<span class="token punctuation">,</span> <span class="token keyword">int</span> chipnr<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 片选</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>chipnr <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         <span class="token comment">// 取消选中芯片 NFCONT[1] 为1</span>        s3c_nand_regs<span class="token operator">-></span>nfcont <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>         <span class="token comment">// 选中芯片 NFCONT[1] 为0</span>        s3c_nand_regs<span class="token operator">-></span>nfcont <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// 发命令或者地址</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">s3c2440_cmd_ctrl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd<span class="token punctuation">,</span> <span class="token keyword">int</span> dat<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> ctrl<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctrl <span class="token operator">&amp;</span> NAND_CLE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 发命令</span>        <span class="token comment">// NFCMMD = dat</span>        s3c_nand_regs<span class="token operator">-></span>nfcmd  <span class="token operator">=</span> dat<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>               <span class="token comment">// 发地址</span>        <span class="token comment">// NFADDR = dat</span>        s3c_nand_regs<span class="token operator">-></span>nfcmd  <span class="token operator">=</span> dat<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// 判断状态</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">s3c2440_dev_ready</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span> <span class="token operator">*</span>mtd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 返回NFSTAT的bit0</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>s3c_nand_regs<span class="token operator">-></span>nfstat <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">s3c_nand_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">clk</span> <span class="token operator">*</span>nand_clk<span class="token punctuation">;</span>    <span class="token comment">// 1.分配一个nand_chip结构体</span>s3c_nand <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">nand_chip</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3.硬件相关操作 nand寄存器地址映射</span>    s3c_nand_regs <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span><span class="token number">0x4E000000</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">s3c2440_nand_regs</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 2.设置nand_chip, nand_chip是给nand_scan函数用，</span>        <span class="token comment">// 可以先看nand_scan怎么用nand_chip的，再去设置</span>        <span class="token comment">// nand_chip应该提供 选中、发命令、地址、数据，读数据、判断状态 功能</span>    s3c_nand<span class="token operator">-></span>select_chip <span class="token operator">=</span> s3c2440_select_chip<span class="token punctuation">;</span><span class="token comment">// 默认的选择函数不能用需要自己写</span>    s3c_nand<span class="token operator">-></span>cmdfunc   <span class="token operator">=</span> s3c2440_cmd_ctrl<span class="token punctuation">;</span>     <span class="token comment">// 默认的会调用nand_chip->cmdfunc，这里也需要构造</span>    s3c_nand<span class="token operator">-></span>IO_ADDR_R <span class="token operator">=</span> s3c_nand_regs<span class="token operator">-></span>nfdata<span class="token punctuation">;</span><span class="token comment">// 读取数据 NFDATA的虚拟地址 </span>    s3c_nand<span class="token operator">-></span>IO_ADDR_W <span class="token operator">=</span> s3c_nand_regs<span class="token operator">-></span>nfdata<span class="token punctuation">;</span><span class="token comment">// 写入数据</span>    s3c_nand<span class="token operator">-></span>dev_ready <span class="token operator">=</span> s3c2440_dev_ready<span class="token punctuation">;</span>    <span class="token comment">// 判断状态</span>    s3c_nand<span class="token operator">-></span>ecc<span class="token punctuation">.</span>mode  <span class="token operator">=</span> NAND_ECC_SOFT<span class="token punctuation">;</span>        <span class="token comment">// 软件的方法ECC校验</span>    <span class="token comment">// 3.硬件相关操作 电平维持时间</span>        <span class="token comment">// 使能nand控制器的时钟，后面才能读写寄存器</span>nand_clk <span class="token operator">=</span> <span class="token function">clk_get</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"nand"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">clk_enable</span><span class="token punctuation">(</span>nand_clk<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// CLKCON的bit4</span>        <span class="token comment">// HCLK=100MHz, 10ns</span>        <span class="token comment">// TACLS: 发出CLE/ALE之后隔多久发出nWE信号，</span>        <span class="token comment">//  从nand手册计算得知CLE/ALE与nWE可以同时，所以TACLS=0</span>        <span class="token comment">// TWRPH0: nWE的脉冲宽度，HCLK x ( TWRPH0 + 1 )</span>        <span class="token comment">//  从nand手册知>=12ns,所以TWRPH0=1</span>        <span class="token comment">// TWRPH1: nWE变为高电平后CLE/ALE才能变为低电平，</span>        <span class="token comment">//  从nand手册知>=5ns，所以TWRPH1>=0</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TACLS</span>   <span class="token expression"><span class="token number">0</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TWRPH0</span>  <span class="token expression"><span class="token number">1</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TWRPH1</span>  <span class="token expression"><span class="token number">0</span></span></span>    s3c_nand_regs<span class="token operator">-></span>nfconf <span class="token operator">=</span> <span class="token punctuation">(</span>TACLS<span class="token operator">&lt;&lt;</span><span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>TWRPH0<span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>TWRPH1<span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// NFCONF 取消片选，使能nand控制器 </span>        <span class="token comment">//  bit1为1 取消片选</span>        <span class="token comment">//  bit0为1 使能nand控制器</span>    s3c_nand_regs<span class="token operator">-></span>nfcont <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4.使用 nand_scan，nand_scan识别nand，构造mtd_info（包含读写擦除等方法）</span>    s3c_mtd <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mtd_info</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>    s3c_mtd<span class="token operator">-></span>priv   <span class="token operator">=</span> s3c_nand<span class="token punctuation">;</span> <span class="token comment">// mtd与nand_chip联系</span>    s3c_mtd<span class="token operator">-></span>owner  <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>     <span class="token function">nand_scan</span><span class="token punctuation">(</span>s3c_mtd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1个芯片</span>    <span class="token comment">// 5.add_mtd_partitions</span>        <span class="token comment">// 1struct mtd_info </span>        <span class="token comment">// 2struct mtd_partition *parts 分区结构体数据</span>        <span class="token comment">// 3 int nbparts 该结构体数组的项数</span>    <span class="token function">add_mtd_partitions</span><span class="token punctuation">(</span>s3c_mtd<span class="token punctuation">,</span> s3c_nand_part<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 需要对nand分区才用</span>    <span class="token comment">// add_mtd_device(); // 不对nand分区用add_mtd_device就行</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">s3c_nand_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">del_mtd_partitions</span><span class="token punctuation">(</span>s3c_mtd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">kfree</span><span class="token punctuation">(</span>s3c_mtd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">iounmap</span><span class="token punctuation">(</span>s3c_nand_regs<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">kfree</span><span class="token punctuation">(</span>s3c_nand<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>s3c_nand_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>s3c_nand_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="测试代码3"><a href="#测试代码3" class="headerlink" title="测试代码3"></a>测试代码3</h1><ol><li><code>make menuconfig</code>去掉内核原来的nand驱动程序，输入<code>N</code>不选，<br><img src="/images/20200429143032551.png"></li><li><code>make uImage</code> 使用新的内核启动，并且用NFS启动，因为nand驱动没有了<br>先进入uboot，<br>然后设置参数，保存save，<br>从网络文件系统下载uImages 无nand的，<br>启动kernel，在启动信息中没有nand的信息了，<br><img src="/images/20200429145524931.png"></li><li>插入nand驱动模块<br>查看mtd设备，开始没有，加载nand驱动，在查看就有了mtd设备了，分区了，<br><img src="/images/20200429145739446.png"><br>查看新的分区能否挂接，能挂街上是因为之前的nand烧好了系统，而实际可能nand是空的，需要格式化，<br><img src="/images/20200429150658534.png"></li><li>格式化nand<br>需要专门的工具，<code>mtd-utils-05.07.23.tar.bz2</code>.<br><img src="/images/20200429151630415.png"><br>其中绿色文件就是<code>mtd-utils</code>工具生成的工具，<br><img src="/images/20200429151444549.png"><br>先<code>umount /mnt</code>再擦除。用工具格式化<code>nand</code>的<code>root</code>分区，<code>erase</code>是擦除扇区，<code>erase_all</code>是擦除整个分区，擦除之和就是yaffs文件系统，<br><img src="/images/20200429151924593.png"></li><li>挂接<br><img src="/images/20200429152326998.png"><br>然后就可以在/mnt创建文件了。创建之后重启试试。</li></ol>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第19课 2 NAND驱动框架</title>
      <link href="2021/05/14/wds2-qi-di-19-ke-2-nand-qu-dong-kuang-jia-local/"/>
      <url>2021/05/14/wds2-qi-di-19-ke-2-nand-qu-dong-kuang-jia-local/</url>
      
        <content type="html"><![CDATA[<p>每一层专注自己的一小块，<br>命令层关注 具体怎么收发，<br>协议层关注 收发什么实现控制（识别 读写 擦除），<br>块设备关注 优化工作（合并 调序等），<br>字符设备直接调取mtd_info的read write就行。</p><p><strong>MTD ( Memory Technology Device)存储技术设备</strong><br><img src="/images/20200428101810540.png"><br>查看内核启动信息，从这里开始分析，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">drivers\mtd\nand\s3c2410<span class="token punctuation">.</span>c<span class="token string">"S3C24XX NAND Driver, (c) 2004 Simtec Electronics"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/images/20200425101709357.png"><br>bus drv dev用的总线驱动设备模型，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">drivers\mtd\nand\s3c2410<span class="token punctuation">.</span>c<span class="token comment">// 入口函数</span><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">s3c2410_nand_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"S3C24XX NAND Driver, (c) 2004 Simtec Electronics\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">platform_driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s3c2412_nand_driver<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注册平台驱动</span><span class="token function">platform_driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s3c2440_nand_driver<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token function">platform_driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s3c2410_nand_driver<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">platform_driver</span> s3c2412_nand_driver <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>probe<span class="token operator">=</span> s3c2412_nand_probe<span class="token punctuation">,</span><span class="token punctuation">.</span>remove<span class="token operator">=</span> s3c2410_nand_remove<span class="token punctuation">,</span><span class="token punctuation">.</span>suspend<span class="token operator">=</span> s3c24xx_nand_suspend<span class="token punctuation">,</span><span class="token punctuation">.</span>resume<span class="token operator">=</span> s3c24xx_nand_resume<span class="token punctuation">,</span><span class="token punctuation">.</span>driver<span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>name<span class="token operator">=</span> <span class="token string">"s3c2412-nand"</span><span class="token punctuation">,</span> <span class="token comment">// 会在probe中匹配name</span><span class="token punctuation">.</span>owner<span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// probe函数的大致步骤</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">s3c24xx_nand_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">,</span>      <span class="token keyword">enum</span> <span class="token class-name">s3c_cpu_type</span> cpu_type<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>err <span class="token operator">=</span> <span class="token function">s3c2410_nand_inithw</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> pdev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化硬件</span><span class="token function">s3c2410_nand_init_chip</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> nmtd<span class="token punctuation">,</span> sets<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化芯片</span><span class="token comment">// =============================================</span><span class="token comment">// 根据nand_chip的底层操作函数识别nand，构造=====mtd_info====</span><span class="token function">nand_scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>nmtd<span class="token operator">-></span>mtd<span class="token punctuation">,</span> <span class="token punctuation">(</span>sets<span class="token punctuation">)</span> <span class="token operator">?</span> sets<span class="token operator">-></span>nr_chips <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// drivers\mtd\nand\nand_base.c</span><span class="token comment">// =============================================</span><span class="token function">nand_scan_ident</span><span class="token punctuation">(</span>mtd<span class="token punctuation">,</span> maxchips<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">nand_set_defaults</span><span class="token punctuation">(</span>chip<span class="token punctuation">,</span> busw<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 片选</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>chip<span class="token operator">-></span>select_chip<span class="token punctuation">)</span> <span class="token comment">// 默认芯片选择没有做什么，不能用</span>chip<span class="token operator">-></span>select_chip <span class="token operator">=</span> nand_select_chip<span class="token punctuation">;</span><span class="token comment">// 发命令发地址</span><span class="token keyword">if</span> <span class="token punctuation">(</span>chip<span class="token operator">-></span>cmdfunc <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>chip<span class="token operator">-></span>cmdfunc <span class="token operator">=</span> nand_command<span class="token punctuation">;</span> <span class="token comment">// 默认cmd会调用chip->cmd_ctrl</span>chip<span class="token operator">-></span><span class="token function">cmd_ctrl</span><span class="token punctuation">(</span>mtd<span class="token punctuation">,</span> command<span class="token punctuation">,</span> ctrl<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 读数据</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>chip<span class="token operator">-></span>read_byte<span class="token punctuation">)</span> chip<span class="token operator">-></span>read_byte <span class="token operator">=</span> busw <span class="token operator">?</span> nand_read_byte16 <span class="token operator">:</span> nand_read_byte<span class="token punctuation">;</span>nand_read_byte <span class="token comment">// 总线宽度是8 所以nand_read_byte</span><span class="token function">readb</span><span class="token punctuation">(</span>chip<span class="token operator">-></span>IO_ADDR_R<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// chip->IO_ADDR_R 数据寄存器的虚拟地址</span><span class="token comment">// 读数据</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>chip<span class="token operator">-></span>read_buf<span class="token punctuation">)</span>chip<span class="token operator">-></span>read_buf <span class="token operator">=</span> busw <span class="token operator">?</span> nand_read_buf16 <span class="token operator">:</span> nand_read_buf<span class="token punctuation">;</span>nand_write_buf <span class="token comment">// 总线宽度是8 所以nand_write_buf</span><span class="token function">writeb</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> chip<span class="token operator">-></span>IO_ADDR_W<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 往这里写chip->IO_ADDR_W</span><span class="token comment">// 判断状态</span><span class="token keyword">if</span> <span class="token punctuation">(</span>chip<span class="token operator">-></span>waitfunc <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>chip<span class="token operator">-></span>waitfunc <span class="token operator">=</span> nand_wait<span class="token punctuation">;</span>chip<span class="token operator">-></span><span class="token function">dev_ready</span><span class="token punctuation">(</span>mtd<span class="token punctuation">)</span> <span class="token comment">// 需要这个函数 </span><span class="token function">nand_get_flash_type</span><span class="token punctuation">(</span>mtd<span class="token punctuation">,</span> chip<span class="token punctuation">,</span> busw<span class="token punctuation">,</span> <span class="token operator">&amp;</span>nand_maf_id<span class="token punctuation">)</span><span class="token punctuation">;</span>chip<span class="token operator">-></span><span class="token function">select_chip</span><span class="token punctuation">(</span>mtd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>chip<span class="token operator">-></span><span class="token function">cmdfunc</span><span class="token punctuation">(</span>mtd<span class="token punctuation">,</span> NAND_CMD_READID<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取id的命令</span><span class="token comment">/* Read manufacturer and device IDs */</span><span class="token operator">*</span>maf_id <span class="token operator">=</span> chip<span class="token operator">-></span><span class="token function">read_byte</span><span class="token punctuation">(</span>mtd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 读取制造商信息id</span>dev_id <span class="token operator">=</span> chip<span class="token operator">-></span><span class="token function">read_byte</span><span class="token punctuation">(</span>mtd<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 设备id</span><span class="token function">nand_scan_tail</span><span class="token punctuation">(</span>mtd<span class="token punctuation">)</span><span class="token punctuation">;</span>mtd<span class="token operator">-></span>erase <span class="token operator">=</span> nand_erase<span class="token punctuation">;</span> <span class="token comment">// struct mtd_info *mtd</span>mtd<span class="token operator">-></span>read <span class="token operator">=</span> nand_read<span class="token punctuation">;</span>mtd<span class="token operator">-></span>write <span class="token operator">=</span> nand_write<span class="token punctuation">;</span><span class="token function">nand_get_flash_type</span><span class="token punctuation">(</span>mtd<span class="token punctuation">,</span> chip<span class="token punctuation">,</span> busw<span class="token punctuation">,</span> <span class="token operator">&amp;</span>nand_maf_id<span class="token punctuation">)</span><span class="token punctuation">;</span>chip<span class="token operator">-></span><span class="token function">select_chip</span><span class="token punctuation">(</span>mtd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 选中芯片</span>chip<span class="token operator">-></span><span class="token function">cmdfunc</span><span class="token punctuation">(</span>mtd<span class="token punctuation">,</span> NAND_CMD_READID<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发出命令 Send the command for reading device ID</span><span class="token operator">*</span>maf_id <span class="token operator">=</span> chip<span class="token operator">-></span><span class="token function">read_byte</span><span class="token punctuation">(</span>mtd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取厂家id </span>dev_id <span class="token operator">=</span> chip<span class="token operator">-></span><span class="token function">read_byte</span><span class="token punctuation">(</span>mtd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取设备id  0xda </span><span class="token comment">// Lookup the flash id 在数组里比较设备id</span><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> nand_flash_ids<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>dev_id <span class="token operator">==</span> nand_flash_ids<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>type <span class="token operator">=</span>  <span class="token operator">&amp;</span>nand_flash_ids<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token function">s3c2410_nand_add_partition</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> nmtd<span class="token punctuation">,</span> sets<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">add_mtd_device</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mtd<span class="token operator">-></span>mtd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 添加分区添加设备 通知两个user 字符和块设备</span><span class="token function">list_for_each</span><span class="token punctuation">(</span>this<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mtd_notifiers<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 这个链表在哪里设置呢mtd_notifiers，我们才知道add是干嘛的 drivers\mtd\mtdcore.c</span><span class="token comment">// 在register_mtd_user中添加，</span><span class="token comment">// register_mtd_user 在drivers\mtd\mtd_blkdevs.c </span><span class="token comment">// drivers\mtd\mtdchar.c 都有调用。nand即可当作字符设备也可块设备 </span><span class="token comment">// 最终导致mtd_notify_add和blktrans_notify_add被调用</span><span class="token keyword">struct</span> <span class="token class-name">mtd_notifier</span> <span class="token operator">*</span>not <span class="token operator">=</span> <span class="token function">list_entry</span><span class="token punctuation">(</span>this<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">mtd_notifier</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>not<span class="token operator">-></span><span class="token function">add</span><span class="token punctuation">(</span>mtd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// mtd_notify_add和blktrans_notify_add</span><span class="token comment">// 先看字符设备 mtd_notify_add ，字符设备那一套</span><span class="token function">class_device_create</span><span class="token punctuation">(</span>mtd_class<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>MTD_CHAR_MAJOR<span class="token punctuation">,</span> mtd<span class="token operator">-></span>index<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// 再看块设备 blktrans_notify_add</span><span class="token function">list_for_each</span><span class="token punctuation">(</span>this<span class="token punctuation">,</span> <span class="token operator">&amp;</span>blktrans_majors<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// blktrans_majors这个链表在哪里设置呢,register_mtd_blktrans, register_mtd_blktrans被drivers\mtd\mtdblock.c和drivers\mtd\mtdblock_ro.c调用。 mtdblock_add_mtd </span><span class="token keyword">struct</span> <span class="token class-name">mtd_blktrans_ops</span> <span class="token operator">*</span>tr <span class="token operator">=</span> <span class="token function">list_entry</span><span class="token punctuation">(</span>this<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">mtd_blktrans_ops</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>tr<span class="token operator">-></span><span class="token function">add_mtd</span><span class="token punctuation">(</span>tr<span class="token punctuation">,</span> mtd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">mtdblock_add_mtd</span> <span class="token punctuation">(</span>drivers\mtd\mtdblock<span class="token punctuation">.</span>c<span class="token punctuation">)</span>add_mtd_blktrans_dev <span class="token comment">// drivers\mtd\mtd_blkdevs.c</span>alloc_diskset_capacitygd<span class="token operator">-></span>queue <span class="token operator">=</span> tr<span class="token operator">-></span>blkcore_priv<span class="token operator">-></span>rq<span class="token punctuation">;</span>add_disk<span class="token punctuation">&#125;</span>    <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"mtd%d"</span><span class="token punctuation">,</span> mtd<span class="token operator">-></span>index<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">struct</span> <span class="token class-name">nand_flash_dev</span> nand_flash_ids<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_MTD_NAND_MUSEUM_IDS</span></span><span class="token punctuation">&#123;</span><span class="token string">"NAND 1MiB 5V 8-bit"</span><span class="token punctuation">,</span><span class="token number">0x6e</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token comment">/* 2 Gigabit */</span><span class="token punctuation">&#123;</span><span class="token string">"NAND 256MiB 1,8V 8-bit"</span><span class="token punctuation">,</span><span class="token number">0xAA</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> LP_OPTIONS<span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">"NAND 256MiB 3,3V 8-bit"</span><span class="token punctuation">,</span><span class="token number">0xDA</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> LP_OPTIONS<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// nand 对应参数</span>drivers\mtd\mtdchar<span class="token punctuation">.</span>c<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">mtd_notifier</span> notifier <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>add<span class="token operator">=</span> mtd_notify_add<span class="token punctuation">,</span><span class="token punctuation">.</span>remove<span class="token operator">=</span> mtd_notify_remove<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>drivers\mtd\mtd_blkdevs<span class="token punctuation">.</span>c<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">mtd_notifier</span> blktrans_notifier <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>add <span class="token operator">=</span> blktrans_notify_add<span class="token punctuation">,</span><span class="token punctuation">.</span>remove <span class="token operator">=</span> blktrans_notify_remove<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>nand协议只知道收发什么（命令 地址 数据），硬件相关只知道怎么收发（命令 地址 数据）。<br>三星写的很啰嗦，一个简单的例子<code>drivers\mtd\nand\at91_nand.c</code>。</p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第19课 1 NAND原理及硬件操作 通过命令在uboot中操作NAND 连续发送5个周期的地址值</title>
      <link href="2021/05/14/wds2-qi-di-19-ke-1-nand-yuan-li-ji-ying-jian-cao-zuo-tong-guo-ming-ling-zai-uboot-zhong-cao-zuo-nand-lian-xu-fa-song-5-ge-zhou-qi-de-di-zhi-zhi-local/"/>
      <url>2021/05/14/wds2-qi-di-19-ke-1-nand-yuan-li-ji-ying-jian-cao-zuo-tong-guo-ming-ling-zai-uboot-zhong-cao-zuo-nand-lian-xu-fa-song-5-ge-zhou-qi-de-di-zhi-zhi-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">app：open read write <span class="token string">"xxx.txt"</span><span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> 文件的读写文件系统：vfat、ext2、ext3、yaffs2、jffs2 （把文件的读写转换成对扇区的读写）<span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> ll_rw_block <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> 扇区的读写<span class="token number">1.</span>把读写放入队列，<span class="token number">2.</span>调用队列的处理函数（调顺序、合并等优化）块设备驱动程序<span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> 硬件：硬盘、Flash<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>分配<code>gendisk</code>结构体 <code>alloc_disk</code></li><li>设置</li><li>1 分配/设置队列：<code>request_queue_t</code>  // 提供读写能力 <code>blk_init_queue</code></li><li>2 设置<code>gendisk</code>其他信息 // 它提供属性，如容量</li><li>注册：<code>add_disk</code></li></ol><h1 id="nand的引脚-和-操作-命令-地址-数据-读写"><a href="#nand的引脚-和-操作-命令-地址-数据-读写" class="headerlink" title="nand的引脚 和 操作 命令-地址-数据-读写"></a>nand的引脚 和 操作 命令-地址-数据-读写</h1><p>nand flash是存储芯片，DATA0~DATA7即传输数据也传输地址、还有控制命令，地址本身也是数据，冯诺依曼结构。<br>ALE：依靠ALE，当ALE为高时传输地址， 为低时传输数据；<br><strong>传输地址：当ALE为高时传输地址；<br>传输命令：当CLE为高时传输的是命令；<br>传输数据：当ALE和CLE都为低电平时传输的是数据。</strong></p><p>CE片选：DATA这些线接到了NAND、NOR、SDRAM、DM9000等，CE片选区分。<br>RnB引脚：当NAND完成烧写之后，RnB为高电平表示烧写完毕，低电平表示正忙。<br><img src="/images/20200424162458401.png"></p><h1 id="操作nand，步骤-发出命令-地址-数据-读取数据"><a href="#操作nand，步骤-发出命令-地址-数据-读取数据" class="headerlink" title="操作nand，步骤 发出命令/地址/数据 读取数据"></a>操作nand，步骤 发出命令/地址/数据 读取数据</h1><ol><li><strong>发出命令</strong><br> 选中芯片，<br> CLE高电平，<br> DATA0~DATA7上输出命令值，<br> 发出写脉冲</li><li><strong>发出地址</strong><br> 选中芯片，<br> ALE高电平，<br> DATA0~DATA7上输出地址值，<br> 发出写脉冲</li><li><strong>发送数据</strong><br> 选中芯片，<br> ALE、CLE都为低电平，<br> DATA0~DATA7上输出数据值，<br> 发出写脉冲</li><li><strong>读取数据</strong><br> 选中芯片，<br> 发出读脉冲，<br> 读取DATA0~DATA7上数据值。</li></ol><p>2440有nand控制器，nand引脚对应接到2440后，直接操作对应寄存器就行，</p><ol><li><strong>发出命令</strong> NFCMD = 命令值</li><li><strong>发出地址</strong> NFADDR = 地址值</li><li><strong>发送数据</strong> NFDATA = 数据值</li><li><strong>读取数据</strong> val = NFDATA <h1 id="读取NAND的ID的操作，"><a href="#读取NAND的ID的操作，" class="headerlink" title="读取NAND的ID的操作，"></a>读取NAND的ID的操作，</h1></li><li>选中</li><li>发出0x90命令 </li><li>发出0x00地址值 </li><li>读取数据（0xEC）</li><li>读数据（Device code）<br><img src="/images/20200424213417337.png"><h2 id="0-选中-寄存器NFCONT-0x4E000004-bit1-0"><a href="#0-选中-寄存器NFCONT-0x4E000004-bit1-0" class="headerlink" title="0. 选中 寄存器NFCONT(0x4E000004) bit1 = 0"></a>0. 选中 寄存器NFCONT(0x4E000004) bit1 = 0</h2><img src="/images/20200424214959361.png"><h2 id="1-发出0x90命令-NFCMMD-0x4E000008"><a href="#1-发出0x90命令-NFCMMD-0x4E000008" class="headerlink" title="1. 发出0x90命令 NFCMMD(0x4E000008)"></a>1. 发出0x90命令 NFCMMD(0x4E000008)</h2><img src="/images/2020042421532774.png"><h2 id="2-发出0x00地址值-NFADDR-0x4E00000C"><a href="#2-发出0x00地址值-NFADDR-0x4E00000C" class="headerlink" title="2. 发出0x00地址值  NFADDR 0x4E00000C"></a>2. 发出0x00地址值  NFADDR 0x4E00000C</h2><img src="/images/20200424215352289.png"><h2 id="3-读取数据（0xEC）NFDATA-0x4E000010"><a href="#3-读取数据（0xEC）NFDATA-0x4E000010" class="headerlink" title="3. 读取数据（0xEC）NFDATA 0x4E000010"></a>3. 读取数据（0xEC）NFDATA 0x4E000010</h2><img src="/images/20200424215437777.png"><h2 id="4-读数据（Device-code）NFDATA-0x4E000010"><a href="#4-读数据（Device-code）NFDATA-0x4E000010" class="headerlink" title="4. 读数据（Device code）NFDATA 0x4E000010"></a>4. 读数据（Device code）NFDATA 0x4E000010</h2></li></ol><h1 id="通过命令在uboot中对NAND操作"><a href="#通过命令在uboot中对NAND操作" class="headerlink" title="通过命令在uboot中对NAND操作"></a>通过命令在uboot中对NAND操作</h1><h2 id="通过命令在uboot中读取NAND的ID的操作"><a href="#通过命令在uboot中读取NAND的ID的操作" class="headerlink" title="通过命令在uboot中读取NAND的ID的操作"></a>通过命令在uboot中读取NAND的ID的操作</h2><p>所有操作，<br><img src="/images/20200424222714839.png"><br>启动开发板按<code>q</code>，不启动内核，在uboot停下。用md命令操作nand，<br><img src="/images/20200424215944393.png"><br>0 片选：读出 寄存器NFCONT(0x4E000004)<br><code>md.l 0x4E000004</code>，  <code>.l</code>表示以4字节读取，<br><code>mw.l 0x4E000004 1</code>，写入1，bit1为0<br>1 发出0x90命令 NFCMMD(0x4E000008)<br><code>mw.b 0x4E000008 0x90</code> ，<code>.b</code>写入一个字节<br>2 发出0x00地址值  NFADDR 0x4E00000C<br><code>mw.b 0x4E00000C 0x00</code><br>3 读取数据（0xEC）NFDATA 0x4E000010<br> <code>md.b 0x4E000010 1</code> ，读取1字节<br>4 退出读取id的状态。reset 0xFF  NFCMMD = 0xFF<br><code>mw.b 0x4E000008 0xFF</code><br><img src="/images/20200424221757729.png"><br>uboot测试结果对应，<br><img src="/images/20200424222016566.png"></p><h2 id="通过命令在uboot中读取NAND的读内容"><a href="#通过命令在uboot中读取NAND的读内容" class="headerlink" title="通过命令在uboot中读取NAND的读内容"></a>通过命令在uboot中读取NAND的读内容</h2><p>所有操作，<br><img src="/images/20200424222811953.png"><br>查看0地址里的内容，<code>nand dump 0</code>。<br>地址输入需要连续的5个地址，2^(8 + 20) = 256M，至少需要28位的数据才能表示所有地址，而一个周期地址为8bit，因此需要连续4个周期的地址值。为了兼容更大容量的地址，连续发送5个周期的地址值。<br><img src="/images/20200424223714623.png"><br>uboot测试结果对应，<br><img src="/images/202004242239481.png"></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第18课 3 块设备驱动程序 用内存模拟磁盘 电梯算法 读取写入 分区 格式化</title>
      <link href="2021/05/14/wds2-qi-di-18-ke-3-kuai-she-bei-qu-dong-cheng-xu-yong-nei-cun-mo-ni-ci-pan-dian-ti-suan-fa-du-qu-xie-ru-fen-qu-ge-shi-hua-local/"/>
      <url>2021/05/14/wds2-qi-di-18-ke-3-kuai-she-bei-qu-dong-cheng-xu-yong-nei-cun-mo-ni-ci-pan-dian-ti-suan-fa-du-qu-xie-ru-fen-qu-ge-shi-hua-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]<br>参考<code>drivers\block\xd.c</code>和<code>drivers\block\z2ram.c</code></p><p><code>ls /dev/sd* -l</code> 查看所有磁盘设备，次设备号为0的磁盘表示整个磁盘，此设备号为1、2、3表示该盘的第几个分区。<br><img src="/images/20200423173330538.png"></p><h1 id="程序1-用内存模拟磁盘-简单处理请求do-ramblock-request"><a href="#程序1-用内存模拟磁盘-简单处理请求do-ramblock-request" class="headerlink" title="程序1 用内存模拟磁盘 简单处理请求do_ramblock_request"></a>程序1 用内存模拟磁盘 简单处理请求do_ramblock_request</h1><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/errno.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/interrupt.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mm.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/timer.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/genhd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/hdreg.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/ioport.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/wait.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/blkdev.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/blkpg.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/delay.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/io.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/system.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/uaccess.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/dma.h></span></span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">gendisk</span> <span class="token operator">*</span>ramblock_disk<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token class-name">request_queue_t</span> <span class="token operator">*</span>ramblock_queue<span class="token punctuation">;</span> <span class="token comment">// 队列</span><span class="token keyword">static</span> <span class="token function">DEFINE_SPINLOCK</span><span class="token punctuation">(</span>ramblock_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 自旋锁</span><span class="token keyword">static</span> <span class="token keyword">int</span> major<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">block_device_operations</span> ramdisk_fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>owner<span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RAMBLOCK_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> </span><span class="token comment">// 1M</span></span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">do_ramblock_request</span><span class="token punctuation">(</span><span class="token class-name">request_queue_t</span> <span class="token operator">*</span> q<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"do_ramblock_request: %d\n"</span><span class="token punctuation">,</span> <span class="token operator">++</span>cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 防止insmod后卡住，这里取出请求假装处理完成</span>    <span class="token keyword">struct</span> <span class="token class-name">request</span> <span class="token operator">*</span>req<span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>req <span class="token operator">=</span> <span class="token function">elv_next_request</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 用电梯调度算法取出下一个请求</span>        <span class="token function">end_request</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 认为已经对请求处理完成 1成功0失败</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ramblock_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 1.分配一个gendisk结构体</span>    ramblock_disk <span class="token operator">=</span> <span class="token function">alloc_disk</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 次设备号个数 分区个数 最多15个分区</span>    <span class="token comment">// 2.设置</span>    <span class="token comment">// 2.1分配/设置队列：提供读写功能</span>        <span class="token comment">// 需要提供处理队列的函数</span>    ramblock_queue <span class="token operator">=</span> <span class="token function">blk_init_queue</span><span class="token punctuation">(</span>do_ramblock_request<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ramblock_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    ramblock_disk<span class="token operator">-></span>queue <span class="token operator">=</span> ramblock_queue<span class="token punctuation">;</span>     <span class="token comment">// 2.2设置其他属性：比如容量</span>    major <span class="token operator">=</span> <span class="token function">register_blkdev</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"ramdisk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注册，只有主设备号和name了 无fops</span>    ramblock_disk<span class="token operator">-></span>major        <span class="token operator">=</span> major<span class="token punctuation">;</span>    ramblock_disk<span class="token operator">-></span>first_minor  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 15个次设备 从0开始</span>    <span class="token function">sprintf</span><span class="token punctuation">(</span>ramblock_disk<span class="token operator">-></span>disk_name<span class="token punctuation">,</span> <span class="token string">"ramdisk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ramblock_disk<span class="token operator">-></span>fops         <span class="token operator">=</span> ramdisk_fops<span class="token punctuation">;</span>    <span class="token function">set_capacity</span><span class="token punctuation">(</span>ramblock_disk<span class="token punctuation">,</span> RAMBLOCK_SIZE <span class="token operator">/</span> <span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置容量1M 以扇区为单位</span>                                <span class="token comment">// 内核文件系统中认为扇区是512Byte </span>    <span class="token comment">// 3.注册</span>    <span class="token function">add_disk</span><span class="token punctuation">(</span>ramblock_disk<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ramblock_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">unregister_blkdev</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> <span class="token string">"ramdisk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">del_gendisk</span><span class="token punctuation">(</span>ramblock_disk<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">put_disk</span><span class="token punctuation">(</span>ramblock_disk<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">blk_cleanup_queue</span><span class="token punctuation">(</span>ramblock_queue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>ramblock_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>ramblock_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="测试程序1-简单查看块设备信息"><a href="#测试程序1-简单查看块设备信息" class="headerlink" title="测试程序1 简单查看块设备信息"></a>测试程序1 简单查看块设备信息</h2><p><img src="/images/20200423193245299.png"></p><h1 id="程序2-分配内存作为模拟磁盘-磁盘和req-gt-buffer之间拷贝数据"><a href="#程序2-分配内存作为模拟磁盘-磁盘和req-gt-buffer之间拷贝数据" class="headerlink" title="程序2 分配内存作为模拟磁盘 磁盘和req-&gt;buffer之间拷贝数据"></a>程序2 分配内存作为模拟磁盘 磁盘和req-&gt;buffer之间拷贝数据</h1><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/errno.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/interrupt.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mm.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/timer.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/genhd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/hdreg.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/ioport.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/wait.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/blkdev.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/blkpg.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/delay.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/io.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/system.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/uaccess.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/dma.h></span></span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">gendisk</span> <span class="token operator">*</span>ramblock_disk<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token class-name">request_queue_t</span> <span class="token operator">*</span>ramblock_queue<span class="token punctuation">;</span> <span class="token comment">// 队列</span><span class="token keyword">static</span> <span class="token function">DEFINE_SPINLOCK</span><span class="token punctuation">(</span>ramblock_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 自旋锁</span><span class="token keyword">static</span> <span class="token keyword">int</span> major<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">block_device_operations</span> ramdisk_fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>owner<span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RAMBLOCK_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> </span><span class="token comment">// 1M</span></span><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>ramblock_buf<span class="token punctuation">;</span> <span class="token comment">// 分配得到的内存</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">do_ramblock_request</span><span class="token punctuation">(</span><span class="token class-name">request_queue_t</span> <span class="token operator">*</span> q<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// static int cnt = 0;</span>    <span class="token comment">// printk("do_ramblock_request: %d\n", ++cnt);</span>    <span class="token comment">// 用内存模拟块设备，在请求中拷贝数据</span>    <span class="token keyword">struct</span> <span class="token class-name">request</span> <span class="token operator">*</span>req<span class="token punctuation">;</span> <span class="token comment">// 取出请求之后要对其处理</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>req <span class="token operator">=</span> <span class="token function">elv_next_request</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 用电梯调度算法取出下一个请求</span>        <span class="token comment">// 数据传输三要素:源 目地 长度</span>        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> offset <span class="token operator">=</span> req<span class="token operator">-></span>sector <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">;</span> <span class="token comment">// *512 源 一个扇区大小为512还原为Byte</span>        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> len  <span class="token operator">=</span> req<span class="token operator">-></span>current_nr_sectors <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">;</span> <span class="token comment">// *512 长度</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rq_data_dir</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token operator">==</span> READ<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 读请求</span>            <span class="token function">memcpy</span><span class="token punctuation">(</span>req<span class="token operator">-></span>buffer<span class="token punctuation">,</span> ramblock_buf<span class="token operator">+</span>offset<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 从磁盘中读取数据 内存模拟的磁盘</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token function">memcpy</span><span class="token punctuation">(</span>ramblock_buf<span class="token operator">+</span>offset<span class="token punctuation">,</span> req<span class="token operator">-></span>buffer<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将buffer的数据写入磁盘 内存</span>        <span class="token punctuation">&#125;</span>        <span class="token function">end_request</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 已经对请求处理完成 1成功0失败</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ramblock_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 1.分配一个gendisk结构体</span>    ramblock_disk <span class="token operator">=</span> <span class="token function">alloc_disk</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 次设备号个数 分区个数 最多15个分区</span>    <span class="token comment">// 2.设置</span>    <span class="token comment">// 2.1分配/设置队列：提供读写功能</span>        <span class="token comment">// 需要提供处理队列的函数</span>    ramblock_queue <span class="token operator">=</span> <span class="token function">blk_init_queue</span><span class="token punctuation">(</span>do_ramblock_request<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ramblock_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    ramblock_disk<span class="token operator">-></span>queue <span class="token operator">=</span> ramblock_queue<span class="token punctuation">;</span>     <span class="token comment">// 2.2设置其他属性：比如容量</span>    major <span class="token operator">=</span> <span class="token function">register_blkdev</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"ramdisk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注册，只有主设备号和name了 无fops</span>    ramblock_disk<span class="token operator">-></span>major        <span class="token operator">=</span> major<span class="token punctuation">;</span>    ramblock_disk<span class="token operator">-></span>first_minor  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 15个次设备 从0开始</span>    <span class="token function">sprintf</span><span class="token punctuation">(</span>ramblock_disk<span class="token operator">-></span>disk_name<span class="token punctuation">,</span> <span class="token string">"ramdisk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ramblock_disk<span class="token operator">-></span>fops         <span class="token operator">=</span> ramdisk_fops<span class="token punctuation">;</span>    <span class="token function">set_capacity</span><span class="token punctuation">(</span>ramblock_disk<span class="token punctuation">,</span> RAMBLOCK_SIZE <span class="token operator">/</span> <span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置容量1M 以扇区为单位</span>                                <span class="token comment">// 内核文件系统中认为扇区是512Byte </span>        <span class="token comment">// 3.硬件相关操作</span>    ramblock_buf <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span>RAMBLOCK_SIZE<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 分配一块内存</span>    <span class="token comment">// 4.注册</span>    <span class="token function">add_disk</span><span class="token punctuation">(</span>ramblock_disk<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ramblock_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">unregister_blkdev</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> <span class="token string">"ramdisk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">del_gendisk</span><span class="token punctuation">(</span>ramblock_disk<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">put_disk</span><span class="token punctuation">(</span>ramblock_disk<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">blk_cleanup_queue</span><span class="token punctuation">(</span>ramblock_queue<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">kfree</span><span class="token punctuation">(</span>ramblock_buf<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>ramblock_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>ramblock_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="测试程序2"><a href="#测试程序2" class="headerlink" title="测试程序2"></a>测试程序2</h2><ol><li><code>insmod ramblock.ko</code> 装载新的block<br>装载后提示未知分区表，因为ramblock_buf = kzalloc(RAMBLOCK_SIZE, GFP_KERNEL);分配的是清零的内存，不是分区表，什么都没有。<br><img src="/images/20200423214711797.png"></li><li>格式化 <code>mkdosfs /dev/ramblock</code></li><li>挂接  <code>mount /dev/ramblock /tmp/</code></li><li>读写文件，<code>cd /tmp/</code> 然后 <code>vi 1.txt</code> 加入内容 hello；拷贝文件过来<code>cp /etc/inittab .</code></li><li><code>cd /</code> 然后<code>umount /tmp/</code></li><li>重新挂接  <code>mount /dev/ramblock /tmp/</code>，查看那两个文件还在不在<code>ls /tmp/</code><br><img src="/images/20200423215637789.png"></li><li>将整个磁盘放入<code>.bin</code>文件，<code>cat /dev/ramblock &gt; /mnt/ramblock.bin</code></li><li>在pc上查看ramblock.bin，<code>sudo mount -o loop ramblock.bin /mnt</code> loop将一个普通文件当作块设备挂接<br><img src="/images/20200423220200387.png"><h1 id="程序3-在读写时加了打印"><a href="#程序3-在读写时加了打印" class="headerlink" title="程序3 在读写时加了打印"></a>程序3 在读写时加了打印</h1>在程序2上加了打印而已，<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">do_ramblock_request</span><span class="token punctuation">(</span><span class="token class-name">request_queue_t</span> <span class="token operator">*</span> q<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> rd_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> wt_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">// printk("do_ramblock_request: %d\n", ++cnt);</span>    <span class="token comment">// 用内存模拟块设备，在请求中拷贝数据</span>    <span class="token keyword">struct</span> <span class="token class-name">request</span> <span class="token operator">*</span>req<span class="token punctuation">;</span> <span class="token comment">// 取出请求之后要对其处理</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>req <span class="token operator">=</span> <span class="token function">elv_next_request</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 用电梯调度算法取出下一个请求</span>        <span class="token comment">// 数据传输三要素:源 目地 长度</span>        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> offset <span class="token operator">=</span> req<span class="token operator">-></span>sector <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">;</span> <span class="token comment">// *512 源 一个扇区大小为512还原为Byte</span>        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> len  <span class="token operator">=</span> req<span class="token operator">-></span>current_nr_sectors <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">;</span> <span class="token comment">// *512 长度</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rq_data_dir</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token operator">==</span> READ<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 读请求</span>            <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"do_ramblock_request read: %d\n"</span><span class="token punctuation">,</span> <span class="token operator">++</span>rd_cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">memcpy</span><span class="token punctuation">(</span>req<span class="token operator">-></span>buffer<span class="token punctuation">,</span> ramblock_buf<span class="token operator">+</span>offset<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 从磁盘中读取数据 内存模拟的磁盘</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"do_ramblock_request write: %d\n"</span><span class="token punctuation">,</span> <span class="token operator">++</span>wt_cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">memcpy</span><span class="token punctuation">(</span>ramblock_buf<span class="token operator">+</span>offset<span class="token punctuation">,</span> req<span class="token operator">-></span>buffer<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将buffer的数据写入磁盘 内存</span>        <span class="token punctuation">&#125;</span>        <span class="token function">end_request</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 已经对请求处理完成 1成功0失败</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="程序3测试"><a href="#程序3测试" class="headerlink" title="程序3测试"></a>程序3测试</h2></li><li><code>insmod xxx.ko</code></li><li>格式化 <code>mkdosfs /dev/ramblock</code>是write</li><li>挂接 <code>mount /dev/ramblock /tmp</code> 全是read</li><li>拷贝个文件 <code>cp /etc/inittab /tmp</code> 是read没有写，等一会儿才写。硬盘在读写提示完成时并没有真正的完成。</li><li>再拷贝个文件 <code>cp /etc/init.d/rcS /tmp</code> 没有立刻写 <code>sync</code>后立刻写。sync是一个系统调用<br><img src="/images/20200423222335667.png"></li></ol><p><strong>要么都是读要么都是写，电梯调度算法，</strong></p><h2 id="程序3接着测试"><a href="#程序3接着测试" class="headerlink" title="程序3接着测试"></a>程序3接着测试</h2><p>对/dev/ramblock进行分区，出现 柱面数未知 Unknown value for：cylinders，为了兼容旧设备需要设置虚拟的柱面数，获得几何属性，<br><img src="/images/2020042322274921.png"><br>在程序3基础上去掉打印信息，添加获取磁盘几何属性的代码，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 提供磁盘的几何信息</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ramblock_getgeo</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">block_device</span> <span class="token operator">*</span>bdev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">hd_geometry</span> <span class="token operator">*</span>geo<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 容量 = heads x cylinders x sectors x 512</span>geo<span class="token operator">-></span>heads <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>     <span class="token comment">// 磁头多少面</span>geo<span class="token operator">-></span>sectors <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>  <span class="token comment">// 柱面 多少环</span>geo<span class="token operator">-></span>cylinders <span class="token operator">=</span> RAMBLOCK_SIZE<span class="token operator">/</span><span class="token number">2</span><span class="token operator">/</span><span class="token number">32</span><span class="token operator">/</span><span class="token number">512</span><span class="token punctuation">;</span> <span class="token comment">// 一环多少扇区 1024*1024/2/512/32</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">block_device_operations</span> ramdisk_fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>owner<span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>    <span class="token punctuation">.</span>getgeo <span class="token operator">=</span> ramblock_getgeo<span class="token punctuation">,</span> <span class="token comment">// 获取几何信息，分区时提供柱面数cylinders</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li><code>insmod xxx.ko</code> </li><li><code>ls /dev/ramblock* -l</code> 只有一整块磁盘</li><li>分区 <code>fdsk/dev/ramblock</code><br><img src="/images/20200423225148522.png"><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1>如果以后的磁盘可以像内存一样访问，那块设备就简单了。<br>自己写好处理队列的函数就可以了 <code>ramblock_queue = blk_init_queue(do_ramblock_request, &amp;ramblock_lock);</code>。</li></ol>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第17课 3 4 USB设备驱动程序1简单编写 鼠标按键lse usb request block struct urb 总线驱动设备模型提供数据 设备驱动程序处理数据</title>
      <link href="2021/05/14/wds2-qi-di-17-ke-3-4-usb-she-bei-qu-dong-cheng-xu-1-jian-dan-bian-xie-shu-biao-an-jian-lse-usb-request-block-struct-urb-zong-xian-qu-dong-she-bei-mo-xing-ti-gong-shu-ju-she-bei-qu-dong-cheng-xu-chu-li-shu-ju-local/"/>
      <url>2021/05/14/wds2-qi-di-17-ke-3-4-usb-she-bei-qu-dong-cheng-xu-1-jian-dan-bian-xie-shu-biao-an-jian-lse-usb-request-block-struct-urb-zong-xian-qu-dong-she-bei-mo-xing-ti-gong-shu-ju-she-bei-qu-dong-cheng-xu-chu-li-shu-ju-local/</url>
      
        <content type="html"><![CDATA[<h1 id="如何写驱动程序"><a href="#如何写驱动程序" class="headerlink" title="如何写驱动程序"></a>如何写驱动程序<img src="/images/20200422132202404.png"></h1><p>USB总线驱动程序 在我们接入USB设备时会自动构建一个USBdevice并注册到bus的dev中。<br>我们需要做的是构建driver驱动程序，将程序注册到bus中。</p><p>如何写USB设备驱动程序：</p><ol><li>分配/设置usb_driver结构体<br> .id_table 支持哪些设备<br> .probe USB总线驱动程序发现设备后比较id，如果支持则probe<br> .disconnect</li><li>注册</li></ol><h1 id="参考USB鼠标driver程序例子drivers-hid-usbhid-usbmouse-c"><a href="#参考USB鼠标driver程序例子drivers-hid-usbhid-usbmouse-c" class="headerlink" title="参考USB鼠标driver程序例子drivers\hid\usbhid\usbmouse.c"></a>参考USB鼠标driver程序例子drivers\hid\usbhid\usbmouse.c</h1><p>USB鼠标driver程序例子drivers\hid\usbhid\usbmouse.c。<br>我们的目标是用鼠标当作按键，left=l、right=s、mid=enter</p><h2 id="程序1-简单的结构"><a href="#程序1-简单的结构" class="headerlink" title="程序1 简单的结构"></a>程序1 简单的结构</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/usb/input.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/hid.h></span></span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">usb_device_id</span> usb_mouse_key_id_table <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 接口描述符的成员，符合这三条就支持，HID类，子类是BOOT，协议是MOUSE</span><span class="token punctuation">&#123;</span> <span class="token function">USB_INTERFACE_INFO</span><span class="token punctuation">(</span>USB_INTERFACE_CLASS_HID<span class="token punctuation">,</span> USB_INTERFACE_SUBCLASS_BOOT<span class="token punctuation">,</span> USB_INTERFACE_PROTOCOL_MOUSE<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token comment">// &#123; USB_DEVICE(0x111,0x222) &#125;, // 只支持某个厂家生产的某款设备，</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span><span class="token comment">/* Terminating entry */</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">usb_mouse_key_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">usb_interface</span> <span class="token operator">*</span>intf<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">usb_device_id</span> <span class="token operator">*</span>id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"find usb mouse.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">usb_mouse_key_disconnect</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">usb_interface</span> <span class="token operator">*</span>intf<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"disconnect usbmouse.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 1.分配 设置usb_driver</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">usb_driver</span> usbmouse_key_driver <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span>name <span class="token operator">=</span> usbmouse_key_name<span class="token punctuation">,</span>    <span class="token punctuation">.</span>probe <span class="token operator">=</span> usbmouse_key_probe<span class="token punctuation">,</span>    <span class="token punctuation">.</span>disconnect <span class="token operator">=</span> usbmouse_key_disconnect<span class="token punctuation">,</span>    <span class="token punctuation">.</span>id_table <span class="token operator">=</span> usbmouse_key_id_table<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">usb_mouse_key_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">usb_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>usbmouse_key_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">usb_mouse_key_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">usb_deregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>usbmouse_key_driver<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>usb_mouse_key_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>usb_mouse_key_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LiCENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="程序1-测试"><a href="#程序1-测试" class="headerlink" title="程序1 测试"></a>程序1 测试</h2><ol><li><code>make menuconfig</code> 去掉原来的usb鼠标驱动<br>去掉*号<br><img src="/images/20200422165130707.png"></li><li><code>make uImage</code> 重新制作内核镜像，并用新的内核启动</li><li><code>insmod usbmouse_as_key.ko</code></li><li>插入拔出usb鼠标<br><img src="/images/202004221707139.png"><h2 id="在probe中打印USB设备的版本号、提供商、产品id"><a href="#在probe中打印USB设备的版本号、提供商、产品id" class="headerlink" title="在probe中打印USB设备的版本号、提供商、产品id"></a>在probe中打印USB设备的版本号、提供商、产品id</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c">设备描述符 <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token number">1</span>个配置描述符 <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> 多个接口描述符 <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> 多个 （录音 播放）端点描述符 <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> 多个<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>USB设备描述符里包含了：<br>USB的版本号bcdUSB，<br>USB的提供商，<br>USB产品的id，<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">usb_device_descriptor</span> <span class="token punctuation">&#123;</span>__u8  bLength<span class="token punctuation">;</span>__u8  bDescriptorType<span class="token punctuation">;</span>__le16 bcdUSB<span class="token punctuation">;</span>__u8  bDeviceClass<span class="token punctuation">;</span>__u8  bDeviceSubClass<span class="token punctuation">;</span>__u8  bDeviceProtocol<span class="token punctuation">;</span>__u8  bMaxPacketSize0<span class="token punctuation">;</span>__le16 idVendor<span class="token punctuation">;</span>__le16 idProduct<span class="token punctuation">;</span>__le16 bcdDevice<span class="token punctuation">;</span>__u8  iManufacturer<span class="token punctuation">;</span>__u8  iProduct<span class="token punctuation">;</span>__u8  iSerialNumber<span class="token punctuation">;</span>__u8  bNumConfigurations<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>只在probe中新增了代码，<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">usb_mouse_key_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">usb_interface</span> <span class="token operator">*</span>intf<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">usb_device_id</span> <span class="token operator">*</span>id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 从usb_interface获取usb_device</span>    <span class="token keyword">struct</span> <span class="token class-name">usb_device</span> <span class="token operator">*</span>usb_dev <span class="token operator">=</span> <span class="token function">interface_to_usbdev</span><span class="token punctuation">(</span>intf<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"find usb mouse.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// usb_device中有struct usb_device_descriptor descriptor;/* Descriptor */</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"bsdUSB   : %x\n"</span><span class="token punctuation">,</span> usb_dev<span class="token operator">-></span>descriptor<span class="token operator">-></span>bcdUSB<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 版本号</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"idVendor : %x\n"</span><span class="token punctuation">,</span> usb_dev<span class="token operator">-></span>descriptor<span class="token operator">-></span>idVendor<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 提供商</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"bcdDevice: %x\n"</span><span class="token punctuation">,</span> usb_dev<span class="token operator">-></span>descriptor<span class="token operator">-></span>bcdDevice<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 产品id</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>打印结果与windows看到的一致，<br><img src="/images/20200422172200768.png"><h1 id="USB第四个视频"><a href="#USB第四个视频" class="headerlink" title="USB第四个视频"></a>USB第四个视频</h1>分析probe代码，<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">usb_mouse_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">usb_interface</span> <span class="token operator">*</span>intf<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">usb_device_id</span> <span class="token operator">*</span>id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">// 除0端点外 不止一个端点，则不支持此设备 返回</span><span class="token keyword">if</span> <span class="token punctuation">(</span>interface<span class="token operator">-></span>desc<span class="token punctuation">.</span>bNumEndpoints <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span><span class="token comment">// 得到除0之外的 第一个端点的描述符</span>endpoint <span class="token operator">=</span> <span class="token operator">&amp;</span>interface<span class="token operator">-></span>endpoint<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>desc<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">usb_endpoint_is_int_in</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 如果不是中断类型端点 输入类型端点 则返回</span><span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>    <span class="token comment">// 是否为输入设备 在端点描述符中的bmAttributes属性中可知</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c">include\linux\usb<span class="token punctuation">.</span>h<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">usb_rcvintpipe</span><span class="token expression"><span class="token punctuation">(</span>dev<span class="token punctuation">,</span>endpoint<span class="token punctuation">)</span></span><span class="token punctuation">\</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>PIPE_INTERRUPT <span class="token operator">&lt;&lt;</span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">__create_pipe</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span>endpoint<span class="token punctuation">)</span> <span class="token operator">|</span> USB_DIR_IN<span class="token punctuation">)</span> </span></span><span class="token comment">// 端点类型 USB设备的编号 和 端点的编号 端点方向</span>include\linux\usb<span class="token punctuation">.</span>h<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">__create_pipe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">usb_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> endpoint<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token punctuation">(</span>dev<span class="token operator">-></span>devnum <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>endpoint <span class="token operator">&lt;&lt;</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// USB设备的编号 和 端点的编号</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>USB设备没有中断主机的能力，在主机上的USB控制器一直查询USB设备的接入情况，当有USB接入后会通过中断的方式通知主机，是主机上的USB控制器产生的中断，不是USB设备本身。<br><img src="/images/20200422211425931.png"><h2 id="程序2-在usb-irq中print"><a href="#程序2-在usb-irq中print" class="headerlink" title="程序2 在usb irq中print"></a>程序2 在usb irq中print</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/usb/input.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/hid.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/usb.h></span></span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>usbk_dev<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token operator">*</span>usb_buf<span class="token punctuation">;</span>            <span class="token comment">// 虚拟地址</span><span class="token keyword">static</span> <span class="token class-name">dma_addr_t</span> usb_buf_phys<span class="token punctuation">;</span>  <span class="token comment">// 物理地址 typedef u64 dma_addr_t;</span><span class="token keyword">static</span> <span class="token keyword">int</span> len<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">urb</span> <span class="token operator">*</span>usbk_urb<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">usb_device_id</span> usb_mouse_key_id_table <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 接口描述符的成员，符合这三条就支持，HID类，子类是BOOT，协议是MOUSE</span><span class="token punctuation">&#123;</span> <span class="token function">USB_INTERFACE_INFO</span><span class="token punctuation">(</span>USB_INTERFACE_CLASS_HID<span class="token punctuation">,</span> USB_INTERFACE_SUBCLASS_BOOT<span class="token punctuation">,</span> USB_INTERFACE_PROTOCOL_MOUSE<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token comment">// &#123; USB_DEVICE(0x111,0x222) &#125;, // 只支持某个厂家生产的某款设备，</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span><span class="token comment">/* Terminating entry */</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// USB控制器在接收到数据后会产生中断，cpu调用这个irq</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">usbmouse_key_irq</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">urb</span> <span class="token operator">*</span>urb<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> i<span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"data cnt: %d "</span><span class="token punctuation">,</span> <span class="token operator">++</span>cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%02x "</span><span class="token punctuation">,</span> usb_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打印缓冲区内容</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 重新提交urb</span>    <span class="token function">usb_submit_urb</span><span class="token punctuation">(</span>usbk_urb<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">usb_mouse_key_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">usb_interface</span> <span class="token operator">*</span>intf<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">usb_device_id</span> <span class="token operator">*</span>id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 从usb_interface获取usb_device</span>    <span class="token keyword">struct</span> <span class="token class-name">usb_device</span> <span class="token operator">*</span>usb_dev <span class="token operator">=</span> <span class="token function">interface_to_usbdev</span><span class="token punctuation">(</span>intf<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">struct</span> <span class="token class-name">usb_host_interface</span> <span class="token operator">*</span>interface<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">usb_endpoint_descriptor</span> <span class="token operator">*</span>endpoint<span class="token punctuation">;</span>    <span class="token keyword">int</span> pipe<span class="token punctuation">;</span>interface <span class="token operator">=</span> intf<span class="token operator">-></span>cur_altsetting<span class="token punctuation">;</span>endpoint <span class="token operator">=</span> <span class="token operator">&amp;</span>interface<span class="token operator">-></span>endpoint<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>desc<span class="token punctuation">;</span>    <span class="token comment">// printk("find usb mouse.\n");</span>    <span class="token comment">// // usb_device中有struct usb_device_descriptor descriptor;/* Descriptor */</span>    <span class="token comment">// printk("bsdUSB   : %x\n", usb_dev->descriptor->bcdUSB);   // 版本号</span>    <span class="token comment">// printk("idVendor : %x\n", usb_dev->descriptor->idVendor); // 提供商</span>    <span class="token comment">// printk("bcdDevice: %x\n", usb_dev->descriptor->bcdDevice);// 产品id</span>    <span class="token comment">// 不打印 也不判断是否为输入端点 中断端点等，直接认为是鼠标</span>    <span class="token comment">// 1.分配一个input_dev</span>    usbk_dev <span class="token operator">=</span> <span class="token function">input_allocate_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2.设置</span>    <span class="token comment">// 2.1能产生哪类事件</span>    <span class="token function">set_bit</span><span class="token punctuation">(</span>EV_KEY<span class="token punctuation">,</span> usbk_dev<span class="token operator">-></span>evbit<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">set_bit</span><span class="token punctuation">(</span>EV_REP<span class="token punctuation">,</span> usbk_dev<span class="token operator">-></span>evbit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 重复类事件，长按</span>    <span class="token comment">// 2.2能产生这类事件的哪些事件</span>    <span class="token function">set_bit</span><span class="token punctuation">(</span>KEY_L<span class="token punctuation">,</span> usbk_dev<span class="token operator">-></span>keybit<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">set_bit</span><span class="token punctuation">(</span>KEY_S<span class="token punctuation">,</span> usbk_dev<span class="token operator">-></span>keybit<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">set_bit</span><span class="token punctuation">(</span>KEY_ENTER<span class="token punctuation">,</span> usbk_dev<span class="token operator">-></span>keybit<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3.注册</span>    <span class="token function">input_register_device</span><span class="token punctuation">(</span>usbk_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4.硬件相关操作  在之前的led lcd等硬件操作就是配置寄存器</span>    <span class="token comment">//      在usb中，是通过总线去收发usb数据</span>    <span class="token comment">// 数据传输三要素</span>    <span class="token comment">// 一源：USB设备的某个端点</span>        <span class="token comment">// pipe源 端点类型 USB设备的编号和端点的编号 端点方向</span>        <span class="token comment">// ((PIPE_INTERRUPT &lt;&lt; 30) | __create_pipe(dev,endpoint) | USB_DIR_IN) </span>        <span class="token comment">// __create_pipe中return (dev->devnum &lt;&lt; 8) | (endpoint &lt;&lt; 15);    </span>pipe <span class="token operator">=</span> <span class="token function">usb_rcvintpipe</span><span class="token punctuation">(</span>usb_dev<span class="token punctuation">,</span> endpoint<span class="token operator">-></span>bEndpointAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 三长度：</span>    len <span class="token operator">=</span> endpoint<span class="token operator">-></span>wMaxPacketSize<span class="token punctuation">;</span> <span class="token comment">// 最大包大小</span>    <span class="token comment">// 二目地：</span>usb_buf <span class="token operator">=</span> <span class="token function">usb_buffer_alloc</span><span class="token punctuation">(</span>usb_dev<span class="token punctuation">,</span> len<span class="token punctuation">,</span> GFP_ATOMIC<span class="token punctuation">,</span> <span class="token operator">&amp;</span>usb_buf_phys<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 使用三要素</span>    <span class="token comment">// 分配一个USB请求块 usb request block</span>usbk_urb <span class="token operator">=</span> <span class="token function">usb_alloc_urb</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 设置urb,填充这个urb</span>        <span class="token comment">// USB控制器得到数据后 会产生中断 cpu调用complete函数usbmouse_key_irq</span><span class="token function">usb_fill_int_urb</span><span class="token punctuation">(</span>usbk_urb<span class="token punctuation">,</span> usb_dev<span class="token punctuation">,</span> pipe<span class="token punctuation">,</span> usb_buf<span class="token punctuation">,</span> len<span class="token punctuation">,</span> usbmouse_key_irq<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> endpoint<span class="token operator">-></span>bInterval<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 查询频率</span>        <span class="token comment">//  USB控制器会将这些数据写入到内存，并不聪明所以需要告知物理地址</span>usbk_urb<span class="token operator">-></span>transfer_dma <span class="token operator">=</span> usb_buf_phys<span class="token punctuation">;</span>        <span class="token comment">// 设置某些标记</span>usbk_urb<span class="token operator">-></span>transfer_flags <span class="token operator">|=</span> URB_NO_TRANSFER_DMA_MAP<span class="token punctuation">;</span>        <span class="token comment">// 使用urb</span>    <span class="token function">usb_submit_urb</span><span class="token punctuation">(</span>usbk_urb<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">usb_mouse_key_disconnect</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">usb_interface</span> <span class="token operator">*</span>intf<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">usb_device</span> <span class="token operator">*</span>usb_dev <span class="token operator">=</span> <span class="token function">interface_to_usbdev</span><span class="token punctuation">(</span>intf<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// printk("disconnect usbmouse.\n");</span>    <span class="token function">usb_kill_urb</span><span class="token punctuation">(</span>usbk_urb<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">usb_free_urb</span><span class="token punctuation">(</span>usbk_urb<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">usb_buffer_free</span><span class="token punctuation">(</span>usb_dev<span class="token punctuation">,</span> len<span class="token punctuation">,</span> usb_buf<span class="token punctuation">,</span> usb_buf_phys<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">input_unregister_device</span><span class="token punctuation">(</span>usbk_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">input_free_device</span><span class="token punctuation">(</span>usbk_dev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 1.分配 设置usb_driver</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">usb_driver</span> usbmouse_key_driver <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"usbms_key_name"</span><span class="token punctuation">,</span>    <span class="token punctuation">.</span>probe <span class="token operator">=</span> usb_mouse_key_probe<span class="token punctuation">,</span>    <span class="token punctuation">.</span>disconnect <span class="token operator">=</span> usb_mouse_key_disconnect<span class="token punctuation">,</span>    <span class="token punctuation">.</span>id_table <span class="token operator">=</span> usb_mouse_key_id_table<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">usb_mouse_key_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">usb_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>usbmouse_key_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">usb_mouse_key_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">usb_deregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>usbmouse_key_driver<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>usb_mouse_key_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>usb_mouse_key_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LiCENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="程序2-测试-查看print"><a href="#程序2-测试-查看print" class="headerlink" title="程序2 测试 查看print"></a>程序2 测试 查看print</h2></li><li><code>insmod xxx.ko</code> </li><li><code>ls /dev/event*</code></li><li>接上USB鼠标</li><li><code>ls /dev/event*</code><br><img src="/images/20200422215236730.png"></li><li>操作鼠标观察数据<br><img src="/images/20200422215832539.png"><h2 id="程序3-将usb-irq中print改为上报事件input-event，在程序2上改"><a href="#程序3-将usb-irq中print改为上报事件input-event，在程序2上改" class="headerlink" title="程序3 将usb irq中print改为上报事件input_event，在程序2上改"></a>程序3 将usb irq中print改为上报事件input_event，在程序2上改</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// USB控制器在接收到数据后会产生中断，cpu调用这个irq</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">usbmouse_key_irq</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">urb</span> <span class="token operator">*</span>urb<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 打印缓冲区内容</span>    <span class="token comment">// int i;</span>    <span class="token comment">// static int cnt = 0;</span>    <span class="token comment">// printk("data cnt: %d ", ++cnt);</span>    <span class="token comment">// for (i=0; i&lt;len; ++i) &#123;</span>    <span class="token comment">//     printk("%02x ", usb_buf[i]); // 打印缓冲区内容</span>    <span class="token comment">// &#125;</span>    <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> pre_val<span class="token punctuation">;</span>    <span class="token comment">// USB数据含义  </span>        <span class="token comment">// USB设备驱动程序知道数据含义，总线驱动识别设备、找到驱动、提供读写函数</span>        <span class="token comment">// data[0]: bit0-左键 1-按下 0-松开</span>        <span class="token comment">//          bit1-左键 1-按下 0-松开</span>        <span class="token comment">//          bit2-左键 1-按下 0-松开</span>        <span class="token comment">// 与上次的值比较 发生了变换则上报事件</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pre_val <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>usb_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         <span class="token comment">// 左键变化 ,有值1按下 否则0松开</span>        <span class="token function">input_event</span><span class="token punctuation">(</span>usbk_dev<span class="token punctuation">,</span> EV_KEY<span class="token punctuation">,</span> KEY_L<span class="token punctuation">,</span> <span class="token punctuation">(</span>usb_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">input_sync</span><span class="token punctuation">(</span>usbk_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pre_val <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>usb_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         <span class="token comment">// 右键变化 ,有值1按下 否则0松开</span>        <span class="token function">input_event</span><span class="token punctuation">(</span>usbk_dev<span class="token punctuation">,</span> EV_KEY<span class="token punctuation">,</span> KEY_S<span class="token punctuation">,</span> <span class="token punctuation">(</span>usb_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">input_sync</span><span class="token punctuation">(</span>usbk_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pre_val <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>usb_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         <span class="token comment">// 中键变化 ,有值1按下 否则0松开</span>        <span class="token function">input_event</span><span class="token punctuation">(</span>usbk_dev<span class="token punctuation">,</span> EV_KEY<span class="token punctuation">,</span> KEY_ENTER<span class="token punctuation">,</span> <span class="token punctuation">(</span>usb_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">input_sync</span><span class="token punctuation">(</span>usbk_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>            pre_val <span class="token operator">=</span> usb_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 保存当前值</span>    <span class="token comment">// 重新提交urb</span>    <span class="token function">usb_submit_urb</span><span class="token punctuation">(</span>usbk_urb<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="程序3-测试-hexdump-dev-event0查看事件文件"><a href="#程序3-测试-hexdump-dev-event0查看事件文件" class="headerlink" title="程序3 测试 hexdump /dev/event0查看事件文件"></a>程序3 测试 <code>hexdump /dev/event0</code>查看事件文件</h2></li><li><code>insmod xxx.ko</code> </li><li><code>ls /dev/event*</code></li><li>接上USB鼠标</li><li><code>ls /dev/event*</code> 应该有event0<br><img src="/images/20200422222135892.png"></li><li><code>cat /dev/tty1</code></li><li>按下左键 右键 按住左键不动<br><img src="/images/20200422222248317.png" alt="7."></li><li><code>hexdump /dev/event0</code>跟以前一样，<br><img src="/images/20200422222337489.png"><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1>根据bus drv dev 总线驱动设备模型，<br>bus中有match函数，<br>左边dev由usb bus总线驱动设备程序发现新设备，注册usb_dev，并从drv链表中一个个找出驱动程序比较，比较接口和idtable，吻合就probe，probe中为所欲为，<br>以前的数据从中断irq中读取，如读寄存器按键值、adc，<br>USB的数据从总线设备驱动程序读寄存器中来，urb。<br><img src="/images/20200422223332273.png"></li></ol>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第18课 1 2 块设备驱动程序 分析ll_rw_block底层读写块 文件系统将对文件的读写转化成对扇区的读写</title>
      <link href="2021/05/14/wds2-qi-di-18-ke-1-2-kuai-she-bei-qu-dong-cheng-xu-fen-xi-ll-rw-block-di-ceng-du-xie-kuai-wen-jian-xi-tong-jiang-dui-wen-jian-de-du-xie-zhuan-hua-cheng-dui-shan-qu-de-du-xie-local/"/>
      <url>2021/05/14/wds2-qi-di-18-ke-1-2-kuai-she-bei-qu-dong-cheng-xu-fen-xi-ll-rw-block-di-ceng-du-xie-kuai-wen-jian-xi-tong-jiang-dui-wen-jian-de-du-xie-zhuan-hua-cheng-dui-shan-qu-de-du-xie-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]</p><h1 id="总结字符设备驱动程序"><a href="#总结字符设备驱动程序" class="headerlink" title="总结字符设备驱动程序"></a>总结字符设备驱动程序</h1><p><img src="/images/20200423094011241.png"></p><ol><li>查询方式：在读函数中返回引脚状态，比较前后值。（cpu占用太高）</li><li>休眠唤醒：用户读驱动读，没有数据休眠，有数据被中断服务程序唤醒然后copy_to_user。（没有数据则一直休眠）</li><li>poll机制：休眠时定时器也开始了，如果在预定时间内没有数据，时间超出将唤醒。（休眠，加闹钟）</li><li>异步通知：最好的方法（发信号）</li></ol><p>但是只有以上 写出的代码只能自己用，要融合到别人的代码需要 <strong>输入子系统</strong>。或者总线驱动设备模型。<br>输入子系统 或者 总线驱动设备模型，也是用到了前面四种方法写的。</p><h1 id="块设备驱动程序"><a href="#块设备驱动程序" class="headerlink" title="块设备驱动程序"></a>块设备驱动程序</h1><ol><li>硬盘，磁头、柱面、扇区。读写不能按照用户的顺序，会导致效率极低，顺序需要优化。（调整读写顺序）</li><li>Flash，块、扇区。读出-修改-擦除-烧写。（合并 读写擦除修改）</li></ol><p>块设备不能像字符设备 直接提供读写函数，需要<strong>把读写放入队列优化后再执行</strong>。</p><h2 id="块设备驱动程序框架"><a href="#块设备驱动程序框架" class="headerlink" title="块设备驱动程序框架"></a>块设备驱动程序框架</h2><p>app：open read write “xxx.txt”<br> = = = = = = = = = = = = = = = = = = = = = = = = 文件的读写<br>文件系统：vfat、ext2、ext3、yaffs2、jffs2 （把文件的读写转换成对扇区的读写）<br>= = = = = = = = = ll_rw_block = = = = = = = = = 扇区的读写<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;1.把读写放入队列，<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;2.调用队列的处理函数（调顺序、合并等优化）<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;块设备驱动程序<br>= = = = = = = = = = = = = = = = = = = = = = = =<br>硬件：&emsp;&emsp;&emsp;&emsp;硬盘、Flash</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">app：open read write <span class="token string">"xxx.txt"</span><span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> 文件的读写文件系统：vfat、ext2、ext3、yaffs2、jffs2 （把文件的读写转换成对扇区的读写）<span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> ll_rw_block <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> 扇区的读写<span class="token number">1.</span>把读写放入队列，<span class="token number">2.</span>调用队列的处理函数（调顺序、合并等优化）块设备驱动程序<span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> <span class="token operator">=</span> 硬件：硬盘、Flash<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="从ll-rw-block-开始分析-low-level-read-write-block底层读写块"><a href="#从ll-rw-block-开始分析-low-level-read-write-block底层读写块" class="headerlink" title="从ll_rw_block 开始分析 low level read-write block底层读写块"></a>从ll_rw_block 开始分析 low level read-write block底层读写块</h2><p>在fs\buffer.c中，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">ll_rw_block</span><span class="token punctuation">(</span><span class="token keyword">int</span> rw<span class="token punctuation">,</span> <span class="token keyword">int</span> nr<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>bhs<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">// rw读还是写  nr数组有多少项  bhs数据传输的目地</span><span class="token keyword">int</span> i<span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nr<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">buffer_head</span> <span class="token operator">*</span>bh <span class="token operator">=</span> bhs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token function">submit_bh</span><span class="token punctuation">(</span>WRITE<span class="token punctuation">,</span> bh<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用下面的</span><span class="token keyword">struct</span> <span class="token class-name">bio</span> <span class="token operator">*</span>bio<span class="token punctuation">;</span> <span class="token comment">// 使用bh来构造bio （block input/output）</span><span class="token function">submit_bio</span><span class="token punctuation">(</span>rw<span class="token punctuation">,</span> bio<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// block\ll_rw_blk.c</span><span class="token function">generic_make_request</span><span class="token punctuation">(</span>bio<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通用的构造请求 block\ll_rw_blk.c</span><span class="token function">__generic_make_request</span><span class="token punctuation">(</span>bio<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// block\ll_rw_blk.c</span><span class="token class-name">request_queue_t</span> <span class="token operator">*</span>q <span class="token operator">=</span> <span class="token function">bdev_get_queue</span><span class="token punctuation">(</span>bio<span class="token operator">-></span>bi_bdev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 找到队列</span><span class="token comment">// 调用队列的函数 “构造请求函数”。当然也有默认函数</span>ret <span class="token operator">=</span> q<span class="token operator">-></span><span class="token function">make_request_fn</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> bio<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 默认的函数是__make_request</span>__make_requestel_ret <span class="token operator">=</span> <span class="token function">elv_merge</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token operator">&amp;</span>req<span class="token punctuation">,</span> bio<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 电梯调度算法 （优化合并请求）将bio合并到队列</span><span class="token function">init_request_from_bio</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> bio<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 如果合并不成功，则使用bio构造请求</span><span class="token function">add_request</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 把请求放入到队列</span><span class="token function">__generic_unplug_device</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行队列</span>q<span class="token operator">-></span><span class="token function">request_fn</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用队列的“处理函数”</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="怎么写块设备驱动程序"><a href="#怎么写块设备驱动程序" class="headerlink" title="怎么写块设备驱动程序"></a>怎么写块设备驱动程序</h1><ol><li>分配gendisk</li><li>设置</li><li>1 分配/设置队列：request_queue_t  // 提供读写能力<br>blk_init_queue</li><li>2 设置gendisk其他信息 // 它提供属性，如容量</li><li>注册：add_disk</li></ol>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第17课 2 USB总线驱动程序 接设备-测电平-生中断-分配编号-告知设备-取描述符-注册dev-放入bus的dev链表-读出drv-比较匹配-调用drv的probe</title>
      <link href="2021/05/14/wds2-qi-di-17-ke-2-usb-zong-xian-qu-dong-cheng-xu-jie-she-bei-ce-dian-ping-sheng-zhong-duan-fen-pei-bian-hao-gao-zhi-she-bei-qu-miao-shu-fu-zhu-ce-dev-fang-ru-bus-de-dev-lian-biao-du-chu-drv-bi-jiao-pi-pei-diao-yong-drv-de-probe-local/"/>
      <url>2021/05/14/wds2-qi-di-17-ke-2-usb-zong-xian-qu-dong-cheng-xu-jie-she-bei-ce-dian-ping-sheng-zhong-duan-fen-pei-bian-hao-gao-zhi-she-bei-qu-miao-shu-fu-zhu-ce-dev-fang-ru-bus-de-dev-lian-biao-du-chu-drv-bi-jiao-pi-pei-diao-yong-drv-de-probe-local/</url>
      
        <content type="html"><![CDATA[<p>app<br>= = = = = = = = = = = = = = = = = =  = =<br>&emsp;&emsp;&emsp;&emsp;USB设备驱动程序<br>内核 = = = = = = = = = = = = == = = ==<br>&emsp;&emsp;&emsp;&emsp;USB总线驱动程序<br>= = = = = = = = = = = = = = = = = =  = =<br>&emsp;&emsp;&emsp;&emsp;&emsp;USB主机控制器<br>&emsp;&emsp;&emsp;&emsp;（UHCI OHCI EHCI）<br>硬件&emsp;&emsp;&emsp;= = = = = = = = =<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;USB设备</p><p>UHCI：intel，低速（1.5Mbps）/全速（12Mbps）硬件复杂软件简单<br>OHCI：microsoft，低速/全速 硬件一般软件厉害<br>EHCI： 高速</p><p>s3c用的是OHCI <code>drivers\usb\host\ohci-s3c2410.c</code>。</p><h1 id="USB总线驱动程序的作用，分析这些步骤在哪里实现"><a href="#USB总线驱动程序的作用，分析这些步骤在哪里实现" class="headerlink" title="USB总线驱动程序的作用，分析这些步骤在哪里实现"></a>USB总线驱动程序的作用，分析这些步骤在哪里实现</h1><ol><li>识别USB设备<br> 1.1 分配地址，并告诉USB设备（set address）<br> 1.2 发出命令获取描述符</li><li>查找并安装对应的设备驱动程序</li><li>提供USB读写函数（不管数据的含义）</li></ol><p>从USB接入拔出打印的信息着手:<br>接上—-拔掉—-再接上<br><img src="/images/20200421103105222.png"><br>内核下搜索 <code>grep &quot;USB device using&quot; -nR</code>，在<code>drivers\usb\core\hub.c</code>路径下找到，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span><span class="token function">hub_port_init</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">usb_hub</span> <span class="token operator">*</span>hub<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">usb_device</span> <span class="token operator">*</span>udev<span class="token punctuation">,</span> <span class="token keyword">int</span> port1<span class="token punctuation">,</span><span class="token keyword">int</span> retry_counter<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">dev_info</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>udev<span class="token operator">-></span>dev<span class="token punctuation">,</span>  <span class="token string">"%s %s speed %sUSB device using %s and address %d\n"</span><span class="token punctuation">,</span>  <span class="token punctuation">(</span>udev<span class="token operator">-></span>config<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"reset"</span> <span class="token operator">:</span> <span class="token string">"new"</span><span class="token punctuation">,</span> speed<span class="token punctuation">,</span> type<span class="token punctuation">,</span>  udev<span class="token operator">-></span>bus<span class="token operator">-></span>controller<span class="token operator">-></span>driver<span class="token operator">-></span>name<span class="token punctuation">,</span> udev<span class="token operator">-></span>devnum<span class="token punctuation">)</span><span class="token punctuation">;</span>当接入USB设备时，主机硬件检测到电平拉高，产生中断，在中断程序中分配编号，然后把编号告诉USB设备，发出命令获取描述符，注册device，然后把device放入USB bus的dev链表，从链表中读取driver，一一比较，如果匹配则调用driver的probe，hub_irq<span class="token function">kick_khubd</span> <span class="token punctuation">(</span>唤醒<span class="token punctuation">)</span><span class="token function">hub_thread</span> <span class="token punctuation">(</span>休眠<span class="token punctuation">)</span>hub_eventshub_port_connect_changeudev <span class="token operator">=</span> <span class="token function">usb_alloc_dev</span><span class="token punctuation">(</span>hdev<span class="token punctuation">,</span> hdev<span class="token operator">-></span>bus<span class="token punctuation">,</span> port1<span class="token punctuation">)</span><span class="token punctuation">;</span>dev<span class="token operator">-></span>dev<span class="token punctuation">.</span>bus <span class="token operator">=</span> <span class="token operator">&amp;</span>usb_bus_type<span class="token punctuation">;</span><span class="token punctuation">.</span>match <span class="token operator">=</span>usb_device_match<span class="token punctuation">,</span><span class="token function">choose_address</span><span class="token punctuation">(</span>udev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 给新的设备分配编号（地址）</span><span class="token function">hub_port_init</span> <span class="token punctuation">(</span><span class="token string">"%s %s speed %sUSB device using %s and address %d\n"</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token function">hub_set_address</span><span class="token punctuation">(</span>udev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 把编号地址告诉USB设备</span>retval <span class="token operator">=</span> <span class="token function">usb_get_device_descriptor</span><span class="token punctuation">(</span>udev<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获得设备描述符 8字节是因为不知道端的描述符</span>i <span class="token operator">=</span> udev<span class="token operator">-></span>descriptor<span class="token punctuation">.</span>bMaxPacketSize0 <span class="token operator">==</span> <span class="token number">0xff</span> <span class="token comment">// 设置</span>retval <span class="token operator">=</span> <span class="token function">usb_get_device_descriptor</span><span class="token punctuation">(</span>udev<span class="token punctuation">,</span> USB_DT_DEVICE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 再次获取</span>status <span class="token operator">=</span> <span class="token function">usb_new_device</span><span class="token punctuation">(</span>udev<span class="token punctuation">)</span><span class="token punctuation">;</span>err <span class="token operator">=</span> <span class="token function">usb_get_configuration</span><span class="token punctuation">(</span>udev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获得所有描述符 解析描述符</span>usb_get_descriptor <span class="token comment">// 获得所有描述符</span>usb_parse_configuration <span class="token comment">// 解析描述符</span>err <span class="token operator">=</span> <span class="token function">device_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>udev<span class="token operator">-></span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 把device放入bus的dev链表，</span><span class="token comment">// 从bus的driver链表里取出driver,一一比较，</span><span class="token comment">// 如果匹配则调用driver的probe函数</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>分析<code>hub_port_connect_change</code>,给新设备分配编号，告知USB设备，获得设备描述符，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">drivers\usb\core\hub<span class="token punctuation">.</span>c<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">hub_port_connect_change</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">usb_hub</span> <span class="token operator">*</span>hub<span class="token punctuation">,</span> <span class="token keyword">int</span> port1<span class="token punctuation">,</span>u16 portstatus<span class="token punctuation">,</span> u16 portchange<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>udev <span class="token operator">=</span> <span class="token function">usb_alloc_dev</span><span class="token punctuation">(</span>hdev<span class="token punctuation">,</span> hdev<span class="token operator">-></span>bus<span class="token punctuation">,</span> port1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* set the address */</span><span class="token function">choose_address</span><span class="token punctuation">(</span>udev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 给新的设备分配编号（地址）</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">choose_address</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">usb_device</span> <span class="token operator">*</span>udev<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">int</span>devnum<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">usb_bus</span><span class="token operator">*</span>bus <span class="token operator">=</span> udev<span class="token operator">-></span>bus<span class="token punctuation">;</span><span class="token comment">/* If khubd ever becomes multithreaded, this will need a lock */</span><span class="token comment">/* Try to allocate the next devnum beginning at bus->devnum_next. */</span>devnum <span class="token operator">=</span> <span class="token function">find_next_zero_bit</span><span class="token punctuation">(</span>bus<span class="token operator">-></span>devmap<span class="token punctuation">.</span>devicemap<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token comment">// 寻找为0的标记，表示还没有被分配的usb</span>bus<span class="token operator">-></span>devnum_next<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>devnum <span class="token operator">>=</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token comment">// 如果>=128则从头开始找，因此一个USB控制器最多分配127个USB设备</span>devnum <span class="token operator">=</span> <span class="token function">find_next_zero_bit</span><span class="token punctuation">(</span>bus<span class="token operator">-></span>devmap<span class="token punctuation">.</span>devicemap<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span><span class="token function">hub_port_init</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">usb_hub</span> <span class="token operator">*</span>hub<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">usb_device</span> <span class="token operator">*</span>udev<span class="token punctuation">,</span> <span class="token keyword">int</span> port1<span class="token punctuation">,</span><span class="token keyword">int</span> retry_counter<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">dev_info</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>udev<span class="token operator">-></span>dev<span class="token punctuation">,</span>  <span class="token string">"%s %s speed %sUSB device using %s and address %d\n"</span><span class="token punctuation">,</span>  <span class="token punctuation">(</span>udev<span class="token operator">-></span>config<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"reset"</span> <span class="token operator">:</span> <span class="token string">"new"</span><span class="token punctuation">,</span> speed<span class="token punctuation">,</span> type<span class="token punctuation">,</span>  udev<span class="token operator">-></span>bus<span class="token operator">-></span>controller<span class="token operator">-></span>driver<span class="token operator">-></span>name<span class="token punctuation">,</span> udev<span class="token operator">-></span>devnum<span class="token punctuation">)</span><span class="token punctuation">;</span>retval <span class="token operator">=</span> <span class="token function">hub_set_address</span><span class="token punctuation">(</span>udev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 把编号地址告诉USB设备</span>retval <span class="token operator">=</span> <span class="token function">usb_get_device_descriptor</span><span class="token punctuation">(</span>udev<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获得设备描述符 8字节是因为不知道端的描述符</span>分析设个USB设备描述符是什么东西，drivers\usb\core\message<span class="token punctuation">.</span>c<span class="token keyword">int</span> <span class="token function">usb_get_device_descriptor</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">usb_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">usb_device_descriptor</span> <span class="token operator">*</span>desc<span class="token punctuation">;</span>找到这个usb_device_descriptor设备描述符结构体的定义include\linux\usb\ch9<span class="token punctuation">.</span>h，是USB第九章，<span class="token keyword">struct</span> <span class="token class-name">usb_device_descriptor</span> <span class="token punctuation">&#123;</span>__u8  bLength<span class="token punctuation">;</span>__u8  bDescriptorType<span class="token punctuation">;</span>__le16 bcdUSB<span class="token punctuation">;</span> <span class="token comment">// USB版本号</span>__u8  bDeviceClass<span class="token punctuation">;</span>__u8  bDeviceSubClass<span class="token punctuation">;</span>__u8  bDeviceProtocol<span class="token punctuation">;</span>__u8  bMaxPacketSize0<span class="token punctuation">;</span> <span class="token comment">// 最大包大小，端点0，每个设备都有端点0，</span>   <span class="token comment">// 就是通过这个端点0识别USB设备，</span>   <span class="token comment">// 把地址 控制信息发送到端点0，从端点0读到描述符信息</span>__le16 idVendor<span class="token punctuation">;</span>__le16 idProduct<span class="token punctuation">;</span>__le16 bcdDevice<span class="token punctuation">;</span>__u8  iManufacturer<span class="token punctuation">;</span>__u8  iProduct<span class="token punctuation">;</span>__u8  iSerialNumber<span class="token punctuation">;</span>__u8  bNumConfigurations<span class="token punctuation">;</span> <span class="token comment">// 设备有多少种配置</span><span class="token punctuation">&#125;</span> <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>配置描述符include\linux\usb\ch9<span class="token punctuation">.</span>h<span class="token keyword">struct</span> <span class="token class-name">usb_config_descriptor</span> <span class="token punctuation">&#123;</span>__u8  bLength<span class="token punctuation">;</span><span class="token comment">// 配置描述符本身的长度</span>__u8  bDescriptorType<span class="token punctuation">;</span>__le16 wTotalLength<span class="token punctuation">;</span>__u8  bNumInterfaces<span class="token punctuation">;</span>  <span class="token comment">// 接口的个数，每个配置下可有多个接口，</span>   <span class="token comment">// 逻辑上的功能，如声卡实际一个硬件但是有录音和播放两个接口</span>   <span class="token comment">// 因此用两个接口描述符描述</span>__u8  bConfigurationValue<span class="token punctuation">;</span>__u8  iConfiguration<span class="token punctuation">;</span>__u8  bmAttributes<span class="token punctuation">;</span>__u8  bMaxPower<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>接口描述符<span class="token keyword">struct</span> <span class="token class-name">usb_interface_descriptor</span> <span class="token punctuation">&#123;</span>__u8  bLength<span class="token punctuation">;</span>__u8  bDescriptorType<span class="token punctuation">;</span>__u8  bInterfaceNumber<span class="token punctuation">;</span>__u8  bAlternateSetting<span class="token punctuation">;</span>__u8  bNumEndpoints<span class="token punctuation">;</span><span class="token comment">// 端点个数</span>__u8  bInterfaceClass<span class="token punctuation">;</span>__u8  bInterfaceSubClass<span class="token punctuation">;</span>__u8  bInterfaceProtocol<span class="token punctuation">;</span>__u8  iInterface<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>端点描述符include\linux\usb\ch9<span class="token punctuation">.</span>h<span class="token keyword">struct</span> <span class="token class-name">usb_endpoint_descriptor</span> <span class="token punctuation">&#123;</span>__u8  bLength<span class="token punctuation">;</span>__u8  bDescriptorType<span class="token punctuation">;</span>__u8  bEndpointAddress<span class="token punctuation">;</span> <span class="token comment">// 端点地址</span>__u8  bmAttributes<span class="token punctuation">;</span><span class="token comment">// 属性 表示哪一种端点类型，批量？实时？</span>__le16 wMaxPacketSize<span class="token punctuation">;</span><span class="token comment">// 最大包大小 通过端点一次性传输多少数据</span>__u8  bInterval<span class="token punctuation">;</span><span class="token comment">// 查询的频率，本来没有中断主动通知pc，但是通过查询来实时</span><span class="token comment">/* NOTE:  these two are _only_ in audio endpoints. */</span><span class="token comment">/* use USB_DT_ENDPOINT*_SIZE in bLength, not sizeof. */</span>__u8  bRefresh<span class="token punctuation">;</span>__u8  bSynchAddress<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span> <span class="token expression">USB的传输类型：</span></span><span class="token number">1.</span> 批量传输：可靠，时间没有保障 如U盘<span class="token number">2.</span> 中断传输：可靠实时，如USB鼠标<span class="token number">3.</span> 实时传输：不可靠、实时，如USB摄像头<span class="token number">4.</span> 控制传输：可靠，时间有保证，如USB设备的识别过程<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="描述符的层次-设备—配置—接口—端点"><a href="#描述符的层次-设备—配置—接口—端点" class="headerlink" title="描述符的层次 设备—配置—接口—端点"></a>描述符的层次 设备—配置—接口—端点</h1><pre class="line-numbers language-c" data-language="c"><code class="language-c">设备描述符 <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token number">1</span>个配置描述符 <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> 多个接口描述符 <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> 多个 （录音 播放）端点描述符 <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> 多个<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/images/20200421130441704.png"><br>我们需要写的是USB设备驱动程序，<br><img src="/images/20200421214102184.png"></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第17课 1 USB驱动程序之概念介绍 电平 传输类型 USB驱动框架图 app-_USB设备驱动程序-_USB总线驱动程序-_USB主机控制器-_USB设备</title>
      <link href="2021/05/14/wds2-qi-di-17-ke-1-usb-qu-dong-cheng-xu-zhi-gai-nian-jie-shao-dian-ping-chuan-shu-lei-xing-usb-qu-dong-kuang-jia-tu-app-usb-she-bei-qu-dong-cheng-xu-usb-zong-xian-qu-dong-cheng-xu-usb-zhu-ji-kong-zhi-qi-usb-she-bei-local/"/>
      <url>2021/05/14/wds2-qi-di-17-ke-1-usb-qu-dong-cheng-xu-zhi-gai-nian-jie-shao-dian-ping-chuan-shu-lei-xing-usb-qu-dong-kuang-jia-tu-app-usb-she-bei-qu-dong-cheng-xu-usb-zong-xian-qu-dong-cheng-xu-usb-zhu-ji-kong-zhi-qi-usb-she-bei-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]</p><h1 id="USB驱动框架图"><a href="#USB驱动框架图" class="headerlink" title="USB驱动框架图"></a>USB驱动框架图</h1><p>app<br>= = = = = = = = = = = = = = = = = =  = =<br>&emsp;&emsp;&emsp;&emsp;USB设备驱动程序<br>内核 = = = = = = = = = = = = = = = =  =<br>&emsp;&emsp;&emsp;&emsp;USB总线驱动程序<br>= = = = = = = = = = = = = = = = = =  = =<br>&emsp;&emsp;&emsp;&emsp;&emsp;USB主机控制器<br>硬件&emsp;&emsp;&emsp;= = = = = = = = =<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;USB设备<br><img src="/images/20200420204906502.png"><br><img src="/images/20200420204933369.png"><br>总线驱动程序 知道接入了什么类型的设备，USB、显卡、声卡等（识别哪种设备）<br>设备驱动程序需要具体的设备提供。</p><p>PC和USB都遵循一些规范。</p><h1 id="USB电平电阻连接-PC15K下拉-usb设备1-5k上拉"><a href="#USB电平电阻连接-PC15K下拉-usb设备1-5k上拉" class="headerlink" title="USB电平电阻连接 PC15K下拉 usb设备1.5k上拉"></a>USB电平电阻连接 PC15K下拉 usb设备1.5k上拉</h1><p><strong><font color=red> PC的USB口D-D+都接有15k下拉，<br>USB设备 D-或D+接有1.5k上拉电阻，接上PC的USB时就会把D-或D+拉高，从硬件的角度通知PC有新设备而不是中断。D-接1.5k上拉电阻则全速设备12Mbps，D+上接1.5k上拉电阻则高速设备480Mbps。 </font></strong></p><p>USB是<strong>主从结构</strong>，都是从<strong>主机发起</strong>，USB设备没有能力主动通知USB主机。从机永远只有被动的等待主机来读取数据。</p><h1 id="USB的传输类型："><a href="#USB的传输类型：" class="headerlink" title="USB的传输类型："></a>USB的传输类型：</h1><ol><li>批量传输：可靠，时间没有保障 如U盘</li><li>中断传输：可靠实时，如USB鼠标</li><li>实时传输：不可靠、实时，如USB摄像头</li><li>控制传输：可靠，时间有保证，如USB设备的识别过程<h1 id="USB传输的对象：端点。传输方向除了端点0都是单向"><a href="#USB传输的对象：端点。传输方向除了端点0都是单向" class="headerlink" title="USB传输的对象：端点。传输方向除了端点0都是单向"></a>USB传输的对象：端点。传输方向除了端点0都是单向</h1>从<strong>端点1</strong>读数据，把数据写到<strong>端点2</strong>。<br>除了端点0，其他端点只支持一个方向的数据传输。端点0用于控制传输，既能输入也能输出。<br>输入输出都是在主机的角度。<h1 id="USB总线驱动程序的作用"><a href="#USB总线驱动程序的作用" class="headerlink" title="USB总线驱动程序的作用"></a>USB总线驱动程序的作用</h1></li><li>识别USB设备</li><li>查找并安装对应的设备驱动程序</li><li>提供USB读写函数（不管数据的含义），【设备驱动程序知道数据的含义】</li></ol><p>libusb可以绕过设备驱动程序直使用去读取USB总线驱动程序。</p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第16课 1 2 3 触摸屏 TS 打开ADC时钟 设置ADC的寄存器 采集电压 处理异常值 filter 上报事件 LCD和触摸对应 需要tslib库 校准触摸屏</title>
      <link href="2021/05/14/wds2-qi-di-16-ke-1-2-3-hong-mo-ping-ts-da-kai-adc-shi-zhong-she-zhi-adc-de-ji-cun-qi-cai-ji-dian-ya-chu-li-yi-chang-zhi-filter-shang-bao-shi-jian-lcd-he-hong-mo-dui-ying-xu-yao-tslib-ku-xiao-zhun-hong-mo-ping-local/"/>
      <url>2021/05/14/wds2-qi-di-16-ke-1-2-3-hong-mo-ping-ts-da-kai-adc-shi-zhong-she-zhi-adc-de-ji-cun-qi-cai-ji-dian-ya-chu-li-yi-chang-zhi-filter-shang-bao-shi-jian-lcd-he-hong-mo-dui-ying-xu-yao-tslib-ku-xiao-zhun-hong-mo-ping-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]<br>还是用的输入子系统，总线驱动设备框架。<br>参考配套光盘的<code>drivers\input\touchscreen\s3c2410_ts.c</code>，<br>触摸屏工作原理，电阻屏利用的是两个欧姆定律，一层通电另一层ADC采集膜对应电压。<br><img src="/images/20200418102242707.png"><br>触摸屏使用过程：</p><ol><li>按下，产生中断</li><li>在中断处理程序中启动ADC采集x、y电压</li><li>ADC转换结束，产生ADC中断</li><li>在ADC中断函数里边，上报input_event，启动定时器</li><li>定时时间到，再次启动ADC采集电压，2.3.4.5（处理长按和滑动操作）</li><li>松开</li></ol><p>触摸屏硬件连接，这几个引脚就只能用作ADC的，要么ADC要么touch screen，<br><img src="/images/20200418111043210.png"></p><h2 id="打开ADC时钟-设置寄存器CLKCON-bit15为1"><a href="#打开ADC时钟-设置寄存器CLKCON-bit15为1" class="headerlink" title="打开ADC时钟 设置寄存器CLKCON bit15为1"></a>打开ADC时钟 设置寄存器<code>CLKCON</code> bit15为1</h2><p>内核为了省电，在上电时，很多外设都是关闭的，s3c需要通过设置寄存器<code>CLKCON</code>打开，这里ts应该设置bit15为1<br><img src="/images/20200418111950111.png"><br>参考drivers\input\touchscreen\s3c2410_ts.c怎么设置的硬件相关操作，s3c需要通过设置寄存器<code>CLKCON</code>打开，这里ts应该设置bit15为1</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">drivers\input\touchscreen\s3c2410_ts<span class="token punctuation">.</span>c<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">s3c2410ts_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>adc_clock <span class="token operator">=</span> <span class="token function">clk_get</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"adc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>arch\arm\mach<span class="token operator">-</span>s3c2410\clock<span class="token punctuation">.</span>c<span class="token punctuation">&#123;</span><span class="token punctuation">.</span>name<span class="token operator">=</span> <span class="token string">"adc"</span><span class="token punctuation">,</span><span class="token punctuation">.</span>id<span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">.</span>parent<span class="token operator">=</span> <span class="token operator">&amp;</span>clk_p<span class="token punctuation">,</span><span class="token punctuation">.</span>enable<span class="token operator">=</span> s3c2410_clkcon_enable<span class="token punctuation">,</span><span class="token punctuation">.</span>ctrlbit<span class="token operator">=</span> S3C2410_CLKCON_ADC<span class="token punctuation">,</span> <span class="token comment">// bit15</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>include\<span class="token keyword">asm</span><span class="token operator">-</span>arm\arch<span class="token operator">-</span>s3c2410\regs<span class="token operator">-</span>clock<span class="token punctuation">.</span>h<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S3C2410_CLKCON_ADC</span>     <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">15</span><span class="token punctuation">)</span></span></span>arch\arm\mach<span class="token operator">-</span>s3c2410\clock<span class="token punctuation">.</span>c<span class="token keyword">int</span> <span class="token function">s3c2410_clkcon_enable</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">clk</span> <span class="token operator">*</span>clk<span class="token punctuation">,</span> <span class="token keyword">int</span> enable<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> clocks <span class="token operator">=</span> clk<span class="token operator">-></span>ctrlbit<span class="token punctuation">;</span> <span class="token comment">// .ctrlbit= S3C2410_CLKCON_ADC, // bit15</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> clkcon<span class="token punctuation">;</span>clkcon <span class="token operator">=</span> <span class="token function">__raw_readl</span><span class="token punctuation">(</span>S3C2410_CLKCON<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>enable<span class="token punctuation">)</span>clkcon <span class="token operator">|=</span> clocks<span class="token punctuation">;</span>   <span class="token comment">// clkcon | clk->ctrlbit 修改bit15</span><span class="token keyword">else</span>clkcon <span class="token operator">&amp;=</span> <span class="token operator">~</span>clocks<span class="token punctuation">;</span><span class="token comment">/* ensure none of the special function bits set */</span>clkcon <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>S3C2410_CLKCON_IDLE<span class="token operator">|</span>S3C2410_CLKCON_POWER<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">__raw_writel</span><span class="token punctuation">(</span>clkcon<span class="token punctuation">,</span> S3C2410_CLKCON<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写入寄存器</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="adc的分辨率，1bit刻度表示3-3-2-10-1-0-003v-3mv"><a href="#adc的分辨率，1bit刻度表示3-3-2-10-1-0-003v-3mv" class="headerlink" title="adc的分辨率，1bit刻度表示3.3/(2^10-1)=0.003v=3mv"></a>adc的分辨率，1bit刻度表示3.3/(2^10-1)=0.003v=3mv</h2><p><img src="/images/20200418113528448.png"></p><h2 id="设置ADC的ADC-TS的寄存器，"><a href="#设置ADC的ADC-TS的寄存器，" class="headerlink" title="设置ADC的ADC/TS的寄存器，"></a>设置ADC的ADC/TS的寄存器，</h2><p><img src="/images/20200418115249253.png"></p><h3 id="ADCCON寄存器"><a href="#ADCCON寄存器" class="headerlink" title="ADCCON寄存器"></a>ADCCON寄存器</h3><p><img src="/images/20200418123122792.png"><br>dmesg查看外设时钟为50MHz，<br><img src="/images/20200418122944469.png"></p><h3 id="ADCTSC寄存器-等待中断模式"><a href="#ADCTSC寄存器-等待中断模式" class="headerlink" title="ADCTSC寄存器  等待中断模式"></a>ADCTSC寄存器  等待中断模式</h3><p>等待中断模式，<br><img src="/images/20200418130632194.png"><br><img src="/images/20200418125116220.png"></p><h3 id="ADCDAT0寄存器"><a href="#ADCDAT0寄存器" class="headerlink" title="ADCDAT0寄存器"></a>ADCDAT0寄存器</h3><p><img src="/images/20200418131836560.png"></p><h2 id="程序一-实现按下松开"><a href="#程序一-实现按下松开" class="headerlink" title="程序一 实现按下松开"></a>程序一 实现按下松开</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/errno.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/input.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/serio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/delay.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/clk.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/irq.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/interrupt.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/plat-s3c24xx/ts.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/regs-adc.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/regs-gpio.h></span></span><span class="token keyword">struct</span> <span class="token class-name">adc_regs</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adccon<span class="token punctuation">;</span>      <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adctsc<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adcdly<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adcdat0<span class="token punctuation">;</span>     <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adcdat1<span class="token punctuation">;</span>     <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adcupdn<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span> s3c_ts_dev<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">struct</span> <span class="token class-name">adc_regs</span> <span class="token operator">*</span>adcregs<span class="token punctuation">;</span><span class="token comment">// 进入等待松开模式</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">enter_wait_pen_up_mode</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    adcregs<span class="token operator">-></span>adctsc <span class="token operator">=</span> <span class="token number">0x1d3</span><span class="token punctuation">;</span> <span class="token comment">// bit8 1 = Detect Stylus Up Interrupt Signal.</span><span class="token punctuation">&#125;</span><span class="token comment">// 进入等待按下模式</span><span class="token keyword">static</span> <span class="token keyword">void</span>  <span class="token function">enter_wait_pen_down_mode</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    adcregs<span class="token operator">-></span>adctsc <span class="token operator">=</span> <span class="token number">0xd3</span><span class="token punctuation">;</span>  <span class="token comment">// bit8 0 = Detect Stylus Down Interrupt Signal</span><span class="token punctuation">&#125;</span><span class="token comment">// 触摸按下松开进入中断函数</span><span class="token keyword">static</span> <span class="token class-name">irqreturn_t</span> <span class="token function">pen_down_up_irq</span><span class="token punctuation">(</span><span class="token keyword">int</span> irq<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dev_id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"pen down/up.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 分辨按下还是松开 判断adcdat0 bit15</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>adcregs<span class="token operator">-></span>adcdat0 <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 松开</span>        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"pen_up.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">enter_wait_pen_down_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 进入等待按下模式</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                          <span class="token comment">// 按下</span>        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"pen_down.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">enter_wait_pen_up_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 进入等待松开模式</span>    <span class="token punctuation">&#125;</span><span class="token keyword">return</span> IRQ_HANDLED<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">s3c_ts_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">clk</span> <span class="token operator">*</span> adc_clock<span class="token punctuation">;</span> <span class="token comment">// adc的时钟，需要打开，内核上电关闭了</span>    <span class="token comment">// 1.分配input_dev结构体</span>    s3c_ts_dev <span class="token operator">=</span> <span class="token function">input_allocate_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2.设置该结构体</span>    <span class="token comment">// 2.1能产生哪类事件</span>    <span class="token function">set_bit</span><span class="token punctuation">(</span>EV_KEY<span class="token punctuation">,</span> s3c_ts_dev<span class="token operator">-></span>evbit<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">set_bit</span><span class="token punctuation">(</span>EV_ABS<span class="token punctuation">,</span> s3c_ts_dev<span class="token operator">-></span>evbit<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 绝对位置 </span>    <span class="token comment">// 2.2能产生这类事件的哪些事件</span>    <span class="token function">set_bit</span><span class="token punctuation">(</span>BTN_TOUCH<span class="token punctuation">,</span> s3c_ts_dev<span class="token operator">-></span>evbit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 点击，类button</span>    <span class="token comment">// void input_set_abs_params(input_dev *, int axis, int min, int max, int fuzz, int flat)</span>    <span class="token comment">//  ADC最大值最小值</span><span class="token function">input_set_abs_params</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">,</span> ABS_X<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x3FF</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">input_set_abs_params</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">,</span> ABS_Y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x3FF</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">input_set_abs_params</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">,</span> ABS_PRESSURE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3.注册</span>    <span class="token function">input_register_device</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4.硬件相关操作</span>    <span class="token comment">// 4.1使能adc时钟 CLKCON[15]</span>    adc_clock <span class="token operator">=</span> <span class="token function">clk_get</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"adc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">clk_enable</span><span class="token punctuation">(</span>adc_clock<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 打开时钟    </span>    <span class="token comment">// 4.2设置s3c的ADC/TS寄存器</span>    adcregs <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span><span class="token number">0x58000000</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">adc_regs</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// bit[14]  : 1 将pclck预分配</span>        <span class="token comment">// bit[13:6]: 分频系数 49</span>        <span class="token comment">//      ADCCLK=PCLK/(49+1)=50/(49+1)=1MHz</span>        <span class="token comment">// bit[0]   : 0 转换开始信号，现在不设置</span>    adcregs<span class="token operator">-></span>adccon <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">49</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 注册中断 中断号 isr 。。。</span>    <span class="token function">request_irq</span><span class="token punctuation">(</span>IRQ_TC<span class="token punctuation">,</span> pen_down_up_irq<span class="token punctuation">,</span> IRQF_SAMPLE_RANDOM<span class="token punctuation">,</span> \                <span class="token string">"ts_pen"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 进入等待中断模式</span>    <span class="token function">enter_wait_pen_down_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 进入等待按下模式</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">s3c_ts_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">free_irq</span><span class="token punctuation">(</span>IRQ_TC<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    adcregs <span class="token operator">=</span> <span class="token function">iounmap</span><span class="token punctuation">(</span>adcregs<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">input_unregister_device</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">input_free_device</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>s3c_ts_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>s3c_ts_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="测试触摸-按下和松开-（程序一）"><a href="#测试触摸-按下和松开-（程序一）" class="headerlink" title="测试触摸 按下和松开 （程序一）"></a>测试触摸 按下和松开 （程序一）</h2><ol><li><code>make</code> 触摸驱动程序，<code>cp xxx.ko nfs</code></li><li><code>make menuconfig</code> 在内核镜像中去掉触摸驱动<br><img src="/images/2020041814155540.png"><br><img src="/images/20200418141641338.png"></li><li><code>make uImage</code> 重新编译内核</li><li>从新的内核镜像启动</li><li><code>inmod ts.ko</code> 插入触摸屏模块<br>点击触摸屏可以看到结果<br><img src="/images/20200418142040758.png"><h2 id="触摸屏ADC自动的ADC转换模式"><a href="#触摸屏ADC自动的ADC转换模式" class="headerlink" title="触摸屏ADC自动的ADC转换模式"></a>触摸屏ADC自动的ADC转换模式</h2>等待TS中断时上拉电阻要使能（默认），ADC测量的时候上拉电阻要失能，<br><img src="/images/20200418144734456.png"><br><img src="/images/20200418161605498.png"><br>启动ADC，<br><img src="/images/20200418161910682.png"><br>x、y电压转换值存放在ADCDAT0 1 10bit，<br><img src="/images/20200418163220463.png"><h2 id="程序二-测量x-y电压打印出来"><a href="#程序二-测量x-y电压打印出来" class="headerlink" title="程序二 测量x y电压打印出来"></a>程序二 测量x y电压打印出来</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/errno.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/input.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/serio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/delay.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/clk.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/irq.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/interrupt.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/plat-s3c24xx/ts.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/regs-adc.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/regs-gpio.h></span></span><span class="token keyword">struct</span> <span class="token class-name">adc_regs</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adccon<span class="token punctuation">;</span>      <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adctsc<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adcdly<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adcdat0<span class="token punctuation">;</span>     <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adcdat1<span class="token punctuation">;</span>     <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adcupdn<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span> s3c_ts_dev<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">struct</span> <span class="token class-name">adc_regs</span> <span class="token operator">*</span>adcregs<span class="token punctuation">;</span><span class="token comment">// 进入等待松开中断模式</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">enter_wait_pen_up_mode</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    adcregs<span class="token operator">-></span>adctsc <span class="token operator">=</span> <span class="token number">0x1d3</span><span class="token punctuation">;</span> <span class="token comment">// bit8 1 = Detect Stylus Up Interrupt Signal.</span><span class="token punctuation">&#125;</span><span class="token comment">// 进入等待按下中断模式</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">enter_wait_pen_down_mode</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    adcregs<span class="token operator">-></span>adctsc <span class="token operator">=</span> <span class="token number">0xd3</span><span class="token punctuation">;</span>  <span class="token comment">// bit8 0 = Detect Stylus Down Interrupt Signal</span><span class="token punctuation">&#125;</span><span class="token comment">// 使adc进入 Auto(Sequential) X/Y Position Conversion Mode</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">enter_measure_xy_mode</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//      为啥不是 |= 可能其它位自动设置吧 </span>    adcregs<span class="token operator">-></span>adctsc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 1 = Auto Sequential measurement of X-position, Y-position.</span><span class="token punctuation">&#125;</span><span class="token comment">// 启动adc，开始转换</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">start_adc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    adcregs<span class="token operator">-></span>adccon <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// adc采集完成会有进入adc isr</span><span class="token keyword">static</span> <span class="token class-name">irqreturn_t</span> <span class="token function">adc_irq</span><span class="token punctuation">(</span><span class="token keyword">int</span> irq<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dev_id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">// 测量值放在 ADCDAT0  ADCDAT1 打印电压测量值</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"irq cnt=%d, x=%d, y=%d\n"</span><span class="token punctuation">,</span> <span class="token operator">++</span>cnt<span class="token punctuation">,</span> \            adcregs<span class="token operator">-></span>adcdat0 <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">0x3ff</span><span class="token punctuation">)</span><span class="token punctuation">,</span> \            adcregs<span class="token operator">-></span>adcdat1 <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">0x3ff</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 测量完 打印之后等待松开，否则测量一次，不明白为什么？？？</span>    <span class="token function">enter_wait_pen_up_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> IRQ_HANDLED<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 触摸按下松开进入中断函数</span><span class="token keyword">static</span> <span class="token class-name">irqreturn_t</span> <span class="token function">pen_down_up_irq</span><span class="token punctuation">(</span><span class="token keyword">int</span> irq<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dev_id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"pen down/up.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 分辨按下还是松开 判断adcdat0 bit15</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>adcregs<span class="token operator">-></span>adcdat0 <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 松开</span>        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"pen_up.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">enter_wait_pen_down_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 进入等待按下模式</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                          <span class="token comment">// 按下</span>        <span class="token comment">// printk("pen_down.\n");    </span>        <span class="token comment">// enter_wait_pen_up_mode();   // 进入等待松开模式</span>        <span class="token function">enter_measure_xy_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 进入测量模式</span>        <span class="token function">start_adc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 启动adc开始转换，转换需要时间，但是不等，</span>                     <span class="token comment">// 设置了adc中断，转换完成后会进入adc_irq</span>    <span class="token punctuation">&#125;</span><span class="token keyword">return</span> IRQ_HANDLED<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">s3c_ts_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">clk</span> <span class="token operator">*</span> adc_clock<span class="token punctuation">;</span> <span class="token comment">// adc的时钟，需要打开，内核上电关闭了</span>    <span class="token comment">// 1.分配input_dev结构体</span>    s3c_ts_dev <span class="token operator">=</span> <span class="token function">input_allocate_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2.设置该结构体</span>    <span class="token comment">// 2.1能产生哪类事件</span>    <span class="token function">set_bit</span><span class="token punctuation">(</span>EV_KEY<span class="token punctuation">,</span> s3c_ts_dev<span class="token operator">-></span>evbit<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">set_bit</span><span class="token punctuation">(</span>EV_ABS<span class="token punctuation">,</span> s3c_ts_dev<span class="token operator">-></span>evbit<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 绝对位置 </span>    <span class="token comment">// 2.2能产生这类事件的哪些事件</span>    <span class="token function">set_bit</span><span class="token punctuation">(</span>BTN_TOUCH<span class="token punctuation">,</span> s3c_ts_dev<span class="token operator">-></span>evbit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 点击，类button</span>    <span class="token comment">// void input_set_abs_params(input_dev *, int axis, int min, int max, int fuzz, int flat)</span>    <span class="token comment">//  ADC最大值最小值</span><span class="token function">input_set_abs_params</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">,</span> ABS_X<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x3FF</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">input_set_abs_params</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">,</span> ABS_Y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x3FF</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">input_set_abs_params</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">,</span> ABS_PRESSURE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3.注册</span>    <span class="token function">input_register_device</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4.硬件相关操作</span>    <span class="token comment">// 4.1使能adc时钟 CLKCON[15]</span>    adc_clock <span class="token operator">=</span> <span class="token function">clk_get</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"adc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">clk_enable</span><span class="token punctuation">(</span>adc_clock<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 打开时钟    </span>    <span class="token comment">// 4.2设置s3c的ADC/TS寄存器</span>    adcregs <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span><span class="token number">0x58000000</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">adc_regs</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// bit[14]  : 1 将pclck预分配</span>        <span class="token comment">// bit[13:6]: 分频系数 49</span>        <span class="token comment">//      ADCCLK=PCLK/(49+1)=50/(49+1)=1MHz</span>        <span class="token comment">// bit[0]   : 0 转换开始信号，现在不设置</span>    adcregs<span class="token operator">-></span>adccon <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">49</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 注册中断 中断号 触摸屏中断 isr 。。。</span>    <span class="token function">request_irq</span><span class="token punctuation">(</span>IRQ_TC<span class="token punctuation">,</span> pen_down_up_irq<span class="token punctuation">,</span> IRQF_SAMPLE_RANDOM<span class="token punctuation">,</span> \                <span class="token string">"ts_pen"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 注册ADC中断</span>    <span class="token function">request_irq</span><span class="token punctuation">(</span>IRQ_ADC<span class="token punctuation">,</span> adc_irq<span class="token punctuation">,</span> IRQF_SAMPLE_RANDOM<span class="token punctuation">,</span> \                <span class="token string">"adc"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 进入等待中断模式</span>    <span class="token function">enter_wait_pen_down_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 进入等待按下中断模式</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">s3c_ts_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">free_irq</span><span class="token punctuation">(</span>IRQ_TC<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    adcregs <span class="token operator">=</span> <span class="token function">iounmap</span><span class="token punctuation">(</span>adcregs<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">input_unregister_device</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">input_free_device</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>s3c_ts_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>s3c_ts_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="问题，触摸屏返回值不连续，也无法滑动长按"><a href="#问题，触摸屏返回值不连续，也无法滑动长按" class="headerlink" title="问题，触摸屏返回值不连续，也无法滑动长按"></a>问题，触摸屏返回值不连续，也无法滑动长按</h2>依次点击但是x的值不连续，滑动也不测量，<br><img src="/images/2020041816404518.png"><br>采集结果不稳定的结果原因有：</li><li>电压建立不稳定就开始采集，所以可以延时稳定后再采集，有寄存器ADCDLY支持；<br><img src="/images/20200418164616276.png"></li><li>adc完成前 已经松开，丢弃此次结果。按下松开时间间隔短语adc采集时间，导致采集信息不准确，丢弃；寄存器可以判断按下松开<br><img src="/images/20200418170012300.png"></li><li>求多次测量的平均值，比如4次</li><li>简单滤波，根据x y 4次采样得到的数组计算正常的情况，1 2 3 4<br> 3与1、2平均值的差值应该&lt;ERR_LIMIT &amp;&amp; 4与2、3平均值的差值应该&lt;ERR_LIMIT</li></ol><h2 id="程序三-处理异常值（电压稳定再采集、剔除中间弹起、4次平均值、filter）"><a href="#程序三-处理异常值（电压稳定再采集、剔除中间弹起、4次平均值、filter）" class="headerlink" title="程序三 处理异常值（电压稳定再采集、剔除中间弹起、4次平均值、filter）"></a>程序三 处理异常值（电压稳定再采集、剔除中间弹起、4次平均值、filter）</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/errno.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/input.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/serio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/delay.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/clk.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/irq.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/interrupt.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/plat-s3c24xx/ts.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/regs-adc.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/regs-gpio.h></span></span><span class="token keyword">struct</span> <span class="token class-name">adc_regs</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adccon<span class="token punctuation">;</span>      <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adctsc<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adcdly<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adcdat0<span class="token punctuation">;</span>     <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adcdat1<span class="token punctuation">;</span>     <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adcupdn<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span> s3c_ts_dev<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">struct</span> <span class="token class-name">adc_regs</span> <span class="token operator">*</span>adcregs<span class="token punctuation">;</span><span class="token comment">// 进入等待松开中断模式</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">enter_wait_pen_up_mode</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    adcregs<span class="token operator">-></span>adctsc <span class="token operator">=</span> <span class="token number">0x1d3</span><span class="token punctuation">;</span> <span class="token comment">// bit8 1 = Detect Stylus Up Interrupt Signal.</span><span class="token punctuation">&#125;</span><span class="token comment">// 进入等待按下中断模式</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">enter_wait_pen_down_mode</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    adcregs<span class="token operator">-></span>adctsc <span class="token operator">=</span> <span class="token number">0xd3</span><span class="token punctuation">;</span>  <span class="token comment">// bit8 0 = Detect Stylus Down Interrupt Signal</span><span class="token punctuation">&#125;</span><span class="token comment">// 使adc进入 Auto(Sequential) X/Y Position Conversion Mode</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">enter_measure_xy_mode</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//      为啥不是 |= 可能其它位自动设置吧 </span>    adcregs<span class="token operator">-></span>adctsc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 1 = Auto Sequential measurement of X-position, Y-position.</span><span class="token punctuation">&#125;</span><span class="token comment">// 启动adc，开始转换</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">start_adc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    adcregs<span class="token operator">-></span>adccon <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 根据x y多次采样得到的数组计算正常的情况</span><span class="token comment">//  1 2 3 4  3与1、2平均值的差值应该&lt;ERR_LIMIT &amp;&amp; </span><span class="token comment">//           4与2、3平均值的差值应该&lt;ERR_LIMIT</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ts_filter</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> x<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> y<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ERR_LIMIT</span>   <span class="token expression"><span class="token number">10</span> </span><span class="token comment">// 像素误差极限</span></span>    <span class="token keyword">int</span> avr_x<span class="token punctuation">,</span> avr_y<span class="token punctuation">;</span>    <span class="token keyword">int</span> dst_x<span class="token punctuation">,</span> dst_y<span class="token punctuation">;</span>    avr_x <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>    avr_y <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>    dst_x <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">></span> avr_x <span class="token operator">?</span> x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> avr_x <span class="token operator">:</span> avr_x <span class="token operator">-</span> x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    dst_y <span class="token operator">=</span> y<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">></span> avr_y <span class="token operator">?</span> y<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> avr_y <span class="token operator">:</span> avr_y <span class="token operator">-</span> y<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>dst_x <span class="token operator">></span> ERR_LIMIT <span class="token operator">||</span> dst_x <span class="token operator">></span> ERR_LIMIT<span class="token punctuation">)</span> <span class="token comment">// 3与1、2</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    avr_x <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>    avr_y <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> x<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>    dst_x <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">></span> avr_x <span class="token operator">?</span> x<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> avr_x <span class="token operator">:</span> avr_x <span class="token operator">-</span> x<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    dst_y <span class="token operator">=</span> y<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">></span> avr_y <span class="token operator">?</span> y<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> avr_y <span class="token operator">:</span> avr_y <span class="token operator">-</span> y<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>dst_x <span class="token operator">></span> ERR_LIMIT <span class="token operator">||</span> dst_x <span class="token operator">></span> ERR_LIMIT<span class="token punctuation">)</span> <span class="token comment">// 4与2、3</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment">// 符合正确情况</span><span class="token punctuation">&#125;</span><span class="token comment">// adc采集完成会有进入adc isr</span><span class="token keyword">static</span> <span class="token class-name">irqreturn_t</span> <span class="token function">adc_irq</span><span class="token punctuation">(</span><span class="token keyword">int</span> irq<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dev_id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> x<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> y<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 保存4次结果 求均值用</span>    <span class="token comment">// // 优化措施2: adc完成前 已经松开，丢弃此次结果</span>    <span class="token comment">// if (adcregs->adcdat0 &amp; (1&lt;&lt;15)) &#123; // 松开</span>    <span class="token comment">//     // 等待下次按下</span>    <span class="token comment">//     enter_wait_pen_down_mode();</span>    <span class="token comment">// &#125; else &#123;</span>    <span class="token comment">//     // 测量值放在 ADCDAT0  ADCDAT1 打印电压测量值</span>    <span class="token comment">//     printk("irq cnt=%d, x=%d, y=%d\n", ++cnt, \    //             adcregs->adcdat0 &amp; (0x3ff), \    //             adcregs->adcdat1 &amp; (0x3ff));</span>    <span class="token comment">//     // 测量完 打印之后等待松开，否则测量一次，不明白为什么？？？</span>    <span class="token comment">//     enter_wait_pen_up_mode();</span>    <span class="token comment">// &#125;</span>    <span class="token comment">// // 优化措施3: 多次求平均值 （之前的优化也在）</span>    <span class="token comment">// if (adcregs->adcdat0 &amp; (1&lt;&lt;15)) &#123; // 松开</span>    <span class="token comment">//     // 等待下次按下</span>    <span class="token comment">//     enter_wait_pen_down_mode();</span>    <span class="token comment">// &#125; else &#123;</span>    <span class="token comment">//     x[cnt] = adcregs->adcdat0 &amp; (0x3ff);</span>    <span class="token comment">//     y[cnt] = adcregs->adcdat1 &amp; (0x3ff);</span>    <span class="token comment">//     ++cnt;</span>    <span class="token comment">//     if (cnt == 4) &#123;</span>    <span class="token comment">//         cnt = 0;</span>    <span class="token comment">//         // 测量值放在 ADCDAT0  ADCDAT1 打印电压测量值</span>    <span class="token comment">//         printk("irq cnt=%d, x=%d, y=%d\n", ++cnt, \    //                 (x[0]+x[1]+x[2]+x[3])/4, \    //                 (y[0]+y[1]+y[2]+y[3])/4);</span>    <span class="token comment">//         // 测量完 打印之后等待松开，否则测量一次，不明白为什么？？？</span>    <span class="token comment">//         enter_wait_pen_up_mode();</span>    <span class="token comment">//     &#125; else &#123;</span>    <span class="token comment">//         enter_measure_xy_mode(); // 进入测量模式</span>    <span class="token comment">//         start_adc();            </span>    <span class="token comment">//     &#125;</span>    <span class="token comment">// &#125;    </span>    <span class="token comment">// 优化措施4:  自定义过滤异常的值 ts_filter （之前的优化也在）</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>adcregs<span class="token operator">-></span>adcdat0 <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 松开</span>        cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token comment">// 等待下次按下</span>        <span class="token function">enter_wait_pen_down_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        x<span class="token punctuation">[</span>cnt<span class="token punctuation">]</span> <span class="token operator">=</span> adcregs<span class="token operator">-></span>adcdat0 <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">0x3ff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        y<span class="token punctuation">[</span>cnt<span class="token punctuation">]</span> <span class="token operator">=</span> adcregs<span class="token operator">-></span>adcdat1 <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">0x3ff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">++</span>cnt<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>cnt <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ts_filter</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 自定义过滤方法filter</span>                <span class="token comment">// 测量值放在 ADCDAT0  ADCDAT1 打印电压测量值</span>                <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"irq cnt=%d, x=%d, y=%d\n"</span><span class="token punctuation">,</span> <span class="token operator">++</span>cnt<span class="token punctuation">,</span> \                        <span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span>x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">+</span>x<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">,</span> \                        <span class="token punctuation">(</span>y<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span>y<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span>y<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">+</span>y<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 测量完 打印之后等待松开，否则测量一次，不明白为什么？？？</span>                <span class="token function">enter_wait_pen_up_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token function">enter_measure_xy_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 进入测量模式</span>            <span class="token function">start_adc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> IRQ_HANDLED<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 触摸按下松开进入中断函数</span><span class="token keyword">static</span> <span class="token class-name">irqreturn_t</span> <span class="token function">pen_down_up_irq</span><span class="token punctuation">(</span><span class="token keyword">int</span> irq<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dev_id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"pen down/up.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 分辨按下还是松开 判断adcdat0 bit15</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>adcregs<span class="token operator">-></span>adcdat0 <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 松开</span>        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"pen_up.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">enter_wait_pen_down_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 进入等待按下模式</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                          <span class="token comment">// 按下</span>        <span class="token comment">// printk("pen_down.\n");    </span>        <span class="token comment">// enter_wait_pen_up_mode();   // 进入等待松开模式</span>        <span class="token function">enter_measure_xy_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 进入测量模式</span>        <span class="token function">start_adc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 启动adc开始转换，转换需要时间，但是不等，</span>                     <span class="token comment">// 设置了adc中断，转换完成后会进入adc_irq</span>    <span class="token punctuation">&#125;</span><span class="token keyword">return</span> IRQ_HANDLED<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">s3c_ts_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">clk</span> <span class="token operator">*</span> adc_clock<span class="token punctuation">;</span> <span class="token comment">// adc的时钟，需要打开，内核上电关闭了</span>    <span class="token comment">// 1.分配input_dev结构体</span>    s3c_ts_dev <span class="token operator">=</span> <span class="token function">input_allocate_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2.设置该结构体</span>    <span class="token comment">// 2.1能产生哪类事件</span>    <span class="token function">set_bit</span><span class="token punctuation">(</span>EV_KEY<span class="token punctuation">,</span> s3c_ts_dev<span class="token operator">-></span>evbit<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">set_bit</span><span class="token punctuation">(</span>EV_ABS<span class="token punctuation">,</span> s3c_ts_dev<span class="token operator">-></span>evbit<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 绝对位置 </span>    <span class="token comment">// 2.2能产生这类事件的哪些事件</span>    <span class="token function">set_bit</span><span class="token punctuation">(</span>BTN_TOUCH<span class="token punctuation">,</span> s3c_ts_dev<span class="token operator">-></span>evbit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 点击，类button</span>    <span class="token comment">// void input_set_abs_params(input_dev *, int axis, int min, int max, int fuzz, int flat)</span>    <span class="token comment">//  ADC最大值最小值</span><span class="token function">input_set_abs_params</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">,</span> ABS_X<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x3FF</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">input_set_abs_params</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">,</span> ABS_Y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x3FF</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">input_set_abs_params</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">,</span> ABS_PRESSURE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3.注册</span>    <span class="token function">input_register_device</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4.硬件相关操作</span>    <span class="token comment">// 4.1使能adc时钟 CLKCON[15]</span>    adc_clock <span class="token operator">=</span> <span class="token function">clk_get</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"adc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">clk_enable</span><span class="token punctuation">(</span>adc_clock<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 打开时钟    </span>    <span class="token comment">// 4.2设置s3c的ADC/TS寄存器</span>    adcregs <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span><span class="token number">0x58000000</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">adc_regs</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// bit[14]  : 1 将pclck预分配</span>        <span class="token comment">// bit[13:6]: 分频系数 49</span>        <span class="token comment">//      ADCCLK=PCLK/(49+1)=50/(49+1)=1MHz</span>        <span class="token comment">// bit[0]   : 0 转换开始信号，现在不设置</span>    adcregs<span class="token operator">-></span>adccon <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">49</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 注册中断 中断号 触摸屏中断 isr 。。。</span>    <span class="token function">request_irq</span><span class="token punctuation">(</span>IRQ_TC<span class="token punctuation">,</span> pen_down_up_irq<span class="token punctuation">,</span> IRQF_SAMPLE_RANDOM<span class="token punctuation">,</span> \                <span class="token string">"ts_pen"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 注册ADC中断</span>    <span class="token function">request_irq</span><span class="token punctuation">(</span>IRQ_ADC<span class="token punctuation">,</span> adc_irq<span class="token punctuation">,</span> IRQF_SAMPLE_RANDOM<span class="token punctuation">,</span> \                <span class="token string">"adc"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 优化措施1: 延时测量，配置延时寄存器ADCDLY</span>    <span class="token comment">// 使得电压稳定后再发出IRQ_TC中断</span>    adcregs<span class="token operator">-></span>adcdly <span class="token operator">=</span> <span class="token number">0xffff</span><span class="token punctuation">;</span> <span class="token comment">// 延时最大值</span>        <span class="token comment">// 进入等待中断模式</span>    <span class="token function">enter_wait_pen_down_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 进入等待按下中断模式</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">s3c_ts_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">free_irq</span><span class="token punctuation">(</span>IRQ_TC<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free_irq</span><span class="token punctuation">(</span>IRQ_ADC<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    adcregs <span class="token operator">=</span> <span class="token function">iounmap</span><span class="token punctuation">(</span>adcregs<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">input_unregister_device</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">input_free_device</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>s3c_ts_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>s3c_ts_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="程序四-处理滑动长按-用定时器timer"><a href="#程序四-处理滑动长按-用定时器timer" class="headerlink" title="程序四 处理滑动长按 用定时器timer"></a>程序四 处理滑动长按 用定时器timer</h2><p>按下触摸屏，<br>发生IRQ_TC中断，设置成测量模式并启动ADC，<br>ADC转换完成发生中断，各种异常值处理优化措施，如果4次判断都是按下 则上报事件 并 则启动定时器，<br>定时时间到若还是按下则测量并启动ADC转换，不是按下则等待下次按下。</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/errno.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/input.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/serio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/delay.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/clk.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/irq.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/interrupt.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/plat-s3c24xx/ts.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/regs-adc.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/regs-gpio.h></span></span><span class="token keyword">struct</span> <span class="token class-name">adc_regs</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adccon<span class="token punctuation">;</span>      <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adctsc<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adcdly<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adcdat0<span class="token punctuation">;</span>     <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adcdat1<span class="token punctuation">;</span>     <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adcupdn<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span> s3c_ts_dev<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">struct</span> <span class="token class-name">adc_regs</span> <span class="token operator">*</span>adcregs<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">timer_list</span> ts_timer<span class="token punctuation">;</span> <span class="token comment">// 用于处理需要多次中断的 ts滑动长按</span><span class="token comment">// 进入等待松开中断模式</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">enter_wait_pen_up_mode</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    adcregs<span class="token operator">-></span>adctsc <span class="token operator">=</span> <span class="token number">0x1d3</span><span class="token punctuation">;</span> <span class="token comment">// bit8 1 = Detect Stylus Up Interrupt Signal.</span><span class="token punctuation">&#125;</span><span class="token comment">// 进入等待按下中断模式</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">enter_wait_pen_down_mode</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    adcregs<span class="token operator">-></span>adctsc <span class="token operator">=</span> <span class="token number">0xd3</span><span class="token punctuation">;</span>  <span class="token comment">// bit8 0 = Detect Stylus Down Interrupt Signal</span><span class="token punctuation">&#125;</span><span class="token comment">// 使adc进入 Auto(Sequential) X/Y Position Conversion Mode</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">enter_measure_xy_mode</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//      为啥不是 |= 可能其它位自动设置吧 </span>    adcregs<span class="token operator">-></span>adctsc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 1 = Auto Sequential measurement of X-position, Y-position.</span><span class="token punctuation">&#125;</span><span class="token comment">// 启动adc，开始转换</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">start_adc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    adcregs<span class="token operator">-></span>adccon <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 根据x y多次采样得到的数组计算正常的情况</span><span class="token comment">//  1 2 3 4  3与1、2平均值的差值应该&lt;ERR_LIMIT &amp;&amp; </span><span class="token comment">//           4与2、3平均值的差值应该&lt;ERR_LIMIT</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ts_filter</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> x<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> y<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ERR_LIMIT</span>   <span class="token expression"><span class="token number">10</span> </span><span class="token comment">// 像素误差极限</span></span>    <span class="token keyword">int</span> avr_x<span class="token punctuation">,</span> avr_y<span class="token punctuation">;</span>    <span class="token keyword">int</span> dst_x<span class="token punctuation">,</span> dst_y<span class="token punctuation">;</span>    avr_x <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>    avr_y <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>    dst_x <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">></span> avr_x <span class="token operator">?</span> x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> avr_x <span class="token operator">:</span> avr_x <span class="token operator">-</span> x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    dst_y <span class="token operator">=</span> y<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">></span> avr_y <span class="token operator">?</span> y<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> avr_y <span class="token operator">:</span> avr_y <span class="token operator">-</span> y<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>dst_x <span class="token operator">></span> ERR_LIMIT <span class="token operator">||</span> dst_x <span class="token operator">></span> ERR_LIMIT<span class="token punctuation">)</span> <span class="token comment">// 3与1、2</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    avr_x <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>    avr_y <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> x<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>    dst_x <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">></span> avr_x <span class="token operator">?</span> x<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> avr_x <span class="token operator">:</span> avr_x <span class="token operator">-</span> x<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    dst_y <span class="token operator">=</span> y<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">></span> avr_y <span class="token operator">?</span> y<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> avr_y <span class="token operator">:</span> avr_y <span class="token operator">-</span> y<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>dst_x <span class="token operator">></span> ERR_LIMIT <span class="token operator">||</span> dst_x <span class="token operator">></span> ERR_LIMIT<span class="token punctuation">)</span> <span class="token comment">// 4与2、3</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment">// 符合正确情况</span><span class="token punctuation">&#125;</span><span class="token comment">// 定时时间到 处理函数</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ts_timer_function</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>adcregs<span class="token operator">-></span>adcdat0 <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 已经松开</span>        <span class="token comment">// 等待下次按下</span>        <span class="token function">enter_wait_pen_down_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                          <span class="token comment">// 依然是按下</span>        <span class="token function">enter_measure_xy_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 进入测量模式</span>        <span class="token function">start_adc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// adc采集完成会有进入adc isr</span><span class="token keyword">static</span> <span class="token class-name">irqreturn_t</span> <span class="token function">adc_irq</span><span class="token punctuation">(</span><span class="token keyword">int</span> irq<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dev_id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> x<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> y<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 保存4次结果 求均值用</span>    <span class="token comment">// 优化措施4:  自定义过滤异常的值 ts_filter （之前的优化也在）</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>adcregs<span class="token operator">-></span>adcdat0 <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 松开</span>        cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment">// 等待下次按下</span>        <span class="token function">enter_wait_pen_down_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        x<span class="token punctuation">[</span>cnt<span class="token punctuation">]</span> <span class="token operator">=</span> adcregs<span class="token operator">-></span>adcdat0 <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">0x3ff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        y<span class="token punctuation">[</span>cnt<span class="token punctuation">]</span> <span class="token operator">=</span> adcregs<span class="token operator">-></span>adcdat1 <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">0x3ff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">++</span>cnt<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>cnt <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ts_filter</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 自定义过滤方法filter</span>                <span class="token comment">// 测量值放在 ADCDAT0  ADCDAT1 打印电压测量值</span>                <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"irq cnt=%d, x=%d, y=%d\n"</span><span class="token punctuation">,</span> <span class="token operator">++</span>cnt<span class="token punctuation">,</span> \                        <span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span>x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">+</span>x<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">,</span> \                         <span class="token punctuation">(</span>y<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span>y<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span>y<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">+</span>y<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">// 测量完 打印之后等待松开，否则测量一次，不明白为什么？？？</span>                <span class="token function">enter_wait_pen_up_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 启动定时器</span>                <span class="token function">mod_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ts_timer<span class="token punctuation">,</span> jiffies<span class="token operator">+</span>HZ<span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 10ms</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token function">enter_measure_xy_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 进入测量模式</span>            <span class="token function">start_adc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> IRQ_HANDLED<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 触摸按下松开进入中断函数</span><span class="token keyword">static</span> <span class="token class-name">irqreturn_t</span> <span class="token function">pen_down_up_irq</span><span class="token punctuation">(</span><span class="token keyword">int</span> irq<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dev_id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"pen down/up.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 分辨按下还是松开 判断adcdat0 bit15</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>adcregs<span class="token operator">-></span>adcdat0 <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 松开</span>        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"pen_up.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">enter_wait_pen_down_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 进入等待按下模式</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                          <span class="token comment">// 按下</span>        <span class="token comment">// printk("pen_down.\n");    </span>        <span class="token comment">// enter_wait_pen_up_mode();   // 进入等待松开模式</span>        <span class="token function">enter_measure_xy_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 进入测量模式</span>        <span class="token function">start_adc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 启动adc开始转换，转换需要时间，但是不等，</span>                     <span class="token comment">// 设置了adc中断，转换完成后会进入adc_irq</span>    <span class="token punctuation">&#125;</span><span class="token keyword">return</span> IRQ_HANDLED<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">s3c_ts_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">clk</span> <span class="token operator">*</span> adc_clock<span class="token punctuation">;</span> <span class="token comment">// adc的时钟，需要打开，内核上电关闭了</span>    <span class="token comment">// 1.分配input_dev结构体</span>    s3c_ts_dev <span class="token operator">=</span> <span class="token function">input_allocate_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2.设置该结构体</span>    <span class="token comment">// 2.1能产生哪类事件</span>    <span class="token function">set_bit</span><span class="token punctuation">(</span>EV_KEY<span class="token punctuation">,</span> s3c_ts_dev<span class="token operator">-></span>evbit<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">set_bit</span><span class="token punctuation">(</span>EV_ABS<span class="token punctuation">,</span> s3c_ts_dev<span class="token operator">-></span>evbit<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 绝对位置 </span>    <span class="token comment">// 2.2能产生这类事件的哪些事件</span>    <span class="token function">set_bit</span><span class="token punctuation">(</span>BTN_TOUCH<span class="token punctuation">,</span> s3c_ts_dev<span class="token operator">-></span>evbit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 点击，类button</span>    <span class="token comment">// void input_set_abs_params(input_dev *, int axis, int min, int max, int fuzz, int flat)</span>    <span class="token comment">//  ADC最大值最小值</span><span class="token function">input_set_abs_params</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">,</span> ABS_X<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x3FF</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">input_set_abs_params</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">,</span> ABS_Y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x3FF</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">input_set_abs_params</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">,</span> ABS_PRESSURE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3.注册</span>    <span class="token function">input_register_device</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4.硬件相关操作</span>    <span class="token comment">// 4.1使能adc时钟 CLKCON[15]</span>    adc_clock <span class="token operator">=</span> <span class="token function">clk_get</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"adc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">clk_enable</span><span class="token punctuation">(</span>adc_clock<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 打开时钟    </span>    <span class="token comment">// 4.2设置s3c的ADC/TS寄存器</span>    adcregs <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span><span class="token number">0x58000000</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">adc_regs</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// bit[14]  : 1 将pclck预分配</span>        <span class="token comment">// bit[13:6]: 分频系数 49</span>        <span class="token comment">//      ADCCLK=PCLK/(49+1)=50/(49+1)=1MHz</span>        <span class="token comment">// bit[0]   : 0 转换开始信号，现在不设置</span>    adcregs<span class="token operator">-></span>adccon <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">49</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 注册中断 中断号 触摸屏中断 isr 。。。</span>    <span class="token function">request_irq</span><span class="token punctuation">(</span>IRQ_TC<span class="token punctuation">,</span> pen_down_up_irq<span class="token punctuation">,</span> IRQF_SAMPLE_RANDOM<span class="token punctuation">,</span> \                <span class="token string">"ts_pen"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 注册ADC中断</span>    <span class="token function">request_irq</span><span class="token punctuation">(</span>IRQ_ADC<span class="token punctuation">,</span> adc_irq<span class="token punctuation">,</span> IRQF_SAMPLE_RANDOM<span class="token punctuation">,</span> \                <span class="token string">"adc"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 优化措施1: 延时测量，配置延时寄存器ADCDLY</span>    <span class="token comment">// 使得电压稳定后再发出IRQ_TC中断</span>    adcregs<span class="token operator">-></span>adcdly <span class="token operator">=</span> <span class="token number">0xffff</span><span class="token punctuation">;</span> <span class="token comment">// 延时最大值</span>        <span class="token comment">// 优化措施5：用定时器处理滑动长按</span>    <span class="token comment">//  </span>    <span class="token function">init_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ts_timer<span class="token punctuation">)</span><span class="token punctuation">;</span>    ts_timer<span class="token punctuation">.</span>function <span class="token operator">=</span> ts_timer_function<span class="token punctuation">;</span>    <span class="token function">add_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ts_timer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 进入等待中断模式</span>    <span class="token function">enter_wait_pen_down_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 进入等待按下中断模式</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">s3c_ts_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">del_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ts_timer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free_irq</span><span class="token punctuation">(</span>IRQ_TC<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free_irq</span><span class="token punctuation">(</span>IRQ_ADC<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    adcregs <span class="token operator">=</span> <span class="token function">iounmap</span><span class="token punctuation">(</span>adcregs<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">input_unregister_device</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">input_free_device</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>s3c_ts_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>s3c_ts_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 按下触摸屏，</span><span class="token comment">// 发生IRQ_TC中断，设置成测量模式并启动ADC，</span><span class="token comment">// ADC转换完成发生中断，各种异常值处理优化措施，</span><span class="token comment">//      如果4次判断都是按下 则上报事件 并 则启动定时器</span><span class="token comment">// 定时时间到若还是按下则测量并启动ADC转换，不是按下则等待下次按下</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="程序五-将打印改成上报事件-上报完毕"><a href="#程序五-将打印改成上报事件-上报完毕" class="headerlink" title="程序五 将打印改成上报事件 上报完毕"></a>程序五 将打印改成上报事件 上报完毕</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/errno.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/input.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/serio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/delay.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/clk.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/irq.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/interrupt.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/plat-s3c24xx/ts.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/regs-adc.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/regs-gpio.h></span></span><span class="token keyword">struct</span> <span class="token class-name">adc_regs</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adccon<span class="token punctuation">;</span>      <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adctsc<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adcdly<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adcdat0<span class="token punctuation">;</span>     <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adcdat1<span class="token punctuation">;</span>     <span class="token keyword">unsigned</span> <span class="token keyword">long</span> adcupdn<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span> s3c_ts_dev<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">struct</span> <span class="token class-name">adc_regs</span> <span class="token operator">*</span>adcregs<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">timer_list</span> ts_timer<span class="token punctuation">;</span> <span class="token comment">// 用于处理需要多次中断的 ts滑动长按</span><span class="token comment">// 进入等待松开中断模式</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">enter_wait_pen_up_mode</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    adcregs<span class="token operator">-></span>adctsc <span class="token operator">=</span> <span class="token number">0x1d3</span><span class="token punctuation">;</span> <span class="token comment">// bit8 1 = Detect Stylus Up Interrupt Signal.</span><span class="token punctuation">&#125;</span><span class="token comment">// 进入等待按下中断模式</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">enter_wait_pen_down_mode</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    adcregs<span class="token operator">-></span>adctsc <span class="token operator">=</span> <span class="token number">0xd3</span><span class="token punctuation">;</span>  <span class="token comment">// bit8 0 = Detect Stylus Down Interrupt Signal</span><span class="token punctuation">&#125;</span><span class="token comment">// 使adc进入 Auto(Sequential) X/Y Position Conversion Mode</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">enter_measure_xy_mode</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//      为啥不是 |= 可能其它位自动设置吧 </span>    adcregs<span class="token operator">-></span>adctsc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 1 = Auto Sequential measurement of X-position, Y-position.</span><span class="token punctuation">&#125;</span><span class="token comment">// 启动adc，开始转换</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">start_adc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    adcregs<span class="token operator">-></span>adccon <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 根据x y多次采样得到的数组计算正常的情况</span><span class="token comment">//  1 2 3 4  3与1、2平均值的差值应该&lt;ERR_LIMIT &amp;&amp; </span><span class="token comment">//           4与2、3平均值的差值应该&lt;ERR_LIMIT</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ts_filter</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> x<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> y<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ERR_LIMIT</span>   <span class="token expression"><span class="token number">10</span> </span><span class="token comment">// 像素误差极限</span></span>    <span class="token keyword">int</span> avr_x<span class="token punctuation">,</span> avr_y<span class="token punctuation">;</span>    <span class="token keyword">int</span> dst_x<span class="token punctuation">,</span> dst_y<span class="token punctuation">;</span>    avr_x <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>    avr_y <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>    dst_x <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">></span> avr_x <span class="token operator">?</span> x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> avr_x <span class="token operator">:</span> avr_x <span class="token operator">-</span> x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    dst_y <span class="token operator">=</span> y<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">></span> avr_y <span class="token operator">?</span> y<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> avr_y <span class="token operator">:</span> avr_y <span class="token operator">-</span> y<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>dst_x <span class="token operator">></span> ERR_LIMIT <span class="token operator">||</span> dst_x <span class="token operator">></span> ERR_LIMIT<span class="token punctuation">)</span> <span class="token comment">// 3与1、2</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    avr_x <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>    avr_y <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> x<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>    dst_x <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">></span> avr_x <span class="token operator">?</span> x<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> avr_x <span class="token operator">:</span> avr_x <span class="token operator">-</span> x<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    dst_y <span class="token operator">=</span> y<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">></span> avr_y <span class="token operator">?</span> y<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> avr_y <span class="token operator">:</span> avr_y <span class="token operator">-</span> y<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>dst_x <span class="token operator">></span> ERR_LIMIT <span class="token operator">||</span> dst_x <span class="token operator">></span> ERR_LIMIT<span class="token punctuation">)</span> <span class="token comment">// 4与2、3</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment">// 符合正确情况</span><span class="token punctuation">&#125;</span><span class="token comment">// 定时时间到 处理函数</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ts_timer_function</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>adcregs<span class="token operator">-></span>adcdat0 <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 已经松开</span>        <span class="token comment">// 等待下次按下</span>        <span class="token function">enter_wait_pen_down_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                          <span class="token comment">// 依然是按下</span>        <span class="token function">enter_measure_xy_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 进入测量模式</span>        <span class="token function">start_adc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// adc采集完成会有进入adc isr</span><span class="token keyword">static</span> <span class="token class-name">irqreturn_t</span> <span class="token function">adc_irq</span><span class="token punctuation">(</span><span class="token keyword">int</span> irq<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dev_id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> x<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> y<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 保存4次结果 求均值用</span>    <span class="token comment">// 优化措施4:  自定义过滤异常的值 ts_filter （之前的优化也在）</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>adcregs<span class="token operator">-></span>adcdat0 <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 松开</span>        cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment">// 上报事件</span>        <span class="token function">input_report_abs</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">,</span> ABS_PRESSURE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 多级压力 1表示按下</span>        <span class="token function">input_report_key</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">,</span> BTN_TOUCH<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1表示按下        </span>        <span class="token function">input_sync</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 上报完毕</span>        <span class="token comment">// 等待下次按下</span>        <span class="token function">enter_wait_pen_down_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        x<span class="token punctuation">[</span>cnt<span class="token punctuation">]</span> <span class="token operator">=</span> adcregs<span class="token operator">-></span>adcdat0 <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">0x3ff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        y<span class="token punctuation">[</span>cnt<span class="token punctuation">]</span> <span class="token operator">=</span> adcregs<span class="token operator">-></span>adcdat1 <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">0x3ff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token operator">++</span>cnt<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>cnt <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ts_filter</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 自定义过滤方法filter</span>                <span class="token comment">// 测量值放在 ADCDAT0  ADCDAT1 打印电压测量值</span>                <span class="token comment">// printk("irq cnt=%d, x=%d, y=%d\n", ++cnt, \                //         (x[0]+x[1]+x[2]+x[3])/4, \ </span>                <span class="token comment">//         (y[0]+y[1]+y[2]+y[3])/4); </span>                <span class="token comment">// 上报事件 绝对位移 压力 </span>                <span class="token function">input_report_abs</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">,</span> ABS_X<span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span>x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">+</span>x<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">input_report_abs</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">,</span> ABS_Y<span class="token punctuation">,</span> <span class="token punctuation">(</span>y<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span>y<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span>y<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">+</span>y<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">input_report_abs</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">,</span> ABS_PRESSURE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 多级压力 1表示按下</span>                <span class="token function">input_report_key</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">,</span> BTN_TOUCH<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1表示按下</span>                <span class="token function">input_sync</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 上报完毕</span>                <span class="token comment">// 测量完 打印之后等待松开，否则测量一次，不明白为什么？？？</span>                <span class="token function">enter_wait_pen_up_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 启动定时器</span>                <span class="token function">mod_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ts_timer<span class="token punctuation">,</span> jiffies<span class="token operator">+</span>HZ<span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 10ms</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token function">enter_measure_xy_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 进入测量模式</span>            <span class="token function">start_adc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> IRQ_HANDLED<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 触摸按下松开进入中断函数</span><span class="token keyword">static</span> <span class="token class-name">irqreturn_t</span> <span class="token function">pen_down_up_irq</span><span class="token punctuation">(</span><span class="token keyword">int</span> irq<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dev_id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"pen down/up.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 分辨按下还是松开 判断adcdat0 bit15</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>adcregs<span class="token operator">-></span>adcdat0 <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 松开</span>        <span class="token comment">// printk("pen_up.\n");</span>        <span class="token comment">// 上报事件</span>        <span class="token function">input_report_abs</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">,</span> ABS_PRESSURE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 多级压力 1表示按下</span>        <span class="token function">input_report_key</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">,</span> BTN_TOUCH<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">input_sync</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 上报完毕       </span>        <span class="token function">enter_wait_pen_down_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 进入等待按下模式</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                          <span class="token comment">// 按下</span>        <span class="token comment">// printk("pen_down.\n");    </span>        <span class="token comment">// enter_wait_pen_up_mode();   // 进入等待松开模式</span>        <span class="token function">enter_measure_xy_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 进入测量模式</span>        <span class="token function">start_adc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 启动adc开始转换，转换需要时间，但是不等，</span>                     <span class="token comment">// 设置了adc中断，转换完成后会进入adc_irq</span>    <span class="token punctuation">&#125;</span><span class="token keyword">return</span> IRQ_HANDLED<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">s3c_ts_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">clk</span> <span class="token operator">*</span> adc_clock<span class="token punctuation">;</span> <span class="token comment">// adc的时钟，需要打开，内核上电关闭了</span>    <span class="token comment">// 1.分配input_dev结构体</span>    s3c_ts_dev <span class="token operator">=</span> <span class="token function">input_allocate_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2.设置该结构体</span>    <span class="token comment">// 2.1能产生哪类事件</span>    <span class="token function">set_bit</span><span class="token punctuation">(</span>EV_KEY<span class="token punctuation">,</span> s3c_ts_dev<span class="token operator">-></span>evbit<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">set_bit</span><span class="token punctuation">(</span>EV_ABS<span class="token punctuation">,</span> s3c_ts_dev<span class="token operator">-></span>evbit<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 绝对位置 </span>    <span class="token comment">// 2.2能产生这类事件的哪些事件</span>    <span class="token function">set_bit</span><span class="token punctuation">(</span>BTN_TOUCH<span class="token punctuation">,</span> s3c_ts_dev<span class="token operator">-></span>evbit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 点击，类button</span>    <span class="token comment">// void input_set_abs_params(input_dev *, int axis, int min, int max, int fuzz, int flat)</span>    <span class="token comment">//  ADC最大值最小值</span><span class="token function">input_set_abs_params</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">,</span> ABS_X<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x3FF</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">input_set_abs_params</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">,</span> ABS_Y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x3FF</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">input_set_abs_params</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">,</span> ABS_PRESSURE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3.注册</span>    <span class="token function">input_register_device</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4.硬件相关操作</span>    <span class="token comment">// 4.1使能adc时钟 CLKCON[15]</span>    adc_clock <span class="token operator">=</span> <span class="token function">clk_get</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"adc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">clk_enable</span><span class="token punctuation">(</span>adc_clock<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 打开时钟    </span>    <span class="token comment">// 4.2设置s3c的ADC/TS寄存器</span>    adcregs <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span><span class="token number">0x58000000</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">adc_regs</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// bit[14]  : 1 将pclck预分配</span>        <span class="token comment">// bit[13:6]: 分频系数 49</span>        <span class="token comment">//      ADCCLK=PCLK/(49+1)=50/(49+1)=1MHz</span>        <span class="token comment">// bit[0]   : 0 转换开始信号，现在不设置</span>    adcregs<span class="token operator">-></span>adccon <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">49</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 注册中断 中断号 触摸屏中断 isr 。。。</span>    <span class="token function">request_irq</span><span class="token punctuation">(</span>IRQ_TC<span class="token punctuation">,</span> pen_down_up_irq<span class="token punctuation">,</span> IRQF_SAMPLE_RANDOM<span class="token punctuation">,</span> \                <span class="token string">"ts_pen"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 注册ADC中断</span>    <span class="token function">request_irq</span><span class="token punctuation">(</span>IRQ_ADC<span class="token punctuation">,</span> adc_irq<span class="token punctuation">,</span> IRQF_SAMPLE_RANDOM<span class="token punctuation">,</span> \                <span class="token string">"adc"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 优化措施1: 延时测量，配置延时寄存器ADCDLY</span>    <span class="token comment">// 使得电压稳定后再发出IRQ_TC中断</span>    adcregs<span class="token operator">-></span>adcdly <span class="token operator">=</span> <span class="token number">0xffff</span><span class="token punctuation">;</span> <span class="token comment">// 延时最大值</span>        <span class="token comment">// 优化措施5：用定时器处理滑动长按</span>    <span class="token comment">//  </span>    <span class="token function">init_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ts_timer<span class="token punctuation">)</span><span class="token punctuation">;</span>    ts_timer<span class="token punctuation">.</span>function <span class="token operator">=</span> ts_timer_function<span class="token punctuation">;</span>    <span class="token function">add_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ts_timer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 进入等待中断模式</span>    <span class="token function">enter_wait_pen_down_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 进入等待按下中断模式</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">s3c_ts_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">del_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ts_timer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free_irq</span><span class="token punctuation">(</span>IRQ_TC<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free_irq</span><span class="token punctuation">(</span>IRQ_ADC<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    adcregs <span class="token operator">=</span> <span class="token function">iounmap</span><span class="token punctuation">(</span>adcregs<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">input_unregister_device</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">input_free_device</span><span class="token punctuation">(</span>s3c_ts_dev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>s3c_ts_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>s3c_ts_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 按下触摸屏，</span><span class="token comment">// 发生IRQ_TC中断，设置成测量模式并启动ADC，</span><span class="token comment">// ADC转换完成发生中断，各种异常值处理优化措施，</span><span class="token comment">//      如果4次判断都是按下 则上报事件 并 则启动定时器</span><span class="token comment">// 定时时间到若还是按下则测量并启动ADC转换，不是按下则等待下次按下</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="测试程序五"><a href="#测试程序五" class="headerlink" title="测试程序五"></a>测试程序五</h2><ol><li>装在模块前 查看有哪些事件 <code>ls /dev/even*</code></li><li>然后 <code>insmod xxx.ko</code></li><li>装在模块后 查看有哪些事件 <code>ls /dev/even*</code> 新增加的对应触摸屏even</li><li><code>hexdump /dev/even0</code> 打开并读取<br><img src="/images/20200418232637921.png"><h2 id="将LCD和触摸对应起来-需要tslib库-校准触摸屏-生成校验文件-有很多测试程序"><a href="#将LCD和触摸对应起来-需要tslib库-校准触摸屏-生成校验文件-有很多测试程序" class="headerlink" title="将LCD和触摸对应起来 需要tslib库 校准触摸屏 生成校验文件 有很多测试程序"></a>将LCD和触摸对应起来 需要tslib库 校准触摸屏 生成校验文件 有很多测试程序</h2><img src="/images/20200418233817128.png"></li><li>解压 <code>tar xzf tslib1.4.tar.gz</code></li><li><code>cd tslib</code></li><li><code>./autogen.sh</code></li><li><code>mkdir temp</code> 存放临时结果</li><li>。。。。。</li></ol><p>可能出现段错误，内核配置后 需要重新编译驱动程序，跟装载过程有关。</p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第15课 2 3 4 LCD驱动程序之硬件操作 固定 可变参数 配置LCD控制器  LCD液晶时序和s3c的LCD时序，划内存做显存 调色板 输入子系统按键和LCD测试</title>
      <link href="2021/05/14/wds2-qi-di-15-ke-2-3-4-lcd-qu-dong-cheng-xu-zhi-ying-jian-cao-zuo-gu-ding-ke-bian-can-shu-pei-zhi-lcd-kong-zhi-qi-lcd-ye-jing-shi-xu-he-s3c-de-lcd-shi-xu-hua-nei-cun-zuo-xian-cun-diao-se-ban-shu-ru-zi-xi-tong-an-jian-he-lcd-ce-shi-local/"/>
      <url>2021/05/14/wds2-qi-di-15-ke-2-3-4-lcd-qu-dong-cheng-xu-zhi-ying-jian-cao-zuo-gu-ding-ke-bian-can-shu-pei-zhi-lcd-kong-zhi-qi-lcd-ye-jing-shi-xu-he-s3c-de-lcd-shi-xu-hua-nei-cun-zuo-xian-cun-diao-se-ban-shu-ru-zi-xi-tong-an-jian-he-lcd-ce-shi-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]<br><img src="/images/202004161534349.png"><br><img src="/images/20200416152730659.png"><br>LCD引脚相关作用：<br><strong>VCLK</strong>：发出lcd时钟信号，每来一个时钟，就会在屏幕上显示一个像素<br><strong>VD[3]~VD[7]</strong>  ：lcd数据总线<br><strong>VD[10]~VD[15]</strong> ：lcd数据总线<br><strong>VD[19]~VD[23]</strong> ：lcd数据总线<br>**VLINE(HSYNC)**：发出lcd行扫描信号<br>**VFRAME(VSYNC)**：发出lcd桢（垂直）扫描信号<br>**VM(VDEN)**：有效时才会在屏幕上显示像素，video enable<br><strong>LCD_PWREN</strong>：发出lcd面板电源使能控制信号</p><p>硬件相关设置步骤：</p><ol><li>配置引脚用于LCD</li><li>根据LCD手册，设置LCD控制器</li><li>分配显存，并把地址告诉LCD控制器</li></ol><p>参考内核的<code>drivers\video\s3c2410fb.c</code>，</p><p><img src="/images/20200416155342297.png"></p><h1 id="第一个程序，不能用，只有步骤注释"><a href="#第一个程序，不能用，只有步骤注释" class="headerlink" title="第一个程序，不能用，只有步骤注释"></a>第一个程序，不能用，只有步骤注释</h1><p>需要做的事情，流程如下：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/errno.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mm.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/delay.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fb.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/dma-mapping.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/interrupt.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/workqueue.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/wait.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/clk.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/uaccess.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/div64.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/mach/map.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/regs-lcd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/regs-gpio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/fb.h></span></span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>s3c_lcd_fbinfo<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">lcd_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 1. 分配一个fb_info</span>    <span class="token comment">//   内核结构分配小技巧，可以多分配些空间，</span>    <span class="token comment">//   结构内部有指针指向这段空间，私有空间，</span>    <span class="token comment">// |====|=|。 这里不需要额外空间所以0</span>    s3c_lcd_fbinfo <span class="token operator">=</span> <span class="token function">framebuffer_alloc</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 设置 分配的结构体</span>    <span class="token comment">// 2.1设置固定的参数</span>    <span class="token comment">// 2.2设置可变的参数</span>    <span class="token comment">// 2.3设置fb_ops</span>    <span class="token comment">// 其他设置</span>    <span class="token comment">// 3. 硬件相关操作</span>    <span class="token comment">// 3.1配置GPIO用于LCD</span>    <span class="token comment">// 3.2根据LCD手册设置LCD控制器，VCLK的频率等</span>    <span class="token comment">// 3.3分配显存(framebuffer),把地址告诉LCD控制器</span>    <span class="token comment">//      从内存中划出，这里没有实际显存</span>    <span class="token comment">// 4. 注册</span>    <span class="token function">register_framebuffer</span><span class="token punctuation">(</span>s3c_lcd_fbinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">lcd_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>lcd_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>lcd_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>固定参数，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">fb_fix_screeninfo</span> <span class="token punctuation">&#123;</span><span class="token keyword">char</span> id<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">/* identification string eg "TT Builtin" */</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> smem_start<span class="token punctuation">;</span><span class="token comment">/* Start of frame buffer mem */</span><span class="token comment">/* (physical address) */</span>__u32 smem_len<span class="token punctuation">;</span><span class="token comment">/* Length of frame buffer mem */</span>__u32 type<span class="token punctuation">;</span><span class="token comment">/* see FB_TYPE_**/</span>__u32 type_aux<span class="token punctuation">;</span><span class="token comment">/* Interleave for interleaved Planes */</span>__u32 visual<span class="token punctuation">;</span><span class="token comment">/* see FB_VISUAL_**/</span> __u16 xpanstep<span class="token punctuation">;</span><span class="token comment">/* zero if no hardware panning  */</span>__u16 ypanstep<span class="token punctuation">;</span><span class="token comment">/* zero if no hardware panning  */</span>__u16 ywrapstep<span class="token punctuation">;</span><span class="token comment">/* zero if no hardware ywrap    */</span>__u32 line_length<span class="token punctuation">;</span><span class="token comment">/* length of a line in bytes    */</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> mmio_start<span class="token punctuation">;</span><span class="token comment">/* Start of Memory Mapped I/O   */</span><span class="token comment">/* (physical address) */</span>__u32 mmio_len<span class="token punctuation">;</span><span class="token comment">/* Length of Memory Mapped I/O  */</span>__u32 accel<span class="token punctuation">;</span><span class="token comment">/* Indicate to driver which*/</span><span class="token comment">/*  specific chip/card we have*/</span>__u16 reserved<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">/* Reserved for future compatibility */</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可变参数，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">fb_var_screeninfo</span> <span class="token punctuation">&#123;</span>__u32 xres<span class="token punctuation">;</span><span class="token comment">/* visible resolution*/</span>__u32 yres<span class="token punctuation">;</span>__u32 xres_virtual<span class="token punctuation">;</span><span class="token comment">/* virtual resolution*/</span>__u32 yres_virtual<span class="token punctuation">;</span>__u32 xoffset<span class="token punctuation">;</span><span class="token comment">/* offset from virtual to visible */</span>__u32 yoffset<span class="token punctuation">;</span><span class="token comment">/* resolution*/</span>__u32 bits_per_pixel<span class="token punctuation">;</span><span class="token comment">/* guess what*/</span>__u32 grayscale<span class="token punctuation">;</span><span class="token comment">/* != 0 Graylevels instead of colors */</span><span class="token keyword">struct</span> <span class="token class-name">fb_bitfield</span> red<span class="token punctuation">;</span><span class="token comment">/* bitfield in fb mem if true color, */</span><span class="token keyword">struct</span> <span class="token class-name">fb_bitfield</span> green<span class="token punctuation">;</span><span class="token comment">/* else only length is significant */</span><span class="token keyword">struct</span> <span class="token class-name">fb_bitfield</span> blue<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">fb_bitfield</span> transp<span class="token punctuation">;</span><span class="token comment">/* transparency*/</span>__u32 nonstd<span class="token punctuation">;</span><span class="token comment">/* != 0 Non standard pixel format */</span>__u32 activate<span class="token punctuation">;</span><span class="token comment">/* see FB_ACTIVATE_**/</span>__u32 height<span class="token punctuation">;</span><span class="token comment">/* height of picture in mm    */</span>__u32 width<span class="token punctuation">;</span><span class="token comment">/* width of picture in mm     */</span>__u32 accel_flags<span class="token punctuation">;</span><span class="token comment">/* (OBSOLETE) see fb_info.flags */</span><span class="token comment">/* Timing: All values in pixclocks, except pixclock (of course) */</span>__u32 pixclock<span class="token punctuation">;</span><span class="token comment">/* pixel clock in ps (pico seconds) */</span>__u32 left_margin<span class="token punctuation">;</span><span class="token comment">/* time from sync to picture*/</span>__u32 right_margin<span class="token punctuation">;</span><span class="token comment">/* time from picture to sync*/</span>__u32 upper_margin<span class="token punctuation">;</span><span class="token comment">/* time from sync to picture*/</span>__u32 lower_margin<span class="token punctuation">;</span>__u32 hsync_len<span class="token punctuation">;</span><span class="token comment">/* length of horizontal sync*/</span>__u32 vsync_len<span class="token punctuation">;</span><span class="token comment">/* length of vertical sync*/</span>__u32 sync<span class="token punctuation">;</span><span class="token comment">/* see FB_SYNC_**/</span>__u32 vmode<span class="token punctuation">;</span><span class="token comment">/* see FB_VMODE_**/</span>__u32 rotate<span class="token punctuation">;</span><span class="token comment">/* angle we rotate counter clockwise */</span>__u32 reserved<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">/* Reserved for future compatibility */</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>RGB位范围设置，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">fb_bitfield</span> <span class="token punctuation">&#123;</span>__u32 offset<span class="token punctuation">;</span><span class="token comment">/* beginning of bitfield*/</span>__u32 length<span class="token punctuation">;</span><span class="token comment">/* length of bitfield*/</span>__u32 msb_right<span class="token punctuation">;</span><span class="token comment">/* != 0 : Most significant bit is */</span>  <span class="token comment">// 最重要的位在左边所以设置0默认就是</span><span class="token comment">/* right */</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>显示屏硬件相关资料：<br><img src="/images/20200416161534917.png"></p><h1 id="第二个程序，不能用，完成了一些步骤"><a href="#第二个程序，不能用，完成了一些步骤" class="headerlink" title="第二个程序，不能用，完成了一些步骤"></a>第二个程序，不能用，完成了一些步骤</h1><p>配置可变参数和不可变参数，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/errno.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mm.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/delay.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fb.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/dma-mapping.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/interrupt.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/workqueue.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/wait.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/clk.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/uaccess.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/div64.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/mach/map.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/regs-lcd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/regs-gpio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/fb.h></span></span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>s3c_lcd_fbinfo<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">fb_ops</span> s3c_lcdfb_ops <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>owner<span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span><span class="token comment">// .fb_setcolreg= atmel_lcdfb_setcolreg,</span><span class="token punctuation">.</span>fb_fillrect<span class="token operator">=</span> cfb_fillrect<span class="token punctuation">,</span><span class="token punctuation">.</span>fb_copyarea<span class="token operator">=</span> cfb_copyarea<span class="token punctuation">,</span><span class="token punctuation">.</span>fb_imageblit<span class="token operator">=</span> cfb_imageblit<span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">lcd_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 1. 分配一个fb_info</span>    <span class="token comment">//   内核结构分配小技巧，可以多分配些空间，</span>    <span class="token comment">//   结构内部有指针指向这段空间，私有空间，</span>    <span class="token comment">// |====|=|。 这里不需要额外空间所以0</span>    s3c_lcd_fbinfo <span class="token operator">=</span> <span class="token function">framebuffer_alloc</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 设置 分配的结构体，</span>    <span class="token comment">// 2.1设置固定的参数 未设置的分配之后都是0</span>    <span class="token function">strcpy</span><span class="token punctuation">(</span>s3c_lcd_fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token string">"mylcd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// id name</span>    s3c_lcd_fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>smem_len    <span class="token operator">=</span> <span class="token number">240</span><span class="token operator">*</span><span class="token number">320</span><span class="token operator">*</span><span class="token number">16</span><span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">;</span><span class="token comment">// 显存的长度 16=5+6+5</span>    s3c_lcd_fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>type        <span class="token operator">=</span> FB_TYPE_PACKED_PIXELS<span class="token punctuation">;</span><span class="token comment">// see FB_TYPE_*</span>        <span class="token comment">// s3c_lcd_fbinfo->fix.type_aux = 平板会用到</span>    s3c_lcd_fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>visual      <span class="token operator">=</span> FB_VISUAL_TRUECOLOR<span class="token punctuation">;</span> <span class="token comment">// TFT屏幕是真彩 MONO单色</span>    s3c_lcd_fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>line_length <span class="token operator">=</span> <span class="token number">240</span><span class="token operator">*</span><span class="token number">16</span><span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">// 一个像素由16位表示就是2Bytes，length of a line in bytes</span>    <span class="token comment">// 2.2设置可变的参数</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>xres         <span class="token operator">=</span> <span class="token number">240</span><span class="token punctuation">;</span> <span class="token comment">// 实际分辨率</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>yres         <span class="token operator">=</span> <span class="token number">320</span><span class="token punctuation">;</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>xres_virtual <span class="token operator">=</span> <span class="token number">240</span><span class="token punctuation">;</span> <span class="token comment">// 可调整的分辨率</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>yres_virtual <span class="token operator">=</span> <span class="token number">320</span><span class="token punctuation">;</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>bits_per_pixel <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span><span class="token comment">// 2440不支持18位，丢弃2位</span>        <span class="token comment">// RGB 565 R:11 G:5 B:0</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>red<span class="token punctuation">.</span>offset   <span class="token operator">=</span>  <span class="token number">11</span><span class="token punctuation">;</span><span class="token comment">// red对应位的区域</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>red<span class="token punctuation">.</span>length   <span class="token operator">=</span>  <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">// red长度</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>green<span class="token punctuation">.</span>offset <span class="token operator">=</span>  <span class="token number">5</span><span class="token punctuation">;</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>green<span class="token punctuation">.</span>length <span class="token operator">=</span>  <span class="token number">6</span><span class="token punctuation">;</span>     s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>blue<span class="token punctuation">.</span>offset  <span class="token operator">=</span>  <span class="token number">0</span><span class="token punctuation">;</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>blue<span class="token punctuation">.</span>length  <span class="token operator">=</span>  <span class="token number">5</span><span class="token punctuation">;</span>     s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>activate     <span class="token operator">=</span>  FB_ACTIVATE_NOW<span class="token punctuation">;</span>       <span class="token comment">// 2.3设置fb_ops. 参考drivers\video\atmel_lcdfb.c</span>    s3c_lcd_fbinfo<span class="token operator">-></span>fbops <span class="token operator">=</span> <span class="token operator">&amp;</span>s3c_lcdfb_ops<span class="token punctuation">;</span>    <span class="token comment">// 其他设置</span>    <span class="token comment">// s3c_lcd_fbinfo->pseudo_palette  = ; // 假调色板16种颜色 Fake palette of 16 colors </span>    <span class="token comment">// s3c_lcd_fbinfo->screen_base     = ; // 显存的虚拟地址 如果没提供write就用到screen_base</span>    s3c_lcd_fbinfo<span class="token operator">-></span>screen_size     <span class="token operator">=</span> <span class="token number">240</span><span class="token operator">*</span><span class="token number">320</span><span class="token operator">*</span><span class="token number">16</span><span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">// Amount of ioremapped VRAM or 0</span>    <span class="token comment">// 3. 硬件相关操作</span>    <span class="token comment">// 3.1配置GPIO用于LCD</span>    <span class="token comment">// 3.2根据LCD手册设置LCD控制器，VCLK的频率等</span>    <span class="token comment">// 3.3分配显存(framebuffer),把地址告诉LCD控制器</span>    <span class="token comment">//      从内存中划出，这里没有实际显存</span>    s3c_lcd_fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>smem_start <span class="token operator">=</span> <span class="token punctuation">;</span> <span class="token comment">// 显存的物理地址</span>    <span class="token comment">// 4. 注册</span>    <span class="token function">register_framebuffer</span><span class="token punctuation">(</span>s3c_lcd_fbinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">lcd_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>lcd_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>lcd_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="配置硬件相关"><a href="#配置硬件相关" class="headerlink" title="配置硬件相关"></a>配置硬件相关</h1><p>GPB0控制背光，配置为输出引脚，不太对，根据具体板子说吧<br><img src="/images/20200416173921996.png"><br><img src="/images/20200416181204127.png"><br>在LCD手册的P14页，看到最小LCD刷新的时钟为<code>100ns(10MHz)</code><br><img src="/images/20200416214755734.png"></p><h2 id="设置LCDCON1："><a href="#设置LCDCON1：" class="headerlink" title="设置LCDCON1："></a>设置LCDCON1：</h2><p><img src="/images/2020041622023574.png"><br>查看Linux内核时钟频率<code>dmesg</code>：<br><img src="/images/20200416220725253.png"></p><h2 id="设置LCDCON2："><a href="#设置LCDCON2：" class="headerlink" title="设置LCDCON2："></a>设置LCDCON2：</h2><p><img src="/images/20200417174002623.png"><br>液晶屏垂直（frame）方向时序，<br><img src="/images/20200417173341600.png"><br>s3c2440 TFT液晶时序，<br><img src="/images/20200417173638544.png"><br>VSPW：0 = 1 - 1<br>LINEVAL：319 = 320 - 1<br>VFPD：1 = T2-T5 - 1 = 2 - 1<br>VBPD：3 = 327 - 322 - 1 - 1</p><h2 id="设置LCDCON3-4："><a href="#设置LCDCON3-4：" class="headerlink" title="设置LCDCON3/4："></a>设置LCDCON3/4：</h2><p>LCD水平时序，<br><img src="/images/20200417180152737.png"></p><h2 id="设置-LCDCON3，4"><a href="#设置-LCDCON3，4" class="headerlink" title="设置 LCDCON3，4"></a>设置 LCDCON3，4</h2><p><img src="/images/20200417180322374.png"><br><img src="/images/20200417180647884.png"></p><h2 id="设置-LCDCON5"><a href="#设置-LCDCON5" class="headerlink" title="设置 LCDCON5"></a>设置 LCDCON5</h2><p><img src="/images/20200417182510991.png"><br>BSWP HWSWP，字节顺序交换<br><img src="/images/20200417184509313.png"><br>设置好LCD控制器后，LCD控制器就会自动从显存中周期性的取出每个像素数据</p><h1 id="分配显存-用SDRAM代替"><a href="#分配显存-用SDRAM代替" class="headerlink" title="分配显存 用SDRAM代替"></a>分配显存 用SDRAM代替</h1><p>LCD控制器需要SDRAM内存连续才行，查看内核自带的驱动怎么分配这块连续内存的，参考drivers\video\s3c2410fb.c，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">s3c2410fb_map_video_memory</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">s3c2410fb_info</span> <span class="token operator">*</span>fbi<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">dprintk</span><span class="token punctuation">(</span><span class="token string">"map_video_memory(fbi=%p)\n"</span><span class="token punctuation">,</span> fbi<span class="token punctuation">)</span><span class="token punctuation">;</span>fbi<span class="token operator">-></span>map_size <span class="token operator">=</span> <span class="token function">PAGE_ALIGN</span><span class="token punctuation">(</span>fbi<span class="token operator">-></span>fb<span class="token operator">-></span>fix<span class="token punctuation">.</span>smem_len <span class="token operator">+</span> PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>fbi<span class="token operator">-></span>map_cpu  <span class="token operator">=</span> <span class="token function">dma_alloc_writecombine</span><span class="token punctuation">(</span>fbi<span class="token operator">-></span>dev<span class="token punctuation">,</span> fbi<span class="token operator">-></span>map_size<span class="token punctuation">,</span>       <span class="token operator">&amp;</span>fbi<span class="token operator">-></span>map_dma<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>fbi<span class="token operator">-></span>map_size <span class="token operator">=</span> fbi<span class="token operator">-></span>fb<span class="token operator">-></span>fix<span class="token punctuation">.</span>smem_len<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>将申请到的连续内存空间的虚拟告知显存，<br><img src="/images/20200417201703740.png"><br><img src="/images/20200417201651604.png"><br><img src="/images/20200417203447560.png"></p><h1 id="第三个程序，调色板没有设置"><a href="#第三个程序，调色板没有设置" class="headerlink" title="第三个程序，调色板没有设置"></a>第三个程序，调色板没有设置</h1><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/errno.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mm.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/delay.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fb.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/dma-mapping.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/interrupt.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/workqueue.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/wait.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/clk.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/uaccess.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/div64.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/mach/map.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/regs-lcd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/regs-gpio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/fb.h></span></span><span class="token comment">// s3c的LCD寄存器</span><span class="token keyword">struct</span> <span class="token class-name">s3c_lcd_regs</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> lcdcon1<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> lcdcon2<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> lcdcon3<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> lcdcon4<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> lcdcon5<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> lcdsaddr1<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> lcdsaddr2<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> lcdsaddr3<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> redlut<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> greenlut<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> bluelut<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> reserved<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 连续的4字节，这里不连续，空出来</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> dithmode<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> tpal<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> lcdintpnd<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> lcdsrcpnd<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> lcdintmsk<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> tconsel<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// s3c的LCD引脚设置</span><span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpbcon<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpbdat<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpccon<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpdcon<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpgcon<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">struct</span> <span class="token class-name">s3c_lcd_regs</span> <span class="token operator">*</span>lcd_regs<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>s3c_lcd_fbinfo<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">fb_ops</span> s3c_lcdfb_ops <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>owner<span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span><span class="token comment">// .fb_setcolreg= atmel_lcdfb_setcolreg,</span><span class="token punctuation">.</span>fb_fillrect<span class="token operator">=</span> cfb_fillrect<span class="token punctuation">,</span><span class="token punctuation">.</span>fb_copyarea<span class="token operator">=</span> cfb_copyarea<span class="token punctuation">,</span><span class="token punctuation">.</span>fb_imageblit<span class="token operator">=</span> cfb_imageblit<span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">lcd_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 1. 分配一个fb_info</span>    <span class="token comment">//   内核结构分配小技巧，可以多分配些空间，</span>    <span class="token comment">//   结构内部有指针指向这段空间，私有空间，</span>    <span class="token comment">// |====|=|。 这里不需要额外空间所以0</span>    s3c_lcd_fbinfo <span class="token operator">=</span> <span class="token function">framebuffer_alloc</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 设置 分配的结构体，</span>    <span class="token comment">// 2.1设置固定的参数 未设置的分配之后都是0</span>    <span class="token function">strcpy</span><span class="token punctuation">(</span>s3c_lcd_fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token string">"mylcd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// id name</span>    s3c_lcd_fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>smem_len    <span class="token operator">=</span> <span class="token number">240</span><span class="token operator">*</span><span class="token number">320</span><span class="token operator">*</span><span class="token number">16</span><span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">;</span><span class="token comment">// 显存的长度 16=5+6+5</span>    s3c_lcd_fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>type        <span class="token operator">=</span> FB_TYPE_PACKED_PIXELS<span class="token punctuation">;</span><span class="token comment">// see FB_TYPE_*</span>        <span class="token comment">// s3c_lcd_fbinfo->fix.type_aux = 平板会用到</span>    s3c_lcd_fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>visual      <span class="token operator">=</span> FB_VISUAL_TRUECOLOR<span class="token punctuation">;</span> <span class="token comment">// TFT屏幕是真彩 MONO单色</span>    s3c_lcd_fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>line_length <span class="token operator">=</span> <span class="token number">240</span><span class="token operator">*</span><span class="token number">16</span><span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">// 一个像素由16位表示就是2Bytes，length of a line in bytes</span>    <span class="token comment">// 2.2设置可变的参数</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>xres         <span class="token operator">=</span> <span class="token number">240</span><span class="token punctuation">;</span> <span class="token comment">// 实际分辨率</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>yres         <span class="token operator">=</span> <span class="token number">320</span><span class="token punctuation">;</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>xres_virtual <span class="token operator">=</span> <span class="token number">240</span><span class="token punctuation">;</span> <span class="token comment">// 可调整的分辨率</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>yres_virtual <span class="token operator">=</span> <span class="token number">320</span><span class="token punctuation">;</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>bits_per_pixel <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span><span class="token comment">// 2440不支持18位，丢弃2位</span>        <span class="token comment">// RGB 565 R:11 G:5 B:0</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>red<span class="token punctuation">.</span>offset   <span class="token operator">=</span>  <span class="token number">11</span><span class="token punctuation">;</span><span class="token comment">// red对应位的区域</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>red<span class="token punctuation">.</span>length   <span class="token operator">=</span>  <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">// red长度</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>green<span class="token punctuation">.</span>offset <span class="token operator">=</span>  <span class="token number">5</span><span class="token punctuation">;</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>green<span class="token punctuation">.</span>length <span class="token operator">=</span>  <span class="token number">6</span><span class="token punctuation">;</span>     s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>blue<span class="token punctuation">.</span>offset  <span class="token operator">=</span>  <span class="token number">0</span><span class="token punctuation">;</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>blue<span class="token punctuation">.</span>length  <span class="token operator">=</span>  <span class="token number">5</span><span class="token punctuation">;</span>     s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>activate     <span class="token operator">=</span>  FB_ACTIVATE_NOW<span class="token punctuation">;</span>       <span class="token comment">// 2.3设置fb_ops. 参考drivers\video\atmel_lcdfb.c</span>    s3c_lcd_fbinfo<span class="token operator">-></span>fbops <span class="token operator">=</span> <span class="token operator">&amp;</span>s3c_lcdfb_ops<span class="token punctuation">;</span>    <span class="token comment">// 2.4其他设置</span>    <span class="token comment">// s3c_lcd_fbinfo->pseudo_palette  = ; // 假调色板16种颜色 Fake palette of 16 colors </span>    <span class="token comment">// s3c_lcd_fbinfo->screen_base     = ; // 显存的虚拟地址 如果没提供write就用到screen_base</span>    s3c_lcd_fbinfo<span class="token operator">-></span>screen_size     <span class="token operator">=</span> <span class="token number">240</span><span class="token operator">*</span><span class="token number">320</span><span class="token operator">*</span><span class="token number">16</span><span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">// Amount of ioremapped VRAM or 0</span>    <span class="token comment">// 3. 硬件相关操作</span>    <span class="token comment">// 3.1配置GPIO用于LCD</span>    gpbcon <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span><span class="token number">0x56000010</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 一页一页的映射 1024字节</span>    gpbdat <span class="token operator">=</span> gpbcon <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    gpccon <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span><span class="token number">0x56000020</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 4和8一样 一页一页的映射 1024字节</span>    gpdcon <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span><span class="token number">0x56000030</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    gpgcon <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span><span class="token number">0x56000060</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">*</span>gpccon <span class="token operator">=</span> <span class="token number">0xaaaaaaaa</span><span class="token punctuation">;</span> <span class="token comment">// GPIO管脚用于VD[7:0] LCDVF[2:0] VM VFRAME VLINE LEND</span>    <span class="token operator">*</span>gpdcon <span class="token operator">=</span> <span class="token number">0xaaaaaaaa</span><span class="token punctuation">;</span> <span class="token comment">// GPIO管脚用于VD[23:8]</span>    <span class="token operator">*</span>gpbcon <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 设置GPB0为输出引脚 背光</span>    <span class="token operator">*</span>gpbcon <span class="token operator">|=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token operator">*</span>gpbdat <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token comment">// 输出低电平</span>    <span class="token operator">*</span>gpgcon <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// GPG4用作LCD_PWREN LCD电源使能引脚</span>    <span class="token comment">// 3.2根据LCD手册设置LCD控制器，VCLK的频率等</span>    lcd_regs <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span><span class="token number">0x4d000000</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>lcd_regs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 寄存器组映射</span>        <span class="token comment">// bit[17:8]: TFT: VCLK = HCLK / [(CLKVAL+1) x 2] (CLKVAL‡ 0)</span>        <span class="token comment">//                  VCLK(扫描时钟)&lt;=10MHz  HCLK(内核时钟频率) 100MHz</span>        <span class="token comment">//                  10MHz(100ns)=100MHz/[(CLKVAL+1)x2]-->CLKVAL=4</span>        <span class="token comment">// bit[6:5] : 11 = TFT LCD panel</span>        <span class="token comment">// bit[4:1] : 1100 = 16 bpp for TFT. BPP (Bits Per Pixel) mode.</span>        <span class="token comment">// bit[0]   : 0 = Disable the video output and the LCD control signal.</span>    lcd_regs<span class="token operator">-></span>lcdcon1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">0x0C</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 垂直方向的时间参数</span>        <span class="token comment">// bit[31:24]: VBPD VSYNC过多长时间后才能发出第一行数据</span>        <span class="token comment">//                  LCD手册上T0-T2-T1=4 所以VBPD = 3</span>        <span class="token comment">// bit[23:14]: LINEVAL 多少行，320 所以LINEVAL = 319</span>        <span class="token comment">// bit[13:6] : VFPD 发出最后一行数据后过多久才发出VSYNC信号</span>        <span class="token comment">//                  LCD手册T2-T5=322-320=2， 所以=1</span>        <span class="token comment">// bit[5:0]  : VSYNC VSYNC信号脉冲宽度，LCD手册T1=1 所以=0</span>    lcd_regs<span class="token operator">-></span>lcdcon2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">&lt;&lt;</span><span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">319</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 水平方向的时间参数</span>        <span class="token comment">// bit[25:19]: HBPD HSYNC过多长时间后才能发出第一个像素数据</span>        <span class="token comment">//                  LCD手册 T6-T7-T8=17 所以16</span>        <span class="token comment">// bit[18:8] : HOZVAL 多少列 240 所以239</span>        <span class="token comment">// bit[7:0]  : HFPD 发出最后一行最后一个像素后过多久才发出HSYNC信号</span>        <span class="token comment">//                  LCD手册 T8-T11=11 所以10</span>    lcd_regs<span class="token operator">-></span>lcdcon3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">16</span><span class="token operator">&lt;&lt;</span><span class="token number">19</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">239</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// bit[7:0]  : HSPW HSYNC的脉冲宽度 LCD手册T7=5 所以4 </span>    lcd_regs<span class="token operator">-></span>lcdcon4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 信号的极性</span>        <span class="token comment">// bit[11]: 1=565 Format</span>        <span class="token comment">// bit[10]: 0 = The video data is fetched at VCLK falling edge</span>        <span class="token comment">// bit[9] : 1 反转HSYNC 低电平有效</span>        <span class="token comment">// bit[8] : 1 反转VSYNC 低电平有效</span>        <span class="token comment">// bit[6] : 0 VDEN不用反转</span>        <span class="token comment">// bit[3] : 0 PWREN输出0</span>        <span class="token comment">// bit[1] : 0 BSWP</span>        <span class="token comment">// bit[0] : 1 HWSWP 2440手册P413</span>    lcd_regs<span class="token operator">-></span>lcdcon5 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3.3分配显存(framebuffer),把地址告诉LCD控制器</span>    <span class="token comment">//      从内存中划出，这里没有实际显存,需要连续内存</span>    <span class="token comment">//      返回虚拟地址</span>    s3c_lcd_fbinfo<span class="token operator">-></span>screen_base <span class="token operator">=</span> <span class="token function">dma_alloc_writecombine</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> \                    s3c_lcd_fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>smem_len<span class="token punctuation">,</span> \                    s3c_lcd_fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>smem_start<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 告诉lcd控制器 显存的起始地址</span>    lcd_regs<span class="token operator">-></span>lcdsaddr1 <span class="token operator">=</span> <span class="token punctuation">(</span>s3c_lcd_fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>smem_start<span class="token operator">>></span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">&lt;&lt;</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0~29bit 30 31清0</span>        <span class="token comment">// 告诉lcd控制器显存的结束地址</span>    lcd_regs<span class="token operator">-></span>lcdsaddr2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s3c_lcd_fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>smem_start<span class="token operator">+</span>s3c_lcd_fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>smem_len<span class="token punctuation">)</span><span class="token operator">>></span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> \                        <span class="token number">0x1fffff</span><span class="token punctuation">;</span> <span class="token comment">// 0~20bit</span>        <span class="token comment">// 一行显示的长度（单位：半字）</span>    lcd_regs<span class="token operator">-></span>lcdsaddr3 <span class="token operator">=</span> <span class="token number">240</span><span class="token operator">*</span><span class="token number">16</span><span class="token operator">/</span><span class="token number">16</span><span class="token punctuation">;</span>    <span class="token comment">// s3c_lcd_fbinfo->fix.smem_start = ; // 显存的物理地址</span>    <span class="token comment">// 启动LCD </span>    lcd_regs<span class="token operator">-></span>lcdcon1 <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使能LCD</span>    <span class="token operator">*</span>gpbdat <span class="token operator">|=</span> <span class="token number">1</span><span class="token punctuation">;</span>                <span class="token comment">// 打开背光</span>            <span class="token comment">// 4. 注册</span>    <span class="token function">register_framebuffer</span><span class="token punctuation">(</span>s3c_lcd_fbinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">lcd_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>lcd_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>lcd_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="调色板"><a href="#调色板" class="headerlink" title="调色板"></a>调色板</h2><p>每个像素所占数据为16bit，假如想节省内存，只用一个8bit的数据转换后去代替LCD硬件所需16bit，中间加入调色板，调色板存放真正的16bit数据，8bit数据作为索引在调色板上找到16bit正真的颜色数据，然后给LCD。<br>为了兼容一些程序，需要提供假的调色板<br><img src="/images/20200417205417183.png"><br>参考内核代码，自己写一个假的调色板，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">drivers\video\s3c2410fb<span class="token punctuation">.</span>c<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">s3c2410fb_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>fbinfo<span class="token operator">-></span>pseudo_palette      <span class="token operator">=</span> <span class="token operator">&amp;</span>info<span class="token operator">-></span>pseudo_pal<span class="token punctuation">;</span>drivers\video\s3c2410fb<span class="token punctuation">.</span>h<span class="token keyword">struct</span> <span class="token class-name">s3c2410fb_info</span> <span class="token punctuation">&#123;</span>u32palette_buffer<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>u32pseudo_pal<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="第四个程序，基本完成-添加调色板-但是我找不到s3c-lcd-fbinfo-gt-fix-smem-start显存的物理地址"><a href="#第四个程序，基本完成-添加调色板-但是我找不到s3c-lcd-fbinfo-gt-fix-smem-start显存的物理地址" class="headerlink" title="第四个程序，基本完成 添加调色板 但是我找不到s3c_lcd_fbinfo-&gt;fix.smem_start显存的物理地址"></a>第四个程序，基本完成 添加调色板 但是我找不到s3c_lcd_fbinfo-&gt;fix.smem_start显存的物理地址</h1><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/errno.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mm.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/delay.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fb.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/dma-mapping.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/interrupt.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/workqueue.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/wait.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/clk.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/uaccess.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/div64.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/mach/map.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/regs-lcd.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/regs-gpio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/fb.h></span></span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">s3c_lcdfb_setcolreg</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> regno<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> red<span class="token punctuation">,</span>     <span class="token keyword">unsigned</span> <span class="token keyword">int</span> green<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> blue<span class="token punctuation">,</span>     <span class="token keyword">unsigned</span> <span class="token keyword">int</span> transp<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// s3c的LCD寄存器</span><span class="token keyword">struct</span> <span class="token class-name">s3c_lcd_regs</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> lcdcon1<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> lcdcon2<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> lcdcon3<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> lcdcon4<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> lcdcon5<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> lcdsaddr1<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> lcdsaddr2<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> lcdsaddr3<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> redlut<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> greenlut<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> bluelut<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> reserved<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 连续的4字节，这里不连续，空出来</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> dithmode<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> tpal<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> lcdintpnd<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> lcdsrcpnd<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> lcdintmsk<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> tconsel<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// s3c的LCD引脚设置</span><span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpbcon<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpbdat<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpccon<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpdcon<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpgcon<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">struct</span> <span class="token class-name">s3c_lcd_regs</span> <span class="token operator">*</span>lcd_regs<span class="token punctuation">;</span>u32pseudo_pal<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 假的调色板</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>s3c_lcd_fbinfo<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">fb_ops</span> s3c_lcdfb_ops <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>owner<span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span><span class="token punctuation">.</span>fb_setcolreg<span class="token operator">=</span> s3c_lcdfb_setcolreg<span class="token punctuation">,</span> <span class="token comment">// 设置假的调色板</span><span class="token punctuation">.</span>fb_fillrect<span class="token operator">=</span> cfb_fillrect<span class="token punctuation">,</span><span class="token punctuation">.</span>fb_copyarea<span class="token operator">=</span> cfb_copyarea<span class="token punctuation">,</span><span class="token punctuation">.</span>fb_imageblit<span class="token operator">=</span> cfb_imageblit<span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 颜色值转换</span><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">chan_to_field</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> chan<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">fb_bitfield</span> <span class="token operator">*</span>bf<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>chan <span class="token operator">&amp;=</span> <span class="token number">0xffff</span><span class="token punctuation">;</span>chan <span class="token operator">>>=</span> <span class="token number">16</span> <span class="token operator">-</span> bf<span class="token operator">-></span>length<span class="token punctuation">;</span><span class="token keyword">return</span> chan <span class="token operator">&lt;&lt;</span> bf<span class="token operator">-></span>offset<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 设置调色板</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">s3c_lcdfb_setcolreg</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> regno<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> red<span class="token punctuation">,</span>     <span class="token keyword">unsigned</span> <span class="token keyword">int</span> green<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> blue<span class="token punctuation">,</span>     <span class="token keyword">unsigned</span> <span class="token keyword">int</span> transp<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> val<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>regno <span class="token operator">></span> <span class="token number">16</span><span class="token punctuation">)</span>         <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment">// 用red green blue三原色构造val值</span>    val  <span class="token operator">=</span> <span class="token function">chan_to_field</span><span class="token punctuation">(</span>red<span class="token punctuation">,</span> <span class="token operator">&amp;</span>info<span class="token operator">-></span>var<span class="token punctuation">.</span>red<span class="token punctuation">)</span><span class="token punctuation">;</span>    val <span class="token operator">|=</span> <span class="token function">chan_to_field</span><span class="token punctuation">(</span>green<span class="token punctuation">,</span> <span class="token operator">&amp;</span>info<span class="token operator">-></span>var<span class="token punctuation">.</span>green<span class="token punctuation">)</span><span class="token punctuation">;</span>    val <span class="token operator">|=</span> <span class="token function">chan_to_field</span><span class="token punctuation">(</span>blue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>info<span class="token operator">-></span>var<span class="token punctuation">.</span>blue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 将计算的值付给对应号的调色板</span>    <span class="token comment">// ((u32 *)(info->pseudo_palette))[regno] = val;</span>    pseudo_pal<span class="token punctuation">[</span>regno<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span> <span class="token comment">// 本地的假调色板</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">lcd_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 1. 分配一个fb_info</span>    <span class="token comment">//   内核结构分配小技巧，可以多分配些空间，</span>    <span class="token comment">//   结构内部有指针指向这段空间，私有空间，</span>    <span class="token comment">// |====|=|。 这里不需要额外空间所以0</span>    s3c_lcd_fbinfo <span class="token operator">=</span> <span class="token function">framebuffer_alloc</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 设置 分配的结构体，</span>    <span class="token comment">// 2.1设置固定的参数 未设置的分配之后都是0</span>    <span class="token function">strcpy</span><span class="token punctuation">(</span>s3c_lcd_fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token string">"mylcd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// id name</span>    s3c_lcd_fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>smem_len    <span class="token operator">=</span> <span class="token number">240</span><span class="token operator">*</span><span class="token number">320</span><span class="token operator">*</span><span class="token number">16</span><span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">;</span><span class="token comment">// 显存的长度 16=5+6+5</span>    s3c_lcd_fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>type        <span class="token operator">=</span> FB_TYPE_PACKED_PIXELS<span class="token punctuation">;</span><span class="token comment">// see FB_TYPE_*</span>        <span class="token comment">// s3c_lcd_fbinfo->fix.type_aux = 平板会用到</span>    s3c_lcd_fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>visual      <span class="token operator">=</span> FB_VISUAL_TRUECOLOR<span class="token punctuation">;</span> <span class="token comment">// TFT屏幕是真彩 MONO单色</span>    s3c_lcd_fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>line_length <span class="token operator">=</span> <span class="token number">240</span><span class="token operator">*</span><span class="token number">16</span><span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">// 一个像素由16位表示就是2Bytes，length of a line in bytes</span>    <span class="token comment">// 2.2设置可变的参数</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>xres         <span class="token operator">=</span> <span class="token number">240</span><span class="token punctuation">;</span> <span class="token comment">// 实际分辨率</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>yres         <span class="token operator">=</span> <span class="token number">320</span><span class="token punctuation">;</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>xres_virtual <span class="token operator">=</span> <span class="token number">240</span><span class="token punctuation">;</span> <span class="token comment">// 可调整的分辨率</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>yres_virtual <span class="token operator">=</span> <span class="token number">320</span><span class="token punctuation">;</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>bits_per_pixel <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span><span class="token comment">// 2440不支持18位，丢弃2位</span>        <span class="token comment">// RGB 565 R:11 G:5 B:0</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>red<span class="token punctuation">.</span>offset   <span class="token operator">=</span>  <span class="token number">11</span><span class="token punctuation">;</span><span class="token comment">// red对应位的区域</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>red<span class="token punctuation">.</span>length   <span class="token operator">=</span>  <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">// red长度</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>green<span class="token punctuation">.</span>offset <span class="token operator">=</span>  <span class="token number">5</span><span class="token punctuation">;</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>green<span class="token punctuation">.</span>length <span class="token operator">=</span>  <span class="token number">6</span><span class="token punctuation">;</span>     s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>blue<span class="token punctuation">.</span>offset  <span class="token operator">=</span>  <span class="token number">0</span><span class="token punctuation">;</span>    s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>blue<span class="token punctuation">.</span>length  <span class="token operator">=</span>  <span class="token number">5</span><span class="token punctuation">;</span>     s3c_lcd_fbinfo<span class="token operator">-></span>var<span class="token punctuation">.</span>activate     <span class="token operator">=</span>  FB_ACTIVATE_NOW<span class="token punctuation">;</span>       <span class="token comment">// 2.3设置fb_ops. 参考drivers\video\atmel_lcdfb.c</span>    s3c_lcd_fbinfo<span class="token operator">-></span>fbops <span class="token operator">=</span> <span class="token operator">&amp;</span>s3c_lcdfb_ops<span class="token punctuation">;</span>    <span class="token comment">// 2.4其他设置</span>    s3c_lcd_fbinfo<span class="token operator">-></span>pseudo_palette  <span class="token operator">=</span> pseudo_pal<span class="token punctuation">;</span> <span class="token comment">// 假调色板16种颜色 Fake palette of 16 colors </span>    <span class="token comment">// s3c_lcd_fbinfo->screen_base     = ; // 显存的虚拟地址 如果没提供write就用到screen_base</span>    s3c_lcd_fbinfo<span class="token operator">-></span>screen_size     <span class="token operator">=</span> <span class="token number">240</span><span class="token operator">*</span><span class="token number">320</span><span class="token operator">*</span><span class="token number">16</span><span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">// Amount of ioremapped VRAM or 0</span>    <span class="token comment">// 3. 硬件相关操作 </span>    <span class="token comment">// 3.1配置GPIO用于LCD</span>    gpbcon <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span><span class="token number">0x56000010</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 一页一页的映射 1024字节</span>    gpbdat <span class="token operator">=</span> gpbcon <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    gpccon <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span><span class="token number">0x56000020</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 4和8一样 一页一页的映射 1024字节</span>    gpdcon <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span><span class="token number">0x56000030</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    gpgcon <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span><span class="token number">0x56000060</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">*</span>gpccon <span class="token operator">=</span> <span class="token number">0xaaaaaaaa</span><span class="token punctuation">;</span> <span class="token comment">// GPIO管脚用于VD[7:0] LCDVF[2:0] VM VFRAME VLINE LEND</span>    <span class="token operator">*</span>gpdcon <span class="token operator">=</span> <span class="token number">0xaaaaaaaa</span><span class="token punctuation">;</span> <span class="token comment">// GPIO管脚用于VD[23:8]</span>    <span class="token operator">*</span>gpbcon <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 设置GPB0为输出引脚 背光</span>    <span class="token operator">*</span>gpbcon <span class="token operator">|=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token operator">*</span>gpbdat <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token comment">// 输出低电平</span>    <span class="token operator">*</span>gpgcon <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// GPG4用作LCD_PWREN LCD电源使能引脚</span>    <span class="token comment">// 3.2根据LCD手册设置LCD控制器，VCLK的频率等</span>    lcd_regs <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span><span class="token number">0x4d000000</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>lcd_regs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 寄存器组映射</span>        <span class="token comment">// bit[17:8]: TFT: VCLK = HCLK / [(CLKVAL+1) x 2] (CLKVAL‡ 0)</span>        <span class="token comment">//                  VCLK(扫描时钟)&lt;=10MHz  HCLK(内核时钟频率) 100MHz</span>        <span class="token comment">//                  10MHz(100ns)=100MHz/[(CLKVAL+1)x2]-->CLKVAL=4</span>        <span class="token comment">// bit[6:5] : 11 = TFT LCD panel</span>        <span class="token comment">// bit[4:1] : 1100 = 16 bpp for TFT. BPP (Bits Per Pixel) mode.</span>        <span class="token comment">// bit[0]   : 0 = Disable the video output and the LCD control signal.</span>    lcd_regs<span class="token operator">-></span>lcdcon1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">0x0C</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 垂直方向的时间参数</span>        <span class="token comment">// bit[31:24]: VBPD VSYNC过多长时间后才能发出第一行数据</span>        <span class="token comment">//                  LCD手册上T0-T2-T1=4 所以VBPD = 3</span>        <span class="token comment">// bit[23:14]: LINEVAL 多少行，320 所以LINEVAL = 319</span>        <span class="token comment">// bit[13:6] : VFPD 发出最后一行数据后过多久才发出VSYNC信号</span>        <span class="token comment">//                  LCD手册T2-T5=322-320=2， 所以=1</span>        <span class="token comment">// bit[5:0]  : VSYNC VSYNC信号脉冲宽度，LCD手册T1=1 所以=0</span>    lcd_regs<span class="token operator">-></span>lcdcon2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">&lt;&lt;</span><span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">319</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 水平方向的时间参数</span>        <span class="token comment">// bit[25:19]: HBPD HSYNC过多长时间后才能发出第一个像素数据</span>        <span class="token comment">//                  LCD手册 T6-T7-T8=17 所以16</span>        <span class="token comment">// bit[18:8] : HOZVAL 多少列 240 所以239</span>        <span class="token comment">// bit[7:0]  : HFPD 发出最后一行最后一个像素后过多久才发出HSYNC信号</span>        <span class="token comment">//                  LCD手册 T8-T11=11 所以10</span>    lcd_regs<span class="token operator">-></span>lcdcon3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">16</span><span class="token operator">&lt;&lt;</span><span class="token number">19</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">239</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// bit[7:0]  : HSPW HSYNC的脉冲宽度 LCD手册T7=5 所以4 </span>    lcd_regs<span class="token operator">-></span>lcdcon4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 信号的极性</span>        <span class="token comment">// bit[11]: 1=565 Format</span>        <span class="token comment">// bit[10]: 0 = The video data is fetched at VCLK falling edge</span>        <span class="token comment">// bit[9] : 1 反转HSYNC 低电平有效</span>        <span class="token comment">// bit[8] : 1 反转VSYNC 低电平有效</span>        <span class="token comment">// bit[6] : 0 VDEN不用反转</span>        <span class="token comment">// bit[3] : 0 PWREN输出0</span>        <span class="token comment">// bit[1] : 0 BSWP</span>        <span class="token comment">// bit[0] : 1 HWSWP 2440手册P413</span>    lcd_regs<span class="token operator">-></span>lcdcon5 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3.3分配显存(framebuffer),把地址告诉LCD控制器</span>    <span class="token comment">//      从内存中划出，这里没有实际显存,需要连续内存</span>    <span class="token comment">//      返回虚拟地址</span>    s3c_lcd_fbinfo<span class="token operator">-></span>screen_base <span class="token operator">=</span> <span class="token function">dma_alloc_writecombine</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> \                    s3c_lcd_fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>smem_len<span class="token punctuation">,</span> \                    s3c_lcd_fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>smem_start<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 告诉lcd控制器 显存的起始地址</span>    lcd_regs<span class="token operator">-></span>lcdsaddr1 <span class="token operator">=</span> <span class="token punctuation">(</span>s3c_lcd_fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>smem_start<span class="token operator">>></span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">&lt;&lt;</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0~29bit 30 31清0</span>        <span class="token comment">// 告诉lcd控制器显存的结束地址</span>    lcd_regs<span class="token operator">-></span>lcdsaddr2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s3c_lcd_fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>smem_start<span class="token operator">+</span>s3c_lcd_fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>smem_len<span class="token punctuation">)</span><span class="token operator">>></span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> \                        <span class="token number">0x1fffff</span><span class="token punctuation">;</span> <span class="token comment">// 0~20bit</span>        <span class="token comment">// 一行显示的长度（单位：半字）</span>    lcd_regs<span class="token operator">-></span>lcdsaddr3 <span class="token operator">=</span> <span class="token number">240</span><span class="token operator">*</span><span class="token number">16</span><span class="token operator">/</span><span class="token number">16</span><span class="token punctuation">;</span>    <span class="token comment">// s3c_lcd_fbinfo->fix.smem_start = ; // 显存的物理地址</span>    <span class="token comment">// 启动LCD </span>    lcd_regs<span class="token operator">-></span>lcdcon1 <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使能LCD控制器</span>    lcd_regs<span class="token operator">-></span>lcdcon5 <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使能LCD</span>    <span class="token operator">*</span>gpbdat <span class="token operator">|=</span> <span class="token number">1</span><span class="token punctuation">;</span>                <span class="token comment">// 打开背光</span>            <span class="token comment">// 4. 注册</span>    <span class="token function">register_framebuffer</span><span class="token punctuation">(</span>s3c_lcd_fbinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">lcd_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">unregister_framebuffer</span><span class="token punctuation">(</span>s3c_lcd_fbinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">dma_free_writecombine</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> \        s3c_lcd_fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>smem_len<span class="token punctuation">,</span>\        s3c_lcd_fbinfo<span class="token operator">-></span>screen_base<span class="token punctuation">,</span> \        s3c_lcd_fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>smem_start<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">iounmap</span><span class="token punctuation">(</span>lcd_regs<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">iounmap</span><span class="token punctuation">(</span>gpgcon<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">iounmap</span><span class="token punctuation">(</span>gpdcon<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">iounmap</span><span class="token punctuation">(</span>gpccon<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">framebuffer_release</span><span class="token punctuation">(</span>s3c_lcd_fbinfo<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>lcd_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>lcd_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><h2 id="1-make-menuconfig-在内核镜像中手动去掉原来的LCD驱动程序"><a href="#1-make-menuconfig-在内核镜像中手动去掉原来的LCD驱动程序" class="headerlink" title="1. make menuconfig 在内核镜像中手动去掉原来的LCD驱动程序"></a>1. make menuconfig 在内核镜像中手动去掉原来的LCD驱动程序</h2><p><img src="/images/20200417221358768.png"><br>设备驱动程序—图形支持—s3c2410 LCD改成<code>M</code>，因为还有三个文件没有写暂时先用这里的先编译成模块，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">这三个函数没有写<span class="token punctuation">.</span>fb_fillrect<span class="token operator">=</span> cfb_fillrect<span class="token punctuation">,</span><span class="token punctuation">.</span>fb_copyarea<span class="token operator">=</span> cfb_copyarea<span class="token punctuation">,</span><span class="token punctuation">.</span>fb_imageblit<span class="token operator">=</span> cfb_imageblit<span class="token punctuation">,</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/images/20200417221743484.png"><br><img src="/images/20200417221956223.png"></p><h2 id="2-make-uImage-，-make-modules"><a href="#2-make-uImage-，-make-modules" class="headerlink" title="2. make uImage ， make modules"></a>2. make uImage ， make modules</h2><p><img src="/images/20200417222147453.png"><br><img src="/images/20200417222300170.png"></p><h2 id="3-使用新的uImage启动"><a href="#3-使用新的uImage启动" class="headerlink" title="3. 使用新的uImage启动"></a>3. 使用新的uImage启动</h2><h2 id="4-编译我们写的驱动代码-make"><a href="#4-编译我们写的驱动代码-make" class="headerlink" title="4. 编译我们写的驱动代码 make"></a>4. 编译我们写的驱动代码 make</h2><p><img src="/images/20200417222420260.png"></p><h2 id="5-插入那三个模块，然后插入lcd驱动模块"><a href="#5-插入那三个模块，然后插入lcd驱动模块" class="headerlink" title="5. 插入那三个模块，然后插入lcd驱动模块"></a>5. 插入那三个模块，然后插入lcd驱动模块</h2><p>拷贝三个.ko到网络文件系统，<code>cp drivers/video/cfb*.ko nfsxxx</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">insmod cfb_copyarea.koinsmod cfb_fillrect.koinsmod cfb_imageblit.koinsmod lcd.ko<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>装载完毕可以看到设备，<code>ls /dev/fb0</code>，屏幕背光亮起来了。<br><code>echo hello &gt; /dev/tty1</code> 可以看到屏幕显示hello，<br><code>cat lcd.ko &gt; /dev/fb0</code> 可以看到花屏。</p><h2 id="6-将前面的输入子系统按键驱动模块加进来，和LCD一起测试"><a href="#6-将前面的输入子系统按键驱动模块加进来，和LCD一起测试" class="headerlink" title="6. 将前面的输入子系统按键驱动模块加进来，和LCD一起测试"></a>6. 将前面的输入子系统按键驱动模块加进来，和LCD一起测试</h2><ol><li>修改<code>/etc/inittab</code>，之前是启动一个shell程序，把输入输出到串口0，<br>现在加一行，启动另一个shell程序，tty1输入对应键盘输出对应lcd。<br><img src="/images/20200417224634505.png"></li><li>重启</li><li>插入那三个缺失的模块，和lcd模块</li><li>插入<code>buttons</code>模块</li><li>按键 <code>l s enter</code>，可以看到lcd上显示</li><li>查看刚新启动的shell进程对应的设备<code>ls l /proc/768/fd</code>，标准输入输出都对应到了tty1，tty1对应<code>buttons.ko</code><br><img src="/images/20200417230304275.png"></li></ol><p><strong>tty1用到的驱动程序是<code>drivers\video\console\fbcon.c</code>，一定会用到那个数组然后获得<code>struct fb_info</code>进而获得显存，然后操作显存即可在lcd中显示，</strong></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">fbcon_rotate</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info<span class="token punctuation">,</span> u32 rotate<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">fbcon_ops</span> <span class="token operator">*</span>ops<span class="token operator">=</span> info<span class="token operator">-></span>fbcon_par<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>fb_info<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ops <span class="token operator">||</span> ops<span class="token operator">-></span>currcon <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">;</span>fb_info <span class="token operator">=</span> registered_fb<span class="token punctuation">[</span>con2fb_map<span class="token punctuation">[</span>ops<span class="token operator">-></span>currcon<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="内核自带的lcd驱动程序"><a href="#内核自带的lcd驱动程序" class="headerlink" title="内核自带的lcd驱动程序"></a>内核自带的lcd驱动程序</h1><p>内核自带的lcd驱动程序分为两部分，稳定的代码在<code>drivers\video\s3c2410fb.c</code>，硬件相关的代码在<code>arch\arm\plat-s3c24xx\devs.c，</code></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> s3c_device_lcd <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 平台设备</span><span class="token punctuation">.</span>name  <span class="token operator">=</span> <span class="token string">"s3c2410-lcd"</span><span class="token punctuation">,</span><span class="token punctuation">.</span>id  <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">.</span>num_resources  <span class="token operator">=</span> <span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>s3c_lcd_resource<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">.</span>resource  <span class="token operator">=</span> s3c_lcd_resource<span class="token punctuation">,</span><span class="token punctuation">.</span>dev              <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>dma_mask<span class="token operator">=</span> <span class="token operator">&amp;</span>s3c_device_lcd_dmamask<span class="token punctuation">,</span><span class="token punctuation">.</span>coherent_dma_mask<span class="token operator">=</span> <span class="token number">0xffffffffUL</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">void</span> __init <span class="token function">s3c24xx_fb_set_platdata</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">s3c2410fb_mach_info</span> <span class="token operator">*</span>pd<span class="token punctuation">)</span> <span class="token comment">// 设置私有数据</span><span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">s3c2410fb_mach_info</span> <span class="token operator">*</span>npd<span class="token punctuation">;</span>npd <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>npd<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>npd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">memcpy</span><span class="token punctuation">(</span>npd<span class="token punctuation">,</span> pd<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>npd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>s3c_device_lcd<span class="token punctuation">.</span>dev<span class="token punctuation">.</span>platform_data <span class="token operator">=</span> npd<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>针对每种平台都有对应的硬件设置，<img src="/images/20200417231542438.png"><br>如果使用内核提供的驱动代码，在这个结构体中这里修改寄存器就可以了，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">arch\arm\mach<span class="token operator">-</span>s3c2410\mach<span class="token operator">-</span>qt2410<span class="token punctuation">.</span>c<span class="token comment">/* Configuration for 640x480 SHARP LQ080V3DG01 */</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">s3c2410fb_mach_info</span> qt2410_biglcd_cfg __initdata <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>regs<span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>lcdcon1<span class="token operator">=</span> S3C2410_LCDCON1_TFT16BPP <span class="token operator">|</span>  S3C2410_LCDCON1_TFT <span class="token operator">|</span>  <span class="token function">S3C2410_LCDCON1_CLKVAL</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">/* HCLK/4 */</span><span class="token punctuation">.</span>lcdcon2<span class="token operator">=</span> <span class="token function">S3C2410_LCDCON2_VBPD</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span> <span class="token operator">|</span><span class="token comment">/* 19 */</span>  <span class="token function">S3C2410_LCDCON2_LINEVAL</span><span class="token punctuation">(</span><span class="token number">479</span><span class="token punctuation">)</span> <span class="token operator">|</span>  <span class="token function">S3C2410_LCDCON2_VFPD</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">|</span><span class="token comment">/* 11 */</span>  <span class="token function">S3C2410_LCDCON2_VSPW</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">/* 15 */</span><span class="token punctuation">.</span>lcdcon3<span class="token operator">=</span> <span class="token function">S3C2410_LCDCON3_HBPD</span><span class="token punctuation">(</span><span class="token number">43</span><span class="token punctuation">)</span> <span class="token operator">|</span><span class="token comment">/* 44 */</span>  <span class="token function">S3C2410_LCDCON3_HOZVAL</span><span class="token punctuation">(</span><span class="token number">639</span><span class="token punctuation">)</span> <span class="token operator">|</span><span class="token comment">/* 640 */</span>  <span class="token function">S3C2410_LCDCON3_HFPD</span><span class="token punctuation">(</span><span class="token number">115</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第15课 1 内核LCD驱动层次分析 fbmem.c -- register_framebuffer -- 硬件 抽象出来的fbmem.c依赖底层硬件相关的数组registered_fb</title>
      <link href="2021/05/14/wds2-qi-di-15-ke-1-nei-he-lcd-qu-dong-ceng-ci-fen-xi-fbmem.c-register-framebuffer-ying-jian-chou-xiang-chu-lai-de-fbmem.c-di-ceng-shu-zu-registered-fb-local/"/>
      <url>2021/05/14/wds2-qi-di-15-ke-1-nei-he-lcd-qu-dong-ceng-ci-fen-xi-fbmem.c-register-framebuffer-ying-jian-chou-xiang-chu-lai-de-fbmem.c-di-ceng-shu-zu-registered-fb-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]<br><img src="/images/20200416092502602.png"></p><h1 id="分析内核自带LCD驱动程序drivers-video-fbmem-c"><a href="#分析内核自带LCD驱动程序drivers-video-fbmem-c" class="headerlink" title="分析内核自带LCD驱动程序drivers\video\fbmem.c"></a>分析内核自带LCD驱动程序drivers\video\fbmem.c</h1><p>内核自带的LCD驱动程序，在<code>drivers\video\fbmem.c</code>中，<code>fbmem.c</code>提供的都是抽象的，具体的实现依赖里边的数组<code>registered_fb[iminor(inode)]</code>，fb帧缓冲区（Frame Buffer），可以看到以下步骤：<br><img src="/images/20200416105944687.png"></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">majorfopsregister_chrdevclass_create没有 class_device_create<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> fb_fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>owner <span class="token operator">=</span>THIS_MODULE<span class="token punctuation">,</span><span class="token punctuation">.</span>read <span class="token operator">=</span>fb_read<span class="token punctuation">,</span><span class="token punctuation">.</span>write <span class="token operator">=</span>fb_write<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">static</span> <span class="token keyword">int</span> __init<span class="token function">fbmem_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">create_proc_read_entry</span><span class="token punctuation">(</span><span class="token string">"fb"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> fbmem_read_proc<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// major register_chrdev fops</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">register_chrdev</span><span class="token punctuation">(</span>FB_MAJOR<span class="token punctuation">,</span><span class="token string">"fb"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>fb_fops<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"unable to get major %d for fb devs\n"</span><span class="token punctuation">,</span> FB_MAJOR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// class_create</span>fb_class <span class="token operator">=</span> <span class="token function">class_create</span><span class="token punctuation">(</span>THIS_MODULE<span class="token punctuation">,</span> <span class="token string">"graphics"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>fb_class<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"Unable to create fb class; errno = %ld\n"</span><span class="token punctuation">,</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>fb_class<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>fb_class <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查看open函数，和read函数，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span><span class="token function">fb_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">int</span> fbidx <span class="token operator">=</span> <span class="token function">iminor</span><span class="token punctuation">(</span>inode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取次设备号</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>info <span class="token operator">=</span> registered_fb<span class="token punctuation">[</span>fbidx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 以此设备号为数组下标赋值给fb_info</span>res <span class="token operator">=</span> info<span class="token operator">-></span>fbops<span class="token operator">-></span><span class="token function">fb_open</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用open</span><span class="token keyword">return</span> res<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token class-name">ssize_t</span><span class="token function">fb_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>ppos<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">int</span> fbidx <span class="token operator">=</span> <span class="token function">iminor</span><span class="token punctuation">(</span>inode<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 获取次设备号</span><span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info <span class="token operator">=</span> registered_fb<span class="token punctuation">[</span>fbidx<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 以次设备号为数组下标赋值给struct fb_info</span><span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token operator">-></span>fbops<span class="token operator">-></span>fb_read<span class="token punctuation">)</span> <span class="token comment">// 有read就read</span><span class="token keyword">return</span> info<span class="token operator">-></span>fbops<span class="token operator">-></span><span class="token function">fb_read</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> count<span class="token punctuation">,</span> ppos<span class="token punctuation">)</span><span class="token punctuation">;</span>src <span class="token operator">=</span> <span class="token punctuation">(</span>u32 __iomem <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>info<span class="token operator">-></span>screen_base <span class="token operator">+</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 无read读取显存的缓存</span><span class="token operator">*</span>dst<span class="token operator">++</span> <span class="token operator">=</span> <span class="token function">fb_readl</span><span class="token punctuation">(</span>src<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 将读取的内容拷贝到用户空间</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="为fbmem-c提供硬件设备的数组registered-fb，register-framebuffer为fbmem-c和硬之间桥梁"><a href="#为fbmem-c提供硬件设备的数组registered-fb，register-framebuffer为fbmem-c和硬之间桥梁" class="headerlink" title="为fbmem.c提供硬件设备的数组registered_fb，register_framebuffer为fbmem.c和硬之间桥梁"></a>为fbmem.c提供硬件设备的数组registered_fb，register_framebuffer为fbmem.c和硬之间桥梁</h2><p>fbmem.c提供的都是抽象的，具体的实现依赖里边的数组<code>registered_fb[iminor(inode)]</code>，也在里边定义，修改也是，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>registered_fb<span class="token punctuation">[</span>FB_MAX<span class="token punctuation">]</span> __read_mostly<span class="token punctuation">;</span> <span class="token comment">// 定义</span><span class="token comment">// fbmem.c依赖register_framebuffer，register_framebuffer会把底层设备向上注册</span><span class="token keyword">int</span><span class="token function">register_framebuffer</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>fb_info<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">// device_create对应于前面fb_class = class_create(THIS_MODULE, "graphics");</span><span class="token comment">// 创建设备节点</span>fb_info<span class="token operator">-></span>dev <span class="token operator">=</span> <span class="token function">device_create</span><span class="token punctuation">(</span>fb_class<span class="token punctuation">,</span> fb_info<span class="token operator">-></span>device<span class="token punctuation">,</span>     <span class="token function">MKDEV</span><span class="token punctuation">(</span>FB_MAJOR<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"fb%d"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">fb_add_videomode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mode<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fb_info<span class="token operator">-></span>modelist<span class="token punctuation">)</span><span class="token punctuation">;</span>registered_fb<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> fb_info<span class="token punctuation">;</span><span class="token comment">// 修改</span>event<span class="token punctuation">.</span>info <span class="token operator">=</span> fb_info<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="硬件相关以drivers-video-s3c2410fb-c为例"><a href="#硬件相关以drivers-video-s3c2410fb-c为例" class="headerlink" title="硬件相关以drivers\video\s3c2410fb.c为例"></a>硬件相关以drivers\video\s3c2410fb.c为例</h2><p>有很多驱动程序都会调用register_framebuffer函数，如我们的<code>drivers\video\s3c2410fb.c</code>，进去简单看看，<br><img src="/images/20200416104226451.png"></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 入口函数  </span><span class="token keyword">int</span> __devinit <span class="token function">s3c2410fb_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">platform_driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s3c2410fb_driver<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// platform_driver_register --> add</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">platform_driver</span> s3c2410fb_driver <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>probe<span class="token operator">=</span> s3c2410fb_probe<span class="token punctuation">,</span><span class="token punctuation">.</span>remove<span class="token operator">=</span> s3c2410fb_remove<span class="token punctuation">,</span><span class="token punctuation">.</span>suspend<span class="token operator">=</span> s3c2410fb_suspend<span class="token punctuation">,</span><span class="token punctuation">.</span>resume<span class="token operator">=</span> s3c2410fb_resume<span class="token punctuation">,</span><span class="token punctuation">.</span>driver<span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>name<span class="token operator">=</span> <span class="token string">"s3c2410-lcd"</span><span class="token punctuation">,</span> <span class="token comment">// 会根据name寻找同名dev</span><span class="token punctuation">.</span>owner<span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 首先根据platform_device获取硬件信息，然后分配struct fb_info，设置，注册framebuffer</span><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">s3c2410fb_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">// 获取硬件信息，</span>mach_info <span class="token operator">=</span> pdev<span class="token operator">-></span>dev<span class="token punctuation">.</span>platform_data<span class="token punctuation">;</span><span class="token comment">// 然后分配struct fb_info</span>fbinfo <span class="token operator">=</span> <span class="token function">framebuffer_alloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">s3c2410fb_info</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pdev<span class="token operator">-></span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 设置</span>fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>type    <span class="token operator">=</span> FB_TYPE_PACKED_PIXELS<span class="token punctuation">;</span>fbinfo<span class="token operator">-></span>fix<span class="token punctuation">.</span>type_aux    <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 注册framebuffer</span>ret <span class="token operator">=</span> <span class="token function">register_framebuffer</span><span class="token punctuation">(</span>fbinfo<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="fbmem-c找到硬件信息的例子，如获取分辨率"><a href="#fbmem-c找到硬件信息的例子，如获取分辨率" class="headerlink" title="fbmem.c找到硬件信息的例子，如获取分辨率"></a>fbmem.c找到硬件信息的例子，如获取分辨率</h2><p>如果在用户空间想获得屏幕的分辨率，通过fops中的<code>fb_ioctl</code>可以获得可变的屏幕信息<code>FBIOGET_VSCREENINFO</code> V(var)</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">drivers\video\fbmem<span class="token punctuation">.</span>c<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">fb_ioctl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">int</span> fbidx <span class="token operator">=</span> <span class="token function">iminor</span><span class="token punctuation">(</span>inode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取次设备号</span><span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token operator">*</span>info <span class="token operator">=</span> registered_fb<span class="token punctuation">[</span>fbidx<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 以次设备号为下标获取struct  fb_info  registered_fb数组很重要</span><span class="token keyword">struct</span> <span class="token class-name">fb_ops</span> <span class="token operator">*</span>fb <span class="token operator">=</span> info<span class="token operator">-></span>fbops<span class="token punctuation">;</span> <span class="token keyword">case</span> FBIOGET_VSCREENINFO<span class="token operator">:</span><span class="token keyword">return</span> <span class="token function">copy_to_user</span><span class="token punctuation">(</span>argp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>info<span class="token operator">-></span>var<span class="token punctuation">,</span><span class="token comment">// 通过struct fb_info找到var把结果拷贝到用户空间</span>    <span class="token keyword">sizeof</span><span class="token punctuation">(</span>var<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token operator">-</span>EFAULT <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>include\linux\fb<span class="token punctuation">.</span>h<span class="token keyword">struct</span> <span class="token class-name">fb_info</span> <span class="token punctuation">&#123;</span><span class="token keyword">int</span> node<span class="token punctuation">;</span><span class="token keyword">int</span> flags<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">fb_var_screeninfo</span> var<span class="token punctuation">;</span><span class="token comment">/* Current var */</span> <span class="token comment">// struct fb_info包含var结构</span><span class="token keyword">struct</span> <span class="token class-name">fb_fix_screeninfo</span> fix<span class="token punctuation">;</span><span class="token comment">/* Current fix */</span>include\linux\fb<span class="token punctuation">.</span>h<span class="token keyword">struct</span> <span class="token class-name">fb_var_screeninfo</span> <span class="token punctuation">&#123;</span>__u32 xres<span class="token punctuation">;</span><span class="token comment">/* visible resolution*/</span> <span class="token comment">// x y 方向的分辨率</span>__u32 yres<span class="token punctuation">;</span>__u32 xres_virtual<span class="token punctuation">;</span><span class="token comment">/* virtual resolution*/</span>__u32 yres_virtual<span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="小结fbmem-c-lt-—-register-framebuffer-—-gt-硬件"><a href="#小结fbmem-c-lt-—-register-framebuffer-—-gt-硬件" class="headerlink" title="*** 小结fbmem.c &lt;—- register_framebuffer —-&gt; 硬件"></a>*** 小结fbmem.c &lt;—- register_framebuffer —-&gt; 硬件</h2><p><code>fbmem.c</code>提供抽象的代码，主要依赖数组<code>registered_fb[iminor(inode)]</code>的项获取硬件相关代码，而这个数组由<code>register_framebuffer</code>函数设置，<code>register_framebuffer</code>函数还完成自动创建设备节点的任务<code>device_create</code>，完成向上注册设备，而硬件部分就跟<code>fbmem.c</code>分离，由各自的芯片什么去完成如<code>drivers\video\s3c2410fb.c</code>然后调用<code>register_framebuffer</code>完成向上注册设备，<br><img src="/images/20200416110046693.png"></p><h1 id="最终总结写LCD驱动应该以下步骤："><a href="#最终总结写LCD驱动应该以下步骤：" class="headerlink" title="最终总结写LCD驱动应该以下步骤："></a>最终总结写LCD驱动应该以下步骤：</h1><h2 id="1-分配struct-fb-info-用framebuffer-alloc-sizeof-struct-xxxfb-info-amp-pdev-gt-dev"><a href="#1-分配struct-fb-info-用framebuffer-alloc-sizeof-struct-xxxfb-info-amp-pdev-gt-dev" class="headerlink" title="1. 分配struct fb_info 用framebuffer_alloc(sizeof(struct xxxfb_info), &amp;pdev-&gt;dev);"></a>1. 分配<code>struct fb_info</code> 用<code>framebuffer_alloc(sizeof(struct xxxfb_info), &amp;pdev-&gt;dev);</code></h2><h2 id="2-设置"><a href="#2-设置" class="headerlink" title="2. 设置"></a>2. 设置</h2><h2 id="3-注册register-framebuffer"><a href="#3-注册register-framebuffer" class="headerlink" title="3. 注册register_framebuffer"></a>3. 注册<code>register_framebuffer</code></h2><h2 id="4-硬件相关操作"><a href="#4-硬件相关操作" class="headerlink" title="4. 硬件相关操作"></a>4. 硬件相关操作</h2>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第14课 驱动程序分层分离概念 总线驱动设备模型 dev(struct resource)和drv(get_resource) 关心probe是核心</title>
      <link href="2021/05/14/wds2-qi-di-14-ke-qu-dong-cheng-xu-fen-ceng-fen-chi-gai-nian-zong-xian-qu-dong-she-bei-mo-xing-dev-struct-resource-he-drv-get-resource-guan-xin-probe-shi-he-xin-local/"/>
      <url>2021/05/14/wds2-qi-di-14-ke-qu-dong-cheng-xu-fen-ceng-fen-chi-gai-nian-zong-xian-qu-dong-she-bei-mo-xing-dev-struct-resource-he-drv-get-resource-guan-xin-probe-shi-he-xin-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]</p><h1 id="驱动程序分层分离概念"><a href="#驱动程序分层分离概念" class="headerlink" title="驱动程序分层分离概念"></a>驱动程序分层分离概念</h1><p>3分离分层，将硬件相关代码和纯软件代码分离，然后修改各自的代码都向上层注册，分层。<br><img src="/images/20200415143500787.png"></p><h1 id="总线驱动设备模型-match"><a href="#总线驱动设备模型-match" class="headerlink" title="总线驱动设备模型 match"></a>总线驱动设备模型 match</h1><p><img src="/images/2020041520285214.png"><br>总线驱动设备模型，bus driver device都是虚拟的概念，是一种结构体而已。<br>device硬件相关，driver比较稳定的代码。<br>platform_driver_register，platform(struct bus_type)是一条虚拟的总线，向上注册将driver结构体放到bus的链表里面，platform_add_devices将device放到bus的链表里。</p><p>add_devices完成以下步骤，左边device：</p><ol><li>将device放入bus的dev链表；</li><li>从bus的dev链表取出每个drv，用bus的match函数判断drv能否支持dev，能支持则调用probe函数。</li></ol><p>driver_register完成以下步骤，右边driver：</p><ol><li>将driver放入bus的drv链表；</li><li>从bus的dev链表取出每个dev，match比较，能支持调用probe函数。</li></ol><p>左右建立联系的一种机制，这种结构机制内部实现什么做什么完全自己决定，不要被bus、device、driver名字所迷惑。</p><h2 id="简单分析platform例子，"><a href="#简单分析platform例子，" class="headerlink" title="简单分析platform例子，"></a>简单分析platform例子，</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c">drivers\base\platform<span class="token punctuation">.</span>c <span class="token operator">--</span> platform_driver_register<span class="token keyword">int</span> <span class="token function">platform_driver_register</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_driver</span> <span class="token operator">*</span>drv<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>drv<span class="token operator">-></span>driver<span class="token punctuation">.</span>bus <span class="token operator">=</span> <span class="token operator">&amp;</span>platform_bus_type<span class="token punctuation">;</span> <span class="token comment">// bus赋值，platform_bus_type</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">return</span> <span class="token function">driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>drv<span class="token operator">-></span>driver<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>drivers\base\platform<span class="token punctuation">.</span>c <span class="token operator">--</span> platform_bus_type <span class="token keyword">struct</span> <span class="token class-name">bus_type</span> platform_bus_type <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>name<span class="token operator">=</span> <span class="token string">"platform"</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dev_attrs<span class="token operator">=</span> platform_dev_attrs<span class="token punctuation">,</span><span class="token punctuation">.</span>match<span class="token operator">=</span> platform_match<span class="token punctuation">,</span> <span class="token comment">// match函数</span><span class="token punctuation">.</span>uevent<span class="token operator">=</span> platform_uevent<span class="token punctuation">,</span><span class="token punctuation">.</span>suspend<span class="token operator">=</span> platform_suspend<span class="token punctuation">,</span><span class="token punctuation">.</span>suspend_late<span class="token operator">=</span> platform_suspend_late<span class="token punctuation">,</span><span class="token punctuation">.</span>resume_early<span class="token operator">=</span> platform_resume_early<span class="token punctuation">,</span><span class="token punctuation">.</span>resume<span class="token operator">=</span> platform_resume<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>drivers\base\platform<span class="token punctuation">.</span>c <span class="token operator">--</span> platform_match<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">platform_match</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span> dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device_driver</span> <span class="token operator">*</span> drv<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">platform_device</span><span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 名字相同就认为匹配，</span><span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>pdev<span class="token operator">-></span>name<span class="token punctuation">,</span> drv<span class="token operator">-></span>name<span class="token punctuation">,</span> BUS_ID_SIZE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>drivers\input\keyboard\gpio_keys<span class="token punctuation">.</span>c<span class="token keyword">struct</span> <span class="token class-name">platform_driver</span> gpio_keys_device_driver <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>probe<span class="token operator">=</span> gpio_keys_probe<span class="token punctuation">,</span> <span class="token comment">// 名字相同就会调用probe函数</span><span class="token punctuation">.</span>remove<span class="token operator">=</span> <span class="token function">__devexit_p</span><span class="token punctuation">(</span>gpio_keys_remove<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">.</span>driver<span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>name<span class="token operator">=</span> <span class="token string">"gpio-keys"</span><span class="token punctuation">,</span> <span class="token comment">// 理论上会找到同名"gpio-keys" ，但这是示例代码所以没有</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="代码1，bus-drv-dev框架简单应用"><a href="#代码1，bus-drv-dev框架简单应用" class="headerlink" title="代码1，bus_drv_dev框架简单应用"></a>代码1，bus_drv_dev框架简单应用</h1><p>于是写个led试试，drv和dev分开写，参考了<code>drivers\mmc\host\s3cmci.c</code>和<code>arch\arm\mach-s3c2440\mach-smdk2440.c</code>搜索<code>&quot;s3c2440-sdi&quot;</code>可以得到，<br>先在<code>probe</code>和<code>remove</code>中不写什么，就搞个<code>print</code>，</p><h2 id="led-dev-c"><a href="#led-dev-c" class="headerlink" title="led_dev.c"></a>led_dev.c</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/version.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/interrupt.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/list.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/timer.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/serial_core.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h></span></span><span class="token comment">// 分配  设置  注册一个platform_device</span><span class="token comment">// 资源描述，寄存器，地址</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">resource</span> led_resource<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">.</span>start <span class="token operator">=</span> <span class="token number">0x56000050</span><span class="token punctuation">,</span>        <span class="token comment">// 起始地址</span>        <span class="token punctuation">.</span>end   <span class="token operator">=</span> <span class="token number">0x56000050</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token comment">// 结束地址</span>        <span class="token punctuation">.</span>flags <span class="token operator">=</span> IORESOURCE_MEM<span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">.</span>start <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span>end   <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span>flags <span class="token operator">=</span> IORESOURCE_IRQ<span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 先不写，硬件相关代码</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">led_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">platform_device</span> led_dev <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span>name           <span class="token operator">=</span> <span class="token string">"my_led"</span><span class="token punctuation">,</span>    <span class="token punctuation">.</span>id             <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>    <span class="token punctuation">.</span>num_resources  <span class="token operator">=</span> <span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>led_resource<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">.</span>resource       <span class="token operator">=</span> led_resource<span class="token punctuation">,</span>    <span class="token punctuation">.</span>dev<span class="token punctuation">.</span>release    <span class="token operator">=</span> led_release<span class="token punctuation">,</span> <span class="token comment">// platform_device内有dev内有release。 硬件相关代码</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">led_dev_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">platform_device_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led_dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 最终放到platform的dev链表中 device_add</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">led_dev_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">platform_device_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led_dev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>led_dev_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>led_dev_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="led-drv-c"><a href="#led-drv-c" class="headerlink" title="led_drv.c"></a>led_drv.c</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/version.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/dma-mapping.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/clk.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mmc/mmc.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mmc/host.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/irq.h></span></span><span class="token comment">// 分配  设置  注册一个platform_driver</span><span class="token comment">// platform_device_register注册后device_add加入到dev，</span><span class="token comment">//  找能否支持看name相同否，找到则调用probe （dev中与drv中）</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">led_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"led_probe found led.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// platform_device_unregister卸载时，从dev中去掉，调用remove  （dev中与drv中）</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">led_remove</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"led_remove remove led.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">platform_driver</span> led_drv <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>driver<span class="token punctuation">.</span>name<span class="token operator">=</span> <span class="token string">"my_led"</span><span class="token punctuation">,</span> <span class="token comment">// name dev和drv要一样</span><span class="token punctuation">.</span>probe<span class="token operator">=</span> led_probe<span class="token punctuation">,</span><span class="token punctuation">.</span>remove<span class="token operator">=</span> led_remove<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">led_drv_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">platform_driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led_drv<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">led_drv_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">platform_driver_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led_drv<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>led_drv_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>led_drv_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="测试1"><a href="#测试1" class="headerlink" title="测试1"></a>测试1</h2><p>编译两个模块后运行如下，<br><img src="/images/20200415181339419.png"></p><h1 id="代码2，bus-drv-dev-在led中的应用"><a href="#代码2，bus-drv-dev-在led中的应用" class="headerlink" title="代码2，bus_drv_dev 在led中的应用"></a>代码2，bus_drv_dev 在led中的应用</h1><p>跟最早的led驱动一样，硬刚，繁琐，只是被拆成了两个部分，资源在dev中，驱动在drv中，drv相对固定，dev可以修改。</p><h2 id="led-dev-c-1"><a href="#led-dev-c-1" class="headerlink" title="led_dev.c"></a>led_dev.c</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/version.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/interrupt.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/list.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/timer.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/serial_core.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h></span></span><span class="token comment">// 分配  设置  注册一个platform_device</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEVICE_NAME</span>  <span class="token string">"myled"</span></span><span class="token comment">// 资源描述，寄存器，地址</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">resource</span> led_resource<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">.</span>start <span class="token operator">=</span> <span class="token number">0x56000050</span><span class="token punctuation">,</span>        <span class="token comment">// 起始地址</span>        <span class="token punctuation">.</span>end   <span class="token operator">=</span> <span class="token number">0x56000050</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token comment">// 结束地址</span>        <span class="token punctuation">.</span>flags <span class="token operator">=</span> IORESOURCE_MEM<span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">.</span>start <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span>end   <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span>flags <span class="token operator">=</span> IORESOURCE_IRQ<span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 先不写，硬件相关代码</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">led_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">platform_device</span> led_dev <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span>name           <span class="token operator">=</span> DEVICE_NAME<span class="token punctuation">,</span>    <span class="token punctuation">.</span>id             <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>    <span class="token punctuation">.</span>num_resources  <span class="token operator">=</span> <span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>led_resource<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">.</span>resource       <span class="token operator">=</span> led_resource<span class="token punctuation">,</span>    <span class="token punctuation">.</span>dev<span class="token punctuation">.</span>release    <span class="token operator">=</span> led_release<span class="token punctuation">,</span> <span class="token comment">// platform_device内有dev内有release。 硬件相关代码</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">led_dev_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">platform_device_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led_dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 最终放到platform的dev链表中 device_add</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">led_dev_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">platform_device_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led_dev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>led_dev_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>led_dev_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="led-drv-c-1"><a href="#led-drv-c-1" class="headerlink" title="led_drv.c"></a>led_drv.c</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/version.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/dma-mapping.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/clk.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mmc/mmc.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mmc/host.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/irq.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/uaccess.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h></span></span><span class="token comment">// 分配  设置  注册一个platform_driver</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEVICE_NAME</span>  <span class="token string">"myled"</span></span><span class="token keyword">static</span> <span class="token keyword">int</span> major<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>led_class<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">class_device</span> <span class="token operator">*</span>led_class_dev<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpio_con<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpio_dat<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> pin<span class="token punctuation">;</span><span class="token comment">//  配置GPF4/5/6为输出模式</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">led_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filep<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 配置为输出引脚</span>    <span class="token operator">*</span>gpio_con <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x3</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>pin<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 先清零 8-13 01010101</span>    <span class="token operator">*</span>gpio_dat <span class="token operator">|=</span>   <span class="token punctuation">(</span><span class="token number">0x1</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>pin<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 再对应位置1</span>    <span class="token comment">// printk("--%s--%s--%d\n", __FILE__, __func__, __LINE__);</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//  配置GPF4/5/6输出高或者低电平</span><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">led_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filep<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>ppos<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 在用户层传入的形式是 write(fd, &amp;val, 4); val是buf，4是count</span>    <span class="token comment">// 在内核层获取用户层传入的参数，用copy_from_user； 内核空间到用户传参数copy_to_user</span>    <span class="token keyword">int</span> user_param <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user_param<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 从buf拷贝到user_param，长度为count</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> user_param<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>       <span class="token comment">// 开灯</span>        <span class="token comment">// 4-6 000</span>        <span class="token operator">*</span>gpio_dat <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x1</span><span class="token operator">&lt;&lt;</span>pin<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> user_param<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 关灯</span>        <span class="token operator">*</span>gpio_dat <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0x1</span><span class="token operator">&lt;&lt;</span>pin<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// printk("--%s--%s--%d\n", __FILE__, __func__, __LINE__);</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span>owner  <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>    <span class="token punctuation">.</span>open   <span class="token operator">=</span> led_open<span class="token punctuation">,</span>    <span class="token punctuation">.</span>write  <span class="token operator">=</span> led_write<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// platform_device_register注册后device_add加入到dev，</span><span class="token comment">//  找能否支持看name相同否，找到则调用probe （dev中与drv中）</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">led_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"led_probe found led.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 根据platform_device的平台资源 获得寄存器和引脚资源，进行ioremap </span>    <span class="token comment">//  参考drivers\pcmcia\at91_cf.c的at91_cf_probe</span><span class="token keyword">struct</span> <span class="token class-name">resource</span><span class="token operator">*</span>resc<span class="token punctuation">;</span>resc <span class="token operator">=</span> <span class="token function">platform_get_resource</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> IORESOURCE_MEM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取寄存器资源</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resc<span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>    <span class="token comment">// led寄存器的地址映射，只需要执行一次，所以在入口函数映射, 起始 映射长度</span>    gpio_con <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>resc<span class="token operator">-></span>start<span class="token punctuation">,</span> resc<span class="token operator">-></span>end <span class="token operator">-</span> resc<span class="token operator">-></span>start <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    gpio_dat <span class="token operator">=</span> gpio_con <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>     resc <span class="token operator">=</span> <span class="token function">platform_get_resource</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> IORESOURCE_IRQ<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取引脚资源，这类资源的第0个</span>    pin <span class="token operator">=</span> resc<span class="token operator">-></span>start<span class="token punctuation">;</span> <span class="token comment">// 根据资源修改pin值</span>    <span class="token comment">// 注册字符设备驱动程序</span>    major <span class="token operator">=</span> <span class="token function">register_chrdev</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> DEVICE_NAME<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fops<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>major <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">printk</span><span class="token punctuation">(</span>DEVICE_NAME <span class="token string">"can't register major number.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> major<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    led_class <span class="token operator">=</span> <span class="token function">class_create</span><span class="token punctuation">(</span>THIS_MODULE<span class="token punctuation">,</span> <span class="token string">"led_class"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>led_class<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>led_class<span class="token punctuation">)</span><span class="token punctuation">;</span>    led_class_dev <span class="token operator">=</span> <span class="token function">class_device_create</span><span class="token punctuation">(</span>led_class<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> DEVICE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// /dev/DEVICE_NAME</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>led_class_dev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>led_class_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// platform_device_unregister卸载时，从dev中去掉，调用remove  （dev中与drv中）</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">led_remove</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"led_remove remove led.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 卸载字符设备驱动程序</span>    <span class="token function">class_device_destroy</span><span class="token punctuation">(</span>led_class<span class="token punctuation">,</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// call to class_device_create()</span>    <span class="token function">class_destroy</span><span class="token punctuation">(</span>led_class_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">unregister_chrdev</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> DEVICE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">iounmap</span><span class="token punctuation">(</span>gpio_con<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">platform_driver</span> led_drv <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>driver<span class="token punctuation">.</span>name<span class="token operator">=</span> DEVICE_NAME<span class="token punctuation">,</span> <span class="token comment">// name dev和drv要一样</span><span class="token punctuation">.</span>probe<span class="token operator">=</span> led_probe<span class="token punctuation">,</span><span class="token punctuation">.</span>remove<span class="token operator">=</span> led_remove<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">led_drv_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">platform_driver_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led_drv<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">led_drv_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">platform_driver_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led_drv<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>led_drv_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>led_drv_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="测试2"><a href="#测试2" class="headerlink" title="测试2"></a>测试2</h2><p>make<br>拷贝<br>加载<code>inmod led_drv.ko</code> 和 <code>inmod led_dev.ko</code>，看到probe和remove打印的结果<br>查看设备，<code>ls /dev/xxx -l</code><br><code>./xxxx on</code> 和 <code>./xxxx off</code><br><img src="/images/20200415224231429.png"><br>换个灯试试，只需要修改dev中资源的情况，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 资源描述，寄存器，地址</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">resource</span> led_resource<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">.</span>start <span class="token operator">=</span> <span class="token number">0x56000050</span><span class="token punctuation">,</span>        <span class="token comment">// 起始地址</span>        <span class="token punctuation">.</span>end   <span class="token operator">=</span> <span class="token number">0x56000050</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token comment">// 结束地址</span>        <span class="token punctuation">.</span>flags <span class="token operator">=</span> IORESOURCE_MEM<span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">.</span>start <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token comment">// 修改成另一个引脚</span>        <span class="token punctuation">.</span>end   <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token comment">// 修改成另一个引脚</span>        <span class="token punctuation">.</span>flags <span class="token operator">=</span> IORESOURCE_IRQ<span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第13课 2 输入子系统 1分配一个input_dev结构体 2设置 3注册 4硬件相关操作 重复事件修改定时器超时时间 改标准输入到指定设备exec _</title>
      <link href="2021/05/14/wds2-qi-di-13-ke-2-shu-ru-zi-xi-tong-1-fen-pei-yi-ge-input-dev-jie-gou-ti-2-she-zhi-3-zhu-ce-4-ying-jian-xiang-guan-cao-zuo-chong-fu-shi-jian-xiu-gai-ding-shi-qi-chao-shi-shi-jian-gai-biao-zhun-shu-ru-dao-zhi-ding-she-bei-exec-local/"/>
      <url>2021/05/14/wds2-qi-di-13-ke-2-shu-ru-zi-xi-tong-1-fen-pei-yi-ge-input-dev-jie-gou-ti-2-she-zhi-3-zhu-ce-4-ying-jian-xiang-guan-cao-zuo-chong-fu-shi-jian-xiu-gai-ding-shi-qi-chao-shi-shi-jian-gai-biao-zhun-shu-ru-dao-zhi-ding-she-bei-exec-local/</url>
      
        <content type="html"><![CDATA[<h1 id="之前不用input-subsystem的步骤"><a href="#之前不用input-subsystem的步骤" class="headerlink" title="之前不用input_subsystem的步骤"></a>之前不用input_subsystem的步骤</h1><p>自己写驱动程序<br>用户需要open，read，write<br>驱动也要完成对应的drv_open, drv_read, drv_write</p><ul><li>主设备号</li><li>构造fops<br>.read<br>.open<br>.poll<br>.fasync</li><li>register_chrdev(major, name, fops)</li><li>入口</li><li>出口</li><li>LICENSE</li></ul><p>以前在一个文件里把所有写完，在输入子系统里被拆分为几个文件，我们需要做的是：</p><ol><li>分配input_dev</li><li>设置</li><li>注册</li><li>硬件相关操作</li></ol><h1 id="在输入子系统下编程"><a href="#在输入子系统下编程" class="headerlink" title="在输入子系统下编程"></a>在输入子系统下编程</h1><p>主要参考例子，<code>drivers\input\keyboard\gpio_keys.c</code></p><p>上报事件，看<code>drivers\input\input.c</code>中的input_event函数的定义，最后几行，input_event会从input_dev的h_list中找到input_hanldle找到handler调用event函数，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/** * input_event() - report new input event * @dev: device that generated the event * @type: type of the event * @code: event code * @value: value of the event * * This function should be used by drivers implementing various input devices * See also input_inject_event() */</span><span class="token keyword">void</span> <span class="token function">input_event</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// input_event会从input_dev的h_list中找到input_hanldle</span>    <span class="token comment">//  找到handler调用event函数  </span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">else</span><span class="token function">list_for_each_entry</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dev<span class="token operator">-></span>h_list<span class="token punctuation">,</span> d_node<span class="token punctuation">)</span><span class="token keyword">if</span> <span class="token punctuation">(</span>handle<span class="token operator">-></span>open<span class="token punctuation">)</span>handle<span class="token operator">-></span>handler<span class="token operator">-></span><span class="token function">event</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> type<span class="token punctuation">,</span> code<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>有了input subsystem，我们只需要写硬件相关的代码，其他read，write，poll等已经被写好了，在drivers\input\evdev.c里面，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> evdev_fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>owner <span class="token operator">=</span>THIS_MODULE<span class="token punctuation">,</span><span class="token punctuation">.</span>read <span class="token operator">=</span>evdev_read<span class="token punctuation">,</span><span class="token punctuation">.</span>write <span class="token operator">=</span>evdev_write<span class="token punctuation">,</span><span class="token punctuation">.</span>poll <span class="token operator">=</span>evdev_poll<span class="token punctuation">,</span><span class="token punctuation">.</span>open <span class="token operator">=</span>evdev_open<span class="token punctuation">,</span><span class="token punctuation">.</span>release <span class="token operator">=</span>evdev_release<span class="token punctuation">,</span><span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span> evdev_ioctl<span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="1-编译make"><a href="#1-编译make" class="headerlink" title="1. 编译make"></a>1. 编译<code>make</code></h2><h2 id="2-拷贝到网络文件系统cp-xxx-ko-mnt"><a href="#2-拷贝到网络文件系统cp-xxx-ko-mnt" class="headerlink" title="2. 拷贝到网络文件系统cp xxx.ko /mnt/"></a>2. 拷贝到网络文件系统<code>cp xxx.ko /mnt/</code></h2><h2 id="3-查看原来的事件，ls-dev-event"><a href="#3-查看原来的事件，ls-dev-event" class="headerlink" title="3. 查看原来的事件，ls /dev/event*"></a>3. 查看原来的事件，<code>ls /dev/event*</code></h2><h2 id="4-插入模块inmod-buttons-ko"><a href="#4-插入模块inmod-buttons-ko" class="headerlink" title="4. 插入模块inmod buttons.ko"></a>4. 插入模块<code>inmod buttons.ko</code></h2><h2 id="5-再查看事件，ls-dev-event"><a href="#5-再查看事件，ls-dev-event" class="headerlink" title="5. 再查看事件，ls /dev/event*"></a>5. 再查看事件，<code>ls /dev/event*</code></h2><p>看到新的event主设备号为13，次设备号为65，</p><h3 id="下面解释次设备号65："><a href="#下面解释次设备号65：" class="headerlink" title="下面解释次设备号65："></a>下面解释次设备号65：</h3><p><code>input_register_device</code>函数会从右边<code>handler</code>一个个取出与左边<code>input_dev</code>比较，比较<code>id_table</code>，在<code>drivers\input\evdev.c</code>中看到evdev支持所有的输入设备<code>/* Matches all devices */</code>，<br>当然也支持按键类输入设备，于是会调用<code>connect</code>函数，在<code>connect</code>函数里，<br>    <pre class="line-numbers language-c" data-language="c"><code class="language-c">drivers\input\evdev<span class="token punctuation">.</span>c <span class="token operator">--</span> id_table <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">input_device_id</span> evdev_ids<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> <span class="token punctuation">.</span>driver_info <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token comment">/* Matches all devices */</span><span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token comment">/* Terminating zero entry */</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token function">MODULE_DEVICE_TABLE</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> evdev_ids<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">input_handler</span> evdev_handler <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>event <span class="token operator">=</span>evdev_event<span class="token punctuation">,</span><span class="token punctuation">.</span>connect <span class="token operator">=</span>evdev_connect<span class="token punctuation">,</span><span class="token punctuation">.</span>disconnect <span class="token operator">=</span>evdev_disconnect<span class="token punctuation">,</span><span class="token punctuation">.</span>fops <span class="token operator">=</span><span class="token operator">&amp;</span>evdev_fops<span class="token punctuation">,</span><span class="token punctuation">.</span>minor <span class="token operator">=</span>EVDEV_MINOR_BASE<span class="token punctuation">,</span><span class="token punctuation">.</span>name <span class="token operator">=</span><span class="token string">"evdev"</span><span class="token punctuation">,</span><span class="token punctuation">.</span>id_table <span class="token operator">=</span>evdev_ids<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>drivers\input\evdev<span class="token punctuation">.</span>c <span class="token operator">--</span> connect<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">evdev_connect</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_handler</span> <span class="token operator">*</span>handler<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">input_device_id</span> <span class="token operator">*</span>id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">// #define EVDEV_MINOR_BASE64</span>devt <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>INPUT_MAJOR<span class="token punctuation">,</span> EVDEV_MINOR_BASE <span class="token operator">+</span> minor<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// 在class下面创建设备，这样就文件系统中mdev就会自动创建设备节点</span>cdev <span class="token operator">=</span> <span class="token function">class_device_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input_class<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dev<span class="token operator">-></span>cdev<span class="token punctuation">,</span> devt<span class="token punctuation">,</span>   dev<span class="token operator">-></span>cdev<span class="token punctuation">.</span>dev<span class="token punctuation">,</span> evdev<span class="token operator">-></span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><br>    <img src="/images/20200414210158602.png"><br>在<code>drivers\input\input.c</code>中，创建了class，注册了字符设备，但并没有在class下面创建设备（在class下面创建设备，文件系统的mdev就会自动创建设备节点），所以创建设备应该是在connnet中完成，<br>（之前自己写代码。创建class后，下面就直接创建设备，输入子系统把他们分开了，在<code>connect</code>和<code>input_init</code>分别完成）<br>    <pre class="line-numbers language-c" data-language="c"><code class="language-c">drivers\input\input<span class="token punctuation">.</span>c<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">input_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">// 创建class</span>err <span class="token operator">=</span> <span class="token function">class_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input_class<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 注册字符设备</span>err <span class="token operator">=</span> <span class="token function">register_chrdev</span><span class="token punctuation">(</span>INPUT_MAJOR<span class="token punctuation">,</span> <span class="token string">"input"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>input_fops<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>drivers\input\evdev<span class="token punctuation">.</span>c <span class="token operator">--</span> connect<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">evdev_connect</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_handler</span> <span class="token operator">*</span>handler<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">input_device_id</span> <span class="token operator">*</span>id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">// #define EVDEV_MINOR_BASE64</span>devt <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>INPUT_MAJOR<span class="token punctuation">,</span> EVDEV_MINOR_BASE <span class="token operator">+</span> minor<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// 在class下面创建设备，这样就文件系统中mdev就会自动创建设备节点，次设备号</span>cdev <span class="token operator">=</span> <span class="token function">class_device_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input_class<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dev<span class="token operator">-></span>cdev<span class="token punctuation">,</span> devt<span class="token punctuation">,</span>   dev<span class="token operator">-></span>cdev<span class="token punctuation">.</span>dev<span class="token punctuation">,</span> evdev<span class="token operator">-></span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p><h2 id="6-打开终端，等待按键输入，cat-dev-tty1，按键S2-S3-S4"><a href="#6-打开终端，等待按键输入，cat-dev-tty1，按键S2-S3-S4" class="headerlink" title="6. 打开终端，等待按键输入，cat /dev/tty1，按键S2 S3 S4"></a>6. 打开终端，等待按键输入，<code>cat /dev/tty1</code>，按键S2 S3 S4</h2><p>出错，调试</p><h3 id="调试方法一：hexdump-dev-event1-（打开-dev-event1设备，读取设备-对应文件-，以16进制显示）"><a href="#调试方法一：hexdump-dev-event1-（打开-dev-event1设备，读取设备-对应文件-，以16进制显示）" class="headerlink" title="调试方法一：hexdump /dev/event1 （打开 /dev/event1设备，读取设备[对应文件]，以16进制显示）"></a>调试方法一：<code>hexdump /dev/event1</code> （打开 /dev/event1设备，读取设备[对应文件]，以16进制显示）</h3><p><img src="/images/20200414213110877.png"><br>打开哪个对应的文件，分析，在<code>drivers\input\input.c</code>中<code>input_init</code>需要用<code>input_fops</code>注册字符设备，找到 <code>input_fops</code>的<code>.read = input_open_file</code>，打开，次设备号为65，右移5就是除以32等于2也就是input_table[2]，这个东西在<code>input_register_handler(&amp;evdev_handler);</code>被赋值<code>handler</code>也就是<code>evdev_handler</code>，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">drivers\input\input<span class="token punctuation">.</span>c<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">input_open_file</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">input_handler</span> <span class="token operator">*</span>handler <span class="token operator">=</span> input_table<span class="token punctuation">[</span><span class="token function">iminor</span><span class="token punctuation">(</span>inode<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>drivers\input\input<span class="token punctuation">.</span>c<span class="token keyword">int</span> <span class="token function">input_register_handler</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_handler</span> <span class="token operator">*</span>handler<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>input_table<span class="token punctuation">[</span>handler<span class="token operator">-></span>minor <span class="token operator">>></span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> handler<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>怎么读，<code>evdev_read</code>，读环形缓冲区数据 头不等于尾，然后将读到的数据拷贝到用户空间<code>evdev_event_to_user</code>，查看数据格式，就是前面那个<code>hexdump /dev/event1</code>命令打开的内容了，就是<code>input_event</code> 它了，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">include\linux\input<span class="token punctuation">.</span>h<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> evdev_fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>owner <span class="token operator">=</span>THIS_MODULE<span class="token punctuation">,</span><span class="token punctuation">.</span>read <span class="token operator">=</span>evdev_read<span class="token punctuation">,</span><span class="token punctuation">.</span>write <span class="token operator">=</span>evdev_write<span class="token punctuation">,</span><span class="token punctuation">.</span>poll <span class="token operator">=</span>evdev_poll<span class="token punctuation">,</span><span class="token punctuation">.</span>open <span class="token operator">=</span>evdev_open<span class="token punctuation">,</span><span class="token punctuation">.</span>release <span class="token operator">=</span>evdev_release<span class="token punctuation">,</span><span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span> evdev_ioctl<span class="token punctuation">,</span>include\linux\input<span class="token punctuation">.</span>h<span class="token keyword">struct</span> <span class="token class-name">input_event</span> <span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">timeval</span> time<span class="token punctuation">;</span>__u16 type<span class="token punctuation">;</span>__u16 code<span class="token punctuation">;</span>__s32 value<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>include\linux\time<span class="token punctuation">.</span>h<span class="token keyword">struct</span> <span class="token class-name">timeval</span> <span class="token punctuation">&#123;</span><span class="token class-name">time_t</span>tv_sec<span class="token punctuation">;</span><span class="token comment">/* seconds */</span>      <span class="token number">4</span>个字节<span class="token class-name">suseconds_t</span>tv_usec<span class="token punctuation">;</span><span class="token comment">/* microseconds */</span> <span class="token number">4</span>个字节<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>现在就可以具体解析那个文件16进制内容，4 4 2 2 4字节，左边低字节右边高字节，<br>如 类 0001是<code>EV_KEY</code>的值0x01，0000是EV_SYN的值0x00；<br>code 0026是<code>KEY_L</code>的值38；<br>value 0001 0000是按下 1，0000 0000是松开 0；<br>第二行和第四行表示上报的同步类事件。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EV_SYN</span><span class="token expression"><span class="token number">0x00</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EV_KEY</span><span class="token expression"><span class="token number">0x01</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EV_REL</span><span class="token expression"><span class="token number">0x02</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="/images/20200414223329640.png"></p><h3 id="调试方法二：如果没有启动QT，cat-dev-tty1，按键S2-S3-S4就是输入ls-enter。"><a href="#调试方法二：如果没有启动QT，cat-dev-tty1，按键S2-S3-S4就是输入ls-enter。" class="headerlink" title="调试方法二：如果没有启动QT，cat /dev/tty1，按键S2 S3 S4就是输入ls enter。"></a>调试方法二：如果没有启动QT，<code>cat /dev/tty1</code>，按键S2 S3 S4就是输入<code>ls enter</code>。</h3><p>如果没有启动QT，<code>cat /dev/tty1</code>，按键S2 S3 S4就是输入<code>ls enter</code>。</p><p>或者 exec 0&lt;/dev/tty1<code>将标准输入改成</code>tty1</p><p>查看需要的、依赖的文件有没有被编译进内核，这里检查<code>keyboard.c</code>，<br><code>ls drivers/char/keyboard.</code>存在对应.o就是被编译进去了。<br><img src="/images/20200414224651864.png"></p><h3 id="调试方法三：如果启动了QT，打开记事本，新建文件，然后按S2-S3-S4，"><a href="#调试方法三：如果启动了QT，打开记事本，新建文件，然后按S2-S3-S4，" class="headerlink" title="调试方法三：如果启动了QT，打开记事本，新建文件，然后按S2 S3 S4，"></a>调试方法三：如果启动了QT，打开记事本，新建文件，然后按S2 S3 S4，</h3><p>如果启动了QT，打开记事本，新建文件，然后按S2 S3 S4，可以在文件中看到ls enter。<br>杀不掉QT，就inittab，<code>vi /etc/inittab</code> ，修改那个<code>rcS</code>，<code>vi /etc/init.d/rcS</code>，注释掉最后一行。<br><img src="/images/20200414225706785.png"><br><code>exec 0&lt;/dev/tty1</code>将标准输入改成<code>tty1</code>，以前从串口得到输入现在改为按键输入。</p><h2 id="分析连续键值-（重复事件修改定时器超时时间）"><a href="#分析连续键值-（重复事件修改定时器超时时间）" class="headerlink" title="分析连续键值  （重复事件修改定时器超时时间）"></a>分析连续键值  （重复事件修改定时器超时时间）</h2><p>按着按键不松开并没有显示多个值(连续键值)，需要产生重复类事件就可以了，实际是通过修改定时器的值实现，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 2.1能产生哪类事件，按键类 重复类（修改定时器超时事件）</span><span class="token function">set_bit</span><span class="token punctuation">(</span>EV_KEY<span class="token punctuation">,</span> _buttons_dev<span class="token operator">-></span>evbit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">set_bit</span><span class="token punctuation">(</span>EV_REP<span class="token punctuation">,</span> _buttons_dev<span class="token operator">-></span>evbit<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>分析，按键的重复事件，在<code>input_event</code>中，如果能产生重复类事件就修改定时器超时时间，当然也需要时间处理函数就需要<code>init_timer</code>跟着找，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">drivers\input\input<span class="token punctuation">.</span>c<span class="token keyword">void</span> <span class="token function">input_event</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">case</span> EV_KEY<span class="token operator">:</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token function">change_bit</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> dev<span class="token operator">-></span>key<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 如果能产生重复类事件就修改定时器超时时间</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">test_bit</span><span class="token punctuation">(</span>EV_REP<span class="token punctuation">,</span> dev<span class="token operator">-></span>evbit<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> dev<span class="token operator">-></span>rep<span class="token punctuation">[</span>REP_PERIOD<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> dev<span class="token operator">-></span>rep<span class="token punctuation">[</span>REP_DELAY<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> dev<span class="token operator">-></span>timer<span class="token punctuation">.</span>data <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>dev<span class="token operator">-></span>repeat_key <span class="token operator">=</span> code<span class="token punctuation">;</span> <span class="token comment">// 记录需要重复的按键值</span><span class="token function">mod_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>timer<span class="token punctuation">,</span> jiffies <span class="token operator">+</span> <span class="token function">msecs_to_jiffies</span><span class="token punctuation">(</span>dev<span class="token operator">-></span>rep<span class="token punctuation">[</span>REP_DELAY<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">break</span><span class="token punctuation">;</span>drivers\input\input<span class="token punctuation">.</span>c<span class="token keyword">int</span> <span class="token function">input_register_device</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">init_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>dev<span class="token operator">-></span>timer<span class="token punctuation">.</span>function <span class="token operator">=</span> input_repeat_key<span class="token punctuation">;</span>drivers\input\input<span class="token punctuation">.</span>c<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">input_repeat_key</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">// 上报时间 记录的那个重复键值，重复事件2，0松开1按下</span><span class="token function">input_event</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> EV_KEY<span class="token punctuation">,</span> dev<span class="token operator">-></span>repeat_key<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">input_sync</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-></span>rep<span class="token punctuation">[</span>REP_PERIOD<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token function">mod_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>timer<span class="token punctuation">,</span> jiffies <span class="token operator">+</span> <span class="token function">msecs_to_jiffies</span><span class="token punctuation">(</span>dev<span class="token operator">-></span>rep<span class="token punctuation">[</span>REP_PERIOD<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>根据接受的数据显示或删除的程序是shell，进程号770，查看它打开了哪些文件，<code>ls -l /proc/770/fd</code>,标准输入0输出1错误2都是串口，    <code>exec 0&lt;/dev/tty1</code>将标准输入改成<code>tty1</code><br><img src="/images/20200414232109965.png"></p><h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/version.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/interrupt.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/irq.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/sched.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/pm.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/sysctl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/proc_fs.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/delay.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/input.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/irq.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/gpio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/regs-gpio.h></span> <span class="token comment">// S3C2410_GPFx</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/gpio.h></span></span><span class="token comment">// 引脚描述结构体 中断号、名称、管脚、键值</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">pin_desc</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> irq<span class="token punctuation">;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> pin<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> key_val<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 定义一个引脚描述数组，并初始化，对应于4个按键的信息</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NUMS_KEYS</span>   <span class="token expression"><span class="token number">4</span></span></span><span class="token keyword">struct</span> <span class="token class-name">pin_desc</span> pins_desc<span class="token punctuation">[</span>NUMS_KEYS<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#123;</span>IRQ_EINT0<span class="token punctuation">,</span>  <span class="token string">"EINT0_S2"</span><span class="token punctuation">,</span>  S3C2410_GPF0<span class="token punctuation">,</span>  KEY_L<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>IRQ_EINT2<span class="token punctuation">,</span>  <span class="token string">"EINT2_S3"</span><span class="token punctuation">,</span>  S3C2410_GPF2<span class="token punctuation">,</span>  KEY_S<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>IRQ_EINT11<span class="token punctuation">,</span> <span class="token string">"EINT11_S4"</span><span class="token punctuation">,</span> S3C2410_GPG3<span class="token punctuation">,</span>  KEY_ENTER<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>IRQ_EINT19<span class="token punctuation">,</span> <span class="token string">"EINT19_S5"</span><span class="token punctuation">,</span> S3C2410_GPG11<span class="token punctuation">,</span> KEY_LEFTSHIFT<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// 定义一个输入设备结构</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>_buttons_dev<span class="token punctuation">;</span><span class="token comment">// 定义一个定时器</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">timer_list</span> buttons_timer<span class="token punctuation">;</span><span class="token comment">// 发生中断后，参数的在irq和timer_function之间传递</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">pin_desc</span> <span class="token operator">*</span>irq_pd<span class="token punctuation">;</span> <span class="token comment">// 在中断中的引脚描述pin_desc</span><span class="token comment">// ISR 发生按键中断之后会调用这个函数, irq就是对应的中断号</span><span class="token comment">// 按键中断发生后进入irq，修改定时器溢出值，修改按键的struct</span><span class="token keyword">static</span> <span class="token class-name">irqreturn_t</span> <span class="token function">buttons_irq</span><span class="token punctuation">(</span><span class="token keyword">int</span> irq<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dev_id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    irq_pd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pin_desc</span> <span class="token operator">*</span><span class="token punctuation">)</span>dev_id<span class="token punctuation">;</span>    <span class="token comment">// jiffies是全局变量,每隔10ms系统产生一个时钟中断, 10ms</span>    <span class="token function">mod_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buttons_timer<span class="token punctuation">,</span> jiffies<span class="token operator">+</span>HZ<span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">IRQ_RETVAL</span><span class="token punctuation">(</span>IRQ_HANDLED<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 时间处理函数，超时会被调用</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">buttons_timer_function</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>       <span class="token keyword">struct</span> <span class="token class-name">pin_desc</span> <span class="token operator">*</span> pindesc <span class="token operator">=</span> irq_pd<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> pin_status<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pindesc<span class="token punctuation">)</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token comment">// 获取该引脚状态</span>    pin_status <span class="token operator">=</span> <span class="token function">s3c2410_gpio_getpin</span><span class="token punctuation">(</span>pindesc<span class="token operator">-></span>pin<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 上报事件</span>    <span class="token comment">// 之前的代码是 确定按键值，唤醒用户程序或者发信号，</span>    <span class="token comment">// 在input subsystem中，现在只需要上报事件就ok</span>    <span class="token comment">// input_event会从input_dev的h_list中找到input_hanldle</span>    <span class="token comment">//  找到handler调用event函数 在drivers\input\input.c中input_event的最后几行    </span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pin_status<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 松开</span>        <span class="token comment">// 哪个设备、事件类型、哪个事件、值（0表示松开，1表示按下）</span>        <span class="token function">input_event</span><span class="token punctuation">(</span>_buttons_dev<span class="token punctuation">,</span> EV_KEY<span class="token punctuation">,</span> pindesc<span class="token operator">-></span>key_val<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 还有上报同步事件</span>        <span class="token function">input_sync</span><span class="token punctuation">(</span>_buttons_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>          <span class="token comment">// 按下</span>        <span class="token function">input_event</span><span class="token punctuation">(</span>_buttons_dev<span class="token punctuation">,</span> EV_KEY<span class="token punctuation">,</span> pindesc<span class="token operator">-></span>key_val<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">input_sync</span><span class="token punctuation">(</span>_buttons_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">buttons_inSubSys_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> error<span class="token punctuation">;</span>    <span class="token comment">/*1. 分配一个input_dev结构体 */</span>    _buttons_dev <span class="token operator">=</span> <span class="token function">input_allocate_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_buttons_dev<span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>    <span class="token comment">/*2. 设置 */</span><span class="token comment">// unsigned long evbit[NBITS(EV_MAX)];  // 表示能产生哪类事件</span><span class="token comment">// unsigned long keybit[NBITS(KEY_MAX)];// 表示能产生哪些事件</span><span class="token comment">// unsigned long relbit[NBITS(REL_MAX)];// 表示能产生哪些相对位移事件 (x y 滚轮)</span>      <span class="token comment">// #define EV_SYN0x00 // 同步类事件</span>    <span class="token comment">// #define EV_KEY0x01 // 按键类事件</span>    <span class="token comment">// #define EV_REL0x02 // 相对位移类事件 鼠标滑动</span>    <span class="token comment">// #define EV_ABS0x03 // 绝对位移类事件 点击屏幕</span>    <span class="token comment">// 2.1能产生哪类事件，按键类 重复类（修改定时器超时事件）</span>    <span class="token function">set_bit</span><span class="token punctuation">(</span>EV_KEY<span class="token punctuation">,</span> _buttons_dev<span class="token operator">-></span>evbit<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">set_bit</span><span class="token punctuation">(</span>EV_REP<span class="token punctuation">,</span> _buttons_dev<span class="token operator">-></span>evbit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 只需要这一句就可以实现按下按键时重复按键值</span>    <span class="token comment">// 2.2能产生这类事件里的哪些事件 (哪个按键呢 l s ENTER LEFTSHIFT)</span>    <span class="token function">set_bit</span><span class="token punctuation">(</span>KEY_L<span class="token punctuation">,</span> _buttons_dev<span class="token operator">-></span>keybit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置数组的某一位</span>    <span class="token function">set_bit</span><span class="token punctuation">(</span>KEY_S<span class="token punctuation">,</span> _buttons_dev<span class="token operator">-></span>keybit<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">set_bit</span><span class="token punctuation">(</span>KEY_ENTER<span class="token punctuation">,</span> _buttons_dev<span class="token operator">-></span>keybit<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">set_bit</span><span class="token punctuation">(</span>KEY_LEFTSHIFT<span class="token punctuation">,</span> _buttons_dev<span class="token operator">-></span>keybit<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/*3. 注册 */</span>     <span class="token comment">// 加入到某个管理输入子系统设备的链表，然后依次与右边的hanlder的id比较，</span>    <span class="token comment">// 看是否支持此设备，支持则调用connect函数，建立input_handle, </span>    <span class="token comment">// dev指向左，handler指向右边，再把input_handle放入两边的.h_list</span>    error <span class="token operator">=</span> <span class="token function">input_register_device</span><span class="token punctuation">(</span>_buttons_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"Unable to register _buttons_dev input device.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">goto</span> fail_input_register_device<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/*4. 硬件相关操作 */</span>    <span class="token comment">// 初始化定时器、定时器函数、start a timer，用于防抖动</span>    <span class="token function">init_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buttons_timer<span class="token punctuation">)</span><span class="token punctuation">;</span>    buttons_timer<span class="token punctuation">.</span>function <span class="token operator">=</span> buttons_timer_function<span class="token punctuation">;</span>    <span class="token function">add_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buttons_timer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 注册中断函数</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>NUMS_KEYS<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// 应该需要判断返回值</span>        <span class="token function">request_irq</span><span class="token punctuation">(</span>pins_desc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>irq<span class="token punctuation">,</span> buttons_irq<span class="token punctuation">,</span> IRQT_BOTHEDGE<span class="token punctuation">,</span> \                    pins_desc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pins_desc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"gpio-keys: unable to claim irq %d; error %d.\n"</span><span class="token punctuation">,</span>pins_desc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>irq<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">goto</span> fail_request_irq<span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 倒序释放</span>fail_request_irq<span class="token operator">:</span>    <span class="token comment">// 对应于request_irq，注意i</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span>             <span class="token function">free_irq</span><span class="token punctuation">(</span>pins_desc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>irq<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pins_desc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 对应于add_timer</span>    <span class="token function">del_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buttons_timer<span class="token punctuation">)</span><span class="token punctuation">;</span>fail_input_register_device<span class="token operator">:</span>    <span class="token comment">// 对应于input_register_device</span>    <span class="token function">input_unregister_device</span><span class="token punctuation">(</span>_buttons_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// input_allocate_device</span>    <span class="token function">input_free_device</span><span class="token punctuation">(</span>_buttons_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> error<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">buttons_inSubSys_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> i<span class="token punctuation">;</span>    <span class="token comment">// 对应于request_irq</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span>NUMS_KEYS<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">>=</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">free_irq</span><span class="token punctuation">(</span>pins_desc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>irq<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pins_desc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>        <span class="token comment">// 对应于add_timer</span>    <span class="token function">del_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buttons_timer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 对应于input_register_device</span>    <span class="token function">input_unregister_device</span><span class="token punctuation">(</span>_buttons_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// input_allocate_device</span>    <span class="token function">input_free_device</span><span class="token punctuation">(</span>_buttons_dev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>buttons_inSubSys_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>buttons_inSubSys_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS2期第13课 1 输入子系统框架 input.c是核心层 代表硬件input_dev 纯软件input_handler input_handle连接</title>
      <link href="2021/05/14/wds2-qi-di-13-ke-1-shu-ru-zi-xi-tong-kuang-jia-input.c-shi-he-xin-ceng-dai-biao-ying-jian-input-dev-chun-ruan-jian-input-handler-input-handle-lian-jie-local/"/>
      <url>2021/05/14/wds2-qi-di-13-ke-1-shu-ru-zi-xi-tong-kuang-jia-input.c-shi-he-xin-ceng-dai-biao-ying-jian-input-dev-chun-ruan-jian-input-handler-input-handle-lian-jie-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]</p><p>之前写的代码只适合内部使用（自己用或者公司内部用），不能通用，也许通过scanf就要去打开某个设备。<br>想要用户代码无需任何修改就能使用之前的驱动， 就要使用<strong>输入子系统</strong>。</p><p>输入子系统框架<br>input.c 是核心层<br><img src="/images/2020041122333580.png"></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 流程</span>drivers<span class="token operator">/</span>input<span class="token operator">/</span>input<span class="token punctuation">.</span>cerr <span class="token operator">=</span> <span class="token function">register_chrdev</span><span class="token punctuation">(</span>INPUT_MAJOR<span class="token punctuation">,</span> <span class="token string">"input"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>input_fops<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> input_fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span><span class="token punctuation">.</span>open <span class="token operator">=</span> input_open_file<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 怎么读按键</span>input_open_file<span class="token keyword">struct</span> <span class="token class-name">input_handler</span> <span class="token operator">*</span>handler <span class="token operator">=</span> input_table<span class="token punctuation">[</span><span class="token function">iminor</span><span class="token punctuation">(</span>inode<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>new_fops <span class="token operator">=</span> <span class="token function">fops_get</span><span class="token punctuation">(</span>handler<span class="token operator">-></span>fops<span class="token punctuation">)</span>file<span class="token operator">-></span>f_op <span class="token operator">=</span> new_fops<span class="token punctuation">;</span> <span class="token comment">// 将新的fops赋值给file的f_op</span>err <span class="token operator">=</span> new_fops<span class="token operator">-></span><span class="token function">open</span><span class="token punctuation">(</span>inode<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// input_table由谁构造</span>input_table<span class="token keyword">int</span> <span class="token function">input_register_handler</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_handler</span> <span class="token operator">*</span>handler<span class="token punctuation">)</span> <span class="token comment">// 构造了input_table数组的项</span><span class="token comment">// 在keyboard.c  evdev.c  joydev.c  mousedev.c  tsdev.c中调用了input_register_handler，向上注册input_register_handler</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>主要代码在<code>drivers/input/input.c</code>里，已经写好字符设备的注册等代码<code>register_chrdev(INPUT_MAJOR, &quot;input&quot;, &amp;input_fops);</code>，但<code>fops</code>只有<code>.open</code>，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> input_fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span><span class="token punctuation">.</span>open <span class="token operator">=</span> input_open_file<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">input_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">int</span> err<span class="token punctuation">;</span>err <span class="token operator">=</span> <span class="token function">class_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input_class<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"input: unable to register input_dev class\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> err<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>err <span class="token operator">=</span> <span class="token function">input_proc_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token keyword">goto</span> fail1<span class="token punctuation">;</span>err <span class="token operator">=</span> <span class="token function">register_chrdev</span><span class="token punctuation">(</span>INPUT_MAJOR<span class="token punctuation">,</span> <span class="token string">"input"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>input_fops<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"input: unable to register char major %d"</span><span class="token punctuation">,</span> INPUT_MAJOR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">goto</span> fail2<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> fail2<span class="token operator">:</span><span class="token function">input_proc_exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> fail1<span class="token operator">:</span><span class="token function">class_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input_class<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> err<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查看这个.open函数，根据inode的次设备号获得新的fops，赋值给file的f_op，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">input_open_file</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">input_handler</span> <span class="token operator">*</span>handler <span class="token operator">=</span> input_table<span class="token punctuation">[</span><span class="token function">iminor</span><span class="token punctuation">(</span>inode<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token operator">*</span>old_fops<span class="token punctuation">,</span> <span class="token operator">*</span>new_fops <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">int</span> err<span class="token punctuation">;</span><span class="token comment">/* No load-on-demand here? */</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>handler <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>new_fops <span class="token operator">=</span> <span class="token function">fops_get</span><span class="token punctuation">(</span>handler<span class="token operator">-></span>fops<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 获得新的new_fops</span><span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span><span class="token comment">/* * That's _really_ odd. Usually NULL ->open means "nothing special", * not "no device". Oh, well... */</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>new_fops<span class="token operator">-></span>open<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">fops_put</span><span class="token punctuation">(</span>new_fops<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>old_fops <span class="token operator">=</span> file<span class="token operator">-></span>f_op<span class="token punctuation">;</span>file<span class="token operator">-></span>f_op <span class="token operator">=</span> new_fops<span class="token punctuation">;</span> <span class="token comment">// 将新的fops赋值给file的f_op</span>err <span class="token operator">=</span> new_fops<span class="token operator">-></span><span class="token function">open</span><span class="token punctuation">(</span>inode<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">fops_put</span><span class="token punctuation">(</span>file<span class="token operator">-></span>f_op<span class="token punctuation">)</span><span class="token punctuation">;</span>file<span class="token operator">-></span>f_op <span class="token operator">=</span> <span class="token function">fops_get</span><span class="token punctuation">(</span>old_fops<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">fops_put</span><span class="token punctuation">(</span>old_fops<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> err<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其中<code>input_table[iminor(inode) &gt;&gt; 5];</code>这个数组的项由<code>input_register_handler</code>构造，<code>input_register_handler</code>被多个调用（<code>keyboard.c  evdev.c  joydev.c  mousedev.c  tsdev.c</code>），</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">input_register_handler</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_handler</span> <span class="token operator">*</span>handler<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">;</span><span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>handler<span class="token operator">-></span>h_list<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>handler<span class="token operator">-></span>fops <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>input_table<span class="token punctuation">[</span>handler<span class="token operator">-></span>minor <span class="token operator">>></span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>input_table<span class="token punctuation">[</span>handler<span class="token operator">-></span>minor <span class="token operator">>></span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> handler<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>比如在evdev.c的入口函数中，就调用了<code>input_register_handler</code>,</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">evdev_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">input_register_handler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>evdev_handler<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><code>input_register_handler</code>,函数的参数是<code>input_handler</code>类型，<code>input_register_handler</code>结构体包含了<code>fops</code>结构，<code>fops</code>就有了open read write等，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// input_handler结构体</span><span class="token keyword">struct</span> <span class="token class-name">input_handler</span> <span class="token punctuation">&#123;</span><span class="token keyword">void</span> <span class="token operator">*</span>private<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>event<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_handle</span> <span class="token operator">*</span>handle<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>connect<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_handler</span> <span class="token operator">*</span>handler<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">input_device_id</span> <span class="token operator">*</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>disconnect<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_handle</span> <span class="token operator">*</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>start<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_handle</span> <span class="token operator">*</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token operator">*</span>fops<span class="token punctuation">;</span> <span class="token comment">// 包含了fops结果</span><span class="token keyword">int</span> minor<span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span><span class="token comment">// 参数evdev_handler的初始化，</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">input_handler</span> evdev_handler <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>event <span class="token operator">=</span>evdev_event<span class="token punctuation">,</span><span class="token punctuation">.</span>connect <span class="token operator">=</span>evdev_connect<span class="token punctuation">,</span><span class="token comment">// 支持这个设备就调用connect，与硬件建立连接</span><span class="token punctuation">.</span>disconnect <span class="token operator">=</span>evdev_disconnect<span class="token punctuation">,</span><span class="token punctuation">.</span>fops <span class="token operator">=</span><span class="token operator">&amp;</span>evdev_fops<span class="token punctuation">,</span><span class="token punctuation">.</span>minor <span class="token operator">=</span>EVDEV_MINOR_BASE<span class="token punctuation">,</span> <span class="token comment">// 64</span><span class="token punctuation">.</span>name <span class="token operator">=</span><span class="token string">"evdev"</span><span class="token punctuation">,</span><span class="token punctuation">.</span>id_table <span class="token operator">=</span>evdev_ids<span class="token punctuation">,</span> <span class="token comment">// 表示这个handler能够支持哪些输入设备</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// file_operations结构体</span><span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token punctuation">&#123;</span><span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>read<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>write<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>mmap<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">vm_area_struct</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>open<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="注册输入设备-input-register-device-（对称）"><a href="#注册输入设备-input-register-device-（对称）" class="headerlink" title="注册输入设备 input_register_device （对称）"></a>注册输入设备 input_register_device （对称）</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 流程</span><span class="token keyword">int</span> <span class="token function">input_register_device</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span> <span class="token comment">// 注册输入设备</span><span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>input_dev_list<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 放入链表</span><span class="token function">list_for_each_entry</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> <span class="token operator">&amp;</span>input_handler_list<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token comment">// 对每个input_handler都调用input_attach_handler</span><span class="token function">input_attach_handler</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 根据input_handler的id_table判断能否支持这个input_dev</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">input_register_device</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>input_dev_list<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">list_for_each_entry</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> <span class="token operator">&amp;</span>input_handler_list<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token function">input_attach_handler</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">input_wakeup_procfs_readers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="注册handler-input-register-handler-（对称）"><a href="#注册handler-input-register-handler-（对称）" class="headerlink" title="注册handler input_register_handler  （对称）"></a>注册handler input_register_handler  （对称）</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 流程</span><span class="token keyword">int</span> <span class="token function">input_register_handler</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_handler</span> <span class="token operator">*</span>handler<span class="token punctuation">)</span> <span class="token comment">// 注册handler</span><span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>handler<span class="token operator">-></span>node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>input_handler_list<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 放入链表</span><span class="token function">list_for_each_entry</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>input_dev_list<span class="token punctuation">,</span> node<span class="token punctuation">)</span>       <span class="token comment">// 对于每个input_dev调用input_attach_handler</span><span class="token function">input_attach_handler</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 根据handler的id_table判断能否支持这个input_dev</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">input_register_handler</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_handler</span> <span class="token operator">*</span>handler<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">;</span><span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>handler<span class="token operator">-></span>h_list<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>handler<span class="token operator">-></span>fops <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>input_table<span class="token punctuation">[</span>handler<span class="token operator">-></span>minor <span class="token operator">>></span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>input_table<span class="token punctuation">[</span>handler<span class="token operator">-></span>minor <span class="token operator">>></span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> handler<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>handler<span class="token operator">-></span>node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>input_handler_list<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">list_for_each_entry</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>input_dev_list<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token function">input_attach_handler</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">input_wakeup_procfs_readers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>无论先注册<code>input_register_handler</code>还是<code>input_register_device</code>，最终都调用<code>input_attach_handler(dev, handler);</code>。</p><h2 id="input-attach-handler-dev-handler"><a href="#input-attach-handler-dev-handler" class="headerlink" title="input_attach_handler(dev, handler)"></a>input_attach_handler(dev, handler)</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 流程</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">input_attach_handler</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">input_handler</span> <span class="token operator">*</span>handler<span class="token punctuation">)</span>id <span class="token operator">=</span> <span class="token function">input_match_device</span><span class="token punctuation">(</span>handler<span class="token operator">-></span>id_table<span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 根据handler的id_table和dev比较</span>error <span class="token operator">=</span> handler<span class="token operator">-></span><span class="token function">connect</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> dev<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果支持则handler->connect</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>注册<code>input_dev</code>或 <code>input_handler</code>时，会两两比较左边的<code>input_dev</code>和右边的<code>input_handler</code>，根据<code>input_handler</code>的<code>id_table</code>判断这个<code>input_handler</code>能否支持这个<code>input_dev</code>，如果能支持，则调用<code>input_handler</code>的<code>connect</code>函数建立“连接”。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">input_attach_handler</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">input_handler</span> <span class="token operator">*</span>handler<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">input_device_id</span> <span class="token operator">*</span>id<span class="token punctuation">;</span><span class="token keyword">int</span> error<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>handler<span class="token operator">-></span>blacklist <span class="token operator">&amp;&amp;</span> <span class="token function">input_match_device</span><span class="token punctuation">(</span>handler<span class="token operator">-></span>blacklist<span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>id <span class="token operator">=</span> <span class="token function">input_match_device</span><span class="token punctuation">(</span>handler<span class="token operator">-></span>id_table<span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>id<span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>error <span class="token operator">=</span> handler<span class="token operator">-></span><span class="token function">connect</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> dev<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">&amp;&amp;</span> error <span class="token operator">!=</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">)</span><span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR<span class="token string">"input: failed to attach handler %s to device %s, "</span><span class="token string">"error: %d\n"</span><span class="token punctuation">,</span>handler<span class="token operator">-></span>name<span class="token punctuation">,</span> <span class="token function">kobject_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-></span>cdev<span class="token punctuation">.</span>kobj<span class="token punctuation">)</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> error<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="以evdev-c为例-怎么建立连接，通过struct-input-handle-建立连接"><a href="#以evdev-c为例-怎么建立连接，通过struct-input-handle-建立连接" class="headerlink" title="以evdev.c为例 怎么建立连接，通过struct input_handle 建立连接"></a>以evdev.c为例 怎么建立连接，通过struct input_handle 建立连接</h2><ol><li><p>分配一个input_handle结构体</p></li><li><p>设置</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c">evdev<span class="token operator">-></span>handle<span class="token punctuation">.</span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span><span class="token comment">// 指向左边的input_dev</span>evdev<span class="token operator">-></span>handle<span class="token punctuation">.</span>handler <span class="token operator">=</span> handler<span class="token punctuation">;</span> <span class="token comment">// 指向右边的handler</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>注册</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>handle<span class="token operator">-></span>d_node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>handle<span class="token operator">-></span>dev<span class="token operator">-></span>h_list<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将handle加入到dev->h_list</span><span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>handle<span class="token operator">-></span>h_node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>handler<span class="token operator">-></span>h_list<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 将handle加入到handler->h_list</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c">流程：<span class="token keyword">int</span> <span class="token function">evdev_connect</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_handler</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">input_dev</span><span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">input_device_id</span><span class="token punctuation">)</span>evdev <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">evdev</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 分配一个evdev，evdev包含input_handle</span><span class="token comment">// 设置</span>evdev<span class="token operator">-></span>exist <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>evdev<span class="token operator">-></span>minor <span class="token operator">=</span> minor<span class="token punctuation">;</span>evdev<span class="token operator">-></span>handle<span class="token punctuation">.</span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span><span class="token comment">// 指向左边的input_dev</span>evdev<span class="token operator">-></span>handle<span class="token punctuation">.</span>name <span class="token operator">=</span> evdev<span class="token operator">-></span>name<span class="token punctuation">;</span> evdev<span class="token operator">-></span>handle<span class="token punctuation">.</span>handler <span class="token operator">=</span> handler<span class="token punctuation">;</span> <span class="token comment">// 指向右边的handler</span>evdev<span class="token operator">-></span>handle<span class="token punctuation">.</span>private <span class="token operator">=</span> evdev<span class="token punctuation">;</span><span class="token comment">// 注册</span>error <span class="token operator">=</span> <span class="token function">input_register_handle</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>evdev<span class="token operator">-></span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>handle<span class="token operator">-></span>d_node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>handle<span class="token operator">-></span>dev<span class="token operator">-></span>h_list<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将handle加入到dev->h_list</span><span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>handle<span class="token operator">-></span>h_node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>handler<span class="token operator">-></span>h_list<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 将handle加入到handler->h_list</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><p><strong>可以从输入设备的<code>h_list</code>找到<code>input_handle</code>找到<code>input_handler</code>；<br>同样从<code>input_handler</code>的<code>h_list</code>找到<code>input_handle</code>找到输入设备。</strong></p><h2 id="读取按键的数据-（可能休眠）"><a href="#读取按键的数据-（可能休眠）" class="headerlink" title="读取按键的数据 （可能休眠）"></a>读取按键的数据 （可能休眠）</h2><p>用户在<code>read</code>时候 会调用到具体的某个<code>handler</code>的<code>fops</code>的<code>read</code>，以 <code>evdev_read</code>为例，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 读取数据的操作</span><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">evdev_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>ppos<span class="token punctuation">)</span><span class="token comment">// 无数据并且非阻塞方式，则立即返回-EAGAIN，，client缓冲区头等于尾</span><span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token operator">-></span>head <span class="token operator">==</span> client<span class="token operator">-></span>tail <span class="token operator">&amp;&amp;</span> evdev<span class="token operator">-></span>exist <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>file<span class="token operator">-></span>f_flags <span class="token operator">&amp;</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token operator">-</span>EAGAIN<span class="token punctuation">;</span><span class="token comment">// 否则休眠</span>retval <span class="token operator">=</span> <span class="token function">wait_event_interruptible</span><span class="token punctuation">(</span>evdev<span class="token operator">-></span>wait<span class="token punctuation">,</span> client<span class="token operator">-></span>head <span class="token operator">!=</span> client<span class="token operator">-></span>tail <span class="token operator">||</span> <span class="token operator">!</span>evdev<span class="token operator">-></span>exist<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 唤醒操作在事件处理函数中</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">evdev_event</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_handle</span> <span class="token operator">*</span>handle<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token comment">// 唤醒</span><span class="token function">wake_up_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>evdev<span class="token operator">-></span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="evdev-event去唤醒"><a href="#evdev-event去唤醒" class="headerlink" title="evdev_event去唤醒"></a>evdev_event去唤醒</h3><p><code>evdev_event</code>事件处理函数在<code>input_handler</code>中，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">input_handler</span> evdev_handler <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>event <span class="token operator">=</span>evdev_event<span class="token punctuation">,</span><span class="token punctuation">.</span>connect <span class="token operator">=</span>evdev_connect<span class="token punctuation">,</span><span class="token punctuation">.</span>disconnect <span class="token operator">=</span>evdev_disconnect<span class="token punctuation">,</span><span class="token punctuation">.</span>fops <span class="token operator">=</span><span class="token operator">&amp;</span>evdev_fops<span class="token punctuation">,</span><span class="token punctuation">.</span>minor <span class="token operator">=</span>EVDEV_MINOR_BASE<span class="token punctuation">,</span><span class="token punctuation">.</span>name <span class="token operator">=</span><span class="token string">"evdev"</span><span class="token punctuation">,</span><span class="token punctuation">.</span>id_table <span class="token operator">=</span>evdev_ids<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>evdev_event</code>被硬件相关的代码调用。以这个看，<code>gpio_keys_isr</code>是一个例子，不对应实际硬件，在drivers\input\keyboard\gpio_keys.c中，<br><font color=red> <strong>在设备的终端服务程序中，<br>先确定事件是什么，<br>然后调用相应的<code>input_handler</code>的<code>event</code>函数上报事件。</strong></font> </p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token class-name">irqreturn_t</span> <span class="token function">gpio_keys_isr</span><span class="token punctuation">(</span><span class="token keyword">int</span> irq<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dev_id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">if</span> <span class="token punctuation">(</span>irq <span class="token operator">==</span> <span class="token function">gpio_to_irq</span><span class="token punctuation">(</span>gpio<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> type <span class="token operator">=</span> button<span class="token operator">-></span>type <span class="token operator">?</span><span class="token operator">:</span> EV_KEY<span class="token punctuation">;</span><span class="token keyword">int</span> state <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">gpio_get_value</span><span class="token punctuation">(</span>gpio<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">^</span> button<span class="token operator">-></span>active_low<span class="token punctuation">;</span><span class="token comment">// 上报事件</span><span class="token function">input_event</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> type<span class="token punctuation">,</span> button<span class="token operator">-></span>code<span class="token punctuation">,</span> <span class="token operator">!</span><span class="token operator">!</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">input_sync</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> IRQ_HANDLED<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="中断服务程序中的去调用input-event-上报事件-去-调用evdev-event"><a href="#中断服务程序中的去调用input-event-上报事件-去-调用evdev-event" class="headerlink" title="中断服务程序中的去调用input_event 上报事件 去 调用evdev_event"></a>中断服务程序中的去调用input_event 上报事件 去 调用evdev_event</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">input_event</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token comment">// 遍历设备链表</span><span class="token function">list_for_each_entry</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dev<span class="token operator">-></span>h_list<span class="token punctuation">,</span> d_node<span class="token punctuation">)</span><span class="token comment">// 对每个已经打开的设备 去调用它的event函数</span><span class="token keyword">if</span> <span class="token punctuation">(</span>handle<span class="token operator">-></span>open<span class="token punctuation">)</span>handle<span class="token operator">-></span>handler<span class="token operator">-></span><span class="token function">event</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> type<span class="token punctuation">,</span> code<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>写符合输入子系统框架的 驱动程序：</p><ol><li>分配一个input_dev结构体</li><li>设置</li><li>注册</li><li>硬件相关代码，如在中断服务程序中上报事件</li></ol><p><img src="/images/20200411223427262.png"></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS1期第9课 uboot 5 之uboot启动内核 tftp下载内核 写入nand</title>
      <link href="2021/05/14/wds1-qi-di-9-ke-uboot-5-zhi-uboot-qi-dong-nei-he-tftp-xia-zai-nei-he-xie-ru-nand-local/"/>
      <url>2021/05/14/wds1-qi-di-9-ke-uboot-5-zhi-uboot-qi-dong-nei-he-tftp-xia-zai-nei-he-xie-ru-nand-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]<br><img src="/images/20200627215806761.png"></p><p><code>bootcmd=nand read.jffs2 0x30007fc0 kernel;bootm 0x30007fc0</code></p><h1 id="1-nand-read-jffs2-0x30007fc0-kernel-读出内核到SDRAM"><a href="#1-nand-read-jffs2-0x30007fc0-kernel-读出内核到SDRAM" class="headerlink" title="1. nand read.jffs2 0x30007fc0 kernel 读出内核到SDRAM"></a>1. nand read.jffs2 0x30007fc0 kernel 读出内核到SDRAM</h1><p>&#8195;从kernel分区读出内核到SDRAM的0x30007fc0地址。<br>&#8195;<strong>分区</strong>，PC上每个==硬盘==的前面都有分区表，分区一般不变。嵌入式linux没有这样分区，只是在源码里写死，有boot/env/kernel/sysfile，这些分区的地址范围非常重要。在include/configs/100ask24x0.h中，<em>MTD(memory technology device内存技术设备)</em><br>bootloader 0~256k （从0开始）<br>params +128k 环境变量<br>kernel +2M 内核<br>root +剩余</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MTDPARTS_DEFAULT</span> <span class="token string">"mtdparts=nandflash0:256k@0(bootloader),"</span> <span class="token punctuation">\</span>                            <span class="token string">"128k(params),"</span> <span class="token punctuation">\</span>                            <span class="token string">"2m(kernel),"</span> <span class="token punctuation">\</span>                            <span class="token string">"-(root)"</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/images/20191204094010380.png">也就是说从nand的0x00060000地址往后读取0x00200000Byte的内核数据 到 SDRAM的0x30007fc0地址。<br>对于nand命令，在这里common/cmd_nand.c实现，.jffs2表示长度不需要页或块对齐，最终调用nand_read_opts读取nand，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">do_nand</span><span class="token punctuation">(</span><span class="token class-name">cmd_tbl_t</span> <span class="token operator">*</span> cmdtp<span class="token punctuation">,</span> <span class="token keyword">int</span> flag<span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"bad"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"erase"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>        <span class="token function">strncmp</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"dump"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>        <span class="token function">strncmp</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"read"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"write"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>        <span class="token function">strcmp</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"scrub"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"markbad"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>        <span class="token function">strcmp</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"biterr"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>        <span class="token function">strcmp</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"lock"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"unlock"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span>        <span class="token keyword">goto</span> usage<span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span>      <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">".jffs2"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">".e"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">".i"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>read<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token comment">/* read */</span>          <span class="token class-name">nand_read_options_t</span> opts<span class="token punctuation">;</span>          <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>opts<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          opts<span class="token punctuation">.</span>buffer <span class="token operator">=</span> <span class="token punctuation">(</span>u_char<span class="token operator">*</span><span class="token punctuation">)</span> addr<span class="token punctuation">;</span>          opts<span class="token punctuation">.</span>length <span class="token operator">=</span> size<span class="token punctuation">;</span>          opts<span class="token punctuation">.</span>offset <span class="token operator">=</span> off<span class="token punctuation">;</span>          opts<span class="token punctuation">.</span>quiet      <span class="token operator">=</span> quiet<span class="token punctuation">;</span>          ret <span class="token operator">=</span> <span class="token function">nand_read_opts</span><span class="token punctuation">(</span>nand<span class="token punctuation">,</span> <span class="token operator">&amp;</span>opts<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="2-bootm-0x30007fc0-启动内核"><a href="#2-bootm-0x30007fc0-启动内核" class="headerlink" title="2. bootm 0x30007fc0 启动内核"></a>2. bootm 0x30007fc0 启动内核</h1><h2 id="2-1-bootm-xxx读出头，根据头是否移动真内核到加载地址ih-load"><a href="#2-1-bootm-xxx读出头，根据头是否移动真内核到加载地址ih-load" class="headerlink" title="2.1 bootm xxx读出头，根据头是否移动真内核到加载地址ih_load"></a>2.1 bootm xxx读出头，根据头是否移动真内核到加载地址ih_load</h2><p>nand的kernel中存储内核的是uImage(头+真内核)，头在bootm的实现里边用到，common/cmd_bootm.c，找到image_header_t这个东西，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">do_bootm</span> <span class="token punctuation">(</span><span class="token class-name">cmd_tbl_t</span> <span class="token operator">*</span>cmdtp<span class="token punctuation">,</span> <span class="token keyword">int</span> flag<span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>ulongiflag<span class="token punctuation">;</span>ulongaddr<span class="token punctuation">;</span>ulongdata<span class="token punctuation">,</span> len<span class="token punctuation">,</span> checksum<span class="token punctuation">;</span>ulong  <span class="token operator">*</span>len_ptr<span class="token punctuation">;</span>uintunc_len <span class="token operator">=</span> CFG_BOOTM_LEN<span class="token punctuation">;</span><span class="token keyword">int</span>i<span class="token punctuation">,</span> verify<span class="token punctuation">;</span><span class="token keyword">char</span><span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token operator">*</span>s<span class="token punctuation">;</span><span class="token keyword">int</span><span class="token punctuation">(</span><span class="token operator">*</span>appl<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">image_header_t</span> <span class="token operator">*</span>hdr <span class="token operator">=</span> <span class="token operator">&amp;</span>header<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>头（64Byte）的格式为一个结构体，在include/image.h中，关注ih_load和ih_ep，<br>ih_load表示内核加载的地址，运行内核时放在哪里；ih_ep内核运行入口地址。讲道理内核可以放到SDRAM的任何地方（但要保证不破坏内存顶部数据），</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">image_header</span> <span class="token punctuation">&#123;</span><span class="token class-name">uint32_t</span>ih_magic<span class="token punctuation">;</span><span class="token comment">/* Image Header Magic Number*/</span><span class="token class-name">uint32_t</span>ih_hcrc<span class="token punctuation">;</span><span class="token comment">/* Image Header CRC Checksum*/</span><span class="token class-name">uint32_t</span>ih_time<span class="token punctuation">;</span><span class="token comment">/* Image Creation Timestamp*/</span><span class="token class-name">uint32_t</span>ih_size<span class="token punctuation">;</span><span class="token comment">/* Image Data Size*/</span><span class="token class-name">uint32_t</span>ih_load<span class="token punctuation">;</span><span class="token comment">/* Data Load  Address*/</span><span class="token class-name">uint32_t</span>ih_ep<span class="token punctuation">;</span><span class="token comment">/* Entry Point Address*/</span><span class="token class-name">uint32_t</span>ih_dcrc<span class="token punctuation">;</span><span class="token comment">/* Image Data CRC Checksum*/</span><span class="token class-name">uint8_t</span>ih_os<span class="token punctuation">;</span><span class="token comment">/* Operating System*/</span><span class="token class-name">uint8_t</span>ih_arch<span class="token punctuation">;</span><span class="token comment">/* CPU architecture*/</span><span class="token class-name">uint8_t</span>ih_type<span class="token punctuation">;</span><span class="token comment">/* Image Type*/</span><span class="token class-name">uint8_t</span>ih_comp<span class="token punctuation">;</span><span class="token comment">/* Compression Type*/</span><span class="token class-name">uint8_t</span>ih_name<span class="token punctuation">[</span>IH_NMLEN<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">/* Image Name*/</span><span class="token punctuation">&#125;</span> <span class="token class-name">image_header_t</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/images/20191204102335302.png">因为有ih_ep和ih_load可以保证内核正常启动。但为什么是0x30007FC0？<br><strong>原因</strong>：<br>&#8195;从flash读到的是uImage，放到SDRAM中的xxx去，bootm xxx从内存的那个地方启动内核，当读到==头==的时候可以获取到ih_ep和ih_load，若真内核不在ih_load，则将真内核移到ih_load，然后跳到ih_ep执行真内核。<br>&#8195;在common/cmd_bootm.c中，首先读出头部，然后校验，根据头部移动真内核<code>data</code>到中去ih_load，若内核刚好就在ih_load这个地方，可以节省时间。对于2440开发板ih_load为0x30008000(真内核在这里)，头部64Byte。从这里0x30007FC0启动uImage。加载64Byte的头，然后刚好到0x30008000运行真内核，省去移动真内核的时间。<br>0x30007FC0 + 64Byte = 0x30008000</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">memmove</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>header<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">image_header_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>checksum <span class="token operator">=</span> <span class="token function">ntohl</span><span class="token punctuation">(</span>hdr<span class="token operator">-></span>ih_hcrc<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">memmove</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">ntohl</span><span class="token punctuation">(</span>hdr<span class="token operator">-></span>ih_load<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>uchar <span class="token operator">*</span><span class="token punctuation">)</span>data<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果真内核加载地址ih_load和真内核data相等，则不移动，不等则要搬移到ih_load，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">switch</span> <span class="token punctuation">(</span>hdr<span class="token operator">-></span>ih_comp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">case</span> IH_COMP_NONE<span class="token operator">:</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">ntohl</span><span class="token punctuation">(</span>hdr<span class="token operator">-></span>ih_load<span class="token punctuation">)</span> <span class="token operator">==</span> data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"   XIP %s ... "</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_HW_WATCHDOG<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_WATCHDOG<span class="token punctuation">)</span></span></span><span class="token class-name">size_t</span> l <span class="token operator">=</span> len<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span>to <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">ntohl</span><span class="token punctuation">(</span>hdr<span class="token operator">-></span>ih_load<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span>from <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>data<span class="token punctuation">;</span><span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"   Loading %s ... "</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>l <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">size_t</span> tail <span class="token operator">=</span> <span class="token punctuation">(</span>l <span class="token operator">></span> CHUNKSZ<span class="token punctuation">)</span> <span class="token operator">?</span> CHUNKSZ <span class="token operator">:</span> l<span class="token punctuation">;</span><span class="token function">WATCHDOG_RESET</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">memmove</span> <span class="token punctuation">(</span>to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> tail<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-2-从ih-load启动真内核"><a href="#2-2-从ih-load启动真内核" class="headerlink" title="2.2 从ih_load启动真内核"></a>2.2 从ih_load启动真内核</h2><p>在common/cmd_bootm.c中，do_bootm_linux函数用于启动真内核，首先由uboot传入参数，然后跳到in_ep启动真内核。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">do_bootm_linux</span>  <span class="token punctuation">(</span>cmdtp<span class="token punctuation">,</span> flag<span class="token punctuation">,</span> argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span>   addr<span class="token punctuation">,</span> len_ptr<span class="token punctuation">,</span> verify<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>do_bootm_linux的实现在lib_arm/armlinux.c中，传递参数，启动真内核theKernel(函数指针)，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span> <span class="token punctuation">(</span>CONFIG_SETUP_MEMORY_TAGS<span class="token punctuation">)</span> <span class="token operator">||</span> </span><span class="token punctuation">\</span>    <span class="token expression"><span class="token function">defined</span> <span class="token punctuation">(</span>CONFIG_CMDLINE_TAG<span class="token punctuation">)</span> <span class="token operator">||</span> </span><span class="token punctuation">\</span>    <span class="token expression"><span class="token function">defined</span> <span class="token punctuation">(</span>CONFIG_INITRD_TAG<span class="token punctuation">)</span> <span class="token operator">||</span> </span><span class="token punctuation">\</span>    <span class="token expression"><span class="token function">defined</span> <span class="token punctuation">(</span>CONFIG_SERIAL_TAG<span class="token punctuation">)</span> <span class="token operator">||</span> </span><span class="token punctuation">\</span>    <span class="token expression"><span class="token function">defined</span> <span class="token punctuation">(</span>CONFIG_REVISION_TAG<span class="token punctuation">)</span> <span class="token operator">||</span> </span><span class="token punctuation">\</span>    <span class="token expression"><span class="token function">defined</span> <span class="token punctuation">(</span>CONFIG_LCD<span class="token punctuation">)</span> <span class="token operator">||</span> </span><span class="token punctuation">\</span>    <span class="token expression"><span class="token function">defined</span> <span class="token punctuation">(</span>CONFIG_VFD<span class="token punctuation">)</span></span></span><span class="token function">setup_start_tag</span> <span class="token punctuation">(</span>bd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">theKernel</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> bd<span class="token operator">-></span>bi_arch_number<span class="token punctuation">,</span> bd<span class="token operator">-></span>bi_boot_params<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>分析theKernel，theKernel等于入口地址，然后执行theKernel启动真内核，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">theKernel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> uint<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token function">ntohl</span><span class="token punctuation">(</span>hdr<span class="token operator">-></span>ih_ep<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">theKernel</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> bd<span class="token operator">-></span>bi_arch_number<span class="token punctuation">,</span> bd<span class="token operator">-></span>bi_boot_params<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="2-2-1-传递参数，在某个地址按照某格式写入参数"><a href="#2-2-1-传递参数，在某个地址按照某格式写入参数" class="headerlink" title="2.2.1 传递参数，在某个地址按照某格式写入参数"></a>2.2.1 传递参数，在某个地址按照某格式写入参数</h3><p>地址：0x30000100 2440开发板<br>格式称：tag</p><p>设置参数到内存，格式在函数内实现，lib_arm/armlinux.c中，<br>setup_start_tag (bd);<br>setup_memory_tags (bd);<br>setup_commandline_tag (bd, commandline);<br>etup_end_tag (bd);</p><p>如setup_start_tag，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setup_start_tag</span> <span class="token punctuation">(</span><span class="token class-name">bd_t</span> <span class="token operator">*</span>bd<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>params <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tag</span> <span class="token operator">*</span><span class="token punctuation">)</span> bd<span class="token operator">-></span>bi_boot_params<span class="token punctuation">;</span>params<span class="token operator">-></span>hdr<span class="token punctuation">.</span>tag <span class="token operator">=</span> ATAG_CORE<span class="token punctuation">;</span>params<span class="token operator">-></span>hdr<span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token function">tag_size</span> <span class="token punctuation">(</span>tag_core<span class="token punctuation">)</span><span class="token punctuation">;</span>params<span class="token operator">-></span>u<span class="token punctuation">.</span>core<span class="token punctuation">.</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>params<span class="token operator">-></span>u<span class="token punctuation">.</span>core<span class="token punctuation">.</span>pagesize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>params<span class="token operator">-></span>u<span class="token punctuation">.</span>core<span class="token punctuation">.</span>rootdev <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>params <span class="token operator">=</span> <span class="token function">tag_next</span> <span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-2-2-根据参数启动真内核"><a href="#2-2-2-根据参数启动真内核" class="headerlink" title="2.2.2 根据参数启动真内核"></a>2.2.2 根据参数启动真内核</h3><p>内核可能支持很多单板，根据机器id来判断，第二个参数为机器id，第三个参数传入启动参数所在的地址，</p><pre class="line-numbers language-none"><code class="language-none">theKernel (0, bd-&gt;bi_arch_number, bd-&gt;bi_boot_params);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>第二个参数在board/100ask24x0/100ask24x0.c中设置的，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">else</span><span class="token punctuation">&#123;</span>    <span class="token comment">/* arch number of SMDK2440-Board */</span>    gd<span class="token operator">-></span>bd<span class="token operator">-></span>bi_arch_number <span class="token operator">=</span> MACH_TYPE_S3C2440<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="tftp下载内核-写入nand"><a href="#tftp下载内核-写入nand" class="headerlink" title="tftp下载内核 写入nand"></a>tftp下载内核 写入nand</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">tftp <span class="token number">30000000</span> uImage <span class="token comment"># uImage在tftp的目录下，直接下载就行</span>nand erase <span class="token number">60000</span> <span class="token number">400000</span> <span class="token comment"># offset size</span>nand <span class="token function">write</span> <span class="token number">30000000</span> <span class="token number">60000</span> <span class="token number">400000</span> <span class="token comment"># ram offset size</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="/images/20200628104056672.png"></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS1期第9课 uboot 4 之uboot命令分析</title>
      <link href="2021/05/14/wds1-qi-di-9-ke-uboot-4-zhi-uboot-ming-ling-fen-xi-local/"/>
      <url>2021/05/14/wds1-qi-di-9-ke-uboot-4-zhi-uboot-ming-ling-fen-xi-local/</url>
      
        <content type="html"><![CDATA[<p><img src="/images/20200627215806761.png"></p><p>根据命令找到对应的函数<br>命令结构体</p><p>分离开命令，命令中有 ; 等，还是在common/main.c中，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* * Find separator, or string end * Allow simple escape of ';' by writing "\;" */</span><span class="token keyword">for</span> <span class="token punctuation">(</span>inquotes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> sep <span class="token operator">=</span> str<span class="token punctuation">;</span> <span class="token operator">*</span>sep<span class="token punctuation">;</span> sep<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>sep<span class="token operator">==</span><span class="token string">'\''</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>    <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>sep<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">'\\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>inquotes<span class="token operator">=</span><span class="token operator">!</span>inquotes<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inquotes <span class="token operator">&amp;&amp;</span>    <span class="token punctuation">(</span><span class="token operator">*</span>sep <span class="token operator">==</span> <span class="token string">';'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span><span class="token comment">/* separator*/</span>    <span class="token punctuation">(</span> sep <span class="token operator">!=</span> str<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span><span class="token comment">/* past string start*/</span>    <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>sep<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">'\\'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">/* and NOT escaped*/</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/* * Limit the token to data between separators */</span>token <span class="token operator">=</span> str<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>sep<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>str <span class="token operator">=</span> sep <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">/* start of command for next pass */</span><span class="token operator">*</span>sep <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span>str <span class="token operator">=</span> sep<span class="token punctuation">;</span><span class="token comment">/* no more commands for next pass */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>处理一些宏，如通过网卡下载文件时产生的宏，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* find macros in this tokenand replace them */</span><span class="token function">process_macros</span> <span class="token punctuation">(</span>token<span class="token punctuation">,</span> finaltoken<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>提取命令和参数，argv[0]（命令）, argv[1]（参数）等等</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Extract arguments */</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>argc <span class="token operator">=</span> <span class="token function">parse_line</span> <span class="token punctuation">(</span>finaltoken<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>rc <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">/* no command at all */</span><span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查找命令</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Look up command in command table */</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cmdtp <span class="token operator">=</span> <span class="token function">find_cmd</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"Unknown command '%s' - try 'help'\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>rc <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">/* give up after bad command */</span><span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>命令结构体cmd_tbl_s，在include/command.h中，命令名字，参数，是否可重复（回车就可以再次执行），函数指针执行命令，短（help）长（help print）帮助信息，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* * Monitor Command Table */</span><span class="token keyword">struct</span> <span class="token class-name">cmd_tbl_s</span> <span class="token punctuation">&#123;</span><span class="token keyword">char</span><span class="token operator">*</span>name<span class="token punctuation">;</span><span class="token comment">/* Command Name*/</span><span class="token keyword">int</span>maxargs<span class="token punctuation">;</span><span class="token comment">/* maximum number of arguments*/</span><span class="token keyword">int</span>repeatable<span class="token punctuation">;</span><span class="token comment">/* autorepeat allowed?*/</span><span class="token comment">/* Implementation function*/</span><span class="token keyword">int</span><span class="token punctuation">(</span><span class="token operator">*</span>cmd<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">cmd_tbl_s</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">char</span><span class="token operator">*</span>usage<span class="token punctuation">;</span><span class="token comment">/* Usage message(short)*/</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span><span class="token expression">CFG_LONGHELP</span></span><span class="token keyword">char</span><span class="token operator">*</span>help<span class="token punctuation">;</span><span class="token comment">/* Help  message(long)*/</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_AUTO_COMPLETE</span></span><span class="token comment">/* do auto completion on the arguments */</span><span class="token keyword">int</span><span class="token punctuation">(</span><span class="token operator">*</span>complete<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> last_char<span class="token punctuation">,</span> <span class="token keyword">int</span> maxv<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>cmdv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查找命令find_cmd，在common/command.c中，for循环依次在__u_boot_cmd_start～__u_boot_cmd_end中查找，查找到了返回结构体，没有则继续往下查找，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span>cmdtp <span class="token operator">=</span> <span class="token operator">&amp;</span>__u_boot_cmd_start<span class="token punctuation">;</span>     cmdtp <span class="token operator">!=</span> <span class="token operator">&amp;</span>__u_boot_cmd_end<span class="token punctuation">;</span>     cmdtp<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> cmdtp<span class="token operator">-></span>name<span class="token punctuation">,</span> len<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token function">strlen</span> <span class="token punctuation">(</span>cmdtp<span class="token operator">-></span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span> cmdtp<span class="token punctuation">;</span><span class="token comment">/* full match */</span>cmdtp_temp <span class="token operator">=</span> cmdtp<span class="token punctuation">;</span><span class="token comment">/* abbreviated command ? */</span>n_found<span class="token operator">++</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>__u_boot_cmd_start～__u_boot_cmd_end这俩东西在代码中找不到，但可以通过链接脚本（board/100ask24x0/u-boot.lds）传入，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">.</span> <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">;</span>__u_boot_cmd_start <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">;</span><span class="token punctuation">.</span>u_boot_cmd <span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">.</span>u_boot_cmd<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>__u_boot_cmd_end <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>想查看究竟这俩中间放了些什么命令，需要在include/command.h中找到u_boot_cmd的定义</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Struct_Section</span>  <span class="token expression"><span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>unused<span class="token punctuation">,</span><span class="token function">section</span> <span class="token punctuation">(</span></span><span class="token string">".u_boot_cmd"</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>假设命令为<code>bootcmd nand read 0x30007fc0 kernel;bootm 0x30007fc0</code><br>以bootm命令为例，找到这个宏U_BOOT_CMD，在common/cmd_bootm.c中，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">U_BOOT_CMD</span><span class="token punctuation">(</span> bootm<span class="token punctuation">,</span>CFG_MAXARGS<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>do_bootm<span class="token punctuation">,</span> <span class="token string">"bootm   - boot application image from memory\n"</span><span class="token punctuation">,</span> <span class="token string">"[addr [arg ...]]\n    - boot application image stored in memory\n"</span> <span class="token string">"\tpassing arguments 'arg ...'; when booting a Linux kernel,\n"</span> <span class="token string">"\t'arg' can be the address of an initrd image\n"</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_OF_FLAT_TREE</span></span><span class="token string">"\tWhen booting a Linux kernel which requires a flat device-tree\n"</span><span class="token string">"\ta third argument is required which is the address of the of the\n"</span><span class="token string">"\tdevice-tree blob. To boot that kernel without an initrd image,\n"</span><span class="token string">"\tuse a '-' for the second argument. If you do not pass a third\n"</span><span class="token string">"\ta bd_info struct will be passed instead\n"</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>定义之处还是在include/command.h中，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">U_BOOT_CMD</span><span class="token expression"><span class="token punctuation">(</span>name<span class="token punctuation">,</span>maxargs<span class="token punctuation">,</span>rep<span class="token punctuation">,</span>cmd<span class="token punctuation">,</span>usage<span class="token punctuation">,</span>help<span class="token punctuation">)</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token class-name">cmd_tbl_t</span> __u_boot_cmd_</span><span class="token punctuation">##</span><span class="token expression">name Struct_Section <span class="token operator">=</span> <span class="token punctuation">&#123;</span>#name<span class="token punctuation">,</span> maxargs<span class="token punctuation">,</span> rep<span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> usage<span class="token punctuation">,</span> help<span class="token punctuation">&#125;</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>展开如下，cmd_tbl_t为结构体类型，Struct_Section为前面的定义的宏__attribute__ ((unused,section (“.u_boot_cmd”)))。定义一个结构体变量__u_boot_cmd_bootm，其有段属性被强制设置为”.u_boot_cmd”，这个东西在lds中。<br>#name, maxargs, rep, cmd, usage, help分别在这个宏U_BOOT_CMD中对应，usage和help为字符串，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">cmd_tbl_t</span> __u_boot_cmd_bootm <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>unused<span class="token punctuation">,</span><span class="token function">section</span> <span class="token punctuation">(</span><span class="token string">".u_boot_cmd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"bootm"</span><span class="token punctuation">,</span> CFG_MAXARGS<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> do_bootm<span class="token punctuation">,</span> 小help<span class="token punctuation">,</span> 大help<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>===最后：在代码段用U_BOOT_CMD表示的东西最终被解析成</strong></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">cmd_tbl_t</span> __u_boot_cmd_bootm <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>unused<span class="token punctuation">,</span><span class="token function">section</span> <span class="token punctuation">(</span><span class="token string">".u_boot_cmd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"bootm"</span><span class="token punctuation">,</span> CFG_MAXARGS<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> do_bootm<span class="token punctuation">,</span> 小help<span class="token punctuation">,</span> 大help<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>这就相当于定义了一个结构体，这个结构体有个属性强制把他的段指定成”.u_boot_cmd”，所以所有的命令都会被集中到lds中的<code>    .u_boot_cmd : &#123; *(.u_boot_cmd) &#125;</code>这里。=====</strong></p><h3 id="在uboot中增加一个自定义命令"><a href="#在uboot中增加一个自定义命令" class="headerlink" title="在uboot中增加一个自定义命令"></a>在uboot中增加一个自定义命令</h3><p>uboot命令都放在common/下吧，<br>命名为cmd_my_hello.c,</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;common.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;watchdog.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;command.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;image.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;malloc.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;zlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;bzlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;environment.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/byteorder.h></span></span><span class="token keyword">int</span> <span class="token function">do_my_hello</span> <span class="token punctuation">(</span><span class="token class-name">cmd_tbl_t</span> <span class="token operator">*</span>cmdtp<span class="token punctuation">,</span> <span class="token keyword">int</span> flag<span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"my_hello add uboot cmd\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>argc<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"argv[%d]: %s\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">U_BOOT_CMD</span><span class="token punctuation">(</span> my_hello<span class="token punctuation">,</span>CFG_MAXARGS<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>do_my_hello<span class="token punctuation">,</span> <span class="token string">"my_hello short help, just for test.\n"</span><span class="token punctuation">,</span> <span class="token string">"my_hello, long help\n"</span> <span class="token string">"\tmy_hello, long help1....\n"</span> <span class="token string">"\tmy_hello, long help2....\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改common/Makefile, 只需要添加就是了，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">s_record<span class="token punctuation">.</span>o serial<span class="token punctuation">.</span>o soft_i2c<span class="token punctuation">.</span>o soft_spi<span class="token punctuation">.</span>o spartan2<span class="token punctuation">.</span>o spartan3<span class="token punctuation">.</span>o \usb<span class="token punctuation">.</span>o usb_kbd<span class="token punctuation">.</span>o usb_storage<span class="token punctuation">.</span>o \virtex2<span class="token punctuation">.</span>o xilinx<span class="token punctuation">.</span>o crc16<span class="token punctuation">.</span>o xyzModem<span class="token punctuation">.</span>o cmd_mac<span class="token punctuation">.</span>o cmd_suspend<span class="token punctuation">.</span>o \cmd_my_hello<span class="token punctuation">.</span>o  # 自定义uboot命令<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>重新编译uboot，cd到uboot根目录，make。</p><p>根目录下生成的u-boot.bin烧写到开发板就ok了。</p><p>检查是否添加，命令成功，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">OpenJTAG<span class="token operator">></span> help <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/images/20191203233816101.png"></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">OpenJTAG<span class="token operator">></span> help my_hello   <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/images/20191203233953966.png"></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">OpenJTAG<span class="token operator">></span> my_hello <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/images/20191203233926534.png"></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS1期第9课 uboot 3 之Makefile, uboot启动第二段</title>
      <link href="2021/05/14/wds1-qi-di-9-ke-uboot-3-zhi-makefile-uboot-qi-dong-di-er-duan-local/"/>
      <url>2021/05/14/wds1-qi-di-9-ke-uboot-3-zhi-makefile-uboot-qi-dong-di-er-duan-local/</url>
      
        <content type="html"><![CDATA[<p><img src="/images/20200627215806761.png"></p><p>uboot的目标是启动内核，从flash读出内核然后启动。<br>在start.S中start_armboot开始：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">ldrpc<span class="token punctuation">,</span> _start_armboot_start_armboot<span class="token operator">:</span><span class="token punctuation">.</span>word start_armboot<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>在lib_arm/board.c中定义：<br>gd是结构体指针，申请得到部分内存，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">start_armboot</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">/* Pointer is writable since we allocated a register for it */</span>gd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">gd_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_armboot_start <span class="token operator">-</span> CFG_MALLOC_LEN <span class="token operator">-</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">gd_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">for</span> <span class="token punctuation">(</span>init_fnc_ptr <span class="token operator">=</span> init_sequence<span class="token punctuation">;</span> <span class="token operator">*</span>init_fnc_ptr<span class="token punctuation">;</span> <span class="token operator">++</span>init_fnc_ptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>init_fnc_ptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">hang</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>init_sequence是函数指针数组的首地址，在lib_arm/board.c中，其中包含了cpu等初始化函数的指针，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">init_fnc_t</span> <span class="token operator">*</span>init_sequence<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>cpu_init<span class="token punctuation">,</span><span class="token comment">/* basic cpu dependent setup */</span>board_init<span class="token punctuation">,</span><span class="token comment">/* basic board dependent setup */</span>interrupt_init<span class="token punctuation">,</span><span class="token comment">/* set up exceptions */</span>env_init<span class="token punctuation">,</span><span class="token comment">/* initialize environment */</span>init_baudrate<span class="token punctuation">,</span><span class="token comment">/* initialze baudrate settings */</span>serial_init<span class="token punctuation">,</span><span class="token comment">/* serial communications setup */</span>console_init_f<span class="token punctuation">,</span><span class="token comment">/* stage 1 init of console */</span>display_banner<span class="token punctuation">,</span><span class="token comment">/* say that we are here */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_DISPLAY_CPUINFO<span class="token punctuation">)</span></span></span>print_cpuinfo<span class="token punctuation">,</span><span class="token comment">/* display cpu info (and speed) */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_DISPLAY_BOARDINFO<span class="token punctuation">)</span></span></span>checkboard<span class="token punctuation">,</span><span class="token comment">/* display board info */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>dram_init<span class="token punctuation">,</span><span class="token comment">/* configure available RAM banks */</span>display_dram_config<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>看board_init定义，在board/100ask24x0/100ask24x0.c中，设置管脚，gd指向那个128字节的内存，bi_arch_number叫机器id，bi_boot_params启动内核的时候传入的一些参数所存放的位置，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">board_init</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    S3C24X0_CLOCK_POWER <span class="token operator">*</span> <span class="token keyword">const</span> clk_power <span class="token operator">=</span> <span class="token function">S3C24X0_GetBase_CLOCK_POWER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    S3C24X0_GPIO <span class="token operator">*</span> <span class="token keyword">const</span> gpio <span class="token operator">=</span> <span class="token function">S3C24X0_GetBase_GPIO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* set up the I/O ports */</span>    gpio<span class="token operator">-></span>GPACON <span class="token operator">=</span> <span class="token number">0x007FFFFF</span><span class="token punctuation">;</span>    gpio<span class="token operator">-></span>GPBCON <span class="token operator">=</span> <span class="token number">0x00044555</span><span class="token punctuation">;</span>    gpio<span class="token operator">-></span>GPBUP <span class="token operator">=</span> <span class="token number">0x000007FF</span><span class="token punctuation">;</span>    gpio<span class="token operator">-></span>GPCCON <span class="token operator">=</span> <span class="token number">0xAAAAAAAA</span><span class="token punctuation">;</span>    gpio<span class="token operator">-></span>GPCUP <span class="token operator">=</span> <span class="token number">0x0000FFFF</span><span class="token punctuation">;</span>    gpio<span class="token operator">-></span>GPDCON <span class="token operator">=</span> <span class="token number">0xAAAAAAAA</span><span class="token punctuation">;</span>    gpio<span class="token operator">-></span>GPDUP <span class="token operator">=</span> <span class="token number">0x0000FFFF</span><span class="token punctuation">;</span>    gpio<span class="token operator">-></span>GPECON <span class="token operator">=</span> <span class="token number">0xAAAAAAAA</span><span class="token punctuation">;</span>    gpio<span class="token operator">-></span>GPEUP <span class="token operator">=</span> <span class="token number">0x0000FFFF</span><span class="token punctuation">;</span>    gpio<span class="token operator">-></span>GPFCON <span class="token operator">=</span> <span class="token number">0x000055AA</span><span class="token punctuation">;</span>    gpio<span class="token operator">-></span>GPFUP <span class="token operator">=</span> <span class="token number">0x000000FF</span><span class="token punctuation">;</span>    gpio<span class="token operator">-></span>GPGCON <span class="token operator">=</span> <span class="token number">0xFF95FFBA</span><span class="token punctuation">;</span>    gpio<span class="token operator">-></span>GPGUP <span class="token operator">=</span> <span class="token number">0x0000FFFF</span><span class="token punctuation">;</span>    gpio<span class="token operator">-></span>GPHCON <span class="token operator">=</span> <span class="token number">0x002AFAAA</span><span class="token punctuation">;</span>    gpio<span class="token operator">-></span>GPHUP <span class="token operator">=</span> <span class="token number">0x000007FF</span><span class="token punctuation">;</span>    <span class="token comment">/* support both of S3C2410 and S3C2440, by www.100ask.net */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>isS3C2410<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">/* arch number of SMDK2410-Board */</span>        gd<span class="token operator">-></span>bd<span class="token operator">-></span>bi_arch_number <span class="token operator">=</span> MACH_TYPE_SMDK2410<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">/* arch number of SMDK2440-Board */</span>        gd<span class="token operator">-></span>bd<span class="token operator">-></span>bi_arch_number <span class="token operator">=</span> MACH_TYPE_S3C2440<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/* adress of boot parameters */</span>    gd<span class="token operator">-></span>bd<span class="token operator">-></span>bi_boot_params <span class="token operator">=</span> <span class="token number">0x30000100</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>    <span class="token function">icache_enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">dcache_enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>既然要从flash中读数据，那么flash一定有读功能的实现，初始化flash</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">CFG_NO_FLASH</span></span><span class="token comment">/* configure available FLASH banks */</span>size <span class="token operator">=</span> <span class="token function">flash_init</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>以下是对堆的一些初始化 192K空间，实现了堆的分配和释放，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* armboot_start is defined in the board-specific linker script */</span><span class="token function">mem_malloc_init</span> <span class="token punctuation">(</span>_armboot_start <span class="token operator">-</span> CFG_MALLOC_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>nand_init</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>CONFIG_COMMANDS <span class="token operator">&amp;</span> CFG_CMD_NAND<span class="token punctuation">)</span></span></span><span class="token function">puts</span> <span class="token punctuation">(</span><span class="token string">"NAND:  "</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">nand_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* go init the NAND */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>一些环境变量的初始化，上电后去flash中找有没有环境变量，没有就使用默认的，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* initialize environment */</span><span class="token function">env_relocate</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>往下网卡，设备，usb，调试，如果用调试器下载PreLoadedONRAM将被置1</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">Port_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>PreLoadedONRAM<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">/* enable exceptions */</span><span class="token function">enable_interrupts</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* add by www.100ask.net */</span>    <span class="token function">usb_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>到此只是flash拥有了读写的功能，但是怎么读怎么启动内核还需要分析，这里是死循环，应该是uboot启动打印的那个循环信息，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* main_loop() can return to retry autoboot, if so just run it again. */</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">main_loop</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>在start_armboot中完成了nand nor的初始化。<br>main_loop在common/main.c中，环境变量通过getenv来获取得到，bootdelay,bootcmd。根据bootcmd  run_command启动内核，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_BOOTDELAY<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>CONFIG_BOOTDELAY <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>s <span class="token operator">=</span> <span class="token function">getenv</span> <span class="token punctuation">(</span><span class="token string">"bootdelay"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>bootdelay <span class="token operator">=</span> s <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">simple_strtol</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">:</span> CONFIG_BOOTDELAY<span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token function">getenv</span> <span class="token punctuation">(</span><span class="token string">"bootcmd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">debug</span> <span class="token punctuation">(</span><span class="token string">"### main_loop: bootcmd=\"%s\"\n"</span><span class="token punctuation">,</span> s <span class="token operator">?</span> s <span class="token operator">:</span> <span class="token string">"&lt;UNDEFINED>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bootdelay <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> s <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">abortboot</span> <span class="token punctuation">(</span>bootdelay<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_AUTOBOOT_KEYED</span></span><span class="token keyword">int</span> prev <span class="token operator">=</span> <span class="token function">disable_ctrlc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* disable Control C checking */</span><span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">endif</span></span><span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">ifndef</span> <span class="token expression">CFG_HUSH_PARSER</span></span>        <span class="token punctuation">&#123;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Booting Linux ...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token function">run_command</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>bootcmd指定了从nand的kernel分区读取到SDRAM，然后从SDRAM启动，<br><img src="/images/20191203205830288.png">在uboot倒计时结束前空格，进入menu，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">eth_init</span><span class="token punctuation">(</span>gd<span class="token operator">-></span>bd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">run_command</span><span class="token punctuation">(</span><span class="token string">"menu"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>在这里readline读取串口交互的输入，根据输入的参数去启动系统run_command，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_BOOT_RETRY_TIME</span></span><span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">/* Saw enough of a valid command to * restart the timeout. */</span><span class="token function">reset_cmd_timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>len <span class="token operator">=</span> <span class="token function">readline</span> <span class="token punctuation">(</span>CFG_PROMPT<span class="token punctuation">)</span><span class="token punctuation">;</span>flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">/* assume no special flags for now */</span><span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token function">strcpy</span> <span class="token punctuation">(</span>lastcommand<span class="token punctuation">,</span> console_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>flag <span class="token operator">|=</span> CMD_FLAG_REPEAT<span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_BOOT_RETRY_TIME</span></span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">/* -2 means timed out, retry autoboot */</span><span class="token function">puts</span> <span class="token punctuation">(</span><span class="token string">"\nTimed out waiting for command\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_RESET_TO_RETRY</span></span><span class="token comment">/* Reinit board to run initialization code again */</span><span class="token function">do_reset</span> <span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">else</span></span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token comment">/* retry autoboot */</span><span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">endif</span></span><span class="token punctuation">&#125;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token function">puts</span> <span class="token punctuation">(</span><span class="token string">"&lt;INTERRUPT>\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">else</span>rc <span class="token operator">=</span> <span class="token function">run_command</span> <span class="token punctuation">(</span>lastcommand<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">/* invalid command or not repeatable, forget it */</span>lastcommand<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/*CFG_HUSH_PARSER*/</span></span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在start.S中start_armboot开始，start_armboot在lib_arm/board.c中定义。<br>在start_armboot中，有各种初始化操作init_sequenceboard，其中的某些会调用/100ask24x0/100ask24x0.c的board_init等等。完成一些外设的初始化工作。</p><p>到这里uboot运行起来了，一些外设也运行起来了，马上就是串口交互界面，这个交互界面在main_loop函数中实现，main_loop在common/main.c中。<br>交互界面中主要通过getenv获取flash保存的环境变量，通过readline获取串口的输入，最终都是通过传递参数给run_command来启动内核的。</p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS1期第9课 uboot 2 之Makefile, uboot启动第一段</title>
      <link href="2021/05/14/wds1-qi-di-9-ke-uboot-2-zhi-makefile-uboot-qi-dong-di-yi-duan-local/"/>
      <url>2021/05/14/wds1-qi-di-9-ke-uboot-2-zhi-makefile-uboot-qi-dong-di-yi-duan-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]<br><img src="/images/20200627215806761.png"></p><h2 id="之前的裸机程序，上电需要做的事情在-S里边，大致步骤："><a href="#之前的裸机程序，上电需要做的事情在-S里边，大致步骤：" class="headerlink" title="之前的裸机程序，上电需要做的事情在.S里边，大致步骤："></a>之前的裸机程序，上电需要做的事情在<code>.S</code>里边，大致步骤：</h2><ol><li>初始化<br>关看门狗<br>初始化时钟<br>初始化SDRAM</li><li>把程序从nand拷贝到SDRAM</li><li>设置sp（使sp指向main所在内存）<h2 id="uboot程序上电需要做的事情分为两段，第一段主要是底层的硬件初始化："><a href="#uboot程序上电需要做的事情分为两段，第一段主要是底层的硬件初始化：" class="headerlink" title="uboot程序上电需要做的事情分为两段，第一段主要是底层的硬件初始化："></a>uboot程序上电需要做的事情分为两段，第一段主要是底层的硬件初始化：</h2></li><li>设为管理模式</li><li>关闭看门狗</li><li>屏蔽中断</li><li>初始化SDRAM（需要配置存储管理器等）</li><li>设置栈</li><li>时钟</li><li>重定位（代码从flash拷贝到SDRAM）</li><li>清bss段</li><li>调用start_armboot (c代码，串口/USB/网卡等等 )<h2 id="cpu-arm920t-start-S"><a href="#cpu-arm920t-start-S" class="headerlink" title="cpu/arm920t/start.S"></a>cpu/arm920t/start.S</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">.</span>globl _start_start<span class="token operator">:</span>b       reset<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>首先跳转到reset的地方，将cpu设置为管理模式<pre class="line-numbers language-c" data-language="c"><code class="language-c">reset<span class="token operator">:</span><span class="token comment">/* * set the cpu to SVC32 mode # 设置为管理模式 */</span>mrsr0<span class="token punctuation">,</span>cpsrbicr0<span class="token punctuation">,</span>r0<span class="token punctuation">,</span>#<span class="token number">0x1f</span>orrr0<span class="token punctuation">,</span>r0<span class="token punctuation">,</span>#<span class="token number">0xd3</span>msrcpsr<span class="token punctuation">,</span>r0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>关闭看门狗<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_S3C2400<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_S3C2410<span class="token punctuation">)</span></span></span>ldr     r0<span class="token punctuation">,</span> <span class="token operator">=</span>pWTCONmov     r1<span class="token punctuation">,</span> #<span class="token number">0x0</span>str     r1<span class="token punctuation">,</span> <span class="token punctuation">[</span>r0<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>屏蔽所有中断<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* * mask all IRQs by setting all bits in the INTMR - default */</span>movr1<span class="token punctuation">,</span> #<span class="token number">0xffffffff</span>ldrr0<span class="token punctuation">,</span> <span class="token operator">=</span>INTMSKstrr1<span class="token punctuation">,</span> <span class="token punctuation">[</span>r0<span class="token punctuation">]</span><span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_S3C2410<span class="token punctuation">)</span></span></span>ldrr1<span class="token punctuation">,</span> <span class="token operator">=</span><span class="token number">0x3ff</span>ldrr0<span class="token punctuation">,</span> <span class="token operator">=</span>INTSUBMSKstrr1<span class="token punctuation">,</span> <span class="token punctuation">[</span>r0<span class="token punctuation">]</span><span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>读取中_start的地址，与_TEXT_BASE比较：<br>如果是上电运行，代码的前4K会被自动从nand拷贝到内部的SRAM中，则_start的地址就是0；<br>如果程序是通过调试器仿真器直接下载到SDRAM，则_start的地址就是链接地址0x33F80000。<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* * we do sys-critical inits only at reboot, * not when booting from ram! */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">CONFIG_SKIP_LOWLEVEL_INIT</span></span>adrr0<span class="token punctuation">,</span> _start<span class="token comment">/* r0 &lt;- current position of code   */</span>ldrr1<span class="token punctuation">,</span> _TEXT_BASE<span class="token comment">/* test if we run from flash or RAM */</span>cmp     r0<span class="token punctuation">,</span> r1                  <span class="token comment">/* don't reloc during debug         */</span>blnecpu_init_crit<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><p><strong>比较结果不等</strong>说明SDRAM还没有被初始化，需要到cpu_init_crit去初始化SDRAM：</p><ol><li><p>关flush清空cache</p></li><li><p>关MMU</p></li><li><p>初始化存储控制器(lowlevel_init在board/100ask24x0/lowlevel_init.S)</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">CONFIG_SKIP_LOWLEVEL_INIT</span></span>cpu_init_crit<span class="token operator">:</span><span class="token comment">/* * flush v4 I/D caches */</span>movr0<span class="token punctuation">,</span> #<span class="token number">0</span>mcrp15<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> r0<span class="token punctuation">,</span> c7<span class="token punctuation">,</span> c7<span class="token punctuation">,</span> <span class="token number">0</span><span class="token comment">/* flush v3/v4 cache */</span>mcrp15<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> r0<span class="token punctuation">,</span> c8<span class="token punctuation">,</span> c7<span class="token punctuation">,</span> <span class="token number">0</span><span class="token comment">/* flush v4 TLB */</span><span class="token comment">/* * disable MMU stuff and caches */</span>mrcp15<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> r0<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c0<span class="token punctuation">,</span> <span class="token number">0</span>bicr0<span class="token punctuation">,</span> r0<span class="token punctuation">,</span> #<span class="token number">0x00002300</span>@ clear bits <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token operator">:</span><span class="token number">8</span> <span class="token punctuation">(</span><span class="token operator">--</span>V<span class="token operator">-</span> <span class="token operator">--</span>RS<span class="token punctuation">)</span>bicr0<span class="token punctuation">,</span> r0<span class="token punctuation">,</span> #<span class="token number">0x00000087</span>@ clear bits <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">:</span><span class="token number">0</span> <span class="token punctuation">(</span>B<span class="token operator">--</span><span class="token operator">-</span> <span class="token operator">-</span>CAM<span class="token punctuation">)</span>orrr0<span class="token punctuation">,</span> r0<span class="token punctuation">,</span> #<span class="token number">0x00000002</span>@ set bit <span class="token number">2</span> <span class="token punctuation">(</span>A<span class="token punctuation">)</span> Alignorrr0<span class="token punctuation">,</span> r0<span class="token punctuation">,</span> #<span class="token number">0x00001000</span>@ set bit <span class="token number">12</span> <span class="token punctuation">(</span>I<span class="token punctuation">)</span> I<span class="token operator">-</span>Cachemcrp15<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> r0<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c0<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>bllowlevel_init<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>栈的划分：<br><img src="/images/20191202115847862.png"></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Set up the stack    */</span>stack_setup<span class="token operator">:</span>ldrr0<span class="token punctuation">,</span> _TEXT_BASE<span class="token comment">/* upper 128 KiB: relocated uboot   */</span>subr0<span class="token punctuation">,</span> r0<span class="token punctuation">,</span> #CFG_MALLOC_LEN<span class="token comment">/* malloc area                      */</span>subr0<span class="token punctuation">,</span> r0<span class="token punctuation">,</span> #CFG_GBL_DATA_SIZE <span class="token comment">/* bdinfo                        */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_USE_IRQ</span></span>subr0<span class="token punctuation">,</span> r0<span class="token punctuation">,</span> #<span class="token punctuation">(</span>CONFIG_STACKSIZE_IRQ<span class="token operator">+</span>CONFIG_STACKSIZE_FIQ<span class="token punctuation">)</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>subsp<span class="token punctuation">,</span> r0<span class="token punctuation">,</span> #<span class="token number">12</span><span class="token comment">/* leave 3 words for abort-stack    */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>初始化时钟，usb，系统的时钟</p><p> bl clock_init<br>clock_init在board/100ask24x0/boot_init.c，</p></li></ol><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">clock_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>        <span class="token comment">/* to reduce PLL lock time, adjust the LOCKTIME register */</span>        clk_power<span class="token operator">-></span>LOCKTIME <span class="token operator">=</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">;</span>        <span class="token comment">/* configure UPLL */</span>        clk_power<span class="token operator">-></span>UPLLCON <span class="token operator">=</span> S3C2410_UPLL_48MHZ<span class="token punctuation">;</span>        <span class="token comment">/* some delay between MPLL and UPLL */</span>        <span class="token function">delay</span> <span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/* configure MPLL */</span>        clk_power<span class="token operator">-></span>MPLLCON <span class="token operator">=</span> S3C2410_MPLL_200MHZ<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>重定位：代码从flash中读到SDRAM中，地址为链接地址，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">CONFIG_SKIP_RELOCATE_UBOOT</span></span>relocate<span class="token operator">:</span><span class="token comment">/* relocate U-Boot to RAM    */</span>adrr0<span class="token punctuation">,</span> _start<span class="token comment">/* r0 &lt;- current position of code   */</span>ldrr1<span class="token punctuation">,</span> _TEXT_BASE<span class="token comment">/* test if we run from flash or RAM */</span>cmp     r0<span class="token punctuation">,</span> r1                  <span class="token comment">/* don't reloc during debug         */</span>beq     clear_bssldrr2<span class="token punctuation">,</span> _armboot_startldrr3<span class="token punctuation">,</span> _bss_startsubr2<span class="token punctuation">,</span> r3<span class="token punctuation">,</span> r2<span class="token comment">/* r2 &lt;- size of armboot            */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">1</span></span></span>bl  CopyCode2Ram<span class="token comment">/* r0: source, r1: dest, r2: size */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>addr2<span class="token punctuation">,</span> r0<span class="token punctuation">,</span> r2<span class="token comment">/* r2 &lt;- source end address         */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>CopyCode2Ram在board/100ask24x0/boot_init.c中，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">CopyCode2Ram</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> start_addr<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>pdwDest<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>pdwSrc<span class="token punctuation">;</span>    <span class="token keyword">int</span> i<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bBootFrmNORFlash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        pdwDest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">;</span>        pdwSrc  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>start_addr<span class="token punctuation">;</span>        <span class="token comment">/* 从 NOR Flash启动 */</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            pdwDest<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> pdwSrc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">/* 初始化NAND Flash */</span><span class="token function">nand_init_ll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/* 从 NAND Flash启动 */</span>        <span class="token function">nand_read_ll_lp</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> start_addr<span class="token punctuation">,</span> <span class="token punctuation">(</span>size <span class="token operator">+</span> NAND_BLOCK_MASK_LP<span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token operator">~</span><span class="token punctuation">(</span>NAND_BLOCK_MASK_LP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>其中bBootFrmNORFlash是判断从nand启动还是从nor启动，判断方式是看<span class="token number">0</span>地址可写与否，如果写进去和读出来的数据同则为nand启动；因为nor不能像RAM一样去写，所以读出来的不等于写进去的数据。<span class="token keyword">int</span> <span class="token function">bBootFrmNORFlash</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>pdw <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> dwVal<span class="token punctuation">;</span>        <span class="token comment">/*     * 无论是从NOR Flash还是从NAND Flash启动，     * 地址0处为指令"bReset", 机器码为0xEA00000B，     * 对于从NAND Flash启动的情况，其开始4KB的代码会复制到CPU内部4K内存中，     * 对于从NOR Flash启动的情况，NOR Flash的开始地址即为0。     * 对于NOR Flash，必须通过一定的命令序列才能写数据，     * 所以可以根据这点差别来分辨是从NAND Flash还是NOR Flash启动:     * 向地址0写入一个数据，然后读出来，如果没有改变的话就是NOR Flash     */</span>    dwVal <span class="token operator">=</span> <span class="token operator">*</span>pdw<span class="token punctuation">;</span>           <span class="token operator">*</span>pdw <span class="token operator">=</span> <span class="token number">0x12345678</span><span class="token punctuation">;</span> <span class="token comment">// 重点</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>pdw <span class="token operator">!=</span> <span class="token number">0x12345678</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span>    <span class="token punctuation">&#123;</span>        <span class="token operator">*</span>pdw <span class="token operator">=</span> dwVal<span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>清bss段：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">clear_bss<span class="token operator">:</span>ldrr0<span class="token punctuation">,</span> _bss_start<span class="token comment">/* find start of bss segment        */</span>ldrr1<span class="token punctuation">,</span> _bss_end<span class="token comment">/* stop here                        */</span>mov r2<span class="token punctuation">,</span> #<span class="token number">0x00000000</span><span class="token comment">/* clear                            */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>board/100ask24x0/uboot.lds文件中，意思是存放所有文件的bss段</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">.</span> <span class="token operator">=</span> <span class="token function">ALIGN</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>__bss_start <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">;</span><span class="token punctuation">.</span>bss <span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">.</span>bss<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>_end <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>以上都是硬件相关的初始化，是uboot的第一阶段。<br>启动ARM核：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">ldrpc<span class="token punctuation">,</span> _start_armboot<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS1期第9课 uboot 1 之make配置文件和Makefile部分内容</title>
      <link href="2021/05/14/wds1-qi-di-9-ke-uboot-1-zhi-make-pei-zhi-wen-jian-he-makefile-bu-fen-nei-rong-local/"/>
      <url>2021/05/14/wds1-qi-di-9-ke-uboot-1-zhi-make-pei-zhi-wen-jian-he-makefile-bu-fen-nei-rong-local/</url>
      
        <content type="html"><![CDATA[<p>重新编译uboot的过程：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token number">1.</span> tar xjf u<span class="token operator">-</span>boot<span class="token operator">-</span><span class="token number">1.1</span><span class="token number">.6</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>bz2    解压<span class="token number">2.</span> cd u<span class="token operator">-</span>boot<span class="token operator">-</span><span class="token number">1.1</span><span class="token number">.6</span><span class="token operator">/</span>                到目录下<span class="token number">3.</span> patch <span class="token operator">-</span>p1 <span class="token operator">&lt;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>u<span class="token operator">-</span>boot<span class="token operator">-</span><span class="token number">1.1</span><span class="token number">.6</span>_jz2440<span class="token punctuation">.</span>patch  打补丁 <span class="token number">4.</span> make <span class="token number">100</span>ask24x0_config                    配置make<span class="token number">5.</span> make                                      make<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="分析Makefile，找到100ask24x0-config："><a href="#分析Makefile，找到100ask24x0-config：" class="headerlink" title="分析Makefile，找到100ask24x0_config："></a>分析Makefile，找到100ask24x0_config：</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token number">100</span>ask24x0_config<span class="token operator">:</span>unconfig@$<span class="token punctuation">(</span>MKCONFIG<span class="token punctuation">)</span> $<span class="token punctuation">(</span>@<span class="token operator">:</span>_config<span class="token operator">=</span><span class="token punctuation">)</span> arm arm920t <span class="token number">100</span>ask24x0 <span class="token constant">NULL</span> s3c24x0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>第一个MKCONFIG在这里定义：<br><code>MKCONFIG    := $(SRCTREE)/mkconfig</code>，第二个解析为：<br><code>100ask24x0</code><br>所以相当于：<br><code>mkconfig 100ask24x0 arm arm920t 100ask24x0 NULL s3c24x0</code></p><h3 id="打开mkconfig文件，以下分析mkconfig"><a href="#打开mkconfig文件，以下分析mkconfig" class="headerlink" title="打开mkconfig文件，以下分析mkconfig"></a>打开mkconfig文件，以下分析mkconfig</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">[</span> <span class="token string">"$&#123;BOARD_NAME&#125;"</span> <span class="token punctuation">]</span> <span class="token operator">||</span> BOARD_NAME<span class="token operator">=</span><span class="token string">"$1"</span><span class="token punctuation">[</span> $# <span class="token operator">-</span>lt <span class="token number">4</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> exit <span class="token number">1</span><span class="token punctuation">[</span> $# <span class="token operator">-</span>gt <span class="token number">6</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> exit <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>如果BOARD_NAME为空，则BOARD_NAME赋值为第一个参数($1 100ask24x0),<code>$0 $1 $2 $3</code>分别表示命令顺序的字符，如$0为mkconfig。再往下，如果参数小于4个则退出，如果参数大于6个则退出。</p><h4 id="Create-link-to-architecture-specific-headers"><a href="#Create-link-to-architecture-specific-headers" class="headerlink" title="# Create link to architecture specific headers"></a># Create link to architecture specific headers</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"$SRCTREE"</span> <span class="token operator">!=</span> <span class="token string">"$OBJTREE"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在Makefile中BUILD_DIR没有值</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">OBJTREE<span class="token operator">:</span><span class="token operator">=</span> $<span class="token punctuation">(</span><span class="token keyword">if</span> $<span class="token punctuation">(</span>BUILD_DIR<span class="token punctuation">)</span><span class="token punctuation">,</span>$<span class="token punctuation">(</span>BUILD_DIR<span class="token punctuation">)</span><span class="token punctuation">,</span>$<span class="token punctuation">(</span>CURDIR<span class="token punctuation">)</span><span class="token punctuation">)</span>SRCTREE<span class="token operator">:</span><span class="token operator">=</span> $<span class="token punctuation">(</span>CURDIR<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>所以<code>$SRCTREE = $OBJTREE</code>，在mkconfig中将执行下面：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">else</span>cd <span class="token punctuation">.</span><span class="token operator">/</span>includerm <span class="token operator">-</span>f <span class="token keyword">asm</span>ln <span class="token operator">-</span>s <span class="token keyword">asm</span><span class="token operator">-</span>$<span class="token number">2</span> <span class="token keyword">asm</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>其中删除asm，建立新的软件接asm链接到asm-arm。加入在源码里边写<code>include &lt;asm-i386/type.h&gt;/&lt;asm-arm/type.h&gt;</code>修改麻烦，这样就直接在编译时临时配置就可以，在源码里只需要写<code>include &lt;asm/type.h&gt;</code>。编译配置参数指定arm，链接之后就是asm就是asm-arm。<br><img src="/images/20191201211812380.png"><br>删除 asm-arm/arch文件夹：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">rm <span class="token operator">-</span>f <span class="token keyword">asm</span><span class="token operator">-</span>$<span class="token number">2</span><span class="token operator">/</span>arch<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果第6个参数为空 或者 等于NULL，不满足，第六个参数为s3c24x0</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">-</span>z <span class="token string">"$6"</span> <span class="token operator">-</span>o <span class="token string">"$6"</span> <span class="token operator">=</span> <span class="token string">"NULL"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> thenln <span class="token operator">-</span>s $<span class="token punctuation">&#123;</span>LNPREFIX<span class="token punctuation">&#125;</span>arch<span class="token operator">-</span>$<span class="token number">3</span> <span class="token keyword">asm</span><span class="token operator">-</span>$<span class="token number">2</span><span class="token operator">/</span>arch<span class="token keyword">else</span>ln <span class="token operator">-</span>s $<span class="token punctuation">&#123;</span>LNPREFIX<span class="token punctuation">&#125;</span>arch<span class="token operator">-</span>$<span class="token number">6</span> <span class="token keyword">asm</span><span class="token operator">-</span>$<span class="token number">2</span><span class="token operator">/</span>arch<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c">ln <span class="token operator">-</span>s $<span class="token punctuation">&#123;</span>LNPREFIX<span class="token punctuation">&#125;</span>arch<span class="token operator">-</span>$<span class="token number">6</span> <span class="token keyword">asm</span><span class="token operator">-</span>$<span class="token number">2</span><span class="token operator">/</span>archLNPREFIX没有定义，所以解析为：ln <span class="token operator">-</span>s arch<span class="token operator">-</span>s3c24x0 <span class="token keyword">asm</span><span class="token operator">-</span>arm<span class="token operator">/</span>arch为arch<span class="token operator">-</span>s3c24x0创建软链接为<span class="token keyword">asm</span><span class="token operator">-</span>arm<span class="token operator">/</span>arch<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/images/20191201215601198.png"><br>继续往下走，条件成立删除，然后创建软链接:<br><code>ln -s proc-armv asm-arm/proc</code></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"$2"</span> <span class="token operator">=</span> <span class="token string">"arm"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> thenrm <span class="token operator">-</span>f <span class="token keyword">asm</span><span class="token operator">-</span>$<span class="token number">2</span><span class="token operator">/</span>procln <span class="token operator">-</span>s $<span class="token punctuation">&#123;</span>LNPREFIX<span class="token punctuation">&#125;</span>proc<span class="token operator">-</span>armv <span class="token keyword">asm</span><span class="token operator">-</span>$<span class="token number">2</span><span class="token operator">/</span>proc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="/images/20191201220132701.png"></p><h4 id="Create-include-file-for-Make"><a href="#Create-include-file-for-Make" class="headerlink" title="#Create include file for Make"></a>#Create include file for Make</h4><p><code>&gt;</code>新建一个文件config.mk，<code>&gt;&gt;</code>追加内容, </p><pre class="line-numbers language-c" data-language="c"><code class="language-c">echo <span class="token string">"ARCH   = $2"</span> <span class="token operator">></span>  config<span class="token punctuation">.</span>mkecho <span class="token string">"CPU    = $3"</span> <span class="token operator">>></span> config<span class="token punctuation">.</span>mkecho <span class="token string">"BOARD  = $4"</span> <span class="token operator">>></span> config<span class="token punctuation">.</span>mk<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>如果第5个参数存在并且不等于NULL，追加第5个参数到config.mk文件<br>如果第6个参数存在并且不等于NULL，追加第6个参数到config.mk文件</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">[</span> <span class="token string">"$5"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">[</span> <span class="token string">"$5"</span> <span class="token operator">!=</span> <span class="token string">"NULL"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> echo <span class="token string">"VENDOR = $5"</span> <span class="token operator">>></span> config<span class="token punctuation">.</span>mk<span class="token punctuation">[</span> <span class="token string">"$6"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">[</span> <span class="token string">"$6"</span> <span class="token operator">!=</span> <span class="token string">"NULL"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> echo <span class="token string">"SOC    = $6"</span> <span class="token operator">>></span> config<span class="token punctuation">.</span>mk<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>config.mk文件的内容如下：<br><img src="/images/20191201220432796.png"></p><h4 id="Create-board-specific-header-file"><a href="#Create-board-specific-header-file" class="headerlink" title="# Create board specific header file"></a># Create board specific header file</h4><p>前面APPEND=no，<code>&gt;</code>新建config.h文件，追加内容到config.h</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"$APPEND"</span> <span class="token operator">=</span> <span class="token string">"yes"</span> <span class="token punctuation">]</span># Append to existing config filethenecho <span class="token operator">>></span> config<span class="token punctuation">.</span>h<span class="token keyword">else</span><span class="token operator">></span> config<span class="token punctuation">.</span>h# Create new config filefiecho <span class="token string">"/* Automatically generated - do not edit */"</span> <span class="token operator">>></span>config<span class="token punctuation">.</span>hecho <span class="token string">"#include &lt;configs/$1.h>"</span> <span class="token operator">>></span>config<span class="token punctuation">.</span>h<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>config.h文件的内容如下：<br><img src="/images/20191201221349216.png">以上生成的两个配置文件在Makefile中都会用到。</p><h3 id="前面分析配置文件，以下分析编译的过程"><a href="#前面分析配置文件，以下分析编译的过程" class="headerlink" title="前面分析配置文件，以下分析编译的过程"></a>前面分析配置文件，以下分析编译的过程</h3><p>在Makefile中会导出config.mk中的变量，通过这些变量来配置交叉编译工具等等：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">load</span> <span class="token expression">ARCH<span class="token punctuation">,</span> BOARD<span class="token punctuation">,</span> and CPU configuration</span></span>include $<span class="token punctuation">(</span>OBJTREE<span class="token punctuation">)</span><span class="token operator">/</span>include<span class="token operator">/</span>config<span class="token punctuation">.</span>mkexportARCH CPU BOARD VENDOR SOC<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">ifeq</span> <span class="token punctuation">(</span>$<span class="token punctuation">(</span>ARCH<span class="token punctuation">)</span><span class="token punctuation">,</span>arm<span class="token punctuation">)</span>CROSS_COMPILE <span class="token operator">=</span> arm<span class="token operator">-</span>linux<span class="token operator">-</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>CPU= arm920t</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">OBJS  <span class="token operator">=</span> cpu<span class="token operator">/</span>$<span class="token punctuation">(</span>CPU<span class="token punctuation">)</span><span class="token operator">/</span>start<span class="token punctuation">.</span>o<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>BOARDDIR BOARD</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">LIBS  <span class="token operator">=</span> lib_generic<span class="token operator">/</span>libgeneric<span class="token punctuation">.</span>aLIBS <span class="token operator">+=</span> board<span class="token operator">/</span>$<span class="token punctuation">(</span>BOARDDIR<span class="token punctuation">)</span><span class="token operator">/</span>lib$<span class="token punctuation">(</span>BOARD<span class="token punctuation">)</span><span class="token punctuation">.</span>aLIBS <span class="token operator">+=</span> cpu<span class="token operator">/</span>$<span class="token punctuation">(</span>CPU<span class="token punctuation">)</span><span class="token operator">/</span>lib$<span class="token punctuation">(</span>CPU<span class="token punctuation">)</span><span class="token punctuation">.</span>a<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>为了得到u-boot.bin，需要依赖u-boot(elf格式)，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">ALL <span class="token operator">=</span> $<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>u<span class="token operator">-</span>boot<span class="token punctuation">.</span>srec $<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>u<span class="token operator">-</span>boot<span class="token punctuation">.</span>bin $<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>System<span class="token punctuation">.</span>map $<span class="token punctuation">(</span>U_BOOT_NAND<span class="token punctuation">)</span>all<span class="token operator">:</span>$<span class="token punctuation">(</span>ALL<span class="token punctuation">)</span>$<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>u<span class="token operator">-</span>boot<span class="token punctuation">.</span>hex<span class="token operator">:</span>$<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>u<span class="token operator">-</span>boot$<span class="token punctuation">(</span>OBJCOPY<span class="token punctuation">)</span> $<span class="token punctuation">&#123;</span>OBJCFLAGS<span class="token punctuation">&#125;</span> <span class="token operator">-</span>O ihex $<span class="token operator">&lt;</span> $@$<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>u<span class="token operator">-</span>boot<span class="token punctuation">.</span>srec<span class="token operator">:</span>$<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>u<span class="token operator">-</span>boot$<span class="token punctuation">(</span>OBJCOPY<span class="token punctuation">)</span> $<span class="token punctuation">&#123;</span>OBJCFLAGS<span class="token punctuation">&#125;</span> <span class="token operator">-</span>O srec $<span class="token operator">&lt;</span> $@$<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>u<span class="token operator">-</span>boot<span class="token punctuation">.</span>bin<span class="token operator">:</span>$<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>u<span class="token operator">-</span>boot$<span class="token punctuation">(</span>OBJCOPY<span class="token punctuation">)</span> $<span class="token punctuation">&#123;</span>OBJCFLAGS<span class="token punctuation">&#125;</span> <span class="token operator">-</span>O binary $<span class="token operator">&lt;</span> $@$<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>u<span class="token operator">-</span>boot<span class="token punctuation">.</span>img<span class="token operator">:</span>$<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>u<span class="token operator">-</span>boot<span class="token punctuation">.</span>bin<span class="token punctuation">.</span><span class="token operator">/</span>tools<span class="token operator">/</span>mkimage <span class="token operator">-</span>A $<span class="token punctuation">(</span>ARCH<span class="token punctuation">)</span> <span class="token operator">-</span>T firmware <span class="token operator">-</span>C none \<span class="token operator">-</span>a $<span class="token punctuation">(</span>TEXT_BASE<span class="token punctuation">)</span> <span class="token operator">-</span>e <span class="token number">0</span> \<span class="token operator">-</span>n $<span class="token punctuation">(</span>shell sed <span class="token operator">-</span>n <span class="token operator">-</span>e <span class="token string">'s/.*U_BOOT_VERSION//p'</span> $<span class="token punctuation">(</span>VERSION_FILE<span class="token punctuation">)</span> <span class="token operator">|</span> \sed <span class="token operator">-</span>e <span class="token string">'s/"[ ]*$$/ for $(BOARD) board"/'</span><span class="token punctuation">)</span> \<span class="token operator">-</span>d $<span class="token operator">&lt;</span> $@$<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>u<span class="token operator">-</span>boot<span class="token punctuation">.</span>dis<span class="token operator">:</span>$<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>u<span class="token operator">-</span>boot$<span class="token punctuation">(</span>OBJDUMP<span class="token punctuation">)</span> <span class="token operator">-</span>d $<span class="token operator">&lt;</span> <span class="token operator">></span> $@<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>而u-boot(elf格式)，<code>LD</code>链接，<code>LDFLAGS</code>链接的一些参数，<code>__OBJS</code>所有的.o文件。在make的最后命令就是链接命令，所以在make之后可以查看最终到解析的内容。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">$<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>u<span class="token operator">-</span>boot<span class="token operator">:</span>depend version $<span class="token punctuation">(</span>SUBDIRS<span class="token punctuation">)</span> $<span class="token punctuation">(</span>OBJS<span class="token punctuation">)</span> $<span class="token punctuation">(</span>LIBS<span class="token punctuation">)</span> $<span class="token punctuation">(</span>LDSCRIPT<span class="token punctuation">)</span>UNDEF_SYM<span class="token operator">=</span>`$<span class="token punctuation">(</span>OBJDUMP<span class="token punctuation">)</span> <span class="token operator">-</span>x $<span class="token punctuation">(</span>LIBS<span class="token punctuation">)</span> <span class="token operator">|</span>sed  <span class="token operator">-</span>n <span class="token operator">-</span>e <span class="token string">'s/.*\(__u_boot_cmd_.*\)/-u\1/p'</span><span class="token operator">|</span>sort<span class="token operator">|</span>uniq`<span class="token punctuation">;</span>\cd $<span class="token punctuation">(</span>LNDIR<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> $<span class="token punctuation">(</span>LD<span class="token punctuation">)</span> $<span class="token punctuation">(</span>LDFLAGS<span class="token punctuation">)</span> $$UNDEF_SYM $<span class="token punctuation">(</span>__OBJS<span class="token punctuation">)</span> \<span class="token operator">--</span>start<span class="token operator">-</span>group $<span class="token punctuation">(</span>__LIBS<span class="token punctuation">)</span> <span class="token operator">--</span>end<span class="token operator">-</span>group $<span class="token punctuation">(</span>PLATFORM_LIBS<span class="token punctuation">)</span> \<span class="token operator">-</span>Map u<span class="token operator">-</span>boot<span class="token punctuation">.</span>map <span class="token operator">-</span>o u<span class="token operator">-</span>boot<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>解析到链接的输出内容如下，：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">UNDEF_SYM<span class="token operator">=</span>`arm<span class="token operator">-</span>linux<span class="token operator">-</span>objdump <span class="token operator">-</span>x lib_generic<span class="token operator">/</span>libgeneric<span class="token punctuation">.</span>a board<span class="token operator">/</span><span class="token number">100</span>ask24x0<span class="token operator">/</span>lib100ask24x0<span class="token punctuation">.</span>a cpu<span class="token operator">/</span>arm920t<span class="token operator">/</span>libarm920t<span class="token punctuation">.</span>a cpu<span class="token operator">/</span>arm920t<span class="token operator">/</span>s3c24x0<span class="token operator">/</span>libs3c24x0<span class="token punctuation">.</span>a lib_arm<span class="token operator">/</span>libarm<span class="token punctuation">.</span>a fs<span class="token operator">/</span>cramfs<span class="token operator">/</span>libcramfs<span class="token punctuation">.</span>a fs<span class="token operator">/</span>fat<span class="token operator">/</span>libfat<span class="token punctuation">.</span>a fs<span class="token operator">/</span>fdos<span class="token operator">/</span>libfdos<span class="token punctuation">.</span>a fs<span class="token operator">/</span>jffs2<span class="token operator">/</span>libjffs2<span class="token punctuation">.</span>a fs<span class="token operator">/</span>reiserfs<span class="token operator">/</span>libreiserfs<span class="token punctuation">.</span>a fs<span class="token operator">/</span>ext2<span class="token operator">/</span>libext2fs<span class="token punctuation">.</span>a net<span class="token operator">/</span>libnet<span class="token punctuation">.</span>a disk<span class="token operator">/</span>libdisk<span class="token punctuation">.</span>a rtc<span class="token operator">/</span>librtc<span class="token punctuation">.</span>a dtt<span class="token operator">/</span>libdtt<span class="token punctuation">.</span>a drivers<span class="token operator">/</span>libdrivers<span class="token punctuation">.</span>a drivers<span class="token operator">/</span>nand<span class="token operator">/</span>libnand<span class="token punctuation">.</span>a drivers<span class="token operator">/</span>nand_legacy<span class="token operator">/</span>libnand_legacy<span class="token punctuation">.</span>a drivers<span class="token operator">/</span>usb<span class="token operator">/</span>libusb<span class="token punctuation">.</span>a drivers<span class="token operator">/</span>sk98lin<span class="token operator">/</span>libsk98lin<span class="token punctuation">.</span>a common<span class="token operator">/</span>libcommon<span class="token punctuation">.</span>a <span class="token operator">|</span>sed  <span class="token operator">-</span>n <span class="token operator">-</span>e <span class="token string">'s/.*\(__u_boot_cmd_.*\)/-u\1/p'</span><span class="token operator">|</span>sort<span class="token operator">|</span>uniq`<span class="token punctuation">;</span>\cd <span class="token operator">/</span>media<span class="token operator">/</span>wuyexkx<span class="token operator">/</span>DA18EBFA09C1B27D<span class="token operator">/</span>韦东山<span class="token operator">/</span>修改加笔记<span class="token operator">/</span>uboot相关<span class="token operator">/</span>u<span class="token operator">-</span>boot<span class="token operator">-</span><span class="token number">1.1</span><span class="token number">.6</span> <span class="token operator">&amp;&amp;</span> arm<span class="token operator">-</span>linux<span class="token operator">-</span>ld <span class="token operator">-</span>Bstatic <span class="token operator">-</span>T <span class="token operator">/</span>media<span class="token operator">/</span>wuyexkx<span class="token operator">/</span>DA18EBFA09C1B27D<span class="token operator">/</span>韦东山<span class="token operator">/</span>修改加笔记<span class="token operator">/</span>uboot相关<span class="token operator">/</span>u<span class="token operator">-</span>boot<span class="token operator">-</span><span class="token number">1.1</span><span class="token number">.6</span><span class="token operator">/</span>board<span class="token operator">/</span><span class="token number">100</span>ask24x0<span class="token operator">/</span>u<span class="token operator">-</span>boot<span class="token punctuation">.</span>lds <span class="token operator">-</span>Ttext <span class="token number">0x33F80000</span>  $UNDEF_SYM cpu<span class="token operator">/</span>arm920t<span class="token operator">/</span>start<span class="token punctuation">.</span>o \<span class="token operator">--</span>start<span class="token operator">-</span>group lib_generic<span class="token operator">/</span>libgeneric<span class="token punctuation">.</span>a board<span class="token operator">/</span><span class="token number">100</span>ask24x0<span class="token operator">/</span>lib100ask24x0<span class="token punctuation">.</span>a cpu<span class="token operator">/</span>arm920t<span class="token operator">/</span>libarm920t<span class="token punctuation">.</span>a cpu<span class="token operator">/</span>arm920t<span class="token operator">/</span>s3c24x0<span class="token operator">/</span>libs3c24x0<span class="token punctuation">.</span>alib_arm<span class="token operator">/</span>libarm<span class="token punctuation">.</span>a fs<span class="token operator">/</span>cramfs<span class="token operator">/</span>libcramfs<span class="token punctuation">.</span>a fs<span class="token operator">/</span>fat<span class="token operator">/</span>libfat<span class="token punctuation">.</span>a fs<span class="token operator">/</span>fdos<span class="token operator">/</span>libfdos<span class="token punctuation">.</span>a fs<span class="token operator">/</span>jffs2<span class="token operator">/</span>libjffs2<span class="token punctuation">.</span>a fs<span class="token operator">/</span>reiserfs<span class="token operator">/</span>libreiserfs<span class="token punctuation">.</span>a fs<span class="token operator">/</span>ext2<span class="token operator">/</span>libext2fs<span class="token punctuation">.</span>a net<span class="token operator">/</span>libnet<span class="token punctuation">.</span>a disk<span class="token operator">/</span>libdisk<span class="token punctuation">.</span>a rtc<span class="token operator">/</span>librtc<span class="token punctuation">.</span>a dtt<span class="token operator">/</span>libdtt<span class="token punctuation">.</span>a drivers<span class="token operator">/</span>libdrivers<span class="token punctuation">.</span>a drivers<span class="token operator">/</span>nand<span class="token operator">/</span>libnand<span class="token punctuation">.</span>a drivers<span class="token operator">/</span>nand_legacy<span class="token operator">/</span>libnand_legacy<span class="token punctuation">.</span>a drivers<span class="token operator">/</span>usb<span class="token operator">/</span>libusb<span class="token punctuation">.</span>a drivers<span class="token operator">/</span>sk98lin<span class="token operator">/</span>libsk98lin<span class="token punctuation">.</span>a common<span class="token operator">/</span>libcommon<span class="token punctuation">.</span>a <span class="token operator">--</span>end<span class="token operator">-</span>group  \<span class="token operator">-</span>Map u<span class="token operator">-</span>boot<span class="token punctuation">.</span>map <span class="token operator">-</span>o u<span class="token operator">-</span>bootarm<span class="token operator">-</span>linux<span class="token operator">-</span>objcopy <span class="token operator">--</span>gap<span class="token operator">-</span>fill<span class="token operator">=</span><span class="token number">0xff</span> <span class="token operator">-</span>O srec u<span class="token operator">-</span>boot u<span class="token operator">-</span>boot<span class="token punctuation">.</span>srecarm<span class="token operator">-</span>linux<span class="token operator">-</span>objcopy <span class="token operator">--</span>gap<span class="token operator">-</span>fill<span class="token operator">=</span><span class="token number">0xff</span> <span class="token operator">-</span>O binary u<span class="token operator">-</span>boot u<span class="token operator">-</span>boot<span class="token punctuation">.</span>bin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>总结上面的一堆，链接文件 就是依赖链接脚本(.lds) 和 原材料(.a)。<br>查看这些原材料（库）是怎么组织起来的，顺序是什么，需要查看链接脚本u-boot-1.1.6/board/100ask24x0/u-boot.lds，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">SECTIONS<span class="token punctuation">&#123;</span><span class="token punctuation">.</span> <span class="token operator">=</span> <span class="token number">0x00000000</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>当前地址为0，在链接的结果中看到-Ttext 0x33F80000，所以相加等于0x33F80000，之后的代码放到内存的0x33F80000，依次放<code>cpu/arm920t/start.o</code>的代码段(.text)，board/100ask24x0/boot_init.o (.text)和其他所有文件的代码段*(.text)，所有文件的只读数据段*(.rodata)，*(.data)数据段，*(.u_boot_cmd)等等<br><img src="/images/20191201230138978.png">由上分析可知，从内存0x33F80000首先运行的是<code>cpu/arm920t/start.S</code>,然后是board/100ask24x0/boot_init.o，然后==分析start.o==就可以知道uboot的大概流程。</p><p>总结：</p><ol><li><code>cpu/arm920t/start.S</code></li><li>链接地址board/100ask24x0/u-boot.lds 和 0x33F80000</li></ol><p>uboot根目录下的文件config.mk ，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">LDFLAGS <span class="token operator">+=</span> <span class="token operator">-</span>Bstatic <span class="token operator">-</span>T $<span class="token punctuation">(</span>LDSCRIPT<span class="token punctuation">)</span> <span class="token operator">-</span>Ttext $<span class="token punctuation">(</span>TEXT_BASE<span class="token punctuation">)</span> $<span class="token punctuation">(</span>PLATFORM_LDFLAGS<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>EXT_BASE在board/100ask24x0/config.mk</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">TEXT_BASE <span class="token operator">=</span> <span class="token number">0x33F80000</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>可以通过修改board/100ask24x0/config.mk中的TEXT_BASE来改变uboot的地址，<br>0x33F80000是64MSDRAM的最上面往回512k的地址，若uboot超过512k需要往下修改TEXT_BASE的值；若自己的SDRAM不是64M也需要修改。<br>内存0x30000000 ～ 0x34000000 共 64M(0x4000000)，<br>最上端512k(0x80000)，所以0x34000000-0x80000=0x33F80000</p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS1期第12课 字符设备驱动框架 围绕cdev</title>
      <link href="2021/05/14/wds1-qi-di-12-ke-zi-fu-she-bei-qu-dong-kuang-jia-wei-rao-cdev-local/"/>
      <url>2021/05/14/wds1-qi-di-12-ke-zi-fu-she-bei-qu-dong-kuang-jia-wei-rao-cdev-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]<br><strong>模块</strong>是linux内核进行组件管理的一种方式，<br>驱动是基于模块进行注册和注销的，<br>不单单是字符设备，块设备驱动和网络设备驱动都是基于模块进行加载和卸载的。</p><p><strong>字符设备</strong>（字符为单位，读写同步）<br>I/O传输过程中以字符为单位进行传输，<br>用户对字符设备发出读/写请求时,实际的使件读/写操作一般紧接着发生块设备。<br>eg：LCD 鼠标 键盘 触摸屏 串口<br><strong>块设备</strong>（以块为单位，异步）<br>与字符相反,它的数据传输以块(内存缓冲)为单位传输用户对块设备读,硬件上的读/写操作不会紧接着发生,即用户请求和硬件操作是异步的<br>eg：磁盘类、闪存类等设备都封装成块设备</p><p>设备文件：字符设备 和块设备有设备文件，网络设备没有设备文件。</p><p>内核统一管理设备，所以编写内核驱动程序需要遵循内核的一些规则。<strong>内核将字符设备/块设备/网络设备</strong><font color=red><strong>抽象成对应的结构体</strong></font>。</p><h3 id="一、-描述字符设备的结构体（cdev）"><a href="#一、-描述字符设备的结构体（cdev）" class="headerlink" title="一、 描述字符设备的结构体（cdev）"></a>一、 描述字符设备的结构体（cdev）</h3><p>在include/linux/cdev.h中定义，有两个成员很重要dev，ops，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">cdev</span> <span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">kobject</span> kobj<span class="token punctuation">;</span> <span class="token comment">// 设备模型相关 </span><span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">;</span><span class="token comment">// 设备模型相关，赋值THIS_MODULE,设备驱动属于哪个模块</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token operator">*</span>ops<span class="token punctuation">;</span>  <span class="token comment">// 函数指针，操作方法集</span><span class="token keyword">struct</span> <span class="token class-name">list_head</span> list<span class="token punctuation">;</span><span class="token comment">// 内核通过这个list管理设备</span><span class="token class-name">dev_t</span> dev<span class="token punctuation">;</span><span class="token comment">// 设备号</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> count<span class="token punctuation">;</span><span class="token comment">// 设备个数，一个驱动 驱动了多个设备</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="1-设备号-（dev-t-dev）"><a href="#1-设备号-（dev-t-dev）" class="headerlink" title="1. 设备号 （dev_t dev）"></a>1. 设备号 （dev_t dev）</h4><p>用来标识设备，唯一。<br>32位无符号整型，12位主设备 <code>+</code> 20位次设备（根内核版本有关吧）<br>在/usr/include/linux/kdev_t.h中，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">MAJOR</span><span class="token expression"><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token operator">>></span><span class="token number">8</span><span class="token punctuation">)</span></span><span class="token comment">// 提取主设备号</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">MINOR</span><span class="token expression"><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span></span><span class="token comment">// 提取次设备号</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">MKDEV</span><span class="token expression"><span class="token punctuation">(</span>ma<span class="token punctuation">,</span>mi<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ma<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span> <span class="token operator">|</span> <span class="token punctuation">(</span>mi<span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="token comment">// 根据 主次设备号 合成 设备号</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="2-操作方法集（file-operations-ops）"><a href="#2-操作方法集（file-operations-ops）" class="headerlink" title="2. 操作方法集（file_operations *ops）"></a>2. 操作方法集（file_operations *ops）</h4><p>提供给应用层的一些操作方法集，open write read</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* * NOTE: * read, write, poll, fsync, readv, writev, unlocked_ioctl and compat_ioctl * can be called without the big kernel lock held in all filesystems. */</span><span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">;</span><span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>read<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>write<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>open<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>release<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="二、-字符设备驱动框架用到的一些API"><a href="#二、-字符设备驱动框架用到的一些API" class="headerlink" title="二、 字符设备驱动框架用到的一些API"></a>二、 字符设备驱动框架用到的一些API</h3><p><strong>这些东西都是在内核模块框架下的。</strong></p><h4 id="0-分配设备号"><a href="#0-分配设备号" class="headerlink" title="0. 分配设备号"></a>0. 分配设备号</h4><h5 id="0-1-分配设备号，注册设备号"><a href="#0-1-分配设备号，注册设备号" class="headerlink" title="0.1 分配设备号，注册设备号"></a>0.1 分配设备号，注册设备号</h5><ol><li>自动分配设备号 <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*********************************************功能：分配设备号参数：dev设备号指针，分配到的设备号就从指针传出 baseminor  次设备号起始，一般从0开始 count次设备个数 name设备号对应的名字返回值：成功返回0，失败返回负数错误码**********************************************/</span><span class="token keyword">int</span> <span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token class-name">dev_t</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> baseminor<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> count<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>指定设备号 <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*********************************************功能：分配设备号参数：from需要程序员指定的设备号,MKDEV(major, minor),起始在次设备号中 count次设备个数 name设备号对应的名字返回值：成功返回0，失败返回负数错误码**********************************************/</span><span class="token keyword">int</span> <span class="token function">register_chrdev_region</span><span class="token punctuation">(</span><span class="token class-name">dev_t</span> from<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> count<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="0-2-注销设备号"><a href="#0-2-注销设备号" class="headerlink" title="0.2 注销设备号"></a>0.2 注销设备号</h5><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*********************************************功能：从内核中注销设备号参数：from需要注销的设备号 count次设备个数 name设备号对应的名字返回值：void**********************************************/</span><span class="token keyword">void</span> <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span><span class="token class-name">dev_t</span> from<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="1-为cdev结构体分配内存空间"><a href="#1-为cdev结构体分配内存空间" class="headerlink" title="1. 为cdev结构体分配内存空间"></a>1. 为cdev结构体分配内存空间</h4>在fs/char_dev.c中，cdev_alloc为cdev结构体分配内存空间，<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*********************************************功能：为cdev结构体分配空间参数：void返回值：分配成功返回分配得到的结构体指针   失败返回NULL**********************************************/</span><span class="token keyword">struct</span> <span class="token class-name">cdev</span> <span class="token operator">*</span><span class="token function">cdev_alloc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><font color=red><strong>可能由于内存不够 导致分配失败，==一定要处理分配失败的情况，并且如果要返回一定要把前面分配到的资源释放掉==，包含多层调用一定要查清楚分配了哪些资源，然后依次释放。</strong></font><h4 id="2-初始化cdev结构体"><a href="#2-初始化cdev结构体" class="headerlink" title="2. 初始化cdev结构体"></a>2. 初始化cdev结构体</h4>在fs/char_dev.c中，<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*********************************************功能：初始化结构体参数：cdevcdev结构体指针fops操作方法集指针返回值：void**********************************************/</span><span class="token keyword">void</span> <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">cdev</span> <span class="token operator">*</span>cdev<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token operator">*</span>fops<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="3-添加（注册）字符设备到内核"><a href="#3-添加（注册）字符设备到内核" class="headerlink" title="3. 添加（注册）字符设备到内核"></a>3. 添加（注册）字符设备到内核</h4>注册字符设备中，由内核统一管理，在fs/char_dev.c中，<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*********************************************功能：添加（注册）字符设备到内核中参数：pcdev结构体指针dev设备号count设备个数返回值：int 成功返回0，失败返回错误码-ENOMEM**********************************************/</span><span class="token keyword">int</span> <span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">cdev</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token class-name">dev_t</span> dev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> count<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>cdev_add返回值的情况<br>在drivers/base/map.c中定义kobj_map函数，成功返回0，失败返回错误码 <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">kobj_map</span><span class="token punctuation">(</span>cdev_map<span class="token punctuation">,</span> dev<span class="token punctuation">,</span> count<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> exact_match<span class="token punctuation">,</span> exact_lock<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">probe</span><span class="token punctuation">)</span> <span class="token operator">*</span> n<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span> <span class="token comment">// #defineENOMEM12/* Out of memory */</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>第二参数dev设备号<br>设备号内核统一管理，属于内核的资源，设备号资源，需要申请设备号资源<h4 id="4-删除（注销）字符设备"><a href="#4-删除（注销）字符设备" class="headerlink" title="4. 删除（注销）字符设备"></a>4. 删除（注销）字符设备</h4>在不用设备时，一定要注销该设备，应该在内核模块的卸载函数中，<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*********************************************功能：从内核中删除（注销）字符设备参数：pcdev结构体指针返回值：void**********************************************/</span><span class="token keyword">void</span> <span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">cdev</span> <span class="token operator">*</span>p<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="三、-编写字符设备驱动框架"><a href="#三、-编写字符设备驱动框架" class="headerlink" title="三、 编写字符设备驱动框架"></a>三、 编写字符设备驱动框架</h3>所有驱动都是基于内核模块去完成的，内核模块三要素：<br>入口函数<br>出口函数<br>GPL协议声明</li></ol><p>驱动注册时，就要申请cdev内存，执行初始化，申请设备号等；<br>当卸载驱动时就要去释放内存资源，注销设备号。</p><h4 id="1-module-demo-c文件"><a href="#1-module-demo-c文件" class="headerlink" title="1. module_demo.c文件"></a>1. module_demo.c文件</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span>  <span class="token comment">// 操作方法集</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h></span> </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BASEMINOR</span>   <span class="token expression"><span class="token number">0</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">COUNT</span>       <span class="token expression"><span class="token number">3</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NAME</span>        <span class="token string">"chrdev_demo"</span></span><span class="token comment">// 保存申请到的设备号</span><span class="token class-name">dev_t</span> devno<span class="token punctuation">;</span> <span class="token comment">// 抽象的字符设备结构体</span><span class="token keyword">struct</span> <span class="token class-name">cdev</span> <span class="token operator">*</span>cdevp<span class="token punctuation">;</span><span class="token comment">// 操作方法集内的函数指针（函数）定义</span><span class="token keyword">int</span> <span class="token function">demo_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filep<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"---%s---%s---%d"</span><span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">demo_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filep<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"---%s---%s---%d"</span><span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 定义操作方法集结构体，并部分初始化</span><span class="token keyword">struct</span> <span class="token class-name">file_operations</span> fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>     <span class="token punctuation">.</span>owner   <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>    <span class="token punctuation">.</span>open    <span class="token operator">=</span> demo_open<span class="token punctuation">,</span>    <span class="token punctuation">.</span>release <span class="token operator">=</span> demo_release<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">module_demo_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 用于保存分配到的设备号</span>    <span class="token comment">// 0. 获取设备号 alloc_chrdev_region 自动获取设备号</span>    ret <span class="token operator">=</span> <span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>devno<span class="token punctuation">,</span> BASEMINOR<span class="token punctuation">,</span> COUNT<span class="token punctuation">,</span> NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"alloc_chrdev_region failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">goto</span> err1_alloc_chrdev_region<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"major = %d\n"</span><span class="token punctuation">,</span> <span class="token function">MAJOR</span><span class="token punctuation">(</span>devno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 主设备号是内核分配的，次设备是自己指定，提取主设备号打印</span>    <span class="token comment">// 1. 分配内存 cdev_alloc</span>    cdevp <span class="token operator">=</span> <span class="token function">cdev_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>cdevp <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"cdev_alloc failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ret <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>     <span class="token comment">// #defineENOMEM12/* Out of memory */</span>        <span class="token keyword">goto</span> err2_cdev_alloc<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 2. 初始化cdev结构体 cdev_init</span>    <span class="token function">cdev_init</span><span class="token punctuation">(</span>cdevp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fops<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3. 注册设备到内核 cdev_add</span>    ret <span class="token operator">=</span> <span class="token function">cdev_add</span><span class="token punctuation">(</span>cdevp<span class="token punctuation">,</span> devno<span class="token punctuation">,</span> COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"cdev_add failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">goto</span> err2_cdev_alloc<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"---%s---%s---%d"</span><span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打印此行说明前面成功</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>                                                <span class="token comment">// 成功之后就不能执行下面的err释放资源步骤</span>    <span class="token comment">// 释放资源，申请资源的倒序</span>    err2_cdev_alloc<span class="token operator">:</span>        <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>devno<span class="token punctuation">,</span> COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>    err1_alloc_chrdev_region<span class="token operator">:</span>        <span class="token keyword">return</span> ret<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">module_demo_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 注销设备号</span>    <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>devno<span class="token punctuation">,</span> COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 注销字符设备</span>    <span class="token function">cdev_del</span><span class="token punctuation">(</span>cdevp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"---%s---%s---%d"</span><span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打印此行说明注销成功</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>module_demo_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>module_demo_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2-Makefile文件"><a href="#2-Makefile文件" class="headerlink" title="2. Makefile文件"></a>2. Makefile文件</h4><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token property">KERNDIR</span> <span class="token punctuation">:</span>= /lib/modules/$<span class="token punctuation">(</span>shell uname -r<span class="token punctuation">)</span>/build # 系统内核的路径<span class="token property">PWD</span> <span class="token punctuation">:</span>= $<span class="token punctuation">(</span>shell pwd<span class="token punctuation">)</span># 执行pwd命令并把结果赋给PWD<span class="token property">obj-m</span> <span class="token punctuation">:</span>= module_demo.o  # .ko的生成依赖于.o，.o默认依赖.c<span class="token property">all</span><span class="token punctuation">:</span>make -C $<span class="token punctuation">(</span>KERNDIR<span class="token punctuation">)</span> M=$<span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> modules<span class="token property">clean</span><span class="token punctuation">:</span>make -C $<span class="token punctuation">(</span>KERNDIR<span class="token punctuation">)</span> M=$<span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> clean<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>插入内核模块module_demo.ko到内核，查看内核日志，卸载内核模块，查看内核日志，<br><img src="/images/20191217103255906.png">重新分配得到的设备号根之前的一样，说明上次释放资源成功，<br><img src="/images/20191217103414560.png"></p><h3 id="三个重要的结构体"><a href="#三个重要的结构体" class="headerlink" title="三个重要的结构体"></a>三个重要的结构体</h3><h4 id="1-inode"><a href="#1-inode" class="headerlink" title="1. inode"></a>1. inode</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token class-name">dev_t</span>i_rdev<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">cdev</span><span class="token operator">*</span>i_cdev<span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2-fops"><a href="#2-fops" class="headerlink" title="2.fops"></a>2.fops</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">;</span><span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>read<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>write<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>open<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>release<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="3-filep"><a href="#3-filep" class="headerlink" title="3. filep"></a>3. filep</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token class-name">mode_t</span>f_mode<span class="token punctuation">;</span><span class="token class-name">loff_t</span>f_pos<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> f_flags<span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span><span class="token operator">*</span>f_op<span class="token punctuation">;</span> <span class="token keyword">void</span><span class="token operator">*</span>private_data<span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>inode结构体将设备号dev_t和字符设备抽象结构cdev联系起来，字符设备抽象结构cdev将设备号dev_t和操作方法集fops联系起来，<br>cdev_init函数用操作方法集fops去初始化字符设备抽象结构cdev（绑定驱动程序到cdev）<br><a href="https://www.linuxidc.com/Linux/2017-02/140227.htm">参考牛人的博客</a><br><img src="/images/20191217232838991.png"></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS1期第6课 裸机5 -中断控制器</title>
      <link href="2021/05/14/wds1-qi-di-6-ke-luo-ji-5-zhong-duan-kong-zhi-qi-local/"/>
      <url>2021/05/14/wds1-qi-di-6-ke-luo-ji-5-zhong-duan-kong-zhi-qi-local/</url>
      
        <content type="html"><![CDATA[<p>ARM的中断体系结构<br><img src="/images/20200331141847948.png"><br>用户模式usr<br>快速终端模式fiq<br>中断模式irq<br>管理模式svc<br>数据访问终止模式abt<br>系统模式sys<br>未定义指令终止模式und<br>中断是一种异常</p><p>各个模式下对应使用不同的寄存器，有不同的权限，出发条件也不同，目的是使系统能够方便快速执行，而不需要保存和恢复太多东西。</p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS1期第12课 字符设备驱动 9 keys较完整的驱动 增加利用定时器消抖 struct timer_list 直到抖到最后一次进中断,再调keys_timer_function去获取按键状态</title>
      <link href="2021/05/14/wds1-qi-di-12-ke-zi-fu-she-bei-qu-dong-9-keys-jiao-wan-zheng-de-qu-dong-zeng-jia-li-yong-ding-shi-qi-xiao-dou-struct-timer-list-zhi-dao-dou-dao-zui-hou-yi-ci-jin-zhong-duan-zai-diao-keys-timer-function-qu-huo-qu-an-jian-zhuang-tai-local/"/>
      <url>2021/05/14/wds1-qi-di-12-ke-zi-fu-she-bei-qu-dong-9-keys-jiao-wan-zheng-de-qu-dong-zeng-jia-li-yong-ding-shi-qi-xiao-dou-struct-timer-list-zhi-dao-dou-dao-zui-hou-yi-ci-jin-zhong-duan-zai-diao-keys-timer-function-qu-huo-qu-an-jian-zhuang-tai-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]</p><blockquote><p>修改超时时间jiffies, jiffies是全局变量,每隔10ms系统产生一个时钟中断, 10ms<br>每次进中断都修改jiffies往后延迟10ms, 10ms内可能多次进入中断,<br>直到抖动到最后一次进中断 后超时，然后调用keys_timer_function去获取按键的状态<br><img src="/images/20200408221902371.png"></p></blockquote><h1 id="驱动代码"><a href="#驱动代码" class="headerlink" title="驱动代码"></a>驱动代码</h1><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span>     <span class="token comment">// module_init module_exit</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span>   <span class="token comment">// MODULE_LICENSE</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span>       <span class="token comment">// file_operations</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h></span>     <span class="token comment">// cdev</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h></span>   <span class="token comment">// class_device</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/irq.h></span>      <span class="token comment">// IRQ_EINTx</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/uaccess.h></span>    <span class="token comment">// copy_from_user copy_to_user</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h></span>         <span class="token comment">// ioremap  iounmap</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/irq.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/regs-gpio.h></span> <span class="token comment">// S3C2410_GPFx</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/poll.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/timer.h></span>   <span class="token comment">// HZ</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/jiffies.h></span> <span class="token comment">// jiffies</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEVICE_NAME</span>      <span class="token string">"keys_all"</span></span><span class="token keyword">int</span> major<span class="token punctuation">;</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpfcon <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpfdat <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpgcon <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpgdat <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPFCON</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span>gpfcon<span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPFDAT</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span>gpfdat<span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPGCON</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span>gpgcon<span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPGDAT</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span>gpgdat<span class="token punctuation">)</span></span></span><span class="token comment">// 用定时器来防抖动, 主要是设置超时时间,处理函数</span><span class="token comment">// 定义一个定时器</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">timer_list</span> keys_timer<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">pin_desc</span> <span class="token operator">*</span>irq_pd<span class="token punctuation">;</span><span class="token comment">// 使用static来允许同一时刻只有一个用户使用驱动程序</span><span class="token comment">// static int canopen = 1;</span><span class="token comment">// 使用原子操作,定义原子变量并初始化为1</span><span class="token comment">// static atomic_t canopen = ATOMIC_INIT(1);</span><span class="token comment">// 使用信号量， </span><span class="token keyword">static</span> <span class="token function">DECLARE_MUTEX</span><span class="token punctuation">(</span>canopen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 定义互斥锁</span><span class="token comment">// 异步通知用户程序 需要的保存用户pid等信息的结构体</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">fasync_struct</span> <span class="token operator">*</span>keys_async_stct<span class="token punctuation">;</span><span class="token comment">// 用于自动创建设备节点的结构class 和 class_device</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>keys_class<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">class_device</span> <span class="token operator">*</span>keys_class_dev<span class="token punctuation">;</span><span class="token comment">/* 定义一个等待队列button_waitq，这个等待队列实际上是由中断驱动的，    当中断发生时，会令挂接到这个等待队列的休眠进程唤醒 */</span><span class="token keyword">static</span> <span class="token function">DECLARE_WAIT_QUEUE_HEAD</span><span class="token punctuation">(</span>button_waitq<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 中断事件标志，ISR将它置1, read 清0</span><span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> ev_press <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 自定义引脚描述的结构</span><span class="token keyword">struct</span> <span class="token class-name">pin_desc</span><span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> pin<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> key_val<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">/*键值：按下，0x01,0x02,0x03,0x04  键值：松开，0x81,0x82,0x83,0x84*/</span><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> key_val<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">pin_desc</span> pins_desc<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#123;</span>S3C2410_GPF0<span class="token punctuation">,</span>  <span class="token number">0x01</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>S3C2410_GPF2<span class="token punctuation">,</span>  <span class="token number">0x02</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>S3C2410_GPG3<span class="token punctuation">,</span>  <span class="token number">0x03</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>S3C2410_GPG11<span class="token punctuation">,</span> <span class="token number">0x04</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// ISR 发生中断之后会调用这个函数, irq就是对应的中断号</span><span class="token keyword">static</span> <span class="token class-name">irqreturn_t</span> <span class="token function">keys_irq</span><span class="token punctuation">(</span><span class="token keyword">int</span> irq<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dev_id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    irq_pd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pin_desc</span> <span class="token operator">*</span><span class="token punctuation">)</span>dev_id<span class="token punctuation">;</span>    <span class="token comment">// 修改超时时间jiffies, jiffies是全局变量,每隔10ms系统产生一个时钟中断, 10ms</span>    <span class="token comment">//  每次进中断都修改jiffies往后延迟10ms, 10ms内可能多次进入中断,</span>    <span class="token comment">//  直到抖动到最后一次进中断,然后调用keys_timer_function去获取按键的状态</span>    <span class="token function">mod_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>keys_timer<span class="token punctuation">,</span> jiffies<span class="token operator">+</span>HZ<span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">IRQ_RETVAL</span><span class="token punctuation">(</span>IRQ_HANDLED<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// GPF0/2 GPG3/11 申请中断</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">keys_open</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>       <span class="token comment">// // static同时只有一个用户使用drv</span>    <span class="token comment">// if (--canopen != 0)</span>    <span class="token comment">// &#123;</span>    <span class="token comment">//     // 这个++是配合判断里的--</span>    <span class="token comment">//     canopen++;</span>    <span class="token comment">//     return -EBUSY;</span>    <span class="token comment">// &#125;</span>    <span class="token comment">// 原子变量自减test, 如果自减之后为0则返回true</span>    <span class="token comment">// if (!atomic_dec_and_test(&amp;canopen))</span>    <span class="token comment">// &#123;</span>    <span class="token comment">//     // 这个inc是配合判断里的dec</span>    <span class="token comment">//     atomic_inc(&amp;canopen);</span>    <span class="token comment">//     return -EBUSY;</span>    <span class="token comment">// &#125;</span>    <span class="token comment">// 获取信号量，获取不到不可被打断，kill不掉</span>    <span class="token comment">// down(&amp;canopen); // down_interruptible();获取不到就休眠，休眠中可以被打断</span>    <span class="token comment">// 阻塞与非阻塞</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>filp<span class="token operator">-></span>f_flags <span class="token operator">&amp;</span> O_NONBLOCK<span class="token punctuation">)</span> <span class="token comment">// 非阻塞，</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">// 非阻塞，如果获取不了锁就应该立即返回</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">down_trylock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>canopen<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span>                            <span class="token comment">// 阻塞</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">// 获取信号量，获取不到就休眠等待那个锁，kill不掉</span>        <span class="token function">down</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>canopen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// down_interruptible();获取不到就休眠，休眠中可以被打断</span>    <span class="token punctuation">&#125;</span>        <span class="token comment">/**********************************************************    中断控制器的初始化（底层）在irq_chip结构体中定义；    自定义的处理函数以desc为索引，在action链表中；        struct irq_desc        struct irq_chip        action    需用通过注册的机制将他们联系起来:        request_irq()        free_irq()    中断的顶半部和底半部：        顶半部：            在request_irq中传入的handler就是它，会屏蔽中断，行紧急之事开销小，如flag，读写IO寄存器等等，然后将下半部处理函数挂在到底半部的执行队列中去        底半部：            执行耗时工作，可以被打断，底半部机制包括：                 tasklet：使系统在适当时调度运行                工作队列：将工作推后执行的机制，推后的工作交由一个内核线程去执行，优势是允许重新调度甚至睡眠                软中断：一般写驱动不用也宜使用    ***********************************************************/</span><span class="token comment">// 在request_irq中会去注册中断函数到action链表</span>    <span class="token comment">/*    *@irq: Interrupt line to allocate    *@handler: Function to be called when the IRQ occurs    *@irqflags: Interrupt type flags    *@devname: An ascii name for the claiming device    *@dev_id: A cookie passed back to the handler function    */</span>        <span class="token comment">// irq:中断号</span><span class="token comment">// handler：处理函数</span><span class="token comment">// irqflags:上升沿触发，下降沿触发，边沿触发等。指定了快速中断或中断共享等中断处理属性.</span><span class="token comment">// *devname：中断名字。通常是设备驱动程序的名称。改值用在 /proc/interrupt 系统 (虚拟)</span><span class="token comment">// 文件上，或内核发生中断错误时使用。</span><span class="token comment">// dev_id 可作为共享中断时的中断区别参数，也可以用来指定中断服务函数需要参考的数据地址。也用于卸载action</span>    <span class="token comment">// 中断引脚，自动设备为中断引脚，</span>    <span class="token comment">//  IRQ_EINT0在include/asm-arm/arch-s3c2410/irqs.h中定义</span>    <span class="token comment">//  keys_irq</span>    <span class="token comment">//  IRQT_BOTHEDGE双边沿触发</span>    <span class="token comment">//  "EINT0_S2"</span>    <span class="token comment">// IRQ_EINT0 &amp;pins_desc[0]将被传入到中断服务程序</span>    <span class="token function">request_irq</span><span class="token punctuation">(</span>IRQ_EINT0<span class="token punctuation">,</span>  keys_irq<span class="token punctuation">,</span> IRQT_BOTHEDGE<span class="token punctuation">,</span> <span class="token string">"EINT0_S2"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pins_desc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">request_irq</span><span class="token punctuation">(</span>IRQ_EINT2<span class="token punctuation">,</span>  keys_irq<span class="token punctuation">,</span> IRQT_BOTHEDGE<span class="token punctuation">,</span> <span class="token string">"EINT0_S3"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pins_desc<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">request_irq</span><span class="token punctuation">(</span>IRQ_EINT11<span class="token punctuation">,</span> keys_irq<span class="token punctuation">,</span> IRQT_BOTHEDGE<span class="token punctuation">,</span> <span class="token string">"EINT0_S4"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pins_desc<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">request_irq</span><span class="token punctuation">(</span>IRQ_EINT19<span class="token punctuation">,</span> keys_irq<span class="token punctuation">,</span> IRQT_BOTHEDGE<span class="token punctuation">,</span> <span class="token string">"EINT0_S5"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pins_desc<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// read函数会被用户空间调用，可能while(1), 防止占用资源</span><span class="token class-name">ssize_t</span> <span class="token function">keys_read</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>ppos<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 判断缓冲区为1</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>filp<span class="token operator">-></span>f_flags <span class="token operator">&amp;</span> O_NONBLOCK<span class="token punctuation">)</span> <span class="token comment">// 非阻塞</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ev_press<span class="token punctuation">)</span> <span class="token comment">// 没有按键中断产生</span>            <span class="token keyword">return</span> <span class="token operator">-</span>EAGAIN<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span>                            <span class="token comment">// 阻塞</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">// 没有按键动作就休眠, 内部判断ev_press是否为0，为0则休眠，否则往下执行</span>        <span class="token comment">//  有休眠就有唤醒，唤醒在ISR中</span>        <span class="token function">wait_event_interruptible</span><span class="token punctuation">(</span>button_waitq<span class="token punctuation">,</span> ev_press<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// // 没有按键动作就休眠, 内部判断ev_press是否为0，为0则休眠，否则往下执行</span>    <span class="token comment">// //  有休眠就有唤醒，唤醒在ISR中</span>    <span class="token comment">// wait_event_interruptible(button_waitq, ev_press);</span>    <span class="token comment">// 将键值返回到用户空间</span>    <span class="token function">copy_to_user</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>key_val<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 中断事件标志，ISR将它置1, read 清0</span>    ev_press <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 释放中断的配置</span><span class="token keyword">int</span> <span class="token function">keys_close</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// canopen++; // 使用完配合前面打开时的--</span>    <span class="token comment">// atomic_inc(&amp;canopen); // 这个inc是配合判断里的dec</span>    <span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>canopen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 释放掉信号量</span>    <span class="token function">free_irq</span><span class="token punctuation">(</span>IRQ_EINT0<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pins_desc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free_irq</span><span class="token punctuation">(</span>IRQ_EINT2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pins_desc<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free_irq</span><span class="token punctuation">(</span>IRQ_EINT11<span class="token punctuation">,</span><span class="token operator">&amp;</span>pins_desc<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free_irq</span><span class="token punctuation">(</span>IRQ_EINT19<span class="token punctuation">,</span><span class="token operator">&amp;</span>pins_desc<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token function">keys_poll</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> poll_table <span class="token operator">*</span>wait<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> mask <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">// 将进程挂接到button_waitq等待队列下, 前面定义的button_waitq</span>    <span class="token function">poll_wait</span><span class="token punctuation">(</span>filp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>button_waitq<span class="token punctuation">,</span> wait<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 根据实际情况，标记事件类型 </span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ev_press<span class="token punctuation">)</span>        mask <span class="token operator">|=</span> POLLIN <span class="token operator">|</span> POLLRDNORM<span class="token punctuation">;</span>    <span class="token comment">// 如果mask为0，则没有请求事件发生；如果非零说明有事件发生</span>    <span class="token keyword">return</span> mask<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">keys_drv_async</span> <span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">int</span> on<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 用helper去初始化fasync_struct这个结构体，初始化之后就可以在IRQ中使用kill_fasync</span>    <span class="token keyword">return</span> <span class="token function">fasync_helper</span> <span class="token punctuation">(</span>fd<span class="token punctuation">,</span> filp<span class="token punctuation">,</span> on<span class="token punctuation">,</span> <span class="token operator">&amp;</span>keys_async_stct<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span>owner   <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>  <span class="token comment">// 这是一个宏，指向编译模块时自动创建的__this_module变量</span>    <span class="token punctuation">.</span>open    <span class="token operator">=</span> keys_open<span class="token punctuation">,</span>    <span class="token punctuation">.</span>read    <span class="token operator">=</span> keys_read<span class="token punctuation">,</span>    <span class="token punctuation">.</span>release <span class="token operator">=</span> keys_close<span class="token punctuation">,</span>    <span class="token punctuation">.</span>poll    <span class="token operator">=</span> keys_poll<span class="token punctuation">,</span>    <span class="token punctuation">.</span>fasync  <span class="token operator">=</span> keys_drv_async<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 时间处理函数，应该是超时后执行的</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">keys_timer_function</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// irq_pd是在中断函数中修改的引脚描述, 得到是哪个引脚引起的中断</span>    <span class="token keyword">struct</span> <span class="token class-name">pin_desc</span> <span class="token operator">*</span>pindesc <span class="token operator">=</span> irq_pd<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> pin_status<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pindesc<span class="token punctuation">)</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token comment">// 获取该引脚状态</span>    pin_status <span class="token operator">=</span> <span class="token function">s3c2410_gpio_getpin</span><span class="token punctuation">(</span>pindesc<span class="token operator">-></span>pin<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// printk("irq = %d\n", irq);</span>    <span class="token comment">// 判断引脚，给全局变量赋对应引脚的状态值 （状态--> 所属引脚）</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pin_status<span class="token punctuation">)</span> <span class="token comment">// 松开</span>    <span class="token punctuation">&#123;</span>        key_val <span class="token operator">=</span> <span class="token number">0x80</span> <span class="token operator">|</span> pindesc<span class="token operator">-></span>key_val<span class="token punctuation">;</span> <span class="token comment">// 存入自定义全局变量，在read中to_user</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span>            <span class="token comment">// 按下</span>    <span class="token punctuation">&#123;</span>        key_val <span class="token operator">=</span> <span class="token number">0x00</span> <span class="token operator">|</span> pindesc<span class="token operator">-></span>key_val<span class="token punctuation">;</span> <span class="token comment">// 存入自定义全局变量，在read中to_user</span>    <span class="token punctuation">&#125;</span>    ev_press <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 中断事件标志，ISR将它置1, read 清0</span>    <span class="token function">wake_up_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>button_waitq<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 向用户进程发送信号, 发给谁，在fasync_struct结构中应该指出，在此之前keys_async_stct应该在helper中被初始化</span>    <span class="token comment">//  用户程序用fcntl(fd, F_SETOWN, pid)告诉驱动程序，用户调用它时系统调用fops.fasync初始化fasync_struct</span><span class="token function">kill_fasync</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>keys_async_stct<span class="token punctuation">,</span> SIGIO<span class="token punctuation">,</span> POLL_IN<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">IRQ_RETVAL</span><span class="token punctuation">(</span>IRQ_HANDLED<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">keys_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 初始化</span>    <span class="token function">init_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>keys_timer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 处理函数</span>    keys_timer<span class="token punctuation">.</span>function <span class="token operator">=</span> keys_timer_function<span class="token punctuation">;</span>     <span class="token comment">// keys_timer.expires = 0;</span>    <span class="token function">add_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>keys_timer<span class="token punctuation">)</span><span class="token punctuation">;</span>    major <span class="token operator">=</span> <span class="token function">register_chrdev</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> DEVICE_NAME<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fops<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>major <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">printk</span><span class="token punctuation">(</span>DEVICE_NAME <span class="token string">" can't register major number.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> major<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    keys_class <span class="token operator">=</span> <span class="token function">class_create</span><span class="token punctuation">(</span>THIS_MODULE<span class="token punctuation">,</span> <span class="token string">"keys_class"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>keys_class<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>keys_class<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 在class里边创建一个设备叫xxx，然后mdev自动创建设备节点/dev/xxx</span>    <span class="token comment">//  在/dev目录下创建相应的设备节点，</span>    keys_class_dev <span class="token operator">=</span> <span class="token function">class_device_create</span><span class="token punctuation">(</span>keys_class<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"keys_all_node"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>keys_class_dev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>keys_class_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>     gpfcon <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">ioremap</span><span class="token punctuation">(</span><span class="token number">0x56000050</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    gpfdat <span class="token operator">=</span> gpfcon <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    gpgcon <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">ioremap</span><span class="token punctuation">(</span><span class="token number">0x56000060</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    gpgdat <span class="token operator">=</span> gpgcon <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>DEVICE_NAME <span class="token string">" device initialized successfully...\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">keys_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 对应卸载</span>    <span class="token function">unregister_chrdev</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> DEVICE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">class_device_unregister</span><span class="token punctuation">(</span>keys_class_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">class_destroy</span><span class="token punctuation">(</span>keys_class<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">iounmap</span><span class="token punctuation">(</span>gpfcon<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">iounmap</span><span class="token punctuation">(</span>gpgcon<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>keys_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>keys_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="用户代码"><a href="#用户代码" class="headerlink" title="用户代码"></a>用户代码</h1><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> fd<span class="token punctuation">,</span> ret<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> key_val<span class="token punctuation">;</span>    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/keys_all_node"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// 默认阻塞方式</span>    <span class="token comment">// fd = open("/dev/keys_all_node", O_RDWR | O_NONBLOCK); // 非阻塞方式</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"can't open '/dev/keys_all_node'.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>key_val<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"signal read key_val: 0x%x, ret: %d.\n"</span><span class="token punctuation">,</span> key_val<span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// sleep(3); // 单位s</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS1期第12课 字符设备驱动 8 异步互斥阻塞 同一时刻，只能有一个用户进程打开某个驱动程序（原子操作 互斥量 信号量）</title>
      <link href="2021/05/14/wds1-qi-di-12-ke-zi-fu-she-bei-qu-dong-8-yi-bu-hu-chi-zu-sai-tong-yi-shi-ke-zhi-neng-you-yi-ge-yong-hu-jin-cheng-da-kai-mou-ge-qu-dong-cheng-xu-yuan-zi-cao-zuo-hu-chi-liang-xin-hao-liang-local/"/>
      <url>2021/05/14/wds1-qi-di-12-ke-zi-fu-she-bei-qu-dong-8-yi-bu-hu-chi-zu-sai-tong-yi-shi-ke-zhi-neng-you-yi-ge-yong-hu-jin-cheng-da-kai-mou-ge-qu-dong-cheng-xu-yuan-zi-cao-zuo-hu-chi-liang-xin-hao-liang-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]<br><strong>信号量</strong>（semaphore[ˈseməfɔ:]）用在多线程多任务同步的，一个线程完成了某一个动作就通过信号量告诉别的线程，别的线程再进行某些动作。<br><strong>互斥锁</strong>（Mutual exclusion）是用在多线程多任务互斥的，一个线程占用了某一个资源，那么别的线程就无法访问，直到这个线程unlock，其他的线程才开始可以利用这个资源。</p><p>加入某个驱动程序，<strong>同一时刻，只能有一个用户进程打开某个驱动程序。</strong></p><h2 id="第一种方法static，有bug"><a href="#第一种方法static，有bug" class="headerlink" title="第一种方法static，有bug"></a>第一种方法static，有bug</h2><p>这种方法有漏洞，原因是 <code>canopen</code>这个变量对应的– ++操作不是原子操作，可以被打断，可能导致多个用户代码同时打开这个驱动。<br><code>--</code> <code>++</code>包含三步：读出 修改 写回</p><h3 id="驱动代码中修改"><a href="#驱动代码中修改" class="headerlink" title="驱动代码中修改"></a>驱动代码中修改</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">定义这个全局<span class="token keyword">static</span>变量，<span class="token comment">// 使用static来允许同一时刻只有一个用户使用驱动程序</span><span class="token keyword">static</span> <span class="token keyword">int</span> canopen <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>在open里边，<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">keys_open</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filep<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>       <span class="token comment">// static同时只有一个用户使用drv</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>canopen <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">// 这个++是配合判断里的--</span>        canopen<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    在close里，<span class="token keyword">int</span> <span class="token function">keys_close</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>canopen<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// 使用完配合前面打开时的--</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="原子操作"><a href="#原子操作" class="headerlink" title="原子操作"></a>原子操作</h2><h3 id="对应的API"><a href="#对应的API" class="headerlink" title="对应的API"></a>对应的API</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">原子操作原子操作指的是在执行过程中不会被别的代码路径所中断的操作。常用原子操作函数举例：<span class="token class-name">atomic_t</span> v <span class="token operator">=</span> <span class="token function">ATOMIC_INIT</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//定义原子变量v并初始化为0</span><span class="token function">atomic_read</span><span class="token punctuation">(</span><span class="token class-name">atomic_t</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//返回原子变量的值</span><span class="token keyword">void</span> <span class="token function">atomic_inc</span><span class="token punctuation">(</span><span class="token class-name">atomic_t</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//原子变量增加1</span><span class="token keyword">void</span> <span class="token function">atomic_dec</span><span class="token punctuation">(</span><span class="token class-name">atomic_t</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//原子变量减少1</span><span class="token keyword">int</span> <span class="token function">atomic_dec_and_test</span><span class="token punctuation">(</span><span class="token class-name">atomic_t</span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//自减操作后测试其是否为0，为0则返回true，否则返回false。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="驱动代码中修改-1"><a href="#驱动代码中修改-1" class="headerlink" title="驱动代码中修改"></a>驱动代码中修改</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">定义这个全局原子变量，<span class="token comment">// 使用原子操作,定义原子变量并初始化为1</span><span class="token keyword">static</span> <span class="token class-name">atomic_t</span> canopen <span class="token operator">=</span> <span class="token function">ATOMIC_INIT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>在open里边，<span class="token comment">// 原子变量自减test, 如果自减之后为0则返回true</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">atomic_dec_and_test</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>canopen<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 这个inc是配合判断里的dec</span>    <span class="token function">atomic_inc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>canopen<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>    在close里，<span class="token keyword">int</span> <span class="token function">keys_close</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 这个inc是配合判断里的dec</span>    <span class="token function">atomic_inc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>canopen<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="用户代码-原子操作和信号量一样"><a href="#用户代码-原子操作和信号量一样" class="headerlink" title="用户代码  原子操作和信号量一样"></a>用户代码  原子操作和信号量一样</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token keyword">int</span> fd<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">signal_func</span><span class="token punctuation">(</span><span class="token keyword">int</span> sign<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> key_val<span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>key_val<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"signal read key_val: 0x%x.\n"</span><span class="token punctuation">,</span> key_val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> oflag<span class="token punctuation">;</span>    <span class="token comment">// 1. 应用程序注册信号处理函数</span>    <span class="token comment">// 2. 谁发，在驱动程序中IRQ中kill_fasync发</span>    <span class="token comment">//      驱动代码的kill_fasync (&amp;keys_async, SIGIO, POLL_IN);通知用户signal函数</span>    <span class="token function">signal</span><span class="token punctuation">(</span>SIGIO<span class="token punctuation">,</span> signal_func<span class="token punctuation">)</span><span class="token punctuation">;</span>    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/k_smb_node"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"can't open '/dev/k_smb_node'.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 3. 发给谁，应用程序通过这里告诉驱动程序 发给这个pid</span>    <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_SETOWN<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 改变oflag之后驱动程序中的fops.fasync才会被调用，</span>    <span class="token comment">//      fasync被调用之后才用helper去初始化fasync_struct这个结构体</span>    <span class="token comment">//      那个结构体被初始化后，驱动才知道向谁发信号</span>    oflag <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> oflag <span class="token operator">|</span> FASYNC<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="信号量"><a href="#信号量" class="headerlink" title="信号量"></a>信号量</h2><p>申请信号量，<br>如果申请不到信号量，要么返回要么休眠，<br>如果申请到了就可以继续操作，完毕之后需要释放信号量，<br>释放之后，如果有其他用户代码在等待这个信号量的话，那就去唤醒应用程序</p><h3 id="对应的API-1"><a href="#对应的API-1" class="headerlink" title="对应的API"></a>对应的API</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">定义信号量<span class="token keyword">struct</span> <span class="token class-name">semaphore</span> sem<span class="token punctuation">;</span>初始化信号量<span class="token keyword">void</span> <span class="token function">sema_init</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">semaphore</span> <span class="token operator">*</span>sem<span class="token punctuation">,</span> <span class="token keyword">int</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">init_MUTEX</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">semaphore</span> <span class="token operator">*</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化为0</span><span class="token keyword">static</span> <span class="token function">DECLARE_MUTEX</span><span class="token punctuation">(</span>button_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//定义互斥锁</span>获得信号量<span class="token keyword">void</span> <span class="token function">down</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">semaphore</span> <span class="token operator">*</span> sem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 不可被打断</span><span class="token keyword">int</span> <span class="token function">down_interruptible</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">semaphore</span> <span class="token operator">*</span> sem<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 可被打断，</span><span class="token keyword">int</span> <span class="token function">down_trylock</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">semaphore</span> <span class="token operator">*</span> sem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 如果获取不到就立刻返回，需要判断返回值</span>释放信号量<span class="token keyword">void</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">semaphore</span> <span class="token operator">*</span> sem<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="驱动代码中修改-2"><a href="#驱动代码中修改-2" class="headerlink" title="驱动代码中修改"></a>驱动代码中修改</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">定义信号量，<span class="token comment">// 使用信号量， </span><span class="token keyword">static</span> <span class="token function">DECLARE_MUTEX</span><span class="token punctuation">(</span>canopen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 定义互斥锁</span>在open里边，<span class="token comment">// 获取信号量，获取不到不可被打断，kill不掉</span><span class="token function">down</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>canopen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// down_interruptible();获取不到就休眠，休眠中不可以被打断</span>    在close里，<span class="token keyword">int</span> <span class="token function">keys_close</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>canopen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 释放掉信号量</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以打开多个用户程序，但是只有一个用户打开了驱动程序，其他用户处于<code>D</code>状态，是不可中断的睡眠状态，等待别人释放那个信号量，而且杀不掉状态为<code>D</code>的进程。<br><img src="/images/20191226103112220.png"><br>杀掉811进程，812获得了信号了，杀不掉状态为<code>D</code>的进程。<br><img src="/images/20191226103445818.png"></p><h2 id="阻塞"><a href="#阻塞" class="headerlink" title="阻塞"></a>阻塞</h2><p>等待直到读到值，阻塞<br>不等待，读不到就直接返回错误，非阻塞</p><h3 id="对应的API-2"><a href="#对应的API-2" class="headerlink" title="对应的API"></a>对应的API</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">阻塞阻塞操作    是指在执行设备操作时若不能获得资源则挂起进程，直到满足可操作的条件后再进行操作。被挂起的进程进入休眠状态，被从调度器的运行队列移走，直到等待的条件被满足。非阻塞操作  进程在不能进行设备操作时并不挂起，它或者放弃，或者不停地查询，直至可以进行操作为止。fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"..."</span><span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="驱动代码修改"><a href="#驱动代码修改" class="headerlink" title="驱动代码修改"></a>驱动代码修改</h3><p>驱动代码在open和read里要判断<code>filp-&gt;f_flags &amp; O_NONBLOCK</code></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span>     <span class="token comment">// module_init module_exit</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span>   <span class="token comment">// MODULE_LICENSE</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span>       <span class="token comment">// file_operations</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h></span>     <span class="token comment">// cdev</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h></span>   <span class="token comment">// class_device</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/irq.h></span>      <span class="token comment">// IRQ_EINTx</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/uaccess.h></span>    <span class="token comment">// copy_from_user copy_to_user</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h></span>         <span class="token comment">// ioremap  iounmap</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/irq.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/regs-gpio.h></span> <span class="token comment">// S3C2410_GPFx</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/poll.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEVICE_NAME</span>      <span class="token string">"keys_smb"</span></span><span class="token keyword">int</span> major<span class="token punctuation">;</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpfcon <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpfdat <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpgcon <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpgdat <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPFCON</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span>gpfcon<span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPFDAT</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span>gpfdat<span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPGCON</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span>gpgcon<span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPGDAT</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span>gpgdat<span class="token punctuation">)</span></span></span><span class="token comment">// 使用static来允许同一时刻只有一个用户使用驱动程序</span><span class="token comment">// static int canopen = 1;</span><span class="token comment">// 使用原子操作,定义原子变量并初始化为1</span><span class="token comment">// static atomic_t canopen = ATOMIC_INIT(1);</span><span class="token comment">// 使用信号量， </span><span class="token keyword">static</span> <span class="token function">DECLARE_MUTEX</span><span class="token punctuation">(</span>canopen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 定义互斥锁</span><span class="token comment">// 异步通知用户程序 需要的保存用户pid等信息的结构体</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">fasync_struct</span> <span class="token operator">*</span>keys_async_stct<span class="token punctuation">;</span><span class="token comment">// 用于自动创建设备节点的结构class 和 class_device</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>keys_class<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">class_device</span> <span class="token operator">*</span>keys_class_dev<span class="token punctuation">;</span><span class="token comment">/* 定义一个等待队列button_waitq，这个等待队列实际上是由中断驱动的，    当中断发生时，会令挂接到这个等待队列的休眠进程唤醒 */</span><span class="token keyword">static</span> <span class="token function">DECLARE_WAIT_QUEUE_HEAD</span><span class="token punctuation">(</span>button_waitq<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 中断事件标志，ISR将它置1, read 清0</span><span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> ev_press <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 自定义引脚描述的结构</span><span class="token keyword">struct</span> <span class="token class-name">pin_desc</span><span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> pin<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> key_val<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">/*键值：按下，0x01,0x02,0x03,0x04  键值：松开，0x81,0x82,0x83,0x84*/</span><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> key_val<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">pin_desc</span> pins_desc<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#123;</span>S3C2410_GPF0<span class="token punctuation">,</span>  <span class="token number">0x01</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>S3C2410_GPF2<span class="token punctuation">,</span>  <span class="token number">0x02</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>S3C2410_GPG3<span class="token punctuation">,</span>  <span class="token number">0x03</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>S3C2410_GPG11<span class="token punctuation">,</span> <span class="token number">0x04</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// ISR 发生中断之后会调用这个函数, irq就是对应的中断号</span><span class="token keyword">static</span> <span class="token class-name">irqreturn_t</span> <span class="token function">keys_irq</span><span class="token punctuation">(</span><span class="token keyword">int</span> irq<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dev_id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">pin_desc</span> <span class="token operator">*</span>pindesc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pin_desc</span> <span class="token operator">*</span><span class="token punctuation">)</span>dev_id<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> pin_status<span class="token punctuation">;</span>        <span class="token comment">// 获取引脚状态</span>    pin_status <span class="token operator">=</span> <span class="token function">s3c2410_gpio_getpin</span><span class="token punctuation">(</span>pindesc<span class="token operator">-></span>pin<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// printk("irq = %d\n", irq);</span>    <span class="token comment">// 判断引脚，给全局变量赋对应引脚的状态值 （状态--> 所属引脚）</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pin_status<span class="token punctuation">)</span> <span class="token comment">// 松开</span>    <span class="token punctuation">&#123;</span>        key_val <span class="token operator">=</span> <span class="token number">0x80</span> <span class="token operator">|</span> pindesc<span class="token operator">-></span>key_val<span class="token punctuation">;</span> <span class="token comment">// 存入自定义全局变量，在read中to_user</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span>            <span class="token comment">// 按下</span>    <span class="token punctuation">&#123;</span>        key_val <span class="token operator">=</span> <span class="token number">0x00</span> <span class="token operator">|</span> pindesc<span class="token operator">-></span>key_val<span class="token punctuation">;</span> <span class="token comment">// 存入自定义全局变量，在read中to_user</span>    <span class="token punctuation">&#125;</span>    ev_press <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 中断事件标志，ISR将它置1, read 清0</span>    <span class="token function">wake_up_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>button_waitq<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 向用户进程发送信号, 发给谁，在fasync_struct结构中应该指出，在此之前keys_async_stct应该在helper中被初始化</span>    <span class="token comment">//  用户程序用fcntl(fd, F_SETOWN, pid)告诉驱动程序，用户调用它时系统调用fops.fasync初始化fasync_struct</span><span class="token function">kill_fasync</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>keys_async_stct<span class="token punctuation">,</span> SIGIO<span class="token punctuation">,</span> POLL_IN<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">IRQ_RETVAL</span><span class="token punctuation">(</span>IRQ_HANDLED<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// GPF0/2 GPG3/11 申请中断</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">keys_open</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>       <span class="token comment">// // static同时只有一个用户使用drv</span>    <span class="token comment">// if (--canopen != 0)</span>    <span class="token comment">// &#123;</span>    <span class="token comment">//     // 这个++是配合判断里的--</span>    <span class="token comment">//     canopen++;</span>    <span class="token comment">//     return -EBUSY;</span>    <span class="token comment">// &#125;</span>    <span class="token comment">// 原子变量自减test, 如果自减之后为0则返回true</span>    <span class="token comment">// if (!atomic_dec_and_test(&amp;canopen))</span>    <span class="token comment">// &#123;</span>    <span class="token comment">//     // 这个inc是配合判断里的dec</span>    <span class="token comment">//     atomic_inc(&amp;canopen);</span>    <span class="token comment">//     return -EBUSY;</span>    <span class="token comment">// &#125;</span>    <span class="token comment">// 获取信号量，获取不到不可被打断，kill不掉</span>    <span class="token comment">// down(&amp;canopen); // down_interruptible();获取不到就休眠，休眠中可以被打断</span>    <span class="token comment">// 阻塞与非阻塞</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>filp<span class="token operator">-></span>f_flags <span class="token operator">&amp;</span> O_NONBLOCK<span class="token punctuation">)</span> <span class="token comment">// 非阻塞，</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">// 非阻塞，如果获取不了锁就应该立即返回</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">down_trylock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>canopen<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span>                            <span class="token comment">// 阻塞</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">// 获取信号量，获取不到就休眠等待那个锁，kill不掉</span>        <span class="token function">down</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>canopen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// down_interruptible();获取不到就休眠，休眠中可以被打断</span>    <span class="token punctuation">&#125;</span>        <span class="token comment">/**********************************************************    中断控制器的初始化（底层）在irq_chip结构体中定义；    自定义的处理函数以desc为索引，在action链表中；        struct irq_desc        struct irq_chip        action    需用通过注册的机制将他们联系起来:        request_irq()        free_irq()    中断的顶半部和底半部：        顶半部：            在request_irq中传入的handler就是它，会屏蔽中断，行紧急之事开销小，如flag，读写IO寄存器等等，然后将下半部处理函数挂在到底半部的执行队列中去        底半部：            执行耗时工作，可以被打断，底半部机制包括：                 tasklet：使系统在适当时调度运行                工作队列：将工作推后执行的机制，推后的工作交由一个内核线程去执行，优势是允许重新调度甚至睡眠                软中断：一般写驱动不用也宜使用    ***********************************************************/</span>    <span class="token comment">/*    *@irq: Interrupt line to allocate    *@handler: Function to be called when the IRQ occurs    *@irqflags: Interrupt type flags    *@devname: An ascii name for the claiming device    *@dev_id: A cookie passed back to the handler function    */</span>    <span class="token comment">// 中断引脚，自动设备为中断引脚，</span>    <span class="token comment">//  IRQ_EINT0在include/asm-arm/arch-s3c2410/irqs.h中定义</span>    <span class="token comment">//  keys_irq</span>    <span class="token comment">//  IRQT_BOTHEDGE双边沿触发</span>    <span class="token comment">//  "EINT0_S2"</span>    <span class="token comment">// IRQ_EINT0 &amp;pins_desc[0]将被传入到中断服务程序</span>    <span class="token function">request_irq</span><span class="token punctuation">(</span>IRQ_EINT0<span class="token punctuation">,</span>  keys_irq<span class="token punctuation">,</span> IRQT_BOTHEDGE<span class="token punctuation">,</span> <span class="token string">"EINT0_S2"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pins_desc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">request_irq</span><span class="token punctuation">(</span>IRQ_EINT2<span class="token punctuation">,</span>  keys_irq<span class="token punctuation">,</span> IRQT_BOTHEDGE<span class="token punctuation">,</span> <span class="token string">"EINT0_S3"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pins_desc<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">request_irq</span><span class="token punctuation">(</span>IRQ_EINT11<span class="token punctuation">,</span> keys_irq<span class="token punctuation">,</span> IRQT_BOTHEDGE<span class="token punctuation">,</span> <span class="token string">"EINT0_S4"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pins_desc<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">request_irq</span><span class="token punctuation">(</span>IRQ_EINT19<span class="token punctuation">,</span> keys_irq<span class="token punctuation">,</span> IRQT_BOTHEDGE<span class="token punctuation">,</span> <span class="token string">"EINT0_S5"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pins_desc<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// read函数会被用户空间调用，可能while(1), 防止占用资源</span><span class="token class-name">ssize_t</span> <span class="token function">keys_read</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>ppos<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 判断缓冲区为1</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>filp<span class="token operator">-></span>f_flags <span class="token operator">&amp;</span> O_NONBLOCK<span class="token punctuation">)</span> <span class="token comment">// 非阻塞</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ev_press<span class="token punctuation">)</span> <span class="token comment">// 没有按键中断产生</span>            <span class="token keyword">return</span> <span class="token operator">-</span>EAGAIN<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span>                            <span class="token comment">// 阻塞</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">// 没有按键动作就休眠, 内部判断ev_press是否为0，为0则休眠，否则往下执行</span>        <span class="token comment">//  有休眠就有唤醒，唤醒在ISR中</span>        <span class="token function">wait_event_interruptible</span><span class="token punctuation">(</span>button_waitq<span class="token punctuation">,</span> ev_press<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// // 没有按键动作就休眠, 内部判断ev_press是否为0，为0则休眠，否则往下执行</span>    <span class="token comment">// //  有休眠就有唤醒，唤醒在ISR中</span>    <span class="token comment">// wait_event_interruptible(button_waitq, ev_press);</span>    <span class="token comment">// 将键值返回到用户空间</span>    <span class="token function">copy_to_user</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>key_val<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 中断事件标志，ISR将它置1, read 清0</span>    ev_press <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 释放中断的配置</span><span class="token keyword">int</span> <span class="token function">keys_close</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// canopen++; // 使用完配合前面打开时的--</span>    <span class="token comment">// atomic_inc(&amp;canopen); // 这个inc是配合判断里的dec</span>    <span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>canopen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 释放掉信号量</span>    <span class="token function">free_irq</span><span class="token punctuation">(</span>IRQ_EINT0<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pins_desc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free_irq</span><span class="token punctuation">(</span>IRQ_EINT2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pins_desc<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free_irq</span><span class="token punctuation">(</span>IRQ_EINT11<span class="token punctuation">,</span><span class="token operator">&amp;</span>pins_desc<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free_irq</span><span class="token punctuation">(</span>IRQ_EINT19<span class="token punctuation">,</span><span class="token operator">&amp;</span>pins_desc<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token function">keys_poll</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> poll_table <span class="token operator">*</span>wait<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> mask <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">// 将进程挂接到button_waitq等待队列下, 前面定义的button_waitq</span>    <span class="token function">poll_wait</span><span class="token punctuation">(</span>filp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>button_waitq<span class="token punctuation">,</span> wait<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 根据实际情况，标记事件类型 </span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ev_press<span class="token punctuation">)</span>        mask <span class="token operator">|=</span> POLLIN <span class="token operator">|</span> POLLRDNORM<span class="token punctuation">;</span>    <span class="token comment">// 如果mask为0，则没有请求事件发生；如果非零说明有事件发生</span>    <span class="token keyword">return</span> mask<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">keys_drv_async</span> <span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">int</span> on<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 用helper去初始化fasync_struct这个结构体，初始化之后就可以在IRQ中使用kill_fasync</span>    <span class="token keyword">return</span> <span class="token function">fasync_helper</span> <span class="token punctuation">(</span>fd<span class="token punctuation">,</span> filp<span class="token punctuation">,</span> on<span class="token punctuation">,</span> <span class="token operator">&amp;</span>keys_async_stct<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span>owner   <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>    <span class="token punctuation">.</span>open    <span class="token operator">=</span> keys_open<span class="token punctuation">,</span>    <span class="token punctuation">.</span>read    <span class="token operator">=</span> keys_read<span class="token punctuation">,</span>    <span class="token punctuation">.</span>release <span class="token operator">=</span> keys_close<span class="token punctuation">,</span>    <span class="token punctuation">.</span>poll    <span class="token operator">=</span> keys_poll<span class="token punctuation">,</span>    <span class="token punctuation">.</span>fasync  <span class="token operator">=</span> keys_drv_async<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">keys_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    major <span class="token operator">=</span> <span class="token function">register_chrdev</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> DEVICE_NAME<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fops<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>major <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">printk</span><span class="token punctuation">(</span>DEVICE_NAME <span class="token string">" can't register major number.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> major<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    keys_class <span class="token operator">=</span> <span class="token function">class_create</span><span class="token punctuation">(</span>THIS_MODULE<span class="token punctuation">,</span> <span class="token string">"keys_class"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>keys_class<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>keys_class<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 在class里边创建一个设备叫xxx，然后mdev自动创建设备节点/dev/xxx</span>    <span class="token comment">//  在/dev目录下创建相应的设备节点，</span>    keys_class_dev <span class="token operator">=</span> <span class="token function">class_device_create</span><span class="token punctuation">(</span>keys_class<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"k_smb_node"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>keys_class_dev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>keys_class_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>     gpfcon <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">ioremap</span><span class="token punctuation">(</span><span class="token number">0x56000050</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    gpfdat <span class="token operator">=</span> gpfcon <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    gpgcon <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">ioremap</span><span class="token punctuation">(</span><span class="token number">0x56000060</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    gpgdat <span class="token operator">=</span> gpgcon <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>DEVICE_NAME <span class="token string">" device initialized successfully...\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">keys_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 对应卸载</span>    <span class="token function">unregister_chrdev</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> DEVICE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">class_device_unregister</span><span class="token punctuation">(</span>keys_class_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">class_destroy</span><span class="token punctuation">(</span>keys_class<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">iounmap</span><span class="token punctuation">(</span>gpfcon<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">iounmap</span><span class="token punctuation">(</span>gpgcon<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>keys_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>keys_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="用户代码修改"><a href="#用户代码修改" class="headerlink" title="用户代码修改"></a>用户代码修改</h3><p>阻塞或者非阻塞方式open</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> fd<span class="token punctuation">,</span> ret<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> key_val<span class="token punctuation">;</span>    <span class="token comment">// fd = open("/dev/k_smb_node", O_RDWR); // 默认阻塞方式</span>    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/k_smb_node"</span><span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 非阻塞方式</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"can't open '/dev/k_smb_node'.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>key_val<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"signal read key_val: 0x%x, ret: %d.\n"</span><span class="token punctuation">,</span> key_val<span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 单位s</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="验证结果"><a href="#验证结果" class="headerlink" title="验证结果"></a>验证结果</h3><p>插入内核    驱动模块，后台运行用户代码，不阻塞，按下按键返回按键值。<br><img src="/images/20191226115618996.png"></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS1期第12课 字符设备驱动 7 async异步通知用户空间 驱动代码的kill_fasync函数通知用户的signal函数 fcntl</title>
      <link href="2021/05/14/wds1-qi-di-12-ke-zi-fu-she-bei-qu-dong-7-async-yi-bu-tong-zhi-yong-hu-kong-jian-qu-dong-dai-ma-de-kill-fasync-han-shu-tong-zhi-yong-hu-de-signal-han-shu-fcntl-local/"/>
      <url>2021/05/14/wds1-qi-di-12-ke-zi-fu-she-bei-qu-dong-7-async-yi-bu-tong-zhi-yong-hu-kong-jian-qu-dong-dai-ma-de-kill-fasync-han-shu-tong-zhi-yong-hu-de-signal-han-shu-fcntl-local/</url>
      
        <content type="html"><![CDATA[<p>前面的query interrupt poll都需要用户程序去主动去读或查询。<br>async异步通知—可以<strong>由驱动程序主动去通知用户程序</strong>中断的到来。</p><p>信号也可以通知TASK_INTERRUPTIBLE的进程，SIGKILL可以杀掉任何进程，就是传说中的信号9，无法阻挡无法被应用覆盖的终极杀器。列出所有信号：<code>kill -l</code><br><img src="/images/20200408094002319.png"></p><h2 id="1-test进程间发信号"><a href="#1-test进程间发信号" class="headerlink" title="1. test进程间发信号"></a>1. test进程间发信号</h2><p>后台运行该用户进程后，通过<code>kill -USR1 PID</code>，<code>kill -10 PID</code>传递参数，<br><code>kill -9 PID</code> 杀掉进程。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span><span class="token keyword">void</span> <span class="token function">signal_func</span><span class="token punctuation">(</span><span class="token keyword">int</span> sign<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"signal: %d, %d times.\n"</span><span class="token punctuation">,</span> signal<span class="token punctuation">,</span> <span class="token operator">++</span>cnt<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// kill -USR1 PID == kill -10 PID</span><span class="token comment">// kill -9 PID // 杀掉进程</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span>argc <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 信号处理函数, </span>    <span class="token function">signal</span><span class="token punctuation">(</span>SIGUSR1<span class="token punctuation">,</span> signal_func<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>进程间传递参数要点：</p><ol><li>注册信号处理函数</li><li>谁来发</li><li>发给谁</li><li>怎么收</li></ol><h2 id="2-驱动代码通知用户异步接收信号"><a href="#2-驱动代码通知用户异步接收信号" class="headerlink" title="2. 驱动代码通知用户异步接收信号"></a>2. 驱动代码通知用户异步接收信号</h2><p>我们的目标是有中断产生时（按键按下），驱动程序去通知用户程序。</p><ol><li>用户代码需要注册信号处理函数 <code>signal(SIGIO, signal_func);</code></li><li>由驱动程序发信号 </li><li>发给用户程序，用户程序要告诉驱动 自己的pid <code>   fcntl(fd, F_SETOWN, getpid());</code></li><li>驱动程序调用某个函数来发 <code>kill_fasync (&amp;keys_async_stct, SIGIO, POLL_IN);</code>，keys_async_stct中包含用户进程的id</li></ol><p>用户程序中需要做的事情：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token number">1.</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_SETOWN<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 告诉内核，用户进程的pid</span><span class="token number">2.</span> oflag <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// </span><span class="token number">3.</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> oflag <span class="token operator">|</span> FASYNC<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 改变fasync标记，最终调用.fasync > fasync_helper(初始化/释放fasync_struct)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="2-1-驱动增加的代码"><a href="#2-1-驱动增加的代码" class="headerlink" title="2.1 驱动增加的代码"></a>2.1 驱动增加的代码</h3><p>增加一个结构体，保存用户传入的pid等等，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">fasync_struct</span> <span class="token operator">*</span>keys_async_stct<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ISR中增加一行向用户发送异步信号的代码，kill_fasync，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 向用户进程发送信号, 发给谁，在fasync_struct结构中应该指出，</span><span class="token comment">//   在此之前keys_async_stct应该在helper中被初始化</span><span class="token comment">// 用户程序用fcntl(fd, F_SETOWN, pid)告诉驱动程序，</span><span class="token comment">//   用户调用它时系统调用fops.fasync初始化fasync_struct</span><span class="token function">kill_fasync</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>keys_async_stct<span class="token punctuation">,</span> SIGIO<span class="token punctuation">,</span> POLL_IN<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>fops增加初始化一个函数指针，以及对应的函数去初始化fasync_struct这个结构体，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">.</span>fasync  <span class="token operator">=</span> keys_drv_async<span class="token punctuation">,</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">keys_drv_async</span> <span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">int</span> on<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 用helper去初始化fasync_struct这个结构体，初始化之后就可以在IRQ中使用kill_fasync</span>    <span class="token keyword">return</span> <span class="token function">fasync_helper</span> <span class="token punctuation">(</span>fd<span class="token punctuation">,</span> filp<span class="token punctuation">,</span> on<span class="token punctuation">,</span> <span class="token operator">&amp;</span>keys_async_stct<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-2-用户代码"><a href="#2-2-用户代码" class="headerlink" title="2.2 用户代码"></a>2.2 用户代码</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span><span class="token keyword">int</span> fd<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">signal_func</span><span class="token punctuation">(</span><span class="token keyword">int</span> sign<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> key_val<span class="token punctuation">;</span>    <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>key_val<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"signal read key_val: 0x%x.\n"</span><span class="token punctuation">,</span> key_val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> oflag<span class="token punctuation">;</span>    <span class="token comment">// 1. 应用程序注册信号处理函数</span>    <span class="token comment">// 2. 谁发，在驱动程序中IRQ中kill_fasync发</span>    <span class="token comment">//      驱动代码的kill_fasync (&amp;keys_async, SIGIO, POLL_IN);通知用户signal函数</span>    <span class="token function">signal</span><span class="token punctuation">(</span>SIGIO<span class="token punctuation">,</span> signal_func<span class="token punctuation">)</span><span class="token punctuation">;</span>    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/k_async_node"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"can't open '/dev/k_async_node'.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 3. 发给谁，应用程序通过这里告诉驱动程序 发给这个pid</span>    <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_SETOWN<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 改变oflag之后驱动程序中的fops.fasync才会被调用，</span>    <span class="token comment">//      fasync被调用之后才用helper去初始化fasync_struct这个结构体</span>    <span class="token comment">//      那个结构体被初始化后，驱动才知道向谁发信号</span>    oflag <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> oflag <span class="token operator">|</span> FASYNC<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS1期第12课 字符设备驱动 5 key 中断 exec 在irq中读取引脚 休眠 DECLARE_WAIT_QUEUE_HEAD wake_up_ wait_event_interrupti</title>
      <link href="2021/05/14/wds1-qi-di-12-ke-zi-fu-she-bei-qu-dong-5-key-zhong-duan-exec-zai-irq-zhong-du-qu-yin-jiao-xiu-mian-declare-wait-queue-head-wake-up-wait-event-interrupti-local/"/>
      <url>2021/05/14/wds1-qi-di-12-ke-zi-fu-she-bei-qu-dong-5-key-zhong-duan-exec-zai-irq-zhong-du-qu-yin-jiao-xiu-mian-declare-wait-queue-head-wake-up-wait-event-interrupti-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]<br>单片机开发</p><ol><li>有按键按下</li><li>cpu中断，强制跳转到中断入口执行</li><li>在中断入口函数中</li><li>1 保存现场（各种寄存器的值）</li><li>2 执行中断处理函数</li><li>3 恢复现场</li></ol><p><a href="https://www.cnblogs.com/zongzi10010/p/10003477.html">他人优秀总结 字符设备驱动三 中断框架</a><br>中断描述符表（Interrupt Descriptor Table，IDT）<a href="https://r00tk1ts.github.io/2017/12/21/Linux%E4%B8%AD%E6%96%AD%E5%86%85%E5%B9%95/">大佬的链接</a><br>整个流程：<br><img src="/images/20200405111946854.png"><br><img src="/images/20200405112019484.png"></p><p>Linux<br>设置异常入口，linux异常向量的基地址为0xFFFF0000（8字节），这个是虚拟地址，建立与物理地址的映射之后需要把异常向量表复制到0xFFFF0000对应的物理地址，<br>arch/arm/kernel/traps.c，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> __init <span class="token function">trap_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">/* * Copy the vectors, stubs and kuser helpers (in entry-armv.S) * into the vector page, mapped at 0xffff0000, and ensure these * are visible to the instruction stream. */</span><span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>vectors<span class="token punctuation">,</span> __vectors_start<span class="token punctuation">,</span> __vectors_end <span class="token operator">-</span> __vectors_start<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>vectors <span class="token operator">+</span> <span class="token number">0x200</span><span class="token punctuation">,</span> __stubs_start<span class="token punctuation">,</span> __stubs_end <span class="token operator">-</span> __stubs_start<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>vectors <span class="token operator">+</span> <span class="token number">0x1000</span> <span class="token operator">-</span> kuser_sz<span class="token punctuation">,</span> __kuser_helper_start<span class="token punctuation">,</span> kuser_sz<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其中，<br>vecotrs的值在include/linux/autoconf.h中定义<code>#define CONFIG_VECTORS_BASE 0xffff0000</code><br>__vectors_start在arch/arm/kernel/entry-armv.S中表示如下，就是汇编指令跳转到某个地址，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">.</span>globl__vectors_start__vectors_start<span class="token operator">:</span>swiSYS_ERROR0bvector_und <span class="token operator">+</span> stubs_offsetldrpc<span class="token punctuation">,</span> <span class="token punctuation">.</span>LCvswi <span class="token operator">+</span> stubs_offsetbvector_pabt <span class="token operator">+</span> stubs_offsetbvector_dabt <span class="token operator">+</span> stubs_offsetbvector_addrexcptn <span class="token operator">+</span> stubs_offsetbvector_irq <span class="token operator">+</span> stubs_offsetbvector_fiq <span class="token operator">+</span> stubs_offset<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>vector_und也在entry-armv.S中，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">vector_stubund<span class="token punctuation">,</span> UND_MODE<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>macrovector_stub<span class="token punctuation">,</span> name<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> correction<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span>align<span class="token number">5</span>vector_\name<span class="token operator">:</span><span class="token punctuation">.</span><span class="token keyword">if</span> \correctionsublr<span class="token punctuation">,</span> lr<span class="token punctuation">,</span> #\correction<span class="token punctuation">.</span>endif@@ Save r0<span class="token punctuation">,</span> lr_<span class="token operator">&lt;</span>exception<span class="token operator">></span> <span class="token punctuation">(</span>parent PC<span class="token punctuation">)</span> and spsr_<span class="token operator">&lt;</span>exception<span class="token operator">></span>@ <span class="token punctuation">(</span>parent CPSR<span class="token punctuation">)</span>@stmiasp<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>r0<span class="token punctuation">,</span> lr<span class="token punctuation">&#125;</span>@ save r0<span class="token punctuation">,</span> lrmrslr<span class="token punctuation">,</span> spsrstrlr<span class="token punctuation">,</span> <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">8</span><span class="token punctuation">]</span>@ save spsr@@ Prepare <span class="token keyword">for</span> SVC32 mode<span class="token punctuation">.</span>  IRQs remain disabled<span class="token punctuation">.</span>@mrsr0<span class="token punctuation">,</span> cpsreorr0<span class="token punctuation">,</span> r0<span class="token punctuation">,</span> #<span class="token punctuation">(</span>\mode <span class="token operator">^</span> SVC_MODE<span class="token punctuation">)</span>msrspsr_cxsf<span class="token punctuation">,</span> r0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>展开，是一个宏定义的，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">vector_und<span class="token operator">:</span>@@ Save r0<span class="token punctuation">,</span> lr_<span class="token operator">&lt;</span>exception<span class="token operator">></span> <span class="token punctuation">(</span>parent PC<span class="token punctuation">)</span> and spsr_<span class="token operator">&lt;</span>exception<span class="token operator">></span>@ <span class="token punctuation">(</span>parent CPSR<span class="token punctuation">)</span>@stmiasp<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>r0<span class="token punctuation">,</span> lr<span class="token punctuation">&#125;</span>@ save r0<span class="token punctuation">,</span> lrmrslr<span class="token punctuation">,</span> spsrstrlr<span class="token punctuation">,</span> <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #<span class="token number">8</span><span class="token punctuation">]</span>@ save spsr@@ Prepare <span class="token keyword">for</span> SVC32 mode<span class="token punctuation">.</span>  IRQs remain disabled<span class="token punctuation">.</span>@mrsr0<span class="token punctuation">,</span> cpsreorr0<span class="token punctuation">,</span> r0<span class="token punctuation">,</span> #<span class="token punctuation">(</span>\mode <span class="token operator">^</span> SVC_MODE<span class="token punctuation">)</span>msrspsr_cxsf<span class="token punctuation">,</span> r0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>trap_init拷贝异常向量的表到0xffff0000，<br>跳转到具体的某个向量时，计算返回地址—保存寄存器值—调用处理函数（asm_do_IRQ[C函数]）—恢复</strong>。流程如下图，完全开发手册第415页<br><img src="/images/20191220225116435.png"></p><h2 id="解析asm-do-IRQ"><a href="#解析asm-do-IRQ" class="headerlink" title="解析asm_do_IRQ"></a>解析asm_do_IRQ</h2><p>在单片机开发中，发生中断后，cpu干什么</p><ol><li>判断是哪个中断</li><li>执行对应中断函数</li><li>清中断</li></ol><p><strong>在linux内核中这三步都在asm_do_IRQ完成</strong>，它在arch/arm26/kernel/irq.c中，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">asmlinkage <span class="token keyword">void</span> __exception <span class="token function">asm_do_IRQ</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> irq<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">pt_regs</span> <span class="token operator">*</span>regs<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">pt_regs</span> <span class="token operator">*</span>old_regs <span class="token operator">=</span> <span class="token function">set_irq_regs</span><span class="token punctuation">(</span>regs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">irq_desc</span> <span class="token operator">*</span>desc <span class="token operator">=</span> irq_desc <span class="token operator">+</span> irq<span class="token punctuation">;</span><span class="token comment">/* * Some hardware gives randomly wrong interrupts.  Rather * than crashing, do something sensible. */</span><span class="token keyword">if</span> <span class="token punctuation">(</span>irq <span class="token operator">>=</span> NR_IRQS<span class="token punctuation">)</span>desc <span class="token operator">=</span> <span class="token operator">&amp;</span>bad_irq_desc<span class="token punctuation">;</span><span class="token function">irq_enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">desc_handle_irq</span><span class="token punctuation">(</span>irq<span class="token punctuation">,</span> desc<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* AT91 specific workaround */</span><span class="token function">irq_finish</span><span class="token punctuation">(</span>irq<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">irq_exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">set_irq_regs</span><span class="token punctuation">(</span>old_regs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">irq_desc</span> irq_desc<span class="token punctuation">[</span>NR_IRQS<span class="token punctuation">]</span> __cacheline_aligned_in_smp <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>irq_desc在kernel/irq/handle.c中，irq_desc是中断描述数组，以中断号为下标。asm_do_IRQ首先根据中断号在irq_desc取到一项，然后执行desc_handle_irq里的desc-&gt;handle_irq(irq, desc);，<br>在kernel/irq/chip.c中__set_irq_handler函数中对其赋值desc-&gt;handle_irq = handle;<br>在arch/arm/plat-s3c24xx/irq.c中的void __init s3c24xx_init_irq(void)</p><p>desc就是那个全局数组的某一项，<strong>那三步都在<code>asm_do_IRQ</code>中的<code>desc-&gt;handle(irq, desc, regs);</code>实现</strong>，<br><img src="/images/20191222214859849.png"></p><h2 id="听不懂照搬代码吧，跟之前比做了一点点修改"><a href="#听不懂照搬代码吧，跟之前比做了一点点修改" class="headerlink" title="听不懂照搬代码吧，跟之前比做了一点点修改"></a>听不懂照搬代码吧，跟之前比做了一点点修改</h2><h3 id="1-简单irq函数-request-irq-free-irq-用exec打开设备节点"><a href="#1-简单irq函数-request-irq-free-irq-用exec打开设备节点" class="headerlink" title="1. 简单irq函数 request_irq free_irq 用exec打开设备节点"></a>1. 简单irq函数 request_irq free_irq 用exec打开设备节点</h3><p>只改了驱动，没有该user，这小部分没有用到user</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 发生中断之后会调用这个函数</span><span class="token keyword">static</span> <span class="token class-name">irqreturn_t</span> <span class="token function">keys_irq</span><span class="token punctuation">(</span><span class="token keyword">int</span> irq<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dev_id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"irq = %d\n"</span><span class="token punctuation">,</span> irq<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"--%s--%s--%d\n"</span><span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// GPF0/2 GPG3/11 配置成输入模式</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">keys_open</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filep<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// GPFCON &amp;= ~((0x3&lt;&lt;0*2) | (0x3&lt;&lt;2*2));  // 清零</span>    <span class="token comment">// GPGCON &amp;= ~((0x3&lt;&lt;3*2) | (0x3&lt;&lt;11*2)); // 清零</span>    <span class="token comment">/*    *@irq: Interrupt line to allocate    *@handler: Function to be called when the IRQ occurs    *@irqflags: Interrupt type flags    *@devname: An ascii name for the claiming device    *@dev_id: A cookie passed back to the handler function    */</span><span class="token comment">// irq:中断号</span><span class="token comment">// handler：处理函数</span><span class="token comment">// irqflags:上升沿触发，下降沿触发，边沿触发等。指定了快速中断或中断共享等中断处理属性.</span><span class="token comment">// *devname：中断名字。通常是设备驱动程序的名称。改值用在 /proc/interrupt 系统 (虚拟)</span><span class="token comment">// 文件上，或内核发生中断错误时使用。</span><span class="token comment">// dev_id 可作为共享中断时的中断区别参数，也可以用来指定中断服务函数需要参考的数据地址。也用于卸载action    </span>    <span class="token comment">// 中断引脚，自动设备为中断引脚，</span>    <span class="token comment">//  IRQ_EINT0在include/asm-arm/arch-s3c2410/irqs.h中定义</span>    <span class="token comment">//  keys_irq</span>    <span class="token comment">//  IRQT_BOTHEDGE双边沿触发</span>    <span class="token comment">//  "EINT0_S2"</span>    <span class="token function">request_irq</span><span class="token punctuation">(</span>IRQ_EINT0<span class="token punctuation">,</span>  keys_irq<span class="token punctuation">,</span> IRQT_BOTHEDGE<span class="token punctuation">,</span> <span class="token string">"EINT0_S2"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">request_irq</span><span class="token punctuation">(</span>IRQ_EINT2<span class="token punctuation">,</span>  keys_irq<span class="token punctuation">,</span> IRQT_BOTHEDGE<span class="token punctuation">,</span> <span class="token string">"EINT0_S3"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">request_irq</span><span class="token punctuation">(</span>IRQ_EINT11<span class="token punctuation">,</span> keys_irq<span class="token punctuation">,</span> IRQT_BOTHEDGE<span class="token punctuation">,</span> <span class="token string">"EINT0_S4"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">request_irq</span><span class="token punctuation">(</span>IRQ_EINT19<span class="token punctuation">,</span> keys_irq<span class="token punctuation">,</span> IRQT_BOTHEDGE<span class="token punctuation">,</span> <span class="token string">"EINT0_S5"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 释放中断的配置</span><span class="token comment">// 关闭中断,也就是取消中断处理函数,在全局数组irq_desc寻找到对应的action链表,</span><span class="token comment">//   通过id将其从链表中删除.如果链表空了,则禁止中断</span><span class="token keyword">int</span> <span class="token function">key_close</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">free_irq</span><span class="token punctuation">(</span>IRQ_EINT0<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free_irq</span><span class="token punctuation">(</span>IRQ_EINT2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free_irq</span><span class="token punctuation">(</span>IRQ_EINT11<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free_irq</span><span class="token punctuation">(</span>IRQ_EINT19<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span>owner   <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>    <span class="token punctuation">.</span>open    <span class="token operator">=</span> keys_open<span class="token punctuation">,</span>    <span class="token punctuation">.</span>read    <span class="token operator">=</span> keys_read<span class="token punctuation">,</span>    <span class="token punctuation">.</span>release <span class="token operator">=</span> key_close<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-插入-exec打开关闭设备节点"><a href="#2-插入-exec打开关闭设备节点" class="headerlink" title="2. 插入/exec打开关闭设备节点"></a>2. 插入/exec打开关闭设备节点</h3><p>查看设备的主设备号和驱动名称，<br><img src="/images/2019122223111438.png"><br>查看设备节点信息，<br><img src="/images/20191222231210168.png"><br>打开设备，这里不是在用户代码中调用open，用命令 <code>exec 5&lt;dev/keys_intnode</code>，打开设备节点，按下按键，弹起，双边沿触发，不同按键对应不同的中断号，比如EINT0在代码中就是16，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S3C2410_CPUIRQ_OFFSET</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">S3C2410_IRQ</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> S3C2410_CPUIRQ_OFFSET<span class="token punctuation">)</span></span></span><span class="token comment">/* main cpu interrupts */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IRQ_EINT0</span>      <span class="token expression"><span class="token function">S3C2410_IRQ</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>    </span><span class="token comment">/* 16 */</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/images/20191222232352151.png"><br>执行<code>cat proc/interrupts</code>查看中IRQ名称断设备节点，可以看到EINT0_S2等 中断次数等<br><img src="/images/20191222231613871.png"><br>当前的进程是shell，查看shell的id     <code>ps  /  top</code>, pid为769，<code>ls -l proc/769/fd</code> 可以看到那个<code>5</code>就指向了keys_intnode设备节点，<br><img src="/images/20191222232726975.png"><br><img src="/images/20191222232903442.png"><br>关闭用exec打开的那个设备<code>exec 5&lt;&amp;-</code> 然后再查看<code>ls proc/769/fd -l</code>，用<code>cat proc/interrupts</code>查看那四个IRQ的名称中断设备节点也没有了，再调用free_irq释放了中断。<br><img src="/images/20191222233358526.png"><br><img src="/images/20191222233556508.png"></p><h2 id="在open中加入休眠等待"><a href="#在open中加入休眠等待" class="headerlink" title="在open中加入休眠等待"></a>在open中加入休眠等待</h2><p><strong>read之后进入内核态的驱动程序里，如果没有按键中断，休眠;<br>有按键中断，进入ISR得到按键值，在read中继续执行，将按键值传递到用户空间</strong></p><p>休眠函数如下,condition=0才休眠,定义在include/linux/wait.h，condition参数这里是ev_press:</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">wait_event_interruptible</span><span class="token expression"><span class="token punctuation">(</span>wq<span class="token punctuation">,</span> condition<span class="token punctuation">)</span></span><span class="token punctuation">\</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">&#123;</span></span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">int</span> __ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>condition<span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="token punctuation">\</span><span class="token expression"><span class="token function">__wait_event_interruptible</span><span class="token punctuation">(</span>wq<span class="token punctuation">,</span> condition<span class="token punctuation">,</span> __ret<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">\</span><span class="token expression">__ret<span class="token punctuation">;</span></span><span class="token punctuation">\</span><span class="token expression"><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="1-驱动代码-keys-int-wait-c-在irq中更新kay-val-wake-up-interruptible-amp-button-waitq"><a href="#1-驱动代码-keys-int-wait-c-在irq中更新kay-val-wake-up-interruptible-amp-button-waitq" class="headerlink" title="1. 驱动代码 keys_int_wait.c 在irq中更新kay_val wake_up_interruptible(&amp;button_waitq)"></a>1. 驱动代码 keys_int_wait.c 在irq中更新kay_val wake_up_interruptible(&amp;button_waitq)</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span>     <span class="token comment">// module_init module_exit</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span>   <span class="token comment">// MODULE_LICENSE</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span>       <span class="token comment">// file_operations</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h></span>     <span class="token comment">// cdev</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h></span>   <span class="token comment">// class_device</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/irq.h></span>      <span class="token comment">// IRQ_EINTx</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/uaccess.h></span>    <span class="token comment">// copy_from_user copy_to_user</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h></span>         <span class="token comment">// ioremap  iounmap</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/irq.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/arch/regs-gpio.h></span> <span class="token comment">// S3C2410_GPFx</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEVICE_NAME</span>      <span class="token string">"k_int_wait"</span></span><span class="token keyword">int</span> major<span class="token punctuation">;</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpfcon <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpfdat <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpgcon <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpgdat <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPFCON</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span>gpfcon<span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPFDAT</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span>gpfdat<span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPGCON</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span>gpgcon<span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPGDAT</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span>gpgdat<span class="token punctuation">)</span></span></span><span class="token comment">// 用于自动创建设备节点的结构class 和 class_device</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>keys_class<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">class_device</span> <span class="token operator">*</span>keys_class_dev<span class="token punctuation">;</span><span class="token comment">// 定义一个事件叫button_waitq 生成一个等待队列头wait_queue_head_t,名字为button_waitq</span><span class="token keyword">static</span> <span class="token function">DECLARE_WAIT_QUEUE_HEAD</span><span class="token punctuation">(</span>button_waitq<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 定义 中断事件标志，与read中的wait_event_interruptible(button_waitq, ev_press)配合 ISR将它置1, read 清0</span><span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> ev_press <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 自定义引脚描述的结构</span><span class="token keyword">struct</span> <span class="token class-name">pin_desc</span><span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> pin<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> key_val<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">/*键值：按下，0x01,0x02,0x03,0x04  键值：松开，0x81,0x82,0x83,0x84*/</span><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> key_val<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">pin_desc</span> pins_desc<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#123;</span>S3C2410_GPF0<span class="token punctuation">,</span>  <span class="token number">0x01</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>S3C2410_GPF2<span class="token punctuation">,</span>  <span class="token number">0x02</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>S3C2410_GPG3<span class="token punctuation">,</span>  <span class="token number">0x03</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>S3C2410_GPG11<span class="token punctuation">,</span> <span class="token number">0x04</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// ISR 发生中断之后会调用这个函数, irq就是对应的中断号</span><span class="token keyword">static</span> <span class="token class-name">irqreturn_t</span> <span class="token function">keys_irq</span><span class="token punctuation">(</span><span class="token keyword">int</span> irq<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dev_id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">pin_desc</span> <span class="token operator">*</span>pindesc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pin_desc</span> <span class="token operator">*</span><span class="token punctuation">)</span>dev_id<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> pin_status<span class="token punctuation">;</span>    <span class="token comment">// 获取引脚状态 Linux内部有系统函数s3c2410_gpio_getpin能够读取GPIO的值</span>    pin_status <span class="token operator">=</span> <span class="token function">s3c2410_gpio_getpin</span><span class="token punctuation">(</span>pindesc<span class="token operator">-></span>pin<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"irq = %d\n"</span><span class="token punctuation">,</span> irq<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 判断引脚，给全局变量赋对应引脚的状态值 （状态--> 所属引脚）</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pin_status<span class="token punctuation">)</span> <span class="token comment">// 松开</span>    <span class="token punctuation">&#123;</span>        key_val <span class="token operator">=</span> <span class="token number">0x80</span> <span class="token operator">|</span> pindesc<span class="token operator">-></span>key_val<span class="token punctuation">;</span> <span class="token comment">// 存入自定义全局变量，在read中to_user</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span>            <span class="token comment">// 按下</span>    <span class="token punctuation">&#123;</span>        key_val <span class="token operator">=</span> <span class="token number">0x00</span> <span class="token operator">|</span> pindesc<span class="token operator">-></span>key_val<span class="token punctuation">;</span> <span class="token comment">// 存入自定义全局变量，在read中to_user</span>    <span class="token punctuation">&#125;</span>    ev_press <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 中断事件标志，ISR将它置1, read 清0</span>    <span class="token function">wake_up_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>button_waitq<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">IRQ_RETVAL</span><span class="token punctuation">(</span>IRQ_HANDLED<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// GPF0/2 GPG3/11 申请中断</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">keys_open</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filep<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">/*    *@irq: Interrupt line to allocate    *@handler: Function to be called when the IRQ occurs    *@irqflags: Interrupt type flags    *@devname: An ascii name for the claiming device    *@dev_id: A cookie passed back to the handler function    */</span>    <span class="token comment">// 中断引脚，自动设备为中断引脚，</span>    <span class="token comment">//  IRQ_EINT0在include/asm-arm/arch-s3c2410/irqs.h中定义</span>    <span class="token comment">//  keys_irq</span>    <span class="token comment">//  IRQT_BOTHEDGE双边沿触发</span>    <span class="token comment">//  "EINT0_S2"</span>    <span class="token comment">// IRQ_EINT0 &amp;pins_desc[0]将被传入到中断服务程序</span>    <span class="token function">request_irq</span><span class="token punctuation">(</span>IRQ_EINT0<span class="token punctuation">,</span>  keys_irq<span class="token punctuation">,</span> IRQT_BOTHEDGE<span class="token punctuation">,</span> <span class="token string">"EINT0_S2"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pins_desc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">request_irq</span><span class="token punctuation">(</span>IRQ_EINT2<span class="token punctuation">,</span>  keys_irq<span class="token punctuation">,</span> IRQT_BOTHEDGE<span class="token punctuation">,</span> <span class="token string">"EINT0_S3"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pins_desc<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">request_irq</span><span class="token punctuation">(</span>IRQ_EINT11<span class="token punctuation">,</span> keys_irq<span class="token punctuation">,</span> IRQT_BOTHEDGE<span class="token punctuation">,</span> <span class="token string">"EINT0_S4"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pins_desc<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">request_irq</span><span class="token punctuation">(</span>IRQ_EINT19<span class="token punctuation">,</span> keys_irq<span class="token punctuation">,</span> IRQT_BOTHEDGE<span class="token punctuation">,</span> <span class="token string">"EINT0_S5"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pins_desc<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// read函数会被用户空间调用，可能while(1), 防止占用资源</span><span class="token class-name">ssize_t</span> <span class="token function">keys_read</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>ppos<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 判断缓冲区为1</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>    <span class="token comment">// 没有按键动作就休眠, 内部判断ev_press是否为0，为0则休眠，否则往下执行</span>    <span class="token comment">//  有休眠就有唤醒，唤醒在ISR中</span>    <span class="token function">wait_event_interruptible</span><span class="token punctuation">(</span>button_waitq<span class="token punctuation">,</span> ev_press<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ev_press在这里跟wait_event_interruptible函数绑定在一起了，该函数会判断第二参数的值而确定是否等待</span>    <span class="token comment">// 将键值返回到用户空间</span>    <span class="token function">copy_to_user</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>key_val<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 中断事件标志，ISR将它置1, read 清0</span>    ev_press <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 释放中断的配置</span><span class="token keyword">int</span> <span class="token function">key_close</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">free_irq</span><span class="token punctuation">(</span>IRQ_EINT0<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pins_desc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free_irq</span><span class="token punctuation">(</span>IRQ_EINT2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pins_desc<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free_irq</span><span class="token punctuation">(</span>IRQ_EINT11<span class="token punctuation">,</span><span class="token operator">&amp;</span>pins_desc<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">free_irq</span><span class="token punctuation">(</span>IRQ_EINT19<span class="token punctuation">,</span><span class="token operator">&amp;</span>pins_desc<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span>owner   <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>    <span class="token punctuation">.</span>open    <span class="token operator">=</span> keys_open<span class="token punctuation">,</span>    <span class="token punctuation">.</span>read    <span class="token operator">=</span> keys_read<span class="token punctuation">,</span>    <span class="token punctuation">.</span>release <span class="token operator">=</span> key_close<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">keys_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    major <span class="token operator">=</span> <span class="token function">register_chrdev</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> DEVICE_NAME<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fops<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>major <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">printk</span><span class="token punctuation">(</span>DEVICE_NAME <span class="token string">" can't register major number.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> major<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    keys_class <span class="token operator">=</span> <span class="token function">class_create</span><span class="token punctuation">(</span>THIS_MODULE<span class="token punctuation">,</span> <span class="token string">"keys_class"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>keys_class<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>keys_class<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 在class里边创建一个设备叫xxx，然后mdev自动创建设备节点/dev/xxx</span>    <span class="token comment">//  在/dev目录下创建相应的设备节点，</span>    keys_class_dev <span class="token operator">=</span> <span class="token function">class_device_create</span><span class="token punctuation">(</span>keys_class<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"k_int_w_node"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>keys_class_dev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>keys_class_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>     gpfcon <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">ioremap</span><span class="token punctuation">(</span><span class="token number">0x56000050</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    gpfdat <span class="token operator">=</span> gpfcon <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    gpgcon <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">ioremap</span><span class="token punctuation">(</span><span class="token number">0x56000060</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    gpgdat <span class="token operator">=</span> gpgcon <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>DEVICE_NAME <span class="token string">" device initialized successfully...\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">keys_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 对应卸载</span>    <span class="token function">unregister_chrdev</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> DEVICE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">class_device_unregister</span><span class="token punctuation">(</span>keys_class_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">class_destroy</span><span class="token punctuation">(</span>keys_class<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">iounmap</span><span class="token punctuation">(</span>gpfcon<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">iounmap</span><span class="token punctuation">(</span>gpgcon<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>keys_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>keys_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-用户代码-user-keys-int-wait-c-read会睡眠-进程资源占用0"><a href="#2-用户代码-user-keys-int-wait-c-read会睡眠-进程资源占用0" class="headerlink" title="2. 用户代码 user_keys_int_wait.c read会睡眠 进程资源占用0%"></a>2. 用户代码 user_keys_int_wait.c read会睡眠 进程资源占用0%</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>    <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> key_val<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"No args required.\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/k_int_w_node"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"can't open '/dev/k_int_w_node'.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Waiting press the keys, will print xxxx.\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">// read之后进入内核态的驱动程序里，如果没有按键中断，休眠;</span>        <span class="token comment">//  有按键中断，进入ISR得到按键值，在read中继续执行，将按键值传递到用户空间</span>        <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>key_val<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"key_val: 0x%x\n"</span><span class="token punctuation">,</span> key_val<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出16进制</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-插入模块-查看设备节点-中断注册情况-资源占用情况"><a href="#3-插入模块-查看设备节点-中断注册情况-资源占用情况" class="headerlink" title="3. 插入模块/查看设备节点/中断注册情况/资源占用情况"></a>3. 插入模块/查看设备节点/中断注册情况/资源占用情况</h3><p>查看主设备号和驱动设备，<br><img src="/images/20191223110506807.png"><br>查看设备节点，<br><img src="/images/20191223110555240.png"><br>查看中断注册情况，<code>cat proc/interrupts</code><br><img src="/images/20191223111031729.png"><br>后台运行，按下按键，查看资源占用情况，<br><img src="/images/20191223110741268.png"></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS1期第12课 字符设备驱动 6 key poll机制，只睡眠固定时间不影响后续程序执行。等待期间将进程休眠，利用事件驱动来唤醒进程</title>
      <link href="2021/05/14/wds1-qi-di-12-ke-zi-fu-she-bei-qu-dong-6-key-poll-ji-zhi-zhi-shui-mian-gu-ding-shi-jian-bu-ying-xiang-hou-xu-cheng-xu-zhi-xing-deng-dai-qi-jian-jiang-jin-cheng-xiu-mian-li-yong-shi-jian-qu-dong-lai-huan-xing-jin-cheng-local/"/>
      <url>2021/05/14/wds1-qi-di-12-ke-zi-fu-she-bei-qu-dong-6-key-poll-ji-zhi-zhi-shui-mian-gu-ding-shi-jian-bu-ying-xiang-hou-xu-cheng-xu-zhi-xing-deng-dai-qi-jian-jiang-jin-cheng-xiu-mian-li-yong-shi-jian-qu-dong-lai-huan-xing-jin-cheng-local/</url>
      
        <content type="html"><![CDATA[<h1 id="poll情景描述"><a href="#poll情景描述" class="headerlink" title="poll情景描述"></a>poll情景描述</h1><p>poll就是 休眠 +超时。   </p><pre><code>  以按键驱动为例进行说明，用阻塞的方式打开按键驱动文件/dev/buttons，应用程序使用read()函数来读取按键的键值。这样做的效果是：如果有按键按下了，调用该read()函数的进程，就成功读取到数据，应用程序得到继续执行；倘若没有按键按下，则要一直处于休眠状态，等待这有按键按下这样的事件发生。  这种功能在一些场合是适用的，但是并不能满足我们所有的需要，有时我们需要一个时间节点。倘若没有按键按下，那么超过多少时间之后，也要返回超时错误信息，进程能够继续得到执行，而不是没有按键按下，就永远休眠。这种例子其实还有很多，比方说两人相亲，男方等待女方给个确定相处的信，男方不可能因为女方不给信，就永远等待下去，双方需要一个时间节点。这个时间节点，就是说超过这个时间之后，不能再等了，程序还要继续运行，需要采取其他的行动来解决问题。</code></pre><h1 id="Linux的做法-poll"><a href="#Linux的做法-poll" class="headerlink" title="Linux的做法 poll"></a>Linux的做法 poll</h1><p>对于类似的场景，linux系统使用poll功能来解决这样的问题。而且，与上述单片机等待方式不同，linux系统再调用poll()函数时候，如果没有发生需要的事件，那么进程进入休眠。如果在限定的时间内得到需要的事件，那么成功返回，如果没有则返回超时错误信息。<br>可见，<strong>等待期间将进程休眠，利用事件驱动来唤醒进程</strong>，将更能提高CPU的效率。</p><p>poll：轮寻<br>上个代码在用户程序中是一直在读取，然后没有中断就睡眠。<br>这里要实现 有中断时，中断函数处理完后就立即返回；没中断时 休眠固定时长后返回。<br>用户代码有open read poll等等，对应于驱动代码open read poll</p><hr><blockquote><p><strong>在Linux内核设计与实现 第11章 定时器和时间管理 中有讲：<a href="https://editor.csdn.net/md/?articleId=104405308">https://editor.csdn.net/md/?articleId=104405308</a><br>某些依赖定时值的系统调用以更高精度运行，如poll(), select()</strong><br>jiffies与秒的转换，常用是把秒转化成jiffies，</p></blockquote><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 将jiffies化成秒，用于内核和用户空间交互</span>jiffies<span class="token operator">/</span>HZ<span class="token comment">// 将秒化成jiffies，</span>seconds <span class="token operator">*</span> HZ<span class="token comment">// 常用把秒转化成jiffies举例</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> time_stamp <span class="token operator">=</span> jiffies<span class="token punctuation">;</span> <span class="token comment">/* 现在*/</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> next_tick <span class="token operator">=</span> jiffies <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">/* 从现在开始一个节拍 */</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> later <span class="token operator">=</span> jiffies <span class="token operator">+</span> <span class="token number">5</span><span class="token operator">*</span>HZ<span class="token punctuation">;</span>   <span class="token comment">/* 从现在开始5秒 */</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> fraction <span class="token operator">=</span> jiffies <span class="token operator">+</span> HZ <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">/* 从现在开始1/10秒 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>在32体系结构中jiffies是32位的，在时钟频率为100HZ时，497天溢出，1000HZ时49.7天溢出。<br>在64位上完全忽略溢出。<br><br><strong>定时器</strong><br>也称为动态定时器或内核定时器，是管理内核流逝时间的基础。<br><strong>内核经常需要推后执行一些代码，而推后的本意是不在当前时间执行就行，实现需要借助定时器。</strong><br>定时器使用简单，初始化操作、设置超时时间、指定超时后执行的函数、激活定时器就ok了。定时器不周期运行，超时后自行撤销，所以也叫动态定时器。</p></blockquote><hr><h3 id="修改的部分驱动文件"><a href="#修改的部分驱动文件" class="headerlink" title="修改的部分驱动文件"></a>修改的部分驱动文件</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token function">keys_poll</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> poll_table <span class="token operator">*</span>wait<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> mask <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">// 将进程挂接到button_waitq等待队列下, 前面定义的button_waitq</span>    <span class="token function">poll_wait</span><span class="token punctuation">(</span>filp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>button_waitq<span class="token punctuation">,</span> wait<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 根据实际情况，标记事件类型 </span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ev_press<span class="token punctuation">)</span>        mask <span class="token operator">|=</span> POLLIN <span class="token operator">|</span> POLLRDNORM<span class="token punctuation">;</span>    <span class="token comment">// 如果mask为0，则没有请求事件发生；如果非零说明有事件发生</span>    <span class="token keyword">return</span> mask<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span>owner   <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>    <span class="token punctuation">.</span>open    <span class="token operator">=</span> keys_open<span class="token punctuation">,</span>    <span class="token punctuation">.</span>read    <span class="token operator">=</span> keys_read<span class="token punctuation">,</span>    <span class="token punctuation">.</span>release <span class="token operator">=</span> keys_close<span class="token punctuation">,</span>    <span class="token punctuation">.</span>poll    <span class="token operator">=</span> keys_poll<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="修改用户代码"><a href="#修改用户代码" class="headerlink" title="修改用户代码"></a>修改用户代码</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;poll.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>    <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> key_val<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">pollfd</span> fds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 同时查询多个文件（驱动程序）</span>    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"No args required.\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/k_poll_node"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"can't open '/dev/k_poll_node'.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Waiting press the keys, will print xxxx.\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    fds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fd     <span class="token operator">=</span> fd<span class="token punctuation">;</span>     <span class="token comment">// 查询打开的文件</span>    fds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span> <span class="token comment">// 有数据等待读取</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>           <span class="token comment">// 查询一个文件，超时时间</span>        <span class="token comment">//  在应用程序中用select和poll最终都是在内核中调用poll，效果一样</span>        ret <span class="token operator">=</span> <span class="token function">poll</span><span class="token punctuation">(</span>fds<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 超时而未发生中断</span>        <span class="token punctuation">&#123;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"timeout 2000ms\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">else</span>          <span class="token comment">// 在等待期间有中断 </span>        <span class="token punctuation">&#123;</span>            <span class="token comment">// read之后进入内核态的驱动程序里，如果没有按键中断，休眠2000ms退出，有中断则poll返回非0</span>            <span class="token comment">//  有按键中断，进入ISR得到按键值，在read中继续执行，将按键值传递到用户空间</span>            <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>key_val<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"key_val: 0x%x\n"</span><span class="token punctuation">,</span> key_val<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出16进制</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="linux内核poll机制实现"><a href="#linux内核poll机制实现" class="headerlink" title="linux内核poll机制实现"></a>linux内核poll机制实现</h3><p><a href="https://www.cnblogs.com/amanlikethis/p/6915485.html">https://www.cnblogs.com/amanlikethis/p/6915485.html</a><br>自己的写的keys_poll是系统sys_poll的一个调用，调用的目的是 <strong>将进程挂接到等待队列下</strong> 和 <strong>返回事件类型mask</strong>。<br>当已经发生了请求事件，那么通过标记mask非0，if (do_pollfd(pfd, pt))判断为真，令count++，从而可以直接令poll()函数成功返回。如果还没有发生请求的事件，那么mask被标记为0，进程将通过函数poll_schedule_timeout()陷入休眠状态。一旦发生了请求的事件，因为之前已经将进程挂接到等待队列下，所以进程将被唤醒，重新执行drivers_poll()，而显然此时能够成功返回。<br><img src="/images/20191225154403232.png"></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS1期第12课 字符设备驱动 4 查询方法读按键 keys_query xxx &amp;后台运行 top资源占用情况</title>
      <link href="2021/05/14/wds1-qi-di-12-ke-zi-fu-she-bei-qu-dong-4-cha-xun-fang-fa-du-an-jian-keys-query-xxx-hou-tai-yun-xing-top-zi-yuan-zhan-yong-qing-kuang-local/"/>
      <url>2021/05/14/wds1-qi-di-12-ke-zi-fu-she-bei-qu-dong-4-cha-xun-fang-fa-du-an-jian-keys-query-xxx-hou-tai-yun-xing-top-zi-yuan-zhan-yong-qing-kuang-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]</p><h2 id="一、原理图-datasheet"><a href="#一、原理图-datasheet" class="headerlink" title="一、原理图 datasheet"></a>一、原理图 datasheet</h2><h3 id="1-原理图"><a href="#1-原理图" class="headerlink" title="1. 原理图"></a>1. 原理图</h3><p><img src="https://img-blog.csdnimg.cn/20191219234543893.png"> <img src="/images/20191219234631629.png"><br><img src="/images/20191219225246933.png"><br><img src="https://img-blog.csdnimg.cn/20191219225326160.png"><img src="/images/20191219230831735.png"></p><h3 id="2-datasheet"><a href="#2-datasheet" class="headerlink" title="2. datasheet"></a>2. datasheet</h3><p>GPF0(EINT0)&#8195;GPF2(EINT2)&#8195;GPG3(EINT11)&#8195;GPG11(EINT19)<br><img src="/images/20191219225840250.png"><br><img src="/images/20191219225818655.png"></p><h2 id="二、框架，内核模块代码-用户代码"><a href="#二、框架，内核模块代码-用户代码" class="headerlink" title="二、框架，内核模块代码 / 用户代码"></a>二、框架，内核模块代码 / 用户代码</h2><p>都是字符设备，所以框架都差不多。</p><h3 id="1-内核驱动代码"><a href="#1-内核驱动代码" class="headerlink" title="1. 内核驱动代码"></a>1. 内核驱动代码</h3><p>keys_query.c</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span>     <span class="token comment">// module_init module_exit</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span>   <span class="token comment">// MODULE_LICENSE</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span>       <span class="token comment">// file_operations</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h></span>     <span class="token comment">// cdev</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h></span>   <span class="token comment">// class_device</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/uaccess.h></span>    <span class="token comment">// copy_from_user copy_to_user</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h></span>         <span class="token comment">// ioremap  iounmap</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEVICE_NAME</span>      <span class="token string">"keys"</span></span><span class="token keyword">int</span> major<span class="token punctuation">;</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpfcon <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpfdat <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpgcon <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpgdat <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPFCON</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span>gpfcon<span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPFDAT</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span>gpfdat<span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPGCON</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span>gpgcon<span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPGDAT</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span>gpgdat<span class="token punctuation">)</span></span></span><span class="token comment">// 用于自动创建设备节点的结构class 和 class_device</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>keys_class<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">class_device</span> <span class="token operator">*</span>keys_class_dev<span class="token punctuation">;</span><span class="token comment">// GPF0/2 GPG3/11 配置成输入模式</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">keys_open</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filep<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    GPFCON <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0x3</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">0x3</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 清零</span>    GPGCON <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0x3</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">0x3</span><span class="token operator">&lt;&lt;</span><span class="token number">11</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 清零 </span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">ssize_t</span> <span class="token function">keys_read</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>ppos<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> key_vals<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> regval<span class="token punctuation">;</span>    <span class="token comment">// 判断缓冲区大小</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>key_vals<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>    <span class="token comment">// 获取GPFDAT寄存器的值</span>    regval <span class="token operator">=</span> GPFDAT<span class="token punctuation">;</span>    key_vals<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>regval <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">0x1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>     key_vals<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>regval <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">0x1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>     <span class="token comment">// 获取GPGDAT寄存器的值</span>    regval <span class="token operator">=</span> GPGDAT<span class="token punctuation">;</span>    key_vals<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>regval <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">0x1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>     key_vals<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>regval <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">0x1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>     <span class="token comment">// 将键值返回到用户空间</span>    <span class="token function">copy_to_user</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> key_vals<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>key_vals<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>    <span class="token punctuation">.</span>open <span class="token operator">=</span> keys_open<span class="token punctuation">,</span>    <span class="token punctuation">.</span>read <span class="token operator">=</span> keys_read<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">keys_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    major <span class="token operator">=</span> <span class="token function">register_chrdev</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> DEVICE_NAME<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fops<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>major <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">printk</span><span class="token punctuation">(</span>DEVICE_NAME <span class="token string">" can't register major number.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> major<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    keys_class <span class="token operator">=</span> <span class="token function">class_create</span><span class="token punctuation">(</span>THIS_MODULE<span class="token punctuation">,</span> <span class="token string">"keys_class"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>keys_class<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>keys_class<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 在class里边创建一个设备叫xxx，然后mdev自动创建设备节点/dev/xxx</span>    <span class="token comment">//  在/dev目录下创建相应的设备节点，</span>        keys_class_dev <span class="token operator">=</span> <span class="token function">class_device_create</span><span class="token punctuation">(</span>keys_class<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"keys_node"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>keys_class_dev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>keys_class_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>     gpfcon <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">ioremap</span><span class="token punctuation">(</span><span class="token number">0x56000050</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    gpfdat <span class="token operator">=</span> gpfcon <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    gpgcon <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">ioremap</span><span class="token punctuation">(</span><span class="token number">0x56000060</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    gpgdat <span class="token operator">=</span> gpgcon <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token function">printk</span><span class="token punctuation">(</span>DEVICE_NAME <span class="token string">" device initialized successfully...\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">keys_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 对应卸载</span>    <span class="token function">unregister_chrdev</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> DEVICE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">class_device_unregister</span><span class="token punctuation">(</span>keys_class_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token function">class_destroy</span><span class="token punctuation">(</span>keys_class<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">iounmap</span><span class="token punctuation">(</span>gpfcon<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">iounmap</span><span class="token punctuation">(</span>gpgcon<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">module_init</span><span class="token punctuation">(</span>keys_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>keys_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-Makefile"><a href="#2-Makefile" class="headerlink" title="2. Makefile"></a>2. Makefile</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">KERN_DIR <span class="token operator">:</span><span class="token operator">=</span> <span class="token operator">/</span>home<span class="token operator">/</span>wuyexkx<span class="token operator">/</span>Desktop<span class="token operator">/</span>韦东山<span class="token operator">/</span>system<span class="token operator">/</span>linux<span class="token operator">-</span><span class="token number">2.6</span><span class="token number">.22</span><span class="token number">.6</span>PWD <span class="token operator">:</span><span class="token operator">=</span> $<span class="token punctuation">(</span>shell pwd<span class="token punctuation">)</span>obj<span class="token operator">-</span>m <span class="token operator">:</span><span class="token operator">=</span> keys_query<span class="token punctuation">.</span>oall<span class="token operator">:</span>make <span class="token operator">-</span>C $<span class="token punctuation">(</span>KERN_DIR<span class="token punctuation">)</span> M<span class="token operator">=</span>$<span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> modules CROSS_COMPILE<span class="token operator">=</span>arm<span class="token operator">-</span>linux<span class="token operator">-</span> ARCH<span class="token operator">=</span>armclean<span class="token operator">:</span>make <span class="token operator">-</span>C $<span class="token punctuation">(</span>KERN_DIR<span class="token punctuation">)</span> M<span class="token operator">=</span>$<span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> clean<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-用户代码"><a href="#3-用户代码" class="headerlink" title="3. 用户代码"></a>3. 用户代码</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>    <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> key_vals<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"No args required.\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/keys_node"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"can't open '/dev/keys_node'.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Waiting press the keys, will print xxxx.\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> key_vals<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>key_vals<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>key_vals<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token operator">!</span>key_vals<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token operator">!</span>key_vals<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token operator">!</span>key_vals<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%04d key pressed, the value is: %d %d %d %d\n\n"</span><span class="token punctuation">,</span> \                    cnt<span class="token operator">++</span><span class="token punctuation">,</span> key_vals<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> key_vals<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> key_vals<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> key_vals<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-加载内核模块，运行用户程序，后台用户程序，查看资源情况"><a href="#4-加载内核模块，运行用户程序，后台用户程序，查看资源情况" class="headerlink" title="4. 加载内核模块，运行用户程序，后台用户程序，查看资源情况"></a>4. 加载内核模块，运行用户程序，后台用户程序，查看资源情况</h3><p>加载内核驱动，<br><img src="/images/20191220083346555.png"><br>后台运行用户程序<code>xxx &amp;</code>，再回车一下，<br><img src="/images/20191220002548628.png"><br>查看资源占用情况<code>top</code>，查询方法检测按键，资源被占完了，<br><img src="/images/2019122000265664.png"><br><img src="/images/20191220083110889.png"></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS1期第12课 字符设备驱动 3 led4个独立驱动 mdev根据代码自动创建次设备节点 获取次设备号 用户代码useage</title>
      <link href="2021/05/14/wds1-qi-di-12-ke-zi-fu-she-bei-qu-dong-3-led4-ge-du-li-qu-dong-mdev-gen-ju-dai-ma-zi-dong-chuang-jian-ci-she-bei-jie-dian-huo-qu-ci-she-bei-hao-yong-hu-dai-ma-useage-local/"/>
      <url>2021/05/14/wds1-qi-di-12-ke-zi-fu-she-bei-qu-dong-3-led4-ge-du-li-qu-dong-mdev-gen-ju-dai-ma-zi-dong-chuang-jian-ci-she-bei-jie-dian-huo-qu-ci-she-bei-hao-yong-hu-dai-ma-useage-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]<br><strong>1. 写驱动框架<br>2. 硬件相关（原理图 手册 写代码）</strong></p><h2 id="一、board相关原理图和芯片datasheet"><a href="#一、board相关原理图和芯片datasheet" class="headerlink" title="一、board相关原理图和芯片datasheet"></a>一、board相关原理图和芯片datasheet</h2><h3 id="1-原理图"><a href="#1-原理图" class="headerlink" title="1. 原理图"></a>1. 原理图</h3><p><img src="https://img-blog.csdnimg.cn/20191218212124603.png"><img src="/images/20191218212151809.png"></p><h3 id="2-datasheet"><a href="#2-datasheet" class="headerlink" title="2. datasheet"></a>2. datasheet</h3><p><img src="https://img-blog.csdnimg.cn/20191218213013697.png"><img src="/images/20191218213233699.png"></p><h2 id="二、驱动-用户-Makefile代码"><a href="#二、驱动-用户-Makefile代码" class="headerlink" title="二、驱动/用户/Makefile代码"></a>二、驱动/用户/Makefile代码</h2><h3 id="1-led驱动led-chrdev1-c"><a href="#1-led驱动led-chrdev1-c" class="headerlink" title="1. led驱动led_chrdev1.c"></a>1. led驱动led_chrdev1.c</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span>     <span class="token comment">// module_init module_exit</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span>   <span class="token comment">// MODULE_LICENSE</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span>       <span class="token comment">// file_operations</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h></span>     <span class="token comment">// cdev</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h></span>   <span class="token comment">// class_device</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/uaccess.h></span>    <span class="token comment">// copy_from_user copy_to_user</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h></span>         <span class="token comment">// ioremap  iounmap</span></span><span class="token comment">// GPF引脚的con和dat寄存器，地址需要映射</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpfcon <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpfdat <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token comment">// 用于自动创建设备节点的结构class 和 class_device</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>demo_class<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">class_device</span> <span class="token operator">*</span>demo_class_devs<span class="token punctuation">;</span><span class="token comment">// 操作方法</span><span class="token comment">//  配置GPF4/5/6为输出模式</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">led_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filep<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token operator">*</span>gpfcon <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0x3</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">0x3</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">0x3</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 先清零 8-13 01010101</span>    <span class="token operator">*</span>gpfcon <span class="token operator">|=</span>   <span class="token punctuation">(</span><span class="token number">0x1</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token operator">|</span>  <span class="token number">0x1</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token operator">|</span>  <span class="token number">0x1</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 再对应位置1</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"--%s--%s--%d\n"</span><span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//  配置GPF4/5/6输出高或者低电平</span><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">led_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filep<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>ppos<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 在用户层传入的形式是 write(fd, &amp;val, 4); val是buf，4是count</span>    <span class="token comment">// 在内核层获取用户层传入的参数，用copy_from_user； 内核空间到用户传参数copy_to_user</span>    <span class="token keyword">int</span> user_param <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user_param<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 从buf拷贝到user_param，长度为count</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> user_param<span class="token punctuation">)</span>        <span class="token comment">// 开灯</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">// 4-6 000</span>        <span class="token operator">*</span>gpfdat <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0x7</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> user_param<span class="token punctuation">)</span>   <span class="token comment">// 关灯</span>    <span class="token punctuation">&#123;</span>        <span class="token operator">*</span>gpfdat <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0x7</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"--%s--%s--%d\n"</span><span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 操作方法集</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>    <span class="token punctuation">.</span>open  <span class="token operator">=</span> led_open<span class="token punctuation">,</span>    <span class="token punctuation">.</span>write <span class="token operator">=</span> led_write<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 用于保存获取到的主设备号</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> major <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 入口函数</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">demo_cdev_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 自动获取主设备号资源；主设备号对应的名字在/proc/devices中，</span>    <span class="token comment">//  内核驱动模块的名字是Makefile里指定的（一般跟驱动.c文件名字对应）</span>    major <span class="token operator">=</span> <span class="token function">register_chrdev</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"major_name_led"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fops<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  0自动分配， </span>        <span class="token comment">// 以下为 在系统中生成设备信息的步骤</span>    <span class="token comment">// 1. 新建一个class</span>    demo_class <span class="token operator">=</span> <span class="token function">class_create</span><span class="token punctuation">(</span>THIS_MODULE<span class="token punctuation">,</span> <span class="token string">"led_chrdev_class1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>demo_class<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>demo_class<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 在class里边创建一个设备叫xxx，然后mdev自动创建设备节点/dev/xxx</span>    <span class="token comment">//  在/dev目录下创建相应的设备节点</span>    demo_class_devs <span class="token operator">=</span> <span class="token function">class_device_create</span><span class="token punctuation">(</span>demo_class<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"led_on_off1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>demo_class_devs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>demo_class_devs<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// led寄存器的地址映射，只需要执行一次，所以在入口函数映射</span>    gpfcon <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">ioremap</span><span class="token punctuation">(</span><span class="token number">0x56000050</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// start, size</span>    gpfdat <span class="token operator">=</span> gpfcon <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                                       <span class="token comment">// unsigned long的长度</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 出口函数</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">demo_cdev_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 对应卸载</span>    <span class="token function">unregister_chrdev</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> <span class="token string">"major_name_led"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">class_device_unregister</span><span class="token punctuation">(</span>demo_class_devs<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">class_destroy</span><span class="token punctuation">(</span>demo_class<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 去掉映射关系</span>    <span class="token function">iounmap</span><span class="token punctuation">(</span>gpfcon<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 内核模块相关</span><span class="token function">module_init</span><span class="token punctuation">(</span>demo_cdev_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>demo_cdev_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-Makefile"><a href="#2-Makefile" class="headerlink" title="2. Makefile"></a>2. Makefile</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">KERN_DIR <span class="token operator">:</span><span class="token operator">=</span> <span class="token operator">/</span>home<span class="token operator">/</span>wuyexkx<span class="token operator">/</span>Desktop<span class="token operator">/</span>韦东山<span class="token operator">/</span>system<span class="token operator">/</span>linux<span class="token operator">-</span><span class="token number">2.6</span><span class="token number">.22</span><span class="token number">.6</span>PWD <span class="token operator">:</span><span class="token operator">=</span> $<span class="token punctuation">(</span>shell pwd<span class="token punctuation">)</span># 执行pwd命令并把结果赋给PWDobj<span class="token operator">-</span>m <span class="token operator">:</span><span class="token operator">=</span> led_chrdev1<span class="token punctuation">.</span>o  # <span class="token punctuation">.</span>ko的生成依赖于<span class="token punctuation">.</span>o，<span class="token punctuation">.</span>o默认依赖<span class="token punctuation">.</span>call<span class="token operator">:</span>make <span class="token operator">-</span>C $<span class="token punctuation">(</span>KERN_DIR<span class="token punctuation">)</span> M<span class="token operator">=</span>$<span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> modules CROSS_COMPILE<span class="token operator">=</span>arm<span class="token operator">-</span>linux<span class="token operator">-</span> ARCH<span class="token operator">=</span>arm # modules为编译目标clean<span class="token operator">:</span>make <span class="token operator">-</span>C $<span class="token punctuation">(</span>KERN_DIR<span class="token punctuation">)</span> M<span class="token operator">=</span>$<span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> clean<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-用户user-led1-c"><a href="#3-用户user-led1-c" class="headerlink" title="3. 用户user_led1.c"></a>3. 用户user_led1.c</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token comment">// main传入2个参数 user_led1 on/off</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>    <span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment">// 打开 mdev根据驱动程序中的class_device_create自动创建的 设备节点</span>    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/led_on_off1"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"can't open '/dev/led_on_off1'\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// main参数个数判断</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span>     <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Usage:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\t%s &lt;on|off>\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 第二参数判断</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"on"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token comment">// 开灯参数</span>    <span class="token punctuation">&#123;</span>        val <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"off"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 关灯参数</span>    <span class="token punctuation">&#123;</span>        val  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 根据第二参数write</span>    <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>val<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="三、插入内核模块-自动创建设备节点-执行用户led"><a href="#三、插入内核模块-自动创建设备节点-执行用户led" class="headerlink" title="三、插入内核模块 自动创建设备节点 执行用户led"></a>三、插入内核模块 自动创建设备节点 执行用户led</h2><p>查看插入的内核驱动模块，<code>cat proc/devices</code><br><img src="/images/20191219093552154.png"><br>查看自动创建的设备节点，<code>ls dev/led_on_off1 -l</code><br><img src="/images/201912182319366.png"><br>执行应用程序，<code>./mnt/tzb/user_led1</code>提示使用信息；<br><code>./mnt/tzb/user_led1 on</code>开灯；<br><code>./mnt/tzb/user_led1 off</code>关灯：<br><img src="/images/20191219093832644.png"></p><h2 id="四、用次设备号改进led驱动代码"><a href="#四、用次设备号改进led驱动代码" class="headerlink" title="四、用次设备号改进led驱动代码"></a>四、用次设备号改进led驱动代码</h2><h3 id="1-led驱动led-chrdev2-c"><a href="#1-led驱动led-chrdev2-c" class="headerlink" title="1. led驱动led_chrdev2.c"></a>1. led驱动led_chrdev2.c</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span>     <span class="token comment">// module_init module_exit</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span>   <span class="token comment">// MODULE_LICENSE</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span>       <span class="token comment">// file_operations</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h></span>     <span class="token comment">// cdev</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h></span>   <span class="token comment">// class_device</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/uaccess.h></span>    <span class="token comment">// copy_from_user copy_to_user</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h></span>         <span class="token comment">// ioremap  iounmap</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEVICE_NAME</span>     <span class="token string">"leds"</span> <span class="token comment">// 加载模式后，执行”cat /proc/devices”命令看到的设备名称</span></span><span class="token keyword">int</span> major <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                 <span class="token comment">// 用于保存获取到的主设备号</span><span class="token comment">// GPF引脚的con和dat寄存器，地址需要映射</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpfcon <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>gpfdat <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPFCON</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span>gpfcon<span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPFDAT</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span>gpfdat<span class="token punctuation">)</span></span></span><span class="token comment">// 用于自动创建设备节点的结构class 和 class_device</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>leds_class<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">class_device</span> <span class="token operator">*</span>leds_class_dev<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 操作方法</span><span class="token comment">//  根据次设备号 配置GPF4/5/6为输出模式</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">leds_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filep<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 从inode中提取次设备号</span><span class="token keyword">int</span> minor <span class="token operator">=</span> <span class="token function">MINOR</span><span class="token punctuation">(</span>inode<span class="token operator">-></span>i_rdev<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">switch</span><span class="token punctuation">(</span>minor<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> <span class="token comment">// leds</span>        <span class="token punctuation">&#123;</span>            GPFCON <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0x3</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">0x3</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">0x3</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 先清零 8-13 01010101</span>            GPFCON <span class="token operator">|=</span>   <span class="token punctuation">(</span><span class="token number">0x1</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token operator">|</span>  <span class="token number">0x1</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token operator">|</span>  <span class="token number">0x1</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 再对应位置1</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token comment">// led1</span>        <span class="token punctuation">&#123;</span>            GPFCON <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x3</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            GPFCON <span class="token operator">|=</span>   <span class="token punctuation">(</span><span class="token number">0x1</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token comment">// led2</span>        <span class="token punctuation">&#123;</span>            GPFCON <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x3</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            GPFCON <span class="token operator">|=</span>   <span class="token punctuation">(</span><span class="token number">0x1</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span> <span class="token comment">// led3</span>        <span class="token punctuation">&#123;</span>            GPFCON <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x3</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            GPFCON <span class="token operator">|=</span>   <span class="token punctuation">(</span><span class="token number">0x1</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"--%s--%s--%d\n"</span><span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//  配置GPF4/5/6输出高或者低电平</span><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">leds_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>ppos<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 获取次设备号</span><span class="token keyword">int</span> minor <span class="token operator">=</span> <span class="token function">MINOR</span><span class="token punctuation">(</span>filp<span class="token operator">-></span>f_dentry<span class="token operator">-></span>d_inode<span class="token operator">-></span>i_rdev<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 在用户层传入的形式是 write(fd, &amp;val, 4); val是buf，4是count</span>    <span class="token comment">// 在内核层获取用户层传入的参数，用copy_from_user； 内核空间到用户传参数copy_to_user</span>    <span class="token keyword">int</span> user_param <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user_param<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 从buf拷贝到user_param，长度为count</span>        <span class="token keyword">switch</span><span class="token punctuation">(</span>minor<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>        <span class="token punctuation">&#123;</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span>user_param <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>                GPFDAT <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0x7</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>user_param <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                GPFDAT <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x7</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4-6 000</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>        <span class="token punctuation">&#123;</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span>user_param <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>                GPFDAT <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0x1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>user_param <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                GPFDAT <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 4 0</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>        <span class="token punctuation">&#123;</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span>user_param <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>                GPFDAT <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0x1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>user_param <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                GPFDAT <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 5 0</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>        <span class="token punctuation">&#123;</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span>user_param <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>                GPFDAT <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0x1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>user_param <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                GPFDAT <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 6 0</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"--%s--%s--%d\n"</span><span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 操作方法集</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>    <span class="token punctuation">.</span>open  <span class="token operator">=</span> leds_open<span class="token punctuation">,</span>    <span class="token punctuation">.</span>write <span class="token operator">=</span> leds_write<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 入口函数</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">leds_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> minor <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 保存次设备号</span>    <span class="token comment">// led寄存器的地址映射，只需要执行一次，所以在入口函数映射</span>    gpfcon <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">ioremap</span><span class="token punctuation">(</span><span class="token number">0x56000050</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// start, size</span>    gpfdat <span class="token operator">=</span> gpfcon <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                                       <span class="token comment">// unsigned long的长度</span>    <span class="token comment">// 0. 自动获取主设备号资源；主设备号对应的名字在/proc/devices中，</span>    <span class="token comment">//      内核驱动模块的名字是Makefile里指定的（一般跟驱动.c文件名字对应）</span>    major <span class="token operator">=</span> <span class="token function">register_chrdev</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> DEVICE_NAME<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fops<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  0自动分配， </span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>major <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">printk</span><span class="token punctuation">(</span>DEVICE_NAME <span class="token string">" can't register major number.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> major<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 以下为 在系统中生成设备信息的步骤</span>    <span class="token comment">// 1. 新建一个class</span>    leds_class <span class="token operator">=</span> <span class="token function">class_create</span><span class="token punctuation">(</span>THIS_MODULE<span class="token punctuation">,</span> <span class="token string">"leds_class"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>leds_class<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>leds_class<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 在class里边创建一个设备叫xxx，然后mdev自动创建设备节点/dev/xxx</span>    <span class="token comment">//  在/dev目录下创建相应的设备节点，0全部led设备节点</span>    leds_class_dev<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">class_device_create</span><span class="token punctuation">(</span>leds_class<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"led0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>leds_class_dev<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>leds_class_dev<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//      1,2,3对应led1/2/3设备节点</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>minor<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> minor<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>minor<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        leds_class_dev<span class="token punctuation">[</span>minor<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">class_device_create</span><span class="token punctuation">(</span>leds_class<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> minor<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"led%d"</span><span class="token punctuation">,</span> minor<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>leds_class_dev<span class="token punctuation">[</span>minor<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>leds_class_dev<span class="token punctuation">[</span>minor<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>        <span class="token function">printk</span><span class="token punctuation">(</span>DEVICE_NAME <span class="token string">" device initialized successfully...\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 出口函数</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">leds_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> minor <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 保存次设备号</span>    <span class="token comment">// 对应卸载</span>    <span class="token function">unregister_chrdev</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> DEVICE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>minor<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> minor<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>minor<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">class_device_unregister</span><span class="token punctuation">(</span>leds_class_dev<span class="token punctuation">[</span>minor<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">&#125;</span>        <span class="token function">class_destroy</span><span class="token punctuation">(</span>leds_class<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 去掉映射关系</span>    <span class="token function">iounmap</span><span class="token punctuation">(</span>gpfcon<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 内核模块相关</span><span class="token function">module_init</span><span class="token punctuation">(</span>leds_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>leds_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-Makefile-1"><a href="#2-Makefile-1" class="headerlink" title="2. Makefile"></a>2. Makefile</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c">KERN_DIR <span class="token operator">:</span><span class="token operator">=</span> <span class="token operator">/</span>home<span class="token operator">/</span>wuyexkx<span class="token operator">/</span>Desktop<span class="token operator">/</span>韦东山<span class="token operator">/</span>system<span class="token operator">/</span>linux<span class="token operator">-</span><span class="token number">2.6</span><span class="token number">.22</span><span class="token number">.6</span>PWD <span class="token operator">:</span><span class="token operator">=</span> $<span class="token punctuation">(</span>shell pwd<span class="token punctuation">)</span># 执行pwd命令并把结果赋给PWDobj<span class="token operator">-</span>m <span class="token operator">:</span><span class="token operator">=</span> led_chrdev2<span class="token punctuation">.</span>o  # <span class="token punctuation">.</span>ko的生成依赖于<span class="token punctuation">.</span>o，<span class="token punctuation">.</span>o默认依赖<span class="token punctuation">.</span>call<span class="token operator">:</span>make <span class="token operator">-</span>C $<span class="token punctuation">(</span>KERN_DIR<span class="token punctuation">)</span> M<span class="token operator">=</span>$<span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> modules CROSS_COMPILE<span class="token operator">=</span>arm<span class="token operator">-</span>linux<span class="token operator">-</span> ARCH<span class="token operator">=</span>arm # modules为编译目标clean<span class="token operator">:</span>make <span class="token operator">-</span>C $<span class="token punctuation">(</span>KERN_DIR<span class="token punctuation">)</span> M<span class="token operator">=</span>$<span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> clean<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-用户user-led2-c"><a href="#3-用户user-led2-c" class="headerlink" title="3. 用户user_led2.c"></a>3. 用户user_led2.c</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token keyword">void</span> <span class="token function">print_usage</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv0<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Usage:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\t%s led&lt;x> &lt;on|off>\t[x=0~3]\n"</span><span class="token punctuation">,</span> argv0<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Example:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\t%s led0 on\n"</span><span class="token punctuation">,</span> argv0<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\t%s led0 off\n\n"</span><span class="token punctuation">,</span> argv0<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// main传入3个参数 user_led2 led0 on/off</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>    <span class="token keyword">int</span> is_off <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment">// main参数个数判断</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">print_usage</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>      <span class="token comment">// 保存设备节点名称</span>    <span class="token keyword">char</span> device_name<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/dev/"</span><span class="token punctuation">;</span>    <span class="token comment">// 根据用户输入得到完整设备节点名称 "/dev/" + "led0" = "/dev/led0"</span>    <span class="token function">strcat</span><span class="token punctuation">(</span>device_name<span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// 打开 mdev根据驱动程序中的class_device_create自动创建的 设备节点</span>    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>device_name<span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"can't open %s.\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>        <span class="token comment">// 第三参数判断</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"on"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token comment">// 开灯参数</span>    <span class="token punctuation">&#123;</span>        is_off <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment">// 根据第三参数write</span>        <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>is_off<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"off"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 关灯参数</span>    <span class="token punctuation">&#123;</span>        is_off <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token comment">// 根据第三参数write</span>        <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>is_off<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span>                                <span class="token comment">// 第三参数错误</span>    <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Unknown args '%s'.\n\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-插入内核模块，运行用户代码，点亮和关闭对应led"><a href="#4-插入内核模块，运行用户代码，点亮和关闭对应led" class="headerlink" title="4. 插入内核模块，运行用户代码，点亮和关闭对应led"></a>4. 插入内核模块，运行用户代码，点亮和关闭对应led</h3><p>插入内核模块，显示初始化成功，并在<code>proc/devices</code>中看到为<code>leds</code>设备驱动分配的主设备号252，<br><img src="https://img-blog.csdnimg.cn/20191219201658321.png"> <img src="/images/20191219201730143.png"><br>在<code>dev/</code>中看到四个对应的设备节点，依次申请到的次设备号0/1/2/3，都是252主设备号，<br><img src="/images/20191219201806480.png"><br><img src="/images/20191219201902314.png"><br>运行用户代码，打印帮助信息，打开led对应的设备节点；第三参数错误也打印出来。<br><img src="/images/20191219202302996.png"><br><img src="/images/20191219202907735.png"></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS1期第12课 字符设备驱动 2 board，insmod rmmod mknod mdev自动创建设备节点 name对应关系 问题NFS_ server not responding,still</title>
      <link href="2021/05/14/wds1-qi-di-12-ke-zi-fu-she-bei-qu-dong-2-board-insmod-rmmod-mknod-mdev-zi-dong-chuang-jian-she-bei-jie-dian-name-dui-ying-guan-xi-wen-ti-nfs-server-not-responding-still-local/"/>
      <url>2021/05/14/wds1-qi-di-12-ke-zi-fu-she-bei-qu-dong-2-board-insmod-rmmod-mknod-mdev-zi-dong-chuang-jian-she-bei-jie-dian-name-dui-ying-guan-xi-wen-ti-nfs-server-not-responding-still-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]<br> <strong><font color=red> NFS: server 192.168.81.32 not responding,still trying..  </font></strong><br>在使用nfs插入内核模块时候，可能出现问题：<font color=red> NFS: server 192.168.81.32 not responding,still trying..  </font><br>解决办法：<a href="https://blog.csdn.net/gatieme/article/details/48625481">https://blog.csdn.net/gatieme/article/details/48625481</a><br>大意是：NFS 的默认传输协议是 UDP，而PC机与嵌入式系统通过UPD交互时就会出现严重的网卡丢包现象； nfs挂载时选择tcp就可以了，</p><ol><li><code>mount -t nfs -o nolock 192.168.1.103:/nfs/fs_root /mnt</code> // 默认udp</li><li><code>mount -t nfs -o tcp,nolock 192.168.1.103:/nfs/fs_root /mnt</code> // tcp，可以传输大文件</li></ol><p>服务端和board端的nfs安装和连接参考<a href="https://editor.csdn.net/md/?articleId=103464574">https://editor.csdn.net/md/?articleId=103464574</a>之挂接NFS。</p><h2 id="编写简单的board字符设备驱动，插入到内核，从内核删除，创建节点"><a href="#编写简单的board字符设备驱动，插入到内核，从内核删除，创建节点" class="headerlink" title="编写简单的board字符设备驱动，插入到内核，从内核删除，创建节点"></a>编写简单的board字符设备驱动，插入到内核，从内核删除，创建节点</h2><h3 id="1-简单的字符设备驱动程序"><a href="#1-简单的字符设备驱动程序" class="headerlink" title="1. 简单的字符设备驱动程序"></a>1. 简单的字符设备驱动程序</h3><h4 id="驱动程序名称demo-chrdev-c，"><a href="#驱动程序名称demo-chrdev-c，" class="headerlink" title="驱动程序名称demo_chrdev.c，"></a>驱动程序名称demo_chrdev.c，</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span> </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h></span> </span><span class="token comment">// 操作方法</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">demo_cdev_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filep<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"--%s--%s--%d\n"</span><span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">demo_cdev_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filep<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>ppos<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"--%s--%s--%d\n"</span><span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 操作方法集</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>    <span class="token punctuation">.</span>open  <span class="token operator">=</span> demo_cdev_open<span class="token punctuation">,</span>    <span class="token punctuation">.</span>write <span class="token operator">=</span> demo_cdev_write<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 入口函数</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">demo_cdev_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">register_chrdev</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">,</span> <span class="token string">"demo_chrdev_1"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fops<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 给主设备号为111，0时自动分配，带返回值</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 出口函数</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">demo_cdev_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">unregister_chrdev</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">,</span> <span class="token string">"demo_chrdev_1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 内核模块相关</span><span class="token function">module_init</span><span class="token punctuation">(</span>demo_cdev_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>demo_cdev_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile,"></a>Makefile,</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c">KERN_DIR <span class="token operator">:</span><span class="token operator">=</span> <span class="token operator">/</span>home<span class="token operator">/</span>wuyexkx<span class="token operator">/</span>Desktop<span class="token operator">/</span>韦东山<span class="token operator">/</span>system<span class="token operator">/</span>linux<span class="token operator">-</span><span class="token number">2.6</span><span class="token number">.22</span><span class="token number">.6</span>PWD <span class="token operator">:</span><span class="token operator">=</span> $<span class="token punctuation">(</span>shell pwd<span class="token punctuation">)</span># 执行pwd命令并把结果赋给PWDobj<span class="token operator">-</span>m <span class="token operator">:</span><span class="token operator">=</span> demo_chrdev<span class="token punctuation">.</span>o  # <span class="token punctuation">.</span>ko的生成依赖于<span class="token punctuation">.</span>o，<span class="token punctuation">.</span>o默认依赖<span class="token punctuation">.</span>call<span class="token operator">:</span>make <span class="token operator">-</span>C $<span class="token punctuation">(</span>KERN_DIR<span class="token punctuation">)</span> M<span class="token operator">=</span>$<span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> modules CROSS_COMPILE<span class="token operator">=</span>arm<span class="token operator">-</span>linux<span class="token operator">-</span> ARCH<span class="token operator">=</span>arm # modules为编译目标clean<span class="token operator">:</span>make <span class="token operator">-</span>C $<span class="token punctuation">(</span>KERN_DIR<span class="token punctuation">)</span> M<span class="token operator">=</span>$<span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> clean<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-将-ko插入到内核"><a href="#2-将-ko插入到内核" class="headerlink" title="2. 将.ko插入到内核"></a>2. 将.ko插入到内核</h3><p>make之后就生成了demo_chrdev.ko模块文件。<br>查看当前系统的设备有哪些（主设备号&#8195;名字）： <code>cat /proc/devices</code>：<br><img src="https://img-blog.csdnimg.cn/2019121814575436.png">  <img src="/images/2019121814580757.png"><br>加载驱动程序到内核，<code>insmod demo_chrdev.ko</code>，可能遇到最前面提到的问题 **<font color=red> NFS: server 192.168.81.32 not responding,still trying..  </font>**。成功之后可以看到对应的设备信息，<code>cat /proc/devices</code>，<br><img src="/images/20191218151159530.png"></p><h3 id="3-将-ko从内核中删除"><a href="#3-将-ko从内核中删除" class="headerlink" title="3. 将.ko从内核中删除"></a>3. 将.ko从内核中删除</h3><p>从内核删除 <code>rmmod demo_chrdev</code>，查看一下，没了，<br><img src="/images/20191218153044670.png"></p><h3 id="4-创建驱动对应的节点"><a href="#4-创建驱动对应的节点" class="headerlink" title="4. 创建驱动对应的节点"></a>4. 创建驱动对应的节点</h3><p>前提是驱动模块已经插入到内核，<code>insmod demo_chrdev.ko</code>，<br>然后创建节点 <code>mknod /dev/xxx c 111 0</code>，设备节点的名称/dev/xxx，设备类型c字符设备，主设备号111，次设备号0，</p><h4 id="用户程序user-open-c，"><a href="#用户程序user-open-c，" class="headerlink" title="用户程序user_open.c，"></a>用户程序user_open.c，</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>    <span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/xxx"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"can't open '/dev/xxx'.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>val<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>得到输出，对应前面驱动代码里的操作方法里的输出，<br><img src="/images/20191218155324782.png"></p><h2 id="自动分配主设备号，自动创建设备节点"><a href="#自动分配主设备号，自动创建设备节点" class="headerlink" title="自动分配主设备号，自动创建设备节点"></a>自动分配主设备号，自动创建设备节点</h2><p>自动创建设备节点，在应用程序中有udev机制，在busybox中有mdev机制。<br>==<a href="https://www.cnblogs.com/OpenShiFt/p/6008562.html">https://www.cnblogs.com/OpenShiFt/p/6008562.html</a> mdev是busybox自带的一个简化版的udev，适合嵌入式应用场合。其具有使用简单的特点。它的作用就是在系统启动和热插拔或动态加载驱动程序时，自动产生驱动程序所需要的节点文件。在以busybox为基础构建嵌入式linux根文件系统时，使用它时最优的选择。==<br>mdev可以<strong>根据系统信息自动创建设备节点</strong>，系统信息是 <strong>在插入内核模块之后系统将该模块信息导入到/sys/class</strong>中，这个需要在驱动代码中配置才能导入，在入口和出口函数中使用，</p><h3 id="驱动程序-demo-chrdev-c"><a href="#驱动程序-demo-chrdev-c" class="headerlink" title="驱动程序 demo_chrdev.c"></a>驱动程序 demo_chrdev.c</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h></span> </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h></span> </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h></span> </span><span class="token comment">// 用于自动创建设备节点的结构</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>demo_class<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">class_device</span> <span class="token operator">*</span>demo_class_devs<span class="token punctuation">;</span><span class="token comment">// 操作方法</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">demo_cdev_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filep<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"--%s--%s--%d\n"</span><span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">demo_cdev_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filep<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>ppos<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"--%s--%s--%d\n"</span><span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 操作方法集</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> fops <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>    <span class="token punctuation">.</span>open  <span class="token operator">=</span> demo_cdev_open<span class="token punctuation">,</span>    <span class="token punctuation">.</span>write <span class="token operator">=</span> demo_cdev_write<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 用于保存获取到的主设备号</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> major <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 入口函数</span><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">demo_cdev_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 自动获取主设备号资源</span>    major <span class="token operator">=</span> <span class="token function">register_chrdev</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"demo_chrdev_1"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fops<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  0自动分配</span>        <span class="token comment">// 以下为 在系统中生成设备信息的步骤</span>    <span class="token comment">// 1. 新建一个class</span>    demo_class <span class="token operator">=</span> <span class="token function">class_create</span><span class="token punctuation">(</span>THIS_MODULE<span class="token punctuation">,</span> <span class="token string">"demo_chrdev_class"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>demo_class<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>demo_class<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2. 在class里边创建一个设备叫xxx，然后mdev自动创建设备节点/dev/xxx</span>    <span class="token comment">//  在/dev目录下创建相应的设备节点</span>    demo_class_devs <span class="token operator">=</span> <span class="token function">class_device_create</span><span class="token punctuation">(</span>demo_class<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"demo_cdev_nodeName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>demo_class_devs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>demo_class_devs<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 出口函数</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">demo_cdev_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">unregister_chrdev</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> <span class="token string">"demo_chrdev_1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 对应卸载</span>    <span class="token function">class_device_unregister</span><span class="token punctuation">(</span>demo_class_devs<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">class_destroy</span><span class="token punctuation">(</span>demo_class<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 内核模块相关</span><span class="token function">module_init</span><span class="token punctuation">(</span>demo_cdev_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">module_exit</span><span class="token punctuation">(</span>demo_cdev_exit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>class_create和class_device_create在drivers/base/class.c中定义，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span><span class="token function">class_create</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>cls<span class="token punctuation">;</span><span class="token keyword">int</span> retval<span class="token punctuation">;</span>cls <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>cls<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cls<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>retval <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span><span class="token keyword">goto</span> error<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">struct</span> <span class="token class-name">class_device</span> <span class="token operator">*</span><span class="token function">class_device_create</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>cls<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">class_device</span> <span class="token operator">*</span>parent<span class="token punctuation">,</span> <span class="token class-name">dev_t</span> devt<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>device<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="用户程序user-open-c"><a href="#用户程序user-open-c" class="headerlink" title="用户程序user_open.c"></a>用户程序user_open.c</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>    <span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/demo_cdev_nodeName"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"can't open '/dev/demo_cdev_nodeName'.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>val<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>只需插入内核模块就自动创建了设备节点：<br>= 在插入内核模块<code>insmod demo_chrdev.ko</code>后，可以看到252设备和设备名称；<br>= 然后在用户程序user_open中修改对应设备节点名称demo_cdev_nodeName后运行， 可以打开设备节点就自动创建了252设备节点；<br>= 然后查看/dev下的那个设备节点，存在；<br>= 内核信息在<code>/sys/class/class_name/dev_node_name/dev</code>中，<code>cat dev</code>可以看到主设备号和次设备号。<br><img src="https://img-blog.csdnimg.cn/20191218175825646.png"><img src="/images/20191218194051759.png"><br><img src="/images/20191218194439760.png"><br><img src="/images/20191218201145495.png"></p><h3 id="为什么会自动创建设备节点"><a href="#为什么会自动创建设备节点" class="headerlink" title="为什么会自动创建设备节点"></a>为什么会自动创建设备节点</h3><p>class_create和class_device_create会在/sys/class下面建立对应的设备节点信息，mdev会根据这些信息创建设备节点。<br>为什么一插入内核模块<code>insmod xxx.ko</code>就会生成这些信息，是因为那两个函数；<br>为什么一在sys/class下一生成这些信息mdev就自动创建设备节点，是因为在脚本文件/etc/init.d/rcS中有 <code>/sbin/mdev &gt; /proc/sys/kernel/hotplug</code>。</p><p><img src="/images/20191218202200850.png"><br>简单解析一下mdev在rcS这个脚本中的使用，<br>mdev有两个主要的用途：初始化常用设备和动态更新。这两个用途都要需要内核的sysfs的支持并且需要把sysfs挂载到/sys。对于动态更新来说，你也需要开启内核的热插拔功能。</p><h2 id="各个name对应的对应关系"><a href="#各个name对应的对应关系" class="headerlink" title="**各个name对应的对应关系"></a>**各个name对应的对应关系</h2><h3 id="1-内核驱动模块名"><a href="#1-内核驱动模块名" class="headerlink" title="1. 内核驱动模块名"></a>1. 内核驱动模块名</h3><p>内核驱动模块的名字是Makefile里指定的<code>obj-m := led_chrdev1.o</code>（一般跟驱动.c文件名字对应）。<br>在<code>insmod led_chrdev1</code>和<code>remmod led_chrdev1</code>时必须是与Makefile中的一致。</p><h3 id="2-主设备号对应的名称-proc-devices"><a href="#2-主设备号对应的名称-proc-devices" class="headerlink" title="2. 主设备号对应的名称/proc/devices"></a>2. 主设备号对应的名称/proc/devices</h3><p>主设备号对应的名字在<code>register_chrdev(0, &quot;major_name_led&quot;, &amp;fops)</code>中指定，在<code>/proc/devices</code>可以看到。</p><h3 id="3-mdev设备class名称"><a href="#3-mdev设备class名称" class="headerlink" title="3. mdev设备class名称"></a>3. mdev设备class名称</h3><p>在<code>class_create(THIS_MODULE, &quot;led_chrdev_class1&quot;)</code>中指定，在<code>/dev/led_chrdev_class1</code>显示。</p><h3 id="4-mdev设备自动创建的节点名称"><a href="#4-mdev设备自动创建的节点名称" class="headerlink" title="4. mdev设备自动创建的节点名称"></a>4. mdev设备自动创建的节点名称</h3><p>在<code>class_device_create(demo_class, NULL, MKDEV(major, 0), NULL, &quot;led_on_off1&quot;)</code>中指定，在<code>/dev/led_chrdev_class1/led_on_off1</code>可以看到。</p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS1期第11课 根文件系统 4 构建根文件系统几个步骤，挂载nfs</title>
      <link href="2021/05/14/wds1-qi-di-11-ke-gen-wen-jian-xi-tong-4-gou-jian-gen-wen-jian-xi-tong-ji-ge-bu-zou-gua-zai-nfs-local/"/>
      <url>2021/05/14/wds1-qi-di-11-ke-gen-wen-jian-xi-tong-4-gou-jian-gen-wen-jian-xi-tong-ji-ge-bu-zou-gua-zai-nfs-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]<br>根据 根文件系统 2  知：<br><strong>最小根文件系统的项</strong></p><ol><li>/dev/console </li><li>/dev/null </li><li>init (busybox)</li><li>/etc/inittab</li><li>配置文件里指定的应用程序或脚本</li><li>C库<h3 id="1-2-创建设备"><a href="#1-2-创建设备" class="headerlink" title="1.2. 创建设备"></a>1.2. 创建设备</h3>查看pc系统的两个设备信息 <code>ls /dev/console /dev/null -l</code>，都是字符设备，5是主设备1是次设备。<br><img src="/images/20191209202705876.png"><br>到上节的根文件系统目录下去，<code>mkdir dev</code> ， <code>cd dev</code>，<br><code>sudo mknod console c 5 1</code> 创建节点console，c字符设备，主设备5次设备1<br><code>sudo mknod null 1 3</code> 创建节点null，c字符设备，主设备1次设备3<br>结果如下：<br><img src="/images/20191209204216113.png"><h3 id="3-init-busybox-在-根文件系统-3-已完成"><a href="#3-init-busybox-在-根文件系统-3-已完成" class="headerlink" title="3. init (busybox)在 根文件系统 3 已完成"></a>3. init (busybox)在 根文件系统 3 已完成</h3><h3 id="4-etc-inittab-配置文件"><a href="#4-etc-inittab-配置文件" class="headerlink" title="4. /etc/inittab 配置文件"></a>4. /etc/inittab 配置文件</h3>创建inittab<br><code>mkdir etc</code><br><code>vim etc/inittab</code><br>填入内容，意思是执行一个askfirst类型的程序 叫做<code> &quot;-/bin/sh&quot;</code>，这个程序的stdin，stdout，stderr定位到<code>console</code>中，<pre class="line-numbers language-c" data-language="c"><code class="language-c">console<span class="token operator">::</span>askfirst<span class="token operator">:</span><span class="token operator">-</span><span class="token operator">/</span>bin<span class="token operator">/</span>sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="6-C库"><a href="#6-C库" class="headerlink" title="6. C库"></a>6. C库</h3>在根文件系统中创建lib文件夹，然后将gcc-3.4.5-glibc-2.3.6/arm-linux/lib目录下的<code>.so</code>拷贝到该目录下，<code>-d</code>表示保持链接文件，其他不是链接文件的直接拷贝，不加<code>-d</code>19M加<code>-d</code>7M，<br><code>mkdir lib</code> 首先在根文件系统中创建lib文件夹<br><code>cd gcc-3.4.5-glibc-2.3.6/arm-linux/lib</code><br><code>cp *.so* /media/D/韦东山/system/fs_root/lib/ -d</code> 然后拷贝.so到lib下 。</li></ol><p><strong><font color=red>注意：<br>1 制作的根文件系统lib库的版本必须与编译内核和编译busybox的交叉工具一致（最好使用厂家推荐的），否则启动卡在：</font></strong></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">VFS<span class="token operator">:</span> Mounted <span class="token function">root</span> <span class="token punctuation">(</span>yaffs filesystem<span class="token punctuation">)</span><span class="token punctuation">.</span>                                           Freeing init memory<span class="token operator">:</span> <span class="token number">140</span>K                                                       Failed to execute <span class="token operator">/</span>linuxrc<span class="token punctuation">.</span>  Attempting defaults<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                             Kernel panic <span class="token operator">-</span> not syncing<span class="token operator">:</span> No init found<span class="token punctuation">.</span>  Try passing init<span class="token operator">=</span> option to kernel<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><strong><font color=red>2 如果是烧写根文件系统，在复制.so时不加<code>-d</code>，直接拷贝不链接，否则启动不了。</font></strong><br><strong>我的编译交叉工具的lib库在<code>/usr/local/arm/gcc-3.4.5-glibc-2.3.6/arm-linux/lib</code>。</strong></p><h3 id="5-那些配置文件中指定的程序或脚本"><a href="#5-那些配置文件中指定的程序或脚本" class="headerlink" title="5. 那些配置文件中指定的程序或脚本"></a>5. 那些配置文件中指定的程序或脚本</h3><p>暂未指定</p><h3 id="制作映像文件（目的是烧写）"><a href="#制作映像文件（目的是烧写）" class="headerlink" title="制作映像文件（目的是烧写）"></a>制作映像文件（目的是烧写）</h3><p>把制作好的根文件系统烧写到开发板，需要制作根文件系统。<br>yaffs1映像文件针对小页nand，每页512Byte。<br>大页nand每页2048Byte，所以要用yaffs2。<br><strong>制作映像文件的工具也是需要修改的。</strong><br>给的资料已经改好，在压缩包里：<code>yaffs_source_util_larger_small_page_nand.tar.bz2</code>。</p><ol><li>先解压：<code>tar xjf yaffs_source_util_larger_small_page_nand.tar.bz2</code> </li><li>再make，<code>cd Development_util_ok/yaffs2/utils</code><br><code>make</code><br><img src="/images/20191210203843492.png"></li><li>生成的工具拷贝到pc目录<br><code>sudo cp mkyaffs2image /usr/local/bin/</code>，将生成的工具<code>mkyaffs2image</code>拷贝到pc系统目录<code>/usr/local/bin/</code> </li><li>给工具加权限<br><code>sudo chmod +x /usr/local/bin/mkyaffs2image </code>加上可执行权限</li><li>用生成的工具将根文件系统制作成映像文件<br>到根文件系统所在目录执行：<code>mkyaffs2image fs_root fs_root.yaffs2</code><br><img src="/images/20191210203731668.png"></li></ol><p>上面步骤完成最小根文件系统的构建。</p><h3 id="root-etc-init-d，fstab"><a href="#root-etc-init-d，fstab" class="headerlink" title="root/etc/ (init.d，fstab)"></a>root/etc/ (init.d，fstab)</h3><p>一些配置文件<br><strong>添加ps功能：</strong></p><p>有些命令还是不能执行如<code>ps</code>，需要挂载<strong>由内核提供的虚拟文件系统proc</strong>，自动收集进程信息，在console中操作，<br>&#8195; <code>mkdir proc</code> 创建目录<br>&#8195; <code>mount -t proc none /proc</code> 手动挂载<br>查看proc下的文件，<code>cd proc/1</code>，pid等于1的进程，<code>ls fd -l</code>，fd指向0stdout，1stdin，2stderr，<br><img src="/images/20191211171958235.png"><br><strong>自动挂载proc文件，</strong></p><ol><li><p>回到pc，在构建的根文件系统中创建文件夹proc：<code>mkdir proc</code></p></li><li><p>需要修改配置文件，回到pc，在自己制作的根文件系统下，打开inittab，<code>vim etc/inittab</code>，添加后如下，</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c">console<span class="token operator">::</span>askfirst<span class="token operator">:</span><span class="token operator">-</span><span class="token operator">/</span>bin<span class="token operator">/</span>sh<span class="token operator">::</span>sysinit<span class="token operator">:</span><span class="token operator">/</span>etc<span class="token operator">/</span>init<span class="token punctuation">.</span>d<span class="token operator">/</span>rcS<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p> 然后创建脚本所在文件夹<code>mkdir etc/init.d</code>，再创建脚本，<code>vim etc/init.d/rcS</code>，添加内容意思挂载proc文件，</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c">mount <span class="token operator">-</span>t proc none <span class="token operator">/</span>proc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p> 加上可执行权限：<code>chmod +x etc/init.d/rcS </code>，这样启动之后就会自动运行这个脚本，挂在proc文件。</p></li><li><p>也可用<code>mount -a</code>，这个命令会根据etc/fstab文件的内容来挂在哪些文件系统，rtc/fstab的格式如下，<br><img src="/images/20191211174803443.png">以上两个文件修改后内容如下：<br><img src="/images/20191211175807272.png"></p><h3 id="root-dev，使用udev"><a href="#root-dev，使用udev" class="headerlink" title="root/dev，使用udev"></a>root/dev，使用udev</h3><p>/dev/下存放一些驱动节点。<br>udev工具能够自动创建/dev/设备节点，简化版本为mdev，使用方法在busybox-1.7.0/docs/mdev.txt，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">Here's a typical code snippet from the init script<span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> mount <span class="token operator">-</span>t sysfs sysfs <span class="token operator">/</span>sys<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> echo <span class="token operator">/</span>bin<span class="token operator">/</span>mdev <span class="token operator">></span> <span class="token operator">/</span>proc<span class="token operator">/</span>sys<span class="token operator">/</span>kernel<span class="token operator">/</span>hotplug<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> mdev <span class="token operator">-</span>sOf course<span class="token punctuation">,</span> a more <span class="token string">"full"</span> setup would entail executing this before the previouscode snippet<span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> mount <span class="token operator">-</span>t tmpfs mdev <span class="token operator">/</span>dev<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> mkdir <span class="token operator">/</span>dev<span class="token operator">/</span>pts<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> mount <span class="token operator">-</span>t devpts devpts <span class="token operator">/</span>dev<span class="token operator">/</span>pts<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>操作：</p></li><li><p>在pc上，根文件系统新建sys文件夹，<code>mkdir sys</code></p></li><li><p>在etc/fstab中修改：sysfs也是虚拟文件系统</p> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">device</span> <span class="token expression">mount<span class="token operator">-</span>point   type    options  dump  fsck  order</span></span>proc      <span class="token operator">/</span>proc        proc    defaults  <span class="token number">0</span>     <span class="token number">0</span>sysfs     <span class="token operator">/</span>sys         sysfs   defaults  <span class="token number">0</span>     <span class="token number">0</span>tmpfs     <span class="token operator">/</span>dev         tmpfs   defaults  <span class="token number">0</span>     <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>在etc/init.d/rcS中修改：hotplug热拔插，动态加载驱动，当插入设备时内核调用hotplug，它指向mdev，/sbin/mdev这个程序就会自动创建设备节点；<code>mdev -s</code>表示先把有的设备都创建出来，</p> <pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token preprocessor property"># mount -t proc none /proc</span>mount <span class="token operator">-</span>amkdir <span class="token operator">/</span>dev<span class="token operator">/</span>ptsmount <span class="token operator">-</span>t devpts devpts <span class="token operator">/</span>dev<span class="token operator">/</span>ptsecho <span class="token operator">/</span>sbin<span class="token operator">/</span>mdev <span class="token operator">></span> <span class="token operator">/</span>proc<span class="token operator">/</span>sys<span class="token operator">/</span>kernel<span class="token operator">/</span>hotplugmdev <span class="token operator">-</span>s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p> <img src="/images/20191211211816873.png"><br> 重新制作映像文件，烧写。</p><h3 id="制作用于nand的jffs2格式文件系统"><a href="#制作用于nand的jffs2格式文件系统" class="headerlink" title="制作用于nand的jffs2格式文件系统"></a>制作用于nand的jffs2格式文件系统</h3><h4 id="制作工具"><a href="#制作工具" class="headerlink" title="制作工具"></a>制作工具</h4><p>jffs2格式的文件系统一般用于nor上，要把jffs2用在nand上需要制作工具。<br>书上有。</p><h3 id="挂接NFS（目的是不烧写）"><a href="#挂接NFS（目的是不烧写）" class="headerlink" title="挂接NFS（目的是不烧写）"></a>挂接NFS（目的是不烧写）</h3><p>服务的安装NFS服务：<code>sudo apt-get install nfs-kernel-server -y</code></p></li></ol><h4 id="先在flash上启动已有的根文件系统，然后在linux系统中挂接NFS"><a href="#先在flash上启动已有的根文件系统，然后在linux系统中挂接NFS" class="headerlink" title="先在flash上启动已有的根文件系统，然后在linux系统中挂接NFS"></a>先在flash上启动已有的根文件系统，然后在linux系统中挂接NFS</h4><p>有两个条件：1 服务器允许该目录被挂接 2 开发板去挂接</p><ol><li>nfs服务在/etc/exports中配置， <pre class="line-numbers language-c" data-language="c"><code class="language-c"># <span class="token operator">/</span>nfs<span class="token operator">/</span>fs_root     ：要共享的路径# <span class="token operator">*</span>                ：<span class="token operator">*</span>通配，表示所有网段都可以访问<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">sync</span>             <span class="token expression">：同步写入硬盘</span></span><span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">no</span><span class="token expression">_root_squash   ：nfs客户端共享目录使用者权限</span></span><span class="token operator">/</span>nfs<span class="token operator">/</span>fs_root <span class="token operator">*</span><span class="token punctuation">(</span>rw<span class="token punctuation">,</span>sync<span class="token punctuation">,</span>no_root_squash<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre> 重启服务：<code>sudo /etc/init.d/nfs-kernel-server restart</code></li><li>在开发板上挂接<br>新建挂载的目录mnt，<code>mkdir mnt</code><br>1 <code>mount -t nfs -o nolock 192.168.1.103:/nfs/fs_root /mnt</code> // 默认udp<br>2 <code>mount -t nfs -o tcp,nolock 192.168.1.103:/nfs/fs_root /mnt</code> // tcp，可以传输大文件<h4 id="直接从根文件启动"><a href="#直接从根文件启动" class="headerlink" title="直接从根文件启动"></a>直接从根文件启动</h4>在开发板的uboot中设置参数bootargs<br>原来参数<code>bootargs=noinitrd root=/dev/mtdblock3 init=/linuxrc console=ttySAC0,115200</code><br><code>set bootargs noinitrd root=/dev/mtdblock3 init=/linuxrc console=ttySAC0,115200</code><br>两个条件： 1 设置服务器的ip和目录 2 自己的ip<br>格式在内核文件Documentation/nfsroot.txt中，<pre class="line-numbers language-c" data-language="c"><code class="language-c">nfsroot<span class="token operator">=</span><span class="token punctuation">[</span><span class="token operator">&lt;</span>server<span class="token operator">-</span>ip<span class="token operator">></span><span class="token operator">:</span><span class="token punctuation">]</span><span class="token operator">&lt;</span>root<span class="token operator">-</span>dir<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token operator">&lt;</span>nfs<span class="token operator">-</span>options<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>ip<span class="token operator">=</span><span class="token operator">&lt;</span>client<span class="token operator">-</span>ip<span class="token operator">></span><span class="token operator">:</span><span class="token operator">&lt;</span>server<span class="token operator">-</span>ip<span class="token operator">></span><span class="token operator">:</span><span class="token operator">&lt;</span>gw<span class="token operator">-</span>ip<span class="token operator">></span><span class="token operator">:</span><span class="token operator">&lt;</span>netmask<span class="token operator">></span><span class="token operator">:</span><span class="token operator">&lt;</span>hostname<span class="token operator">></span><span class="token operator">:</span><span class="token operator">&lt;</span>device<span class="token operator">></span><span class="token operator">:</span><span class="token operator">&lt;</span>autoconf<span class="token operator">></span>对应设置为：set bootargs noinitrd root<span class="token operator">=</span><span class="token operator">/</span>dev<span class="token operator">/</span>nfs nfsroot<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.103</span><span class="token operator">:</span><span class="token operator">/</span>nfs<span class="token operator">/</span>fs_root ip<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.100</span><span class="token operator">:</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.103</span><span class="token operator">:</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span><span class="token operator">::</span>eth0<span class="token operator">:</span>off init<span class="token operator">=</span><span class="token operator">/</span>linuxrc console<span class="token operator">=</span>ttySAC0<span class="token punctuation">,</span><span class="token number">115200</span>set bootargs noinitrd root<span class="token operator">=</span><span class="token operator">/</span>dev<span class="token operator">/</span>nfs nfsroot<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.103</span><span class="token operator">:</span><span class="token operator">/</span>nfs<span class="token operator">/</span>fs_root ip<span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.11</span><span class="token operator">:</span><span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.103</span><span class="token operator">:</span><span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">255.255</span><span class="token number">.255</span><span class="token number">.0</span><span class="token operator">::</span>eth0<span class="token operator">:</span>off init<span class="token operator">=</span><span class="token operator">/</span>linuxrc console<span class="token operator">=</span>ttySAC0<span class="token punctuation">,</span><span class="token number">115200</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS1期第11课 根文件系统 3 busybox 编译安装根文件系统make menuconfig install</title>
      <link href="2021/05/14/wds1-qi-di-11-ke-gen-wen-jian-xi-tong-3-busybox-bian-yi-an-zhuang-gen-wen-jian-xi-tong-make-menuconfig-install-local/"/>
      <url>2021/05/14/wds1-qi-di-11-ke-gen-wen-jian-xi-tong-3-busybox-bian-yi-an-zhuang-gen-wen-jian-xi-tong-make-menuconfig-install-local/</url>
      
        <content type="html"><![CDATA[<p>配置 编译 busybox，在根目录下INSTALL文件里有说明，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">make menuconfig     # This creates a file called <span class="token string">".config"</span>make                # This creates the <span class="token string">"busybox"</span> executablemake install        # or make CONFIG_PREFIX<span class="token operator">=</span><span class="token operator">/</span>path<span class="token operator">/</span>from<span class="token operator">/</span>root install<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ol><li>解压 <code>tar xjf busybox-1.7.0.tar.bz2</code></li><li><code>make menuconfig</code>，</li></ol><p><strong>选择补全命令</strong><br>    <pre class="line-numbers language-c" data-language="c"><code class="language-c">Busybox Settings  <span class="token operator">--</span><span class="token operator">-></span>Busybox Library Tuning  <span class="token operator">--</span><span class="token operator">-></span><span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> Tab completion <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><br>    <strong>修改交叉编译工具</strong>：新版busybox可以在交互界面直接选择，1.7.0版本只能在顶层Makefile中修改，<code>CROSS_COMPILE    ?= arm-linux-</code>。<br>    ==可能出错==：Makefile:405: *** mixed implicit and normal rules: deprecated syntax<br>    Makefile:1242: *** mixed implicit and normal rules: deprecated syntax<br>    ==原因==：新版Makefile不支持这样的组合目标：config %config(一个有通配符，另一个没有通配符)<br>    ==办法== :要么把config %config拆成2个规则，要么把其中一个目标去掉。<br>    ==具体措施==：<br>    a.顶层Makefile 405行 改为: <code>%config:scripts_basic outputmakefile FORCE</code><br>    b.顶层Makefile 1242行  改为: <code>%/:prepare scripts FORCE</code><br>3. <code>make</code><br>可能出错1：/include/linux/netfilter.h:57:17: error: field ‘in’ has incomplete type<br>make[1]: *** [ipsvd/tcpudp.o] Error 1<br>Makefile:701: recipe for target ‘ipsvd’ failed<br>根据提示的路径找到netfilter.h，添加头文件<code>#include &lt;netinet/in.h&gt;</code><br><img src="/images/20191209094338668.png"><br>可能出错2：recipe for target ‘loginutils/passwd.o’ failed<br>make[1]: *** [loginutils/passwd.o] Error 1<br>Makefile:701: recipe for target ‘loginutils’ failed<br>办法：BusyBox源码的include目录下/libbb.h 文件添加头文件 <code>#include &lt;sys/resource.h&gt;</code><br><img src="/images/20191209101313289.png"><br>最终出现以下说明编译成功：<br><img src="/images/20191209094827170.png"><br>4. install<br>不能make install，这将安装到PC系统可能导致系统出错，<br>创建一个目录，<code>mkdir -p fs_root</code><br>然后安装到该目录下，<code>make CONFIG_PREFIX=/fs_root install</code><br>出现如下应该安装成功：<br><img src="/images/20191209101802674.png"><br><code>ls -l</code>：可以看到所有工具都指向了busybox，<br><img src="/images/20191209101731984.png"><br><img src="/images/20191209102004531.png"></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS1期第11课 根文件系统 1 _dev_console run_init_process(execute_command) sbin_init _etc_init</title>
      <link href="2021/05/14/wds1-qi-di-11-ke-gen-wen-jian-xi-tong-1-dev-console-run-init-process-execute-command-sbin-init-etc-init-local/"/>
      <url>2021/05/14/wds1-qi-di-11-ke-gen-wen-jian-xi-tong-1-dev-console-run-init-process-execute-command-sbin-init-etc-init-local/</url>
      
        <content type="html"><![CDATA[<p><img src="/images/2020010809154623.png"><br><img src="/images/20200108092238864.png"><br>uboot的目的是启动内核<br>内核的目的是启动应用程序<br>应用程序位于根文件系统</p><p>查看内核怎么启动应用程序，在init/main.c中，</p><h3 id="打开设备”-dev-console”"><a href="#打开设备”-dev-console”" class="headerlink" title="打开设备”/dev/console”"></a>打开设备”/dev/console”</h3><p>打开了一个设备sys_open((const char __user *) “/dev/console”, O_RDWR, 0)，这个文件 “/dev/console”对应的就是终端（这里是串口0，其他可能是键盘和液晶的组合），<br>    (void) sys_dup(0);<br>    (void) sys_dup(0);<br>    这两个表示标准输入输出错误信息复制到 “/dev/console”下显示，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> noinline <span class="token function">init_post</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">free_initmem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">unlock_kernel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">mark_rodata_ro</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>system_state <span class="token operator">=</span> SYSTEM_RUNNING<span class="token punctuation">;</span><span class="token function">numa_default_policy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sys_open</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token string">"/dev/console"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"Warning: unable to open an initial console.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token function">sys_dup</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token function">sys_dup</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ramdisk_execute_command<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">run_init_process</span><span class="token punctuation">(</span>ramdisk_execute_command<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"Failed to execute %s\n"</span><span class="token punctuation">,</span>ramdisk_execute_command<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/* * We try each of these until one succeeds. * * The Bourne shell can be used instead of init if we are * trying to recover a really broken machine. */</span><span class="token keyword">if</span> <span class="token punctuation">(</span>execute_command<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">run_init_process</span><span class="token punctuation">(</span>execute_command<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING <span class="token string">"Failed to execute %s.  Attempting "</span><span class="token string">"defaults...\n"</span><span class="token punctuation">,</span> execute_command<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">run_init_process</span><span class="token punctuation">(</span><span class="token string">"/sbin/init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">run_init_process</span><span class="token punctuation">(</span><span class="token string">"/etc/init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">run_init_process</span><span class="token punctuation">(</span><span class="token string">"/bin/init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">run_init_process</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"No init found.  Try passing init= option to kernel."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后查看是否定义execute_command，去启动execute_command程序run_init_process(execute_command);，<br>execute_command=/linuxrc保存着uboot传入的参数<code>init=/linuxrc</code>，<br><code>bootargs=noinitrd root=/dev/mtdblock3 init=/linuxrc console=ttySAC0,115200 </code></p><h3 id="run-init-process启动"><a href="#run-init-process启动" class="headerlink" title="run_init_process启动"></a>run_init_process启动</h3><p>run_init_process启动linuxrc或”/sbin/init”或”/etc/init”或”/bin/init”或”/bin/sh”，这些都是死循环，一旦程序一去则不复还，所以执行一般要么命令行指定的linuxrc，要么第一个”/sbin/init”，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">init_setup</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span>execute_command <span class="token operator">=</span> str<span class="token punctuation">;</span><span class="token comment">/* * In case LILO is going to boot us with default command line, * it prepends "auto" before the whole cmdline which makes * the shell think it should execute a script with such name. * So we ignore all arguments entered _before_ init=... [MJ] */</span><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_INIT_ARGS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>argv_init<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">__setup</span><span class="token punctuation">(</span><span class="token string">"init="</span><span class="token punctuation">,</span> init_setup<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="挂载根文件系统"><a href="#挂载根文件系统" class="headerlink" title="挂载根文件系统"></a>挂载根文件系统</h3><p>擦除根文件后启动内核的结果，<br>擦除文件系统后启动提示挂接了根文件系统（空的也能挂载），是因为格式化后可以作为任意的文件系统，但是空的而已，所以启动不了应用程序，<br>在没有打开dev/console时会有警告<code>Warning: unable to open an initial console.</code>与上面init_post中代码对应，<br>因为没有根文件系统了，所以/linux也不存在，所以execute_command没有赋值，所以输出<code>Failed to execute /linuxrc.  Attempting defaults...</code>，与上面init_post中代码对应，<br>没有根文件系统所以”/sbin/init” “/etc/init” “/bin/init” “/bin/sh”都无法执行，输出<code>No init found.  Try passing init= option to kernel.</code>，<br><img src="/images/20191207210234799.png"><br>烧写根文件系统，重新启动，b启动内核，用ps命令查看当前的应用程序，<br>init是内核启动的第一个应用程序，<br>-sh，是输入字母回显字母的应用程序<br>ls可以查看目录下有哪些文件夹</p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS1期第11课  根文件系统 2 init进程</title>
      <link href="2021/05/14/wds1-qi-di-11-ke-gen-wen-jian-xi-tong-2-init-jin-cheng-local/"/>
      <url>2021/05/14/wds1-qi-di-11-ke-gen-wen-jian-xi-tong-2-init-jin-cheng-local/</url>
      
        <content type="html"><![CDATA[<p>linux系统的各种命令如ls，ps，cp等都是由一个程序提供busybox，<br>跟busybox ls，busybox ps使用一样。<br>在init/main.c中的<code>run_init_process(&quot;/sbin/init&quot;);</code>，<br>/sbin/init进程也是busybox的链接：<br><img src="/images/20191208143531589.png">想要弄清楚init进程就要=要分析busybox的源码。解压，<br>cp命令相关的源文件coreutils/cp.c，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">cp_main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>init相关源码，init/init.c，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">init_main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>内核启动了第一个进程init，但内核目的是为了启动用户的应用程序，所以首先应该有个配置，然后解析配置，再根据配置文件去执行用户程序。</p><p><strong>此文大致讲了以下程序调用过程：</strong></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">busybox<span class="token operator">--</span><span class="token operator">></span>init_main运行流程parse_inittab<span class="token function">fopen</span><span class="token punctuation">(</span>INITTAB<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token comment">// 创建一个init_action结构，填充</span>new_init_action<span class="token comment">// 把这个结构放入init_action_list链表</span><span class="token function">run_actions</span><span class="token punctuation">(</span>SYSINIT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">waitfor</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 执行应用程序，等待它执行完毕</span><span class="token function">run</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 创建子进程</span><span class="token function">waitpid</span><span class="token punctuation">(</span>runpid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待执行完毕</span><span class="token function">delete_init_action</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 在init_action_list中删除；</span><span class="token function">run_actions</span><span class="token punctuation">(</span>WAIT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">waitfor</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 执行应用程序，等待它执行完毕</span><span class="token function">run</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 创建子进程</span><span class="token function">waitpid</span><span class="token punctuation">(</span>runpid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待执行完毕</span><span class="token function">delete_init_action</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 在init_action_list中删除；</span><span class="token function">run_actions</span><span class="token punctuation">(</span>ONCE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">run</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 创建子进程</span><span class="token function">delete_init_action</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 在init_action_list中删除；</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">run_actions</span><span class="token punctuation">(</span>RESPAWN<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token operator">-></span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>a<span class="token operator">-></span>pid <span class="token operator">=</span> <span class="token function">run</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">run_actions</span><span class="token punctuation">(</span>ASKFIRST<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token operator">-></span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>a<span class="token operator">-></span>pid <span class="token operator">=</span> <span class="token function">run</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>打印：<span class="token string">"\nPlease press Enter to activate this console. "</span>等待回车创建子进程<span class="token punctuation">&#125;</span>wpid <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待子进程退出</span><span class="token keyword">while</span> <span class="token punctuation">(</span>wpid <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>a<span class="token operator">-></span>pid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">// 推出后设置pid为0</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="查看init进程的源码"><a href="#查看init进程的源码" class="headerlink" title="查看init进程的源码"></a>查看init进程的源码</h3><p>一些快捷键的处理，然后初始化consle，跟之前的标准输入/输出/错误有关。内核启动引用程序时没有给什么参数，所以argc=1，所以执行<code>parse_inittab();</code>也在init/init.c中，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">init_main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span> ctrlaltdel_signal<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">console_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">/* Check if we are supposed to be in single user mode */</span><span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"single"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"-s"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">LONE_CHAR</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">/* Start a shell on console */</span><span class="token function">new_init_action</span><span class="token punctuation">(</span>RESPAWN<span class="token punctuation">,</span> bb_default_login_shell<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">/* Not in single user mode -- see what inittab says */</span><span class="token comment">/* NOTE that if CONFIG_FEATURE_USE_INITTAB is NOT defined, * then parse_inittab() simply adds in some default * actions(i.e., runs INIT_SCRIPT and then starts a pair * of "askfirst" shells */</span><span class="token function">parse_inittab</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c">busyboxinit_mainparse_inittab<span class="token function">fopen</span><span class="token punctuation">(</span>INITTAB<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span>new_init_action<span class="token function">run_actions</span><span class="token punctuation">(</span>SYSINIT<span class="token punctuation">)</span><span class="token function">run_actions</span><span class="token punctuation">(</span>WAIT<span class="token punctuation">)</span><span class="token function">run_actions</span><span class="token punctuation">(</span>ONCE<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在parse_inittab中，打开了inittab配置文件，配置文件格式，<br><code># Format for each entry: &lt;id&gt;:&lt;runlevels&gt;:&lt;action&gt;:&lt;process&gt;</code>，配置文件用于配置哪个进程，何时执行。<br>id： –&gt; /dev/id，用作stdin，stdout，stderr；printf，scanf，err等<br>runlevels：可以忽略<br>action：执行时机<br>process：应用程序或脚本<br>如果配置文件为空，执行下面的默认配置，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">file <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>INITTAB<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">/* No inittab file -- set up some default behavior */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token comment">/* Reboot on Ctrl-Alt-Del */</span><span class="token function">new_init_action</span><span class="token punctuation">(</span>CTRLALTDEL<span class="token punctuation">,</span> <span class="token string">"reboot"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* Umount all filesystems on halt/reboot */</span><span class="token function">new_init_action</span><span class="token punctuation">(</span>SHUTDOWN<span class="token punctuation">,</span> <span class="token string">"umount -a -r"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* Swapoff on halt/reboot */</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ENABLE_SWAPONOFF<span class="token punctuation">)</span> <span class="token function">new_init_action</span><span class="token punctuation">(</span>SHUTDOWN<span class="token punctuation">,</span> <span class="token string">"swapoff -a"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* Prepare to restart init when a HUP is received */</span><span class="token function">new_init_action</span><span class="token punctuation">(</span>RESTART<span class="token punctuation">,</span> <span class="token string">"init"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* Askfirst shell on tty1-4 */</span><span class="token function">new_init_action</span><span class="token punctuation">(</span>ASKFIRST<span class="token punctuation">,</span> bb_default_login_shell<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">new_init_action</span><span class="token punctuation">(</span>ASKFIRST<span class="token punctuation">,</span> bb_default_login_shell<span class="token punctuation">,</span> VC_2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">new_init_action</span><span class="token punctuation">(</span>ASKFIRST<span class="token punctuation">,</span> bb_default_login_shell<span class="token punctuation">,</span> VC_3<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">new_init_action</span><span class="token punctuation">(</span>ASKFIRST<span class="token punctuation">,</span> bb_default_login_shell<span class="token punctuation">,</span> VC_4<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* sysinit */</span><span class="token function">new_init_action</span><span class="token punctuation">(</span>SYSINIT<span class="token punctuation">,</span> INIT_SCRIPT<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>不为空的话就解析配置文件的内容，忽略注释#，对id加上dev前缀，最终根据配置文件调用new_init_action，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Skip the line if it's a comment */</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>id <span class="token operator">==</span> <span class="token string">'#'</span> <span class="token operator">||</span> <span class="token operator">*</span>id <span class="token operator">==</span> <span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">for</span> <span class="token punctuation">(</span>a <span class="token operator">=</span> actions<span class="token punctuation">;</span> a<span class="token operator">-></span>name <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span> a<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>a<span class="token operator">-></span>name<span class="token punctuation">,</span> action<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>id <span class="token operator">!=</span> <span class="token string">'\0'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token string">"/dev/"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>id <span class="token operator">+=</span> <span class="token number">5</span><span class="token punctuation">;</span><span class="token function">strcpy</span><span class="token punctuation">(</span>tmpConsole<span class="token punctuation">,</span> <span class="token string">"/dev/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">safe_strncpy</span><span class="token punctuation">(</span>tmpConsole <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>tmpConsole<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>id <span class="token operator">=</span> tmpConsole<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">new_init_action</span><span class="token punctuation">(</span>a<span class="token operator">-></span>action<span class="token punctuation">,</span> command<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查看new_init_action怎么执行解析到的内容，init/init.c，<br>以<code>new_init_action(ASKFIRST, bb_default_login_shell, VC_2);</code>为例，依次替换出来，<br><code>new_init_action(0x004, &quot;-/bin/sh&quot;, &quot;/dev/tty2&quot;);</code>，<br>id： –&gt; /dev/id，执行终端(串口)，用作stdin，stdout，stderr；printf，scanf，err等<br>runlevels：可以忽略<br>action：执行时机<br>process：应用程序或脚本<br><code>new_init_action(0x004, &quot;-/bin/sh&quot;, &quot;/dev/tty2&quot;);</code>，<br><code>static void new_init_action(int action, const char *command, const char *cons)</code>，对应上了。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">new_init_action</span><span class="token punctuation">(</span><span class="token keyword">int</span> action<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>command<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>cons<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">init_action</span> <span class="token operator">*</span>new_action<span class="token punctuation">,</span> <span class="token operator">*</span>a<span class="token punctuation">,</span> <span class="token operator">*</span>last<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cons<span class="token punctuation">,</span> bb_dev_null<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>action <span class="token operator">&amp;</span> ASKFIRST<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token comment">/* Append to the end of the list */</span><span class="token keyword">for</span> <span class="token punctuation">(</span>a <span class="token operator">=</span> last <span class="token operator">=</span> init_action_list<span class="token punctuation">;</span> a<span class="token punctuation">;</span> a <span class="token operator">=</span> a<span class="token operator">-></span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">/* don't enter action if it's already in the list, * but do overwrite existing actions */</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>a<span class="token operator">-></span>command<span class="token punctuation">,</span> command<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>a<span class="token operator">-></span>terminal<span class="token punctuation">,</span> cons<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>a<span class="token operator">-></span>action <span class="token operator">=</span> action<span class="token punctuation">;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>last <span class="token operator">=</span> a<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>new_action <span class="token operator">=</span> <span class="token function">xzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">init_action</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>last<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>last<span class="token operator">-></span>next <span class="token operator">=</span> new_action<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>init_action_list <span class="token operator">=</span> new_action<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">strcpy</span><span class="token punctuation">(</span>new_action<span class="token operator">-></span>command<span class="token punctuation">,</span> command<span class="token punctuation">)</span><span class="token punctuation">;</span>new_action<span class="token operator">-></span>action <span class="token operator">=</span> action<span class="token punctuation">;</span><span class="token function">strcpy</span><span class="token punctuation">(</span>new_action<span class="token operator">-></span>terminal<span class="token punctuation">,</span> cons<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">messageD</span><span class="token punctuation">(</span>L_LOG <span class="token operator">|</span> L_CONSOLE<span class="token punctuation">,</span> <span class="token string">"command='%s' action=%d tty='%s'\n"</span><span class="token punctuation">,</span>new_action<span class="token operator">-></span>command<span class="token punctuation">,</span> new_action<span class="token operator">-></span>action<span class="token punctuation">,</span> new_action<span class="token operator">-></span>terminal<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>new_init_action做了这些事，</p><ol><li>创建一个init_action，然后根据传入的参数填充</li><li>把这个结构放入init_action_list链表</li></ol><p>以上，找到init_action_list是什么东西，由一个嵌套的结构体init_action定义的指针，<br>找到init_action，<br>执行时机<br>进程号<br>应用程序<br>终端</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Set up a linked list of init_actions, to be read from inittab */</span><span class="token keyword">struct</span> <span class="token class-name">init_action</span> <span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">init_action</span> <span class="token operator">*</span>next<span class="token punctuation">;</span><span class="token keyword">int</span> action<span class="token punctuation">;</span><span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span><span class="token keyword">char</span> command<span class="token punctuation">[</span>INIT_BUFFS_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">char</span> terminal<span class="token punctuation">[</span>CONSOLE_NAME_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>又回到parse_inittab如果没有配置文件，反推出默认配置是什么，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">/* No inittab file -- set up some default behavior */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token comment">/* Reboot on Ctrl-Alt-Del */</span><span class="token function">new_init_action</span><span class="token punctuation">(</span>CTRLALTDEL<span class="token punctuation">,</span> <span class="token string">"reboot"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* Umount all filesystems on halt/reboot */</span><span class="token function">new_init_action</span><span class="token punctuation">(</span>SHUTDOWN<span class="token punctuation">,</span> <span class="token string">"umount -a -r"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* Swapoff on halt/reboot */</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ENABLE_SWAPONOFF<span class="token punctuation">)</span> <span class="token function">new_init_action</span><span class="token punctuation">(</span>SHUTDOWN<span class="token punctuation">,</span> <span class="token string">"swapoff -a"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* Prepare to restart init when a HUP is received */</span><span class="token function">new_init_action</span><span class="token punctuation">(</span>RESTART<span class="token punctuation">,</span> <span class="token string">"init"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* Askfirst shell on tty1-4 */</span><span class="token function">new_init_action</span><span class="token punctuation">(</span>ASKFIRST<span class="token punctuation">,</span> bb_default_login_shell<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">new_init_action</span><span class="token punctuation">(</span>ASKFIRST<span class="token punctuation">,</span> bb_default_login_shell<span class="token punctuation">,</span> VC_2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">new_init_action</span><span class="token punctuation">(</span>ASKFIRST<span class="token punctuation">,</span> bb_default_login_shell<span class="token punctuation">,</span> VC_3<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">new_init_action</span><span class="token punctuation">(</span>ASKFIRST<span class="token punctuation">,</span> bb_default_login_shell<span class="token punctuation">,</span> VC_4<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* sysinit */</span><span class="token function">new_init_action</span><span class="token punctuation">(</span>SYSINIT<span class="token punctuation">,</span> INIT_SCRIPT<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>inittab的格式：<br><code># Format for each entry: &lt;id&gt;:&lt;runlevels&gt;:&lt;action&gt;:&lt;process&gt;</code>，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">id： <span class="token operator">--</span><span class="token operator">></span> <span class="token operator">/</span>dev<span class="token operator">/</span>id，用作<span class="token constant">stdin</span>，<span class="token constant">stdout</span>，<span class="token constant">stderr</span>；printf，scanf，err等runlevels：可以忽略action：执行时机# <span class="token operator">&lt;</span>action<span class="token operator">></span><span class="token operator">:</span> Valid actions include<span class="token operator">:</span> sysinit<span class="token punctuation">,</span> respawn<span class="token punctuation">,</span> askfirst<span class="token punctuation">,</span> wait<span class="token punctuation">,</span> once<span class="token punctuation">,</span><span class="token macro property"><span class="token directive-hash">#</span>                                  <span class="token directive keyword">restart</span><span class="token expression"><span class="token punctuation">,</span> ctrlaltdel<span class="token punctuation">,</span> and shutdown<span class="token punctuation">.</span></span></span>process：应用程序或脚本默认配置等价于配置文件中<span class="token punctuation">(</span>id<span class="token operator">:</span>runlevels<span class="token operator">:</span>action<span class="token operator">:</span>process<span class="token punctuation">)</span>：<span class="token comment">/*::ctrlaltdel:reboot::shutdown:umount -a -r::restart:init::askfirst:-/bin/shtty2::askfirst:-/bin/shtty3::askfirst:-/bin/shtty4::askfirst:-/bin/sh::sysinit:/etc/init.d/rcS*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>解析parse_inittab之后得到init_action_list，init_action_list存放<code>id:runlevels:action:process</code>，run_actions(init/init.c)这个函数就是去使用init_action_list的，run_actions就是执行时机，一共有<code>sysinit, respawn, askfirst, wait, once, restart, ctrlaltdel, and shutdown</code>类时机，init_main中run_actions简化如下，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">run_actions</span><span class="token punctuation">(</span>SYSINIT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">run_actions</span><span class="token punctuation">(</span>WAIT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">run_actions</span><span class="token punctuation">(</span>ONCE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">run_actions</span><span class="token punctuation">(</span>RESPAWN<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">run_actions</span><span class="token punctuation">(</span>ASKFIRST<span class="token punctuation">)</span><span class="token punctuation">;</span>wpid <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>wpid <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>a<span class="token operator">-></span>pid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行实际究竟是什么，需要去看run_actions，init/init.c，简化后如下，for (a = init_action_list; a; a = tmp) 依次遍历init_action_list取出<code>id:runlevels:action:process</code>；waitfor(a, 0)执行一个程序并等待执行完毕；delete_init_action(a);执行完依次程序后删除；</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">run_actions</span><span class="token punctuation">(</span><span class="token keyword">int</span> action<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">init_action</span> <span class="token operator">*</span>a<span class="token punctuation">,</span> <span class="token operator">*</span>tmp<span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span>a <span class="token operator">=</span> init_action_list<span class="token punctuation">;</span> a<span class="token punctuation">;</span> a <span class="token operator">=</span> tmp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>tmp <span class="token operator">=</span> a<span class="token operator">-></span>next<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token operator">-></span>action <span class="token operator">==</span> action<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">/* a->terminal of "" means "init's console" */</span><span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token operator">-></span>terminal<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token function">access</span><span class="token punctuation">(</span>a<span class="token operator">-></span>terminal<span class="token punctuation">,</span> R_OK <span class="token operator">|</span> W_OK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">delete_init_action</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token operator">-></span>action <span class="token operator">&amp;</span> <span class="token punctuation">(</span>SYSINIT <span class="token operator">|</span> WAIT <span class="token operator">|</span> CTRLALTDEL <span class="token operator">|</span> SHUTDOWN <span class="token operator">|</span> RESTART<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">waitfor</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">delete_init_action</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token operator">-></span>action <span class="token operator">&amp;</span> ONCE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">run</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">delete_init_action</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token operator">-></span>action <span class="token operator">&amp;</span> <span class="token punctuation">(</span>RESPAWN <span class="token operator">|</span> ASKFIRST<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">/* Only run stuff with pid==0.  If they have * a pid, that means it is still running */</span><span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token operator">-></span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>a<span class="token operator">-></span>pid <span class="token operator">=</span> <span class="token function">run</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查看waitfor，也在init/init.c中，run(a);创建process子进程；waitpid(runpid, &amp;status, 0);等待结束。run函数中BB_EXECVP(cmdpath, cmd);是系统调用</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">waitfor</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">init_action</span> <span class="token operator">*</span>a<span class="token punctuation">,</span> <span class="token class-name">pid_t</span> pid<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">int</span> runpid<span class="token punctuation">;</span><span class="token keyword">int</span> status<span class="token punctuation">,</span> wpid<span class="token punctuation">;</span>runpid <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> a<span class="token punctuation">)</span><span class="token operator">?</span> pid <span class="token operator">:</span> <span class="token function">run</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>wpid <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span>runpid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>wpid <span class="token operator">==</span> runpid<span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>wpid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">==</span> ECHILD<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">/* we missed its termination */</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/* FIXME other errors should maybe trigger an error, but allow * the program to continue */</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> wpid<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>SYSINIT | WAIT | CTRLALTDEL | SHUTDOWN | RESTART执行的流程一样的，只是先后顺序不同；ONCE这类程序不用等待执行完毕；RESPAWN | ASKFIRST只在a-&gt;pid == 0时才run(a)，并且RESPAWN | ASKFIRST在while(1)里的，简化那个while(1)，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">run</span><span class="token expression"><span class="token function">_actions</span><span class="token punctuation">(</span>RESPAWN <span class="token operator">|</span> ASKFIRST<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token operator">-></span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// =0才会run，pid开始等于0</span>a<span class="token operator">-></span>pid <span class="token operator">=</span> <span class="token function">run</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// run了之后不等于0</span><span class="token punctuation">&#125;</span>wpid <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待子进程退出，</span><span class="token keyword">while</span> <span class="token punctuation">(</span>wpid <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 返回之后又赋值为0</span>a<span class="token operator">-></span>pid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span><span class="token comment">// 重新运行退出的子进程</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>RESPAWN和ASKFIRST还有小区别，ASKFIRST会打印<code>Please press Enter to activate this console. </code><br>然后等待回车，在run中，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token operator">-></span>action <span class="token operator">&amp;</span> ASKFIRST<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> press_enter<span class="token punctuation">[</span><span class="token punctuation">]</span> ALIGN1 <span class="token operator">=</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CUSTOMIZED_BANNER</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token expression">CUSTOMIZED_BANNER</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token string">"\nPlease press Enter to activate this console. "</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">full_write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> press_enter<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>press_enter<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 第一个1表示标准输出</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> c <span class="token operator">!=</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>             <span class="token comment">// 等待回车，</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">BB_EXECVP</span><span class="token punctuation">(</span>cmdpath<span class="token punctuation">,</span> cmd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建进程</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>一共有<code>sysinit, respawn, askfirst, wait, once, restart, ctrlaltdel, and shutdown</code>类时机，还有<code> restart, ctrlaltdel, and shutdown</code>没有出现，这些东西在init/init.c的init_main中，在一开始就设置了相应的信号量，当触发信号量时内核会发给init进程，init进程就去执行对应函数，如ctrlaltdel和shutdown_system时就会去执行该类的程序，shutdown_system先运行配置文件指定的SHUTDOWN，然后才运行系统的关闭，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Set up sig handlers  -- be sure to * clear all of these in run() */</span><span class="token function">signal</span><span class="token punctuation">(</span>SIGHUP<span class="token punctuation">,</span> exec_signal<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">signal</span><span class="token punctuation">(</span>SIGQUIT<span class="token punctuation">,</span> exec_signal<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">signal</span><span class="token punctuation">(</span>SIGUSR1<span class="token punctuation">,</span> shutdown_signal<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">signal</span><span class="token punctuation">(</span>SIGUSR2<span class="token punctuation">,</span> shutdown_signal<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span> ctrlaltdel_signal<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">signal</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span> shutdown_signal<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">signal</span><span class="token punctuation">(</span>SIGCONT<span class="token punctuation">,</span> cont_handler<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">signal</span><span class="token punctuation">(</span>SIGSTOP<span class="token punctuation">,</span> stop_handler<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">signal</span><span class="token punctuation">(</span>SIGTSTP<span class="token punctuation">,</span> stop_handler<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ctrlaltdel_signal</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig ATTRIBUTE_UNUSED<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">run_actions</span><span class="token punctuation">(</span>CTRLALTDEL<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">shutdown_system</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token class-name">sigset_t</span> block_signals<span class="token punctuation">;</span><span class="token comment">/* run everything to be run at "shutdown".  This is done _prior_ * to killing everything, in case people wish to use scripts to * shut things down gracefully... */</span><span class="token function">run_actions</span><span class="token punctuation">(</span>SHUTDOWN<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* first disable all our signals */</span><span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>block_signals<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>block_signals<span class="token punctuation">,</span> SIGHUP<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>block_signals<span class="token punctuation">,</span> SIGQUIT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>block_signals<span class="token punctuation">,</span> SIGCHLD<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>block_signals<span class="token punctuation">,</span> SIGUSR1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>block_signals<span class="token punctuation">,</span> SIGUSR2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>block_signals<span class="token punctuation">,</span> SIGINT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>block_signals<span class="token punctuation">,</span> SIGTERM<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>block_signals<span class="token punctuation">,</span> SIGCONT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>block_signals<span class="token punctuation">,</span> SIGSTOP<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>block_signals<span class="token punctuation">,</span> SIGTSTP<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">sigprocmask</span><span class="token punctuation">(</span>SIG_BLOCK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>block_signals<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>/dev/console  // 打开终端<br>/dev/null  // 如果设置id，stdin,stderr等被定位到null中<br>/etc/inittab  // 配置文件<br>配置文件里指定的应用程序或脚本也一定要存在<br>库<br>init本身，就是busybox</p><p><strong>最小根文件系统的项：</strong></p><ol><li>/dev/console </li><li>/dev/null </li><li>init (busybox)</li><li>/etc/inittab</li><li>配置文件里指定的应用程序或脚本</li><li>C库</li></ol>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS1期第10课 内核 4 内核启动 分区</title>
      <link href="2021/05/14/wds1-qi-di-10-ke-nei-he-4-nei-he-qi-dong-fen-qu-local/"/>
      <url>2021/05/14/wds1-qi-di-10-ke-nei-he-4-nei-he-qi-dong-fen-qu-local/</url>
      
        <content type="html"><![CDATA[<p>内核，处理uboot传入的参数，启动内核，挂接根文件系统，启动应用程序。<br>最终目的是启动应用程序。</p><p>在arch/arm中，head.S有两个，<code>arch/arm/kernel/head.S</code>和<code>arch/arm/boot/compressed/head.S</code>，内核可能编译后很大，所以也可以压缩内核成 <code>自解压代码+压缩的内核</code>，程序运行时从自解压代码开始然后解压后面的内核。</p><p><a href="https://blog.csdn.net/hpu11/article/details/53326609">https://blog.csdn.net/hpu11/article/details/53326609</a></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">插播C语言的__artribute__<span class="token operator">:</span>告诉编译器取消结构在编译过程中的优化对齐<span class="token punctuation">,</span>按照实际占用字节数进行对齐，是GCC特有的语法。这个功能是跟操作系统没关系，跟编译器有关。GNU C的一大特色就是<span class="token keyword">__attribute__</span>机制。<span class="token keyword">__attribute__</span>可以设置函数属性（Function Attribute）、变量属性（Variable Attribute）和类型属性（Type Attribute）。<span class="token keyword">__attribute__</span>语法格式为：<span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>attribute<span class="token operator">-</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span>其位置约束为：声明的尾部，“；”之前。<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">double</span> x<span class="token punctuation">;</span>    <span class="token keyword">double</span> y<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token class-name">position_t</span><span class="token punctuation">;</span><span class="token number">1.</span> 编译器不优化对齐<span class="token number">2.</span> 使编译器错误检查更强大packed是类型属性（Type Attribute）的一个参数，使用packed可以减小对象占用的空间。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="head-S的第一阶段工作"><a href="#head-S的第一阶段工作" class="headerlink" title="head.S的第一阶段工作"></a>head.S的第一阶段工作</h3><p><img src="/images/20191206221009728.png"><br>读head.S, __lookup_processor_type查看此内核支持哪些cpu，支持哪些单板__lookup_machine_type，如果不支持将跳到死循环。__lookup_machine_type</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">.</span>section <span class="token string">".text.head"</span><span class="token punctuation">,</span> <span class="token string">"ax"</span><span class="token punctuation">.</span>typestext<span class="token punctuation">,</span> <span class="token operator">%</span>function<span class="token function">ENTRY</span><span class="token punctuation">(</span>stext<span class="token punctuation">)</span>msrcpsr_c<span class="token punctuation">,</span> #PSR_F_BIT <span class="token operator">|</span> PSR_I_BIT <span class="token operator">|</span> SVC_MODE @ ensure svc mode@ and irqs disabledmrcp15<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> r9<span class="token punctuation">,</span> c0<span class="token punctuation">,</span> c0@ get processor idbl__lookup_processor_type@ r5<span class="token operator">=</span>procinfo r9<span class="token operator">=</span>cpuidmovsr10<span class="token punctuation">,</span> r5@ invalid <span class="token function">processor</span> <span class="token punctuation">(</span>r5<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">?</span>beq__error_p@ yes<span class="token punctuation">,</span> error <span class="token string">'p'</span>bl__lookup_machine_type@ r5<span class="token operator">=</span>machinfomovsr8<span class="token punctuation">,</span> r5@ invalid <span class="token function">machine</span> <span class="token punctuation">(</span>r5<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">?</span>beq__error_a@ yes<span class="token punctuation">,</span> error <span class="token string">'a'</span>bl__create_page_tables<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在include/asm-arm/mach-types.h中定义机器id，在uboot中启动内核的函数的参数包括id <code>theKernel (0, bd-&gt;bi_arch_number, bd-&gt;bi_boot_params);</code>。根据交互规则bi_arch_number存放在<code>r1</code>寄存器里的，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MACH_TYPE_TOTO</span>                 <span class="token expression"><span class="token number">361</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MACH_TYPE_S3C2440</span>              <span class="token expression"><span class="token number">362</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MACH_TYPE_KS8695P</span>              <span class="token expression"><span class="token number">363</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>__lookup_machine_type在arch/arm/kernel/head-common.S中，r3=3b的地址，3b指<code>3:    .long    .</code>这段代码，<code>r4=&quot;.&quot;</code>,”.”是虚拟地址， <code>r5=__arch_info_begin</code>，<code>r6=__arch_info_end</code>。<br><code>sub    r3, r3, r4</code>虚拟地址-物理地址=offset，MMU还没有启动，所以前面的3对应标号是实际物理地址，r5r6对应加上r3(offset)变成__arch_info_begin __arch_info_end的真正物理地址。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token number">3</span><span class="token operator">:</span><span class="token punctuation">.</span><span class="token keyword">long</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">long</span>__arch_info_begin<span class="token punctuation">.</span><span class="token keyword">long</span>__arch_info_end<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>type__lookup_machine_type<span class="token punctuation">,</span> <span class="token operator">%</span>function__lookup_machine_type<span class="token operator">:</span>adrr3<span class="token punctuation">,</span> <span class="token number">3</span>bldmiar3<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>r4<span class="token punctuation">,</span> r5<span class="token punctuation">,</span> r6<span class="token punctuation">&#125;</span>subr3<span class="token punctuation">,</span> r3<span class="token punctuation">,</span> r4@ get offset between virt<span class="token operator">&amp;</span>physaddr5<span class="token punctuation">,</span> r5<span class="token punctuation">,</span> r3@ convert virt addresses toaddr6<span class="token punctuation">,</span> r6<span class="token punctuation">,</span> r3@ physical address space<span class="token number">1</span><span class="token operator">:</span>ldrr3<span class="token punctuation">,</span> <span class="token punctuation">[</span>r5<span class="token punctuation">,</span> #MACHINFO_TYPE<span class="token punctuation">]</span>@ get machine typeteqr3<span class="token punctuation">,</span> r1@ matches loader number<span class="token operator">?</span>beq<span class="token number">2f</span>@ foundaddr5<span class="token punctuation">,</span> r5<span class="token punctuation">,</span> #SIZEOF_MACHINE_DESC@ next machine_desccmpr5<span class="token punctuation">,</span> r6blo<span class="token number">1</span>bmovr5<span class="token punctuation">,</span> #<span class="token number">0</span>@ unknown machine<span class="token number">2</span><span class="token operator">:</span>movpc<span class="token punctuation">,</span> lr<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>__arch_info_begin __arch_info_end这俩东西不在内核定义，在链接脚本里面arch/arm/kernel/vmlinux.lds，架构相关的初始化信息，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">__arch_info_begin <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">.</span>arch<span class="token punctuation">.</span>info<span class="token punctuation">.</span>init<span class="token punctuation">)</span>__arch_info_end <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>.arch.info.init在include/asm-arm/mach/arch.h中涉及到，其中定义了个宏MACHINE_START，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* * Set of macros to define architecture features.  This is built into * a table by the linker. */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">MACHINE_START</span><span class="token expression"><span class="token punctuation">(</span>_type<span class="token punctuation">,</span>_name<span class="token punctuation">)</span></span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">machine_desc</span> __mach_desc_</span><span class="token punctuation">##</span><span class="token expression">_type</span><span class="token punctuation">\</span> <span class="token expression">__used</span><span class="token punctuation">\</span> <span class="token expression"><span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">__section__</span><span class="token punctuation">(</span></span><span class="token string">".arch.info.init"</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></span><span class="token punctuation">\</span><span class="token expression"><span class="token punctuation">.</span>nr<span class="token operator">=</span> MACH_TYPE_</span><span class="token punctuation">##</span><span class="token expression">_type<span class="token punctuation">,</span></span><span class="token punctuation">\</span><span class="token expression"><span class="token punctuation">.</span>name<span class="token operator">=</span> _name<span class="token punctuation">,</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MACHINE_END</span><span class="token punctuation">\</span><span class="token expression"><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>MACHINE_START这个宏在arch/arm/mach-s3c2440/mach-smdk2440.c中使用。按之前分析uboot的思路，这个应该会定义一个结构体，这个结构体会被强制设置属性，段被设置为”.arch.info.init”，每个这样的结构体会被链接脚本组合成一块，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">MACHINE_START</span><span class="token punctuation">(</span>S3C2440<span class="token punctuation">,</span> <span class="token string">"SMDK2440"</span><span class="token punctuation">)</span><span class="token comment">/* Maintainer: Ben Dooks &lt;ben@fluff.org> */</span><span class="token punctuation">.</span>phys_io<span class="token operator">=</span> S3C2410_PA_UART<span class="token punctuation">,</span><span class="token punctuation">.</span>io_pg_offst<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>S3C24XX_VA_UART<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">18</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xfffc</span><span class="token punctuation">,</span><span class="token punctuation">.</span>boot_params<span class="token operator">=</span> S3C2410_SDRAM_PA <span class="token operator">+</span> <span class="token number">0x100</span><span class="token punctuation">,</span><span class="token punctuation">.</span>init_irq<span class="token operator">=</span> s3c24xx_init_irq<span class="token punctuation">,</span><span class="token punctuation">.</span>map_io<span class="token operator">=</span> smdk2440_map_io<span class="token punctuation">,</span><span class="token punctuation">.</span>init_machine<span class="token operator">=</span> smdk2440_machine_init<span class="token punctuation">,</span><span class="token punctuation">.</span>timer<span class="token operator">=</span> <span class="token operator">&amp;</span>s3c24xx_timer<span class="token punctuation">,</span>MACHINE_END<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>将上面展开来看，定义一个静态的机器描述的结构体对象，名字为__mach_desc_S3C2440，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">machine_desc</span> __mach_desc_S3C2440 __used <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">__section__</span><span class="token punctuation">(</span><span class="token string">".arch.info.init"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>nr<span class="token operator">=</span> MACH_TYPE_S3C2440<span class="token punctuation">,</span><span class="token punctuation">.</span>name<span class="token operator">=</span> <span class="token string">"SMDK2440"</span><span class="token punctuation">,</span> <span class="token comment">// 后面的跟着写进来 </span><span class="token comment">/* Maintainer: Ben Dooks &lt;ben@fluff.org> */</span> <span class="token punctuation">.</span>phys_io<span class="token operator">=</span> S3C2410_PA_UART<span class="token punctuation">,</span><span class="token punctuation">.</span>io_pg_offst<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>S3C24XX_VA_UART<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">18</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xfffc</span><span class="token punctuation">,</span><span class="token punctuation">.</span>boot_params<span class="token operator">=</span> S3C2410_SDRAM_PA <span class="token operator">+</span> <span class="token number">0x100</span><span class="token punctuation">,</span><span class="token punctuation">.</span>init_irq<span class="token operator">=</span> s3c24xx_init_irq<span class="token punctuation">,</span><span class="token punctuation">.</span>map_io<span class="token operator">=</span> smdk2440_map_io<span class="token punctuation">,</span><span class="token punctuation">.</span>init_machine<span class="token operator">=</span> smdk2440_machine_init<span class="token punctuation">,</span><span class="token punctuation">.</span>timer<span class="token operator">=</span> <span class="token operator">&amp;</span>s3c24xx_timer<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>自然会查看这个结构体究竟是什么组合，于是去找machine_desc的定义，在include/asm-arm/mach/arch.h下，nr机器id，物理io，uboot传入的参数boot_params等等。所以内核支持多少单板就会有多少由宏定义生成这样的struct，这个结构体被定义了一个属性就是段被强制设置为”.arch.info.init”，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">machine_desc</span> <span class="token punctuation">&#123;</span><span class="token comment">/* * Note! The first four elements are used * by assembler code in head-armv.S */</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span>nr<span class="token punctuation">;</span><span class="token comment">/* architecture number*/</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span>phys_io<span class="token punctuation">;</span><span class="token comment">/* start of physical io*/</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span>io_pg_offst<span class="token punctuation">;</span><span class="token comment">/* byte offset for io  * page tabe entry*/</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>name<span class="token punctuation">;</span><span class="token comment">/* architecture name*/</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span>boot_params<span class="token punctuation">;</span><span class="token comment">/* tagged list*/</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span>video_start<span class="token punctuation">;</span><span class="token comment">/* start of video RAM*/</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span>video_end<span class="token punctuation">;</span><span class="token comment">/* end of video RAM*/</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span>reserve_lp0 <span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">/* never has lp0*/</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span>reserve_lp1 <span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">/* never has lp1*/</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span>reserve_lp2 <span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">/* never has lp2*/</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span>soft_reboot <span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">/* soft reboot*/</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span>fixup<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">machine_desc</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">tag</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">meminfo</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span>map_io<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* IO mapping function*/</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span>init_irq<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">sys_timer</span><span class="token operator">*</span>timer<span class="token punctuation">;</span><span class="token comment">/* system tick timer*/</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span>init_machine<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>  这些结构体被放在这里，然后内核启动从begin读到end，然后把这个读到的id和uboot传入的参数比较，相等则支持该单板，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">__arch_info_begin <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">;</span>   <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">.</span>arch<span class="token punctuation">.</span>info<span class="token punctuation">.</span>init<span class="token punctuation">)</span>  __arch_info_end <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>比较在这里进行，r5是begin，r1为传入的参数，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">.</span>type__lookup_machine_type<span class="token punctuation">,</span> <span class="token operator">%</span>function__lookup_machine_type<span class="token operator">:</span>adrr3<span class="token punctuation">,</span> <span class="token number">3</span>bldmiar3<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>r4<span class="token punctuation">,</span> r5<span class="token punctuation">,</span> r6<span class="token punctuation">&#125;</span>subr3<span class="token punctuation">,</span> r3<span class="token punctuation">,</span> r4@ get offset between virt<span class="token operator">&amp;</span>physaddr5<span class="token punctuation">,</span> r5<span class="token punctuation">,</span> r3@ convert virt addresses toaddr6<span class="token punctuation">,</span> r6<span class="token punctuation">,</span> r3@ physical address space<span class="token number">1</span><span class="token operator">:</span>ldrr3<span class="token punctuation">,</span> <span class="token punctuation">[</span>r5<span class="token punctuation">,</span> #MACHINFO_TYPE<span class="token punctuation">]</span>@ get machine typeteqr3<span class="token punctuation">,</span> r1@ matches loader number<span class="token operator">?</span>beq<span class="token number">2f</span>@ foundaddr5<span class="token punctuation">,</span> r5<span class="token punctuation">,</span> #SIZEOF_MACHINE_DESC@ next machine_desccmpr5<span class="token punctuation">,</span> r6blo<span class="token number">1</span>bmovr5<span class="token punctuation">,</span> #<span class="token number">0</span>@ unknown machine<span class="token number">2</span><span class="token operator">:</span>movpc<span class="token punctuation">,</span> lr<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>比较完相等之后回到head.S，继续往下执行，创建页表，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">ENTRY</span><span class="token punctuation">(</span>stext<span class="token punctuation">)</span>msrcpsr_c<span class="token punctuation">,</span> #PSR_F_BIT <span class="token operator">|</span> PSR_I_BIT <span class="token operator">|</span> SVC_MODE @ ensure svc mode@ and irqs disabledmrcp15<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> r9<span class="token punctuation">,</span> c0<span class="token punctuation">,</span> c0@ get processor idbl__lookup_processor_type@ r5<span class="token operator">=</span>procinfo r9<span class="token operator">=</span>cpuidmovsr10<span class="token punctuation">,</span> r5@ invalid <span class="token function">processor</span> <span class="token punctuation">(</span>r5<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">?</span>beq__error_p@ yes<span class="token punctuation">,</span> error <span class="token string">'p'</span>bl__lookup_machine_type@ r5<span class="token operator">=</span>machinfomovsr8<span class="token punctuation">,</span> r5@ invalid <span class="token function">machine</span> <span class="token punctuation">(</span>r5<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">?</span>beq__error_a@ yes<span class="token punctuation">,</span> error <span class="token string">'a'</span>bl__create_page_tables<span class="token comment">/* * The following calls CPU specific code in a position independent * manner.  See arch/arm/mm/proc-*.S for details.  r10 = base of * xxx_proc_info structure selected by __lookup_machine_type * above.  On return, the CPU will be ready for the MMU to be * turned on, and r0 will hold the CPU control register value. */</span>ldrr13<span class="token punctuation">,</span> __switch_data@ address to jump to after@ mmu has been enabledadrlr<span class="token punctuation">,</span> __enable_mmu@ <span class="token keyword">return</span> <span class="token punctuation">(</span>PIC<span class="token punctuation">)</span> addressaddpc<span class="token punctuation">,</span> r10<span class="token punctuation">,</span> #PROCINFO_INITFUNC<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>为什么创建页表，内核的链接地址是<code> . = (0xc0000000) + 0x00008000;</code>，但这个地址并不对应于真实存在的内存，真实的内存是从0x30000000开始，所以这里需要建立页表去启动MMU。<br>start_kernel是内核的第一个c函数。<br>在head.S中第一部分完成了，</p><ol><li>判断是否支持该cpu (__lookup_processor_type)</li><li>判断是否支持该单板 (__lookup_machine_type)</li><li>创建页表 (__create_page_tables)</li><li>使能mmu (__switch_data)</li><li>跳转到    start_kernel (b    start_kernel)<h3 id="head-S-跳转到-start-kernel"><a href="#head-S-跳转到-start-kernel" class="headerlink" title="head.S 跳转到 start_kernel"></a>head.S 跳转到 start_kernel</h3><img src="/images/2019120622103536.png"><br><code>theKernel (0, bd-&gt;bi_arch_number, bd-&gt;bi_boot_params);</code><br>之前机器id参数已经在head.S的第一部分处理完成，接下来是第二个参数是uboot传过来的参数bd-&gt;bi_boot_params要在start_kernel中处理，在init/main.c中，首先各种初始化，打印内核版本信息，    printk(linux_banner);<br>其中    setup_arch(&amp;command_line);    setup_command_line(command_line);两个就是用来处理uboot传入的参数的，内存多大，内存起始地址，命令行参数(bootargs传入)。<br>那两个函数在arch/arm/kernel/setup.c和init/main.c中定义。<pre class="line-numbers language-c" data-language="c"><code class="language-c">asmlinkage <span class="token keyword">void</span> __init <span class="token function">start_kernel</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">char</span> <span class="token operator">*</span> command_line<span class="token punctuation">;</span><span class="token keyword">extern</span> <span class="token keyword">struct</span> <span class="token class-name">kernel_param</span> __start___param<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> __stop___param<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token function">smp_setup_processor_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* * Need to run as early as possible, to initialize the * lockdep hash: */</span><span class="token function">unwind_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">lockdep_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">local_irq_disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">early_boot_irqs_off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">early_init_irq_lock_class</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* * Interrupts are still disabled. Do necessary setups, then * enable them */</span><span class="token function">lock_kernel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">tick_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">boot_cpu_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">page_address_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printk</span><span class="token punctuation">(</span>KERN_NOTICE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printk</span><span class="token punctuation">(</span>linux_banner<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">setup_arch</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>command_line<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">setup_command_line</span><span class="token punctuation">(</span>command_line<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">unwind_setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">setup_per_cpu_areas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">smp_prepare_boot_cpu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* arch-specific boot-cpu hooks */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>setup_arch里，machine_desc跟前面分析的自定义结构是一样的，<br>boot_params和前面的<code>.boot_params    = S3C2410_SDRAM_PA + 0x100,</code> == 0x30000100，与uboot的board/100ask24x0/100ask24x0.c文件中的，<code>gd-&gt;bd-&gt;bi_boot_params = 0x30000100;</code>对应。接着tag，取出tag，解析tag。<br>命令行参数(bootargs)，如果没有uboot没有传入命令行，那么使用默认的命令行default_command_line,<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> __init <span class="token function">setup_arch</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>cmdline_p<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">tag</span> <span class="token operator">*</span>tags <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tag</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>init_tags<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">machine_desc</span> <span class="token operator">*</span>mdesc<span class="token punctuation">;</span><span class="token keyword">char</span> <span class="token operator">*</span>from <span class="token operator">=</span> default_command_line<span class="token punctuation">;</span><span class="token function">setup_processor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>mdesc <span class="token operator">=</span> <span class="token function">setup_machine</span><span class="token punctuation">(</span>machine_arch_type<span class="token punctuation">)</span><span class="token punctuation">;</span>machine_name <span class="token operator">=</span> mdesc<span class="token operator">-></span>name<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>mdesc<span class="token operator">-></span>soft_reboot<span class="token punctuation">)</span><span class="token function">reboot_setup</span><span class="token punctuation">(</span><span class="token string">"s"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>mdesc<span class="token operator">-></span>boot_params<span class="token punctuation">)</span>tags <span class="token operator">=</span> <span class="token function">phys_to_virt</span><span class="token punctuation">(</span>mdesc<span class="token operator">-></span>boot_params<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* * If we have the old style parameters, convert them to * a tag list. */</span><span class="token keyword">if</span> <span class="token punctuation">(</span>tags<span class="token operator">-></span>hdr<span class="token punctuation">.</span>tag <span class="token operator">!=</span> ATAG_CORE<span class="token punctuation">)</span><span class="token function">convert_to_tag_list</span><span class="token punctuation">(</span>tags<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>tags<span class="token operator">-></span>hdr<span class="token punctuation">.</span>tag <span class="token operator">!=</span> ATAG_CORE<span class="token punctuation">)</span>tags <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tag</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>init_tags<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>mdesc<span class="token operator">-></span>fixup<span class="token punctuation">)</span>mdesc<span class="token operator">-></span><span class="token function">fixup</span><span class="token punctuation">(</span>mdesc<span class="token punctuation">,</span> tags<span class="token punctuation">,</span> <span class="token operator">&amp;</span>from<span class="token punctuation">,</span> <span class="token operator">&amp;</span>meminfo<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>tags<span class="token operator">-></span>hdr<span class="token punctuation">.</span>tag <span class="token operator">==</span> ATAG_CORE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>meminfo<span class="token punctuation">.</span>nr_banks <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token function">squash_mem_tags</span><span class="token punctuation">(</span>tags<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">parse_tags</span><span class="token punctuation">(</span>tags<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>init_mm<span class="token punctuation">.</span>start_code <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>_text<span class="token punctuation">;</span>init_mm<span class="token punctuation">.</span>end_code   <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>_etext<span class="token punctuation">;</span>init_mm<span class="token punctuation">.</span>end_data   <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>_edata<span class="token punctuation">;</span>init_mm<span class="token punctuation">.</span>brk   <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>_end<span class="token punctuation">;</span><span class="token function">memcpy</span><span class="token punctuation">(</span>boot_command_line<span class="token punctuation">,</span> from<span class="token punctuation">,</span> COMMAND_LINE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>boot_command_line<span class="token punctuation">[</span>COMMAND_LINE_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span><span class="token function">parse_cmdline</span><span class="token punctuation">(</span>cmdline_p<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">paging_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>meminfo<span class="token punctuation">,</span> mdesc<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">request_standard_resources</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>meminfo<span class="token punctuation">,</span> mdesc<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_SMP</span></span><span class="token function">smp_init_cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token function">cpu_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/* * Set up various architecture-specific pointers */</span>init_arch_irq <span class="token operator">=</span> mdesc<span class="token operator">-></span>init_irq<span class="token punctuation">;</span>system_timer <span class="token operator">=</span> mdesc<span class="token operator">-></span>timer<span class="token punctuation">;</span>init_machine <span class="token operator">=</span> mdesc<span class="token operator">-></span>init_machine<span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_VT</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_VGA_CONSOLE<span class="token punctuation">)</span></span></span>conswitchp <span class="token operator">=</span> <span class="token operator">&amp;</span>vga_con<span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_DUMMY_CONSOLE<span class="token punctuation">)</span></span></span>conswitchp <span class="token operator">=</span> <span class="token operator">&amp;</span>dummy_con<span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_KGDB<span class="token punctuation">)</span></span></span><span class="token keyword">extern</span> <span class="token keyword">void</span> __init <span class="token function">early_trap_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">early_trap_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>内核启动流程，缩进调用关系，<pre class="line-numbers language-c" data-language="c"><code class="language-c">start_kernelsetup_arch<span class="token comment">//解析uboot传入的启动参数</span>setup_command_line  <span class="token comment">//解析uboot传入的启动参数</span>rest_init <span class="token comment">// 内核</span>kernel_initprepare_namespacemount_root <span class="token comment">// 挂接根文件系统（识别）</span><span class="token function">init_post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行应用程序 </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>以prepare_namespace分析参数如何处理，根文件系统放在第三分区，<br><code>bootargs=noinitrd root=/dev/mtdblock3 init=/linuxrc console=ttySAC0,115200</code>。<br>在init/do_mounts.c中，<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">root_dev_setup</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>line<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">strlcpy</span><span class="token punctuation">(</span>saved_root_name<span class="token punctuation">,</span> line<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>saved_root_name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">__setup</span><span class="token punctuation">(</span><span class="token string">"root="</span><span class="token punctuation">,</span> root_dev_setup<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token operator">*</span> __initdata root_mount_data<span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">root_data_setup</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>root_mount_data <span class="token operator">=</span> str<span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>在include/linux/init.h中，又是宏定义完成定义结构体，<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">__setup_param</span><span class="token expression"><span class="token punctuation">(</span>str<span class="token punctuation">,</span> unique_id<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> early<span class="token punctuation">)</span></span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">static</span> <span class="token keyword">char</span> __setup_str_</span><span class="token punctuation">##</span><span class="token expression">unique_id<span class="token punctuation">[</span><span class="token punctuation">]</span> __initdata <span class="token operator">=</span> str<span class="token punctuation">;</span></span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">obs_kernel_param</span> __setup_</span><span class="token punctuation">##</span><span class="token expression">unique_id</span><span class="token punctuation">\</span><span class="token expression">__attribute_used__</span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">__section__</span><span class="token punctuation">(</span></span><span class="token string">".init.setup"</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">aligned</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="token punctuation">\</span><span class="token expression"><span class="token operator">=</span> <span class="token punctuation">&#123;</span> __setup_str_</span><span class="token punctuation">##</span><span class="token expression">unique_id<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> early <span class="token punctuation">&#125;</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">__setup_null_param</span><span class="token expression"><span class="token punctuation">(</span>str<span class="token punctuation">,</span> unique_id<span class="token punctuation">)</span></span><span class="token punctuation">\</span><span class="token expression"><span class="token function">__setup_param</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> unique_id<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">__setup</span><span class="token expression"><span class="token punctuation">(</span>str<span class="token punctuation">,</span> fn<span class="token punctuation">)</span></span><span class="token punctuation">\</span><span class="token expression"><span class="token function">__setup_param</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>链接脚本中，<pre class="line-numbers language-c" data-language="c"><code class="language-c">__setup_start <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">.</span>init<span class="token punctuation">.</span>setup<span class="token punctuation">)</span>__setup_end <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>查看__setup_start在哪里被使用，在init/main.c中，obsolete_checksetup，do_early_param调用，parse_early_param调用do_early_param，<br>__setup_start被使用，然后从start到end调用函数（用early标志的函数）</li></ol><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Check for early params. */</span><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">do_early_param</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>param<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>val<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">obs_kernel_param</span> <span class="token operator">*</span>p<span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> __setup_start<span class="token punctuation">;</span> p <span class="token operator">&lt;</span> __setup_end<span class="token punctuation">;</span> p<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>early <span class="token operator">&amp;&amp;</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>param<span class="token punctuation">,</span> p<span class="token operator">-></span>str<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span><span class="token function">setup_func</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token function">printk</span><span class="token punctuation">(</span>KERN_WARNING       <span class="token string">"Malformed early option '%s'\n"</span><span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/* We accept everything at this stage. */</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>内核启动流程，缩进调用关系，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">start_kernelsetup_arch<span class="token comment">//解析uboot传入的启动参数</span>setup_command_line  <span class="token comment">//解析uboot传入的启动参数</span>parse_early_paramdo_early_param       <span class="token comment">// 从start到end调用early函数</span>unknown_bootoptionobsolete_checksetup  <span class="token comment">// 从start到end调用非early函数（__setup设置为）</span>rest_init <span class="token comment">// 内核</span>kernel_initprepare_namespacemount_root <span class="token comment">// 挂接根文件系统（识别）</span><span class="token function">init_post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行应用程序 </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>uboot传入的参数被内核保存到一个字符串里，最后调用函数一一分析，就用<code>__setup(&quot;root=&quot;, root_dev_setup);</code>定义在结构体里，结构体被加了段属性，很多结构体被链接脚本链接到一起。<br>flash没有分区表，boot-环境变量-kernel-sysfile，在代码里写死，代码在arch/arm/plat-s3c24xx/common-smdk.c中，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">mtd_partition</span> smdk_default_nand_part<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">.</span>name   <span class="token operator">=</span> <span class="token string">"bootloader"</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span>size   <span class="token operator">=</span> <span class="token number">0x00040000</span><span class="token punctuation">,</span><span class="token punctuation">.</span>offset<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">.</span>name   <span class="token operator">=</span> <span class="token string">"params"</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span>offset <span class="token operator">=</span> MTDPART_OFS_APPEND<span class="token punctuation">,</span>        <span class="token punctuation">.</span>size   <span class="token operator">=</span> <span class="token number">0x00020000</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">.</span>name   <span class="token operator">=</span> <span class="token string">"kernel"</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span>offset <span class="token operator">=</span> MTDPART_OFS_APPEND<span class="token punctuation">,</span>        <span class="token punctuation">.</span>size   <span class="token operator">=</span> <span class="token number">0x00200000</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">.</span>name   <span class="token operator">=</span> <span class="token string">"root"</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span>offset <span class="token operator">=</span> MTDPART_OFS_APPEND<span class="token punctuation">,</span>        <span class="token punctuation">.</span>size   <span class="token operator">=</span> MTDPART_SIZ_FULL<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="参考优秀总结："><a href="#参考优秀总结：" class="headerlink" title="参考优秀总结："></a>参考优秀总结：</h1><p><a href="https://www.cnblogs.com/lcw/p/3337937.html">https://www.cnblogs.com/lcw/p/3337937.html</a><br><img src="/images/20200726155209173.png"></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS1期第10课 内核 2 内核启动流程 配置</title>
      <link href="2021/05/14/wds1-qi-di-10-ke-nei-he-2-nei-he-qi-dong-liu-cheng-pei-zhi-local/"/>
      <url>2021/05/14/wds1-qi-di-10-ke-nei-he-2-nei-he-qi-dong-liu-cheng-pei-zhi-local/</url>
      
        <content type="html"><![CDATA[<p>以前面内核编译配置的某一个项为例，之前生成的那个.config配置文件。</p><p><code>CONFIG_DM9000=y</code><br>.config文件里的东西，在</p><ol><li>子目录Makefile，</li><li> linuc C源码，</li><li>include/config/auto.conf，</li><li>include/linux/autoconf.h等都有用到，</li></ol><p>在头文件include/linux/autoconf.h中无论之前的.config里CONFIG_DM9000是M/Y,这里都是1</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CONFIG_BINFMT_AOUT</span> <span class="token expression"><span class="token number">1</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CONFIG_DM9000</span> <span class="token expression"><span class="token number">1</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CONFIG_SOLARIS_X86_PARTITION</span> <span class="token expression"><span class="token number">1</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>而y和M的体现在子目录的Makefile中体现，<code>obj-y += xxx.o</code>将被编译到内核， <code>obj-m += yyy.o</code>编译成.ko可被加载的模块</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">obj<span class="token operator">-</span>$<span class="token punctuation">(</span>CONFIG_SMC911X<span class="token punctuation">)</span> <span class="token operator">+=</span> smc911x<span class="token punctuation">.</span>oobj<span class="token operator">-</span>$<span class="token punctuation">(</span>CONFIG_DM9000<span class="token punctuation">)</span> <span class="token operator">+=</span> dm9dev9000c<span class="token punctuation">.</span>o<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>include/config/auto.conf</code>和<code> include/linux/autoconf.h</code>都来自于<code>.config</code></p><p>配置内核时生成.config文件，make uImake时.config会自动创建auto.conf(被顶层Makefile包含，子目录下Makefile使用)和autoconf.h(被源代码使用)。<br>最后编译时会根据子目录的Makefile把对应的.c编译成.o或.ko<br><img src="/images/20191205201242593.png"></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WDS1期第10课 内核 1 编译</title>
      <link href="2021/05/14/wds1-qi-di-10-ke-nei-he-1-bian-yi-local/"/>
      <url>2021/05/14/wds1-qi-di-10-ke-nei-he-1-bian-yi-local/</url>
      
        <content type="html"><![CDATA[<p>重新编译内核</p><ol><li>解压</li><li>打补丁</li><li>配置<br>从头自己写<br>在默认配置的基础上修改<br>厂家提供的<pre class="line-numbers language-c" data-language="c"><code class="language-c">tar xjf linux<span class="token operator">-</span><span class="token number">2.6</span><span class="token number">.22</span><span class="token number">.6</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>bz2 cd linux<span class="token operator">-</span><span class="token number">2.6</span><span class="token number">.22</span><span class="token number">.6</span><span class="token operator">/</span>patch <span class="token operator">-</span>p1 <span class="token operator">&lt;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>linux<span class="token operator">-</span><span class="token number">2.6</span><span class="token number">.22</span><span class="token number">.6</span>_jz2440_v2v3<span class="token punctuation">.</span>patch <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li>1 使用默认配置<br>在<code>./arch/arm/configs/</code>下，找到与单板相似的配置文件s3c2410_defconfig，cd 到顶层目录，<pre class="line-numbers language-c" data-language="c"><code class="language-c">make s3c2410_defconfig make menuconfig<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>执行完<code>make s3c2410_defconfig </code>最后显示配置结果到# configuration written to .config，然后执行<code>make menuconfig</code>会读取.config文件对make配置，但是教程中的结果不能用。报错fatal error: curses.h: No such file or directory compilation terminated.<br><img src="/images/20191205093502245.png"><br>原因和解决办法：<br>没装ncurses，安装即可提供头文件curses.h <code>sudo apt-get install libncurses5-dev</code></li></ol><p>3.2 使用厂家的配置文件<br>就在根目录下，把厂家提供的config改成.config <code>cp config_ok .config</code>，然后<code>make menuconfig</code>,交互界面选择合适的参数，然后<code>make</code>，<code>make uImage</code>编译的内核给uboot用，有头部。</p><p>若报错，cc1: error: unrecognised debug output level “dwarf2”，在Makefile文件中查找该参数并注释。</p><p>若没有生成uImage，提示：”mkimage” command not found - U-Boot images will not be built<br>  Image arch/arm/boot/uImage is ready，则安装<code>sudo apt-get install u-boot-tools</code>，<br>  最终应该这样才表示内核编译成uImage成功：<br>  <img src="/images/20191205150413401.png"></p><p>如果安装上述方法还出现not found，则是因为未安装32位库，执行sudo apt-get install lib32ncurses5 lib32z1,安装完成再次输入命令arm-linux-gcc -v则会出现对应gcc版本信息 </p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>uCOS时钟 定时器分辨率 5个系统任务 任务延时 信号量 消息队列 时间标志组 同时等待多个内核对象</title>
      <link href="2021/05/14/ucos-shi-zhong-ding-shi-qi-fen-bian-lu-5-ge-xi-tong-ren-wu-ren-wu-yan-shi-xin-hao-liang-xiao-xi-dui-lie-shi-jian-biao-zhi-zu-tong-shi-deng-dai-duo-ge-nei-he-dui-xiang-local/"/>
      <url>2021/05/14/ucos-shi-zhong-ding-shi-qi-fen-bian-lu-5-ge-xi-tong-ren-wu-ren-wu-yan-shi-xin-hao-liang-xiao-xi-dui-lie-shi-jian-biao-zhi-zu-tong-shi-deng-dai-duo-ge-nei-he-dui-xiang-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]</p><h1 id="delay-c"><a href="#delay-c" class="headerlink" title="delay.c"></a>delay.c</h1><h2 id="OS-TICKS-PER-SEC"><a href="#OS-TICKS-PER-SEC" class="headerlink" title="OS_TICKS_PER_SEC"></a>OS_TICKS_PER_SEC</h2><p>表示CPU一秒钟进行多少次时钟中断，决定了最小的延时间隔，修改os时间节拍，5ms为周期：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// UCOSII\CONFIG\os_cfg.h</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_TICKS_PER_SEC</span><span class="token expression"><span class="token number">200u</span>   </span><span class="token comment">/* Set the number of ticks in one second 200u(5ms) 1000u(1ms)   */</span></span><span class="token comment">// UCOSIII中</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">OS_CFG_TICK_RATE_HZ</span><span class="token expression"><span class="token number">200u</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="void-delay-us-u32-nus"><a href="#void-delay-us-u32-nus" class="headerlink" title="void delay_us(u32 nus)"></a>void delay_us(u32 nus)</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//nus为要延时的us数. 不能发起任务调度       </span><span class="token keyword">void</span> <span class="token function">delay_us</span><span class="token punctuation">(</span>u32 nus<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>任务由三个部分组成：<strong>任务堆栈、任务控制块、任务函数</strong>。<br>任务控制块的初始化和任务堆栈的初始化一样，都是由<code>OSTaskCreate</code>自动完成的。</p><h2 id="优先级，小数优先级高："><a href="#优先级，小数优先级高：" class="headerlink" title="优先级，小数优先级高："></a>优先级，小数优先级高：</h2><p>优先级最大多少级，最低优先级<code>X -1</code>：<br>uCOSIII: <code>OS_CFG_PRIO_MAX</code><br>uCOSII: <code>OS_LOWEST_PRIO</code></p><h2 id="就绪表"><a href="#就绪表" class="headerlink" title="就绪表"></a>就绪表</h2><p>就绪表(先确定优先级[前导码归零&lt;硬件支持&gt;] — 再确定级下哪个任务)：<br>uCOSIII中包含两部分：<br>优先级位映射表 <code>OSPrioTbl[]</code>，记录哪个优先级下有任务就绪，<code>OSPrioTbl[OS_PRIO_TBL_SIZE]</code><br> 就绪任务列表<code>OSRdyList[]</code>，统计每个优先级下所有就绪的任务， <code>OSRdyList[OS_CFG_PRIO_MAX]</code>，数组成员为链表头（链表两个指针和统计数，时间片轮转，永远运行head所指的任务，时间片用完后插到尾部）。<br> <img src="/images/20201027142734139.png"></p><h2 id="任务调度"><a href="#任务调度" class="headerlink" title="任务调度"></a>任务调度</h2><p>高优先级任务准备就绪，并且发起调度，他就会获得cpu使用权。</p><p>uCOSIII任务调度器有两种：任务级调度器 和 中断级调度器。<br>任务级调度器接口：<code>OSSched();</code><br>中断级调度器接口：<code>OSIntCtxSw();</code></p><h3 id="任务调度的点："><a href="#任务调度的点：" class="headerlink" title="任务调度的点："></a>任务调度的点：</h3><p><img src="/images/20201027151257784.png"></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">延时函数会发生任务调度，任务切换delay_ms <span class="token operator">/</span> delay_usOSTimeDly<span class="token function">OSSched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="调度器的上锁和解锁"><a href="#调度器的上锁和解锁" class="headerlink" title="调度器的上锁和解锁"></a>调度器的上锁和解锁</h3><p>代码的执行过程不希望（不能）被打断，需要禁止调度，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">OSSchedLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">OSSchedUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="时间片轮转调度器"><a href="#时间片轮转调度器" class="headerlink" title="时间片轮转调度器"></a>时间片轮转调度器</h3><p>同优先级下的多个任务可以指定执行的时间，可以提前调度，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">OS_SchedRoundRobin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="任务切换"><a href="#任务切换" class="headerlink" title="任务切换"></a>任务切换</h2><p>任务调度包含任务切换。根据不同芯片修改汇编代码，切换很快。<br>任务级切换：<code>OSCtxSw()</code><br>中断级切换：<code>OSIntCtxSw()</code></p><pre class="line-numbers language-none"><code class="language-none">OSCtxSw    LDR     R0, &#x3D;NVIC_INT_CTRL   ; Trigger the PendSV exception (causes context switch)    LDR     R1, &#x3D;NVIC_PENDSVSET    STR     R1, [R0]    BX      LROSIntCtxSw    LDR     R0, &#x3D;NVIC_INT_CTRL    ; Trigger the PendSV exception (causes context switch)    LDR     R1, &#x3D;NVIC_PENDSVSET    STR     R1, [R0]    BX      LR<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="系统初始化-和-启动（必须）"><a href="#系统初始化-和-启动（必须）" class="headerlink" title="系统初始化 和 启动（必须）"></a>系统初始化 和 启动（必须）</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">OSInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化，必须调用</span><span class="token function">OSStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 启动，必须调用</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>空闲任务 和 时钟节拍任务 是系统自动创建的。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//UCOSIII中以下优先级用户程序不能使用:</span><span class="token comment">//将这些优先级分配给了UCOSIII的5个系统内部任务</span><span class="token comment">//优先级0：中断服务服务管理任务 OS_IntQTask()</span><span class="token comment">//优先级1：时钟节拍任务 OS_TickTask()</span><span class="token comment">//优先级2：定时任务 OS_TmrTask()</span><span class="token comment">//优先级OS_CFG_PRIO_MAX-2：统计任务 OS_StatTask()</span><span class="token comment">//优先级OS_CFG_PRIO_MAX-1：空闲任务 OS_IdleTask()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="任务挂起-与-恢复"><a href="#任务挂起-与-恢复" class="headerlink" title="任务挂起 与 恢复"></a>任务挂起 与 恢复</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 挂起哪个任务，把它的控制块指针放入第一个参数</span><span class="token comment">// 第二个参数为错误码</span><span class="token keyword">void</span>   <span class="token function">OSTaskSuspend</span> <span class="token punctuation">(</span>OS_TCB  <span class="token operator">*</span>p_tcb<span class="token punctuation">,</span> OS_ERR  <span class="token operator">*</span>p_err<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// </span><span class="token keyword">void</span>  <span class="token function">OSTaskResume</span> <span class="token punctuation">(</span>OS_TCB  <span class="token operator">*</span>p_tcb<span class="token punctuation">,</span> OS_ERR  <span class="token operator">*</span>p_err<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="时间片轮转调度"><a href="#时间片轮转调度" class="headerlink" title="时间片轮转调度"></a>时间片轮转调度</h2><p>ucosiii才有，只针对相同优先级的任务才有时间片轮转调度。</p><ol><li>首先必须宏置一，<code>OS_CFG_SCHED_ROUND_ROBIN_EN</code>，在UCOSIII\uCOS_CONFIG\os_cfg.h。</li><li>然后调用这个函数配置系统时间片刻度，<br><code>void OSSchedRoundRobinCfg(CPU_BOOLEAN en, OS_TICK dflt_time_quanta, OS_ERR *p_err);</code> <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 设置时间片大小</span><span class="token comment">// 任务的时间片 =  n x 系统时间片刻度// 系统时间片刻度 = 系统时钟节拍间隔 x OSSchedRoundRobinCfg的第二个参数</span><span class="token comment">// 任务的时间片 =  n x 5ms// 5ms = 5ms x 1</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span><span class="token expression">OS_CFG_SCHED_ROUND_ROBIN_EN  </span><span class="token comment">//当使用时间片轮转的时候</span></span> <span class="token comment">//使能时间片轮转调度功能, 时间片长度为1个系统时钟节拍，既1*5=5ms</span> <span class="token comment">// 0 means assumes OSCfg_TickRate_Hz / 10. == 系统时钟节拍 x 10</span><span class="token function">OSSchedRoundRobinCfg</span><span class="token punctuation">(</span>DEF_ENABLED<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 设置系统时间片刻度</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>最后在<code>OSTaskCreate()</code>时参数<code>(OS_TICK     )2</code>，设置该task的时间片长度为n个系统时间片刻度。<h3 id="提前放弃时间片"><a href="#提前放弃时间片" class="headerlink" title="提前放弃时间片"></a>提前放弃时间片</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span>  <span class="token function">OSSchedRoundRobinYield</span> <span class="token punctuation">(</span>OS_ERR  <span class="token operator">*</span>p_err<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="ucos的5个系统任务"><a href="#ucos的5个系统任务" class="headerlink" title="ucos的5个系统任务"></a>ucos的5个系统任务</h1><h2 id="1-空闲任务"><a href="#1-空闲任务" class="headerlink" title="1. 空闲任务"></a>1. 空闲任务</h2></li><li>空闲任务是ucosiii创建的第一个任务</li><li>必须创建</li><li>优先级总是最低的</li><li>空闲任务中不能调用任何 能使其进入等待态的函数<br><img src="/images/20201028221010809.png"></li></ol><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// OSInit(&amp;err);创建了第一个任务，空闲任务，里面</span><span class="token function">OSInit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">OS_IdleTaskInit</span><span class="token punctuation">(</span>p_err<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">OSTaskCreate</span><span class="token punctuation">(</span><span class="token punctuation">(</span>OS_TASK_PTR<span class="token punctuation">)</span>OS_IdleTask    OS_IdleTask    OSIdleTaskCtr<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// 变化越快表示执行空闲任务越频繁，应用层的执行较少</span><span class="token function">OSIdleTaskHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 钩子函数</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-时钟节拍任务"><a href="#2-时钟节拍任务" class="headerlink" title="2. 时钟节拍任务"></a>2. 时钟节拍任务</h2><p>用来跟踪任务延时和任务等待超时， <strong>等待内核对象超时</strong>。<br>如OS自带的延时函数，请求信号量消息队列时等内核对象。<br>任务函数为<code>OS_TickTask()</code> 是UCOSIII必须创建的一个任务,任务优先级用宏<code>OS_CFG_TICK_TASK_PRIO</code>来定义,一般时钟节拍任务的任务应该设置一个相对较高的优先级。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Priority 时钟节拍任务，一般设置一个相对较高的优先级      */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">OS_CFG_TICK_TASK_PRIO</span>    <span class="token expression"><span class="token number">1u</span>               </span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="3-统计任务"><a href="#3-统计任务" class="headerlink" title="3. 统计任务"></a>3. 统计任务</h2><p><strong>统计CPU的使用率</strong>、<strong>各个任务的CPU使用率和各任务的堆栈使用情况。</strong></p><p>默认情况下统计任务是不会创建的。</p><p>需要使用则以下步骤：</p><ol><li>将宏<code>OS_CFG_STAT_TASK_EN</code>置1</li><li>必须在main函数创建的一个任务也是唯一的一个应用任务里面调用函数<code>void  OSStatTaskCPUUsageInit (OS_ERR  *p_err)</code>。</li><li>优先级通常设置为倒数第2个，通过宏<code>OS_CFG_STAT_TASK_PRIO</code>来设置,一般设置0 S CFG PRIO_MX-2,也就是倒数第二个优先级 <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">OS_CFG_STAT_TASK_PRIO</span>  <span class="token expression"><span class="token punctuation">(</span>OS_CFG_PRIO_MAX<span class="token operator">-</span><span class="token number">2u</span><span class="token punctuation">)</span>   </span><span class="token comment">/* Priority 统计任务优先级                                 */</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol><h2 id="4-定时任务"><a href="#4-定时任务" class="headerlink" title="4. 定时任务"></a>4. 定时任务</h2><p>UCOSIII提供软件定时器功能，定时任务是可选的。<br>将宏<code>OS_CFG_TMR_EN</code>设置为1就会使能定时任务。</p><p>在·<code>OSInit()</code>将会调用函数<code>OS_TmrInit(p_err)</code>来创建定时任务。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_TMR_EN <span class="token operator">></span> <span class="token number">0u</span>     </span><span class="token comment">/* Initialize the Timer Manager module                    */</span></span>    <span class="token function">OS_TmrInit</span><span class="token punctuation">(</span>p_err<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>p_err <span class="token operator">!=</span> OS_ERR_NONE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>定时任务的优先级通过宏<code>OS_CFG_TMR_TASK_PRIO</code>定义, ALIENTEK默认将定时器任务优先级设置为2。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">OS_CFG_TMR_TASK_PRIO</span>   <span class="token expression"><span class="token number">2u</span>   </span><span class="token comment">/* Priority of 'Timer Task' 定时任务优先级  */</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="5-中断服务管理任务"><a href="#5-中断服务管理任务" class="headerlink" title="5. 中断服务管理任务"></a>5. 中断服务管理任务</h2><p>为了减少中断关闭的时间。<br>当把 os_cfg.h文件中的宏<code>OS_CFG_ISR_POST_DEFERRED_EN</code>置1使能。</p><p>当ISR(中断服务函数)调用UCOSIII提供的“post”函数时，要发送的数据和发送的目的地都会存入一个特别的缓冲队列中，<br>当所有嵌套的ISR都执行完成以后 UCOSIII会做任务切换，运行中断服务管理任务，该任务会把缓存队列中存放的信息重发给相应的任务。</p><p>这样做的好处就是可以减少中断关闭的时间，否则，在ISR中还需要把任务从等待列表中删除，并把任务放入就绪表，以及做一些其他的耗时操作。中断服务管理任务的优先级永远为0，不可更改。</p><p>UCOSIII关中断几乎全部关闭，除了halt_fault和AIM中断。</p><h2 id="钩子函数"><a href="#钩子函数" class="headerlink" title="钩子函数"></a>钩子函数</h2><p><strong>UCOS里的hook函数用于当发生指定事件时（ucos内部的事件），调用的函数，类似回调。<font color=red>帮助用户扩展ucos的功能。</font></strong></p><p>主要用于扩展其他函数（任务）的功能。<br>最终调用到函数在UCOSIII\uCOS_CONFIG\os_app_hooks.c中填充即可。<br><img src="/images/20201028225830392.png"></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">OSInit</span> <span class="token punctuation">(</span>OS_ERR  <span class="token operator">*</span>p_err<span class="token punctuation">)</span><span class="token function">OS_IdleTaskInit</span><span class="token punctuation">(</span>p_err<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">OSTaskCreate</span><span class="token punctuation">(</span><span class="token punctuation">(</span>OS_TCB     <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>OSIdleTaskTCB<span class="token punctuation">,</span>                 <span class="token punctuation">(</span>CPU_CHAR   <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"uC/OS-III Idle Task"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                 <span class="token punctuation">(</span>OS_TASK_PTR<span class="token punctuation">)</span>OS_IdleTask<span class="token punctuation">,</span> <span class="token function">OSIdleTaskHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 钩子函数</span> <span class="token punctuation">(</span><span class="token operator">*</span>OS_AppIdleTaskHookPtr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 调用了app函数</span> <span class="token comment">// OS_AppIdleTaskHookPtr = App_OS_IdleTaskHook;</span> <span class="token comment">// 用App_OS_IdleTaskHook赋值</span>     <span class="token comment">// UCOSIII\uCOS-III\Ports\ARM-Cortex-M3\Generic\RealView\os_cpu_c.c </span> <span class="token comment">// 空闲函数的钩子函数 OSIdleTaskHook</span><span class="token keyword">void</span>  <span class="token function">OSIdleTaskHook</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_APP_HOOKS_EN <span class="token operator">></span> <span class="token number">0u</span></span></span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>OS_AppIdleTaskHookPtr <span class="token operator">!=</span> <span class="token punctuation">(</span>OS_APP_HOOK_VOID<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token punctuation">(</span><span class="token operator">*</span>OS_AppIdleTaskHookPtr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token punctuation">&#125;</span> <span class="token comment">// UCOSIII\uCOS_CONFIG\os_app_hooks.c</span><span class="token keyword">void</span>  <span class="token function">App_OS_SetAllHooks</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_APP_HOOKS_EN <span class="token operator">></span> <span class="token number">0u</span></span></span>    <span class="token function">CPU_SR_ALLOC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">CPU_CRITICAL_ENTER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    OS_AppTaskCreateHookPtr <span class="token operator">=</span> App_OS_TaskCreateHook<span class="token punctuation">;</span>    OS_AppTaskDelHookPtr    <span class="token operator">=</span> App_OS_TaskDelHook<span class="token punctuation">;</span>    OS_AppTaskReturnHookPtr <span class="token operator">=</span> App_OS_TaskReturnHook<span class="token punctuation">;</span>    OS_AppIdleTaskHookPtr   <span class="token operator">=</span> App_OS_IdleTaskHook<span class="token punctuation">;</span><span class="token comment">// 用App_OS_IdleTaskHook赋值</span>    OS_AppStatTaskHookPtr   <span class="token operator">=</span> App_OS_StatTaskHook<span class="token punctuation">;</span>    OS_AppTaskSwHookPtr     <span class="token operator">=</span> App_OS_TaskSwHook<span class="token punctuation">;</span>    OS_AppTimeTickHookPtr   <span class="token operator">=</span> App_OS_TimeTickHook<span class="token punctuation">;</span>    <span class="token function">CPU_CRITICAL_EXIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token punctuation">&#125;</span><span class="token comment">// UCOSIII\uCOS_CONFIG\os_app_hooks.c</span><span class="token comment">// 自定义，最终调用的就是App_OS_IdleTaskHook</span><span class="token keyword">void</span>  <span class="token function">App_OS_IdleTaskHook</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="中断服务函数"><a href="#中断服务函数" class="headerlink" title="中断服务函数"></a>中断服务函数</h1><p>中断服务函数内部的写法结构：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">xxx_Handler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">OSIntEnter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//进入中断   </span>。。。        <span class="token function">OSIntExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//触发任务切换软中断</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>中断嵌套的全局变量：<code>OSIntNestingCtr </code>, ucos最大支持250级嵌套，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span>  <span class="token function">OSIntEnter</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>OSRunning <span class="token operator">!=</span> OS_STATE_OS_RUNNING<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                 <span class="token comment">/* Is OS running?                                         */</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>                                             <span class="token comment">/* No                                                     */</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>OSIntNestingCtr <span class="token operator">>=</span> <span class="token punctuation">(</span>OS_NESTING_CTR<span class="token punctuation">)</span><span class="token number">250u</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token comment">/* Have we nested past 250 levels?                        */</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>                                             <span class="token comment">/* Yes                                                    */</span>    <span class="token punctuation">&#125;</span>    OSIntNestingCtr<span class="token operator">++</span><span class="token punctuation">;</span>                                      <span class="token comment">/* Increment ISR nesting level                            */</span><span class="token punctuation">&#125;</span><span class="token comment">// </span><span class="token keyword">void</span>  <span class="token function">OSIntExit</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">CPU_SR_ALLOC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">CPU_INT_DIS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭全局中断，保存现场</span>    。。。    <span class="token function">OSIntCtxSw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* 中断级任务调度器 Perform interrupt level ctx switch */</span>    <span class="token function">CPU_INT_EN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 恢复现场</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="临界区保护"><a href="#临界区保护" class="headerlink" title="临界区保护"></a>临界区保护</h1><p>保护临界区代码ucos有两种方式：<br>关闭全局中断，<br>上锁调度器 ，<br>当<code>OS_CFG_ISR_POST_DEFERRED_EN</code>为<strong>0</strong>时 使用关中断的方式保护临界区，<br>当<code>OS_CFG_ISR_POST_DEFERRED_EN</code>为<strong>1</strong>时 使用上锁调度器保护临界区。</p><p>进入临界区只有一种方式，<code>OS_CRITICAL_ENTER();</code><br>退出临界区有两种，<code>OS_CRITICAL_EXIT();</code> 和 <code>OS_CRITICAL_EXIT_NO_SCHED(); </code></p><p><strong>要使用临界区保护的接口 必须与<code>CPU_SR_ALLOC();</code>配合使用，因为此宏函数定义了全局变量<code>cpu_sr </code></strong></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name function">CPU_SR_ALLOC</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>             CPU_SR  cpu_sr <span class="token operator">=</span> <span class="token punctuation">(</span>CPU_SR<span class="token punctuation">)</span><span class="token number">0</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="任务延时"><a href="#任务延时" class="headerlink" title="任务延时"></a>任务延时</h1><p>ucosiii任务是一个无限循环 抢占式的，防止高优先级任务独占cpu，除空闲任务以外的任务必须在合适的位置<strong>调用引起任务切换的接口（如：系统提供的延时函数）</strong>。</p><p>有两个系统的延时函数，<code>OSTimeDly()</code>和<code>OSTimeDlyHMSM()</code>。</p><p>  <code>OSTimeDly()</code>函数有三种工作模式：相对模式、周期模式和绝对模式。<br>  <code>OSTimeDlyHMSM()</code>函数仅在相对模式下工作。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">*</span> OS_OPT_TIME_HMSM_STRICT   strictly allow only  <span class="token function">hours</span>   <span class="token punctuation">(</span><span class="token number">0.</span><span class="token punctuation">.</span><span class="token number">.99</span><span class="token punctuation">)</span><span class="token operator">*</span>                                                <span class="token function">minutes</span>      <span class="token punctuation">(</span><span class="token number">0.</span><span class="token punctuation">.</span><span class="token number">.59</span><span class="token punctuation">)</span><span class="token operator">*</span>                                                <span class="token function">seconds</span>      <span class="token punctuation">(</span><span class="token number">0.</span><span class="token punctuation">.</span><span class="token number">.59</span><span class="token punctuation">)</span><span class="token operator">*</span>                                                <span class="token function">milliseconds</span> <span class="token punctuation">(</span><span class="token number">0.</span><span class="token punctuation">.</span><span class="token number">.999</span><span class="token punctuation">)</span><span class="token operator">*</span> OS_OPT_TIME_HMSM_NON_STRICT allow any value of <span class="token function">hours</span>        <span class="token punctuation">(</span><span class="token number">0.</span><span class="token punctuation">.</span><span class="token number">.999</span><span class="token punctuation">)</span><span class="token operator">*</span>                                                <span class="token function">minutes</span>      <span class="token punctuation">(</span><span class="token number">0.</span><span class="token punctuation">.</span><span class="token number">.9999</span><span class="token punctuation">)</span><span class="token operator">*</span>                                                <span class="token function">seconds</span>      <span class="token punctuation">(</span><span class="token number">0.</span><span class="token punctuation">.</span><span class="token number">.65535</span><span class="token punctuation">)</span><span class="token operator">*</span>                                                <span class="token function">milliseconds</span> <span class="token punctuation">(</span><span class="token number">0.</span><span class="token punctuation">.</span><span class="token number">.4294967295</span><span class="token punctuation">)</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">OS_CFG_TIME_DLY_HMSM_EN <span class="token operator">></span> <span class="token number">0u</span></span></span><span class="token keyword">void</span>  <span class="token function">OSTimeDlyHMSM</span> <span class="token punctuation">(</span>CPU_INT16U   hours<span class="token punctuation">,</span>                     CPU_INT16U   minutes<span class="token punctuation">,</span>                     CPU_INT16U   seconds<span class="token punctuation">,</span>                     CPU_INT32U   milli<span class="token punctuation">,</span>                     OS_OPT       opt<span class="token punctuation">,</span>                     OS_ERR      <span class="token operator">*</span>p_err<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>也可以在其他任务中取消任务的延时：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">OSTimeDlyResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 取消延时而进入就绪状态，此函数最后会引发一次任务调度。</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="获取和设置系统时间，节拍"><a href="#获取和设置系统时间，节拍" class="headerlink" title="获取和设置系统时间，节拍"></a>获取和设置系统时间，节拍</h1><p>CPU_INT32U类型的全局变量<code>OSTickCtr</code>来记录系统时钟节拍数，在调用<code>OSInit()</code>时被初始化为0，以后每发生1个时钟节拍，<code>OSTickCtr</code>加1。</p><p><code>OSTimeSet()</code>允许用户改变当前时钟节拍计数器的值。<br><code>OSTimeGet()</code>用来获取动迁时钟节拍计数器的值。</p><h1 id="软件定时器"><a href="#软件定时器" class="headerlink" title="软件定时器"></a>软件定时器</h1><p>UCOSIII中定时器的时间分辨率由一个宏<code>OS_CFG_TMR_TASK_RATE_HZ</code>，单位为<code>HZ</code>，默认为100Hz。</p><table><thead><tr><th>函数名</th><th>作用</th></tr></thead><tbody><tr><td>OSTmrCreate()</td><td>创建定时器并制定运行模式</td></tr><tr><td>OSTmrDel()</td><td>删除定时器</td></tr><tr><td>OSTmrRemainGet()</td><td>获取定时器的剩余时间</td></tr><tr><td>OSTmrStart()</td><td>启动定时器计数</td></tr><tr><td>OSTmrStateGet()</td><td>获取当前定时器状态</td></tr><tr><td>OSTmrStop()</td><td>停止计数器倒计时</td></tr></tbody></table><p>软件定时器的模式：单次定时、周期无初始延迟模式、周期有初始延迟。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/*optSpecifies either:OS_OPT_TMR_ONE_SHOT       The timer counts down only onceOS_OPT_TMR_PERIODIC       The timer counts down and then reloads itself*/</span><span class="token keyword">void</span>  <span class="token function">OSTmrCreate</span> <span class="token punctuation">(</span>OS_TMR               <span class="token operator">*</span>p_tmr<span class="token punctuation">,</span>                   CPU_CHAR             <span class="token operator">*</span>p_name<span class="token punctuation">,</span>                   OS_TICK               dly<span class="token punctuation">,</span>                   OS_TICK               period<span class="token punctuation">,</span>                   OS_OPT                opt<span class="token punctuation">,</span><span class="token comment">// 模式选择</span>                   OS_TMR_CALLBACK_PTR   p_callback<span class="token punctuation">,</span>                   <span class="token keyword">void</span>                 <span class="token operator">*</span>p_callback_arg<span class="token punctuation">,</span>                   OS_ERR               <span class="token operator">*</span>p_err<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>单次定时，手动<code>OSTmrStart()</code><br><img src="/images/20201029114043751.png"></li><li><ol start="3"><li>周期无初始延迟模式 和 周期有初始延迟模式<br><img src="/images/20201029140826323.png"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 步骤</span><span class="token number">0.</span> 定时器分辨率（<span class="token number">10</span>ms）  OS_CFG_TMR_TASK_RATE_HZ，默认<span class="token number">100</span>Hz <span class="token number">1.</span> 打开宏使能 #define OS_CFG_TMR_EN <span class="token number">1u</span>   <span class="token comment">/* Enable (1) or Disable (0) code generation for TIMERS */</span><span class="token number">2.</span> 定义定时器（全局）OS_TMR tmr1<span class="token punctuation">;</span><span class="token number">3.</span> 回调函数 <span class="token keyword">void</span> <span class="token function">tmr1_clbk</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> p_tmr<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> p_arg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">4.</span> 创建定时器（start_task中） <span class="token function">OSTmrCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token number">5.</span> 开启软件定时器 <span class="token function">OSTmrStart</span> <span class="token punctuation">(</span>OS_TMR  <span class="token operator">*</span>p_tmr<span class="token punctuation">,</span> OS_ERR  <span class="token operator">*</span>p_err<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol></li></ol><h1 id="信号量"><a href="#信号量" class="headerlink" title="信号量"></a>信号量</h1><p>信号量通常分为两种：<strong>二进制信号量</strong>和<strong>计数型信号量</strong>。<br>信号量默认为0，请求到信号量就-1，释放或发送就+1。</p><ol><li>二进制信号量：只能取0和1两个值，一次只能一个任务使用的资源，比如I/O设备，打印机。</li><li>计数型信号量：的信号量值大于1，范围由<code>OS_SEM_CTR</code>决定，可以为8位，16位和32位，取值范围分别为：0 ~ 255, 0 ~ 65535和 0 ~ 4294967295。可以同时被几个任务所使用，如一个缓存池有10个缓存块，那么同时最多支持10个任务使用内存池。</li></ol><p> <strong>使用：</strong><br> 资源与信号量绑定，<strong>等待</strong>获取资源，可设置超时可死等。<br>  要资源的任务必须执行“<strong>等待</strong>”操作，</p><ul><li> 如该资源对应的信号量有效值大于1，则任务可以获得该资源，任务继续运行</li><li>如该信号量的有效值为0，则任务加入等待信号量的任务表中</li><li>如等待时间超过某一个设定值，则等待信号量的任务就进入就绪态</li><li>如将等待时间设置为0则任务就将一直等待该信号量</li></ul><table><thead><tr><th>函数名</th><th>作用</th></tr></thead><tbody><tr><td>OSSemCreate()</td><td>建立一个信号量</td></tr><tr><td>OSSemDel()</td><td>删除一个信号量</td></tr><tr><td>OSSemPend()</td><td>等待一个信号量</td></tr><tr><td>OSSemPendAbrot()</td><td>取消等待</td></tr><tr><td>OSSemPost()</td><td>释放或者发出一个信号量</td></tr><tr><td>OSSemSet()</td><td>强制设置一个信号量的值</td></tr></tbody></table><h2 id="优先级翻转"><a href="#优先级翻转" class="headerlink" title="优先级翻转"></a>优先级翻转</h2><p>优先级反转在可剥夺内核中是非常常见的，在实时系统中不允许出现这种现象，这样会破坏任务的预期顺序，可能会导致严重的后果。</p><p><font color=red><strong>解决办法：将L级任务的优先级 提升到 与其竞争相同资源的高优先级任务 的相同水平，使用完资源释放之后再把优先级恢复成L级别。（加使用互斥信号量</strong>）。</font><br>这样 M等优先级任务 只能 在L级任务执行释放后由H级任务运行完成后 才能执行，因此低优先级任务占用信号量时间必须短。</p><p>优先级翻转现象：<br><img src="/images/20201029162857492.png"></p><p>用提升优先级  和 二值信号量（互斥量）方法解决：<br><img src="/images/20201029163400902.png"></p><h2 id="互斥信号量"><a href="#互斥信号量" class="headerlink" title="互斥信号量"></a>互斥信号量</h2><table><thead><tr><th>函数名</th><th>作用</th></tr></thead><tbody><tr><td>OSMutexCreate()</td><td>建立一个互斥信号量</td></tr><tr><td>OSMutexDel()</td><td>删除一个互斥信号量</td></tr><tr><td>OSMutexPend()</td><td>等待一个互斥信号量</td></tr><tr><td>OSMutexPendAbrot()</td><td>取消等待</td></tr><tr><td>OSMutexPost()</td><td>释放或者发布一个互斥信号量</td></tr></tbody></table><h2 id="任务内嵌信号量"><a href="#任务内嵌信号量" class="headerlink" title="任务内嵌信号量"></a>任务内嵌信号量</h2><p>任务创建时自动创建，因此没有提供创建函数，可以设置信号初始值，<br>只能请求自带的信号量，可以发送到别人信号量。<br>函数名      |    作用<br>——|——–<br>OSTaskSemPend()        |     等待一个任务信号量<br>OSTaskSemPendAbort()        |    取消等待任务信号量<br>OSTaskSemPost()    |    发布任务信号量<br>OSTaskSemSet()    |    强行设置任务信号量计数</p><h1 id="消息传递"><a href="#消息传递" class="headerlink" title="消息传递"></a>消息传递</h1><p>消息包含一下几个部分：指向数据的<strong>指针</strong>，数据的<strong>长度</strong>，记录消息发布时刻的<br><strong>时间戳</strong>。<br>消息以指针方式传递，因此消息内容可以是动态申请的<strong>内存块</strong>、<strong>全局变量</strong>、<strong>函数</strong>。<br>ucosiii没有消息邮箱只有消息队列，邮箱是长度为1的消息队列。</p><p><img src="/images/20201029172113328.png"><br>消息队列的API：<br>函数名 |    作用<br>———-| ——<br>OSQCreate()    |  创建一个消息 队列<br>OSQDel()    |   删除一个消息队列<br>OSQFlush()      |   清空消息队列<br>OSQPend()     |       等待消息<br>OSQPendAbort()  |        取消等待消息<br>OSQPost()      |     向消息队列发布一则消息</p><p> 任务或者中断服务程序都可以给消息队列发送消息，当发送消息时，如果队列未满，uCOS 会将从消息池中取出一个消息，将消息挂载到队列的尾部，消息中的成员变量MsgPtr 指向要发送的消息。如果队列已满， 则返回错误代码，入队失败。<br><img src="/images/20201107221032482.png"><br><img src="/images/20201107221528767.png"></p><h2 id="任务间通信"><a href="#任务间通信" class="headerlink" title="任务间通信"></a>任务间通信</h2><p>两种方式，消息队列 和 全局变量加独占访问（信号量）。</p><h2 id="任务内建消息队列"><a href="#任务内建消息队列" class="headerlink" title="任务内建消息队列"></a>任务内建消息队列</h2><p>需要Create去配置消息队列大小和处理函数，不需要定义消息队列。<br>多个任务等待同一个消息队列的应用很少见。<br> 如果需要使用任务内建消息队列功能的时候需要将宏<code>OS_CFG_TASK_Q_EN</code>置1。<br>函数名    |作用<br>—|—<br>OSTaskQPend()    |等待消息<br>OSTaskQPendAbort()    |取消等待消息<br>OSTaskQPost()    |向任务发布一则消息<br>OSTaskQFlush()    |清空任务的消息队列</p><h1 id="事件标志组（多个任务到达后-才触发事件）"><a href="#事件标志组（多个任务到达后-才触发事件）" class="headerlink" title="事件标志组（多个任务到达后 才触发事件）"></a>事件标志组（多个任务到达后 才触发事件）</h1><p>事件标志组用于 一个任务与多个任务同步。<br>事件标志组与任务之间有两种同步机制：<strong>“或”</strong> 和 <strong>“与”</strong>。</p><ul><li>“或”同步：等待多个事件时，任何一个事件发生 ，任务都被同步。</li><li>“与”同步：当所有的事件都发生时任务才被同步。</li></ul><p>在UCOSIII中事件标志组为<code>OS_FLAG_GRP</code>，将宏<code>OS_CFG_FLAG_EN</code>置1。</p><p>事件标志：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span>   CPU_INT32U  OS_FLAGS<span class="token punctuation">;</span>  <span class="token comment">/* Event flags,  8/16/&lt;32> */</span>OS_FLAGSflags<span class="token punctuation">;</span><span class="token comment">// 每bit表示一个事件</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>事件标志组API：<br>函数名    |        作用<br>——-|——–<br>OSFlagCreate()    |创建事件标志组<br>OSFlagDel()    |    删除事件标志组<br>OSFlagPend()        |    等待事件标志组<br>OSFlagPendAbort()    |    取消等待事件标志<br>OSFlagPendGetFlagsRdy()    |    获取使任务就绪的事件标志<br>OSFlagPost()    |    向事件标志组发布标志</p><h1 id="同时等待多个内核对象-（多个信号量、消息队列）"><a href="#同时等待多个内核对象-（多个信号量、消息队列）" class="headerlink" title="同时等待多个内核对象 （多个信号量、消息队列）"></a>同时等待多个内核对象 （多个信号量、消息队列）</h1><p>前面的都是等待单个内核对象。包括：信号量、互斥信号量、消息队列和事件标志组。</p><p>在UCOSIII中允许任务同时等待<strong>多个信号量和多个消息队列</strong>，<br>不支持同时等待多个事件标志组或互斥信号量。</p><p>一个任务可以等待任意数量的信号量和消息队列，第一个信号量或消息队列的发布会导致该任务进入就绪态。</p><p>一个任务可以调用函数<code>OSPendMulti()</code>函数来等待多个对象，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">OS_OBJ_QTY  <span class="token function">OSPendMulti</span> <span class="token punctuation">(</span>OS_PEND_DATA   <span class="token operator">*</span>p_pend_data_tbl<span class="token punctuation">,</span>                         OS_OBJ_QTY     tbl_size<span class="token punctuation">,</span>                         OS_TICK        timeout<span class="token punctuation">,</span>                         OS_OPT         opt<span class="token punctuation">,</span>                         OS_ERR         <span class="token operator">*</span>p_err<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在调用函数OSPendMulti()之前我们需要先初始化<code>OS_PEND_DATA</code>数组，数组的大小取决于任务同时等待的内核对象的总数量。</p><h1 id="存储管理"><a href="#存储管理" class="headerlink" title="存储管理"></a>存储管理</h1><p>UCOSIII中提供了一种替代<code>malloc()</code>和<code>free()</code>函数的方法，UCOSIII中将存储空间分成<strong>区和块</strong>，每个存储区有数量不等大小相同的存储块，在一个系统中可以有多个存储区。<br>UCOSIII使用区块组合内存很粗糙。</p><p>修改栈、堆空间大小：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// CORE\startup_stm32f10x_md.s</span>Stack_Size      EQU     <span class="token number">0x00000400</span>Heap_Size       EQU     <span class="token number">0x00000200</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h1 id="互斥量与二值信号量"><a href="#互斥量与二值信号量" class="headerlink" title="互斥量与二值信号量"></a>互斥量与二值信号量</h1><p>uCOS 中的信号量不具备传递数据的功能。</p><p>互斥量有优先级继承机制，二值信号量则没有这个机制。这使得二值信号量更偏向应用于同步功能（任务与任务间的同步或任务和中断间同步），而互斥量更偏向应用于临界资源的互斥访问。</p><p>在嵌入式操作系统中二值信号量是任务间、 任务与中断间同步的重要手段。</p><p>而 uCOS 提供的互斥量可以通过优先级继承算法，可以降低优先级翻转问题产生的影响，所以，用于临界资源的保护一般建议使用互斥量。</p><p>互斥量与二值信号量最大的不同是：互斥量具有优先级继承机制，而信号量没有。</p><p>优先级翻转：暂时提高某个占有某种资源的低优先级任务的优先级，使之与在所有等待该资源<br>的任务中优先级最高那个任务的优先级相等，而当这个低优先级任务执行完毕释放该资源时，优先级重新回到初始设定值。</p><h1 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h1><p>但是它与信号量不同的是，事件的发送操作是不可累计的，而信号量的释放动作是可累计的。</p><p>事件是一种实现任务间通信的机制，主要用于实现多任务间的同步，<strong>但事件通信只能是事件类型的通信，无数据传输。</strong> 与信号量不同的是，它可以实现一对多，多对多的同步。<br>即一个任务可以等待多个事件的发生：可以是任意一个事件发生时唤醒任务进行事件处理；也可以是几个事件都发生后才唤醒任务进行事件处理。同样，也可以是多个任务同步多个事件。</p><p>一般将其定义为 32 位的变量， 有 32 个位用来实现事件标志组。 每一位代表一个事件，任务通过“逻辑与”或“逻辑或”与一个或多个事件建立关联，形成一个事件组。事件的“逻辑或”也被称作是独立型同步，指的是任务感兴趣的所有事件任一件发生即可被唤醒；事件“逻辑与”则被称为是关联型同步，指的是任务感兴趣的若干事件都发生时才被唤醒，并且事件发生的时间可以不同步。</p><p><img src="/images/20201109214418711.png"></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ucosiii 系统时钟，时间戳 阻塞延时与空闲任务 临界段 就绪表（优先级位映射表和就绪任务列表）</title>
      <link href="2021/05/14/ucosiii-xi-tong-shi-zhong-shi-jian-chuo-zu-sai-yan-shi-yu-kong-xian-ren-wu-lin-jie-duan-jiu-xu-biao-you-xian-ji-wei-ying-she-biao-he-jiu-xu-ren-wu-lie-biao-local/"/>
      <url>2021/05/14/ucosiii-xi-tong-shi-zhong-shi-jian-chuo-zu-sai-yan-shi-yu-kong-xian-ren-wu-lin-jie-duan-jiu-xu-biao-you-xian-ji-wei-ying-she-biao-he-jiu-xu-ren-wu-lie-biao-local/</url>
      
        <content type="html"><![CDATA[<h1 id="系统时基"><a href="#系统时基" class="headerlink" title="系统时基"></a>系统时基</h1><p> Cortex-M 内核自带一个系统定时器，使得os移植变得很简单。</p><p>刚好 Cortex-M 内核中有一个系统定时器 SysTick， 它内嵌在 NVIC 中，是一个 24 位的递减的计数器，计数器每计数一次的时间为 1/SYSCLK。当重装载数值寄存器的值递减到 0 的时候，系统定时器就产生一次中断，以此循环往复。 因为 SysTick 是嵌套在内核中的，所以使得 OS 在 Cortex-M 器件中编写的定时器代码不必修改，使移植工作一下子变得简单很多。 </p><h1 id="时间戳"><a href="#时间戳" class="headerlink" title="时间戳"></a>时间戳</h1><p>uC/OS-III中用 ARM Cortex-M 系列内核的DWT外设 来 实现时间戳功能。</p><p>在 ARM Cortex-M 系列内核中，有一个 <strong>DWT 的外设</strong>， 它有一个 32 位的寄存器<code>CYCCNT</code>，它是一个向上的 计数器，<strong>记录的是内核时钟 HCLK 运行的个数</strong>，当 CYCCNT溢出之后，会清 0 重新开始向上计数。</p><p>在 STM32F103 系列的单片机中， HCLK 时钟最高为 72M，单个时钟的周期为 1/72 us = 0.0139us = 14ns， CYCCNT 总共能记录的时间为 2^32*14=60S。在 uC/OS-III 中，要测量的时间都是很短的，都是 ms 级别，根本不需要考虑计时器溢出的问题。</p><h1 id="阻塞延时-与-空闲任务"><a href="#阻塞延时-与-空闲任务" class="headerlink" title="阻塞延时 与 空闲任务"></a>阻塞延时 与 空闲任务</h1><p>阻塞延时<br>RTOS 中的延时叫阻塞延时，即任务需要延时的时候，任务会放弃 CPU 的使用权，当任务延时时间到，重新获取 CPU 使用权。</p><p>空闲任务<br>任务阻塞延时，cpu转去别的任务，没有别的任务就运行空闲任务， 在 uC/OSIII 中， 空闲任务是系统在初始化的时候创建的<strong>优先级最低的任务</strong>，空闲任务主体很简单，<strong>只是对一个全局变量进行计数</strong> <code>OSIdleTaskCtr </code>。<br>在实际应用中，当系统进入空闲任务的时候，可在空闲任务中让单片机进入休眠或者低功耗等操作。</p><h1 id="临界段"><a href="#临界段" class="headerlink" title="临界段"></a>临界段</h1><p>如果临界段可能被中断，那么就需要关中断以保护临界段。如果临界段可能被任务级代码打断，那么需要锁调度器保护临界段。</p><p>在 uCOS 里面，这个临界段最常出现的就是对全局变量的操作。</p><h2 id="那么什么情况下临界段会被打断？"><a href="#那么什么情况下临界段会被打断？" class="headerlink" title="那么什么情况下临界段会被打断？"></a>那么什么情况下临界段会被打断？</h2><p>一个是系统调度，还有一个就是外部中断。在uCOS 的系统调度，最终也是产生 PendSV 中断，在 PendSV Handler 里面实现任务的切换，所以还是可以归结为中断。既然这样， uCOS 对临界段的保护最终还是回到对中断的开和关的控制。</p><h2 id="Cortex-M-内核快速关中断指令"><a href="#Cortex-M-内核快速关中断指令" class="headerlink" title="Cortex-M 内核快速关中断指令"></a>Cortex-M 内核快速关中断指令</h2><p>Cortex-M 内核专门设置了一条 CPS 指令，4种用法：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token number">1</span> CPSID I <span class="token punctuation">;</span>PRIMASK<span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">;</span>关中断<span class="token number">2</span> CPSIE I <span class="token punctuation">;</span>PRIMASK<span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">;</span>开中断<span class="token number">3</span> CPSID F <span class="token punctuation">;</span>FAULTMASK<span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">;</span>关异常<span class="token number">4</span> CPSIE F <span class="token punctuation">;</span>FAULTMASK<span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">;</span>开异常<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>PRIMASK （剩下 NMI 和硬 FAULT 可以响应）和 FAULTMAST （只有NMI可以响应）是 Cortex-M 内核 里面三个中断屏蔽寄存器中的两个，还有一个是 BASEPRI。</p><p><strong>在 uCOS 中，对中断的开和关是通过操作 PRIMASK 寄存器来实现。（<code>CPSID I </code>、 <code>CPSIE I</code>）</strong>，<br>关中断汇编实现<code>CPU_SR_Save()</code>，<br>开中断汇编实现<code> CPU_SR_Restore()</code>，</p><h1 id="就绪表（双向链表，存放同优先级下的任务TCB）"><a href="#就绪表（双向链表，存放同优先级下的任务TCB）" class="headerlink" title="就绪表（双向链表，存放同优先级下的任务TCB）"></a>就绪表（双向链表，存放同优先级下的任务TCB）</h1><p>在 uC/OS-III 中，任务被创建后TCB 会被放入就绪列表中，随时可能被运行。<br>就绪列表 包含一个表示任务优先级的优先级表（存储任务 TCB 的TCB 双向链表）。</p><h2 id="优先级位映射表（数组，存放）"><a href="#优先级位映射表（数组，存放）" class="headerlink" title="优先级位映射表（数组，存放）"></a>优先级位映射表（数组，存放）</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// os.h </span>CPU_DATA OSPrioTbl<span class="token punctuation">[</span>OS_PRIO_TBL_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// OS_PRIO_TBL_SIZE为1，总大小1x32=32bit，32个优先级</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_PRIO_TBL_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>OS_CFG_PRIO_MAX <span class="token operator">-</span> <span class="token number">1u</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>DEF_INT_CPU_NBR_BITS<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1u</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><code>OS_CFG_PRIO_MAX </code> 定义os支持多少个优先级，32、64等<br><code>DEF_INT_CPU_NBR_BITS </code> 定义 CPU 整型数据有多少，int型，cpu字长，32</p><p>因此<code>OS_PRIO_TBL_SIZE</code>  的具体取值与 uC/OS-III 支持多少个优先级有关，支持的优先级越多，优先级表也就越大，ucosiii理论上无限。</p><p>优先级位映射表：<br><img src="/images/20201101144616454.png"></p><h2 id="就绪任务列表（数组，存放双向链表头）"><a href="#就绪任务列表（数组，存放双向链表头）" class="headerlink" title="就绪任务列表（数组，存放双向链表头）"></a>就绪任务列表（数组，存放双向链表头）</h2><p><code>OSRdyList[OS_CFG_PRIO_MAX]</code>，数组存放就绪任务链表的头指针，<br>就绪任务列表：<br><img src="/images/20201027142734139.png"></p><h1 id="抢占式调度"><a href="#抢占式调度" class="headerlink" title="抢占式调度"></a>抢占式调度</h1><p>uCOS 中提供的任务调度器是基于优先级的全抢占式调度：在系统中除了中断处理函数、调度器上锁部分的代码和禁止中断的代码是不可抢占的之外，系统的其他部分都是可以抢占的。</p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ucosiii 中断延迟发布关闭中断时间</title>
      <link href="2021/05/14/ucosiii-zhong-duan-yan-chi-fa-bu-guan-bi-zhong-duan-shi-jian-local/"/>
      <url>2021/05/14/ucosiii-zhong-duan-yan-chi-fa-bu-guan-bi-zhong-duan-shi-jian-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]</p><p>uCOS-III内核实现与应用开发实战指南—基于STM32.pdf</p><h1 id="中断相关通用基础"><a href="#中断相关通用基础" class="headerlink" title="中断相关通用基础"></a>中断相关通用基础</h1><h2 id="关闭中段时间"><a href="#关闭中段时间" class="headerlink" title="关闭中段时间"></a>关闭中段时间</h2><p>在操作系统中，很多时候我们会主动进入临界段，系统不允许当前状态被中断打断，故而在临界区发生的中断会被挂起，直到退出临界段时候打开中断。此部分时间，我称其为： 关闭中断时间。</p><h2 id="中断延迟"><a href="#中断延迟" class="headerlink" title="中断延迟"></a>中断延迟</h2><p>中断延迟可以定义为，从中断开始的时刻到中断服务例程开始执行的时刻之间的时间段。<br><strong><font color=red>中断延迟 = 识别中断时间 + [等待中断打开时间] + [关闭中断时间]。</font></strong><br>进入临界段的方式可以是关中断或者锁住调度器。<br>用锁住调度代替关中断，大大减少了关中断的时间， 也能达到进入临界段的目的。 中断延迟就是利用这种思想， 让本该在中断中完成的事情切换到任务中完成， 而且进入临界段的方式是锁定调度器， 这样子中断就不会被屏蔽， 系统能随时响应中断。</p><h1 id="UCOSIII"><a href="#UCOSIII" class="headerlink" title="UCOSIII"></a>UCOSIII</h1><h2 id="通过宏选择"><a href="#通过宏选择" class="headerlink" title="通过宏选择"></a>通过宏选择</h2><p>UCOSIII支持中断嵌套的，即高优先级的中断可以打断低优先级的中断，在UCOSIII中使用<code>OSIntNestingCtr</code>来记录中断嵌套次数，<strong>最大支持250级的中断嵌套</strong>，每进入一次中断服务函数<code>OSIntNestingCtr</code>就会加1，当退出中断服务函数的时候<code>OSIntNestingCtr</code>就会减1。</p><p>在编写UCOSIII的中断服务程序的时候需要使用到两个函数<code>OSIntEnter()</code>和<code>OSIntExit()</code>。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">任务级调度器为函数<span class="token function">OSSched</span><span class="token punctuation">(</span><span class="token punctuation">)</span>；中断级调度器为函数<span class="token function">OSIntExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>，当退出外部中断服务函数的时候使用中断级任务调度。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="中断直接发布-和-延迟发布"><a href="#中断直接发布-和-延迟发布" class="headerlink" title="中断直接发布 和 延迟发布"></a>中断直接发布 和 延迟发布</h2><h3 id="1-直接发布"><a href="#1-直接发布" class="headerlink" title="1 直接发布"></a>1 直接发布</h3><p><img src="/images/20210124130922745.png"></p><ul><li>（1）中断产生</li><li>（2）中断服务程序ISR开始执行。通常中断中包含着任务等待的事件</li><li>（3）若ISR 使能了低于或等于原任务优先级的任务，ISR结束时，uC/OS-III 返回原任务并从被中断处继续执行</li><li>（4）若ISR 使能了高于原任务优先级的任务，ISR 结束后，进入调度。uC/OS-III 切换到高优先级任务</li><li>（5）在直接提交方法中，uC/OS-III 必须保护好临界段（通过关中断方式）</li></ul><h3 id="2-延迟发布"><a href="#2-延迟发布" class="headerlink" title="2 延迟发布"></a>2 延迟发布</h3><p><img src="/images/20210124131020449.png"></p><ul><li>（1）中断产生</li><li>（2）ISR 被执行</li><li>（3）ISR 中调用”post”函数发送信号量或消息给任务。然而，它不是直接发送给任务，而是先发送到中断队列。然后中断处理函数被就绪。这是uC/OS-III 的内部任务且具有最高优先级(优先级为0)</li><li>（4）ISR 的最后，uC/OS-III 会切换到中断处理任务，它将中断队列中消息发送给任务。在此，我们关闭中断防止在处理中断队列时被另外的中断程序打断。最后，该任务使能中断，锁住调度器，提交信息。信息是在任务级被提交的。这样，就是在任务级完成临界段的处理了</li><li>（5）当中断处理任务清空中断队列时，它就会将自己停止，重新开启调度器，调用调度器选择下一个任务运行</li><li>（6）如果优先级更高的任务被使能，uC/OS-III 会马上换到该任务</li></ul><p>总结：<br>使用延迟发布关中断的时间会非常短（且相当固定），但是任务延迟会加长，因为UCOSIII会锁住调度器并访问临界段。</p><ul><li>uC/CPU 中提供了测量最大中断时间的功能</li><li>uC/OS-III 的ISR 前序，ISR 后序，OSIntExit()，OSIntCtxSw()操作的时间可以被测量。</li><li>调用OS_TS_GET()也可以测量“post”函数的处理时间。</li><li>只有在处理定时器任务时才会锁调度器。如果定时器任务中创建的定时器不多的话，任务延迟将会很短。uC/OS-III也可以测量锁调度器时间。<h2 id="UCOSIII中断延迟-ISR添加OSIntEnter-和OSIntExit"><a href="#UCOSIII中断延迟-ISR添加OSIntEnter-和OSIntExit" class="headerlink" title="UCOSIII中断延迟 ISR添加OSIntEnter()和OSIntExit()"></a>UCOSIII中断延迟 ISR添加<code>OSIntEnter()</code>和<code>OSIntExit()</code></h2>相比UCOSII，UCOSIII对从中断发布消息或者信号的处理有两种模式：直接发布和延迟发布两种方式。<br>通过宏<code>OS_CFG_ISR_POST_DEFERRED_EN</code>选择：</li><li>为0时使用直接发布模式，</li><li>为1的时候使用延迟发布模式。<br>对于开发人员来说，使用ucosiii中断延迟发布功能，只需要将宏<code>OS_CFG_ISR_POST_DEFERRED_EN</code>打开，在中断服务函数（ISR，通常是在中断向量表里边固定的函数名）中添加，<code>OSIntEnter();</code> 和 <code>OSIntExit();</code>,中间的代码跟task通信一样写，其他上面提到的中断队列等机制都是ucosiii自己完成。除了添加两行代码以外，跟普通裸机中断编写没什么差别。</li></ul><p>中断向量表：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">__Vectors       DCD     __initial_sp               <span class="token punctuation">;</span> Top of Stack                DCD     Reset_Handler              <span class="token punctuation">;</span> Reset Handler                DCD     NMI_Handler                <span class="token punctuation">;</span> NMI Handler                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>DCD     ETH_IRQHandler                    <span class="token punctuation">;</span> Ethernet                                        DCD     ETH_WKUP_IRQHandler               <span class="token punctuation">;</span> Ethernet Wakeup through EXTI line                      DCD     CAN2_TX_IRQHandler                <span class="token punctuation">;</span> CAN2 TX                                                DCD     CAN2_RX0_IRQHandler               <span class="token punctuation">;</span> CAN2 RX0                                               DCD     CAN2_RX1_IRQHandler               <span class="token punctuation">;</span> CAN2 RX1                                               DCD     CAN2_SCE_IRQHandler               <span class="token punctuation">;</span> CAN2 SCE     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>中断服务函数：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 1. --------------- 以CAN的接收中断为例 ---------------------</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">CAN2_RX0_INT_ENABLE</span><span class="token comment">//使能RX0中断</span></span><span class="token comment">//CAN2接收中断函数</span><span class="token keyword">void</span> <span class="token function">CAN2_RX0_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>OS_ERR err<span class="token punctuation">;</span>CanRxMsg RxMessage<span class="token punctuation">;</span>  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">SYSTEM_SUPPORT_OS </span></span><span class="token function">OSIntEnter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 添加之后ucosiii自动将xxx添加到中断队列，退出ISR后进入中断队列处理任务（优先级最高0）然后发布到指定task</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token function">CAN_Receive</span><span class="token punctuation">(</span>CAN2<span class="token punctuation">,</span> CAN_FIFO0<span class="token punctuation">,</span> <span class="token operator">&amp;</span>RxMessage<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 发布消息到消息队列 queue */</span><span class="token function">OSQPost</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>OS_Q <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>queue<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>CAN2_RECV_DATA<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>OS_MSG_SIZE <span class="token punctuation">)</span><span class="token keyword">sizeof</span> <span class="token punctuation">(</span>CAN2_RECV_DATA<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>OS_OPT <span class="token punctuation">)</span>OS_OPT_POST_FIFO <span class="token operator">|</span> OS_OPT_POST_ALL<span class="token punctuation">,</span><span class="token punctuation">(</span>OS_ERR <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 清除挂起中断</span><span class="token function">CAN_ClearITPendingBit</span><span class="token punctuation">(</span>CAN2<span class="token punctuation">,</span> CAN_IT_FMP0<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">SYSTEM_SUPPORT_OS </span></span><span class="token function">OSIntExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 添加之后ucosiii自动将xxx添加到中断队列，退出ISR后进入中断队列处理任务（优先级最高0）然后发布到指定task</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token punctuation">&#125;</span><span class="token comment">// 2. --------------- 以串口的接收中断为例 ---------------------</span><span class="token keyword">void</span> <span class="token function">USART1_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>                <span class="token comment">//串口1中断服务程序</span><span class="token punctuation">&#123;</span>u8 res<span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">SYSTEM_SUPPORT_OS </span></span><span class="token function">OSIntEnter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 添加之后ucosiii自动将xxx添加到中断队列，退出ISR后进入中断队列处理任务（优先级最高0）然后发布到指定task</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">USART_GetITStatus</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span> USART_IT_RXNE<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>res <span class="token operator">=</span> <span class="token function">USART_ReceiveData</span><span class="token punctuation">(</span>USART1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//(USART1->DR);//读取接收到的数据 </span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">&#125;</span> <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">SYSTEM_SUPPORT_OS </span></span><span class="token function">OSIntExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 添加之后ucosiii自动将xxx添加到中断队列，退出ISR后进入中断队列处理任务（优先级最高0）然后发布到指定task </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token punctuation">&#125;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JZ2440 v3.0 linux-3.4.2  busybox1.20.0内核 和 文件系统移植 修改分区大小 yaffs2文件系统补丁 开源资源查找</title>
      <link href="2021/05/14/jz2440-v3.0-linux-3.4.2-busybox1.20.0-nei-he-he-wen-jian-xi-tong-yi-zhi-xiu-gai-fen-qu-da-xiao-yaffs2-wen-jian-xi-tong-bu-ding-kai-yuan-zi-yuan-cha-zhao-local/"/>
      <url>2021/05/14/jz2440-v3.0-linux-3.4.2-busybox1.20.0-nei-he-he-wen-jian-xi-tong-yi-zhi-xiu-gai-fen-qu-da-xiao-yaffs2-wen-jian-xi-tong-bu-ding-kai-yuan-zi-yuan-cha-zhao-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]</p><h1 id="零、平台-软件版本-烧写"><a href="#零、平台-软件版本-烧写" class="headerlink" title="零、平台 + 软件版本 + 烧写"></a>零、平台 + 软件版本 + 烧写</h1><h2 id="平台-和-版本"><a href="#平台-和-版本" class="headerlink" title="平台 和 版本"></a>平台 和 版本</h2><ol><li>JZ2440v3.0</li><li>u-boot-1.1.6 + u-boot-1.1.6_jz2440.patch <a href="ftp://ftp.denx.de/pub/u-boot/">ftp://ftp.denx.de/pub/u-boot/</a></li><li>linux-3.4.2  <a href="https://mirrors.edge.kernel.org/pub/linux/kernel/v3.x/">https://mirrors.edge.kernel.org/pub/linux/kernel/v3.x/</a><br>内核编译选的mini2440 ，机器id设置 set machid （mini2440 7cf ； smdk2440 16a）</li><li>busybox1.20.0 <a href="https://busybox.net/downloads/">https://busybox.net/downloads/</a><br>内核yaffs2补丁 <a href="https://github.com/lifeyx/yaffs2.git">https://github.com/lifeyx/yaffs2.git</a></li><li>arm-linux-gcc-4.3.2  <a href="https://sourceforge.net/projects/sunsea1026/files/work/arm-linux-gcc-4.3.2.tgz/download">https://sourceforge.net/projects/sunsea1026/files/work/arm-linux-gcc-4.3.2.tgz/download</a>（这个资源真tm难找）</li></ol><p>查找开源资源<a href="https://osdn.net/">https://osdn.net</a></p><h2 id="烧写"><a href="#烧写" class="headerlink" title="烧写"></a>烧写</h2><p>u-boot用oflash工具烧写 ，windows下。（裸机，board – openJTAG – win）<br>内核和文件系统用DNW，windows下。（uboot cmd，boardUSB – win）</p><h1 id="一、编译系统的一堆命令"><a href="#一、编译系统的一堆命令" class="headerlink" title="一、编译系统的一堆命令"></a>一、编译系统的一堆命令</h1><h2 id="1-编译uboot"><a href="#1-编译uboot" class="headerlink" title="1. 编译uboot"></a>1. 编译uboot</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">tar</span> xjf u-boot-1.1.6.tar.bz2    解压<span class="token builtin class-name">cd</span> u-boot-1.1.6/                到目录下patch -p1 <span class="token operator">&lt;</span> <span class="token punctuation">..</span>/u-boot-1.1.6_jz2440.patch  打补丁 <span class="token function">make</span> 100ask24x0_config                    配置make<span class="token function">make</span>                                      <span class="token function">make</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-编译内核"><a href="#2-编译内核" class="headerlink" title="2. 编译内核"></a>2. 编译内核</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">tar</span> -xjf linux-3.4.2.tar.bz2<span class="token builtin class-name">cd</span> linux-3.4.2<span class="token function">make</span> mini2440_defconfig./patch-ker.sh c m <span class="token punctuation">..</span>/linux-3.4.2 <span class="token comment"># yaffs2文件补丁，按照下面错误2步骤下载 打补丁 编译</span><span class="token function">make</span> menuconfig<span class="token function">make</span> uImage -j8<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-文件系统-yaffs2"><a href="#3-文件系统-yaffs2" class="headerlink" title="3. 文件系统 yaffs2"></a>3. 文件系统 yaffs2</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 解压编译安装到fsroot</span><span class="token function">tar</span> -xjf busybox-1.20.0.tar.bz2<span class="token function">make</span> menuconfigBusybox Settings  ---<span class="token operator">></span> Build Options  ---<span class="token operator">></span>Cross Compiler prefix <span class="token punctuation">(</span>输入 arm-linux- 或 在中<span class="token punctuation">)</span><span class="token function">make</span><span class="token function">mkdir</span> fsroot1.20.0<span class="token function">make</span> <span class="token assign-left variable">CONFIG_PREFIX</span><span class="token operator">=</span>~/Desktop/uboot-kernel/fsroot1.20.0 <span class="token function">install</span><span class="token comment"># 在fsroot中创建文件</span><span class="token function">mkdir</span> etc<span class="token function">mkdir</span> lib usr/lib<span class="token function">cp</span> -pd /usr/local/arm/arm-linux-gcc-4.3.2/arm-none-linux-gnueabi/libc/armv4t/lib/*.so* lib/<span class="token function">cp</span> -pd /usr/local/arm/arm-linux-gcc-4.3.2/arm-none-linux-gnueabi/libc/armv4t/usr/lib/*.so* usr/lib/ 注意安装库的时候：加-pd选项（把链接文件cp后也作为链接文件，否则会cp链接后的实际文件，导致fs异常庞大，p是保留源文件属性。）<span class="token builtin class-name">cd</span> etc<span class="token function">vim</span> inittab-----------------------------<span class="token comment"># /etc/inittab</span>::sysinit:/etc/init.d/rcSconsole::askfirst:-/bin/sh::ctrlaltdel:/sbin/reboot::shutdown:/bin/umount -a -r-----------------------------<span class="token function">mkdir</span> init.d<span class="token function">vim</span> init.d/rcS------------------------------------------<span class="token comment">#!/bin/sh</span><span class="token function">mount</span> -a<span class="token function">mkdir</span> /dev/pts<span class="token function">mount</span> -t devpts devpts /dev/pts<span class="token builtin class-name">echo</span> /sbin/mdev <span class="token operator">></span> /proc/sys/kernel/hotplugmdev -s------------------------------------------<span class="token function">chmod</span> a+x init.d/rcS<span class="token function">vim</span> fstab------------------------------------------------------------------<span class="token comment"># device     mount-point    type   options        dump  fsck order</span>proc           /proc        proc   defaults        <span class="token number">0</span>     <span class="token number">0</span>tmpfs          /tmp         tmpfs  defaults        <span class="token number">0</span>     <span class="token number">0</span>sysfs          /sys         sysfs  defaults        <span class="token number">0</span>     <span class="token number">0</span>tmpfs          /dev         tmpfs  defaults        <span class="token number">0</span>     <span class="token number">0</span>------------------------------------------------------------------<span class="token function">mkdir</span> dev<span class="token builtin class-name">cd</span> dev<span class="token function">sudo</span> <span class="token function">mknod</span> console c <span class="token number">5</span> <span class="token number">1</span><span class="token function">sudo</span> <span class="token function">mknod</span> null c <span class="token number">1</span> <span class="token number">3</span><span class="token function">mkdir</span> proc tmp mnt sys root<span class="token comment"># 制作yaffs2文件</span>mkyaffs2image fsroot1.20.0 fsroot.yaffs2  <span class="token comment"># 需要安装mkyaffs2image工具</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/images/20200627115801434.png"></p><h3 id="额外的，自启动脚本配置-自动配置网卡"><a href="#额外的，自启动脚本配置-自动配置网卡" class="headerlink" title="额外的，自启动脚本配置 + 自动配置网卡"></a>额外的，自启动脚本配置 + 自动配置网卡</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">自启动脚本配置 + 自动配置网卡<span class="token function">vi</span> etc/init.d/rcS------------------------------------------<span class="token comment">#!/bin/sh</span><span class="token function">mount</span> -a<span class="token function">mkdir</span> /dev/pts<span class="token function">mount</span> -t devpts devpts /dev/pts<span class="token builtin class-name">echo</span> /sbin/mdev <span class="token operator">></span> /proc/sys/kernel/hotplugmdev -s<span class="token builtin class-name">exec</span> /etc/rc.local <span class="token comment"># 添加这一行</span>------------------------------------------<span class="token function">vi</span> etc/rc.local----------------------------------------------------------<span class="token function">ifconfig</span> eth0 <span class="token number">192.168</span>.1.100<span class="token function">mount</span> -t nfs -o tcp,nolock <span class="token number">192.168</span>.1.103:/nfs/fs_root /mnt----------------------------------------------------------<span class="token function">chmod</span> +x rc.local<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="二、修改默认分区大小"><a href="#二、修改默认分区大小" class="headerlink" title="二、修改默认分区大小"></a>二、修改默认分区大小</h1><p>需要修改uboot的宏(或者直接在uboot cmd中修改) 和 内核代码的mtd分区和偏移，使得两者保持一致。</p><blockquote><p><strong>注意：如果进入uboot后<code>print</code>命令出现了<code>mtdparts</code>参数，那么需要去掉它才是我们在uboot中指定的默认参数（我们在uboot源码中修改的宏），否则会使用print出来的参数，就算uboot源码改过也不起作用。</strong><br>uboot命令中去掉mtdparts参数方法：<br>set mtdparts<br>save</p></blockquote><h2 id="1-修改uboot的宏"><a href="#1-修改uboot的宏" class="headerlink" title="1. 修改uboot的宏"></a>1. 修改uboot的宏</h2><p>uboot中在include/configs/100ask24x0.h，中修改, </p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 只修改这里不一定起作用，还要去掉uboot参数mtdparts。</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MTDPARTS_DEFAULT</span> <span class="token string">"mtdparts=nandflash0:256k@0(bootloader),"</span> <span class="token punctuation">\</span>                            <span class="token string">"128k(params),"</span> <span class="token punctuation">\</span>                            <span class="token string">"4m(kernel),"</span> <span class="token expression">\ </span><span class="token comment">// 2m -> 4m</span></span>                            <span class="token string">"-(root)"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2-修改内核的mtd分区大小和偏移"><a href="#2-修改内核的mtd分区大小和偏移" class="headerlink" title="2. 修改内核的mtd分区大小和偏移"></a>2. 修改内核的mtd分区大小和偏移</h2><p>在文件arch/arm/mach-s3c24xx/mach-mini2440.c中，<br>原来nand为2MB用于存储内核镜像，现在修改为4M，偏移对应修改即可。</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* NAND Flash on MINI2440 board */</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">mtd_partition</span> mini2440_default_nand_part<span class="token punctuation">[</span><span class="token punctuation">]</span> __initdata <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>name<span class="token operator">=</span> <span class="token string">"bootloader"</span><span class="token punctuation">,</span><span class="token punctuation">.</span>size<span class="token operator">=</span> SZ_256K<span class="token punctuation">,</span><span class="token punctuation">.</span>offset<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>name<span class="token operator">=</span> <span class="token string">"params"</span><span class="token punctuation">,</span><span class="token punctuation">.</span>size<span class="token operator">=</span> SZ_128K<span class="token punctuation">,</span><span class="token punctuation">.</span>offset<span class="token operator">=</span> SZ_256K<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>name<span class="token operator">=</span> <span class="token string">"kernel"</span><span class="token punctuation">,</span><span class="token comment">/* 5 megabytes, for a kernel with no modules * or a uImage with a ramdisk attached */</span><span class="token punctuation">.</span>size<span class="token operator">=</span> <span class="token number">0x00400000</span><span class="token punctuation">,</span><span class="token comment">// 这里修改内核分区大小</span><span class="token punctuation">.</span>offset<span class="token operator">=</span> SZ_256K <span class="token operator">+</span> SZ_128K<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>name<span class="token operator">=</span> <span class="token string">"root"</span><span class="token punctuation">,</span><span class="token punctuation">.</span>offset<span class="token operator">=</span> SZ_256K <span class="token operator">+</span> SZ_128K <span class="token operator">+</span> <span class="token number">0x00400000</span><span class="token punctuation">,</span><span class="token comment">// 这里修改root分区的offset</span><span class="token punctuation">.</span>size<span class="token operator">=</span> MTDPART_SIZ_FULL<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="三、在源码中修改uboot的tftp-ip"><a href="#三、在源码中修改uboot的tftp-ip" class="headerlink" title="三、在源码中修改uboot的tftp ip"></a>三、在源码中修改uboot的tftp ip</h1><p>在uboot的include/configs/100ask24x0.h中，</p><pre class="line-numbers language-none"><code class="language-none">#define CONFIG_IPADDR192.168.1.100#define CONFIG_SERVERIP192.168.1.103<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h1 id="四、报错"><a href="#四、报错" class="headerlink" title="四、报错"></a>四、报错</h1><h2 id="1-读出内核但是-内核校验出错"><a href="#1-读出内核但是-内核校验出错" class="headerlink" title="1. 读出内核但是 内核校验出错"></a>1. 读出内核但是 内核校验出错</h2><pre class="line-numbers language-none"><code class="language-none">NAND read: device 0 offset 0x60000, size 0x200000Reading data from 0x25f800 -- 100% complete. 2097152 bytes read: OK## Booting image at 30007fc0 ...   Image Name:   Linux-3.4.2   Created:      2020-06-26   7:42:00 UTC   Image Type:   ARM Linux Kernel Image (uncompressed)   Data Size:    2472992 Bytes &#x3D;  2.4 MB   Load Address: 30008000   Entry Point:  30008000   Verifying Checksum ... Bad Data CRC<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/images/20200627103712725.png"></p><h2 id="1-解决办法"><a href="#1-解决办法" class="headerlink" title="1. 解决办法"></a>1. 解决办法</h2><p>如错误提示所示，内核大小为2.4MB，但是只从NAND中读出了2MB，当然校验出错。<br>需要修改内核分区的大小，保证uboot中的mtd分区大小和内核mtd分区大小和偏移保持一致即可。</p><h2 id="2-版本3-4-2内核无法识别yaffs2文件系统"><a href="#2-版本3-4-2内核无法识别yaffs2文件系统" class="headerlink" title="2. 版本3.4.2内核无法识别yaffs2文件系统"></a>2. 版本3.4.2内核无法识别yaffs2文件系统</h2><pre class="line-numbers language-none"><code class="language-none">List of all partitions:1f00             256 mtdblock0  (driver?)1f01             128 mtdblock1  (driver?)1f02            4096 mtdblock2  (driver?)1f03          257664 mtdblock3  (driver?)No filesystem could mount root, tried:  ext3 cramfs vfat msdos romfsKernel panic - not syncing: VFS: Unable to mount root fs on unknown-block(31,3)[&lt;c000dc1c&gt;] (unwind_backtrace+0x0&#x2F;0xf8) from [&lt;c0340dac&gt;] (panic+0x74&#x2F;0x1d0)[&lt;c0340dac&gt;] (panic+0x74&#x2F;0x1d0) from [&lt;c0441e70&gt;] (mount_block_root+0x1d0&#x2F;0x22c)[&lt;c0441e70&gt;] (mount_block_root+0x1d0&#x2F;0x22c) from [&lt;c0441f4c&gt;] (mount_root+0x80&#x2F;0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/images/20200627101430230.png"></p><h2 id="2-解决办法"><a href="#2-解决办法" class="headerlink" title="2. 解决办法"></a>2. 解决办法</h2><p><strong>内核默认没有yaffs2文件系统格式，需要下载补丁，重新配置内核，再make umage。</strong><br><a href="https://blog.csdn.net/qq_16933601/article/details/105889600">这篇文章</a>详细介绍了如何打yaffs2的补丁和修改编译的错误。<br>主要步骤：</p><ol><li>下载yaffs源码 git clone <a href="mailto:&#103;&#x69;&#x74;&#64;&#x67;&#105;&#116;&#104;&#117;&#98;&#x2e;&#99;&#111;&#x6d;">&#103;&#x69;&#x74;&#64;&#x67;&#105;&#116;&#104;&#117;&#98;&#x2e;&#99;&#111;&#x6d;</a>:lifeyx/yaffs2.git</li><li>打补丁到内核 <pre class="line-numbers language-none"><code class="language-none">cd yaffs2&#x2F;.&#x2F;patch-ker.sh  c m linux-3.4.2 &#x2F;&#x2F;c 将yffs2文件夹copy到linux-3.4.2&#x2F;fs   m 指定多版本<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li>配置内核 <pre class="line-numbers language-none"><code class="language-none">make menuconfig-&gt; File systems      -&gt; Miscellaneous filesystems (MISC_FILESYSTEMS [&#x3D;y])             &lt;*&gt;   yaffs2 file system support <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre> <img src="/images/20200627095748566.png"><h2 id="3-文件系统挂上了-后面出错"><a href="#3-文件系统挂上了-后面出错" class="headerlink" title="3. 文件系统挂上了 后面出错"></a>3. 文件系统挂上了 后面出错</h2><img src="/images/20200626154258423.png"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">s3c-rtc s3c2410-rtc: setting system clock to <span class="token number">2000</span>-01-01 03:24:11 UTC <span class="token punctuation">(</span><span class="token number">946697051</span><span class="token punctuation">)</span>ALSA device list:  No soundcards found.yaffs: dev is <span class="token number">32505859</span> name is <span class="token string">"mtdblock3"</span> rwyaffs: passed flags <span class="token string">""</span>VFS: Mounted root <span class="token punctuation">(</span>yaffs filesystem<span class="token punctuation">)</span> on device <span class="token number">31</span>:3.Freeing init memory: 148KKernel panic - not syncing: Attempted to <span class="token function">kill</span> init<span class="token operator">!</span> <span class="token assign-left variable">exitcode</span><span class="token operator">=</span>0x00000200<span class="token punctuation">[</span><span class="token operator">&lt;</span>c000dc1c<span class="token operator">></span><span class="token punctuation">]</span> <span class="token punctuation">(</span>unwind_backtrace+0x0/0xf8<span class="token punctuation">)</span> from <span class="token punctuation">[</span><span class="token operator">&lt;</span>c0352d2c<span class="token operator">></span><span class="token punctuation">]</span> <span class="token punctuation">(</span>panic+0x74/0x1d0<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">&lt;</span>c0352d2c<span class="token operator">></span><span class="token punctuation">]</span> <span class="token punctuation">(</span>panic+0x74/0x1d0<span class="token punctuation">)</span> from <span class="token punctuation">[</span><span class="token operator">&lt;</span>c001aabc<span class="token operator">></span><span class="token punctuation">]</span> <span class="token punctuation">(</span>do_exit+0x628/0x74c<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">&lt;</span>c001aabc<span class="token operator">></span><span class="token punctuation">]</span> <span class="token punctuation">(</span>do_exit+0x628/0x74c<span class="token punctuation">)</span> from <span class="token punctuation">[</span><span class="token operator">&lt;</span>c001acbc<span class="token operator">></span><span class="token punctuation">]</span> <span class="token punctuation">(</span>sys_exit+0x10/0x14<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">&lt;</span>c001acbc<span class="token operator">></span><span class="token punctuation">]</span> <span class="token punctuation">(</span>sys_exit+0x10/0x14<span class="token punctuation">)</span> from <span class="token punctuation">[</span><span class="token operator">&lt;</span>c000922<span class="token operator"><span class="token file-descriptor important">0</span>></span><span class="token punctuation">]</span> <span class="token punctuation">(</span>ret_fast_syscall+0x0/0x2c<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-解决办法"><a href="#3-解决办法" class="headerlink" title="3. 解决办法"></a>3. 解决办法</h2>内核配置选项中勾选下面两个选项，重新编译uImage：<pre class="line-numbers language-none"><code class="language-none">[*] Use the ARM EABI to compile the kernel.[*]  Allow old ABI binaries to run with this kernel (EXPERIMENTAL) (NEW)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><img src="/images/20200626155000869.png"></li></ol><h1 id="五、打印信息"><a href="#五、打印信息" class="headerlink" title="五、打印信息"></a>五、打印信息</h1><h2 id="u-boot打印信息"><a href="#u-boot打印信息" class="headerlink" title="u-boot打印信息"></a>u-boot打印信息</h2><h3 id="1-u-boot启动打印"><a href="#1-u-boot启动打印" class="headerlink" title="1. u-boot启动打印"></a>1. u-boot启动打印</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">U-Boot <span class="token number">1.1</span>.6 <span class="token builtin class-name">enable</span> Ethernet alltime<span class="token punctuation">(</span>May <span class="token number">15</span> <span class="token number">2018</span> - <span class="token number">19</span>:44:59<span class="token punctuation">)</span>DRAM:  <span class="token number">64</span> MBJEDEC PROBE: ID <span class="token number">90</span> <span class="token number">0</span> <span class="token number">0</span>Flash:  <span class="token number">0</span> kBNAND:  <span class="token number">256</span> MiBIn:    serialOut:   serialErr:   serialUPLLVal <span class="token punctuation">[</span>M:38h,P:2h,S:2h<span class="token punctuation">]</span>MPLLVal <span class="token punctuation">[</span>M:5ch,P:1h,S:1h<span class="token punctuation">]</span>CLKDIVN:5h+---------------------------------------------+<span class="token operator">|</span> S3C2440A USB Downloader ver R0.03 <span class="token number">2004</span> Jan  <span class="token operator">|</span>+---------------------------------------------+USB: IN_ENDPOINT:1 OUT_ENDPOINT:3FORMAT: <span class="token operator">&lt;</span>ADDR<span class="token punctuation">(</span>DATA<span class="token punctuation">)</span>:<span class="token operator"><span class="token file-descriptor important">4</span>></span>+<span class="token operator">&lt;</span>SIZE<span class="token punctuation">(</span>n+10<span class="token punctuation">)</span>:<span class="token operator"><span class="token file-descriptor important">4</span>></span>+<span class="token operator">&lt;</span>DATA:n<span class="token operator">></span>+<span class="token operator">&lt;</span>CS:<span class="token operator"><span class="token file-descriptor important">2</span>></span>NOTE: Power off/on or press the reset button <span class="token keyword">for</span> <span class="token number">1</span> sec      <span class="token keyword">in</span> order to get a valid USB device address.Hit any key to stop autoboot:  <span class="token number">0</span>ERROR: resetting DM9000 -<span class="token operator">></span> not respondingdm9000 i/o: 0x20000000, id: 0x90000a46DM9000: running <span class="token keyword">in</span> <span class="token number">16</span> bit modeMAC: 08:00:3e:26:0a:5bcould not establish <span class="token function">link</span><span class="token comment">##### 100ask Bootloader for OpenJTAG #####</span><span class="token punctuation">[</span>n<span class="token punctuation">]</span> Download u-boot to Nand Flash<span class="token punctuation">[</span>c<span class="token punctuation">]</span> Re-scan Nor Flash<span class="token punctuation">[</span>u<span class="token punctuation">]</span> Copy bootloader from nand to nor<span class="token punctuation">[</span>v<span class="token punctuation">]</span> Copy bootloader from nor to nand<span class="token punctuation">[</span>k<span class="token punctuation">]</span> Download Linux kernel uImage<span class="token punctuation">[</span>j<span class="token punctuation">]</span> Download root_jffs2 image<span class="token punctuation">[</span>y<span class="token punctuation">]</span> Download root_yaffs image<span class="token punctuation">[</span>d<span class="token punctuation">]</span> Download to SDRAM <span class="token operator">&amp;</span> Run<span class="token punctuation">[</span>z<span class="token punctuation">]</span> Download zImage into RAM<span class="token punctuation">[</span>g<span class="token punctuation">]</span> Boot linux from RAM<span class="token punctuation">[</span>f<span class="token punctuation">]</span> Format the Nand Flash<span class="token punctuation">[</span>s<span class="token punctuation">]</span> Set the boot parameters<span class="token punctuation">[</span>b<span class="token punctuation">]</span> Boot the system<span class="token punctuation">[</span>r<span class="token punctuation">]</span> Reboot u-boot<span class="token punctuation">[</span>q<span class="token punctuation">]</span> Quit from menuEnter your selection:<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-u-boot的print"><a href="#2-u-boot的print" class="headerlink" title="2. u-boot的print"></a>2. u-boot的print</h3><p>1.8M的内核镜像文件，这里分配2M够用，<br><img src="/images/20200626101722332.png"></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">OpenJTAG<span class="token operator">></span> print<span class="token assign-left variable">bootargs</span><span class="token operator">=</span>noinitrd <span class="token assign-left variable">root</span><span class="token operator">=</span>/dev/mtdblock3 <span class="token assign-left variable">init</span><span class="token operator">=</span>/linuxrc <span class="token assign-left variable">console</span><span class="token operator">=</span>ttySAC0,115200<span class="token assign-left variable">bootcmd</span><span class="token operator">=</span>nand read.jffs2 0x30007FC0 kernel<span class="token punctuation">;</span> bootm 0x30007FC0<span class="token assign-left variable">bootdelay</span><span class="token operator">=</span><span class="token number">2</span><span class="token assign-left variable">baudrate</span><span class="token operator">=</span><span class="token number">115200</span><span class="token assign-left variable">ethaddr</span><span class="token operator">=</span>08:00:3e:26:0a:5b<span class="token assign-left variable">netmask</span><span class="token operator">=</span><span class="token number">255.255</span>.255.0<span class="token assign-left variable">mtdids</span><span class="token operator">=</span>nand0<span class="token operator">=</span>nandflash0<span class="token assign-left variable">mtdparts</span><span class="token operator">=</span>mtdparts<span class="token operator">=</span>nandflash0:256k@0<span class="token punctuation">(</span>bootloader<span class="token punctuation">)</span>,128k<span class="token punctuation">(</span>params<span class="token punctuation">)</span>,2m<span class="token punctuation">(</span>kernel<span class="token punctuation">)</span>,-<span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token assign-left variable">serverip</span><span class="token operator">=</span><span class="token number">192.168</span>.1.103<span class="token assign-left variable">ipaddr</span><span class="token operator">=</span><span class="token number">192.168</span>.1.100<span class="token assign-left variable">stdin</span><span class="token operator">=</span>serial<span class="token assign-left variable">stdout</span><span class="token operator">=</span>serial<span class="token assign-left variable">stderr</span><span class="token operator">=</span>serial<span class="token assign-left variable">partition</span><span class="token operator">=</span>nand0,0<span class="token assign-left variable">mtddevnum</span><span class="token operator">=</span><span class="token number">0</span><span class="token assign-left variable">mtddevname</span><span class="token operator">=</span>bootloaderEnvironment size: <span class="token number">452</span>/131068 bytesOpenJTAG<span class="token operator">></span> bUnknown <span class="token builtin class-name">command</span> <span class="token string">'b'</span> - try <span class="token string">'help'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-uboot-mtd分区情况"><a href="#3-uboot-mtd分区情况" class="headerlink" title="3. uboot mtd分区情况"></a>3. uboot mtd分区情况</h3><p><img src="/images/20200626105248109.png"></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">OpenJTAG<span class="token operator">></span> mtddevice nand0 <span class="token operator">&lt;</span>nandflash<span class="token operator"><span class="token file-descriptor important">0</span>></span>, <span class="token comment"># parts = 4</span> <span class="token comment">#: name                        size            offset          mask_flags</span> <span class="token number">0</span>: bootloader          0x00040000      0x00000000      <span class="token number">0</span> <span class="token number">1</span>: params              0x00020000      0x00040000      <span class="token number">0</span> <span class="token number">2</span>: kernel              0x00200000      0x00060000      <span class="token number">0</span> <span class="token number">3</span>: root                0x0fda0000      0x00260000      <span class="token number">0</span>active partition: nand0,0 - <span class="token punctuation">(</span>bootloader<span class="token punctuation">)</span> 0x00040000 @ 0x00000000defaults:mtdids  <span class="token builtin class-name">:</span> <span class="token assign-left variable">nand0</span><span class="token operator">=</span>nandflash0mtdparts: <span class="token assign-left variable">mtdparts</span><span class="token operator">=</span>nandflash0:256k@0<span class="token punctuation">(</span>bootloader<span class="token punctuation">)</span>,128k<span class="token punctuation">(</span>params<span class="token punctuation">)</span>,4m<span class="token punctuation">(</span>kernel<span class="token punctuation">)</span>,-<span class="token punctuation">(</span>root<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="内核启动过程的打印信息"><a href="#内核启动过程的打印信息" class="headerlink" title="内核启动过程的打印信息"></a>内核启动过程的打印信息</h2><p><img src="/images/20200626101925180.png"></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">NAND read: device <span class="token number">0</span> offset 0x60000, size 0x200000Reading data from 0x25f800 -- <span class="token number">100</span>% complete. <span class="token number">2097152</span> bytes read: OK<span class="token comment">## Booting image at 30007fc0 ...</span>   Image Name:   Linux-2.6.22.6   Created:      <span class="token number">2018</span>-05-15  <span class="token number">11</span>:57:26 UTC   Image Type:   ARM Linux Kernel Image <span class="token punctuation">(</span>uncompressed<span class="token punctuation">)</span>   Data Size:    <span class="token number">1848728</span> Bytes <span class="token operator">=</span>  <span class="token number">1.8</span> MB   Load Address: <span class="token number">30008000</span>   Entry Point:  <span class="token number">30008000</span>   Verifying Checksum <span class="token punctuation">..</span>. OK   XIP Kernel Image <span class="token punctuation">..</span>. OKStarting kernel <span class="token punctuation">..</span>.Uncompressing Linux<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span> done, booting the kernel.Linux version <span class="token number">2.6</span>.22.6 <span class="token punctuation">(</span>root@book-virtual-machine<span class="token punctuation">)</span> <span class="token punctuation">(</span>gcc version <span class="token number">3.4</span>.5<span class="token punctuation">)</span> <span class="token comment">#1 Tue May 15 19:57:22 CST 2018</span>CPU: ARM920T <span class="token punctuation">[</span><span class="token number">41129200</span><span class="token punctuation">]</span> revision <span class="token number">0</span> <span class="token punctuation">(</span>ARMv4T<span class="token punctuation">)</span>, <span class="token assign-left variable">cr</span><span class="token operator">=</span>c0007177Machine: SMDK2440Memory policy: ECC disabled, Data cache writebackCPU S3C2440A <span class="token punctuation">(</span>id 0x32440001<span class="token punctuation">)</span>S3C244X: core <span class="token number">400.000</span> MHz, memory <span class="token number">100.000</span> MHz, peripheral <span class="token number">50.000</span> MHzS3C24XX Clocks, <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2004</span> Simtec ElectronicsCLOCK: Slow mode <span class="token punctuation">(</span><span class="token number">1.500</span> MHz<span class="token punctuation">)</span>, fast, MPLL on, UPLL onCPU0: D VIVT write-back cacheCPU0: I cache: <span class="token number">16384</span> bytes, associativity <span class="token number">64</span>, <span class="token number">32</span> byte lines, <span class="token number">8</span> setsCPU0: D cache: <span class="token number">16384</span> bytes, associativity <span class="token number">64</span>, <span class="token number">32</span> byte lines, <span class="token number">8</span> setsBuilt <span class="token number">1</span> zonelists.  Total pages: <span class="token number">16256</span>Kernel <span class="token builtin class-name">command</span> line: noinitrd <span class="token assign-left variable">root</span><span class="token operator">=</span>/dev/mtdblock3 <span class="token assign-left variable">init</span><span class="token operator">=</span>/linuxrc <span class="token assign-left variable">console</span><span class="token operator">=</span>ttySAC0,115200irq: clearing subpending status 00000003irq: clearing subpending status 00000002PID <span class="token builtin class-name">hash</span> table entries: <span class="token number">256</span> <span class="token punctuation">(</span>order: <span class="token number">8</span>, <span class="token number">1024</span> bytes<span class="token punctuation">)</span>timer <span class="token assign-left variable">tcon</span><span class="token operator">=</span>00500000, tcnt a2c1, tcfg 00000200,00000000, usec 00001eb8Console: colour dummy device 80x30Dentry cache <span class="token builtin class-name">hash</span> table entries: <span class="token number">8192</span> <span class="token punctuation">(</span>order: <span class="token number">3</span>, <span class="token number">32768</span> bytes<span class="token punctuation">)</span>Inode-cache <span class="token builtin class-name">hash</span> table entries: <span class="token number">4096</span> <span class="token punctuation">(</span>order: <span class="token number">2</span>, <span class="token number">16384</span> bytes<span class="token punctuation">)</span>Memory: 64MB <span class="token operator">=</span> 64MB totalMemory: 60976KB available <span class="token punctuation">(</span>3264K code, 458K data, 140K init<span class="token punctuation">)</span>Mount-cache <span class="token builtin class-name">hash</span> table entries: <span class="token number">512</span>CPU: Testing <span class="token function">write</span> buffer coherency: okNET: Registered protocol family <span class="token number">16</span>S3C2410 Power Management, <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2004</span> Simtec ElectronicsS3C2440: Initialising architectureS3C2440: IRQ SupportS3C2440: Clock Support, DVS offS3C24XX DMA Driver, <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2003</span>-2004,2006 Simtec ElectronicsDMA channel <span class="token number">0</span> at c4800000, irq <span class="token number">33</span>DMA channel <span class="token number">1</span> at c4800040, irq <span class="token number">34</span>DMA channel <span class="token number">2</span> at c4800080, irq <span class="token number">35</span>DMA channel <span class="token number">3</span> at c48000c0, irq <span class="token number">36</span>SCSI subsystem initializedusbcore: registered new interface driver usbfsusbcore: registered new interface driver hubusbcore: registered new device driver usbNET: Registered protocol family <span class="token number">2</span>IP route cache <span class="token builtin class-name">hash</span> table entries: <span class="token number">1024</span> <span class="token punctuation">(</span>order: <span class="token number">0</span>, <span class="token number">4096</span> bytes<span class="token punctuation">)</span>TCP established <span class="token builtin class-name">hash</span> table entries: <span class="token number">2048</span> <span class="token punctuation">(</span>order: <span class="token number">2</span>, <span class="token number">16384</span> bytes<span class="token punctuation">)</span>TCP <span class="token builtin class-name">bind</span> <span class="token builtin class-name">hash</span> table entries: <span class="token number">2048</span> <span class="token punctuation">(</span>order: <span class="token number">1</span>, <span class="token number">8192</span> bytes<span class="token punctuation">)</span>TCP: Hash tables configured <span class="token punctuation">(</span>established <span class="token number">2048</span> <span class="token builtin class-name">bind</span> <span class="token number">2048</span><span class="token punctuation">)</span>TCP reno registeredNetWinder Floating Point Emulator V0.97 <span class="token punctuation">(</span>double precision<span class="token punctuation">)</span>Registering GDB sysrq handlerJFFS2 version <span class="token number">2.2</span>. <span class="token punctuation">(</span>NAND<span class="token punctuation">)</span> © <span class="token number">2001</span>-2006 Red Hat, Inc.yaffs May <span class="token number">15</span> <span class="token number">2018</span> <span class="token number">19</span>:56:07 Installing.io scheduler noop registeredio scheduler anticipatory registered <span class="token punctuation">(</span>default<span class="token punctuation">)</span>io scheduler deadline registeredio scheduler cfq registeredConsole: switching to colour frame buffer device 60x34fb0: s3c2410fb frame buffer devicelp: driver loaded but no devices foundppdev: user-space parallel port driverS3C2410 Watchdog Timer, <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2004</span> Simtec ElectronicsSerial: <span class="token number">8250</span>/16550 driver <span class="token variable">$Revision</span><span class="token builtin class-name">:</span> <span class="token number">1.90</span> $ <span class="token number">4</span> ports, IRQ sharing enableds3c2440-uart.0: s3c2410_serial0 at MMIO map 0x50000000 mem 0xf0400000 <span class="token punctuation">(</span>irq <span class="token operator">=</span> <span class="token number">70</span><span class="token punctuation">)</span> is a S3C2440s3c2440-uart.1: s3c2410_serial1 at MMIO map 0x50004000 mem 0xf0404000 <span class="token punctuation">(</span>irq <span class="token operator">=</span> <span class="token number">73</span><span class="token punctuation">)</span> is a S3C2440s3c2440-uart.2: s3c2410_serial2 at MMIO map 0x50008000 mem 0xf0408000 <span class="token punctuation">(</span>irq <span class="token operator">=</span> <span class="token number">76</span><span class="token punctuation">)</span> is a S3C2440RAMDISK driver initialized: <span class="token number">16</span> RAM disks of 4096K size <span class="token number">1024</span> blocksizeloop: module loadedline <span class="token number">400</span> <span class="token operator">&lt;</span>DM9KS<span class="token operator">></span> I/O: c486a000, VID: 90000a46line <span class="token number">408</span> <span class="token operator">&lt;</span>DM9KS<span class="token operator">></span> I/O: c486a000, VID: 90000a46<span class="token operator">&lt;</span>DM9KS<span class="token operator">></span> error version, chip_revision <span class="token operator">=</span> 0x1a, chip_info <span class="token operator">=</span> 0x3<span class="token assign-left variable">id_val</span><span class="token operator">=</span><span class="token number">0</span>S3C24XX NAND Driver, <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2004</span> Simtec Electronicss3c2440-nand s3c2440-nand: <span class="token assign-left variable">Tacls</span><span class="token operator">=</span><span class="token number">3</span>, 30ns <span class="token assign-left variable">Twrph0</span><span class="token operator">=</span><span class="token number">7</span> 70ns, <span class="token assign-left variable">Twrph1</span><span class="token operator">=</span><span class="token number">3</span> 30nsNAND device: Manufacturer ID: 0xec, Chip ID: 0xda <span class="token punctuation">(</span>Samsung NAND 256MiB <span class="token number">3</span>,3V <span class="token number">8</span>-bit<span class="token punctuation">)</span>Scanning device <span class="token keyword">for</span> bad blocksBad eraseblock <span class="token number">46</span> at 0x005c0000Bad eraseblock <span class="token number">785</span> at 0x06220000Bad eraseblock <span class="token number">789</span> at 0x062a0000Bad eraseblock <span class="token number">1622</span> at 0x0cac0000Bad eraseblock <span class="token number">1698</span> at 0x0d440000Creating <span class="token number">4</span> MTD partitions on <span class="token string">"NAND 256MiB 3,3V 8-bit"</span><span class="token builtin class-name">:</span>0x00000000-0x00040000 <span class="token builtin class-name">:</span> <span class="token string">"bootloader"</span>0x00040000-0x00060000 <span class="token builtin class-name">:</span> <span class="token string">"params"</span>0x00060000-0x00260000 <span class="token builtin class-name">:</span> <span class="token string">"kernel"</span>0x00260000-0x10000000 <span class="token builtin class-name">:</span> <span class="token string">"root"</span>s3c2410-ohci s3c2410-ohci: S3C24XX OHCIs3c2410-ohci s3c2410-ohci: new USB bus registered, assigned bus number <span class="token number">1</span>s3c2410-ohci s3c2410-ohci: irq <span class="token number">42</span>, io mem 0x49000000usb usb1: configuration <span class="token comment">#1 chosen from 1 choice</span>hub <span class="token number">1</span>-0:1.0: USB hub foundhub <span class="token number">1</span>-0:1.0: <span class="token number">2</span> ports detectedInitializing USB Mass Storage driver<span class="token punctuation">..</span>.usbcore: registered new interface driver usb-storageUSB Mass Storage support registered.mice: PS/2 mouse device common <span class="token keyword">for</span> all mices3c2410 TouchScreen successfully loadedinput: s3c2410 TouchScreen as /class/input/input0S3C24XX RTC, <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2004,2006</span> Simtec Electronicss3c2440-i2c s3c2440-i2c: slave address 0x10s3c2440-i2c s3c2440-i2c: bus frequency <span class="token builtin class-name">set</span> to <span class="token number">390</span> KHzs3c2440-i2c s3c2440-i2c: i2c-0: S3C I2C adaptermapped channel <span class="token number">0</span> to <span class="token number">0</span>s3c2440-sdi s3c2440-sdi: powered down.s3c2440-sdi s3c2440-sdi: initialisation done.s3c2440-sdi s3c2440-sdi: running at 0kHz <span class="token punctuation">(</span>requested: 0kHz<span class="token punctuation">)</span>.s3c2440-sdi s3c2440-sdi: running at 196kHz <span class="token punctuation">(</span>requested: 195kHz<span class="token punctuation">)</span>.s3c2440-sdi s3c2440-sdi: running at 196kHz <span class="token punctuation">(</span>requested: 195kHz<span class="token punctuation">)</span>.s3c2440-sdi s3c2440-sdi: running at 196kHz <span class="token punctuation">(</span>requested: 195kHz<span class="token punctuation">)</span>.usbcore: registered new interface driver hiddevs3c2440-sdi s3c2440-sdi: CMD<span class="token punctuation">[</span>TIMEOUT<span class="token punctuation">]</span> <span class="token comment">#2 op:UNKNOWN(8) arg:0x000001aa flags:0x0875 retries:0 Status:nothing to complete</span>s3c2440-sdi s3c2440-sdi: CMD<span class="token punctuation">[</span>TIMEOUT<span class="token punctuation">]</span> <span class="token comment">#3 op:APP_CMD(55) arg:0x00000000 flags:0x0875 retries:0 Status:nothing to complete</span>usbcore: registered new interface driver usbhiddrivers/hid/usbhid/hid-core.c: v2.6:USB HID core driverAdvanced Linux Sound Architecture Driver Version <span class="token number">1.0</span>.14 <span class="token punctuation">(</span>Thu May <span class="token number">31</span> 09:03:25 <span class="token number">2007</span> UTC<span class="token punctuation">)</span>.ASoC version <span class="token number">0.13</span>.1s3c2440-sdi s3c2440-sdi: CMD<span class="token punctuation">[</span>TIMEOUT<span class="token punctuation">]</span> <span class="token comment">#4 op:APP_CMD(55) arg:0x00000000 flags:0x0875 retries:0 Status:nothing to complete</span>s3c2440-sdi s3c2440-sdi: CMD<span class="token punctuation">[</span>TIMEOUT<span class="token punctuation">]</span> <span class="token comment">#5 op:APP_CMD(55) arg:0x00000000 flags:0x0875 retries:0 Status:nothing to complete</span>s3c2410iis_probe<span class="token punctuation">..</span>.s3c2440-sdi s3c2440-sdi: CMD<span class="token punctuation">[</span>TIMEOUT<span class="token punctuation">]</span> <span class="token comment">#6 op:APP_CMD(55) arg:0x00000000 flags:0x0875 retries:0 Status:nothing to complete</span>s3c2440-sdi s3c2440-sdi: CMD<span class="token punctuation">[</span>TIMEOUT<span class="token punctuation">]</span> <span class="token comment">#7 op:ALL_SEND_OCR(1) arg:0x00000000 flags:0x0861 retries:0 Status:nothing to complete</span>s3c2440-sdi s3c2440-sdi: powered down.UDA1341 audio driver initializedALSA device list:  No soundcards found.TCP cubic registeredNET: Registered protocol family <span class="token number">1</span>drivers/rtc/hctosys.c: unable to <span class="token function">open</span> rtc device <span class="token punctuation">(</span>rtc0<span class="token punctuation">)</span>UDF-fs: No VRS foundyaffs: dev is <span class="token number">32505859</span> name is <span class="token string">"mtdblock3"</span>yaffs: passed flags <span class="token string">""</span>yaffs: Attempting MTD <span class="token function">mount</span> on <span class="token number">31.3</span>, <span class="token string">"mtdblock3"</span>yaffs: auto selecting yaffs2block <span class="token number">28</span> is badblock <span class="token number">767</span> is badblock <span class="token number">771</span> is badblock <span class="token number">1604</span> is badblock <span class="token number">1680</span> is badVFS: Mounted root <span class="token punctuation">(</span>yaffs filesystem<span class="token punctuation">)</span>.Freeing init memory: 140Kinit started: BusyBox v1.7.0 <span class="token punctuation">(</span><span class="token number">2008</span>-01-22 <span class="token number">10</span>:04:09 EST<span class="token punctuation">)</span>starting pid <span class="token number">764</span>, <span class="token function">tty</span> <span class="token string">''</span><span class="token builtin class-name">:</span> <span class="token string">'/etc/init.d/rcS'</span>Please press Enter to activate this console.starting pid <span class="token number">767</span>, <span class="token function">tty</span> <span class="token string">'/dev/ttySAC0'</span><span class="token builtin class-name">:</span> <span class="token string">'/bin/sh'</span><span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="参考内容"><a href="#参考内容" class="headerlink" title="参考内容"></a>参考内容</h1><ol><li><a href="https://www.cnblogs.com/multimicro/p/9872722.html">https://www.cnblogs.com/multimicro/p/9872722.html</a></li><li><a href="https://www.cnblogs.com/zzb-Dream-90Time/p/9726900.html">https://www.cnblogs.com/zzb-Dream-90Time/p/9726900.html</a></li><li><a href="https://blog.csdn.net/Carl_0/article/details/87856439">https://blog.csdn.net/Carl_0/article/details/87856439</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ARM的一些基本功arm汇编 处理器处理能力</title>
      <link href="2021/05/14/arm-de-yi-xie-ji-ben-gong-arm-hui-bian-chu-li-qi-chu-li-neng-li-local/"/>
      <url>2021/05/14/arm-de-yi-xie-ji-ben-gong-arm-hui-bian-chu-li-qi-chu-li-neng-li-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]</p><p>寻址方式：处理器根据指令中给出的信息来找到指令所需操作数的方式。 </p><p>ARM寄存器的分类和三种寻址方式讲的很清楚：<br><a href="https://blog.csdn.net/Sandeldeng/article/details/52954781">https://blog.csdn.net/Sandeldeng/article/details/52954781</a></p><p><strong>间接寻址：</strong> 通过 以存储在寄存器上的值为地址去从内存上读数据，汇编中[r0]，对应于C语言中的指针 *p。[]</p><h2 id="一些汇编指令"><a href="#一些汇编指令" class="headerlink" title="一些汇编指令"></a>一些汇编指令</h2><p><a href="https://zhuanlan.zhihu.com/p/82490125">知乎大佬直观解释</a><br>这篇文章给出列汇编指令的缩写来源，很不错<br><a href="https://blog.csdn.net/Critisk/article/details/61196190">https://blog.csdn.net/Critisk/article/details/61196190</a></p><h3 id="1-数据传送指令"><a href="#1-数据传送指令" class="headerlink" title="1. 数据传送指令"></a>1. 数据传送指令</h3><h4 id="LDR（load-register）指令-将内存内容加载入通用寄存器"><a href="#LDR（load-register）指令-将内存内容加载入通用寄存器" class="headerlink" title="LDR（load register）指令 将内存内容加载入通用寄存器"></a>LDR（load register）指令 将内存内容加载入通用寄存器</h4><h4 id="STR（store-register）指令-将寄存器内容存入内存中"><a href="#STR（store-register）指令-将寄存器内容存入内存中" class="headerlink" title="STR（store register）指令 将寄存器内容存入内存中"></a>STR（store register）指令 将寄存器内容存入内存中</h4><p><strong>LDR和STR后面可以接一些后缀，比如”B”, “H”和”W”分别表示从给定的内存地址取1个字节，2个字节和4个字节。</strong></p><ul><li>LDR与MOV的不同：ldr能将数据从内存读到CPU，或者从内存中某处读取到寄存器中，而mov只能在寄存器之间移动数据，或者把立即数移动到寄存器中，如 MOV r0,#0是将立即数0放到r0中；</li><li>MOV是从一个寄存器或者移位的寄存器或者立即数的值传递到另外一个寄存器。但不是所有立即数都可以传递的，这个立即数要符合一个8位数循环右移偶数位的取值。 <strong>立即数需要合法的原因</strong>：是，MOV本身就是一条32bit指令，除了指令码本身，它不可能再带一个可以表示32bit的数字，所以用了其中的12bit来表示立即数，其中4bit表示移位的位数(循环右移，且数值乘以2)，8bit用来表示要移位的一个基数。而对于ldr伪指令，可以在立即数前加上=，以表示把一个地址写到某寄存器中，比如：  ldr r0, =0x12345678  这样，就把0x12345678这个地址写到r0中了。ldr伪指令和mov是比较相似，但mov指令限制了立即数的长度为8位，也就是不能超过512。而ldr伪指令没有这个限制。如果使用ldr伪指令时，后面跟的立即数没有超过8位，那么在实际汇编的时候该ldr伪指令是被转换为 mov指令的。<h4 id="STM和LDM"><a href="#STM和LDM" class="headerlink" title="STM和LDM"></a>STM和LDM</h4>一个字节一个字节的传送那是“蚂蚁搬家”，如果要复制大批量的数据，效率实在不高，为此ARMv7还提供了用于批量传输的LDM和STM指令，”M”在这里代表Multiple。STM是把多个寄存器的值传送到内存相邻的位置，LDM反之。多个寄存器在ARM汇编语言中用”{}”圈起来，表示待传送的寄存器列表。<br><img src="/images/2019122215354996.png"></li></ul><p> <strong>“!”回写！！！！！</strong><br> 在汇编程序中 ！的使用，意思是回写，比如：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">ldr r1<span class="token punctuation">,</span><span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #S_PSR<span class="token punctuation">]</span>ldr lr<span class="token punctuation">,</span> <span class="token punctuation">[</span>sp<span class="token punctuation">,</span> #S_PC<span class="token punctuation">]</span><span class="token operator">!</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>其中 ! 用来控制基址变址寻址的的最终新地址是否进行回写操作。<br>此条语句的意思是 执行 ldr 之后 sp 被回写成 sp+#S_PC 基址变址寻址的新地址。<code>i++; i+1;</code> 第一个i被改变了类似加！，第二个i没有被改变。</p><h4 id="LDP-STP"><a href="#LDP-STP" class="headerlink" title="LDP/STP"></a>LDP/STP</h4><p>在ARMv8中，LDM/STM被新一代的指令LDP(Load Pair)和STP(Store Pair)所取代了，<br>LDM/STM对寄存器列表里包含的寄存器数量并没有什么限制，而LDP/STP要求和内存之间传送数据的寄存器不超过2个。因为”PUSH”和”POP”完全可以用LDM/STM表示，所以他俩也被一并干掉了。两代指令的对应关系大概是这样的：<br><img src="/images/20191222154315870.png"></p><h3 id="2-数据处理指令"><a href="#2-数据处理指令" class="headerlink" title="2. 数据处理指令"></a>2. 数据处理指令</h3><h4 id="逻辑移位"><a href="#逻辑移位" class="headerlink" title="逻辑移位"></a>逻辑移位</h4><p><strong>将寄存器中存放的内容仅仅视为一串bits</strong><br>LSL - Logical Shift Left<br>LSR - Logical Shift Righ<br>ROR(Rotate Right)<br>无循环左移指令</p><h4 id="算术移位"><a href="#算术移位" class="headerlink" title="算术移位"></a>算术移位</h4><p><strong>将寄存器中存放的内容视作一个数值，移位的时候就需要考虑数值的正负问题。</strong><br>ARM中，只有算术右移(ASR - Arithmetic shift right)指令<br>每右移一位的结果相当于除以2。</p><h4 id="数据序反转指令"><a href="#数据序反转指令" class="headerlink" title="数据序反转指令"></a>数据序反转指令</h4><p>“数据序转”是指将寄存器中的bits或bytes进行部分交换，交换的形式有很多种，包括反转所有bits的RBIT指令，反转所有bytes的REV指令，在两个16位的half word中分别反转bytes的REV16指令。64位系统中还有REV32。<br>其中REV指令应该是用的最多的，因为它可以用于网络传输中Little-Endian(LE)和Big-Endian(BE)之间的转换。<br><img src="/images/20191222160234745.png"></p><h4 id="bit手术刀"><a href="#bit手术刀" class="headerlink" title="bit手术刀"></a>bit手术刀</h4><p>要实现一些更为复杂的位操作，就需要一些更为专业的指令，比如将一个寄存器的部分bits插入另一个寄存器的指定部分的BFI(Bit Field Insert)指令，<br>或者将这些bits直接提取出来的BFX(Bit Field Extract)指令，还有将指定部分的bits清零的BFC(Bit Field Clear)指令。<br>比如”BFI W0, W1, #9, #6”就是将W1寄存器LSB端的6个bits插入到W0寄存器从bit 9到bit 14的位置。<br><img src="/images/20191222160640752.png"></p><h3 id="3-跳转指令"><a href="#3-跳转指令" class="headerlink" title="3. 跳转指令"></a>3. 跳转指令</h3><p><a href="https://zhuanlan.zhihu.com/p/84951062">https://zhuanlan.zhihu.com/p/84951062</a></p><h4 id="无条件跳转"><a href="#无条件跳转" class="headerlink" title="无条件跳转"></a>无条件跳转</h4><h5 id="B-（Branch）跳转指令-BX"><a href="#B-（Branch）跳转指令-BX" class="headerlink" title="B （Branch）跳转指令 BX"></a>B （Branch）跳转指令 BX</h5><p> 跳转指令B使程序无条件跳转到指定的地址执行程序。如果跳转的目标地址不是由立即数直接给出，而是通过寄存器给出，那就应该使用”BX”。<br>例：B  0x1234   ;跳转到绝对地址0x1234处。</p><h5 id="BL（Branch-with-Link）带返回的连接跳转"><a href="#BL（Branch-with-Link）带返回的连接跳转" class="headerlink" title="BL（Branch with Link）带返回的连接跳转"></a>BL（Branch with Link）带返回的连接跳转</h5><p><strong>暗示接下来的跳转其实是一个子函数调用</strong><br>BL指令用于实现子程序调用。子程序的返回可通过将LR寄存器的值复制到PC寄存器来实现。<br> 例：BL func    ;跳转到子程序func处执行，同时将当前pc值保存到LR中。 </p><h4 id="条件跳转"><a href="#条件跳转" class="headerlink" title="条件跳转"></a>条件跳转</h4><h5 id="IT（ARMv7）"><a href="#IT（ARMv7）" class="headerlink" title="IT（ARMv7）"></a>IT（ARMv7）</h5><p>ARMv7专门推出了长的和高级语言的关键字很像的”IF‐THEN(IT)”，这已经不是一条单独的指令了，而是一个指令块(IT blocks)。</p><h5 id="CSEL-CINC-CSET（ARMv8）"><a href="#CSEL-CINC-CSET（ARMv8）" class="headerlink" title="CSEL CINC CSET（ARMv8）"></a>CSEL CINC CSET（ARMv8）</h5><p>ARMv8</p><h3 id="MSR和MRS"><a href="#MSR和MRS" class="headerlink" title="MSR和MRS"></a>MSR和MRS</h3><p> MRS 指令:  对状态寄存器CPSR和SPSR进行读操作。通过读CPSR可以获得当前处理器的工作状态。读SPSR寄存器可以获得进入异常前的处理器状态（因为只有异常模式下有SPSR寄存器）。<br>MSR指令:    对状态寄存器CPSR和SPSR进行写操作。与MRS配合使用，可以实现对CPSR或SPSR寄存器的读-修改-写操作，可以切换处理器模式、或者允许/禁止IRQ/FIQ中断等。</p><h2 id="处理器处理能力"><a href="#处理器处理能力" class="headerlink" title="处理器处理能力"></a>处理器处理能力</h2><p>一般从汇编指令的角度去看，从两个方面回答 <strong>时钟频率和处理速度</strong>。</p><p><strong>ARM9处理能力1.1MIPS/MHz。<br>在时钟频率为1MHz的情况下，一秒钟处理110万条指令。（110万1100000）。<br>也就是说，时钟频率每增加1MHz，1秒钟就能多处理110万条指令。</strong></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ARM SoC版本号 芯片型号</title>
      <link href="2021/05/14/arm-soc-ban-ben-hao-xin-pian-xing-hao-local/"/>
      <url>2021/05/14/arm-soc-ban-ben-hao-xin-pian-xing-hao-local/</url>
      
        <content type="html"><![CDATA[<p>ARM8 – ARM9 – ARM15 – ARM7<br>依次为时间顺序。</p><p>ARM8 单核<br>ARM9 多核，功耗性能都不错，双核或四核。<br>ARM15 性能强，功耗大，好点的手机。<br>ARM7 性能差些，功耗低，4核8核，便宜，山寨平板电脑，哈哈哈。</p><h1 id="SoC"><a href="#SoC" class="headerlink" title="SoC"></a>SoC</h1><p>Cotex-A8</p><h1 id="芯片型号"><a href="#芯片型号" class="headerlink" title="芯片型号"></a>芯片型号</h1><p>S5PV210 是 Cotex-A8 的 是 ARMv7。<br>S3C2400 是 ARMv4  ARM9  </p><p>64位架构A54 A57，服务器 高端手机。<br>Cotex-M7 物联网低功耗终端。<br><img src="/images/20200611213403345.png"></p>]]></content>
      
      
      <categories>
          
          <category> 嵌入式Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 嵌入式Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Atlas200DK Mind_Studio 网页版</title>
      <link href="2021/05/14/atlas200dk-mind-studio-wang-ye-ban-local/"/>
      <url>2021/05/14/atlas200dk-mind-studio-wang-ye-ban-local/</url>
      
        <content type="html"><![CDATA[<p>找到Mind_Studio对应的版本：<a href="https://www.huaweicloud.com/ascend/resources/Tools/0">https://www.huaweicloud.com/ascend/resources/Tools/0</a><br><img src="/images/202105070846386.png"><br>DDK对应的版本，<a href="https://www.huaweicloud.com/ascend/resources/Tools/1">https://www.huaweicloud.com/ascend/resources/Tools/1</a><br><img src="/images/2020042619470513.png"><br>最后下载了就是这四个东西，<br><img src="/images/20200426194754795.png"><br>在那两个压缩包里找到这两个恶心的东西，<code>check_sha.sh</code>和<code>mind_studio.sh</code>，修改掉，<br><img src="/images/20200426195741286.png"><br><img src="/images/20200426195306272.png"><br><img src="/images/20200426195516668.png"><br><img src="/images/20200426195617211.png"><br>最后在Google Chrome上登陆，</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">https://192.168.1.120:8888密码 xxxx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Atlas </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Atlas </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Atlas 200 HiLens Kit</title>
      <link href="2021/05/14/atlas-200-hilens-kit-local/"/>
      <url>2021/05/14/atlas-200-hilens-kit-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]<br><a href="https://bbs.huaweicloud.com/forum/thread-38487-1-1.html">常见技术问题https://bbs.huaweicloud.com/forum/thread-38487-1-1.html</a></p><h1 id="默认密码"><a href="#默认密码" class="headerlink" title="默认密码"></a>默认密码</h1><p><img src="/images/20200606112709619.png"><br><img src="/images/20200606172303193.png"></p><h1 id="硬件支持"><a href="#硬件支持" class="headerlink" title="硬件支持"></a>硬件支持</h1><p>最多8路网络摄像头  1路USB摄像头。</p><p>Hilens Kit USB接口当前只支持接linux UVC协议的USB免驱摄像头，不支持键盘、鼠标。</p><p>  红色（闪烁）：表示系统产生告警。<br>   红绿（交替闪烁）：表示系统存储介质主备区异常。<br>   红色（亮2-3秒后熄灭）：表示系统进入重启状态。</p><h1 id="软件安装"><a href="#软件安装" class="headerlink" title="软件安装"></a>软件安装</h1><p>查看PDF<br>分享</p><p>HiLens Kit目前支持以下三种方式安装软件包：</p><pre><code>pip安装：执行python3 -m pip install安装pip包，如requests；也可以使用其他pip源,如python3 -m pip install requests -i http://pypi.douban.com/simple --trusted-host pypi.douban.com源码编译安装：下载源码编译aarch64版本的软件包。rpm包安装：华为开源镜像站上下载相应的rpm包及其依赖并使用rpm安装软件包。也可以参考论坛安装yum，然后使用yum安装相应的包。</code></pre><h1 id="拷贝文件到Hilens"><a href="#拷贝文件到Hilens" class="headerlink" title="拷贝文件到Hilens"></a>拷贝文件到Hilens</h1><p>先登入Hilens的ssh界面，<br>然后<code>scp -r 主机用户名@主机IP:主机文件 HilensKit路径</code><br><code>scp -r username@192.168.1.104:xxx ./</code></p><p><img src="/images/2020061117274924.png"><br><img src="/images/20200611172731626.png"></p><h1 id="修改登录方式为root-shell超时"><a href="#修改登录方式为root-shell超时" class="headerlink" title="修改登录方式为root shell超时"></a>修改登录方式为root shell超时</h1><p><a href="https://bbs.huaweicloud.com/forum/thread-38487-1-1.html">https://bbs.huaweicloud.com/forum/thread-38487-1-1.html</a></p><h2 id="1-如何用root登录，并关闭连接超时？"><a href="#1-如何用root登录，并关闭连接超时？" class="headerlink" title="1 如何用root登录，并关闭连接超时？"></a>1 如何用root登录，并关闭连接超时？</h2><p>超时控制有3个位置：sshd超时、clp超时(15min)、shell超时(5min)。clp超时目前还无法关闭，无论是否有操作，15分钟后断线。<br>1、 关闭sshd超时：<br>以账号名登录（默认admin），切换到develop模式。<code>sudo vi /etc/ssh/sshd_config</code>，找到以下设备并对应修改<br>PermitRootLogin yes（默认为PermitRootLogin no）<br>（以下语句默认开头无注释，修改为在前面增加注释符号，去掉限制root登陆的设置）<br>#ClientAliveInterval 0<br>#ClientAliveCountMax 0<br>#DenyUsers root<br>#DenyGroups root</p><h2 id="2-用root登录。关闭shell超时：命令行输入export-TMOUT-0"><a href="#2-用root登录。关闭shell超时：命令行输入export-TMOUT-0" class="headerlink" title="2 用root登录。关闭shell超时：命令行输入export TMOUT=0"></a>2 用root登录。关闭shell超时：命令行输入export TMOUT=0</h2><p><img src="/images/20200613131551161.png"></p><h1 id="本地开启-和-关闭-技能"><a href="#本地开启-和-关闭-技能" class="headerlink" title="本地开启 和 关闭 技能"></a>本地开启 和 关闭 技能</h1><p>SSH进入 <code>/home/hilens/hda/skill</code> 目录下指定技能文件夹，<br>然后用 <code>hdactl start -s $skill_id</code> 命令拉起，便可以去日志里面查看调试信息。<br>若要停止技能，使用 <code>hdactl stop -s $skill_id</code>。其中技能的 skill_id 可以在技能的文件夹名字中看到（名字的最后一段）。</p><h1 id="安装yum-Linux软件安装工具"><a href="#安装yum-Linux软件安装工具" class="headerlink" title="安装yum Linux软件安装工具"></a>安装yum Linux软件安装工具</h1><p><a href="https://bbs.huaweicloud.com/forum/thread-36021-1-1.html">https://bbs.huaweicloud.com/forum/thread-36021-1-1.html</a></p><p>安装yum之后还需要配置yum源为华为开源镜像站地址，可以参考<a href="https://support.huaweicloud.com/csg_faq/csg_04_1209.html">https://support.huaweicloud.com/csg_faq/csg_04_1209.html</a></p><h1 id="安装gcc-python-dev等"><a href="#安装gcc-python-dev等" class="headerlink" title="安装gcc python-dev等"></a>安装gcc python-dev等</h1><p><a href="https://bbs.huaweicloud.com/forum/thread-53419-1-1.html">https://bbs.huaweicloud.com/forum/thread-53419-1-1.html</a>注意要添加源，否则安装不成功</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token assign-left variable">name</span><span class="token operator">=</span>EulerOS-2.0SP8 base<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>http://developer.huawei.com/ict/site-euleros/euleros/repo/yum/2.8/os/aarch64/<span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span><span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">0</span><span class="token assign-left variable">gpgkey</span><span class="token operator">=</span>http://developer.huawei.com/ict/site-euleros/euleros/repo/yum/2.8/os/RPM-GPG-KEY-EulerOS<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="安装-make"><a href="#安装-make" class="headerlink" title="安装 make"></a>安装 make</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum -y <span class="token function">install</span> gcc automake autoconf libtool <span class="token function">make</span>yum <span class="token function">install</span> gcc gcc-c++ <span class="token comment"># 可以没有</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h1 id="安装curl"><a href="#安装curl" class="headerlink" title="安装curl"></a>安装curl</h1><p>easy_install</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://curl.haxx.se/download/curl-7.55.1.tar.gz<span class="token function">tar</span> -xzvf  curl-7.55.1.tar.gz<span class="token builtin class-name">cd</span> curl-7.55.1./configure<span class="token function">make</span><span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="配置源"><a href="#配置源" class="headerlink" title="配置源"></a>配置源</h1><p>CentOS、Euler、中标麒麟等redhat系的操作系统还可以使用epel的远程域名源，在/etc/yum.repos.d/路径下创建epel.repo文件，在epel.repo文件中写入如下内容，然后执行yum makecache即可使用：<br>[epel]<br>name=epel<br>baseurl=<a href="http://macports.pnl.gov/epel/7/aarch64/">http://macports.pnl.gov/epel/7/aarch64/</a><br>enabled=1<br>gpgcheck=0 </p>]]></content>
      
      
      <categories>
          
          <category> Atlas </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Atlas </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Atlas 200 DK登录密码 制卡安装DDK和lib</title>
      <link href="2021/05/14/atlas-200-dk-deng-lu-mi-ma-zhi-qia-an-zhuang-ddk-he-lib-local/"/>
      <url>2021/05/14/atlas-200-dk-deng-lu-mi-ma-zhi-qia-an-zhuang-ddk-he-lib-local/</url>
      
        <content type="html"><![CDATA[<p>华为云账户：<br>账户：icv-hilens 密码：</p><p>昇腾资源：<a href="https://www.huaweicloud.com/ascend/resources">https://www.huaweicloud.com/ascend/resources</a></p><p><a href="https://drive.google.com/drive/folders/1Drs_Aiu7xx6S-ix95f9kNsA6ueKRpN2J">https://drive.google.com/drive/folders/1Drs_Aiu7xx6S-ix95f9kNsA6ueKRpN2J</a></p><p>切换root用户 su - root</p><h1 id="RJ45登录"><a href="#RJ45登录" class="headerlink" title="RJ45登录"></a>RJ45登录</h1><p>登录用户名：<code>ssh HwHiAiUser@192.168.0.2</code> (原用户：ssh <a href="mailto:&#x48;&#x77;&#x48;&#105;&#65;&#x69;&#x55;&#x73;&#101;&#x72;&#x40;&#49;&#x39;&#50;&#46;&#49;&#54;&#x38;&#x2e;&#x30;&#46;&#x32;">&#x48;&#x77;&#x48;&#105;&#65;&#x69;&#x55;&#x73;&#101;&#x72;&#x40;&#49;&#x39;&#50;&#46;&#49;&#54;&#x38;&#x2e;&#x30;&#46;&#x32;</a>)<br>登录密码：<code>asdfghjkl</code> (原密码：Mind@123)<br>root用户：切换root用户 <code>su - root</code>，密码<code>asdfghjkl</code> (原密码：Mind@123)</p><h2 id="修改登录用户名-可以改，但是改了Minstudio就连不上了"><a href="#修改登录用户名-可以改，但是改了Minstudio就连不上了" class="headerlink" title="修改登录用户名(可以改，但是改了Minstudio就连不上了)"></a>修改登录用户名(可以改，但是改了Minstudio就连不上了)</h2><ol><li>切换root用户 <code>su - root</code></li><li><code>vim /etc/passwd</code> 修改最后一行的第一个<code>HwHiAiUser</code>为<code>icv</code>，第二个不修改否则登入后找不到/home/icv目录<br><img src="/images/20200710102630268.png"></li><li><code>vim /etc/shadow</code> 修改一个地方<br><img src="/images/20200710102707953.png"></li><li><code>vim /etc/group</code> 修改一个地方<br><img src="/images/20200710102727994.png"></li></ol><h1 id="内部指示灯的状态"><a href="#内部指示灯的状态" class="headerlink" title="内部指示灯的状态"></a>内部指示灯的状态</h1><p><img src="/images/20200709175022645.png"></p><h1 id="IP配置"><a href="#IP配置" class="headerlink" title="IP配置"></a>IP配置</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">source</span> /etc/network/interfaces.d/*auto loiface lo inet loopbackauto eth0iface eth0 inet staticaddress <span class="token number">192.168</span>.1.2netmask <span class="token number">255.255</span>.255.0gateway <span class="token number">192.168</span>.1.1auto usb0iface usb0 inet staticaddress <span class="token number">192.168</span>.1.2netmask <span class="token number">255.255</span>.255.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="ssh-跳转失败"><a href="#ssh-跳转失败" class="headerlink" title="ssh 跳转失败"></a>ssh 跳转失败</h1><p>删除“known_hosts”文件。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">rm</span> /home/username/.ssh/known_hosts <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="制卡过程"><a href="#制卡过程" class="headerlink" title="制卡过程"></a>制卡过程</h1><p><a href="https://support.huaweicloud.com/qs-atlas200dkappc32/atlased_04_0028.html">https://support.huaweicloud.com/qs-atlas200dkappc32/atlased_04_0028.html</a></p><h2 id="DDK资源下载（难找啊）"><a href="#DDK资源下载（难找啊）" class="headerlink" title="DDK资源下载（难找啊）"></a>DDK资源下载（难找啊）</h2><p><a href="https://www.huaweicloud.com/ascend/resources/ResourceDownload/DE51187AC4F0F5DBAB3A468952C95CADAC6308BFFFB5D064B9A30DBD2B73B4ABCEC6BAF7F594AE3C3FA89621AFFF3E3CFB4ED973618F8857D07706003D546332/DDK%20&%20Runtime/be3564c84a0546959b6439ebc4e8ae30/3/1/1?ticket=ST-63818-B0KaxNRDrP3SdJsy5XXR4xd2-sso&locale=zh-cn">https://www.huaweicloud.com/ascend/resources/ResourceDownload/DE51187AC4F0F5DBAB3A468952C95CADAC6308BFFFB5D064B9A30DBD2B73B4ABCEC6BAF7F594AE3C3FA89621AFFF3E3CFB4ED973618F8857D07706003D546332/DDK &amp; Runtime/be3564c84a0546959b6439ebc4e8ae30/3/1/1?ticket=ST-63818-B0KaxNRDrP3SdJsy5XXR4xd2-sso&amp;locale=zh-cn</a></p><h2 id="资源完整性校验"><a href="#资源完整性校验" class="headerlink" title="资源完整性校验"></a>资源完整性校验</h2><p><a href="https://support.huaweicloud.com/instg-atlas200dkappc32/atlasdd_03_0009.html">https://support.huaweicloud.com/instg-atlas200dkappc32/atlasdd_03_0009.html</a></p><h1 id="安装-MindStudio"><a href="#安装-MindStudio" class="headerlink" title="安装 MindStudio"></a>安装 MindStudio</h1><p>问答：<a href="https://www.huaweicloud.com/ascend/doc/mindstudio/2.1.0(beta)/zh/zh-cn_topic_0200347813.html">https://www.huaweicloud.com/ascend/doc/mindstudio/2.1.0(beta)/zh/zh-cn_topic_0200347813.html</a><br>所有工具下载：<a href="https://www.huaweicloud.com/ascend/resources/Tools">https://www.huaweicloud.com/ascend/resources/Tools</a></p><p>下载MindStudio<br><a href="https://www.huaweicloud.com/ascend/resources/Tools/0">https://www.huaweicloud.com/ascend/resources/Tools/0</a><br>下载DDK<br><a href="https://www.huaweicloud.com/ascend/resources/Tools/1">https://www.huaweicloud.com/ascend/resources/Tools/1</a></p><h1 id="安装-DDK-和-lib"><a href="#安装-DDK-和-lib" class="headerlink" title="安装 DDK 和 lib"></a>安装 DDK 和 lib</h1><p><a href="https://support.huaweicloud.com/instg-atlas200dkappc32/atlasdd_03_0013.html">https://support.huaweicloud.com/instg-atlas200dkappc32/atlasdd_03_0013.html</a></p>]]></content>
      
      
      <categories>
          
          <category> Atlas </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Atlas </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Atlas 200 DKcam   摄像头yolov3 opencv参数</title>
      <link href="2021/05/14/atlas-200-dkcam-she-xiang-tou-yolov3-opencv-can-shu-local/"/>
      <url>2021/05/14/atlas-200-dkcam-she-xiang-tou-yolov3-opencv-can-shu-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]</p><h1 id="cam例程"><a href="#cam例程" class="headerlink" title="cam例程"></a>cam例程</h1><p>项目github地址 <a href="https://github.com/Atlas200dk/sample-ascendcamera">https://github.com/Atlas200dk/sample-ascendcamera</a></p><ul><li><p>修改param_configure.conf内容为<code>remote_host=192.168.0.2</code>，</p></li><li><p>编译完，</p></li><li><p>运行，</p></li><li><p>在Atlas侧的out目录下运行<code>./workspace_mind_studio_sample-ascendcamera-1-3x-0-0 -v -c 0 --fps 20 -w 704 -h 576 -s 192.168.0.103:7002/qqq</code><br><img src="/images/20201001165042455.png"></p></li><li><p>电脑Terminal <code>sudo bash run_present_server.sh</code>，用浏览器打开下面的地址和端口，<code>http://192.168.1.101:7003</code><br><img src="/images/20201001164553498.png"><br>浏览器中就会出现如下，打勾，点击即可进入实时视频，<br><img src="/images/20201001164702461.png"><br><img src="/images/20201001165125674.png"></p></li></ul><h1 id="摄像头yolov3-opencv参数"><a href="#摄像头yolov3-opencv参数" class="headerlink" title="摄像头yolov3 opencv参数"></a>摄像头yolov3 opencv参数</h1><p><code>cv::cvtColor(yuvImg, bgrImg,   CV_YUV420sp2RGB);</code>opencv格式转化时填入的参数，<br><a href="https://docs.opencv.org/3.4/dc/d0f/imgproc_2include_2opencv2_2imgproc_2types__c_8h.html">https://docs.opencv.org/3.4/dc/d0f/imgproc_2include_2opencv2_2imgproc_2types__c_8h.html</a></p>]]></content>
      
      
      <categories>
          
          <category> Atlas </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Atlas </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>200DK概念</title>
      <link href="2021/05/14/200dk-gai-nian-local/"/>
      <url>2021/05/14/200dk-gai-nian-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]</p><p><a href="https://www.huaweicloud.com/ascend/Course/3/0">https://www.huaweicloud.com/ascend/Course/3/0</a><br><img src="/images/20200919172830247.png"></p><p><img src="/images/20200919174539630.png"></p><h1 id="Matrix"><a href="#Matrix" class="headerlink" title="Matrix"></a>Matrix</h1><ul><li>graph.config 配置图 与 引擎 连接关系的；</li><li>每个引擎都有对应的.h 和 .cpp文件，已自动完成部分代码；<br>Init()方法，该引擎运行前需要的初始化操作，如加载模型，<br>PROCESS宏方法，上个引擎往本引擎发送数据，在这个宏里处理数据，发一次处理一次，<br>arg0参数是 框架带入的，本引擎的0端口接收的数据。<br><img src="/images/20200919214805238.png"></li></ul><p><img src="/images/20200919193521604.png"><br>Atlas 200 DK 特殊 是一个Device，<br><img src="/images/20200919195250298.png"></p><h2 id="图与引擎"><a href="#图与引擎" class="headerlink" title="图与引擎"></a>图与引擎</h2><p>图与引擎的关系用文件定义<br><img src="/images/20200919200216844.png"></p><h1 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h1><p><code>cd ../.. &amp;&amp; cd sample-objectdetectionbyyolov3_08ac3632/out</code><br><code>python3 run_object_detection_yolov3.py -w 416 -h 416 -i ./11.jpg</code></p>]]></content>
      
      
      <categories>
          
          <category> Atlas </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Atlas </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Atlas 200 DK obj</title>
      <link href="2021/05/14/atlas-200-dk-obj-local/"/>
      <url>2021/05/14/atlas-200-dk-obj-local/</url>
      
        <content type="html"><![CDATA[<p>@[toc]</p><h1 id="py-script"><a href="#py-script" class="headerlink" title="py script"></a>py script</h1><pre class="line-numbers language-c" data-language="c"><code class="language-c">获得脚本运行时传入的参数启动CPP_EXE，并将脚本收到的参数传入cpp可执行文件os<span class="token punctuation">.</span><span class="token function">system</span><span class="token punctuation">(</span>CPP_EXE <span class="token operator">+</span> console_params<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h1 id="main"><a href="#main" class="headerlink" title="main"></a>main</h1><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token number">1.</span> 系统初始化 <span class="token function">HIAI_Init</span><span class="token punctuation">(</span>kDeviceId<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">2.</span> 创建并启动图 hiai<span class="token operator">::</span><span class="token class-name">Graph</span><span class="token operator">::</span><span class="token function">CreateGraph</span><span class="token punctuation">(</span>kGraphConfigFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">3.</span> 获取图的实例 graph <span class="token operator">=</span> hiai<span class="token operator">::</span><span class="token class-name">Graph</span><span class="token operator">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span>kGraphId<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">4.</span> 设置回调函数（根据规则自定义：重载RecvData），main中的回调函数是最后一个Engine传出的数据，这里不需要做什么，只是flag<span class="token operator">--</span> graph<span class="token operator">-></span><span class="token function">SetDataRecvFunctor</span><span class="token punctuation">(</span>      target_port_config<span class="token punctuation">,</span>      std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>CustomDataRecvInterface<span class="token operator">></span><span class="token punctuation">(</span>          <span class="token keyword">new</span> <span class="token punctuation">(</span>nothrow<span class="token punctuation">)</span> <span class="token function">CustomDataRecvInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          其中 CustomDataRecvInterface 类的定义有要求：<span class="token comment">// https://www.huaweicloud.com/ascend/doc/Atlas%20200%20DK/1.32.0.0(beta)/zh/zh-cn_topic_0204323953.html</span><span class="token comment">// https://www.huaweicloud.com/ascend/doc/Atlas%20200%20DK/1.32.0.0(beta)/zh/zh-cn_topic_0204323784.html</span><span class="token number">1.</span> 继承 hiai<span class="token operator">::</span>DataRecvInterface<span class="token number">2.</span> 重载RecvData方法<span class="token keyword">class</span> <span class="token class-name">CustomDataRecvInterface</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> hiai<span class="token operator">::</span><span class="token class-name">DataRecvInterface</span></span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>  <span class="token comment">/*** @brief: Constructor */</span>  <span class="token function">CustomDataRecvInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>  <span class="token operator">~</span><span class="token function">CustomDataRecvInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>  <span class="token comment">/*   * @brief: Receive data from call back engine   * @param [in]: received message   * @return: result   */</span>  HIAI_StatusT <span class="token function">RecvData</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token operator">&amp;</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 重写的内容如下，全局flag--，</span>HIAI_StatusT <span class="token class-name">CustomDataRecvInterface</span><span class="token operator">::</span><span class="token function">RecvData</span><span class="token punctuation">(</span>    <span class="token keyword">const</span> std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token operator">&amp;</span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// no need to read any message, only decrease flag</span>  mt<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  flag<span class="token operator">--</span><span class="token punctuation">;</span>  mt<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> HIAI_OK<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token number">5.</span> 发送数据，启动第一个Engine （general_image） graph<span class="token operator">-></span><span class="token function">SendData</span><span class="token punctuation">(</span>engine_id<span class="token punctuation">,</span> <span class="token string">"ConsoleParams"</span><span class="token punctuation">,</span>         static_pointer_cast<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">(</span>param_ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 发送到第一个Engine的数据是 shared_ptr&lt;ConsoleParams> param_ptr 类型</span>   <span class="token comment">// https://support.huaweicloud.com/api-matrix-atlas200dkappc32/atlasmatrix_07_0041.html</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>回调函数，重载而来，需要继承<code>hiai::DataRecvInterface</code>，<br><a href="https://www.huaweicloud.com/ascend/doc/Atlas%20200%20DK/1.32.0.0%28beta%29/zh/zh-cn_topic_0204323784.html">https://www.huaweicloud.com/ascend/doc/Atlas%20200%20DK/1.32.0.0(beta)/zh/zh-cn_topic_0204323784.html</a><br><img src="/images/20200925130054696.png"></p><h1 id="Engine1-general-image"><a href="#Engine1-general-image" class="headerlink" title="Engine1 - general_image"></a>Engine1 - general_image</h1><h2 id="Init-没做什么"><a href="#Init-没做什么" class="headerlink" title="Init 没做什么"></a>Init 没做什么</h2><p>该引擎运行前需要的初始化操作。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// GeneralImage 继承 hiai::Engine</span><span class="token keyword">class</span> <span class="token class-name">GeneralImage</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> hiai<span class="token operator">::</span><span class="token class-name">Engine</span></span> <span class="token punctuation">&#123;</span><span class="token comment">// Init什么也没做</span>HIAI_StatusT <span class="token class-name">GeneralImage</span><span class="token operator">::</span><span class="token function">Init</span><span class="token punctuation">(</span>    <span class="token keyword">const</span> hiai<span class="token operator">::</span>AIConfig<span class="token operator">&amp;</span> config<span class="token punctuation">,</span>    <span class="token keyword">const</span> vector<span class="token operator">&lt;</span>hiai<span class="token operator">::</span>AIModelDescription<span class="token operator">></span><span class="token operator">&amp;</span> model_desc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// do noting</span>  <span class="token keyword">return</span> HIAI_OK<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="HIAI-IMPL-ENGINE-PROCESS"><a href="#HIAI-IMPL-ENGINE-PROCESS" class="headerlink" title="HIAI_IMPL_ENGINE_PROCESS"></a>HIAI_IMPL_ENGINE_PROCESS</h2><p><code>HIAI_IMPL_ENGINE_PROCESS</code>宏方法，上个引擎往本引擎发送数据，在这个宏里处理数据，发一次处理一次。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token number">1.</span> 检查arg0，提取input_path<span class="token number">2.</span> 提取文件路径到file_vec<span class="token number">3.</span> <span class="token keyword">for</span>，send每张图到 inference engine 用cv读取图像，把图像信息存入shared_ptr<span class="token operator">&lt;</span>EngineTrans<span class="token operator">></span> <span class="token operator">&amp;</span>image_handle发送<span class="token function">SendData</span><span class="token punctuation">(</span>kSendDataPort<span class="token punctuation">,</span> <span class="token string">"EngineTrans"</span><span class="token punctuation">,</span> static_pointer_cast<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">(</span>image_handle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>发送成功则sleep <span class="token number">200</span>ms，image_handle<span class="token operator">-></span>is_finished <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> 否则再下一张<span class="token number">4.</span> 发送结束标志 image_handle<span class="token operator">-></span>is_finished <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token function">SendData</span><span class="token punctuation">(</span>kSendDataPort<span class="token punctuation">,</span> <span class="token string">"EngineTrans"</span><span class="token punctuation">,</span>             static_pointer_cast<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">(</span>image_handle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// 发送到下一个Engine的数据是 shared_ptr&lt;EngineTrans> &amp;image_handle类型</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">继承 hiai<span class="token operator">::</span>Engine 的 GeneralImage 通过HIAI_IMPL_ENGINE_PROCESS参数 与 底层产生联系<span class="token punctuation">,</span><span class="token function">HIAI_IMPL_ENGINE_PROCESS</span><span class="token punctuation">(</span><span class="token string">"general_image"</span><span class="token punctuation">,</span>    GeneralImage<span class="token punctuation">,</span> INPUT_SIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h1 id="Engine2-general-inference"><a href="#Engine2-general-inference" class="headerlink" title="Engine2 - general_inference"></a>Engine2 - general_inference</h1><p>接受<code>Engine1 - general_image</code>发过来的图片，<br>dvpp预处理后交给模型管家前向传播得到输出结果，<br>发送处理结果到<code>Engine3 -  general_post</code>。</p><h2 id="Init"><a href="#Init" class="headerlink" title="Init"></a>Init</h2><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token number">1.</span> 初始化 AI模型管家 aiModelManagerstd<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>hiai<span class="token operator">::</span>AIModelManager<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">2.</span> 设置模型描述，从graph<span class="token punctuation">.</span>config文件获取模型路径hiai<span class="token operator">::</span>AIModelDescription fd_model_desc<span class="token punctuation">;</span>fd_model_desc<span class="token punctuation">.</span><span class="token function">set_path</span><span class="token punctuation">(</span>model_path<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">3.</span> 初始化模型管理器vector<span class="token operator">&lt;</span>hiai<span class="token operator">::</span>AIModelDescription<span class="token operator">></span> model_desc_vec<span class="token punctuation">;</span>  model_desc_vec<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>fd_model_desc<span class="token punctuation">)</span><span class="token punctuation">;</span>ai_model_manager_<span class="token operator">-></span><span class="token function">Init</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> model_desc_vec<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化模型管理器</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="HIAI-IMPL-ENGINE-PROCESS-1"><a href="#HIAI-IMPL-ENGINE-PROCESS-1" class="headerlink" title="HIAI_IMPL_ENGINE_PROCESS"></a>HIAI_IMPL_ENGINE_PROCESS</h2><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token number">1.</span> 检查参数arg0，转化参数类型shared_ptr<span class="token operator">&lt;</span>EngineTrans<span class="token operator">></span> image_handle <span class="token operator">=</span> static_pointer_cast<span class="token operator">&lt;</span>EngineTrans<span class="token operator">></span><span class="token punctuation">(</span>arg0<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">2.</span> 判断结束标志，发送数据到推理Engine<span class="token keyword">if</span> <span class="token punctuation">(</span>image_handle<span class="token operator">-></span>is_finished<span class="token punctuation">)</span> <span class="token function">SendToEngine</span><span class="token punctuation">(</span>image_handle<span class="token punctuation">)</span><span class="token function">SendData</span><span class="token punctuation">(</span>kSendDataPort<span class="token punctuation">,</span> <span class="token string">"EngineTrans"</span><span class="token punctuation">,</span>static_pointer_cast<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">(</span>image_handle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// https://support.huaweicloud.com/api-matrix-atlas200dkappc32/atlasmatrix_07_0041.html</span><span class="token number">3.</span> 如果没有接收到结束标志，则预处理图片resize 返回 ImageData没有接收到结束标志，但一定接收到了图片（否则不会进入PROCESS），可以预处理图片咯 <span class="token operator">^</span>v<span class="token operator">^</span> 用dvpp resize图片，保证左顶even，右底odd<span class="token number">4.</span> 目的是丢到AI模型管家前向传播，inference 从dvpp的 ImageData 格式 到 neural格式 到 hiai<span class="token operator">::</span>IAITensor格式ImageData <span class="token operator">--</span> <span class="token operator">></span> hiai<span class="token operator">::</span>AINeuralNetworkBuffer <span class="token operator">--</span><span class="token operator">></span> hiai<span class="token operator">::</span>IAITensor把 hiai<span class="token operator">::</span>IAITensor 图片push到vector<span class="token operator">&lt;</span>shared_ptr<span class="token operator">&lt;</span>hiai<span class="token operator">::</span>IAITensor<span class="token operator">>></span>创建输出Tensor vector<span class="token operator">&lt;</span>shared_ptr<span class="token operator">&lt;</span>hiai<span class="token operator">::</span>IAITensor<span class="token operator">>></span> output_data<span class="token punctuation">;</span>   <span class="token comment">// 实参</span>ai_model_manager_<span class="token operator">-></span><span class="token function">CreateOutputTensor</span><span class="token punctuation">(</span>input_data_vec<span class="token punctuation">,</span> output_data_vec<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 形参</span>开始推理Processai_model_manager_<span class="token operator">-></span><span class="token function">Process</span><span class="token punctuation">(</span>ai_context<span class="token punctuation">,</span> input_data_vec<span class="token punctuation">,</span> output_data_vec<span class="token punctuation">,</span> kAiModelProcessTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">5.</span> 发送结果<span class="token function">SendResult</span><span class="token punctuation">(</span>image_handle<span class="token punctuation">,</span> output_data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">,</span> 对于每个输出Tensor，output_data_vecimage_handle<span class="token operator">-></span>inference_res<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">SendData</span><span class="token punctuation">(</span>kSendDataPort<span class="token punctuation">,</span> <span class="token string">"EngineTrans"</span><span class="token punctuation">,</span>                        static_pointer_cast<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">(</span>image_handle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="Engine3-general-post"><a href="#Engine3-general-post" class="headerlink" title="Engine3 -  general_post"></a>Engine3 -  general_post</h1><p>接收模型输出的结果，后处理</p><h2 id="Init-1"><a href="#Init-1" class="headerlink" title="Init"></a>Init</h2><pre class="line-numbers language-none"><code class="language-none">什么也没做<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="HIAI-IMPL-ENGINE-PROCESS-2"><a href="#HIAI-IMPL-ENGINE-PROCESS-2" class="headerlink" title="HIAI_IMPL_ENGINE_PROCESS"></a>HIAI_IMPL_ENGINE_PROCESS</h2><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token number">1.</span> 检查参数arg0，转化参数类型shared_ptr<span class="token operator">&lt;</span>EngineTrans<span class="token operator">></span> result <span class="token operator">=</span> static_pointer_cast<span class="token operator">&lt;</span>EngineTrans<span class="token operator">></span><span class="token punctuation">(</span>arg0<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">2.</span> 判断结束标志 若结束发送空字符串<span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token operator">-></span>is_finished<span class="token punctuation">)</span>   <span class="token function">SendSentinel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 哨兵</span>  shared_ptr<span class="token operator">&lt;</span>string<span class="token operator">></span> <span class="token function">sentinel_msg</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">(</span>nothrow<span class="token punctuation">)</span> string<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">SendData</span><span class="token punctuation">(</span>kSendDataPort<span class="token punctuation">,</span> <span class="token string">"string"</span><span class="token punctuation">,</span>                 static_pointer_cast<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">(</span>sentinel_msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">3.</span> 如果不是结束标志 则后处理模型输出 PostProcess解码模型输出的Tensor  decodeTensor（yolo3的精髓）非极大值抑制算法 nonMaximumSuppression（yolo3的精髓）返回 std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>BoundingBox<span class="token operator">></span> result<span class="token punctuation">;</span>画框框保存图片<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="一些宏接口"><a href="#一些宏接口" class="headerlink" title="一些宏接口"></a>一些宏接口</h1><h2 id="1-HIAI-REGISTER-DATA-TYPE-自定义数据结构-的宏接口"><a href="#1-HIAI-REGISTER-DATA-TYPE-自定义数据结构-的宏接口" class="headerlink" title="1. HIAI_REGISTER_DATA_TYPE 自定义数据结构 的宏接口"></a>1. HIAI_REGISTER_DATA_TYPE 自定义数据结构 的宏接口</h2><p>宏原型 <code>HIAI_REGISTER_DATA_TYPE(name, type)</code><br>为用户自定义的数据结构类型提供序列化和反序列化机制。<br><a href="https://support.huaweicloud.com/api-matrix-atlas200dkappc32/atlasmatrix_07_0063.html">https://support.huaweicloud.com/api-matrix-atlas200dkappc32/atlasmatrix_07_0063.html</a></p><h2 id="2-HIAI-DEFINE-PROCESS-定义引擎输入出端口数"><a href="#2-HIAI-DEFINE-PROCESS-定义引擎输入出端口数" class="headerlink" title="2. HIAI_DEFINE_PROCESS 定义引擎输入出端口数"></a>2. HIAI_DEFINE_PROCESS 定义引擎输入出端口数</h2><p><a href="https://support.huaweicloud.com/api-matrix-atlas200dkappc32/atlasmatrix_07_0048.html">https://support.huaweicloud.com/api-matrix-atlas200dkappc32/atlasmatrix_07_0048.html</a><br>宏原型<code>HIAI_DEFINE_PROCESS（inputPortNum, outputPortNum）</code></p><p>用户直接调用该<code>宏</code> 定义Engine的输入与输出端口数 <code>[1 , 16]</code>。</p><p>用户调用宏的顺序应该是：<code>HIAI_DEFINE_PROCESS</code> –&gt; <code>HIAI_IMPL_ENGINE_PROCESS</code></p><h2 id="3-HIAI-IMPL-ENGINE-PROCESS-接受处理数据"><a href="#3-HIAI-IMPL-ENGINE-PROCESS-接受处理数据" class="headerlink" title="3. HIAI_IMPL_ENGINE_PROCESS 接受处理数据"></a>3. HIAI_IMPL_ENGINE_PROCESS 接受处理数据</h2><p><a href="https://support.huaweicloud.com/api-matrix-atlas200dkappc32/atlasmatrix_07_0049.html">https://support.huaweicloud.com/api-matrix-atlas200dkappc32/atlasmatrix_07_0049.html</a><br>宏原型<code>HIAI_IMPL_ENGINE_PROCESS(name, engineClass, inPortNum)</code></p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">engineClass 需要继承 hiai<span class="token operator">::</span>Engine需要重写Init<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="4-HIAI-ENGINE-LOG"><a href="#4-HIAI-ENGINE-LOG" class="headerlink" title="4. HIAI_ENGINE_LOG"></a>4. HIAI_ENGINE_LOG</h2><p><a href="https://support.huaweicloud.com/api-matrix-atlas200dkappc30/atlasmatrix_07_0149.html">https://support.huaweicloud.com/api-matrix-atlas200dkappc30/atlasmatrix_07_0149.html</a><br>宏原型很多，打印日志的格式有8种。</p><p>调用<code>HIAI_ENGINE_LOG</code>后，系统将日志记录日志文件中，日志文件在<code>Host侧</code>或开发者板的<code>/var</code>目录下。<br><code>Device侧</code>的日志被记录在文件名称以<code>device-id</code>开头的日志文件中，<br><code>Host侧</code>的日志被记录在文件名称以<code>host-0</code>开头的日志文件中。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">最简单的一种<span class="token function">HIAI_ENGINE_LOG</span><span class="token punctuation">(</span><span class="token string">"Start initialize!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Atlas </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Atlas </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
